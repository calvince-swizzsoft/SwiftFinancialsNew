USE [SwiftFinancialsDB_DEV]
GO
/****** Object:  UserDefinedFunction [dbo].[Currency_ToWords]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


 create FUNCTION [dbo].[Currency_ToWords] (
            @Input Numeric (38) -- Input number with as many as 18 digits

        ) RETURNS VARCHAR(8000) 

        /*
        * Converts a integer number as large as 34 digits into the 
        * equivalent words.  The first letter is capitalized.
        *
        * Attribution: Based on NumberToWords by Srinivas Sampath
        *        as revised by Nick Barclay
        *
        * Example:
        select dbo.udf_Num_ToWords (1234567890) + CHAR(10)
              +  dbo.udf_Num_ToWords (0) + CHAR(10)
              +  dbo.udf_Num_ToWords (123) + CHAR(10)
        select dbo.udf_Num_ToWords(76543210987654321098765432109876543210)

        DECLARE @i numeric (38,0)
        SET @i = 0
        WHILE @I <= 1000 BEGIN 
            PRINT convert (char(5), @i)  
                    + convert(varchar(255), dbo.udf_Num_ToWords(@i)) 
            SET @I  = @i + 1 
        END
        *
        * Published as the T-SQL UDF of the Week Vol 2 #9 2/17/03
        ****************************************************************/
        AS BEGIN
        Declare @Number Numeric(38,0)
        set @Number = @Input
        Declare @Cents as int
        set @Cents = 100*Convert(money,(@Input - convert(Numeric(38,3),@Number)))
        DECLARE @inputNumber VARCHAR(38)
        DECLARE @NumbersTable TABLE (number CHAR(2), word VARCHAR(10))
        DECLARE @outputString VARCHAR(8000)
        DECLARE @length INT
        DECLARE @counter INT
        DECLARE @loops INT
        DECLARE @position INT
        DECLARE @chunk CHAR(3) -- for chunks of 3 numbers
        DECLARE @tensones CHAR(2)
        DECLARE @hundreds CHAR(1)
        DECLARE @tens CHAR(1)
        DECLARE @ones CHAR(1)

        IF @Number = 0 Return 'Zero'

        -- initialize the variables
        SELECT @inputNumber = CONVERT(varchar(38), @Number)
             , @outputString = ''
             , @counter = 1
        SELECT @length   = LEN(@inputNumber)
             , @position = LEN(@inputNumber) - 2
             , @loops    = LEN(@inputNumber)/3

        -- make sure there is an extra loop added for the remaining numbers
        IF LEN(@inputNumber) % 3 <> 0 SET @loops = @loops + 1

        -- insert data for the numbers and words
        INSERT INTO @NumbersTable   SELECT '00', ''
            UNION ALL SELECT '01', 'one'      UNION ALL SELECT '02', 'two'
            UNION ALL SELECT '03', 'three'    UNION ALL SELECT '04', 'four'
            UNION ALL SELECT '05', 'five'     UNION ALL SELECT '06', 'six'
            UNION ALL SELECT '07', 'seven'    UNION ALL SELECT '08', 'eight'
            UNION ALL SELECT '09', 'nine'     UNION ALL SELECT '10', 'ten'
            UNION ALL SELECT '11', 'eleven'   UNION ALL SELECT '12', 'twelve'
            UNION ALL SELECT '13', 'thirteen' UNION ALL SELECT '14', 'fourteen'
            UNION ALL SELECT '15', 'fifteen'  UNION ALL SELECT '16', 'sixteen'
            UNION ALL SELECT '17', 'seventeen' UNION ALL SELECT '18', 'eighteen'
            UNION ALL SELECT '19', 'nineteen' UNION ALL SELECT '20', 'twenty'
            UNION ALL SELECT '30', 'thirty'   UNION ALL SELECT '40', 'forty'
            UNION ALL SELECT '50', 'fifty'    UNION ALL SELECT '60', 'sixty'
            UNION ALL SELECT '70', 'seventy'  UNION ALL SELECT '80', 'eighty'
            UNION ALL SELECT '90', 'ninety'   

        WHILE @counter <= @loops BEGIN

            -- get chunks of 3 numbers at a time, padded with leading zeros
            SET @chunk = RIGHT('000' + SUBSTRING(@inputNumber, @position, 3), 3)

            IF @chunk <> '000' BEGIN
                SELECT @tensones = SUBSTRING(@chunk, 2, 2)
                     , @hundreds = SUBSTRING(@chunk, 1, 1)
                     , @tens = SUBSTRING(@chunk, 2, 1)
                     , @ones = SUBSTRING(@chunk, 3, 1)

                -- If twenty or less, use the word directly from @NumbersTable
                IF CONVERT(INT, @tensones) <= 20 OR @Ones='0' BEGIN
                    SET @outputString = (SELECT word 
                                              FROM @NumbersTable 
                                              WHERE @tensones = number)
                           + CASE @counter WHEN 1 THEN '' -- No name
                               WHEN 2 THEN ' thousand ' WHEN 3 THEN ' million '
                               WHEN 4 THEN ' billion '  WHEN 5 THEN ' trillion '
                               WHEN 6 THEN ' quadrillion ' WHEN 7 THEN ' quintillion '
                               WHEN 8 THEN ' sextillion '  WHEN 9 THEN ' septillion '
                               WHEN 10 THEN ' octillion '  WHEN 11 THEN ' nonillion '
                               WHEN 12 THEN ' decillion '  WHEN 13 THEN ' undecillion '
                               ELSE '' END
                                       + @outputString
                    END
                 ELSE BEGIN -- break down the ones and the tens separately

                     SET @outputString = ' ' 
                                    + (SELECT word 
                                            FROM @NumbersTable 
                                            WHERE @tens + '0' = number)
                                     + '-'
                                     + (SELECT word 
                                            FROM @NumbersTable 
                                            WHERE '0'+ @ones = number)
                           + CASE @counter WHEN 1 THEN '' -- No name
                               WHEN 2 THEN ' thousand ' WHEN 3 THEN ' million '
                               WHEN 4 THEN ' billion '  WHEN 5 THEN ' trillion '
                               WHEN 6 THEN ' quadrillion ' WHEN 7 THEN ' quintillion '
                               WHEN 8 THEN ' sextillion '  WHEN 9 THEN ' septillion '
                               WHEN 10 THEN ' octillion '  WHEN 11 THEN ' nonillion '
                               WHEN 12 THEN ' decillion '   WHEN 13 THEN ' undecillion '
                               ELSE '' END
                                    + @outputString
                END

                -- now get the hundreds
                IF @hundreds <> '0' BEGIN
                    SET @outputString  = (SELECT word 
                                              FROM @NumbersTable 
                                              WHERE '0' + @hundreds = number)
                                        + ' hundred ' 
                                        + @outputString
                END
            END

            SELECT @counter = @counter + 1
                 , @position = @position - 3

        END

        -- Remove any double spaces
        SET @outputString = LTRIM(RTRIM(REPLACE(@outputString, '  ', ' ')))
        SET @outputstring = UPPER(LEFT(@outputstring, 1)) + SUBSTRING(@outputstring, 2, 8000)


        RETURN UPPER(@outputString)   -- return the result
        END



GO
/****** Object:  UserDefinedFunction [dbo].[f_CustomerLastTransactionDate]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create function [dbo].[f_CustomerLastTransactionDate] 
(	
	@CustomerID Varchar(MAX)
)
RETURNS date 

AS


BEGIN 
DECLARE @LasTrxDate date

SELECT @LasTrxDate = MAX(CreatedDate) FROM swiftfin_JournalEntries WHERE CustomerAccountId IN (SELECT id FROM dbo.swiftfin_CustomerAccounts WHERE CustomerId = @CustomerID)

RETURN @LasTrxDate

END






GO
/****** Object:  UserDefinedFunction [dbo].[FirstWord]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create  FUNCTION [dbo].[FirstWord] (@value varchar(max))
RETURNS varchar(max)
AS
BEGIN
    RETURN CASE CHARINDEX(' ', @value, 1)
        WHEN 0 THEN @value
        ELSE SUBSTRING(@value, 1, CHARINDEX(' ', @value, 1) - 1) END
END



GO
/****** Object:  UserDefinedFunction [dbo].[fn_CustomerAccountBalance]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create function [dbo].[fn_CustomerAccountBalance] 
(
	-- Add the parameters for the stored procedure here
	@CustomerAccountID Varchar(100) = 0, 
	@Type int = 0,
	@considerMaturityPeriodForInvestmentAccounts bit =0
)
RETURNS numeric(18,2)
BEGIN
	Declare @Balance numeric(18,2)
	Declare @MinBalance numeric(18,2)


	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.

	Declare @ProductID uniqueidentifier,
			@Days int,
			@EndDate Datetime,
			@unMaturedAmount Numeric(18,2),
			@UnclearedCheques Numeric(18,2)

	
	set @ProductID=(select CustomerAccountType_TargetProductId from swiftfin_CustomerAccounts where id= @CustomerAccountID)
	
	set @days=iif(@considerMaturityPeriodForInvestmentAccounts=1,(select MaturityPeriod from swiftfin_InvestmentProducts where id=@ProductID),0)

	set @EndDate=Dateadd(d,@days*-1,getdate())
	set @unMaturedAmount=
	(SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
			FROM         dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID) AND (dbo.swiftfin_Journals.ModuleNavigationItemCode NOT IN ('64426')) AND 
                         (dbo.swiftfin_Journals.CreatedDate >= @EndDate) AND (dbo.swiftfin_InvestmentProducts.Id = @ProductID)
	)

	Select @UnclearedCheques= 
	(
						(
					SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
					FROM            dbo.swiftfin_JournalEntries INNER JOIN
											 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
					WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID) 
					/*AND dbo.swiftfin_Journals.ModuleNavigationItemCode!='62055'*/
					and ChartOfAccountId  in 
						(
							  SELECT[ChartOfAccountId]
							  FROM [dbo].[swiftfin_SystemGeneralLedgerAccountMappings] 
							  WHERE SystemGeneralLedgerAccountCode=48827
						)
						---Group By Products_1.MinBalance
				)


	)
	SELECT @Balance = 
		CASE 
			WHEN @Type=1 THEN ---Account Balance
			---select * FROM PRODUCTS(0)
				(
					SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
					FROM            dbo.swiftfin_JournalEntries INNER JOIN
											 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
					WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID) 
					AND (dbo.swiftfin_JournalEntries.ChartOfAccountId IN
                             (SELECT        ChartOfAccountId
                               FROM            dbo.Products(0) AS Products_1
                               WHERE        (id IN
                                                             (SELECT        CustomerAccountType_TargetProductId
                                                               FROM            dbo.swiftfin_CustomerAccounts
                                                               WHERE        (Id = @CustomerAccountID)))))
					/*AND dbo.swiftfin_Journals.ModuleNavigationItemCode!='62055'
					and ContraChartOfAccountId not in 
						(
							  SELECT[ChartOfAccountId]
							  FROM [dbo].[swiftfin_SystemGeneralLedgerAccountMappings] 
							  WHERE SystemGeneralLedgerAccountCode=48827
						) */
						---Group By Products_1.MinBalance
				)

			 ELSE  --- AccountInterest

				(		SELECT SUM(dbo.swiftfin_JournalEntries.Amount) 
						FROM   dbo.swiftfin_JournalEntries 
						WHERE CustomerAccountId =@CustomerAccountId  
						and ChartOfAccountId in 
						(SELECT InterestReceivable FROM PRODUCTS(0) WHERE ID IN (select CustomerAccountType_TargetProductId 
						from swiftfin_CustomerAccounts where id=@CustomerAccountID))

				)
			  END 

			  select @Balance= CASE 
			  WHEN @considerMaturityPeriodForInvestmentAccounts=1 THEN  @Balance-@unMaturedAmount
			  ELSE
				   @Balance+isnull(@UnclearedCheques,0)
			  END 
	---set @Balance=iif(@considerMaturityPeriodForInvestmentAccounts=1,@Balance-@unMaturedAmount,@Balance)
RETURN ISNULL(@Balance,0)
END

--select * from swiftfin_chartofaccounts where id='5998761D-3945-C548-CD4F-08D1AD3C85FC'




GO
/****** Object:  UserDefinedFunction [dbo].[fnPaymentCalc]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[fnPaymentCalc] 
	(
	@loan_amt FLOAT,
	@periods  INT,
	@per_anum INT,
	@rate     FLOAT
	)
RETURNS FLOAT
AS
BEGIN
	DECLARE @payment FLOAT
	DECLARE @calc_rate FLOAT
	SELECT  @calc_rate = @rate/@per_anum
	SELECT  @payment   = @loan_amt*((@calc_rate*POWER((1+@calc_rate),@periods))/(POWER(1+@calc_rate,@periods)-1))
	RETURN  @payment
END



GO
/****** Object:  UserDefinedFunction [dbo].[FV]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[FV](@termInMonths [int], @paymentFrequencyPerYear [int], @APR [float], @Pmt [float], @PV [float], @Due [int])
RETURNS [float] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [Infrastructure.Data.SQLCLR].[UserDefinedFunctions].[FV]
GO
/****** Object:  UserDefinedFunction [dbo].[GetProfilePropertyValue]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



create FUNCTION [dbo].[GetProfilePropertyValue] (  
    @PropertyName as varchar(max)
    , @PropertyNamesString as varchar(max)
    , @PropertyValuesString as varchar(max)) 
RETURNS varchar(max)
AS
BEGIN
    DECLARE @StartIndex int
    DECLARE @EndIndex int
    DECLARE @StartPos int
    DECLARE @Length int
    
    -- First we find the starting position
    Set @StartIndex = PatIndex('%' + @PropertyName + ':%', @PropertyNamesString) + LEN(RTRIM(@PropertyName)) + 3
    Set @EndIndex = PatIndex('%:%', Right(@PropertyNamesString, LEN(@PropertyNamesString) - @StartIndex))
    Set @StartPos = Cast(Substring(@PropertyNamesString, @StartIndex, @EndIndex) As Int)
    
    -- Now we need to know how long it is
    Set @StartIndex = @StartIndex + @EndIndex + 1
    Set @EndIndex = PatIndex('%:%', Right(@PropertyNamesString, LEN(@PropertyNamesString) - @StartIndex))
    Set @Length = Cast(Substring(@PropertyNamesString, @StartIndex, @EndIndex) As int)
    
    -- Now we get the value we want
    RETURN SUBSTRING(@PropertyValuesString, @StartPos + 1, @Length)
END





GO
/****** Object:  UserDefinedFunction [dbo].[GetWord]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create FUNCTION [dbo].[GetWord] 
    (
        @value varchar(max)
        , @startLocation int
    ) 
    RETURNS varchar(max) 
    AS 
      BEGIN 

         SET @value = LTRIM(RTRIM(@Value))  
         SELECT @startLocation = 
                CASE 
                    WHEN @startLocation > Len(@value) THEN LEN(@value) 
                    ELSE @startLocation 
                END

            SELECT @value = 
                CASE 
                    WHEN @startLocation > 1 
                        THEN LTRIM(RTRIM(RIGHT(@value, LEN(@value) - @startLocation)))
                    ELSE @value
                END

            RETURN CASE CHARINDEX(' ', @value, 1) 
                    WHEN 0 THEN @value 
                    ELSE SUBSTRING(@value, 1, CHARINDEX(' ', @value, 1) - 1) 
                END

     END 



GO
/****** Object:  UserDefinedFunction [dbo].[IPmt]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[IPmt](@termInMonths [int], @paymentFrequencyPerYear [int], @APR [float], @Per [float], @PV [float], @FV [float], @Due [int])
RETURNS [float] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [Infrastructure.Data.SQLCLR].[UserDefinedFunctions].[IPmt]
GO
/****** Object:  UserDefinedFunction [dbo].[Pmt]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[Pmt](@termInMonths [int], @paymentFrequencyPerYear [int], @APR [float], @PV [float], @FV [float], @Due [int])
RETURNS [float] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [Infrastructure.Data.SQLCLR].[UserDefinedFunctions].[Pmt]
GO
/****** Object:  UserDefinedFunction [dbo].[PPmt]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[PPmt](@termInMonths [int], @paymentFrequencyPerYear [int], @APR [float], @Per [float], @PV [float], @FV [float], @Due [int])
RETURNS [float] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [Infrastructure.Data.SQLCLR].[UserDefinedFunctions].[PPmt]
GO
/****** Object:  UserDefinedFunction [dbo].[Products]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from dbo.Products(0)
create function [dbo].[Products] 
(
	@Product  Int
)
RETURNS 
	@temp table (id varchar(50),type varchar(20),Description varchar(50),ChartOfAccountId varchar(50),InterestReceivable uniqueidentifier,MinBalance Numeric(12,2),Code int,InterestCalculationMode int)
as
begin
	insert into @temp
	select id,'Savings     ' as type,Description,ChartOfAccountId,null,MinimumBalance,Code,0  from swiftfin_SavingsProducts
	insert into @temp
	select id,'Loans',Description,ChartOfAccountId,InterestReceivableChartOfAccountId,0,Code,LoanInterest_CalculationMode from swiftfin_LoanProducts
	insert into @temp
	select id,'Investments',Description,ChartOfAccountId,null,0,Code,0 from swiftfin_InvestmentProducts
	return
end




GO
/****** Object:  UserDefinedFunction [dbo].[RepaymentSchedule]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[RepaymentSchedule](@termInMonths [int], @paymentFrequencyPerYear [int], @gracePeriod [int], @interestCalculationMode [int], @APR [float], @PV [float], @FV [float], @Due [int])
RETURNS  TABLE (
	[Period] [int] NULL,
	[DueDate] [datetime] NULL,
	[StartingBalance] [decimal](18, 2) NULL,
	[Payment] [decimal](18, 2) NULL,
	[InterestPayment] [decimal](18, 2) NULL,
	[PrincipalPayment] [decimal](18, 2) NULL,
	[EndingBalance] [decimal](18, 2) NULL
) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [Infrastructure.Data.SQLCLR].[UserDefinedFunctions].[RepaymentSchedule]
GO
/****** Object:  View [dbo].[vw_CustomerAccounts]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vw_CustomerAccounts]
AS
SELECT        TOP (100) PERCENT REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') 
                         AS FullAccount, LTRIM(RTRIM(ISNULL(dbo.swiftfin_Customers.Individual_FirstName, '') + ' ' + ISNULL(dbo.swiftfin_Customers.Individual_LastName, ''))) + '' + ISNULL(dbo.swiftfin_Customers.NonIndividual_Description, '') AS FullName, 
                         dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, Products_1.Description, dbo.swiftfin_CustomerAccounts.Id, dbo.swiftfin_CustomerAccounts.CustomerId, 
                         dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId, dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 
                         dbo.swiftfin_Customers.Reference1, dbo.swiftfin_CustomerAccounts.BranchId, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Individual_PayrollNumbers, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_CustomerAccounts.Remarks, 
                         dbo.swiftfin_Customers.NonIndividual_RegistrationNumber, dbo.swiftfin_Customers.StationId, dbo.swiftfin_Customers.SerialNumber, dbo.swiftfin_Customers.Address_MobileLine, dbo.swiftfin_Customers.Address_LandLine, 
                         dbo.swiftfin_Customers.PersonalIdentificationNumber, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Employers.Id AS EmployerID, dbo.swiftfin_Employers.Description AS EmployerDescription, 
                         dbo.swiftfin_CustomerAccounts.Status, dbo.swiftfin_Customers.Individual_BirthDate, dbo.swiftfin_Customers.Individual_Gender, Products_1.ChartOfAccountId, dbo.swiftfin_Customers.Address_AddressLine2, 
                         dbo.swiftfin_CustomerAccounts.SigningInstructions, dbo.swiftfin_Customers.Address_Email
FROM            dbo.swiftfin_Divisions INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Divisions.Id = dbo.swiftfin_Zones.DivisionId INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Stations.ZoneId RIGHT OUTER JOIN
                         dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.Products(1) AS Products_1 ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON Products_1.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id ON dbo.swiftfin_Stations.Id = dbo.swiftfin_Customers.StationId
GO
/****** Object:  View [dbo].[vw_StaffStandingOrders]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_StaffStandingOrders]
AS
SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.swiftfin_LoanProducts.Description, SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 AS balance, ROUND(SUM(dbo.swiftfin_JournalEntries.Amount) 
                         * - (1 * dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate / 1200), 2) AS ExpectedInterest, dbo.swiftfin_StandingOrders.Interest, dbo.swiftfin_StandingOrders.PaymentPerPeriod, dbo.swiftfin_StandingOrders.Principal, 
                         dbo.swiftfin_StandingOrders.PaymentPerPeriod - ROUND(SUM(dbo.swiftfin_JournalEntries.Amount) * - (1 * dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate / 1200), 2) AS ExpectedPrincipal
FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId AND dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_StandingOrders ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId
WHERE        (dbo.vw_CustomerAccounts.CustomerId IN
                             (SELECT        CustomerId
                               FROM            dbo.swiftfin_Employees)) AND (dbo.swiftfin_StandingOrders.[Trigger] = 1)
GROUP BY dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate, dbo.swiftfin_StandingOrders.PaymentPerPeriod, 
                         dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.Interest, dbo.swiftfin_StandingOrders.LoanAmount
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
GO
/****** Object:  View [dbo].[vw_AdavanceSO]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_AdavanceSO]
AS
SELECT        dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Description, dbo.swiftfin_StandingOrders.Duration_StartDate, dbo.swiftfin_StandingOrders.Duration_EndDate, 
                         dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod, dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.Interest, dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
FROM            dbo.swiftfin_StandingOrders INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id
GO
/****** Object:  View [dbo].[vw_DuplicateStdOrders]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_DuplicateStdOrders]
AS
SELECT        dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Description, dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod, 
                         dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.Interest, dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId, dbo.swiftfin_StandingOrders.[Trigger], 
                         dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId, dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId
FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_StandingOrders ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId
GO
/****** Object:  View [dbo].[vw_SigningInstructions]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_SigningInstructions]
AS
SELECT        FOSA.dbo.customer.fosa_acno, dbo.vw_CustomerAccounts.Reference1, FOSA.dbo.customer.name, dbo.vw_CustomerAccounts.FullName, FOSA.dbo.customer.reason_dor, 
                         dbo.vw_CustomerAccounts.SigningInstructions, dbo.vw_CustomerAccounts.Status, dbo.vw_CustomerAccounts.Description, dbo.vw_CustomerAccounts.Id
FROM            FOSA.dbo.customer INNER JOIN
                         dbo.vw_CustomerAccounts ON FOSA.dbo.customer.fosa_acno = dbo.vw_CustomerAccounts.Reference1 INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id
WHERE        (dbo.swiftfin_SavingsProducts.Id = 'B293A3E2-17D8-404D-A313-9DF518717B3A') AND (LEN(FOSA.dbo.customer.reason_dor) > 2)
GO
/****** Object:  View [dbo].[vw_EmployeeRegister]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_EmployeeRegister]
WITH SCHEMABINDING 
AS
SELECT        CASE Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN
                          '13' THEN 'Sir' WHEN '11' THEN 'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         CASE swiftfin_Customers.Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
                         CASE swiftfin_Customers.Individual_MaritalStatus WHEN '1' THEN 'Married' WHEN '2' THEN 'Single' WHEN '3' THEN 'Divorced' WHEN '4' THEN 'Separated' ELSE 'UnKnown' END AS MaritalStatus, 
                         dbo.swiftfin_Customers.Individual_IdentityCardNumber AS IdentityCardNumber, dbo.swiftfin_Customers.Individual_EmploymentDate, 
                         CASE dbo.swiftfin_Customers.Individual_Nationality WHEN 1 THEN 'Kenya' WHEN 2 THEN 'Uganda' WHEN 3 THEN 'Tanzania' WHEN 4 THEN 'Rwanda' WHEN 4 THEN 'Burundi' ELSE 'UnKnown' END AS Nationality, 
                         RIGHT('00000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber)) AS VARCHAR(6)), 5) AS MembershipNumber, 
                         CASE dbo.swiftfin_Employees.EmployeeTypeId WHEN '54FE6A7C-AC2D-E811-80D1-F40343552CF8' THEN 'Full-Time' WHEN '119DAE73-6E48-E811-80D1-F40343552CF9' THEN 'Part-Time' WHEN '00E47EAD-5348-E811-80D1-F40343552CF9'
                          THEN 'Contract' END AS EmploymentType, dbo.swiftfin_Customers.Individual_PayrollNumbers AS PersonalFileNumber, dbo.swiftfin_Customers.Individual_BirthDate AS DateOfBirth, dbo.swiftfin_Designations.Description AS Designation, 
                         dbo.swiftfin_Customers.PersonalIdentificationNumber, dbo.swiftfin_Employees.NationalSocialSecurityFundNumber, dbo.swiftfin_Employees.NationalHospitalInsuranceFundNumber, 
                         CASE [BloodGroup] WHEN 0 THEN 'Unknown' WHEN 1 THEN 'A-' WHEN 2 THEN 'A+' WHEN 0 THEN 'B-' WHEN 1 THEN 'B+' WHEN 2 THEN 'AB-' WHEN 0 THEN 'AB+' WHEN 1 THEN 'O-' WHEN 2 THEN 'O+' END AS BloodGroup, 
                         dbo.swiftfin_Employees.Remarks, dbo.swiftfin_Employees.CreatedDate, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Employees.Id AS EmployeeID, dbo.swiftfin_Employees.CustomerId, dbo.swiftfin_Customers.Reference3, 
                         dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Employees.BranchId, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_Employees.EmployeeTypeId, dbo.swiftfin_EmployeeTypes.Id, dbo.swiftfin_EmployeeTypes.Category, 
                         dbo.swiftfin_Departments.Description AS Department
FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Employees.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Designations ON dbo.swiftfin_Employees.DesignationId = dbo.swiftfin_Designations.Id INNER JOIN
                         dbo.swiftfin_EmployeeTypes ON dbo.swiftfin_Employees.EmployeeTypeId = dbo.swiftfin_EmployeeTypes.Id INNER JOIN
                         dbo.swiftfin_Departments ON dbo.swiftfin_Employees.DepartmentId = dbo.swiftfin_Departments.Id
GO
/****** Object:  View [dbo].[vw_EmployeeRegisterwithUserID]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_EmployeeRegisterwithUserID]
AS
SELECT        dbo.GetProfilePropertyValue('EmployeeId', VanguardFinancialsDB_AuthStore.dbo.aspnet_Profile.PropertyNames, VanguardFinancialsDB_AuthStore.dbo.aspnet_Profile.PropertyValuesString) AS ID, 
                         dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.IdentityCardNumber, dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, 
                         dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
                         dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, dbo.vw_EmployeeRegister.Remarks, 
                         dbo.vw_EmployeeRegister.CreatedDate, dbo.vw_EmployeeRegister.Reference1, VanguardFinancialsDB_AuthStore.dbo.aspnet_Profile.UserId, VanguardFinancialsDB_AuthStore.dbo.aspnet_Users.UserName, 
                         dbo.vw_EmployeeRegister.Department, dbo.vw_EmployeeRegister.Branch
FROM            VanguardFinancialsDB_AuthStore.dbo.aspnet_Profile INNER JOIN
                         dbo.vw_EmployeeRegister ON dbo.GetProfilePropertyValue('EmployeeId', VanguardFinancialsDB_AuthStore.dbo.aspnet_Profile.PropertyNames, VanguardFinancialsDB_AuthStore.dbo.aspnet_Profile.PropertyValuesString) 
                         = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         VanguardFinancialsDB_AuthStore.dbo.aspnet_Users ON VanguardFinancialsDB_AuthStore.dbo.aspnet_Profile.UserId = VanguardFinancialsDB_AuthStore.dbo.aspnet_Users.UserId
WHERE        (VanguardFinancialsDB_AuthStore.dbo.aspnet_Profile.UserId IN
                             (SELECT        UserId
                               FROM            VanguardFinancialsDB_AuthStore.dbo.aspnet_Users AS aspnet_Users_1))
GO
/****** Object:  View [dbo].[vw_MicroCreditGroups]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE view [dbo].[vw_MicroCreditGroups]
 

AS
SELECT        dbo.swiftfin_Customers.NonIndividual_Description AS MicroCreditGroupName, 
                         dbo.swiftfin_Customers.NonIndividual_RegistrationNumber AS MicroCreditGroupRegistrationNumber, 
                         
                         dbo.swiftfin_Customers.NonIndividual_DateEstablished AS MicroCreditGroupDateEstablished, dbo.swiftfin_Customers.SerialNumber AS MicroCreditGroupSerialNumber, 
                         CASE dbo.swiftfin_MicroCreditGroups.Type WHEN 1 THEN 'ROSCA' WHEN 2 THEN 'ASCA' WHEN 4 THEN 'Table Banking' END AS MicroCreditGroupType, 
                         dbo.swiftfin_MicroCreditGroups.Purpose, dbo.swiftfin_MicroCreditGroups.Activities, 
                         CASE dbo.swiftfin_MicroCreditGroups.MeetingFrequency WHEN 2 THEN 'Semi-Annual' WHEN 3 THEN 'Tri-Annual' WHEN 4 THEN 'Quartery' WHEN 6 THEN 'Bi-Monthly' WHEN
                          12 THEN 'Monthly' WHEN 24 THEN 'Semi-Monthly' WHEN 26 THEN 'Bi-Weekly' WHEN 52 THEN 'Weekly' END AS MicroCreditGroupMeetingFrequency, 
                         CASE dbo.swiftfin_MicroCreditGroups.MeetingDayOfWeek WHEN 0 THEN 'Sunday' WHEN 1 THEN 'Monday' WHEN 2 THEN 'Tuesday' WHEN 3 THEN 'Wednesday' WHEN
                          4 THEN 'Thursday' WHEN 5 THEN 'Friday' WHEN 6 THEN 'Saturday' END AS MicroCreditGroupMeetingDayOfWeek, dbo.swiftfin_MicroCreditGroups.MeetingPlace, 
                         dbo.swiftfin_MicroCreditGroups.MinimumMembers, dbo.swiftfin_MicroCreditGroups.MaximumMembers, dbo.swiftfin_MicroCreditGroups.Remarks, 
                         dbo.vw_EmployeeRegister.FullName AS MicroCreditOfficerName, dbo.vw_EmployeeRegister.IdentityCardNumber AS MicroCreditOfficerIdentityCardNumber, 
                         dbo.vw_EmployeeRegister.MembershipNumber AS MicroCreditOfficerMembershipNumber, 
                         dbo.vw_EmployeeRegister.PersonalFileNumber AS MicroCreditOfficerPersonalFileNumber
FROM            dbo.swiftfin_MicroCreditGroups INNER JOIN
                         dbo.swiftfin_MicroCreditOfficers ON dbo.swiftfin_MicroCreditGroups.MicroCreditOfficerId = dbo.swiftfin_MicroCreditOfficers.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_MicroCreditGroups.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.vw_EmployeeRegister ON dbo.swiftfin_MicroCreditOfficers.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID












GO
/****** Object:  View [dbo].[vw_payslips]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*select * from [vw_payslips]
-select * from vw_EmployeeRegister*/
CREATE VIEW [dbo].[vw_payslips]
AS
SELECT DISTINCT 
                         TOP (100) PERCENT dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.IdentityCardNumber, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.PersonalFileNumber, 
                         dbo.swiftfin_SalaryCards.CardNumber, dbo.swiftfin_SalaryPeriods.Month, dbo.swiftfin_SalaryGroups.Description AS JobGroups, dbo.swiftfin_SalaryPeriods.Status, dbo.swiftfin_SalaryPeriods.AuthorizedBy, 
                         dbo.swiftfin_SalaryPeriods.AuthorizationRemarks, dbo.swiftfin_SalaryPeriods.AuthorizedDate, dbo.swiftfin_SalaryPeriods.CreatedBy, dbo.swiftfin_SalaryPeriods.CreatedDate, dbo.vw_CustomerAccounts.FullAccount, 
                         dbo.swiftfin_PaySlipEntries.Description AS PayslipDescription, dbo.swiftfin_PaySlipEntries.Principal, dbo.swiftfin_PaySlipEntries.Interest, dbo.swiftfin_PaySlipEntries.CreatedDate AS PayslipDate, dbo.swiftfin_PaySlipEntries.SalaryHeadType, 
                         dbo.swiftfin_PaySlipEntries.SalaryHeadCategory, dbo.swiftfin_PostingPeriods.Description, dbo.swiftfin_Customers.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
                         dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.swiftfin_SalaryCards.EmployeeId, dbo.swiftfin_PostingPeriods.Id AS PostingPeriodID, dbo.vw_CustomerAccounts.Reference1, 
                         dbo.swiftfin_Customers.Individual_FirstName + dbo.swiftfin_Customers.Individual_LastName AS CustomerName, dbo.vw_EmployeeRegister.Category, dbo.vw_EmployeeRegister.Reference3
FROM            dbo.swiftfin_PaySlipEntries INNER JOIN
                         dbo.swiftfin_PaySlips ON dbo.swiftfin_PaySlipEntries.PaySlipId = dbo.swiftfin_PaySlips.Id INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
                         dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
                         dbo.swiftfin_SalaryGroups ON dbo.swiftfin_SalaryCards.SalaryGroupId = dbo.swiftfin_SalaryGroups.Id INNER JOIN
                         dbo.swiftfin_SalaryGroupEntries ON dbo.swiftfin_SalaryGroups.Id = dbo.swiftfin_SalaryGroupEntries.SalaryGroupId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_SalaryGroupEntries.SalaryHeadId = dbo.swiftfin_SalaryHeads.Id INNER JOIN
                         dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_PaySlipEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
GO
/****** Object:  View [dbo].[vw_StandingOrderTrigger]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_StandingOrderTrigger]
AS
SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.AccountName, dbo.swiftfin_StandingOrders.[Trigger], dbo.swiftfin_StandingOrders.Id
FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_StandingOrders ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId







GO
/****** Object:  View [dbo].[vw_FixedDeposts]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[vw_FixedDeposts]
AS
SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_FixedDeposits.Value, dbo.swiftfin_FixedDeposits.Term, 
                         dbo.swiftfin_FixedDeposits.Rate, dbo.swiftfin_FixedDeposits.Remarks, dbo.swiftfin_FixedDeposits.ExpectedInterest, dbo.swiftfin_FixedDeposits.MaturityDate, 
                         dbo.swiftfin_FixedDeposits.TotalExpected, dbo.swiftfin_FixedDeposits.PaidBy, dbo.swiftfin_FixedDeposits.PaidDate, dbo.swiftfin_FixedDeposits.CreatedBy, 
                         dbo.swiftfin_FixedDeposits.CreatedDate, 
                         CASE dbo.swiftfin_FixedDeposits.Status WHEN 1 THEN 'Running' WHEN 2 THEN 'Paid' WHEN 4 THEN 'Revoked' END AS Status
FROM            dbo.swiftfin_FixedDeposits INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_FixedDeposits.CustomerAccountId = dbo.vw_CustomerAccounts.Id

















GO
/****** Object:  View [dbo].[vw_credittypes]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_credittypes]
AS
SELECT        dbo.swiftfin_CreditTypes.Id AS CreditTypeID, dbo.swiftfin_CreditTypes.Description AS CreditType, dbo.swiftfin_CreditBatchEntries.CustomerAccountId, dbo.swiftfin_CreditBatchEntries.Beneficiary, 
                         dbo.vw_CustomerAccounts.CustomerId, dbo.swiftfin_CreditBatches.BatchNumber
FROM            dbo.swiftfin_CreditBatches INNER JOIN
                         dbo.swiftfin_CreditBatchEntries ON dbo.swiftfin_CreditBatches.Id = dbo.swiftfin_CreditBatchEntries.CreditBatchId INNER JOIN
                         dbo.swiftfin_CreditTypes ON dbo.swiftfin_CreditBatches.CreditTypeId = dbo.swiftfin_CreditTypes.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_CreditBatchEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
GO
/****** Object:  View [dbo].[vw_StandingOrders]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_StandingOrders]
AS
SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Description, dbo.vw_CustomerAccounts.Reference1, dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod, 
                         dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.Interest, dbo.swiftfin_StandingOrders.CapitalizedInterest, dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate, 
                         dbo.swiftfin_LoanProducts.LoanRegistration_TermInMonths, dbo.swiftfin_StandingOrders.[Trigger], dbo.swiftfin_StandingOrders.Id
FROM            dbo.swiftfin_StandingOrders INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id
GO
/****** Object:  UserDefinedFunction [dbo].[AccountProductsBalances]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[AccountProductsBalances] (@EndDate Datetime)
RETURNS TABLE
AS
RETURN
(
    SELECT 
	(SELECT 
	    RIGHT('00000'+CAST(ltrim(rtrim(SerialNumber)) AS VARCHAR(6)),6) 
		FROM [dbo].[swiftfin_Customers] 
		where id= [dbo].[swiftfin_CustomerAccounts].CustomerId) as MembershipNumber,
	(SELECT 
	    Individual_PayrollNumbers
		FROM [dbo].[swiftfin_Customers] 
		where id= [dbo].[swiftfin_CustomerAccounts].CustomerId) as PersonalFileNumber,
	(SELECT 
		[Salutation] =
		CASE Individual_Salutation
			WHEN '48814' THEN 'Mr'
			WHEN '48815' THEN 'Mrs'
			WHEN '48816' THEN 'Miss'
			WHEN '48817' THEN 'Dr'
			WHEN '48818' THEN 'Prof'
			WHEN '48819' THEN 'Rev'
			WHEN '48820' THEN 'Eng'
			WHEN '48821' THEN 'Hon'
			WHEN '48822' THEN 'Cllr'
			WHEN '48823' THEN 'Sir'
			WHEN '48824' THEN 'Ms'
			ELSE 'UnKnown'
		END +' '+
		[Individual_FirstName]+' '+
		[Individual_LastName]
		FROM [dbo].[swiftfin_Customers] 
		WHERE id= [dbo].[swiftfin_CustomerAccounts].CustomerId) as FullName
      ,
	  (SELECT [Description]
        FROM [dbo].[swiftfin_Branches] 
		WHERE ID=[dbo].[swiftfin_CustomerAccounts].[BranchId]) AS BranchName,
 		[Product Type] =
		CASE [CustomerAccountType_ProductCode]
			WHEN 1 THEN 'Savings'
			WHEN 2 THEN 'Loans'
			WHEN 3 THEN 'Investments'
			ELSE 'UnKnown'
		END 
		,
		[Product] =
		CASE [CustomerAccountType_ProductCode]
			WHEN 1 THEN 
				(SELECT 
				 [Description]
				FROM [dbo].[swiftfin_SavingsProducts] 
				WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
			WHEN 2 THEN 
				(SELECT 
				 [Description]
				FROM [dbo].[swiftfin_LoanProducts] 
				WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
			WHEN 3 THEN 
				(SELECT 
				 [Description]
				FROM [dbo].[swiftfin_InvestmentProducts] 
				WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
			ELSE 'UnKnown'
		END,
		[Product Balance] =
		ISNULL(
				CASE [CustomerAccountType_ProductCode]
					WHEN 1 THEN 
					(SELECT 
						 (
							SELECT SUM(AMOUNT)
							FROM [dbo].[swiftfin_JournalEntries] 
							WHERE CustomerAccountId=[dbo].[swiftfin_CustomerAccounts].ID AND ChartOfAccountId=[dbo].[swiftfin_SavingsProducts].[ChartOfAccountId] AND CreatedDate<=@enddate
						 )
					FROM [dbo].[swiftfin_SavingsProducts] 
					WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
					WHEN 2 THEN 
					(SELECT 
						 (
							SELECT SUM(AMOUNT)
							FROM [dbo].[swiftfin_JournalEntries] 
							WHERE CustomerAccountId=[dbo].[swiftfin_CustomerAccounts].ID AND ChartOfAccountId=[dbo].[swiftfin_LoanProducts].[ChartOfAccountId] AND CreatedDate<=@enddate
						 )
					FROM [dbo].[swiftfin_LoanProducts] 
					WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
					WHEN 3 THEN 
					(SELECT 
						 (
							SELECT SUM(AMOUNT)
							FROM [dbo].[swiftfin_JournalEntries] 
							WHERE CustomerAccountId=[dbo].[swiftfin_CustomerAccounts].ID AND ChartOfAccountId=[dbo].[swiftfin_InvestmentProducts].[ChartOfAccountId] AND CreatedDate<=@enddate
						 )
					FROM [dbo].[swiftfin_InvestmentProducts] 
					WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
				ELSE 0
				END 
				,0)
      ,[Remarks]
      ,[CreatedDate]
  FROM [dbo].[swiftfin_CustomerAccounts]

)






GO
/****** Object:  UserDefinedFunction [dbo].[f_GLAccountBalance]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from f_GLAccountBalance('389781E6-0273-C568-AF28-08D115F76AD9','04/30/2014')
create function [dbo].[f_GLAccountBalance] 
(	
	-- Add the parameters for the function here
	@ChartOfAccountId Varchar(MAX), 
	@StartDate Datetime
)
RETURNS TABLE 
AS
RETURN 
(
	-- Add the SELECT statement with parameter references here
		SELECT isnull(sum(amount),0) Balance
		FROM [dbo].[swiftfin_JournalEntries] 
		WHERE ChartOfAccountId=@ChartOfAccountId and CreatedDate<@StartDate

)






GO
/****** Object:  UserDefinedFunction [dbo].[f_MonthlyBudget]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_postingperiods

--select * from dbo.f_MonthlyBudget('01/30/2015','2F015C30-7201-C686-7872-08D1AD41F57B')
create function [dbo].[f_MonthlyBudget] 
(	
	@EndDate DateTime,
	@PostingPeriod varchar(MAX)
)
RETURNS TABLE 
AS 
RETURN 
(
SELECT        dbo.swiftfin_ChartOfAccounts.Id, dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         dbo.swiftfin_BudgetEntries.Amount as TotalBudget, dbo.swiftfin_BudgetEntries.Amount / 12 AS MonthlyBudget,(dbo.swiftfin_BudgetEntries.Amount / 12 )*Month(@EndDate) as BudgetTodate,
                         CASE [AccountType] WHEN 1000000 THEN 'Assets' WHEN 2000000 THEN 'Liabilities' WHEN 3000000 THEN 'Equity' WHEN 4000000 THEN 'Income' WHEN 5000000
                          THEN 'Expenses' END AS [AccountTypeCode], dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, SUM(dbo.swiftfin_JournalEntries.Amount) AS ActualAmount,
						  CASE [AccountType]  WHEN 4000000 then (dbo.swiftfin_BudgetEntries.Amount / 12 )*Month(@EndDate)-SUM(dbo.swiftfin_JournalEntries.Amount)   WHEN 5000000
                          THEN SUM(dbo.swiftfin_JournalEntries.Amount)+(dbo.swiftfin_BudgetEntries.Amount / 12 )*Month(@EndDate)  END as Variance
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_Budgets INNER JOIN
                         dbo.swiftfin_BudgetEntries ON dbo.swiftfin_Budgets.Id = dbo.swiftfin_BudgetEntries.BudgetId INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Budgets.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id ON 
                         dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId RIGHT OUTER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id AND 
                         dbo.swiftfin_BudgetEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
WHERE        (dbo.swiftfin_Budgets.PostingPeriodId IN (@PostingPeriod) and dbo.swiftfin_Journals.ValueDate<=@EndDate) AND (dbo.swiftfin_ChartOfAccounts.AccountType IN (4000000, 5000000))
group by  dbo.swiftfin_ChartOfAccounts.Id, dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName,
 dbo.swiftfin_BudgetEntries.Amount,dbo.swiftfin_PostingPeriods.Description

)






GO
/****** Object:  UserDefinedFunction [dbo].[fnReportTemplate]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



--select Row_number() OVER(ORDER BY (SELECT 1)),* from swiftfin_Customers
----select * from dbo.fnReportTemplate('83D39FF9-9BD3-C1AC-03A2-08D126896BE9') order by rownumber
create function [dbo].[fnReportTemplate] 
(
	@ID VARCHAR(50)
) 
RETURNS TABLE 
AS 
RETURN 

WITH
  cteReports (ID, DESCRIPTION,SpreadsheetCellReference)
  AS
  (
    SELECT ID, space(depth)+DESCRIPTION as Description,SpreadsheetCellReference
    FROM swiftfin_ReportTemplates
    WHERE ParentId IS NULL and id=@ID 
    UNION ALL
    SELECT e.ID, space(depth)+e.Description as Description ,e.SpreadsheetCellReference
    FROM swiftfin_ReportTemplates e
      INNER JOIN cteReports r
        ON e.ParentId = r.ID
  )

SELECT       cteReports.id, cteReports.DESCRIPTION, cteReports.SpreadsheetCellReference, right(cteReports.id,12)  AS 'RowNumber',
iif(dbo.swiftfin_ChartOfAccounts.AccountCode is null,'',isnull(left(ltrim(rtrim(str(dbo.swiftfin_ChartOfAccounts.AccountType))),1),'')+'-'+isnull(ltrim(rtrim(str(dbo.swiftfin_ChartOfAccounts.AccountCode))),'')) as AccountCode, 
                         isnull(dbo.swiftfin_ChartOfAccounts.AccountName,'') as AccountName, isnull(dbo.swiftfin_ChartOfAccounts.AccountType,0) as AccountType
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_ReportTemplateEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_ReportTemplateEntries.ChartOfAccountId RIGHT OUTER JOIN
                        cteReports ON dbo.swiftfin_ReportTemplateEntries.ReportTemplateId = cteReports.ID
						






GO
/****** Object:  UserDefinedFunction [dbo].[fnReportTemplateSummary]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



--select Row_number() OVER(ORDER BY (SELECT 1)),* from swiftfin_Customers
----select * from dbo.fnReportTemplateSummary('83D39FF9-9BD3-C1AC-03A2-08D126896BE9','01/01/2014','12/31/2014') order by rownumber
create function [dbo].[fnReportTemplateSummary] 
(
	@ID VARCHAR(50),
	@StartDate DateTime,
	@EndDate DateTime
) 
RETURNS TABLE 
AS 
RETURN 

WITH
  cteReports (ID, DESCRIPTION,SpreadsheetCellReference)
  AS
  (
    SELECT ID, space(depth)+DESCRIPTION as Description,SpreadsheetCellReference
    FROM swiftfin_ReportTemplates
    WHERE ParentId IS NULL and id=@ID 
    UNION ALL
    SELECT e.ID, space(depth)+e.Description as Description ,e.SpreadsheetCellReference
    FROM swiftfin_ReportTemplates e
      INNER JOIN cteReports r
        ON e.ParentId = r.ID
  )

SELECT       cteReports.id, cteReports.DESCRIPTION, cteReports.SpreadsheetCellReference, right(cteReports.id,12)  AS 'RowNumber',
iif(dbo.swiftfin_ChartOfAccounts.AccountCode is null,'',isnull(left(ltrim(rtrim(str(dbo.swiftfin_ChartOfAccounts.AccountType))),1),'')+'-'+isnull(ltrim(rtrim(str(dbo.swiftfin_ChartOfAccounts.AccountCode))),'')) as AccountCode, 
                         isnull(dbo.swiftfin_ChartOfAccounts.AccountName,'') as AccountName, isnull(dbo.swiftfin_ChartOfAccounts.AccountType,0) as AccountType,
						 isnull((
							select sum(amount) 
							from swiftfin_JournalEntries 
							where ChartOfAccountId =dbo.swiftfin_ChartOfAccounts.Id and CreatedDate Between @StartDate and @EndDate
						 ),0) as Balance
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_ReportTemplateEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_ReportTemplateEntries.ChartOfAccountId RIGHT OUTER JOIN
                        cteReports ON dbo.swiftfin_ReportTemplateEntries.ReportTemplateId = cteReports.ID
						






GO
/****** Object:  UserDefinedFunction [dbo].[GetMonthList]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE function [dbo].[GetMonthList] 
(
	@Date DATE, 
    @inc INT 
)
RETURNS TABLE
AS
RETURN  
(
with cte as
(
    SELECT Inc              = @inc                 
          ,[MonthName]      = DATENAME(mm ,@Date)  
          ,[MonthNumber]    = DATEPART(mm ,@Date)  
          ,[MonthYear]      = DATEPART(yy ,@Date)
		  ,[StartDate]		=DATEADD(MONTH, 0, @Date)  
    UNION ALL
    SELECT inc + 1
          ,DATENAME(mm ,DATEADD(mm ,inc + 1 ,@Date))
          ,DATEPART(mm ,DATEADD(mm ,inc + 1 ,@Date))
          ,CASE WHEN [MonthNumber] = 12 THEN [MonthYear] + 1 ELSE [MonthYear] END
		  ,DATEADD(MONTH, inc+1 , @Date)
		
    FROM    cte
    WHERE  inc < 12
)
select [MonthName],[MonthNumber],[MonthYear],[StartDate],  DATEADD(day, DATEDIFF(day, 0, EOMONTH ([StartDate])), '23:59:59')   as EndDate from cte where [MonthYear]=year(@Date)


)






GO
/****** Object:  UserDefinedFunction [dbo].[TrialBalance]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---SELECT * FROM  dbo.TrialBalance('01/01/2014','04/30/2014')  



create function [dbo].[TrialBalance] 
(
	@StartDate DateTime,
	@EndDate DateTime,
	@PostingPeriod varchar(100)
)
RETURNS TABLE
AS
RETURN 

(
	SELECT        CASE [AccountType] WHEN 1000000 THEN 'Assets' WHEN 2000000 THEN 'Liabilities' WHEN 3000000 THEN 'Equity' WHEN 4000000 THEN 'Income' WHEN 5000000
                          THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000000 THEN 'C' WHEN 2000000 THEN 'D' WHEN 3000000 THEN 'E' WHEN 4000000 THEN 'A' WHEN 5000000 THEN 'B' END AS SortOrder,
                          dbo.swiftfin_Branches.Code, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, 
                         ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit, 
                         dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_CostCenters.Description AS CostCenter, 
                          dbo.swiftfin_PostingPeriods.Description AS PostingPeriod
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id
WHERE dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate and dbo.swiftfin_PostingPeriods.Id=@PostingPeriod
GROUP BY dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_Branches.Description, 
                         dbo.swiftfin_Branches.Code, dbo.swiftfin_CostCenters.Description, dbo.swiftfin_PostingPeriods.Id, dbo.swiftfin_PostingPeriods.Description
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
	)






GO
/****** Object:  UserDefinedFunction [dbo].[TrialBalanceConsolidated]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


---SELECT * FROM  dbo.TrialBalance('01/01/2014','05/31/2014','0777363D-0845-C660-9E58-08D1336CB025')  

--select * from swiftfin_PostingPeriods
create function [dbo].[TrialBalanceConsolidated] 
(
	@StartDate DateTime,
	@EndDate DateTime,
	@PostingPeriod varchar(100)
)
RETURNS TABLE
AS
RETURN 

(
	SELECT        CASE [AccountType] WHEN 1000000 THEN 'Assets' WHEN 2000000 THEN 'Liabilities' WHEN 3000000 THEN 'Equity' WHEN 4000000 THEN 'Income' WHEN 5000000
                          THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000000 THEN 'C' WHEN 2000000 THEN 'D' WHEN 3000000 THEN 'E' WHEN 4000000 THEN 'A' WHEN 5000000 THEN 'B' END AS SortOrder,
                           dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, 
                         ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit, 
                         dbo.swiftfin_ChartOfAccounts.AccountType, 
                          dbo.swiftfin_PostingPeriods.Description AS PostingPeriod
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id
WHERE dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate and dbo.swiftfin_PostingPeriods.Id=@PostingPeriod
GROUP BY dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_PostingPeriods.Id, dbo.swiftfin_PostingPeriods.Description
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
	)







GO
/****** Object:  View [dbo].[View_signatories]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[View_signatories]
AS
SELECT        FOSA.dbo.customer.fosa_acno, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_CustomerAccounts.Id, dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, FOSA.dbo.customer.signname1, FOSA.dbo.customer.sign1, 
                         FOSA.dbo.customer.signname2, FOSA.dbo.customer.sign2, FOSA.dbo.customer.signname3, FOSA.dbo.customer.sign3, FOSA.dbo.customer.signname4, FOSA.dbo.customer.sign4, FOSA.dbo.customer.signname5, 
                         FOSA.dbo.customer.sign5, FOSA.dbo.customer.auth_idno1, FOSA.dbo.customer.auth_name1, FOSA.dbo.customer.auth_name, FOSA.dbo.customer.auth_idno
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         FOSA.dbo.customer ON dbo.swiftfin_Customers.Reference1 = FOSA.dbo.customer.fosa_acno COLLATE Latin1_General_CI_AS
WHERE        (dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode = 1)
GO
/****** Object:  View [dbo].[vw_Advtypes]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_Advtypes]
AS
SELECT        TOP (100) PERCENT code, desc_
FROM            FOSA.dbo.lntypes
WHERE        (code LIKE '%L%')
GO
/****** Object:  View [dbo].[vw_ATMcards]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_ATMcards]
AS
SELECT        dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Individual_PayrollNumbers, dbo.swiftfin_AlternateChannels.CardNumber
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_AlternateChannels ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_AlternateChannels.CustomerAccountId
GO
/****** Object:  View [dbo].[vw_Budget]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[vw_Budget]
AS
SELECT        dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_Budgets.TotalValue, dbo.swiftfin_Budgets.Description AS BudgetDescription, 
                         dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_BudgetEntries.Amount, dbo.swiftfin_BudgetEntries.CreatedDate, 
                         dbo.swiftfin_PostingPeriods.ClosedBy, dbo.swiftfin_PostingPeriods.ClosedDate, dbo.swiftfin_Budgets.PostingPeriodId, dbo.swiftfin_BudgetEntries.ChartOfAccountId
FROM            dbo.swiftfin_BudgetEntries INNER JOIN
                         dbo.swiftfin_Budgets ON dbo.swiftfin_BudgetEntries.BudgetId = dbo.swiftfin_Budgets.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Budgets.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_BudgetEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
















GO
/****** Object:  View [dbo].[vw_ClosedAccounts]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_ClosedAccounts]
AS
SELECT        TOP (100) PERCENT dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Individual_PayrollNumbers, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, 
                         BOSA.dbo.customer.pf_no, BOSA.dbo.customer.ldate, dbo.swiftfin_Customers.Remarks
FROM            dbo.swiftfin_Customers INNER JOIN
                         BOSA.dbo.customer ON dbo.swiftfin_Customers.Reference2 = BOSA.dbo.customer.pf_no
WHERE        (BOSA.dbo.customer.ldate IS NOT NULL)
ORDER BY dbo.swiftfin_Customers.Reference2
GO
/****** Object:  View [dbo].[vw_CreditBatchEntries]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_CreditBatchEntries]
WITH SCHEMABINDING 
AS
SELECT        REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 5), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), 
                         '0') AS FullAccountNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8'
                          THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN 'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         dbo.swiftfin_CreditBatchEntries.Principal, dbo.swiftfin_CreditBatchEntries.Interest, dbo.swiftfin_CreditBatchEntries.CreatedDate AS CreditBatchEntriesDate, dbo.swiftfin_CreditTypes.Description AS CreditType, 
                         dbo.swiftfin_ChartOfAccounts.AccountCode AS GLAccountCode, dbo.swiftfin_ChartOfAccounts.AccountName AS GLAccountName, dbo.swiftfin_CreditBatches.BatchNumber, 
                         CASE dbo.swiftfin_CreditBatches.Type WHEN '56026' THEN 'Payout' WHEN '56027' THEN 'Check-off' ELSE 'Unknown' END AS CreditBatchType, dbo.swiftfin_CreditBatches.Reference, 
                         dbo.swiftfin_CreditBatches.TotalValue, CASE dbo.swiftfin_CreditBatches.Status WHEN 1 THEN 'Pending' WHEN 2 THEN 'Posted' WHEN 4 THEN 'Suspended' END AS BatchStatus, dbo.swiftfin_CreditBatches.AuthorizedBy, 
                         dbo.swiftfin_CreditBatches.AuthorizationRemarks, dbo.swiftfin_CreditBatches.AuthorizedDate, dbo.swiftfin_CreditBatches.CreatedBy, dbo.swiftfin_CreditBatches.CreatedDate, 
                         dbo.swiftfin_Commissions.Description AS CommissionType
FROM            dbo.swiftfin_CreditBatchEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_CreditBatchEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_CreditBatches ON dbo.swiftfin_CreditBatchEntries.CreditBatchId = dbo.swiftfin_CreditBatches.Id AND dbo.swiftfin_Branches.Id = dbo.swiftfin_CreditBatches.BranchId INNER JOIN
                         dbo.swiftfin_CreditTypes ON dbo.swiftfin_CreditBatches.CreditTypeId = dbo.swiftfin_CreditTypes.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_CreditTypes.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id LEFT OUTER JOIN
                         dbo.swiftfin_CreditTypeCommissions ON dbo.swiftfin_CreditTypes.Id = dbo.swiftfin_CreditTypeCommissions.CreditTypeId LEFT OUTER JOIN
                         dbo.swiftfin_Commissions ON dbo.swiftfin_CreditTypeCommissions.CommissionId = dbo.swiftfin_Commissions.Id







GO
/****** Object:  View [dbo].[vw_CustomerAccountsBalances]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create view [dbo].[vw_CustomerAccountsBalances]
AS
SELECT        TOP (100) PERCENT REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccount, 
                         CASE [Individual_Salutation] WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818' THEN 'Prof' WHEN '48819'
                          THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN 'Ms' ELSE 'UnKnown' END
                          + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, dbo.swiftfin_ChartOfAccounts.AccountCode, 
                         dbo.swiftfin_ChartOfAccounts.AccountName, Products_1.Description,
                             (SELECT        SUM(Amount) AS Expr1
                               FROM            dbo.swiftfin_JournalEntries
                               WHERE        (CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id) AND (CONVERT(varchar(50), ChartOfAccountId) = Products_1.ChartOfAccountId)) 
                         AS AccountBalance,
                             (SELECT        SUM(Amount) AS Expr1
                               FROM            dbo.swiftfin_JournalEntries AS swiftfin_JournalEntries_1
                               WHERE        (CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id) AND (CONVERT(varchar(50), ChartOfAccountId) = Products_1.InterestReceivable) AND 
                                                         (Products_1.InterestReceivable <> null)) AS InterestBalance
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.Products(1) AS Products_1 ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON Products_1.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id











GO
/****** Object:  View [dbo].[vw_CustomerAccountsWithoutProductDescription]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_CustomerAccountsWithoutProductDescription]
WITH SCHEMABINDING 
AS
SELECT        REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), 
                         '0') AS FullAccount, 
                         CASE [Individual_Salutation] WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN
                          '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN 'Ms' ELSE '' END + ' ' + RTRIM(LTRIM(ISNULL(dbo.swiftfin_Customers.Individual_FirstName, ''))) 
                         + ' ' + LTRIM(LTRIM(ISNULL(dbo.swiftfin_Customers.Individual_LastName, ''))) + ' ' + LTRIM(RTRIM(ISNULL(dbo.swiftfin_Customers.NonIndividual_Description, ''))) AS FullName, dbo.swiftfin_CustomerAccounts.Id, 
                         dbo.swiftfin_CustomerAccounts.CustomerId, dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId, dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 
                         dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_CustomerAccounts.BranchId, dbo.swiftfin_Customers.Reference2, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_CustomerAccounts.Remarks, dbo.swiftfin_Customers.NonIndividual_RegistrationNumber, dbo.swiftfin_Customers.StationId, 
                         dbo.swiftfin_Customers.SerialNumber
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id







GO
/****** Object:  View [dbo].[vw_Customers]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vw_Customers]
WITH SCHEMABINDING 
AS
SELECT        CASE Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN
                          '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN 'Ms' ELSE '' END + ' ' + Individual_FirstName + ' ' + Individual_LastName AS FullName, 
                         CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
                         CASE Individual_MaritalStatus WHEN '1' THEN 'Married' WHEN '2' THEN 'Single' WHEN '3' THEN 'Divorced' WHEN '4' THEN 'Separated' ELSE 'UnKnown' END AS MaritalStatus, Individual_IdentityCardNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Nationality WHEN 1 THEN 'Kenya' WHEN 2 THEN 'Uganda' WHEN 3 THEN 'Tanzania' WHEN 4 THEN 'Rwanda' WHEN 4 THEN 'Burundi' ELSE 'UnKnown' END AS Nationality,
                          RIGHT('00000' + CAST(LTRIM(RTRIM(SerialNumber)) AS VARCHAR(5)), 5) AS MembershipNumber, Individual_PayrollNumbers, Individual_BirthDate, Address_AddressLine1, Address_AddressLine2, 
                         Address_Street, Address_PostalCode, Address_City, Address_Email, Address_LandLine, Address_MobileLine, RegistrationDate, CreatedDate, '' AS [Witness Person], Individual_EmploymentDate, 
                         Individual_EmploymentDesignation, REPLACE(STR(SerialNumber, 5), SPACE(1), '0') AS DelegateMembershipNumber, LTRIM(RTRIM(Individual_FirstName)) + ' ' + LTRIM(RTRIM(Individual_LastName)) 
                         AS DelegateName, Id, REPLACE(STR(SerialNumber, 6), SPACE(1), '0') AS SerialNumber, Reference1, Reference2, Reference3,nonindividual_description
FROM            dbo.swiftfin_Customers
               








GO
/****** Object:  View [dbo].[vw_CustomersCRB]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vw_CustomersCRB]
AS
SELECT        TOP (100) PERCENT REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccount, 
                         dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, + '' + ISNULL(dbo.swiftfin_Customers.NonIndividual_Description, '') 
                         AS FullName, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, Products_1.Description, dbo.swiftfin_CustomerAccounts.Id, 
                         dbo.swiftfin_CustomerAccounts.CustomerId, dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId, 
                         dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 
                         dbo.swiftfin_Customers.Reference1, dbo.swiftfin_CustomerAccounts.BranchId, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Individual_PayrollNumbers, 
                         dbo.swiftfin_Customers.Reference3, dbo.swiftfin_CustomerAccounts.Remarks, dbo.swiftfin_Customers.NonIndividual_RegistrationNumber, 
                         dbo.swiftfin_Customers.StationId, dbo.swiftfin_Customers.SerialNumber, dbo.swiftfin_Customers.Address_MobileLine, dbo.swiftfin_Customers.Individual_Gender, 
                         dbo.swiftfin_Customers.Individual_Salutation, dbo.swiftfin_Customers.Individual_BirthDate, dbo.swiftfin_Customers.Individual_MaritalStatus, 
                         dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Address_LandLine, dbo.swiftfin_Customers.Address_AddressLine1, 
                         dbo.swiftfin_Customers.Address_AddressLine2, dbo.swiftfin_Customers.Address_PostalCode, dbo.swiftfin_Customers.Address_Email, 
                         dbo.swiftfin_Customers.Individual_EmploymentDesignation, dbo.swiftfin_Customers.Individual_EmploymentDate, 
                         dbo.swiftfin_Customers.Individual_EmploymentTermsOfService
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.Products(1) AS Products_1 ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON Products_1.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id


GO
/****** Object:  View [dbo].[vw_CustomerTransactionAuthRequests]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_CustomerTransactionAuthRequests] as  select top 1 * from swiftfin_customers











GO
/****** Object:  View [dbo].[vw_Employers]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_Employers]
AS
SELECT        dbo.swiftfin_Employers.Id AS EmployerID, dbo.swiftfin_Employers.Description AS Employer, dbo.swiftfin_Divisions.Id AS DivisionID, dbo.swiftfin_Divisions.Description AS Division, dbo.swiftfin_Zones.Id AS ZoneID, 
                         dbo.swiftfin_Zones.Description AS Zone, dbo.swiftfin_Stations.Id AS StationID, dbo.swiftfin_Stations.Description AS Station
FROM            dbo.swiftfin_Employers INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Employers.Id = dbo.swiftfin_Divisions.EmployerId INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Divisions.Id = dbo.swiftfin_Zones.DivisionId INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Stations.ZoneId
GO
/****** Object:  View [dbo].[vw_EmployerStationMapping]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_EmployerStationMapping]
AS
SELECT        dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Customers.StationId, dbo.EmployersMapping.NAME, dbo.EmployersMapping.[STATION NAME], 
                         dbo.EmployersMapping.[PF NO]
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.EmployersMapping ON dbo.swiftfin_Customers.Reference3 = dbo.EmployersMapping.[PF NO]
GO
/****** Object:  View [dbo].[vw_FiscalCount]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[vw_FiscalCount]
WITH SCHEMABINDING
AS
SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_FiscalCounts.SecondaryDescription, dbo.swiftfin_FiscalCounts.Reference, 
                         dbo.swiftfin_FiscalCounts.Denomination_OneThousandValue, dbo.swiftfin_FiscalCounts.Denomination_FiveHundredValue, 
                         dbo.swiftfin_FiscalCounts.Denomination_TwoHundredValue, dbo.swiftfin_FiscalCounts.Denomination_OneHundredValue, dbo.swiftfin_FiscalCounts.Denomination_FiftyValue, 
                         dbo.swiftfin_FiscalCounts.Denomination_FourtyValue, dbo.swiftfin_FiscalCounts.Denomination_TwentyValue, dbo.swiftfin_FiscalCounts.Denomination_TenValue, 
                         dbo.swiftfin_FiscalCounts.Denomination_FiveValue, dbo.swiftfin_FiscalCounts.Denomination_OneValue, dbo.swiftfin_FiscalCounts.Denomination_FiftyCentValue, 
                         dbo.swiftfin_FiscalCounts.CreatedBy, dbo.swiftfin_FiscalCounts.CreatedDate
FROM            dbo.swiftfin_FiscalCounts INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_FiscalCounts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id

















GO
/****** Object:  View [dbo].[vw_FosaLoanInterest]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_FosaLoanInterest]
AS
SELECT        dbo.swiftfin_StandingOrders.PaymentPerPeriod, dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.Interest, dbo.swiftfin_StandingOrders.CapitalizedInterest, 
                         dbo.swiftfin_StandingOrders_Copy.PaymentPerPeriod AS PaymentPerPeriod2, dbo.swiftfin_StandingOrders_Copy.Principal AS Principal2, dbo.swiftfin_StandingOrders_Copy.Interest AS Interest2, 
                         dbo.swiftfin_StandingOrders_Copy.CapitalizedInterest AS CapitalizedInterest2
FROM            dbo.swiftfin_StandingOrders INNER JOIN
                         dbo.swiftfin_StandingOrders_Copy ON dbo.swiftfin_StandingOrders.Id = dbo.swiftfin_StandingOrders_Copy.Id
WHERE        (dbo.swiftfin_StandingOrders.[Trigger] = 0) AND (dbo.swiftfin_StandingOrders.Remarks = 'FOSA LOAN')
GO
/****** Object:  View [dbo].[vw_GlName]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_GlName]
AS
SELECT        acno, desc_, branch
FROM            FOSA.dbo.gledger
GO
/****** Object:  View [dbo].[vw_journals]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create  view [dbo].[vw_journals]
as
SELECT        dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
dbo.swiftfin_JournalEntries.Amount,dbo.swiftfin_Journals.CreatedDate
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId
WHERE        (dbo.swiftfin_JournalEntries.ChartOfAccountId = '6E377C4B-F02A-CC8E-29CA-08D3E7027F17' or ContraChartOfAccountId= '6E377C4B-F02A-CC8E-29CA-08D3E7027F17') 
AND (dbo.swiftfin_JournalEntries.CreatedDate = '05/02/2017')



GO
/****** Object:  View [dbo].[vw_KBABankListing]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[vw_KBABankListing]
AS
SELECT        REPLACE(STR(dbo.swiftfin_Banks.Code, 2), SPACE(1), '0') AS BankCode, dbo.swiftfin_Banks.Description, REPLACE(STR(dbo.swiftfin_BankBranches.Code, 3), SPACE(1), '0') 
                         AS BankBranchCode, dbo.swiftfin_BankBranches.Description AS BankBranch
FROM            dbo.swiftfin_Banks INNER JOIN
                         dbo.swiftfin_BankBranches ON dbo.swiftfin_Banks.Id = dbo.swiftfin_BankBranches.BankId
















GO
/****** Object:  View [dbo].[vw_lntypes]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vw_lntypes]
AS
SELECT        code, name
FROM            BOSA.dbo.lntypes
WHERE        (LEFT(code, 1) = 'L')

GO
/****** Object:  View [dbo].[vw_LoanDynamicCharges]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_LoanDynamicCharges]
AS
SELECT        dbo.swiftfin_LoanProducts.Id AS LoanProductId, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_Commissions.Description AS Commission, dbo.swiftfin_GraduatedScales.Charge_Percentage, 
                         dbo.swiftfin_GraduatedScales.Charge_FixedAmount
FROM            dbo.swiftfin_LoanProductDynamicCharges INNER JOIN
                         dbo.swiftfin_DynamicCharges ON dbo.swiftfin_LoanProductDynamicCharges.DynamicChargeId = dbo.swiftfin_DynamicCharges.Id INNER JOIN
                         dbo.swiftfin_DynamicChargeCommissions ON dbo.swiftfin_DynamicCharges.Id = dbo.swiftfin_DynamicChargeCommissions.DynamicChargeId INNER JOIN
                         dbo.swiftfin_Commissions ON dbo.swiftfin_DynamicChargeCommissions.CommissionId = dbo.swiftfin_Commissions.Id INNER JOIN
                         dbo.swiftfin_GraduatedScales ON dbo.swiftfin_Commissions.Id = dbo.swiftfin_GraduatedScales.CommissionId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanProductDynamicCharges.LoanProductId = dbo.swiftfin_LoanProducts.Id
GO
/****** Object:  View [dbo].[vw_LoaningList]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[vw_LoaningList]
WITH SCHEMABINDING 
AS
SELECT        dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, SPACE(10) AS FileReference, 
                         dbo.swiftfin_LoanCases.CaseNumber, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8'
                          THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN 'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
                         CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed' WHEN '48830' THEN 'Rejected' WHEN '48831'
                          THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
                         CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection, 
                         REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers AS PersonalFileNumber, dbo.swiftfin_LoanCases.AppraisedBy, 
                         dbo.swiftfin_LoanCases.AppraisedDate, dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
                         dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, 
                         dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, 
                         dbo.swiftfin_LoanCases.DisbursedDate, dbo.swiftfin_LoanCases.DisbursedAmount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, dbo.swiftfin_LoanCases.TotalPaybackAmount, 
                         dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, dbo.swiftfin_LoanCases.TotalLoansBalance, 
                         CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE 'Unknown' END AS LoanInterest_CalculationMode,
                          CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, dbo.swiftfin_LoanCases.CreatedBy, 
                         dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, dbo.swiftfin_LoanCases.LoanProductId, 
                         CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UNKNOWN' END AS ProductSection, 
                         dbo.swiftfin_LoanCases.BatchNumber AS DisburseBatchNumber,dbo.swiftfin_CostCenters.id,dbo.swiftfin_CostCenters.Description,dbo.swiftfin_ChartOfAccounts.CostCenterId
FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id  INNER JOIN
						 dbo.swiftfin_ChartOfAccounts on dbo.swiftfin_LoanProducts.ChartOfAccountId=dbo.swiftfin_ChartOfAccounts.id inner join 
						 dbo.swiftfin_CostCenters on  dbo.swiftfin_ChartOfAccounts.CostCenterId=dbo.swiftfin_CostCenters.Id

						 ---select * from swiftfin_loanproducts
						





GO
/****** Object:  View [dbo].[vw_MemberRegister]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
/*LEFT OUTER JOIN
dbo.swiftfin_Customers AS swiftfin_Customers_1 ON swiftfin_Customers_2.WitnessId = swiftfin_Customers_1.WitnessId*/
CREATE VIEW [dbo].[vw_MemberRegister]
WITH SCHEMABINDING 
AS
SELECT        CASE swiftfin_Customers_2.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN
                          '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN 'Ms' ELSE '' END AS Salutation, swiftfin_Customers_2.Individual_FirstName, swiftfin_Customers_2.Individual_LastName, 
                         CASE swiftfin_Customers_2.Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
                         CASE swiftfin_Customers_2.Individual_MaritalStatus WHEN '1' THEN 'Married' WHEN '2' THEN 'Single' WHEN '3' THEN 'Divorced' WHEN '4' THEN 'Separated' ELSE 'UnKnown' END AS MaritalStatus, 
                         swiftfin_Customers_2.Individual_IdentityCardNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Nationality WHEN 1 THEN 'Kenya' WHEN 2 THEN 'Uganda' WHEN 3 THEN 'Tanzania' WHEN 4 THEN 'Rwanda' WHEN 4 THEN 'Burundi' ELSE 'UnKnown' END AS Nationality, 
                         RIGHT('00000' + CAST(LTRIM(RTRIM(swiftfin_Customers_2.SerialNumber)) AS VARCHAR(5)), 5) AS MembershipNumber, swiftfin_Customers_2.Individual_PayrollNumbers, swiftfin_Customers_2.Individual_BirthDate, 
                         swiftfin_Customers_2.Address_AddressLine1, swiftfin_Customers_2.Address_AddressLine2, swiftfin_Customers_2.Address_Street, swiftfin_Customers_2.Address_PostalCode, swiftfin_Customers_2.Address_City, 
                         swiftfin_Customers_2.Address_Email, swiftfin_Customers_2.Address_LandLine, swiftfin_Customers_2.Address_MobileLine, swiftfin_Customers_2.RegistrationDate, swiftfin_Customers_2.CreatedDate, '' AS [Witness Person], 
                         dbo.swiftfin_Stations.Description AS Station, dbo.swiftfin_Zones.Description AS Zone, dbo.swiftfin_Divisions.Description AS Division, dbo.swiftfin_Employers.Description AS Employer, swiftfin_Customers_2.Individual_EmploymentDate, 
                         swiftfin_Customers_2.Individual_EmploymentDesignation, REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 5), SPACE(1), '0') AS DelegateMembershipNumber, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers AS DelegatePersonalFileNumber, LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_FirstName)) + ' ' + LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS DelegateName, 
                         swiftfin_Customers_2.Id, REPLACE(STR(swiftfin_Customers_2.SerialNumber, 6), SPACE(1), '0') AS SerialNumber, swiftfin_Customers_2.Reference1, swiftfin_Customers_2.Reference2, swiftfin_Customers_2.Reference3, 
                         swiftfin_Customers_2.NonIndividual_Description
FROM            dbo.swiftfin_Zones INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Stations.ZoneId INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
                         dbo.swiftfin_Delegates ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Delegates.ZoneId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Delegates.CustomerId = dbo.swiftfin_Customers.Id RIGHT OUTER JOIN
                         dbo.swiftfin_Customers AS swiftfin_Customers_2 ON dbo.swiftfin_Stations.Id = swiftfin_Customers_2.StationId



GO
/****** Object:  View [dbo].[vw_MicroGroupMembers]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_MicroGroupMembers]
AS
SELECT        FOSA.dbo.Group_Designation.Code, FOSA.dbo.Group_Designation.Name AS Designation, FOSA.dbo.GroupMember.GroupAcc, FOSA.dbo.GroupMember.GroupName, FOSA.dbo.GroupMember.fosa_Acno, 
                         FOSA.dbo.GroupMember.name, swiftfin_Customers_1.Id AS GroupCustomerID, swiftfin_Customers_1.NonIndividual_Description, dbo.swiftfin_Customers.Id AS CustomerID, 
                         dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName
FROM            FOSA.dbo.GroupMember INNER JOIN
                         FOSA.dbo.Group_Designation ON FOSA.dbo.GroupMember.designation = FOSA.dbo.Group_Designation.Code INNER JOIN
                         dbo.swiftfin_Customers AS swiftfin_Customers_1 ON FOSA.dbo.GroupMember.GroupAcc = swiftfin_Customers_1.Reference1 INNER JOIN
                         dbo.swiftfin_Customers ON FOSA.dbo.GroupMember.fosa_Acno = dbo.swiftfin_Customers.Reference1
GO
/****** Object:  View [dbo].[vw_NextofKin]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_NextofKin]
AS
SELECT        dbo.swiftfin_NextOfKin.FirstName, dbo.swiftfin_NextOfKin.LastName, dbo.swiftfin_NextOfKin.NominatedPercentage, dbo.NextofKin.divisor
FROM            dbo.swiftfin_NextOfKin INNER JOIN
                         dbo.NextofKin ON dbo.swiftfin_NextOfKin.CustomerId = dbo.NextofKin.customerid
GO
/****** Object:  View [dbo].[vw_Overdeductions]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_Overdeductions]
AS
SELECT        REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), 
                         SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccountNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN
                          '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN 'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, REPLACE(STR(swiftfin_Branches_1.Code, 3), 
                         SPACE(1), '0') + '-' + REPLACE(STR(swiftfin_Customers_1.SerialNumber, 6), SPACE(1), '0') + '-' + REPLACE(STR(swiftfin_CustomerAccounts_1.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS CredutAccountNumber, 
                         CASE swiftfin_Customers_1.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN
                          '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN 'Ms' ELSE '' END + ' ' + swiftfin_Customers_1.Individual_FirstName + ' ' + swiftfin_Customers_1.Individual_LastName AS CreditName, 
                         Products_1.Description AS DebitProductType, dbo.swiftfin_OverDeductionBatchEntries.Principal, dbo.swiftfin_OverDeductionBatchEntries.Interest, dbo.swiftfin_OverDeductionBatches.BatchNumber, 
                         dbo.swiftfin_OverDeductionBatches.Reference, dbo.swiftfin_OverDeductionBatches.TotalValue, 
                         CASE dbo.swiftfin_OverDeductionBatches.Status WHEN 1 THEN 'Pending' WHEN 2 THEN 'Posted' WHEN 4 THEN 'Suspended' ELSE 'UnKnown' END AS Status, dbo.swiftfin_OverDeductionBatches.AuthorizedBy, 
                         dbo.swiftfin_OverDeductionBatches.AuthorizationRemarks, dbo.swiftfin_OverDeductionBatches.AuthorizedDate, dbo.swiftfin_OverDeductionBatches.CreatedBy, dbo.swiftfin_OverDeductionBatches.CreatedDate, 
                         Products_2.Description AS CreditProduct, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3
FROM            dbo.swiftfin_OverDeductionBatchEntries INNER JOIN
                         dbo.swiftfin_OverDeductionBatches ON dbo.swiftfin_OverDeductionBatchEntries.OverDeductionBatchId = dbo.swiftfin_OverDeductionBatches.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_OverDeductionBatchEntries.DebitCustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.Products(0) AS Products_1 ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id INNER JOIN
                         dbo.swiftfin_CustomerAccounts AS swiftfin_CustomerAccounts_1 ON dbo.swiftfin_OverDeductionBatchEntries.CreditCustomerAccountId = swiftfin_CustomerAccounts_1.Id INNER JOIN
                         dbo.swiftfin_Customers AS swiftfin_Customers_1 ON swiftfin_CustomerAccounts_1.CustomerId = swiftfin_Customers_1.Id INNER JOIN
                         dbo.swiftfin_Branches AS swiftfin_Branches_1 ON swiftfin_CustomerAccounts_1.BranchId = swiftfin_Branches_1.Id INNER JOIN
                         dbo.Products(0) AS Products_2 ON swiftfin_CustomerAccounts_1.CustomerAccountType_TargetProductId = Products_2.id



GO
/****** Object:  View [dbo].[vw_Phone]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_Phone]
AS
SELECT        dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Address_MobileLine, dbo.swiftfin_Customers.Reference1, FOSA.dbo.customer.name, FOSA.dbo.customer.fosa_acno, 
                         FOSA.dbo.customer.telephone1
FROM            dbo.swiftfin_Customers INNER JOIN
                         FOSA.dbo.customer ON dbo.swiftfin_Customers.Reference1 = FOSA.dbo.customer.fosa_acno
GO
/****** Object:  View [dbo].[vw_PhoneNoId]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_PhoneNoId]
AS
SELECT        FOSA.dbo.MasterFile_Import.fosa_acno, dbo.swiftfin_Customers.Reference1, FOSA.dbo.MasterFile_Import.name, FOSA.dbo.MasterFile_Import.idno, dbo.swiftfin_Customers.Individual_IdentityCardNumber, 
                         dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Address_MobileLine, FOSA.dbo.MasterFile_Import.Tel
FROM            dbo.swiftfin_Customers INNER JOIN
                         FOSA.dbo.MasterFile_Import ON dbo.swiftfin_Customers.Reference1 = FOSA.dbo.MasterFile_Import.fosa_acno
GO
/****** Object:  View [dbo].[vw_PreviousGLStatement]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_PreviousGLStatement]
AS
SELECT        acno AS GLCode, fosa_acno AS AccntNo, name AS Customer, trdate, trdescpt, debit, credit, ref
FROM            FOSA.dbo.gltrans
GO
/****** Object:  View [dbo].[vw_SalaryGroups]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[vw_SalaryGroups]
AS
SELECT        dbo.swiftfin_SalaryGroups.Description, dbo.swiftfin_SalaryGroupEntries.Charge_Percentage, dbo.swiftfin_SalaryGroupEntries.Charge_FixedAmount, 
                         dbo.swiftfin_SalaryHeads.Description AS SalaryHead, 
                         CASE dbo.swiftfin_SalaryGroupEntries.RoundingType WHEN 1 THEN 'To Even' WHEN 2 THEN 'Away From Zero' WHEN 4 THEN 'No Rounding' END AS RoundingType
FROM            dbo.swiftfin_SalaryGroups INNER JOIN
                         dbo.swiftfin_SalaryGroupEntries ON dbo.swiftfin_SalaryGroups.Id = dbo.swiftfin_SalaryGroupEntries.SalaryGroupId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_SalaryGroupEntries.SalaryHeadId = dbo.swiftfin_SalaryHeads.Id
















GO
/****** Object:  View [dbo].[vw_SalaryHeads]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE view [dbo].[vw_SalaryHeads]
AS
SELECT        dbo.swiftfin_SalaryHeads.Description, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         CASE dbo.swiftfin_SalaryHeads.Category WHEN 1 THEN 'Earning' WHEN 2 THEN 'Deduction' END AS Category, dbo.swiftfin_SalaryHeads.Category AS Category1
FROM            dbo.swiftfin_SalaryHeads INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_SalaryHeads.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id















GO
/****** Object:  View [dbo].[vw_Shtypes]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_Shtypes]
AS
SELECT        code, name
FROM            BOSA.dbo.lntypes
WHERE        (LEFT(code, 1) = 's')
GO
/****** Object:  View [dbo].[vw_Standing]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_Standing]
AS
SELECT        TOP (100) PERCENT dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod, dbo.Standing.Amount
FROM            dbo.Standing INNER JOIN
                         dbo.swiftfin_StandingOrders ON dbo.Standing.ID = dbo.swiftfin_StandingOrders.Id
GO
/****** Object:  View [dbo].[vw_StandingOrder2]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vw_StandingOrder2]
AS
SELECT        dbo.swiftfin_StandingOrders.Id, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, 
                         dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod, dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.Interest, dbo.swiftfin_StandingOrders.CapitalizedInterest
FROM            dbo.swiftfin_StandingOrders INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
WHERE        (dbo.swiftfin_StandingOrders.[Trigger] = 0)
GO
/****** Object:  StoredProcedure [dbo].[AnnexShareBalancesReport]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_InvestmentProducts
--[AnnexShareBalancesReport] '06/30/2018'
CREATE procedure [dbo].[AnnexShareBalancesReport] 

@Enddate as datetime
as



With InvestmentProductBalances(AccountNo,SHARENUMBER,Reference2,MEMBERNUMBER,MEMBERNAME,TYPE,SHAREAMOUNT,GUARANTEEAMOUNT,Branch,Interest)
AS(
SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('8D5515F8-C27F-CCF4-7117-08D2B78E3546') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId,  dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
		--sacco shares
union
SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('0CB0E78F-773C-C794-70B0-08D2B78E6216') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
--Group shares
union
SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('3CFF67CE-AD4F-C4BB-64C1-08D2B78E74BD') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
		--boost shares
		union

		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('89B62B58-7F96-C12C-8DE7-08D2B78E86A5') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
		--institutional staff
		union
				SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('08DBABDA-0ED3-C6B3-8DF7-08D2B78E9354') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
		--institutional group
		union
					SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('92AEEDA5-4558-C551-60F8-08D2B916671E') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
		--Baloon shares
		union

					SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('7757652F-FA40-CF61-C3C7-08D2BF34EFE7') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
		--Arise and shine 
		union

					SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('627B84BC-131D-E811-9493-42F2E9267749') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
		--mimea shares
		union
		
					SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('57E9DCAF-F054-C0EB-4258-08D3227D54E8') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
		 --surplus shares
		 union
		 					SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('D43E05B4-5978-C155-DF81-08D325890F58') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId

		--BIDII SHARES
		UNION
				 					SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		,(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('9EF80B2A-E69D-C53F-BB80-08D377C9E8CA') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId)
		--EDUCATION SHARES
		--UNION
		--		 					SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		--dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		--SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		--(select sum(swiftfin_LoanGuarantors.AmountPledged) from dbo.swiftfin_LoanGuarantors where CustomerId=dbo.vw_CustomerAccounts.CustomerId AND STATUS=0  ) as guaranteeAmount
		--FROM            dbo.vw_CustomerAccounts INNER JOIN
		--						 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
		--						 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
		--						 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		--WHERE        (dbo.swiftfin_InvestmentProducts.id in ('91E87B3E-BBD5-C05A-749D-08D37AF98587') and dbo.swiftfin_JournalEntries.createddate<=@Enddate)
		--GROUP BY dbo.vw_CustomerAccounts.BranchId, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		--dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId)

		select SHARENUMBER as AccountNo,Reference2,MEMBERNUMBER,MEMBERNAME,TYPE,SHAREAMOUNT,IIF(GUARANTEEAMOUNT>SHAREAMOUNT,SHAREAMOUNT,GUARANTEEAMOUNT) AS GUARANTEEAMOUNT,Branch as BranchName,
		Interest AS DepositInterest
		 from InvestmentProductBalances 
		GROUP BY Branch,Interest, AccountNo,SHARENUMBER,Reference2,MEMBERNUMBER,MEMBERNAME, TYPE, SHAREAMOUNT,GUARANTEEAMOUNT  having (SHAREAMOUNT)<>0 

		--benevolent fund

		--select * from swiftfin_InvestmentProducts 
GO
/****** Object:  StoredProcedure [dbo].[AnnexShareCapitalReport]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_InvestmentProducts
--[AnnexShareBalancesReport] '10/30/2017'
create procedure [dbo].[AnnexShareCapitalReport] 

@Enddate as datetime
as



With InvestmentProductBalances(AccountNo,SHARENUMBER,Reference2,MEMBERNUMBER,MEMBERNAME,TYPE,SHAREAMOUNT)
AS(
SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('AD144688-0F75-4734-BAFF-0D0B0381846C') and dbo.swiftfin_JournalEntries.ValueDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
		)

			select * from InvestmentProductBalances 
		GROUP BY AccountNo,SHARENUMBER,Reference2,MEMBERNUMBER,MEMBERNAME, TYPE, SHAREAMOUNT  having (SHAREAMOUNT)<>0 
GO
/****** Object:  StoredProcedure [dbo].[CRB_REPORT]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--[CRB_report] '11/10/2018'
--select convert(varchar(8),getdate(),112)
CREATE PROC [dbo].[CRB_REPORT] (@EndDate datetime)
AS
set nocount on
--select * from vw_CustomersCRB
select 
---vw_CustomersCRB.FullName,
vw_CustomersCRB.Individual_FirstName AS FirstName ,
vw_CustomersCRB.Individual_LastName AS SurName,
 CASE vw_CustomersCRB.Individual_Salutation  WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '10' THEN 'Sir' WHEN '11' THEN
 'Ms' ELSE 'UnKnown' END AS SALUTATION,                       
convert(varchar(8),vw_CustomersCRB.[Individual_BirthDate],112) AS DateOfBirth,
vw_CustomersCRB.Reference2 AS MemberNumber,
vw_CustomersCRB.Reference1 AS AccountNumber,
Case vw_CustomersCRB.Individual_Gender when '1'Then 'Male' WHEN '2' THEN 'Female' else 'Unkown' END AS Gender,
'Kenyan' AS NATIONALITY,
 CASE vw_CustomersCRB.Individual_MaritalStatus WHEN '1' THEN 'Married' WHEN '2' THEN 'Single' WHEN '3' 
 THEN 'Divorced' WHEN '24' THEN 'Separated' ELSE 'UnKnown'
 END AS MaritalStatus,
'National ID' AS [Identification Document],
'' as [Primary Identification Document Type],
vw_CustomersCRB.[Individual_IdentityCardNumber] AS [Primary Identification Doc Number],
'' AS [Secondary Identification Document],
'' AS [Secondary Identification Document Type],
'' AS	[Secondary Identification],
'' AS [Other Identification Document],
'' AS [Other Identification TYPE],
'' AS [Other IdentificationDocument Number],
vw_CustomersCRB.[Address_MobileLine] as [Mobile Telephone Number],
vw_CustomersCRB.[Address_LandLine] as [Home Telephone ],
'' as [Work TelephoneNumber],
vw_CustomersCRB.[Address_AddressLine1] as [Postal Address 1],
vw_CustomersCRB.[Address_AddressLine2] as [Postal Address 2],
'' as [Postal Location Town],
'KENYA' AS [Postal Location Country],
vw_CustomersCRB.[Address_PostalCode] AS [Post code],
'' AS [Physical Address1],
'' AS [Physical Address 2],
'' AS [Plot Number],
'' AS [Location Town],
'KENYA' AS [Location Country],
'' AS [Date at Physical Address],
'' AS [PIN Number],
vw_CustomersCRB.[Address_Email] AS [Consumer work E-Mail],
'' AS [Employer Name],
vw_CustomersCRB.[Individual_EmploymentDesignation] AS [Employer Industry],
'' AS [Employer Industry Type],
vw_CustomersCRB.[Individual_EmploymentDate] AS [Employment Date],
'' AS [Employment],
vw_CustomersCRB.[Individual_EmploymentTermsOfService] AS [Employment type],
0 AS [Current Salary],
'' AS [Salary Band],
(select top 1 Description from swiftfin_Companies) AS [Lenders Registered Name],
(select top 1 Description from swiftfin_Companies) as [Lenders Trading Name],
(select Description from swiftfin_Branches where id =vw_CustomersCRB.BranchId) AS [Lenders Branch Name],
(select code from swiftfin_Branches where id =vw_CustomersCRB.BranchId) AS [Lenders Branch Code],
'' AS [Single/Joint Account],
'' AS [Account Joint/Single Indicator*],
(select Description from swiftfin_LoanProducts where id = vw_CustomersCRB.CustomerAccountType_TargetProductId) AS Product,
'' AS [Account Product Type],
convert(varchar(8),(select top 1 DisbursedDate from swiftfin_LoanCases where CustomerId=vw_CustomersCRB.CustomerId and LoanProductId=vw_CustomersCRB.CustomerAccountType_TargetProductId and DisbursedDate<=@EndDate),112) AS [Date Account Opened],
convert(varchar(8),(select top 1 Duration_StartDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomersCRB.id),112) AS [Instalment Due Date],
(select top 1 DisbursedAmount from swiftfin_LoanCases where CustomerId=vw_CustomersCRB.CustomerId and LoanProductId=vw_CustomersCRB.CustomerAccountType_TargetProductId and DisbursedDate<=@EndDate)  AS [Original Amount*],
'Kenya Shilling' AS [Currency Of Faciity],
'KES' AS [Currency of Facility],
(select top 1 DisbursedAmount from swiftfin_LoanCases where CustomerId=vw_CustomersCRB.CustomerId and LoanProductId=vw_CustomersCRB.CustomerAccountType_TargetProductId and DisbursedDate<=@EndDate) AS [Amount in Kenya shillings*],
(select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomersCRB.Id and ChartOfAccountId in
(select ChartOfAccountId from swiftfin_LoanProducts where id =vw_CustomersCRB.CustomerAccountType_TargetProductId) and CreatedDate<=@EndDate)*-1 AS [Current Balance],
(select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomersCRB.Id and ChartOfAccountId in
(select ChartOfAccountId from swiftfin_LoanProducts where id =vw_CustomersCRB.CustomerAccountType_TargetProductId) and CreatedDate<=@EndDate)*-1  AS [Overdue Balance],
(select datediff(dd,(select top 1 Duration_EndDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomersCRB.id),@EndDate))  as [Duration_ENdDate],

(select dateadd(mm,2,(select top 1 Duration_EndDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomersCRB.id)))  as [due_Date],
---
---
(select datediff(dd,(select top 1 Duration_EndDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomersCRB.id),@EndDate)) AS [Nr of Days In Arrears],
case  isnull((select top 1 Principal from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomersCRB.id),0)
when 0 then
0
else
ROUND(((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomersCRB.Id and ChartOfAccountId in
(select ChartOfAccountId from swiftfin_LoanProducts where id =vw_CustomersCRB.CustomerAccountType_TargetProductId) and CreatedDate<=@EndDate)*-1/
(select top 1 Principal from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomersCRB.id)),0)
end
  AS [Nr of Instalments In Arrears],
space(30) AS [Performing/Non Performing],
'' AS [Performing/ NPL Indicator],
'' AS [Account Status],
'01/01/1900' AS [Account Status Date],
'' AS [Account Closure Reason],
(select top 1 LoanRegistration_TermInMonths from swiftfin_LoanCases where CustomerId=vw_CustomersCRB.CustomerId and LoanProductId=vw_CustomersCRB.CustomerAccountType_TargetProductId and DisbursedDate<@EndDate) AS  [Repayment Period],
'' AS [Deferred Payment Date],
0 AS [Deferred PaymentAmount],
'Monthly' AS [Repayment Frequency],
'M' AS [Payment Frequency],
convert(varchar(8),(select top 1 DisbursedDate from swiftfin_LoanCases where CustomerId=vw_CustomersCRB.CustomerId and LoanProductId=vw_CustomersCRB.CustomerAccountType_TargetProductId and DisbursedDate<@EndDate),112) AS [Disbursement Date*],
(select top 1 Principal from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomersCRB.id) AS [Instalment Amount],
(select top 1 ActualPrincipal from swiftfin_StandingOrderHistories where BeneficiaryCustomerAccountId=vw_CustomersCRB.id  order by CreatedDate desc) AS [Last Payment Amount],
convert(varchar(8),(select top 1 CreatedDate from swiftfin_StandingOrderHistories where BeneficiaryCustomerAccountId=vw_CustomersCRB.id and CreatedDate<=@EndDate order by CreatedDate desc),112) AS [Date of Latest Payment],
'Secured' AS [IS Secured],
'S' AS [Type of Security],
convert(varchar(8),(select dateadd(mm,(select top 1 LoanRegistration_TermInMonths from swiftfin_LoanCases where CustomerId=vw_CustomersCRB.CustomerId and LoanProductId=vw_CustomersCRB.CustomerAccountType_TargetProductId and DisbursedDate<@EndDate),

(select top 1 disbursedDate from  swiftfin_LoanCases where CustomerId=vw_CustomersCRB.CustomerId and LoanProductId=vw_CustomersCRB.CustomerAccountType_TargetProductId and DisbursedDate<@EndDate))),112) as [Loan_Date] 
into #TEMPcRB
from vw_CustomersCRB where CustomerAccountType_TargetProductId in (select id from swiftfin_LoanProducts)

 SELECT * FROM #TEMPcRB where isnull([Current Balance],0)>0 and [Due_Date]< @EndDate  ORDER BY product, AccountNumber, [Account Product Type]

 

GO
/****** Object:  StoredProcedure [dbo].[dividends]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[dividends]
@reference varchar(15) as

---dividends '1200-003-00001'
--
with ctedividends (Account,Name,SaccoShares,Housing,GroupShares,Boost,InstitutionalStaff,InstitutionalGroup,
S01_Dividend,S03_dividend,S04_dividend,S09_dividend,S10_dividend,S11_dividend,Gross_Dividend,wtax,Net)
as(
SELECT        Fosaacno, name, [S01 Sacco Shares], [S03 Housing Shares], [S04 Group Shares], [S09 Boost Shares], [S10 Institutional Staff Shares], [S11 Institutional Group Shares], 

sum([S01 Sacco Shares])*.08 as sacco,sum([S03 Housing Shares])*.1 as Housing,sum([S04 Group Shares])*.05 as GroupS,sum([S09 Boost Shares])*.05 as Boost,SUM([S10 Institutional Staff Shares])*.05 as Staff,

sum([S11 Institutional Group Shares])*.05 as InstiGroup,(sum([S01 Sacco Shares])*.08 +sum([S03 Housing Shares])*.1+sum([S04 Group Shares])*.05 +sum([S09 Boost Shares])*.05 +SUM([S10 Institutional Staff Shares])*.05

+sum([S11 Institutional Group Shares])*.05) AS Gross,

((sum([S01 Sacco Shares])*.08 +sum([S03 Housing Shares])*.1+sum([S04 Group Shares])*.05 +sum([S09 Boost Shares])*.05 +SUM([S10 Institutional Staff Shares])*.05

+sum([S11 Institutional Group Shares])*.05))*.05 as Wtax,

(sum([S01 Sacco Shares])*.08 +sum([S03 Housing Shares])*.1+sum([S04 Group Shares])*.05 +sum([S09 Boost Shares])*.05 +SUM([S10 Institutional Staff Shares])*.05

+sum([S11 Institutional Group Shares])*.05)-(((sum([S01 Sacco Shares])*.08 +sum([S03 Housing Shares])*.1+sum([S04 Group Shares])*.05 +sum([S09 Boost Shares])*.05 +SUM([S10 Institutional Staff Shares])*.05

+sum([S11 Institutional Group Shares])*.05))*.05) as net

FROM            dbo.swiftfin_Dividends_2015

Where fosaacno=@reference

group by  Fosaacno, name,[S01 Sacco Shares], [S03 Housing Shares], [S04 Group Shares], [S09 Boost Shares], [S10 Institutional Staff Shares], [S11 Institutional Group Shares]



)

select * from ctedividends
where S01_Dividend+S03_dividend+S04_dividend+S09_dividend+S10_dividend+S11_dividend>0






GO
/****** Object:  StoredProcedure [dbo].[EarningDeductionSummary]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[EarningDeductionSummary]

as 
begin

SELECT        dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_PaySlipEntries.Description, dbo.swiftfin_PaySlipEntries.Principal, 
                         dbo.swiftfin_PaySlipEntries.Interest, dbo.swiftfin_PaySlipEntries.SalaryHeadCategory
FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_PaySlipEntries.CustomerAccountId
end





GO
/****** Object:  StoredProcedure [dbo].[Guaranteedeatails]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CReate PROCEDURE [dbo].[Guaranteedeatails]
	-- Add the parameters for the stored procedure here
	@reference varchar(20),
	@enddate datetime
	
AS
BEGIN
	
	SET NOCOUNT ON;
 SELECT        (dbo.swiftfin_Customers.Individual_FirstName +''+ dbo.swiftfin_Customers.Individual_LastName) as name, dbo.swiftfin_Customers.reference1,dbo.swiftfin_Customers.Id,@enddate as enddate
  from dbo.swiftfin_Customers
  WHERE        (dbo.swiftfin_Customers.Reference1 = @reference ) 
END



GO
/****** Object:  StoredProcedure [dbo].[Guarantor]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
create PROCEDURE [dbo].[Guarantor]
	-- Add the parameters for the stored procedure here
	@reference varchar(20),
	@enddate datetime
AS
BEGIN
	
	SET NOCOUNT ON;

   SELECT        (dbo.swiftfin_Customers.Individual_FirstName +''+ dbo.swiftfin_Customers.Individual_LastName) as name, dbo.swiftfin_Customers.reference1,dbo.swiftfin_Customers.Id,SUM(isnull(dbo.swiftfin_JournalEntries.Amount,0)) AS DepositBalance,@enddate as enddate
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId AND 
                         dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
WHERE        (dbo.swiftfin_Customers.Reference1 = @reference ) and dbo.swiftfin_JournalEntries.createdDate<=@enddate
GROUP BY dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName,dbo.swiftfin_Customers.reference1,dbo.swiftfin_Customers.Id

END






GO
/****** Object:  StoredProcedure [dbo].[guatantordetails]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[guatantordetails]
@customerid varchar(50),
@enddate1 datetime
as
--exec Loanee_guarantro '3859F1B2-1B3E-C388-3742-08D24D5414CD','10/18/2015'
begin
SELECT        dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.CreatedDate, 
                         dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_LoanGuarantors.CreatedBy, (dbo.swiftfin_Customers.Individual_FirstName+''+ dbo.swiftfin_Customers.Individual_LastName) as Name, dbo.swiftfin_LoanProducts.Description, 
                         abs(SUM(dbo.swiftfin_JournalEntries.Amount))*-1 AS Balance,   dbo.swiftfin_Customers.reference1,dbo.swiftfin_LoanGuarantors.LoaneeCustomerId 
FROM            dbo.swiftfin_LoanGuarantors INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanGuarantors.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_LoanGuarantors.CustomerId = dbo.swiftfin_CustomerAccounts.CustomerId AND 
                         dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
                         dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId LEFT OUTER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_LoanGuarantors.LoanCaseId = dbo.swiftfin_LoanCases.Id AND dbo.swiftfin_LoanProducts.Id = dbo.swiftfin_LoanCases.LoanProductId
WHERE        (dbo.swiftfin_LoanGuarantors.loaneeCustomerId = @customerid) and dbo.swiftfin_LoanGuarantors.CreatedDate<=@enddate1

GROUP BY dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.CreatedDate, 
                         dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_LoanGuarantors.CreatedBy, dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_LoanProducts.Description, 
                         dbo.swiftfin_LoanGuarantors.CustomerId,dbo.swiftfin_Customers.reference1,dbo.swiftfin_LoanGuarantors.LoaneeCustomerId 
						 end





GO
/****** Object:  StoredProcedure [dbo].[Loanee]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create procedure [dbo].[Loanee]
as
begin
SELECT        dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.CreatedDate, 
                         dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_LoanGuarantors.CreatedBy, dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_LoanProducts.Description, 
                         SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance, dbo.swiftfin_LoanGuarantors.CustomerId
FROM            dbo.swiftfin_LoanGuarantors INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanGuarantors.LoaneeCustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_LoanGuarantors.LoaneeCustomerId = dbo.swiftfin_CustomerAccounts.CustomerId AND 
                         dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
                         dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId LEFT OUTER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_LoanGuarantors.LoanCaseId = dbo.swiftfin_LoanCases.Id AND dbo.swiftfin_LoanProducts.Id = dbo.swiftfin_LoanCases.LoanProductId
WHERE        (dbo.swiftfin_LoanGuarantors.CustomerId = '3859F1B2-1B3E-C388-3742-08D24D5414CD')
GROUP BY dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.CreatedDate, 
                         dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_LoanGuarantors.CreatedBy, dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_LoanProducts.Description, 
                         dbo.swiftfin_LoanGuarantors.CustomerId
						 end






GO
/****** Object:  StoredProcedure [dbo].[Loanee_guarantro]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[Loanee_guarantro]
@customerid varchar(50),
@enddate1 datetime
as
--exec Loanee_guarantro '3859F1B2-1B3E-C388-3742-08D24D5414CD','10/18/2015'
begin
SELECT        dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.CreatedDate, 
                         dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_LoanGuarantors.CreatedBy, (dbo.swiftfin_Customers.Individual_FirstName+''+ dbo.swiftfin_Customers.Individual_LastName) as Name, dbo.swiftfin_LoanProducts.Description, 
                         SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,   dbo.swiftfin_Customers.reference1,dbo.swiftfin_LoanGuarantors.LoaneeCustomerId 
FROM            dbo.swiftfin_LoanGuarantors INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanGuarantors.LoaneeCustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_LoanGuarantors.LoaneeCustomerId = dbo.swiftfin_CustomerAccounts.CustomerId AND 
                         dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
                         dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId LEFT OUTER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_LoanGuarantors.LoanCaseId = dbo.swiftfin_LoanCases.Id AND dbo.swiftfin_LoanProducts.Id = dbo.swiftfin_LoanCases.LoanProductId
WHERE        (dbo.swiftfin_LoanGuarantors.CustomerId = @customerid) and dbo.swiftfin_LoanGuarantors.CreatedDate<=@enddate1

GROUP BY dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.CreatedDate, 
                         dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_LoanGuarantors.CreatedBy, dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_LoanProducts.Description, 
                         dbo.swiftfin_LoanGuarantors.CustomerId,dbo.swiftfin_Customers.reference1,dbo.swiftfin_LoanGuarantors.LoaneeCustomerId 
						 end





GO
/****** Object:  StoredProcedure [dbo].[Loaneebals]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
create PROCEDURE [dbo].[Loaneebals]
	-- Add the parameters for the stored procedure here
	@reference varchar(20),
	@enddate datetime
AS
BEGIN
	
	SET NOCOUNT ON;

   SELECT        (dbo.swiftfin_Customers.Individual_FirstName +''+ dbo.swiftfin_Customers.Individual_LastName) as name, dbo.swiftfin_Customers.reference1,dbo.swiftfin_Customers.Id,SUM(isnull(dbo.swiftfin_JournalEntries.Amount,0)) AS LoanBalance,@enddate as enddate,
    dbo.swiftfin_LoanProducts.Description 
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId AND 
                         dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
WHERE        (dbo.swiftfin_Customers.Reference1 = @reference ) and dbo.swiftfin_JournalEntries.createdDate<=@enddate
GROUP BY dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName,dbo.swiftfin_Customers.reference1,dbo.swiftfin_Customers.Id,
dbo.swiftfin_LoanProducts.Description 

END







GO
/****** Object:  StoredProcedure [dbo].[NegativeAcccounts]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--NegativeAcccounts '09/25/2015', '09/30/2015'
CREATE PROC [dbo].[NegativeAcccounts]
@StartDate DateTime,
@EndDate DateTime
AS

SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.Reference1, 
case when sum(dbo.swiftfin_JournalEntries.Amount) <=0 then sum(dbo.swiftfin_JournalEntries.Amount)*-1 else 0 end as Debit,
case when sum (dbo.swiftfin_JournalEntries.Amount) >=0 then sum(dbo.swiftfin_JournalEntries.Amount) else 0 end as Credit,sum(dbo.swiftfin_JournalEntries.Amount) AS BookBalance,sum(dbo.swiftfin_JournalEntries.Amount)-dbo.swiftfin_SavingsProducts.MinimumBalance  AS AvailableBalance
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id AND 
                         dbo.swiftfin_SavingsProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
						 where dbo.swiftfin_JournalEntries.Amount<0 and dbo.swiftfin_JournalEntries.CreatedDate>@EndDate											
						 GROUP BY dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_SavingsProducts.MinimumBalance 
						 
						 





GO
/****** Object:  StoredProcedure [dbo].[PreviousGLStatement]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[PreviousGLStatement]
@StartDate DateTime,
@EndDate DateTime
as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
select * from vw_PreviousGLStatement
where trdate between @StartDate and @EndDate
GO
/****** Object:  StoredProcedure [dbo].[sp_AccountHolderPerCategory]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
 
 
 ---exec [sp_AccountHolderPerCategory1] '1934EF3D-C0B4-C148-F0D6-08D30617F260','02/17/2016'
CREATE procedure [dbo].[sp_AccountHolderPerCategory]
 
 @ProductID varchar(100), 
 @EndDate DateTime 
 as
 begin
 set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
 
 With AccountHolderPerCategory(AccountNo,AccountName,idno,Narration,Balance)
	AS
	(	
 select dbo.swiftfin_Customers.Reference1,(dbo.swiftfin_Customers.Individual_FirstName+''+dbo.swiftfin_Customers.Individual_LastName) as name,
  dbo.swiftfin_Customers.Individual_IdentityCardNumber,dbo.swiftfin_Enumerations.Description, SUM(dbo.swiftfin_JournalEntries.Amount) AS BALANCE

FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_Enumerations ON dbo.swiftfin_Customers.Type = dbo.swiftfin_Enumerations.Value INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId
WHERE        (dbo.swiftfin_Enumerations.[Key] = 'CustomerType')  and @productid=swiftfin_Enumerations.id and dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
GROUP BY dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Enumerations.Description,dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId,
dbo.swiftfin_Customers.Individual_FirstName,dbo.swiftfin_Customers.Individual_IdentityCardNumber,dbo.swiftfin_Customers.Individual_LastName)


select AccountNo,AccountName,idno,Narration,Balance
from AccountHolderPerCategory
order by Narration,AccountNo
end





GO
/****** Object:  StoredProcedure [dbo].[sp_AccountsCreditWithSalary]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Joan-Centrino
-- Create date: 16.08.2015
-- Description:	Accounts credited with salary in a particular month
-- =============================================
--[sp_AccountsCreditWithSalary] 'November'

CREATE procedure [dbo].[sp_AccountsCreditWithSalary] 
--@EndDate DateTime
@cMonth Varchar(20)
as
--set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
--
SELECT     top 100   dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_JournalEntries.CreatedDate, dbo.swiftfin_Journals.Reference, dbo.vw_CustomerAccounts.FullName, 
                         dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.swiftfin_JournalEntries.Amount
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
WHERE      dbo.swiftfin_Journals.TransactionCode =32
and SecondaryDescription = 'Payout-'+ltrim(rtrim(@cMonth)) and dbo.swiftfin_JournalEntries.ChartOfAccountId in (select ChartOfAccountId from swiftfin_SavingsProducts) and  dbo.swiftfin_JournalEntries.Amount>0

order by Reference









GO
/****** Object:  StoredProcedure [dbo].[sp_AccountsNotCreditWithSalary]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Joan-Centrino
-- Create date: 16.08.2015
-- Description:	Accounts credited with salary in a particular month
-- =============================================
--[sp_AccountsCreditWithSalary] 'November'

CREATE procedure [dbo].[sp_AccountsNotCreditWithSalary] 
--@EndDate DateTime
@cMonth Varchar(20)
as
--set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
--
SELECT        dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_JournalEntries.CreatedDate, dbo.swiftfin_Journals.Reference, dbo.vw_CustomerAccounts.FullName, 
                         dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.swiftfin_JournalEntries.Amount
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
WHERE      dbo.swiftfin_Journals.TransactionCode =32
and SecondaryDescription = 'Payout-'+ltrim(rtrim(@cMonth)) and dbo.swiftfin_JournalEntries.ChartOfAccountId in (select ChartOfAccountId from swiftfin_SavingsProducts) and  dbo.swiftfin_JournalEntries.Amount>0

order by Reference









GO
/****** Object:  StoredProcedure [dbo].[sp_AccountsOpened]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_AccountsOpened '01/01/2017','02/01/2017'
CREATE PROC [dbo].[sp_AccountsOpened]

@StartDate Datetime,
@EndDate DateTime

AS
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT       COALESCE( ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))),'')+ COALESCE(  dbo.swiftfin_Customers.NonIndividual_Description,'') AS FullName, 
							 COALESCE( Individual_IdentityCardNumber,'')+COALESCE(NonIndividual_RegistrationNumber,'') as IdNo  ,Reference1 as AccountNo, Reference3 as PayrollNo,dbo.swiftfin_Stations.Description AS Station,RecruitedBy
FROM            dbo.swiftfin_Customers LEFT OUTER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id
						 where dbo.swiftfin_Customers.RegistrationDate BETWEEN @StartDate and @EndDate 


						 --SELECT COALESCE(column1,'') + COALESCE(column2,'')


GO
/****** Object:  StoredProcedure [dbo].[sp_ActiveAccounts]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan>
-- Create date: <Create Date, 16/09/2015>
-- Description:	<Description, Active Accounts>
-- =============================================
--sp_ActiveAccounts '1', '08/15/2018'
CREATE PROCEDURE [dbo].[sp_ActiveAccounts]
	-- Add the parameters for the stored procedure here
	@Month int , 
	@CreatedDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @CreatedDate=	(select DATEADD(day, DATEDIFF(day, 0, @CreatedDate), '23:59:59'));
	WITH ActiveAccountsCTE (LastTrxDATE, FosaAccount,FullName,PayrollNo,MobileLine,IdentityCardNumber,Email)
	AS(
    -- Insert statements for procedure here
	SELECT        (MAX( dbo.swiftfin_JournalEntries.CreatedDate)) As LastTrxDate,dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName ,dbo.vw_CustomerAccounts.Reference3,
	dbo.vw_CustomerAccounts.Address_MobileLine,dbo.vw_CustomerAccounts.Individual_IdentityCardNumber,dbo.vw_CustomerAccounts.Address_Email
	FROM          dbo.vw_CustomerAccounts INNER JOIN
				  dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                  dbo.swiftfin_SavingsProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId
	Where		  dbo.swiftfin_JournalEntries.CreatedDate<=@CreatedDate
	Group by     dbo.vw_CustomerAccounts.Address_Email, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,
	dbo.vw_CustomerAccounts.Address_MobileLine,dbo.vw_CustomerAccounts.Individual_IdentityCardNumber)

	
	SELECT DATEDIFF(MM,LastTrxDate,@CreatedDate) AS Month,* 
	FROM ActiveAccountsCTE WHERE DATEDIFF(DD,LastTrxDATE,@CreatedDate)<=@Month*30
END






GO
/****** Object:  StoredProcedure [dbo].[Sp_AlertsStatus]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--Sp_AlertsStatus '05/01/2016','08/30/2016'
CREATE PROCEDURE [dbo].[Sp_AlertsStatus]
 -- Add the parameters for the stored procedure here
 @StartDate DateTime, 
 @EndDate DateTime
AS
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
SELECT       case dbo.swiftfin_TextAlerts.TextMessage_DLRStatus when 4 then 'Pending' when 16 then 'Not Applicable' when 2 then 'Failed' when 8 then 'Delivered' when 1 then 'Uknowkn' end as AlertStatus, 
count(dbo.swiftfin_TextAlerts.TextMessage_Recipient) as  TextAlerts,
case when dbo.swiftfin_TextAlerts.TextMessage_DLRStatus=8 or dbo.swiftfin_TextAlerts.TextMessage_DLRStatus=2 then count(dbo.swiftfin_TextAlerts.TextMessage_Recipient)*10 else 0 end as Income
FROM            dbo.swiftfin_TextAlerts INNER JOIN
                         dbo.vw_Customers ON dbo.swiftfin_TextAlerts.TextMessage_Recipient = dbo.vw_Customers.Address_MobileLine
       where dbo.swiftfin_TextAlerts.CreatedDate between @StartDate and @EndDate 
	   group by dbo.swiftfin_TextAlerts.TextMessage_DLRStatus

END

--select * from swiftfin_enumerations where [key] like '%DLRStatus%'



GO
/****** Object:  StoredProcedure [dbo].[sp_AllRecoveries]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_AllRecoveries '08/30/2017','09/25/2017'
CREATE PROCEDURE [dbo].[sp_AllRecoveries]
 -- Add the parameters for the stored procedure here
--@TransactionCode Int,
@StartDate DateTime, 
@EndDate DateTime 
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
 With LoanProductBalances(AccountNo,Reference1,Reference2,Reference3,AccountName,Description, PayrollNumber, Code,Balance,Interest,Tranxcode,Branch,costcenter)
 AS
 (
  SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
   dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description, dbo.vw_customeraccounts.Individual_PayrollNumbers,  dbo.swiftfin_Journals.TransactionCode, 0,
  SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_Journals.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId
  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
                         dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id inner join
						 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
  WHERE       dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate --and  dbo.swiftfin_Journals.TransactionCode=@TransactionCode
  GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
  dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_Journals.TransactionCode,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_Journals.BranchId,
  dbo.swiftfin_ChartOfAccounts.CostCenterId
  UNION ALL
  SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
  dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers,dbo.swiftfin_Journals.TransactionCode, 
  SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,0,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_Journals.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId
  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id inner join
						 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
  WHERE       dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate --and  dbo.swiftfin_Journals.TransactionCode=@TransactionCode
  GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
  dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_Journals.TransactionCode,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_Journals.BranchId
  ,dbo.swiftfin_ChartOfAccounts.CostCenterId
 )
 SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,
 AccountName,Description,PayrollNumber, Code,SUM(Balance) AS Balance,sum(Interest) as Interest ,Tranxcode,Branch,costcenter
 FROM LoanProductBalances 
 Group By AccountNo,Reference1,Reference2,Reference3,AccountName,Code,Tranxcode,Branch,costcenter,Description,PayrollNumber having SUM(Balance) +sum(Interest)<>0
END
GO
/****** Object:  StoredProcedure [dbo].[sp_AllRecoveriesSummary]    Script Date: 23/05/2023 11:07:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_AllRecoveriesSummary '05/01/2018','05/24/2018',6
CREATE PROCEDURE [dbo].[sp_AllRecoveriesSummary]
 -- Add the parameters for the stored procedure here
--@TransactionCode Int,
@StartDate DateTime, 
@EndDate DateTime
--@TransactionCode Int
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
 With LoanProductBalances(Description,Balance,Interest,code,TranxCode,CostCenter)
 AS
 (
  
  SELECT      dbo.vw_CustomerAccounts.Description,SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount, 0, 'Investments' as Code,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_ChartOfAccounts.CostCenterId
FROM            dbo.swiftfin_InvestmentProducts INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId AND 
                         dbo.swiftfin_InvestmentProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId
						 WHERE       dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate --and  dbo.swiftfin_Journals.TransactionCode=@TransactionCode
GROUP BY dbo.vw_CustomerAccounts.Description,code,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_ChartOfAccounts.CostCenterId
  
  union

  SELECT       dbo.vw_CustomerAccounts.Description,0,
  SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount, 'Loans' as Code,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_ChartOfAccounts.CostCenterId
  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
                         dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id inner join
						 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
  WHERE       dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate --and  dbo.swiftfin_Journals.TransactionCode=@TransactionCode
  GROUP BY dbo.vw_CustomerAccounts.Description,code,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_ChartOfAccounts.CostCenterId
  UNION ALL
  SELECT       dbo.vw_CustomerAccounts.Description,
  SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,0, 'Loans' as Code,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_ChartOfAccounts.CostCenterId
  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id inner join
						 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
  WHERE       dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate --and  dbo.swiftfin_Journals.TransactionCode=@TransactionCode
  GROUP BY dbo.vw_CustomerAccounts.Description,code,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_ChartOfAccounts.CostCenterId
 )
 SELECT Description,SUM(Balance) AS Balance,sum(Interest) as Interest ,code,CostCenter,
 
case TranxCode when 28 then  'Repayment Through Check-Off' when 6 then 'Repayment Through Payout' when 25 then 'Repayment Through SpotCash'
when 5 then 'Repayment Through Journal Vouchers' when 67 then 'Repayment Through Pesa-Pepe' when 17 then 'Repayment Through Cash'
when 2 then 'Repayment Through Cheque Deposit' when 50 then 'Repayment Through New Loans' when 27 then 'Repayment Through Staff Salaries' end as TranxCode,
 
 SUM(Balance)+sum(Interest) as Total
 FROM LoanProductBalances where TranxCode in(28,6,25,5,67,17,2,50,27)
 Group By Description,code,TranxCode,CostCenter having SUM(Balance) +sum(Interest)<>0

 --select * from swiftfin_Enumerations where [key] like '%transaction%'
END
GO
/****** Object:  StoredProcedure [dbo].[sp_AlternateChannels]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_AlternateChannels]
	@Type int,
	@StartDate datetime,
	@EndDate datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT        dbo.swiftfin_AlternateChannels.CardNumber, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_AlternateChannels.Type, 
                         LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_FirstName)) + '  ' + LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS Fullnames, 
                         dbo.swiftfin_Customers.Individual_IdentityCardNumber,dbo.swiftfin_AlternateChannels.CreatedDate,dbo.swiftfin_AlternateChannels.CreatedBy
FROM            dbo.swiftfin_AlternateChannels INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_AlternateChannels.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id

						 where @Type=dbo.swiftfin_AlternateChannels.Type and dbo.swiftfin_AlternateChannels.CreatedDate between @StartDate and @EndDate
END
GO
/****** Object:  StoredProcedure [dbo].[Sp_AnnexLoanBalanceReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_standingorders
--exec [Sp_AnnexLoanBalanceReport] '11/30/2018' 

CREATE  Procedure [dbo].[Sp_AnnexLoanBalanceReport](@EndDate DateTime) as
--drop table #tempx
--drop table #temp8

SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

WITH CTEList (beneficiary,fullaccount,Reference1,Reference2,Reference3,[Account Name],CustomerAccountID,LoanName,Principal,LoanAmount,PaymentPerPeriod,Balance,Interest,latestamountpaid,latestpaymentdate,LoanTerm,Term2,rate,category,
StartDate,FirstPamentDate,PeriodElapsed,EndDate,CustomerID,LoanProductID)
as
(
	SELECT        distinct( select top 1 BeneficiaryCustomerAccountId from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ) as BeneficiaryCustomerAccountId,left(dbo.vw_CustomerAccounts.fullaccount,10), dbo.vw_CustomerAccounts.Reference1, 
	dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Individual_PayrollNumbers, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Id, 
	dbo.swiftfin_LoanProducts.Description,
							 --dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod, 

							  (select top 1 principal from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id order by Duration_StartDate desc) as principal, 
							 (select top 1 LoanAmount from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id order by Duration_StartDate desc) as loanamount,
							 (select top 1 PaymentPerPeriod from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id order by Duration_StartDate desc) as PaymentPerPeriod,
							 SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Balance,
							 (select sum(Amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId =swiftfin_LoanProducts.InterestReceivableChartOfAccountId)*-1 as InterestBalance,0,''
							 , (select top 1 DATEDIFF(mm,Duration_StartDate,Duration_EndDate) from  dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id  ) as LoanRegistration_TermInMonths,(LoanRegistration_TermInMonths+1) as Term2,dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductCategory,
							 --Duration_StartDate as StartDate,DATEadd(mm,1,duration_startdate) as FirstPaymentDate,DATEDIFF(mm,duration_startdate,@EndDate) as MonthElapsed,Duration_EndDate,
							 (select top 1 Duration_StartDate from  dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc )as StartDate,
							 (select top 1 DATEadd(mm,1,duration_startdate) from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc) as FirstPaymentDate,
							 --(select top 1 DATEDIFF(mm,duration_startdate,@EndDate) from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc) as MonthElapsed,
							 (select top 1 iif(DATEDIFF(mm,duration_startdate,@EndDate)<=0,1,DATEDIFF(mm,duration_startdate,@EndDate)) from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc) as MonthElapsed,
							 (select top 1 Duration_EndDate from  dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc )as Duration_EndDate,

							dbo.vw_CustomerAccounts.CustomerId,CustomerAccountType_TargetProductId
	FROM            dbo.vw_CustomerAccounts INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id  INNER JOIN
							 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
							 --isnull(dbo.swiftfin_StandingOrders.islocked,0)=0 and 
							 where  dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate  --and dbo.swiftfin_StandingOrders.duration_startdate<=@EndDate 


	GROUP BY dbo.swiftfin_LoanProducts.ChartOfAccountId,dbo.vw_CustomerAccounts.fullaccount,dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Individual_PayrollNumbers, dbo.vw_CustomerAccounts.AccountName, dbo.vw_CustomerAccounts.Id, 
							 LoanRegistration_TermInMonths,FullName,swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId,
							 dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductCategory, dbo.vw_CustomerAccounts.CustomerId,CustomerAccountType_TargetProductId
						

--WITH CTEList (beneficiary,fullaccount,Reference1,Reference2,Reference3,[Account Name],CustomerAccountID,LoanName,Principal,LoanAmount,PaymentPerPeriod,Balance,Interest,latestamountpaid,latestpaymentdate,LoanTerm,Term2,rate,category,
--StartDate,FirstPamentDate,PeriodElapsed,EndDate,CustomerID,LoanProductID)

	union all
							 SELECT        distinct( select top 1 BeneficiaryCustomerAccountId from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ) as BeneficiaryCustomerAccountId,dbo.vw_CustomerAccounts.fullaccount,dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Individual_PayrollNumbers, dbo.vw_CustomerAccounts.FullName, 
							 dbo.vw_CustomerAccounts.Id, dbo.swiftfin_LoanProducts.Description,
							 --dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod, 
							  (select top 1 principal from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id order by Duration_StartDate desc) as principal, 
							 (select top 1 LoanAmount from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id order by Duration_StartDate desc) as loanamount,
							 (select top 1 PaymentPerPeriod from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id order by Duration_StartDate desc) as PaymentPerPeriod,
							 0,0,
							 (select top 1 isnull(abs(Amount),0) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId =swiftfin_LoanProducts.ChartOfAccountId order by CreatedDate) as LatestAmountPaid,
							 (select top 1 CreatedDate from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId =swiftfin_LoanProducts.ChartOfAccountId order by CreatedDate) as LatestPaymentDate,
							 (select top 1 DATEDIFF(mm,Duration_StartDate,Duration_EndDate) from  dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id  ) as LoanRegistration_TermInMonths,(LoanRegistration_TermInMonths+1) as Term2,dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductCategory,
							 --(select top 1 Duration_StartDate from  dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc )as StartDate,
							 
							 (select top 1 Duration_StartDate from  dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc )as StartDate,
							 (select top 1 DATEadd(mm,1,duration_startdate) from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc) as FirstPaymentDate,
							 (select top 1 DATEDIFF(mm,duration_startdate,@EndDate) from dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc) as MonthElapsed,
							 (select top 1 Duration_EndDate from  dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc )as Duration_EndDate,
							 --DATEadd(mm,1,duration_startdate) as FirstPaymentDate,DATEDIFF(mm,duration_startdate,@EndDate) as MonthElapsed,
							 --(select top 1 Duration_EndDate from  dbo.swiftfin_StandingOrders where BeneficiaryCustomerAccountId= dbo.vw_CustomerAccounts.Id order by  Duration_StartDate desc )as Duration_EndDate,
							 dbo.vw_CustomerAccounts.CustomerId,CustomerAccountType_TargetProductId
	FROM            dbo.vw_CustomerAccounts INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
							 --isnull(dbo.swiftfin_StandingOrders.islocked,0)=0 and 
							 where  dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate--- and dbo.swiftfin_StandingOrders.duration_startdate<=@EndDate 


	
	GROUP BY dbo.swiftfin_LoanProducts.ChartOfAccountId,dbo.vw_CustomerAccounts.fullaccount,dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Individual_PayrollNumbers, dbo.vw_CustomerAccounts.AccountName, dbo.vw_CustomerAccounts.Id, 
							 LoanRegistration_TermInMonths,FullName,swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId,
							 dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductCategory, dbo.vw_CustomerAccounts.CustomerId,CustomerAccountType_TargetProductId


)
--select *,iif((isnull(PaymentPerPeriod,0)*PeriodElapsed)>balance,balance,isnull(PaymentPerPeriod,0)*PeriodElapsed) as BalanceExpected,
select * ,isnull(Principal,0)*PeriodElapsed as BalanceExpected,

case
WHEN category=0  THEN floor((isnull(LoanAmount,0)*rate/1200))  else

floor((isnull(LoanAmount,0)*rate/12*Term2)/200) end as  expectedInterest,
case
WHEN category=0  THEN (floor((isnull(LoanAmount,0)*rate/1200))+LoanAmount)  else
(floor((isnull(LoanAmount,0)*rate/12*term2)/200)+LoanAmount) end as TotalLoanInterest,
case
WHEN category=0   then (floor((isnull(LoanAmount,0)*rate/1200))+LoanAmount)  else

LoanAmount-isnull(Balance,0) end [Balance Paid],
 
 --LoanAmount-isnull(Balance,0) end [Balance Paid],
--(floor((isnull(LoanAmount,0)*rate/12*TERM2)/200)+LoanAmount)-isnull(Balance,0) end [Balance Paid],
iif(startdate<'11/03/2018',
		(select top 1 Loan_officer from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID) ,
		(select top 1 Approvedby from swiftfin_LoanCases where LoanProductID=CTEList.LoanProductID and CustomerID=CTEList.CustomerID and ApprovedDate<=@EndDate  order by ApprovedDate desc )
	)[Loan Officer],
		
isnull(iif(startdate<'11/03/2018',
		(select top 1 loan_guarantors from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID) ,
		(select sum(Amountguaranteed) from swiftfin_LoanGuarantors where LoanProductID=CTEList.LoanProductID and CustomerID=CTEList.CustomerID)
	),0)[Amount Guaranteed],

	iif(startdate<'11/03/2018',
		(select top 1 LoanNo from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID) ,
		(select top 1 str(casenumber) from swiftfin_LoanCases where LoanProductID=CTEList.LoanProductID and CustomerID=CTEList.CustomerID and ApprovedDate<=@EndDate  order by ApprovedDate desc )
	)[Loan No],

	iif(startdate<'11/03/2018',
		(select top 1 amortization_type from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID) ,
		(select case when Loaninterest_calculationmode=512 then 'Reducing Balance' when Loaninterest_calculationmode=513 then 'StraighLine' end from swiftfin_Loanproducts where ID=CTEList.LoanProductID )
	)[Amortization Type],

	iif(startdate<'11/03/2018',
		(select count(loan_guarantors) from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID) ,
		(select count(customerid) from swiftfin_LoanGuarantors where LoanProductID=CTEList.LoanProductID and CustomerID=CTEList.CustomerID )
	)[Guarantors]

				--(select LoanNo from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID) [Loan No]

into #temp8 from CTEList

--from CTEList
select *,
case
when #temp8.PeriodElapsed<=1 then 0
else
iif(round(BalanceExpected-[balance paid],0)<0,0,round(BalanceExpected-[balance paid],0)) end as DefaultedAmount,

 case when #temp8.PeriodElapsed<=1 then 0
 when #temp8.StartDate>@EndDate then 0

 when #temp8.[Balance Paid]<=0 then 0
 else
iif(round((BalanceExpected-[balance paid])/nullif(paymentperperiod,0),0)<0,0,round((BalanceExpected-[balance paid])/nullif(paymentperperiod,0),0)) end as DefaulFrequency


 into #tempx from #temp8 where Balance>0 

 

select *,  
----reference1,reference2,reference3,[Account Name],CustomerAccountID,LoanName,Principal,LoanAmount,PaymentPerPeriod,Balance,interest,
----LoanTerm,StartDate,EndDate,iif(BalanceExpected>balance,BalanceExpected,balance),[Balance Paid] ,iif(DefaultedAmount>balance,DefaultedAmount,balance),
----DefaulFrequency,
case 
WHEN DefaulFrequency< =2 THEN 1
WHEN DefaulFrequency>2 and DefaulFrequency<=4 THEN 5
WHEN DefaulFrequency>4 and DefaulFrequency<=6 THEN 25
WHEN DefaulFrequency>6 and DefaulFrequency<=12 THEN 50
WHEN DefaulFrequency>12 THEN 100
end as ClassOrder

,case 
WHEN DefaulFrequency<=2 THEN 'Performing'
WHEN DefaulFrequency>2 and DefaulFrequency<=4 THEN 'Watch'
WHEN DefaulFrequency>4 and DefaulFrequency<=6 THEN 'Substandard'
WHEN DefaulFrequency>6 and DefaulFrequency<=12 THEN 'Doubtful'
WHEN DefaulFrequency>12 THEN 'Loss'
end as Classification,


case 

WHEN DefaulFrequency<=2 THEN 1
WHEN DefaulFrequency>2 and DefaulFrequency<=4 THEN 5
WHEN DefaulFrequency>4 and DefaulFrequency<=6 THEN 25
WHEN DefaulFrequency>6 and DefaulFrequency<=12 THEN 50
WHEN DefaulFrequency>12 THEN 100
end *Balance *0.01 as provision_amount



from #tempx  --where reference1='5651-005-00061'  
--classorder
where balance>0 order by Reference1

drop table #tempx 
drop table #temp8

---where reference1='0101-001-00650'--

--select * from #tempx where balance<0
--where left(LoanName,3) IN('ADV','BAN')
--where left(LoanName,3) IN('A19','A51')

--,ceiling(DefaultedAmount),ceiling(DefaulFrequency),ClassOrder,Classification,provision_amount from #temp1
--order by DefaulFrequency




GO
/****** Object:  StoredProcedure [dbo].[sp_AnnexShareBalancesReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec Sp_AnnexShareBalancesReport '12/31/2016'
--select * from swiftfin_investmentproducts
CREATE procedure [dbo].[sp_AnnexShareBalancesReport] 

@Enddate as datetime
as



With InvestmentProductBalances(AccountNo,SHARENUMBER,Reference2,MEMBERNUMBER,MEMBERNAME,TYPE,SHAREAMOUNT,Branch,Interest)
AS(
SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('8D5515F8-C27F-CCF4-7117-08D2B78E3546') and dbo.swiftfin_JournalEntries.CreatedDate<='12/31/2016')
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description

union
SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('68042ED2-F9DD-CEE8-275E-08D2B78E4475') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
union
SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('2D148A3C-F463-CF87-EFA6-08D2B78E52C3') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
		union
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('0CB0E78F-773C-C794-70B0-08D2B78E6216') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
		union
			SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('3CFF67CE-AD4F-C4BB-64C1-08D2B78E74BD') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
		union

				SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('89B62B58-7F96-C12C-8DE7-08D2B78E86A5') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
			union

				SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('08DBABDA-0ED3-C6B3-8DF7-08D2B78E9354') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
		union

				SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('92AEEDA5-4558-C551-60F8-08D2B916671E') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
		union
			SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('7757652F-FA40-CF61-C3C7-08D2BF34EFE7') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description

		union
			SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('D43E05B4-5978-C155-DF81-08D325890F58') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
			union
			SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('9EF80B2A-E69D-C53F-BB80-08D377C9E8CA') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description
		
			union
			SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,
		(select top 1 Description from swiftfin_Branches where id=dbo.vw_CustomerAccounts.BranchId) as Branch,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in ('91E87B3E-BBD5-C05A-749D-08D37AF98587') and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_InvestmentProducts.AnnualPercentageYield,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_InvestmentProducts.Description)
		select AccountNo,SHARENUMBER,Reference2,MEMBERNUMBER,MEMBERNAME,Branch as BranchName, TYPE, SHAREAMOUNT,Interest*SHAREAMOUNT/100 as DepositInterest from InvestmentProductBalances 
		GROUP BY AccountNo,SHARENUMBER,Reference2,MEMBERNUMBER,MEMBERNAME,Branch,Interest, TYPE, SHAREAMOUNT  having (SHAREAMOUNT)<>0 




		--select * from swiftfin_InvestmentProducts 
GO
/****** Object:  StoredProcedure [dbo].[sp_Arrears]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- select id, description from swiftfin_loanproducts
-- [sp_Arrears] '173DD0D3-EABB-E811-A815-000C29142092'

create PROCEDURE [dbo].[sp_Arrears]
--@EndDate DateTime
@ProductID uniqueidentifier

AS
with ArrearsCTE(FullName,AccountNo,PayrollNo,Product,ProductID,Principal,Interest,IssueDate)
AS
(

SELECT dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.Description,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId,
isnull( CASE dbo.swiftfin_CustomerAccountArrearages.Category WHEN 0 THEN dbo.swiftfin_CustomerAccountArrearages.Amount end,0) as Principal,
isnull(CASE dbo.swiftfin_CustomerAccountArrearages.Category WHEN 1 THEN dbo.swiftfin_CustomerAccountArrearages.Amount end,0) as Interest,
(select top 1 Duration_StartDate from swiftfin_Standingorders where beneficiarycustomeraccountid=dbo.swiftfin_CustomerAccountArrearages.CustomerAccountId order by Duration_StartDate desc)
FROM dbo.vw_CustomerAccounts INNER JOIN
dbo.swiftfin_CustomerAccountArrearages ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_CustomerAccountArrearages.CustomerAccountId
--where dbo.swiftfin_CustomerAccountArrearages.Amount<>0
where dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = @ProductID

)
select FullName,AccountNo,PayrollNo,Product,ProductID,IssueDate,sum(Principal) as Principal,sum(Interest) as Interest 
from ArrearsCTE
group by FullName,AccountNo,PayrollNo,Product,IssueDate,ProductID
having sum(Principal)+sum(Interest)<>0
GO
/****** Object:  StoredProcedure [dbo].[sp_AssetMovementHistories]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		CustomerCare Desk
-- Create date: 
-- Description:	
-- =============================================
Create PROCEDURE [dbo].[sp_AssetMovementHistories] 
@EndDate datetime
AS
BEGIN
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	
SELECT        dbo.swiftfin_Assets.TagNumber, dbo.swiftfin_ItemRegister.Description As Name, dbo.swiftfin_AssetMovementHistories.Sender, dbo.swiftfin_AssetMovementHistories.Recipient, dbo.swiftfin_AssetMovementHistories.Remarks, 
                         dbo.swiftfin_AssetMovementHistories.CreatedBy, dbo.swiftfin_AssetMovementHistories.CreatedDate, dbo.swiftfin_Departments.Description AS DestinationDepartment, swiftfin_Departments_1.Description AS SourceDepartment, dbo.swiftfin_Locations.Description AS SourceLocation, 
                         swiftfin_Locations_1.Description AS DestinationLocation, Case dbo.swiftfin_AssetMovementHistories.Type when 1 Then 'Dispatch' when 2 Then 'Transfer' When 3 Then 'Disposal' else '' End As Type
FROM            dbo.swiftfin_AssetMovementHistories INNER JOIN
                         dbo.swiftfin_Assets ON dbo.swiftfin_AssetMovementHistories.AssetId = dbo.swiftfin_Assets.Id INNER JOIN
                         dbo.swiftfin_ItemRegister ON dbo.swiftfin_Assets.ItemRegisterId = dbo.swiftfin_ItemRegister.Id INNER JOIN
                         dbo.swiftfin_Departments ON dbo.swiftfin_AssetMovementHistories.DestinationDepartmentId = dbo.swiftfin_Departments.Id INNER JOIN
                         dbo.swiftfin_Departments AS swiftfin_Departments_1 ON dbo.swiftfin_AssetMovementHistories.SourceDepartmentId = swiftfin_Departments_1.Id INNER JOIN
                         dbo.swiftfin_Locations ON dbo.swiftfin_AssetMovementHistories.SourceLocationId = dbo.swiftfin_Locations.Id INNER JOIN
                         dbo.swiftfin_Locations AS swiftfin_Locations_1 ON dbo.swiftfin_AssetMovementHistories.DestinationLocationId = swiftfin_Locations_1.Id

						 where dbo.swiftfin_AssetMovementHistories.CreatedDate<=@EndDate 
						 End 
GO
/****** Object:  StoredProcedure [dbo].[sp_Assets]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--[sp_Assets] '12/04/2018'
--select * from swiftfin_Assets
-- =============================================
-- Author:		CustomerCare Desk
-- Create date: 
-- Description:	
-- =============================================
CREATE PROCEDURE [dbo].[sp_Assets] 
--@EndDate datetime
AS
BEGIN
--set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	
SELECT        dbo.swiftfin_Assets.SerialNumber, dbo.swiftfin_Assets.Manufacturer, dbo.swiftfin_Assets.Model, dbo.swiftfin_Assets.TagNumber, dbo.swiftfin_Assets.PurchasePrice, dbo.swiftfin_Assets.ResidualValue, dbo.swiftfin_Departments.Description AS Department, 
                         dbo.swiftfin_Locations.Description AS Location, dbo.swiftfin_Suppliers.Description AS Supplier, dbo.swiftfin_ItemRegister.Description AS ItemName, dbo.swiftfin_AssetTypes.Description AS AssetType, dbo.swiftfin_Assets.Remarks,
						       dbo.swiftfin_Assets.CreatedDate, dbo.swiftfin_Assets.CreatedBy, Case dbo.swiftfin_Assets.Status when 0 Then 'Un-Alloted' when 2 Then 'Alloted' When 4 Then 'Returned' when 6 Then 'Disposed' else '' End As AssetRegisterStatus
FROM            dbo.swiftfin_Assets INNER JOIN
                         dbo.swiftfin_Departments ON dbo.swiftfin_Assets.DepartmentId = dbo.swiftfin_Departments.Id INNER JOIN
                         dbo.swiftfin_Locations ON dbo.swiftfin_Assets.LocationId = dbo.swiftfin_Locations.Id INNER JOIN
                         dbo.swiftfin_Suppliers ON dbo.swiftfin_Assets.SupplierId = dbo.swiftfin_Suppliers.Id INNER JOIN
                         dbo.swiftfin_ItemRegister ON dbo.swiftfin_Assets.ItemRegisterId = dbo.swiftfin_ItemRegister.Id INNER JOIN
                         dbo.swiftfin_AssetTypes ON dbo.swiftfin_ItemRegister.AssetTypeId = dbo.swiftfin_AssetTypes.Id

						-- where dbo.swiftfin_Assets.CreatedDate=@EndDate 
						 End 
GO
/****** Object:  StoredProcedure [dbo].[sp_AtmTransactions]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 08/10/2014
-- Description:	AtmTransactions
-- =============================================
-- sp_AtmTransactions '10/08/2014','10/08/2014'
CREATE PROCEDURE [dbo].[sp_AtmTransactions] 
	-- Add the parameters for the stored procedure here
	@StartDate datetime , 
	@EndDate datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
	SELECT        TOP (100) PERCENT dbo.swiftfin_Journals.CreatedDate,dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
                         dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference3, dbo.swiftfin_Branches.Description AS Branch, 
                         dbo.swiftfin_Journals.TotalValue,CASE WHEN dbo.swiftfin_JournalEntries.Amount<0 THEN dbo.swiftfin_JournalEntries.Amount *-1 ELSE 0 END AS DEBIT,
						 CASE WHEN dbo.swiftfin_JournalEntries.Amount>0 THEN dbo.swiftfin_JournalEntries.Amount  ELSE 0 END AS CREDIT
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
	WHERE        (dbo.swiftfin_JournalEntries.ContraChartOfAccountId IN
                             (SELECT        ChartOfAccountId
                               FROM            dbo.swiftfin_SystemGeneralLedgerAccountMappings
                               WHERE        (SystemGeneralLedgerAccountCode = '48835')))
	AND dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate
	order by dbo.swiftfin_Journals.CreatedDate asc
							   
END






GO
/****** Object:  StoredProcedure [dbo].[sp_AtmTransactionsFrequency]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---select * from swiftfin_ChartOfAccounts where id='36206afb-23d0-cbc4-72d9-08d10cad4b96'
---sp_AtmTransactionsFrequency 2,'06/01/2014', '07/02/2014',0

CREATE PROCEDURE [dbo].[sp_AtmTransactionsFrequency]
	-- Add the parameters for the stored procedure here
	(
		@CardType int,
		@StartDate Datetime,
		@EndDate DateTime,
		@Frequency int
	)
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
SELECT        dbo.swiftfin_AlternateChannelLogs.AlternateChannelType as DebitCardType, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
                         dbo.swiftfin_Journals.TotalValue, dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName, 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId, dbo.swiftfin_JournalEntries.CreatedDate, dbo.swiftfin_JournalEntries.Amount, dbo.swiftfin_ChartOfAccounts.AccountCode, 
                         dbo.swiftfin_ChartOfAccounts.AccountName
into #Frequency FROM            dbo.swiftfin_AlternateChannelLogs INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_AlternateChannelLogs.Id = dbo.swiftfin_Journals.AlternateChannelLogId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
WHERE  dbo.swiftfin_JournalEntries.CreatedDate between @StartDate and @EndDate and swiftfin_JournalEntries.ChartOfAccountId=

	case @CardType
	WHEN 1 THEN  'D4007A8E-76BD-E811-8355-08D40C76F50B'
	WHEN 2 THEN 'D4007A8E-76BD-E811-8355-08D40C76F50B'
	end
  and amount>200
END

select * from #Frequency where FullAccount in (select FullAccount from #Frequency group by FullAccount having count(FullAccount)>@Frequency) order by reference1,createddate

--select * from swiftfin_ChartOfAccounts where AccountName like '%atm%'







GO
/****** Object:  StoredProcedure [dbo].[sp_AtmTransactionsLocal]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 08/10/2014
-- Description:	AtmTransactions
-- =============================================
-- sp_AtmTransactions '10/08/2014','10/08/2014'
CREATE PROCEDURE [dbo].[sp_AtmTransactionsLocal] 
	-- Add the parameters for the stored procedure here
	@StartDate datetime , 
	@EndDate datetime,
	@ChartofAccountID varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
	SELECT        TOP (100) PERCENT dbo.swiftfin_Journals.CreatedDate,dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
                         dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference3, dbo.swiftfin_Branches.Description AS Branch, 
                         dbo.swiftfin_Journals.TotalValue,CASE WHEN dbo.swiftfin_JournalEntries.Amount<0 THEN dbo.swiftfin_JournalEntries.Amount *-1 ELSE 0 END AS DEBIT,
						 CASE WHEN dbo.swiftfin_JournalEntries.Amount>0 THEN dbo.swiftfin_JournalEntries.Amount  ELSE 0 END AS CREDIT
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
	WHERE        (dbo.swiftfin_JournalEntries.ContraChartOfAccountId =@ChartofAccountID
                             )
	AND dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate
							   
END






GO
/****** Object:  StoredProcedure [dbo].[sp_AttachGuarantor]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Jeff Inyundere
-- Create date: 30-07-2016
-- Description:	Extract attached Guarantor by PF Number
-- =============================================
---sp_AttachGuarantor '0000'
--[sp_AttachGuarantor] '08/08/2016','08/08/2018'
create  PROCEDURE [dbo].[sp_AttachGuarantor] 
	-- Add the parameters for the stored procedure here
	--@PayrollNo Varchar(20)
	@Startdate datetime,
	@EndDate datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	SET NOCOUNT ON;

   SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1 AS LoaneeAccount, dbo.vw_CustomerAccounts.Reference2 AS LoaneeMno, 
                         dbo.vw_CustomerAccounts.Reference3 AS LoaneePayrollNo, dbo.vw_CustomerAccounts.Address_MobileLine, vw_CustomerAccounts_1.Reference1 AS GuarantoAccountNo, 
                         vw_CustomerAccounts_1.Reference2 AS GuarantorMno, vw_CustomerAccounts_1.Description, vw_CustomerAccounts_1.Reference3 AS GuarantorPayrollNo, swiftfin_JournalEntries_1.Amount*-1 as Amount, vw_CustomerAccounts_1.FullName AS Name,swiftfin_JournalEntries_1.CreatedDate
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries AS swiftfin_JournalEntries_1 ON dbo.swiftfin_JournalEntries.JournalId = swiftfin_JournalEntries_1.JournalId INNER JOIN
                         dbo.vw_CustomerAccounts AS vw_CustomerAccounts_1 ON swiftfin_JournalEntries_1.CustomerAccountId = vw_CustomerAccounts_1.Id
	WHERE   swiftfin_journalentries_1.CreatedDate between @Startdate and @EndDate and (dbo.swiftfin_JournalEntries.JournalId IN
                             (SELECT        Id
                               FROM            dbo.swiftfin_Journals
                               WHERE        (TransactionCode = 48))) AND (dbo.swiftfin_JournalEntries.Amount > 0) and swiftfin_JournalEntries_1.Amount<0 order by  dbo.vw_CustomerAccounts.Reference3, vw_CustomerAccounts_1.Description
END


GO
/****** Object:  StoredProcedure [dbo].[sp_AttachGuarantorSingle]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Jeff Inyundere
-- Create date: 30-07-2016
-- Description:	Extract attached Guarantor by PF Number
-- =============================================
---sp_AttachGuarantor '0000'
--[sp_AttachGuarantorSingle] '00065369'
create PROCEDURE [dbo].[sp_AttachGuarantorSingle] 
	-- Add the parameters for the stored procedure here
	@PayrollNo Varchar(20)
	--@Startdate datetime,
	--@EndDate datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
		--set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	SET NOCOUNT ON;

   SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1 AS LoaneeAccount, dbo.vw_CustomerAccounts.Reference2 AS LoaneeMno, 
                         dbo.vw_CustomerAccounts.Reference3 AS LoaneePayrollNo, dbo.vw_CustomerAccounts.Address_MobileLine, vw_CustomerAccounts_1.Reference1 AS GuarantoAccountNo, 
                         vw_CustomerAccounts_1.Reference2 AS GuarantorMno, vw_CustomerAccounts_1.Description, vw_CustomerAccounts_1.Reference3 AS GuarantorPayrollNo, swiftfin_JournalEntries_1.Amount*-1 as Amount, vw_CustomerAccounts_1.FullName AS Name,swiftfin_JournalEntries_1.CreatedDate
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries AS swiftfin_JournalEntries_1 ON dbo.swiftfin_JournalEntries.JournalId = swiftfin_JournalEntries_1.JournalId INNER JOIN
                         dbo.vw_CustomerAccounts AS vw_CustomerAccounts_1 ON swiftfin_JournalEntries_1.CustomerAccountId = vw_CustomerAccounts_1.Id
	WHERE dbo.vw_CustomerAccounts.Reference3=@PayrollNo and (dbo.swiftfin_JournalEntries.JournalId IN
                             (SELECT        Id
                               FROM            dbo.swiftfin_Journals
                               WHERE        (TransactionCode = 48))) AND (dbo.swiftfin_JournalEntries.Amount > 0) and swiftfin_JournalEntries_1.Amount<0 order by  dbo.vw_CustomerAccounts.Reference3, vw_CustomerAccounts_1.Description
END

GO
/****** Object:  StoredProcedure [dbo].[sp_AuditLog]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--	select * from FindAuditLogs('01/01/2018','01/16/2018',0)
--SP_AuditLog '01/01/2018','01/16/2018','254728632428'
CREATE  procedure [dbo].[sp_AuditLog](@StartDate as Date, @EndDate  as Date, @Text Varchar(30)=null,@TableName varchar(100)='swiftfin_Customers')
as
Declare @Date1 Date,@Date2 Date

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

if @Text is null
begin
	select * from FindAuditLogs(@StartDate,@EndDate,0) 
	union
	select * from FindAuditLogs(@StartDate,@EndDate,1) 
end
else
begin
	set @Text= ltrim(rtrim(@Text));
	declare @Text1 varchar(100);

	
	with CTEAUDIT (EventType,TableName,AdditionalNarration,CreatedBy,CreatedDate)
	as
	(
		select EventType,TableName,AdditionalNarration,CreatedBy,CreatedDate from FindAuditLogs(@StartDate,@EndDate,0) where TableName=@TableName
			union
		select EventType,TableName,AdditionalNarration,CreatedBy,CreatedDate from FindAuditLogs(@StartDate,@EndDate,1) where TableName=@TableName
	)
	select * into #temp from CTEAUDIT 

	set @Text1= 'select * from #temp  where additionalNarration like '+'''%'+@Text+'%'''
	exec(@Text1)
end



GO
/****** Object:  StoredProcedure [dbo].[SP_AuditTrail]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--SP_AuditTrail '05/01/2016','09/30/2016','00000072'---- 5-02-00383422-00
CREATE procedure [dbo].[SP_AuditTrail] 
(
	@StartDate DateTime,
	@EndDate DateTime,
	@Reference varchar(10)
)
as

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
set @Reference='%'+@Reference+'%'

SELECT DISTINCT 
                  dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Customers.Individual_FirstName + dbo.swiftfin_Customers.Individual_LastName AS Name, 
                  dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.swiftfin_Journals.ApplicationUserName, dbo.swiftfin_Journals.EnvironmentUserName, 
                  dbo.swiftfin_Journals.EnvironmentMachineName, dbo.swiftfin_Journals.EnvironmentDomainName, dbo.swiftfin_Journals.EnvironmentOSVersion, dbo.swiftfin_Journals.EnvironmentMACAddress, 
                  dbo.swiftfin_Journals.EnvironmentMotherboardSerialNumber, dbo.swiftfin_Journals.EnvironmentProcessorId, dbo.swiftfin_Journals.CreatedDate as Valuedate, dbo.swiftfin_Journals.EnvironmentIPAddress, dbo.swiftfin_Journals.TotalValue, 
                  dbo.swiftfin_Branches.Description AS TransactionBranch,swiftfin_Journals.CreatedDate
FROM     dbo.swiftfin_Journals INNER JOIN
                  dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                  dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                  dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                  dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
WHERE swiftfin_Journals.CreatedDate between @StartDate and @EndDate  and swiftfin_Customers.reference1 like @Reference and swiftfin_Journals.ParentId is null order by swiftfin_Journals.CreatedDate







GO
/****** Object:  StoredProcedure [dbo].[sp_AuditTrail_byuser]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_AuditTrail_byuser '05/01/2016','06/30/2016','00383422'---- 5-02-00383422-00
CREATE procedure [dbo].[sp_AuditTrail_byuser] 
(
	@StartDate DateTime,
	@EndDate DateTime
	--@userid nvarchar(50)
)
as

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
--set @userid='%'+@userid+'%'

SELECT DISTINCT 
                  dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Customers.Individual_FirstName + dbo.swiftfin_Customers.Individual_LastName AS Name, 
                  dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.swiftfin_Journals.ApplicationUserName, dbo.swiftfin_Journals.EnvironmentUserName, 
                  dbo.swiftfin_Journals.EnvironmentMachineName, dbo.swiftfin_Journals.EnvironmentDomainName, dbo.swiftfin_Journals.EnvironmentOSVersion, dbo.swiftfin_Journals.EnvironmentMACAddress, 
                  dbo.swiftfin_Journals.EnvironmentMotherboardSerialNumber, dbo.swiftfin_Journals.EnvironmentProcessorId, dbo.swiftfin_Journals.ValueDate, dbo.swiftfin_Journals.EnvironmentIPAddress, dbo.swiftfin_Journals.TotalValue, 
                  dbo.swiftfin_Branches.Description AS TransactionBranch
FROM     dbo.swiftfin_Journals INNER JOIN
                  dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                  dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                  dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                  dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
WHERE swiftfin_Journals.CreatedDate between @StartDate and @EndDate 
-- and swiftfin_Journals.ApplicationUserName like @userid







GO
/****** Object:  StoredProcedure [dbo].[sp_AuditTrailExtract]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---sp_AuditTrailExtract '01/01/2018', '01/20/2018',

CREATE procedure [dbo].[sp_AuditTrailExtract] (@StartDate Date, @EndDate Date, @UserName varchar(10)=null,@Account varchar(20)=null) as
set nocount off;

with CTEAUDIT([Id]
      ,[EventType]
      ,[TableName]
      ,[RecordID]
      ,[AdditionalNarration]
      ,[ApplicationUserName]
      ,[EnvironmentUserName]
      ,[EnvironmentMachineName]
      ,[EnvironmentDomainName]
      ,[EnvironmentOSVersion]
      ,[EnvironmentMACAddress]
      ,[EnvironmentMotherboardSerialNumber]
      ,[EnvironmentProcessorId]
      ,[EnvironmentIPAddress]
      ,[SequentialId]
      ,[CreatedBy]
      ,[CreatedDate])
as
(
select  [Id]
      ,[EventType]
      ,[TableName]
      ,[RecordID]
      ,[AdditionalNarration]
      ,[ApplicationUserName]
      ,[EnvironmentUserName]
      ,[EnvironmentMachineName]
      ,[EnvironmentDomainName]
      ,[EnvironmentOSVersion]
      ,[EnvironmentMACAddress]
      ,[EnvironmentMotherboardSerialNumber]
      ,[EnvironmentProcessorId]
      ,[EnvironmentIPAddress]
      ,[SequentialId]
      ,[CreatedBy]
      ,[CreatedDate]
   from swiftfin_AuditLogs where CreatedDate>=@StartDate and CreatedDate<=@EndDate  and ApplicationUserName is not null and tablename  in 
 
('swiftfin_Journals','swiftfin_StandingOrders','swiftfin_FiscalCounts','swiftfin_Employees','swiftfin_CashWithdrawalRequests','swiftfin_CustomerAccountHistories','swiftfin_customers','swiftfin_LoanGuarantors','swiftfin_LoanCases')
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="6"%' and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="24"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="27"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="28"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="38"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="37"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="47"%'
union
select  [Id]
      ,[EventType]
      ,[TableName]
      ,[RecordID]
      ,[AdditionalNarration]
      ,[ApplicationUserName]
      ,[EnvironmentUserName]
      ,[EnvironmentMachineName]
      ,[EnvironmentDomainName]
      ,[EnvironmentOSVersion]
      ,[EnvironmentMACAddress]
      ,[EnvironmentMotherboardSerialNumber]
      ,[EnvironmentProcessorId]
      ,[EnvironmentIPAddress]
      ,[SequentialId]
      ,[CreatedBy]
      ,[CreatedDate]
   from swiftfin_AuditLogsArchive where CreatedDate>=@StartDate and CreatedDate<=@EndDate  and ApplicationUserName is not null and tablename  in  
('swiftfin_Journals','swiftfin_StandingOrders','swiftfin_FiscalCounts','swiftfin_Employees','swiftfin_CashWithdrawalRequests','swiftfin_CustomerAccountHistories','swiftfin_customers','swiftfin_LoanGuarantors','swiftfin_LoanCases')
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="6"%' and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="24"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="27"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="28"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="38"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="37"%'
and AdditionalNarration not like '%AuditInfo ColumnName="TransactionCode" OriginalValue="" NewValue="47"%'
)select * into #temp from CTEAUDIT
----select * from #temp
CREATE INDEX IX_ID   
    ON #temp (ID)
--select * from swiftfin_Employees
--select top 100 *  from swiftfin_AuditLogs where  TableName in ('swiftfin_Journals','swiftfin_StandingOrders') and applicationusername is not null
--select top 100 * into #temp from swiftfin_AuditLogs where  applicationusername is not null and tablename not in ('swiftfin_Journals','swiftfin_StandingOrders','swiftfin_CustomerMessageHistories','swiftfin_JournalEntries','swiftfin_AlternateChannelLogs','swiftfin_TextAlerts')
--select * from #temp
---select top 100 *  from swiftfin_AuditLogs where tablename not in ('swiftfin_Journals','swiftfin_StandingOrders','swiftfin_CustomerMessageHistories','swiftfin_JournalEntries','swiftfin_AlternateChannelLogs','swiftfin_TextAlerts')
--drop table #temp
--select * from swiftfin_CustomerMessageHistories where tablename not in ('swiftfin_Journals','swiftfin_StandingOrders','swiftfin_CustomerMessageHistories')
--drop table #AuditTrail
Create table #AuditTrail (UserName Char(20),Activity Varchar(100),Date DateTime,MachineName varchar(20),MacAddress VarChar(50),IPAddress VarChar(50),
AccountNo varchar(20),Amount Numeric(18,2))
/*NULL
Insert into #AuditTrail(UserName ,Activity ,Date ,MachineName ,MacAddress ,IPAddress)
select @UserName,@Activity ,@Date,@MachineName,@MacAddress,@IPAddress 
select UserName ,Activity ,Date ,MachineName ,MacAddress ,IPAddress from #AuditTrail
*/
declare @RowNum int
Select @RowNum = Count(*) From #temp      --get total number of records
WHILE @RowNum > 0   
--- WHILE EXISTS(SELECT  * FROM #Temp ) --- (SELECT count(tablename) FROM #temp) >0
BEGIN  
	Declare @ID uniqueidentifier,@TableName Varchar(100),@RecordID UniqueIdentifier,@EventType Varchar(20),@ApplicationUserName varchar(20),
	@EnvironmentMachineName varchar(50),@Date DateTime,@EnvironmentMACAddress varchar(50),@EnvironmentIPAddress VarChar(50),@Activity Varchar(100),@Amount Numeric(18,2),@AccountNo Varchar(20)
	set @ID =(select top 1 id from #temp)
	
	set @TableName=(select TableName from #temp where ID=@ID)
	set @RecordID=(select RecordID from #temp where ID=@ID)
	set @EventType=(select EventType from #temp where ID=@ID)
	set @ApplicationUserName=(select @ApplicationUserName from #temp where ID=@ID)
	set @ApplicationUserName=(select ApplicationUserName from #temp where ID=@ID)
	set @EnvironmentMachineName=(select EnvironmentMachineName from #temp where ID=@ID)
	set @EnvironmentMACAddress=(select EnvironmentMACAddress from #temp where ID=@ID)
	set @EnvironmentIPAddress=(select EnvironmentIPAddress from #temp where ID=@ID)
----	set @Date=(select CreatedDate from #temp where ID=@ID)

	IF ltrim(rtrim(@TableName))='swiftfin_Journals'
		Begin
		set @Activity=@EventType+' '+(SELECT top 1        swiftfin_Journals.PrimaryDescription
			FROM          swiftfin_Journals INNER JOIN
						  swiftfin_JournalEntries ON swiftfin_Journals.Id = swiftfin_JournalEntries.JournalId left JOIN
                          vw_CustomerAccounts ON swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id 
			WHERE		  swiftfin_journals.ID=@RecordID and swiftfin_Journals.ParentId is null and Amount>0 and swiftfin_journals.TransactionCode not in (select value from swiftfin_Enumerations where [key] like '%SystemTransactionCode%' and swiftfin_Journals.TransactionCode in (24,6,28,27,38,37)
))
		set @Amount	=(SELECT     top 1  swiftfin_Journals.TotalValue
			FROM          swiftfin_Journals INNER JOIN
						  swiftfin_JournalEntries ON swiftfin_Journals.Id = swiftfin_JournalEntries.JournalId left JOIN
                          vw_CustomerAccounts ON swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id 
			WHERE		  swiftfin_journals.ID=@RecordID and swiftfin_Journals.ParentId is null and Amount>0 and swiftfin_journals.TransactionCode not in (select value from swiftfin_Enumerations where [key] like '%SystemTransactionCode%' and swiftfin_Journals.TransactionCode in  (24,6,28,27,38,37)
))
		set @AccountNo=(SELECT     top 1   vw_CustomerAccounts.Reference1
			FROM          swiftfin_Journals INNER JOIN
						  swiftfin_JournalEntries ON swiftfin_Journals.Id = swiftfin_JournalEntries.JournalId left JOIN
                          vw_CustomerAccounts ON swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id 
			WHERE		  swiftfin_journals.ID=@RecordID and swiftfin_Journals.ParentId is null and Amount>0 and swiftfin_journals.TransactionCode not in (select value from swiftfin_Enumerations where [key] like '%SystemTransactionCode%' and swiftfin_Journals.TransactionCode in  (24,6,28,27,38,37)
))
		set @Date=(SELECT     top 1   swiftfin_Journals.CreatedDate
			FROM          swiftfin_Journals INNER JOIN
						  swiftfin_JournalEntries ON swiftfin_Journals.Id = swiftfin_JournalEntries.JournalId left JOIN
                          vw_CustomerAccounts ON swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id 
			WHERE		  swiftfin_journals.ID=@RecordID and swiftfin_Journals.ParentId is null and Amount>0 and swiftfin_journals.TransactionCode not in (select value from swiftfin_Enumerations where [key] like '%SystemTransactionCode%' and swiftfin_Journals.TransactionCode in   (24,6,28,27,38,37)
))
		end
	IF ltrim(rtrim(@TableName))='swiftfin_StandingOrders'
		Begin
			set @Activity='Modified '+(select Description from vw_CustomerAccounts where id in( select BeneficiaryCustomerAccountId from swiftfin_StandingOrders where ID=@RecordID))+' Standing Order'
			set @AccountNo=(select Reference1 from vw_CustomerAccounts where id in( select BeneficiaryCustomerAccountId from swiftfin_StandingOrders where ID=@RecordID))
			set @Date=(select CreatedDate from #temp where ID=@ID)
			set @Amount=(select Principal from swiftfin_StandingOrders where ID=@RecordID)
		end
--select * from swiftfin_FiscalCounts
	IF ltrim(rtrim(@TableName))='swiftfin_FiscalCounts'
		Begin
			set @Activity=(select PrimaryDescription +' - '+ SecondaryDescription from swiftfin_FiscalCounts where ID=@RecordID)
			set @AccountNo=(select Reference from swiftfin_FiscalCounts where ID=@RecordID)
			set @Date=(select CreatedDate from swiftfin_FiscalCounts where ID=@RecordID)
			set @Amount=(select Denomination_OneThousandValue+Denomination_FiveHundredValue	+Denomination_TwoHundredValue+Denomination_OneHundredValue+
			Denomination_FiftyValue+Denomination_TwentyValue+Denomination_TwentyValue+Denomination_FiveValue+Denomination_OneValue+Denomination_FiftyCentValue from swiftfin_FiscalCounts where ID=@RecordID)
		end

	IF ltrim(rtrim(@TableName))='swiftfin_Employees'
		Begin
			set @Activity=@EventType+' Employee Details for '+(SELECT       swiftfin_Customers.Individual_FirstName+' '+swiftfin_Customers.Individual_LastName
							FROM            swiftfin_Customers INNER JOIN
							swiftfin_Employees ON swiftfin_Customers.Id = swiftfin_Employees.CustomerId where swiftfin_Employees.id=@RecordID)
			set @AccountNo=(SELECT       swiftfin_Customers.Reference1
							FROM            swiftfin_Customers INNER JOIN
							swiftfin_Employees ON swiftfin_Customers.Id = swiftfin_Employees.CustomerId where swiftfin_Employees.id=@RecordID)
			set @Date=(select CreatedDate from #temp where ID=@ID)
			set @Amount=0
		end

	IF ltrim(rtrim(@TableName))='swiftfin_CashWithdrawalRequests' ----Account Based
		Begin
			set @Activity=@EventType+' Cash Withdrawal Authorization Requests  for '+(SELECT       vw_CustomerAccounts.fullname
							FROM            vw_CustomerAccounts INNER JOIN
							swiftfin_CashWithdrawalRequests ON vw_CustomerAccounts.Id = swiftfin_CashWithdrawalRequests.CustomerAccountId where swiftfin_CashWithdrawalRequests.id=@RecordID)
			set @AccountNo=(SELECT       vw_CustomerAccounts.Reference1
							FROM            vw_CustomerAccounts INNER JOIN
							swiftfin_CashWithdrawalRequests ON vw_CustomerAccounts.Id = swiftfin_CashWithdrawalRequests.CustomerAccountId where swiftfin_CashWithdrawalRequests.id=@RecordID)
			set @Date=(SELECT       swiftfin_CashWithdrawalRequests.CreatedDate
							FROM            vw_CustomerAccounts INNER JOIN
							swiftfin_CashWithdrawalRequests ON vw_CustomerAccounts.Id = swiftfin_CashWithdrawalRequests.CustomerAccountId where swiftfin_CashWithdrawalRequests.id=@RecordID)
			set @Amount=(SELECT       swiftfin_CashWithdrawalRequests.Amount
							FROM            vw_CustomerAccounts INNER JOIN
							swiftfin_CashWithdrawalRequests ON vw_CustomerAccounts.Id = swiftfin_CashWithdrawalRequests.CustomerAccountId where swiftfin_CashWithdrawalRequests.id=@RecordID)
		end

	IF ltrim(rtrim(@TableName))='swiftfin_CashWithdrawalRequests' -- Ledger Based
		Begin
			set @Activity=@EventType+' Cash Withdrawal Authorization Requests  for '+(SELECT       swiftfin_ChartOfAccounts.AccountName
							FROM            swiftfin_ChartOfAccounts INNER JOIN
							swiftfin_CashWithdrawalRequests ON swiftfin_ChartOfAccounts.Id = swiftfin_CashWithdrawalRequests.ChartOfAccountId where swiftfin_CashWithdrawalRequests.id=@RecordID)
			set @AccountNo=(SELECT       swiftfin_ChartOfAccounts.AccountCode
							FROM            swiftfin_ChartOfAccounts INNER JOIN
							swiftfin_CashWithdrawalRequests ON swiftfin_ChartOfAccounts.Id = swiftfin_CashWithdrawalRequests.ChartOfAccountId where swiftfin_CashWithdrawalRequests.id=@RecordID)
			set @Date=(SELECT       swiftfin_CashWithdrawalRequests.CreatedDate
							FROM            swiftfin_ChartOfAccounts INNER JOIN
							swiftfin_CashWithdrawalRequests ON swiftfin_ChartOfAccounts.Id = swiftfin_CashWithdrawalRequests.ChartOfAccountId where swiftfin_CashWithdrawalRequests.id=@RecordID)
			set @Amount=(SELECT       swiftfin_CashWithdrawalRequests.Amount
							FROM            swiftfin_ChartOfAccounts INNER JOIN
							swiftfin_CashWithdrawalRequests ON swiftfin_ChartOfAccounts.Id = swiftfin_CashWithdrawalRequests.ChartOfAccountId where swiftfin_CashWithdrawalRequests.id=@RecordID)
		end


	IF ltrim(rtrim(@TableName))='swiftfin_CustomerAccountHistories' -- Ledger Based
		Begin
			set @Activity=@EventType+' '+(SELECT      swiftfin_Enumerations.Description+' - ' +swiftfin_CustomerAccountHistories.Remarks
										FROM         vw_CustomerAccounts INNER JOIN
                         swiftfin_CustomerAccountHistories ON vw_CustomerAccounts.Id = swiftfin_CustomerAccountHistories.CustomerAccountId INNER JOIN
                         swiftfin_Enumerations ON swiftfin_CustomerAccountHistories.ManagementAction = swiftfin_Enumerations.Value
						WHERE        (swiftfin_Enumerations.[Key] LIKE '%CustomerAccountManagementAction%') and swiftfin_CustomerAccountHistories.id=@RecordID)
			set @AccountNo=(SELECT     vw_CustomerAccounts.Reference1
										FROM         vw_CustomerAccounts INNER JOIN
                         swiftfin_CustomerAccountHistories ON vw_CustomerAccounts.Id = swiftfin_CustomerAccountHistories.CustomerAccountId INNER JOIN
                         swiftfin_Enumerations ON swiftfin_CustomerAccountHistories.ManagementAction = swiftfin_Enumerations.Value
						WHERE        (swiftfin_Enumerations.[Key] LIKE '%CustomerAccountManagementAction%') and swiftfin_CustomerAccountHistories.id=@RecordID)
			set @Date=(SELECT     swiftfin_CustomerAccountHistories.CreatedDate
										FROM         vw_CustomerAccounts INNER JOIN
                         swiftfin_CustomerAccountHistories ON vw_CustomerAccounts.Id = swiftfin_CustomerAccountHistories.CustomerAccountId INNER JOIN
                         swiftfin_Enumerations ON swiftfin_CustomerAccountHistories.ManagementAction = swiftfin_Enumerations.Value
						WHERE        (swiftfin_Enumerations.[Key] LIKE '%CustomerAccountManagementAction%') and swiftfin_CustomerAccountHistories.id=@RecordID)
			set @Amount=0
		end

	IF ltrim(rtrim(@TableName))='swiftfin_Customers'
		Begin
			set @Activity=@EventType+' '+(SELECT      swiftfin_Customers.Individual_FirstName+' '+swiftfin_Customers.Individual_LastName +' ID#'+swiftfin_Customers.Individual_IdentityCardNumber+' Phone# '+swiftfin_Customers.Address_MobileLine
										FROM         swiftfin_Customers  where id=@RecordID)
			set @AccountNo=(SELECT      swiftfin_Customers.Reference1
										FROM         swiftfin_Customers  where id=@RecordID)
			set @Date=(select CreatedDate from #temp where ID=@ID)
			set @Amount=0
		end

	IF ltrim(rtrim(@TableName))='swiftfin_LoanGuarantors'
		Begin
			set @Activity=@EventType+' For Guarantor- > '+(SELECT     swiftfin_Customers.Individual_FirstName+' '+swiftfin_Customers.Individual_LastName+ ' Loan Type:'+   swiftfin_LoanProducts.Description
										FROM            swiftfin_LoanGuarantors INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanGuarantors.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanGuarantors.LoanProductId = swiftfin_LoanProducts.Id  where swiftfin_LoanGuarantors.id=@RecordID)
			set @AccountNo=(SELECT     swiftfin_Customers.Reference1
										FROM            swiftfin_LoanGuarantors INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanGuarantors.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanGuarantors.LoanProductId = swiftfin_LoanProducts.Id  where swiftfin_LoanGuarantors.id=@RecordID)
			set @Date=(SELECT     swiftfin_LoanGuarantors.CreatedDate
										FROM            swiftfin_LoanGuarantors INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanGuarantors.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanGuarantors.LoanProductId = swiftfin_LoanProducts.Id  where swiftfin_LoanGuarantors.id=@RecordID)
			set @Amount=(SELECT     swiftfin_LoanGuarantors.AmountGuaranteed
										FROM            swiftfin_LoanGuarantors INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanGuarantors.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanGuarantors.LoanProductId = swiftfin_LoanProducts.Id  where swiftfin_LoanGuarantors.id=@RecordID)
		end


	IF ltrim(rtrim(@TableName))='swiftfin_LoanCases' 
		Begin
			set @Activity=@EventType+' Loaning Process '+(SELECT        swiftfin_LoanProducts.Description+' For '+swiftfin_Customers.Individual_FirstName+' '+swiftfin_Customers.Individual_LastName
			FROM            swiftfin_LoanCases INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanCases.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanCases.LoanProductId = swiftfin_LoanProducts.Id  where swiftfin_LoanCases.id=@RecordID)
			set @AccountNo=(SELECT        swiftfin_customers.Reference1
			FROM            swiftfin_LoanCases INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanCases.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanCases.LoanProductId = swiftfin_LoanProducts.Id  where swiftfin_LoanCases.id=@RecordID)
			set @Date=(select CreatedDate from #temp where ID=@ID)
			set @Amount=(SELECT        swiftfin_LoanCases.AmountApplied
			FROM            swiftfin_LoanCases INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanCases.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanCases.LoanProductId = swiftfin_LoanProducts.Id  where swiftfin_LoanCases.id=@RecordID)
		end



if @Activity is not null
		begin
			Insert into #AuditTrail(UserName ,Activity ,Date ,MachineName ,MacAddress ,IPAddress,AccountNo,Amount)
			select @ApplicationUserName,@Activity ,@Date,@EnvironmentMachineName,@EnvironmentMACAddress,@EnvironmentIPAddress,@AccountNo,@Amount
	end
    set @RowNum = @RowNum - 1  
	delete from #temp where id=@ID
END  
drop table #temp

CREATE INDEX IX_AccountNo   
    ON #AuditTrail (AccountNo)

CREATE INDEX IX_UserName   
    ON #AuditTrail (UserName)
--select @TableName,@Activity,@ID
if @Account is not null and @UserName is null
begin
	select * from #AuditTrail where AccountNo=@Account
end
if @UserName is not null and @Account is null
begin
	select * from #AuditTrail where UserName=@UserName	
end
if @UserName is not null and @Account is not null
begin
	select * from #AuditTrail where UserName=@UserName and AccountNo=@Account	
end
if @UserName is  null and @Account is  null
begin
	select * from #AuditTrail 
end

--drop table #AuditTrail


GO
/****** Object:  StoredProcedure [dbo].[sp_AuditTrailLog]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_AuditTrailLog 'A5738399-7063-C972-136C-08D3868C2D0B', '01/01/2015','07/01/2017'
create procedure [dbo].[sp_AuditTrailLog] (@CustomerID uniqueidentifier, @StartDate DateTime , @EndDate DateTime)
as
with CTEAudit (CustomerID,Date,UserName,Action,Amount,MachineName)
as
(
/*Transaction Table*/

SELECT        dbo.swiftfin_CustomerAccounts.CustomerId, dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.EnvironmentUserName, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_JournalEntries.Amount,dbo.swiftfin_Journals.EnvironmentMachineName
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
						where swiftfin_CustomerAccounts.CustomerId=@CustomerID and  dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate and dbo.swiftfin_JournalEntries.Amount>0
union
/*Customer Createddate */

	select id,CreatedDate,CreatedBy,'Account Creation',0,
	(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_customers.id)
	 from swiftfin_Customers where id=@CustomerID and CreatedDate between @StartDate and @EndDate

	union
/*Customer Status*/

	select id,ModifiedDate,ModifiedBy,'Account Modified',0,
		(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_customers.id)
	 from swiftfin_Customers where id=@CustomerID and ModifiedDate between @StartDate and @EndDate

	union
/*Account Remarks*/

	SELECT        dbo.swiftfin_CustomerAccounts.CustomerId, dbo.swiftfin_CustomerAccountHistories.CreatedDate,  dbo.swiftfin_CustomerAccountHistories.CreatedBy, 
							 dbo.swiftfin_Enumerations.Description +'-'+dbo.swiftfin_CustomerAccountHistories.Remarks,0,
	(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_CustomerAccountHistories.id)
	FROM            dbo.swiftfin_CustomerAccountHistories INNER JOIN
							 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_CustomerAccountHistories.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
							 dbo.swiftfin_Enumerations ON dbo.swiftfin_CustomerAccountHistories.ManagementAction = dbo.swiftfin_Enumerations.Value
	WHERE        (dbo.swiftfin_Enumerations.[Key] LIKE 'CustomerAccountManagementAction') and CustomerId=@CustomerID and dbo.swiftfin_CustomerAccountHistories.CreatedDate between  @StartDate and @EndDate
	union
/*Payouts*/

	select dbo.swiftfin_CustomerAccounts.CustomerId,dbo.swiftfin_CreditBatchEntries.CreatedDate,dbo.swiftfin_CreditBatchEntries.CreatedBy,'Created Payout:-'+dbo.swiftfin_CreditBatches.Reference,dbo.swiftfin_CreditBatchEntries.Principal,
	(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_CreditBatchEntries.id)	
	 FROM            dbo.swiftfin_CreditBatchEntries INNER JOIN
							 dbo.swiftfin_CreditBatches ON dbo.swiftfin_CreditBatchEntries.CreditBatchId = dbo.swiftfin_CreditBatches.Id INNER JOIN
							 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_CreditBatchEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
	where dbo.swiftfin_CustomerAccounts.CustomerId=@CustomerID and dbo.swiftfin_CreditBatchEntries.CreatedDate between @StartDate and @EndDate
	union
	select dbo.swiftfin_CustomerAccounts.CustomerId,dbo.swiftfin_CreditBatches.AuditedDate,dbo.swiftfin_CreditBatches.AuditedBy,'Audited Payout:-'+dbo.swiftfin_CreditBatches.Reference,dbo.swiftfin_CreditBatchEntries.Principal,
		(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_CreditBatchEntries.id)	
	 FROM            dbo.swiftfin_CreditBatchEntries INNER JOIN
							 dbo.swiftfin_CreditBatches ON dbo.swiftfin_CreditBatchEntries.CreditBatchId = dbo.swiftfin_CreditBatches.Id INNER JOIN
							 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_CreditBatchEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
	where dbo.swiftfin_CustomerAccounts.CustomerId=@CustomerID and dbo.swiftfin_CreditBatches.AuditedDate between @StartDate and @EndDate
	union
	select dbo.swiftfin_CustomerAccounts.CustomerId,dbo.swiftfin_CreditBatches.AuthorizedDate,dbo.swiftfin_CreditBatches.AuthorizedBy,'Authorized Payout:-'+dbo.swiftfin_CreditBatches.Reference,dbo.swiftfin_CreditBatchEntries.Principal,
	(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_CreditBatchEntries.id)	
	 FROM            dbo.swiftfin_CreditBatchEntries INNER JOIN
							 dbo.swiftfin_CreditBatches ON dbo.swiftfin_CreditBatchEntries.CreditBatchId = dbo.swiftfin_CreditBatches.Id INNER JOIN
							 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_CreditBatchEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
	where dbo.swiftfin_CustomerAccounts.CustomerId=@CustomerID and dbo.swiftfin_CreditBatches.AuthorizedDate between @StartDate and @EndDate
union
/*Overdeductions*/
select dbo.swiftfin_CustomerAccounts.CustomerId,dbo.swiftfin_OverDeductionBatches.CreatedDate,dbo.swiftfin_OverDeductionBatches.CreatedBy,'Created OverDeduction '+swiftfin_OverDeductionBatches.Reference,dbo.swiftfin_OverDeductionBatchEntries.Principal+swiftfin_OverDeductionBatchEntries.Interest,
	(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_OverDeductionBatches.id)	
FROM            dbo.swiftfin_OverDeductionBatchEntries INNER JOIN
                         dbo.swiftfin_OverDeductionBatches ON dbo.swiftfin_OverDeductionBatchEntries.OverDeductionBatchId = dbo.swiftfin_OverDeductionBatches.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_OverDeductionBatchEntries.DebitCustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
where dbo.swiftfin_CustomerAccounts.CustomerId=@CustomerID and dbo.swiftfin_OverDeductionBatches.CreatedDate between @StartDate and @EndDate
union
select dbo.swiftfin_CustomerAccounts.CustomerId,dbo.swiftfin_OverDeductionBatches.AuditedDate,dbo.swiftfin_OverDeductionBatches.AuditedBy,'Verified OverDeduction '+swiftfin_OverDeductionBatches.Reference,dbo.swiftfin_OverDeductionBatchEntries.Principal+swiftfin_OverDeductionBatchEntries.Interest,
	(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_OverDeductionBatches.id)	
FROM            dbo.swiftfin_OverDeductionBatchEntries INNER JOIN
                         dbo.swiftfin_OverDeductionBatches ON dbo.swiftfin_OverDeductionBatchEntries.OverDeductionBatchId = dbo.swiftfin_OverDeductionBatches.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_OverDeductionBatchEntries.DebitCustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
where dbo.swiftfin_CustomerAccounts.CustomerId=@CustomerID and dbo.swiftfin_OverDeductionBatches.AuditedDate between @StartDate and @EndDate
union
select dbo.swiftfin_CustomerAccounts.CustomerId,dbo.swiftfin_OverDeductionBatches.AuthorizedDate,dbo.swiftfin_OverDeductionBatches.AuthorizedBy,'Authorized OverDeduction '+swiftfin_OverDeductionBatches.Reference,dbo.swiftfin_OverDeductionBatchEntries.Principal+swiftfin_OverDeductionBatchEntries.Interest,
	(select top 1 EnvironmentMachineName from swiftfin_AuditLogsArchive where RecordID=swiftfin_OverDeductionBatches.id)	
FROM            dbo.swiftfin_OverDeductionBatchEntries INNER JOIN
                         dbo.swiftfin_OverDeductionBatches ON dbo.swiftfin_OverDeductionBatchEntries.OverDeductionBatchId = dbo.swiftfin_OverDeductionBatches.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_OverDeductionBatchEntries.DebitCustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
where dbo.swiftfin_CustomerAccounts.CustomerId=@CustomerID and dbo.swiftfin_OverDeductionBatches.AuthorizedDate between @StartDate and @EndDate


)
select * from CTEAudit




GO
/****** Object:  StoredProcedure [dbo].[sp_AuxilliaryBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---sp_AuxilliaryBalance '01/01/2016','12/31/2016',1000,0.015
CREATE Procedure [dbo].[sp_AuxilliaryBalance] 
(
	@BegDate as DateTime,
	@EndDate as DateTime,
	@EaringBalance Numeric(18,2),
	@InterestRate Numeric(5,3)
)
as
With CTEMonthlyBalances (CustomerAccount,PayrollNo,Name,BalanceBF,January,February,March,April,May,June,July,August,September,October,November,December,Total,Deleted)
as(
SELECT 
(
--select left(reference1,4)+substring(reference1,6,3)+substring(reference1,10,5) from vw_customeraccounts where id =a.customeraccountid) as CustomerAccount,
  select reference1 from vw_customeraccounts where id =a.customeraccountid) as CustomerAccount,
(
--select left(reference1,4)+substring(reference1,6,3)+substring(reference1,10,5) from vw_customeraccounts where id =a.customeraccountid) as PayrollNo,
 select reference3 from vw_customeraccounts where id =a.customeraccountid) as PayrollNo,
(select FullName from vw_customeraccounts where id =a.customeraccountid) as Name,
isnull((
SELECT     sum(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts) and history.trdate<@BegDate and history.docid not in ('2206')),0) as BalanceBF,
isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts) and year(history.trdate)=year(@BegDate) and month(history.trdate)=1 and history.docid not in ('2206') ),0)  
   AS 'January',

isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts)  and year(history.trdate)=year(@BegDate) and month(history.trdate)=2 and history.docid not in ('2206')),0)  
   AS 'February',
isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts) and year(history.trdate)=year(@BegDate) and month(history.trdate)=3 and history.docid not in ('2206') ),0)  
   AS 'March',
isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts) and year(history.trdate)=year(@BegDate) and month(history.trdate)=4 and history.docid not in ('2206')),0)  
   AS 'April',
isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts) and year(history.trdate)=year(@BegDate) and month(history.trdate)=5 and history.docid not in ('2206')),0)  
   AS 'May',
isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts) and year(history.trdate)=year(@BegDate) and  month(history.trdate)=6 and history.docid not in ('2206')),0)  
   AS 'June',
isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts)  and year(history.trdate)=year(@BegDate) and month(history.trdate)=7 and history.docid not in ('2206')),0)  
   AS 'July',

   isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts)  and year(history.trdate)=year(@BegDate) and month(history.trdate)=8 and history.docid not in ('2206')),0)  
   AS 'August',

      isnull((select 
  SUM(isnull(debit,0)-isnull(credit,0))
FROM         fosa.dbo.history INNER JOIN
                      dbo.vw_CustomerAccounts ON fosa.dbo.history.fosa_acno COLLATE Latin1_General_CI_AS = dbo.vw_CustomerAccounts.Reference1 where  dbo.vw_CustomerAccounts.Id=a.CustomerAccountId and 
					  dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts)  and year(history.trdate)=year(@BegDate) and month(history.trdate)=8 and history.docid not in ('2206')),0)  
   AS 'September',

   
--  SUM(CASE datepart(month,CreatedDate) WHEN 2 THEN Amount ELSE 0 END) AS 'February',
 -- SUM(CASE datepart(month,CreatedDate) WHEN 3 THEN Amount ELSE 0 END) AS 'March',
--  SUM(CASE datepart(month,CreatedDate) WHEN 4 THEN Amount ELSE 0 END) AS 'April',
 -- SUM(CASE datepart(month,CreatedDate) WHEN 5 THEN Amount ELSE 0 END) AS 'May',
 -- SUM(CASE datepart(month,CreatedDate) WHEN 6 THEN Amount ELSE 0 END) AS 'June',
 -- SUM(CASE datepart(month,CreatedDate) WHEN 7 THEN Amount ELSE 0 END) AS 'July',
  --SUM(CASE datepart(month,CreatedDate) WHEN 8 THEN Amount ELSE 0 END) AS 'August',
  --SUM(CASE datepart(month,CreatedDate) WHEN 9 THEN Amount ELSE 0 END) AS 'September',
  SUM(CASE datepart(month,CreatedDate) WHEN 10 THEN Amount ELSE 0 END) AS 'October',
  SUM(CASE datepart(month,CreatedDate) WHEN 11 THEN Amount ELSE 0 END) AS 'November',
  SUM(CASE datepart(month,CreatedDate) WHEN 12 THEN Amount ELSE 0 END) AS 'December',
  SUM(CASE datepart(year,CreatedDate) WHEN year(@BegDate) THEN Amount ELSE 0 END) AS 'TOTAL',
  isnull((select 'Delete' from vw_customeraccounts where id =a.customeraccountid and left(reference1,8)='1200-000' and dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts where code=1)),'')
FROM
    swiftfin_JournalEntries a
WHERE
  CreatedDate BETWEEN @BegDate AND @EndDate 
  and ChartOfAccountId in (select ChartOfAccountId from swiftfin_SavingsProducts) 
  group by CustomerAccountId
  )
  select CustomerAccount,Name,BalanceBF,
  January+BalanceBF as January,
  January+February+BalanceBF as February,
  January+February+March +BalanceBF as March,
  January+February+March +April+BalanceBF as April,
  January+February+March +April+May+BalanceBF as May,
  January+February+March +April+May+June+BalanceBF as June,
  January+February+March +April+May+June+July +BalanceBF as July,
  January+February+March +April+May+June+July +August+BalanceBF as August,
  January+February+March +April+May+June+July+August+September+BalanceBF as September,
  --August as August,
  --August+September as September,
  August+September+October as October,
  August+September+October+November as November,
  August+September+October+November+December as December,
  Total  as YearTotal,
 case when @EaringBalance<January+BalanceBF then January+BalanceBF-@EaringBalance  else 0 end as JanEarningBalance,
 case when @EaringBalance<January+February+BalanceBF then January+February+BalanceBF-@EaringBalance  else 0 end as FebEarningBalance,
 case when @EaringBalance<January+February+March +BalanceBF then January+February+March +BalanceBF-@EaringBalance  else 0 end as MarEarningBalance,
 case when @EaringBalance<January+February+March +April+BalanceBF then January+February+March +April+BalanceBF-@EaringBalance  else 0 end as ApriEarningBalance,
 case when @EaringBalance<January+February+March +April+May+BalanceBF then January+February+March +April+May+BalanceBF-@EaringBalance  else 0 end as MayEarningBalance,
 case when @EaringBalance<January+February+March +April+May+June+BalanceBF then January+February+March +April+May+June+BalanceBF-@EaringBalance  else 0 end as JunEarningBalance,
 case when @EaringBalance<January+February+March +April+May+June+July +BalanceBF then January+February+March +April+May+June+July +BalanceBF-@EaringBalance  else 0 end as JulEarningBalance,
 case when @EaringBalance<January+February+March +April+May+June+July +August+BalanceBF then January+February+March +April+May+June+July +BalanceBF-@EaringBalance  else 0 end as AugEarningBalance,
 case when @EaringBalance<January+February+March +April+May+June+July +August+September+BalanceBF then January+February+March +April+May+June+July +BalanceBF-@EaringBalance  else 0 end as SepEarningBalance,
 --case when @EaringBalance<August then August-@EaringBalance  else 0 end as AugEarningBalance,
 --case when @EaringBalance<August+September then August+September-@EaringBalance  else 0 end as SepEarningBalance,
 --case when @EaringBalance< August+September+October then  August+September+October-@EaringBalance  else 0 end as OctEarningBalance,
 case when @EaringBalance< October then October-@EaringBalance  else 0 end as OctEarningBalance,
 case when @EaringBalance< October+November then October+November-@EaringBalance  else 0 end as NovEarningBalance,
 case when @EaringBalance< October+November+December then October+November+December-@EaringBalance  else 0 end as DecEarningBalance,Deleted,PayrollNo
 into #CTEMonthlyEarning from CTEMonthlyBalances order by CustomerAccount
 select *,
 JanEarningBalance+FebEarningBalance+MarEarningBalance+ApriEarningBalance+MayEarningBalance+JunEarningBalance+JunEarningBalance+
 JulEarningBalance+AugEarningBalance+SepEarningBalance+OctEarningBalance+NovEarningBalance+DecEarningBalance as TotalEarningBalance,
 (JanEarningBalance+FebEarningBalance+MarEarningBalance+ApriEarningBalance+MayEarningBalance+JunEarningBalance+ JulEarningBalance+
 AugEarningBalance+SepEarningBalance+OctEarningBalance+NovEarningBalance+DecEarningBalance)/12 as AverageEarningBalance,
 ((JanEarningBalance+FebEarningBalance+MarEarningBalance+ApriEarningBalance+MayEarningBalance+JunEarningBalance+ JulEarningBalance
 +AugEarningBalance+SepEarningBalance+OctEarningBalance+NovEarningBalance+DecEarningBalance)/12)*@InterestRate as InterestEarned
  from #CTEMonthlyEarning where deleted not in ('Delete')




GO
/****** Object:  StoredProcedure [dbo].[sp_Balance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_Balance] 
	-- Add the parameters for the stored procedure here
	@CustomerAccountID varchar(100),
	@Type int  
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT 
	CASE 
		WHEN @Type=1 THEN ---Account Balance

			(		SELECT SUM(dbo.swiftfin_JournalEntries.Amount) AS amount
					FROM   dbo.swiftfin_JournalEntries INNER JOIN
						dbo.Products(0) AS Products_1 ON dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.ChartOfAccountId
					WHERE CustomerAccountId =@CustomerAccountId and ContraChartOfAccountId<>'F219BF2C-7956-C13E-C38E-08D133ECD9FB'
			
			) 

		 ELSE  --- AccountInterest

			(		SELECT SUM(dbo.swiftfin_JournalEntries.Amount) AS amount
					FROM   dbo.swiftfin_JournalEntries INNER JOIN
						dbo.Products(0) AS Products_1 ON dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.InterestReceivable
					WHERE CustomerAccountId =@CustomerAccountId 
			)
		  END as Balance
END






GO
/****** Object:  StoredProcedure [dbo].[sp_BanksRegister]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_BanksRegister] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT 
			(SELECT 
				Code
			FROM [dbo].[swiftfin_Banks] where ID=[dbo].[swiftfin_BankBranches].BankId) as BankCode,
			(SELECT 
				[Description]
			FROM [dbo].[swiftfin_Banks] where ID=[dbo].[swiftfin_BankBranches].BankId) as BankName
		  ,[Code]
		  ,[Description]
		  ,[Address_AddressLine1]
		  ,[Address_AddressLine2]
		  ,[Address_Street]
		  ,[Address_PostalCode]
		  ,[Address_City]
		  ,[Address_Email]
		  ,[Address_LandLine]
		  ,[Address_MobileLine]
		  ,[CreatedDate]
	  FROM [dbo].[swiftfin_BankBranches]
	END











GO
/****** Object:  StoredProcedure [dbo].[sp_BenevolentBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---[sp_BenevolentBalances] '1/1/2016'

CREATE PROCEDURE [dbo].[sp_BenevolentBalances] 
	-- Add the parameters for the stored procedure here
		@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With benevolent(AccountNo,Reference1,Reference2,Reference3,AccountName,Balance)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount 
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId inner join
								 dbo.swiftfin_journals on dbo.swiftfin_JournalEntries.JournalId=dbo.swiftfin_journals.id 


		WHERE        dbo.swiftfin_InvestmentProducts.code=1 and dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance 
	FROM benevolent 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName having SUM(Balance) <>0
END







GO
/****** Object:  StoredProcedure [dbo].[sp_bosa]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec [sp_BosaStatementtest] '00390072  ','01/01/2007','02/22/2016'
create Procedure [dbo].[sp_bosa] 
(
	@SaccoMno varchar(10),
	@StartDate DateTime,
	@EndDate DateTime
)

as
WITH CTEBosa (pf_no,Name,TrxDate,Description,Debit,Credit,Balance,interestdr,interestcr,interestbalance,TranType,Product)
as
(
select customer.tsc_no,customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned1,0) as Debit,coalesce(Lnrep1,0) as Credit,
 SUM(isnull(Loaned1,0)-isnull(Lnrep1,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal,
coalesce(intcharged1,0) as interestdr,coalesce(Lnint1,0) as Interestcr,
SUM(isnull(intcharged1,0)-isnull(Lnint1,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS InterestBalance,'01','Normal Loan'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no
where ltrim(ltrim(legacy.dbo.customer.tsc_no))=@SaccoMno and coalesce(Loaned2,0) +coalesce(Lnrep2,0)<>0 
and date<=@StartDate and date>=@EndDate

union

select customer.tsc_no,customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned2,0) as Debit,coalesce(Lnrep2,0) as Credit,
 SUM(isnull(Loaned2,0)-isnull(Lnrep2,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged2,0) as interestdr,coalesce(Lnint2,0) as Interestcr,
SUM(isnull(intcharged2,0)-isnull(Lnint2,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'02','School Fees Loan'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no
where ltrim(ltrim(legacy.dbo.customer.tsc_no))=@SaccoMno and coalesce(Loaned2,0) +coalesce(Lnrep2,0)<>0 
and date>=@StartDate and date>=@EndDate
union

select customer.tsc_no,customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned3,0) as Debit,coalesce(Lnrep3,0) as Credit,
 SUM(isnull(Loaned3,0)-isnull(Lnrep3,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged3,0) as interestdr,coalesce(Lnint3,0) as Interestcr,
SUM(isnull(intcharged3,0)-isnull(Lnint3,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'03','Haraka Loan'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no 
where ltrim(ltrim(legacy.dbo.customer.tsc_no))=@SaccoMno and coalesce(Loaned3,0) +coalesce(Lnrep3,0)<>0 
and date>=@StartDate and date>=@EndDate
union

select customer.tsc_no,customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned4,0) as Debit,coalesce(Lnrep4,0) as Credit,
 SUM(isnull(Loaned4,0)-isnull(Lnrep4,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged4,0) as interestdr,coalesce(Lnint4,0) as Interestcr,
SUM(isnull(intcharged4,0)-isnull(Lnint4,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'04','Scholar Loan'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no 
where ltrim(ltrim(legacy.dbo.customer.tsc_no))=@SaccoMno and coalesce(Loaned4,0) +coalesce(Lnrep4,0)<>0 
and date>=@StartDate and date>=@EndDate
union

select customer.tsc_no,customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned5,0) as Debit,coalesce(Lnrep5,0) as Credit,
 SUM(isnull(Loaned5,0)-isnull(Lnrep5,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged5,0) as interestdr,coalesce(Lnint5,0) as Interestcr,
SUM(isnull(intcharged5,0)-isnull(Lnint5,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'05','Auto Mobile Loan'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no 
where ltrim(ltrim(legacy.dbo.customer.tsc_no))=@SaccoMno and coalesce(Loaned5,0) +coalesce(Lnrep5,0)<>0
and date>=@StartDate and date>=@EndDate
union

select customer.tsc_no,customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned6,0) as Debit,coalesce(Lnrep6,0) as Credit,
 SUM(isnull(Loaned6,0)-isnull(Lnrep6,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged6,0) as interestdr,coalesce(Lnint6,0) as Interestcr,
SUM(isnull(intcharged6,0)-isnull(Lnint6,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'06','Development'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no 
where ltrim(ltrim(legacy.dbo.customer.tsc_no))=@SaccoMno and coalesce(Loaned6,0) +coalesce(Lnrep6,0)<>0 
and date>=@StartDate and date>=@EndDate
union

select customer.tsc_no,customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned7,0) as Debit,coalesce(Lnrep7,0) as Credit,
 SUM(isnull(Loaned7,0)-isnull(Lnrep7,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(acint7,0) as interestdr,coalesce(Lnint7,0) as Interestcr,
SUM(isnull(acint7,0)-isnull(Lnint7,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'07','Prime Loan'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no 
where ltrim(ltrim(legacy.dbo.customer.tsc_no))=@SaccoMno and coalesce(Loaned7,0) +coalesce(Lnrep7,0)<>0 
and date>=@StartDate and date>=@EndDate
)
select * from CTEBosa  order by Trantype,TrxDate





GO
/****** Object:  StoredProcedure [dbo].[sp_BosaStatementtest]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec [sp_BosaStatementtest] '00390072  ','01/01/2015','02/22/2016'
create Procedure [dbo].[sp_BosaStatementtest] 
(
	@PayrollNumber varchar(10),
	@StartingDate DateTime,
	@EndingDate DateTime
)

as
WITH CTEBosa (Name,Date,Description,Debit,Credit,Balance,interestdr,interestcr,interestbalance,TrxType)
as
(
select customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned1,0) as Debit,coalesce(Lnrep1,0) as Credit,
 SUM(isnull(Loaned1,0)-isnull(Lnrep1,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal,
coalesce(intcharged1,0) as interestdr,coalesce(Lnint1,0) as Interestcr,
SUM(isnull(intcharged1,0)-isnull(Lnint1,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS InterestBalance,'01'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no
where legacy.dbo.customer.tsc_no=@PayrollNumber and coalesce(Loaned2,0) +coalesce(Lnrep2,0)<>0 

union

select customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned2,0) as Debit,coalesce(Lnrep2,0) as Credit,
 SUM(isnull(Loaned2,0)-isnull(Lnrep2,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged2,0) as interestdr,coalesce(Lnint2,0) as Interestcr,
SUM(isnull(intcharged2,0)-isnull(Lnint2,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'02'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no
where legacy.dbo.customer.tsc_no=@PayrollNumber and coalesce(Loaned2,0) +coalesce(Lnrep2,0)<>0 

union

select customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned3,0) as Debit,coalesce(Lnrep3,0) as Credit,
 SUM(isnull(Loaned3,0)-isnull(Lnrep3,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged3,0) as interestdr,coalesce(Lnint3,0) as Interestcr,
SUM(isnull(intcharged3,0)-isnull(Lnint3,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'03'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no where legacy.dbo.customer.tsc_no=@PayrollNumber and coalesce(Loaned3,0) +coalesce(Lnrep3,0)<>0 

union

select customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned4,0) as Debit,coalesce(Lnrep4,0) as Credit,
 SUM(isnull(Loaned4,0)-isnull(Lnrep4,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged4,0) as interestdr,coalesce(Lnint4,0) as Interestcr,
SUM(isnull(intcharged4,0)-isnull(Lnint4,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'04'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no where legacy.dbo.customer.tsc_no=@PayrollNumber and coalesce(Loaned4,0) +coalesce(Lnrep4,0)<>0 
union

select customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned5,0) as Debit,coalesce(Lnrep5,0) as Credit,
 SUM(isnull(Loaned5,0)-isnull(Lnrep5,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged5,0) as interestdr,coalesce(Lnint5,0) as Interestcr,
SUM(isnull(intcharged5,0)-isnull(Lnint5,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'05'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no where legacy.dbo.customer.tsc_no=@PayrollNumber and coalesce(Loaned5,0) +coalesce(Lnrep5,0)<>0

union

select customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned6,0) as Debit,coalesce(Lnrep6,0) as Credit,
 SUM(isnull(Loaned6,0)-isnull(Lnrep6,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(intcharged6,0) as interestdr,coalesce(Lnint6,0) as Interestcr,
SUM(isnull(intcharged6,0)-isnull(Lnint6,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'06'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no where legacy.dbo.customer.tsc_no=@PayrollNumber and coalesce(Loaned6,0) +coalesce(Lnrep6,0)<>0 
union

select customer.name,Date,ltrim(ltrim(isnull(Minute_no,'')))+' '+ltrim(ltrim(isnull(Details,'')))+' '+ltrim(ltrim(isnull(Reference,''))),coalesce(Loaned7,0) as Debit,coalesce(Lnrep7,0) as Credit,
 SUM(isnull(Loaned7,0)-isnull(Lnrep7,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal ,
coalesce(acint7,0) as interestdr,coalesce(Lnint7,0) as Interestcr,
SUM(isnull(acint7,0)-isnull(Lnint7,0)) OVER(ORDER BY date 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS interestbalance,'07'
from legacy.dbo.checkhis inner join 
legacy.dbo.customer on legacy.dbo.checkhis.tsc_no=legacy.dbo.customer.tsc_no where legacy.dbo.customer.tsc_no=@PayrollNumber and coalesce(Loaned7,0) +coalesce(Lnrep7,0)<>0 

)
select * from CTEBosa  order by TrxType,date





GO
/****** Object:  StoredProcedure [dbo].[sp_BranchCommissionsSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--exec sp_BranchCommissionsSummary '1', '03/24/2015','06/29/2015'
CREATE PROCEDURE [dbo].[sp_BranchCommissionsSummary]
	-- Add the parameters for the stored procedure here
	@BranchCode varchar (50),
	@StartDate Date,
	@EndDate Date
AS
BEGIN
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        TOP (100) PERCENT dbo.swiftfin_Branches.Description, dbo.swiftfin_ChartOfAccounts.AccountName, SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount 
FROM            dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_Branches.Id = dbo.swiftfin_Journals.BranchId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
WHERE        (dbo.swiftfin_ChartOfAccounts.AccountType = '4000') and dbo.swiftfin_Branches.Code=@BranchCode and dbo.swiftfin_Journals.ValueDate between @StartDate and @EndDate
GROUP BY dbo.swiftfin_Branches.Description, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Branches.Code
ORDER BY dbo.swiftfin_Branches.Code

END






GO
/****** Object:  StoredProcedure [dbo].[sp_BranchExpenditureSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan>
-- Create date: <Create Date, 02/10/2015>
-- Description:	<Description,Income and Expenditure per branch>
-- =============================================
--Select * from swiftfin_ChartOfAccounts
--exec sp_BranchExpenditureSummary '1', '07/01/2016','08/01/2016'
CREATE PROCEDURE [dbo].[sp_BranchExpenditureSummary]
	-- Add the parameters for the stored procedure here
	@Branchid UniqueIdentifier,
	@StartDate Date,
	@EndDate Date
AS
BEGIN
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here 
	SELECT ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, 
	ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit,
	space(depth*4)+ ltrim(rtrim(AccountCode))+' '+ltrim([AccountName]) as Code, 
	CASE AccountType when 4000 Then 'Income' WHEN 5000 Then 'Expenses'  End As AccountTypeCode
	FROM            dbo.swiftfin_Branches INNER JOIN
                    dbo.swiftfin_Journals ON dbo.swiftfin_Branches.Id = dbo.swiftfin_Journals.BranchId INNER JOIN
                    dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                    dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
						
	WHERE    dbo.swiftfin_ChartOfAccounts.AccountType in (4000, 5000 ) and     dbo.swiftfin_Branches.Id=@Branchid and dbo.swiftfin_Journals.ValueDate between @StartDate and @EndDate
	GROUP BY dbo.swiftfin_Branches.Description, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Branches.Code, dbo.swiftfin_ChartOfAccounts.Depth, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ChartOfAccounts.AccountType
	ORDER BY dbo.swiftfin_ChartOfAccounts.AccountCode

END






GO
/****** Object:  StoredProcedure [dbo].[sp_BranchListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_BranchListing]
	-- Add the parameters for the stored procedure here
--	<@Param1, sysname, @p1> <Datatype_For_Param1, , int> = <Default_Value_For_Param1, , 0>, 
---	<@Param2, sysname, @p2> <Datatype_For_Param2, , int> = <Default_Value_For_Param2, , 0>
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

  /****** Script for SelectTopNRows command from SSMS  ******/
SELECT id,[Code]
      ,[Description]
  FROM [dbo].[swiftfin_Branches]
END











GO
/****** Object:  StoredProcedure [dbo].[sp_BudgetReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--[sp_BudgetReport] '08/30/2016' ,'B9464590-0EAA-CE89-D50F-08D3A645BFFD'
CREATE Procedure [dbo].[sp_BudgetReport] 
(
	@EndDate DateTime,
	@PostingPeriod varchar(MAX) ---,
---	@BranchID Varchar(Max)
)
as
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	Declare 	@LocalEndDate DateTime=@EndDate,
				@LocalPostingPeriod varchar(MAX)=@PostingPeriod,
				@LocalStartDate DateTime
---				@LocalBranchID varchar(Max)=@BranchID;
				set @LocalStartDate=(select top 1 Duration_StartDate from swiftfin_PostingPeriods where id=@LocalPostingPeriod);
WITH Budgetcte(AccountType,AccountCode,AccountName,TotalBudget,MonthlyBudget,BudgetTodate,AccountTypeCode,ActualAmount,Subdescription)
as
(
SELECT        TOP (100) PERCENT a.AccountType, a.AccountCode, a.AccountName, SUM(dbo.swiftfin_BudgetEntries.Amount) AS TotalBudget, 
                         SUM(dbo.swiftfin_BudgetEntries.Amount) / 12 AS MonthlyBudget, SUM(dbo.swiftfin_BudgetEntries.Amount) / 12 * MONTH(@LocalEndDate) AS BudgetTodate, 
                         CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN 5000 THEN 'Expenses' END AS AccountTypeCode,
						 isnull((SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
							FROM            dbo.swiftfin_Journals INNER JOIN
							 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId 
							 where dbo.swiftfin_JournalEntries.ChartOfAccountId=dbo.swiftfin_BudgetEntries.ChartOfAccountId
							---and dbo.swiftfin_Journals.PostingPeriodId=@LocalPostingPeriod ---- and dbo.swiftfin_Journals.BranchId=@LocalBranchID
							and  dbo.swiftfin_Journals.ValueDate<= @LocalEndDate							
						 ),0) as ActualAmount,
						 (select AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,4)=left(b.AccountCode,4) and costcenterid is not null) as Subdescription
						 
	
FROM            dbo.swiftfin_Budgets INNER JOIN
                         dbo.swiftfin_BudgetEntries ON dbo.swiftfin_Budgets.Id = dbo.swiftfin_BudgetEntries.BudgetId INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Budgets.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts a ON dbo.swiftfin_BudgetEntries.ChartOfAccountId =a.Id
WHERE        (dbo.swiftfin_PostingPeriods.Id = @LocalPostingPeriod)
GROUP BY a.AccountType,dbo.swiftfin_BudgetEntries.ChartOfAccountId, a.AccountCode, a.AccountName
)
select * into #temp1 from Budgetcte 

insert into #temp1 (AccountType,AccountCode,AccountName,TotalBudget,MonthlyBudget,BudgetTodate,AccountTypeCode,ActualAmount,subdescription)
select AccountType,AccountCode,AccountName,0 as TotalBudget,0 as MonthlyBudget,0 as BudgetTodate, 
CASE [AccountType] WHEN 1000000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN 5000 THEN 'Expenses' END AS AccountTypeCode,
							isnull((SELECT sum(dbo.swiftfin_JournalEntries.Amount)
							FROM            dbo.swiftfin_Journals INNER JOIN
							 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId 
							 where dbo.swiftfin_JournalEntries.ChartOfAccountId=a.Id
							----and dbo.swiftfin_Journals.PostingPeriodId=@LocalPostingPeriod --and dbo.swiftfin_Journals.BranchId=@LocalBranchID
							and  dbo.swiftfin_Journals.ValueDate <= @LocalEndDate							
						 ),0) as ActualAmount,
						 (select AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,4)=left(b.AccountCode,4) and costcenterid is not null) as Subdescription
						 
from swiftfin_ChartOfAccounts a where id not in (
SELECT        dbo.swiftfin_BudgetEntries.ChartOfAccountId
FROM            dbo.swiftfin_Budgets INNER JOIN
                         dbo.swiftfin_BudgetEntries ON dbo.swiftfin_Budgets.Id = dbo.swiftfin_BudgetEntries.BudgetId where PostingPeriodId=@LocalPostingPeriod
) and AccountType in (4000,5000)
select *,case when AccountType=4000 then isnull(BudgetTodate,0)-isnull(ActualAmount,0) when AccountType=5000 then isnull(BudgetTodate,0)+isnull(ActualAmount,0) end as Variance  into #temp2 from #temp1 

select * from #temp2 where TotalBudget+MonthlyBudget+BudgetTodate+ActualAmount<>0  order by AccountCode








GO
/****** Object:  StoredProcedure [dbo].[sp_BudgetReportBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_PostingPeriods
--select * from swiftfin_costcenters
--[sp_BudgetReportBranch] '12/31/2018' ,'6D1AC584-032D-E811-80D1-F40343552CF8','8B8B1B74-141C-CF68-05C2-08D19D7D7330','063021C4-F70D-CE7F-3166-08D1AC331921'
CREATE PROCEDURE [dbo].[sp_BudgetReportBranch] 
(
	@EndDate DateTime,
	@PostingPeriod varchar(MAX)
--	@BranchID Varchar(Max),
	--@CostCenterID varchar(Max)
)
as
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	Declare 	@LocalEndDate DateTime=@EndDate,
			 	@LocalStartDate DateTime='01/01/'+ltrim(rtrim(str(year(@EndDate)))),
				@LocalPostingPeriod varchar(MAX)=@PostingPeriod;
				--@LocalBranchID varchar(Max)=@BranchID;
WITH Budgetcte(AccountType,AccountCode,AccountName,TotalBudget,MonthlyBudget,BudgetTodate,AccountTypeCode,ActualAmount,Mode,BranchID,CostCenterID)
as
(
	SELECT        TOP (100) PERCENT dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, SUM(dbo.swiftfin_BudgetEntries.Amount) AS TotalBudget, 
                 
				   SUM(dbo.swiftfin_BudgetEntries.Amount) / 12 AS MonthlyBudget, SUM(dbo.swiftfin_BudgetEntries.Amount) / 12 * MONTH(@LocalEndDate) AS BudgetTodate, 
                 
				   CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN 5000 THEN 'Expenses' END AS AccountTypeCode,
					isnull((SELECT        sum(dbo.swiftfin_JournalEntries.Amount) FROM dbo.swiftfin_Journals INNER JOIN	 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId 
							 where dbo.swiftfin_JournalEntries.ChartOfAccountId=dbo.swiftfin_BudgetEntries.ChartOfAccountId
							 --and dbo.swiftfin_Journals.BranchId=@BranchID
							and  dbo.swiftfin_Journals.ValueDate  <= @LocalEndDate							
						 ),0) as ActualAmount,
  CASE [AccountType] WHEN 1000 THEN -1 WHEN 2000 THEN 1 WHEN 3000 THEN 1 WHEN 4000 THEN 1 WHEN 5000 THEN -1 END AS Mode,swiftfin_Budgets.BranchId, dbo.swiftfin_ChartOfAccounts.CostCenterId
	
FROM            dbo.swiftfin_Budgets INNER JOIN
                         dbo.swiftfin_BudgetEntries ON dbo.swiftfin_Budgets.Id = dbo.swiftfin_BudgetEntries.BudgetId INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Budgets.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_BudgetEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
WHERE        
dbo.swiftfin_PostingPeriods.Id = @LocalPostingPeriod
--and swiftfin_Budgets.BranchId=@LocalBranchID 
--and swiftfin_ChartOfAccounts.CostCenterId=@CostCenterID
GROUP BY dbo.swiftfin_ChartOfAccounts.AccountType,dbo.swiftfin_BudgetEntries.ChartOfAccountId, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName,
swiftfin_Budgets.BranchId,swiftfin_Budgets.BranchId, dbo.swiftfin_ChartOfAccounts.CostCenterId
)
select * into #temp1 from Budgetcte 

insert into #temp1 (AccountType,AccountCode,AccountName,TotalBudget,MonthlyBudget,BudgetTodate,AccountTypeCode,ActualAmount,Mode,BranchID,CostCenterID)
select AccountType,AccountCode,AccountName,0 as TotalBudget,0 as MonthlyBudget,0 as BudgetTodate, 
CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN 5000 THEN 'Expenses' END AS AccountTypeCode,
isnull((SELECT sum(dbo.swiftfin_JournalEntries.Amount)
 FROM    dbo.swiftfin_Journals INNER JOIN dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId 
where dbo.swiftfin_JournalEntries.ChartOfAccountId=dbo.swiftfin_ChartOfAccounts.Id	
--and dbo.swiftfin_Journals.BranchId=@LocalBranchID
and  dbo.swiftfin_Journals.ValueDate <= @LocalEndDate),0),
CASE [AccountType] WHEN 1000 THEN -1 WHEN 2000 THEN 1 WHEN 3000 THEN 1 WHEN 4000 THEN 1 WHEN 5000 THEN -1 END AS Mode,CostCenterId,
(select BranchId  from swiftfin_Budgets where swiftfin_Budgets.id in (select BudgetId from swiftfin_BudgetEntries where swiftfin_BudgetEntries.ChartOfAccountId=swiftfin_ChartOfAccounts.id)) as BranchID
 from swiftfin_ChartOfAccounts 
where id not in (
					SELECT  dbo.swiftfin_BudgetEntries.ChartOfAccountId
					FROM    dbo.swiftfin_Budgets INNER JOIN
					dbo.swiftfin_BudgetEntries ON dbo.swiftfin_Budgets.Id = dbo.swiftfin_BudgetEntries.BudgetId 
					where PostingPeriodId=@LocalPostingPeriod --and dbo.swiftfin_Budgets.BranchId=@BranchID
				) 
						and AccountType in (4000,5000) 
						--and CostCenterId=@CostCenterID
						



select AccountType,AccountCode,AccountName,TotalBudget,MonthlyBudget*mode as MonthlyBudget ,BudgetTodate*mode as BudgetTodate,AccountTypeCode,ActualAmount,Mode,
BranchID,CostCenterID,

case
WHEN AccountType=4000 then (BudgetTodate*mode)-ActualAmount
when AccountType=5000 then (BudgetTodate*mode)-(ActualAmount)
end as Variance,
case
WHEN AccountType=4000 then TotalBudget
end as IncomeBudget,
case
WHEN AccountType=5000 then TotalBudget
end as expenseBudget,

case
WHEN AccountType=4000 then MonthlyBudget*mode
end as monthlyincomeBudget,
case
WHEN AccountType=5000 then MonthlyBudget*mode
end as monthlyexpenseBudget,
case
WHEN AccountType=4000 then BudgetTodate*mode
end as incomeBudgetTodate,
case
WHEN AccountType=5000 then BudgetTodate*mode
end as expenseBudgetTodate

 into #temp2 from #temp1 
select *,sum(IncomeBudget-expenseBudget) as budgetsuplus,sum(monthlyexpenseBudget+monthlyincomeBudget) as monthlybudgetsurplus,
sum(incomeBudgetTodate+expenseBudgetTodate) as budgettodatesurplus
 into #temp3 from #temp2 group by AccountType,AccountCode,AccountName,TotalBudget, MonthlyBudget , BudgetTodate,AccountTypeCode,ActualAmount,Mode,
BranchID,CostCenterID,AccountType,variance,IncomeBudget,expenseBudgetTodate,monthlyexpenseBudget,monthlyincomeBudget,expenseBudget,incomeBudgetTodate


select * from #temp3 

where TotalBudget+MonthlyBudget+BudgetTodate+ActualAmount<>0  

group by AccountType,AccountCode,AccountName,TotalBudget, MonthlyBudget , BudgetTodate,AccountTypeCode,ActualAmount,Mode,
BranchID,CostCenterID,AccountType,Variance,IncomeBudget,expenseBudgetTodate,monthlyexpenseBudget,monthlyincomeBudget,expenseBudget,incomeBudgetTodate
,budgetsuplus,monthlybudgetsurplus,budgettodatesurplus
order by AccountCode




GO
/****** Object:  StoredProcedure [dbo].[sp_ByProductPostingSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 21.01.2015
-- Description:	ByProductPostingSummary
-- =============================================
CREATE PROCEDURE [dbo].[sp_ByProductPostingSummary] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime , 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	Create table #ByProduct (Description Char(50), PrincipalAmount Numeric(18,2), Interest Numeric(18,2),Category char(10));

	With CTEByProductPrincipalCheckoff (Description,PrincipalAmount,Interest)
	as
	(
		SELECT        Products_1.Description,  SUM(dbo.swiftfin_JournalEntries.Amount) AS PrincipalAmount,0
		FROM            dbo.Products(0) AS Products_1 INNER JOIN
								 dbo.swiftfin_JournalEntries ON Products_1.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
								 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
		WHERE        (Products_1.type NOT IN ('Savings')) AND (dbo.swiftfin_Journals.SecondaryDescription LIKE '%Check-off%') 
		AND  dbo.swiftfin_Journals.CreatedDate between 
		@StartDate and @EndDate and Amount >0
		GROUP BY Products_1.Description, Products_1.type
	),
	CTEByProductInterestCheckoff (Description,PrincipalAmount,Interest)
	as
	(
		SELECT        Products_1.Description,  0,SUM(dbo.swiftfin_JournalEntries.Amount) AS Interest
		FROM            dbo.Products(0) AS Products_1 INNER JOIN
								 dbo.swiftfin_JournalEntries ON Products_1.InterestReceivable = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
								 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
		WHERE        (Products_1.type NOT IN ('Savings')) AND (dbo.swiftfin_Journals.SecondaryDescription LIKE '%Check-off%') 
		AND dbo.swiftfin_Journals.CreatedDate between 
		@StartDate and @EndDate 
		GROUP BY Products_1.Description, Products_1.type
	),
	CTEByProductPrincipalPayout (Description,PrincipalAmount,Interest)
	as
	(
		SELECT        Products_1.Description,  SUM(dbo.swiftfin_JournalEntries.Amount) AS PrincipalAmount,0
		FROM            dbo.Products(0) AS Products_1 INNER JOIN
								 dbo.swiftfin_JournalEntries ON Products_1.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
								 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
		WHERE        (Products_1.type NOT IN ('Savings')) AND (dbo.swiftfin_Journals.SecondaryDescription LIKE '%Payout%') 
		AND  dbo.swiftfin_Journals.CreatedDate between 
		@StartDate and @EndDate and Amount>0
		GROUP BY Products_1.Description, Products_1.type
	),
	CTEByProductInterestpayout (Description,PrincipalAmount,Interest)
	as
	(
		SELECT        Products_1.Description,  0,SUM(dbo.swiftfin_JournalEntries.Amount) AS Interest
		FROM            dbo.Products(0) AS Products_1 INNER JOIN
								 dbo.swiftfin_JournalEntries ON Products_1.InterestReceivable = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
								 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
		WHERE        (Products_1.type  not IN ('Savings'))  AND (dbo.swiftfin_Journals.SecondaryDescription LIKE '%Payout%') 
		AND dbo.swiftfin_Journals.CreatedDate between 
		@StartDate and @EndDate
		GROUP BY Products_1.Description, Products_1.type
	)

	insert #ByProduct (Description,PrincipalAmount,Interest,Category) 
	select Description,PrincipalAmount,Interest,'Checkoff'  from CTEByProductInterestCheckoff
	union
	select Description,PrincipalAmount,Interest,'Checkoff'  from CTEByProductPrincipalCheckoff
	union
	select Description,PrincipalAmount,Interest,'Payout'  from CTEByProductPrincipalPayout
	union
	select Description,PrincipalAmount,Interest,'Payout'  from CTEByProductInterestPayout

	select Description, sum(PrincipalAmount) as PrincipalAmount, sum(Interest) as Interest,Category 
	from  #ByProduct group by Description,Category


END






GO
/****** Object:  StoredProcedure [dbo].[sp_ByProductPostingSummaryByEmployer]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_ByProductPostingSummaryByEmployer] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime , 
	@EndDate DateTime,
	@EmployerID varchar(50) 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	Create table #ByProduct (Description Char(50), PrincipalAmount Numeric(18,2), Interest Numeric(18,2),Category char(10));

	With CTEByProductPrincipalCheckoff (Description,PrincipalAmount,Interest)
	as
	(
		SELECT        Products_1.Description,  SUM(dbo.swiftfin_JournalEntries.Amount) AS PrincipalAmount,0
		FROM            dbo.Products(0) AS Products_1 INNER JOIN
                         dbo.swiftfin_JournalEntries ON Products_1.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id
		WHERE        (Products_1.type NOT IN ('Savings')) AND (dbo.swiftfin_Journals.SecondaryDescription LIKE '%Check-off%') 
		AND  dbo.swiftfin_Journals.CreatedDate between 
		@StartDate and @EndDate and Amount >0 and dbo.swiftfin_Employers.Id=@EmployerID
		GROUP BY Products_1.Description, Products_1.type
	),
	CTEByProductInterestCheckoff (Description,PrincipalAmount,Interest)
	as
	(
		SELECT        Products_1.Description,  0,SUM(dbo.swiftfin_JournalEntries.Amount) AS Interest
		FROM             dbo.Products(0) AS Products_1 INNER JOIN
                         dbo.swiftfin_JournalEntries ON Products_1.InterestReceivable = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id
		WHERE        (Products_1.type NOT IN ('Savings')) AND (dbo.swiftfin_Journals.SecondaryDescription LIKE '%Check-off%') 
		AND dbo.swiftfin_Journals.CreatedDate between 
		@StartDate and @EndDate and dbo.swiftfin_Employers.Id=@EmployerID
		GROUP BY Products_1.Description, Products_1.type
	),
	CTEByProductPrincipalPayout (Description,PrincipalAmount,Interest)
	as
	(
	SELECT        Products_1.Description, SUM(dbo.swiftfin_JournalEntries.Amount) AS PrincipalAmount, 0 AS Expr1
FROM            dbo.Products(0) AS Products_1 INNER JOIN
                         dbo.swiftfin_JournalEntries ON Products_1.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id
WHERE        (Products_1.type NOT IN ('Savings')) AND (dbo.swiftfin_Journals.SecondaryDescription LIKE '%Payout%') AND (dbo.swiftfin_Journals.CreatedDate BETWEEN 
                         @StartDate AND @EndDate) AND (dbo.swiftfin_JournalEntries.Amount > 0) and dbo.swiftfin_Employers.Id=@EmployerID
GROUP BY Products_1.Description, Products_1.type
	),
	CTEByProductInterestpayout (Description,PrincipalAmount,Interest)
	as
	(
		SELECT        Products_1.Description,  0,SUM(dbo.swiftfin_JournalEntries.Amount) AS Interest
		FROM             dbo.Products(0) AS Products_1 INNER JOIN
                         dbo.swiftfin_JournalEntries ON Products_1.InterestReceivable = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id
		WHERE        (Products_1.type  not IN ('Savings'))  AND (dbo.swiftfin_Journals.SecondaryDescription LIKE '%Payout%') 
		AND dbo.swiftfin_Journals.CreatedDate between 
		@StartDate and @EndDate and dbo.swiftfin_Employers.Id=@EmployerID
		GROUP BY Products_1.Description, Products_1.type
	)

	insert #ByProduct (Description,PrincipalAmount,Interest,Category) 
	select Description,PrincipalAmount,Interest,'Checkoff'  from CTEByProductInterestCheckoff
	union
	select Description,PrincipalAmount,Interest,'Checkoff'  from CTEByProductPrincipalCheckoff
	union
	select Description,PrincipalAmount,Interest,'Payout'  from CTEByProductPrincipalPayout
	union
	select Description,PrincipalAmount,Interest,'Payout'  from CTEByProductInterestPayout

	select Description, sum(PrincipalAmount) as PrincipalAmount, sum(Interest) as Interest,Category 
	from  #ByProduct group by Description,Category


END






GO
/****** Object:  StoredProcedure [dbo].[sp_Calender]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---dbo.Calender 02,2004
CREATE PROCEDURE [dbo].[sp_Calender]
(
 @month tinyint,
 @year int
)
as
Begin

---------- Declare Valiables

Declare @date1 date, @enddate date, @day1 varchar(10), @weekid tinyint, @currdate date

Select @currdate= convert(date,(CAST(@year as char(4))+'-'+CAST(@month as varchar(2))+'-15'))

Select @date1=convert(date,dbo.[f_FirstDayOfMonth](@currdate)), @enddate=convert(date,dbo.[f_LastdayOfMonth](@currdate))

Select @day1= DATENAME(WEEKDAY, @date1)

---------- Recursive CTE to get Days and Dates for the month

;with cte_cal ([Date], [Day], [weekid])
as
(
 Select @date1, @day1, case when DATEPART(WEEKDAY,@date1)=1 then cast(DATEPART(WW,@date1)  as tinyint)-1
                            else DATEPART(WW,@date1) end as weekid
 union all
 Select DATEADD(DD,1,[Date]), cast(DATENAME(WEEKDAY, DATEADD(DD,1,[Date])) as varchar(10)),  
                              case when DATEPART(WEEKDAY,DATEADD(DD,1,[Date]))=1 then 
                              cast(DATEPART(WW,DATEADD(DD,1,[Date]))  as tinyint)-1
                              else DATEPART(WW,DATEADD(DD,1,[Date])) end as weekid
 from cte_cal
 where [Date] < @enddate 
)

------- Use Pivot to display the result in calender format

Select  [weekid], [Monday], [Tuesday], [Wednesday], [Thursday], [Friday], [Saturday], [Sunday] 
from
(
 Select [Weekid], [Date], [DAY] from cte_cal
)
pvt
Pivot
(
 max([Date]) for [Day] in ([Monday], [Tuesday], [Wednesday], [Thursday], [Friday], [Saturday], [Sunday] )
)
Pvttab

End 











GO
/****** Object:  StoredProcedure [dbo].[sp_CashJournal]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
	---sp_CashJournal '12/08/2014','12/08/2014'
	--select count()
	CREATE Procedure [dbo].[sp_CashJournal] (@StartDate DateTime, @EndDate DateTime)as
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	With CashJournal(ItemDescription,AccountName,ItemCode,ParentItemCode,Debit,Credit,PrimaryDescription)
	as
	(select 'Previous Balance','Cash in Hand','00000','00000',CASE  WHEN    sum(amount)<0 then SUM(Amount)*-1  else 0 end as Debit,CASE  WHEN    sum(amount)>0 then SUM(Amount)  else 0 end as Credit,'CASH IN HAND' from swiftfin_JournalEntries where ChartOfAccountId in (select ChartOfAccountId from swiftfin_Treasuries) and CreatedDate<@StartDate
	union 
	SELECT        TOP (100) PERCENT dbo.swiftfin_ModuleNavigationItems.ItemDescription, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ModuleNavigationItems.ItemCode, 
							 dbo.swiftfin_ModuleNavigationItems.ParentItemCode,
						 CASE  WHEN SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)  else 0 end as Debit,
							 CASE  WHEN SUM(dbo.swiftfin_JournalEntries.Amount)<0 then SUM(dbo.swiftfin_JournalEntries.Amount)*-1  else 0 end as Credit,
							  LEFT(dbo.swiftfin_Journals.PrimaryDescription, 17) 
							 AS PrimaryDescription
	FROM            dbo.swiftfin_ModuleNavigationItems INNER JOIN
							 dbo.swiftfin_Journals ON dbo.swiftfin_ModuleNavigationItems.ItemCode = dbo.swiftfin_Journals.ModuleNavigationItemCode INNER JOIN
							 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
							 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
							 dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId
	WHERE        (dbo.swiftfin_ModuleNavigationItems.ItemCode IN ('61657', '61754', '61757', '61758', '61759', '61760', '61755', '61756', '61655')) AND 
							 (dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate) 
	GROUP BY dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ModuleNavigationItems.ItemCode, dbo.swiftfin_ModuleNavigationItems.ParentItemCode, 
							 dbo.swiftfin_ModuleNavigationItems.ItemDescription, LEFT(dbo.swiftfin_Journals.PrimaryDescription, 17)
	)

	select ROW_NUMBER() OVER(ORDER BY ItemCode) AS Row,* into #temp1 from  CashJournal where accountname not in ('Uncleared Cheques Control') and PrimaryDescription not like '%cheque%'
	and accountname not in ('Treasury Kabianga','Treasury Kapsoit','Treasury Kericho') order by ItemCode

	select *,SUM(debit-credit) OVER(ORDER BY Row 
							ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal from  #temp1  order by ItemCode





GO
/****** Object:  StoredProcedure [dbo].[sp_CashWithdrawalAuthorization]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 20.06.2014
-- Description:	CashWithdrawalAuthorizations
-- =============================================
---sp_CashWithdrawalAuthorization '06/19/2014','06/20/2014'
CREATE PROCEDURE [dbo].[sp_CashWithdrawalAuthorization] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime, 
	@EndDate DateTime  
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
	SELECT        TOP (100) PERCENT  dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, 
							 dbo.swiftfin_CashWithdrawalRequests.Amount, 
							 CASE  dbo.swiftfin_CashWithdrawalRequests.Status
							 WHEN 1 THEN 'Pending'
							 WHEN 2 THEN 'Authorized'
							 WHEN 4 THEN 'Rejected'
							 WHEN 8 THEN 'Paid'
							 END as Status, dbo.swiftfin_CashWithdrawalRequests.AuthorizedBy, 
							 dbo.swiftfin_CashWithdrawalRequests.AuthorizationRemarks, dbo.swiftfin_CashWithdrawalRequests.AuthorizedDate, dbo.swiftfin_CashWithdrawalRequests.PaidBy, 
							 dbo.swiftfin_CashWithdrawalRequests.PaidDate, dbo.swiftfin_CashWithdrawalRequests.CreatedBy, dbo.swiftfin_CashWithdrawalRequests.CreatedDate, 
							 dbo.swiftfin_CashWithdrawalRequests.Remarks, dbo.swiftfin_CashWithdrawalRequests.MaturityDate, dbo.vw_CustomerAccounts.Reference1
	FROM            dbo.swiftfin_CashWithdrawalRequests INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_CashWithdrawalRequests.CustomerAccountId = dbo.vw_CustomerAccounts.Id
	WHERE swiftfin_CashWithdrawalRequests.CreatedDate BETWEEN @StartDate and @EndDate
	ORDER BY dbo.swiftfin_CashWithdrawalRequests.CreatedDate
END







GO
/****** Object:  StoredProcedure [dbo].[sp_ChartOfAccountsListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
--select * from swiftfin_costcenters
---select * from swiftfin_chartofaccounts
-- =============================================
CREATE PROCEDURE [dbo].[sp_ChartOfAccountsListing]
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	/****** Script for SelectTopNRows command from SSMS  ******/
SELECT 	[AccountType],
			[AccountTypeCode] =
			CASE [AccountType]
				WHEN 1000 THEN 'Assets'
				WHEN 2000THEN 'Liabilities'
				WHEN 3000 THEN 'Equity'
				WHEN 4000 THEN 'Income'
				WHEN 5000 THEN 'Expenses'
			END,
			space(depth*4)+ ltrim(rtrim(AccountCode))+' '+ltrim([AccountName]) as Code
		  , [AccountCode] 
		  ,space(depth*4)+ [AccountName] as [AccountName]
		  ,[Depth], dbo.swiftfin_CostCenters.Description as CostCenter,
		   (select top 1 AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,5)=left(b.AccountCode,5) and costcenterid is not null) as subdescription
	  FROM [dbo].[swiftfin_ChartOfAccounts] a inner join 
	       dbo.swiftfin_CostCenters on a.CostCenterId=dbo.swiftfin_CostCenters.id
		   where accountcategory=4097
	       order by AccountCode
END












GO
/****** Object:  StoredProcedure [dbo].[sp_ChartOfAccountsListingSorted]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_ChartOfAccountsListingSorted]
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	/****** Script for SelectTopNRows command from SSMS  ******/
SELECT 	id,	space(depth*4)+ ltrim(rtrim(AccountCode))+' '+ltrim([AccountName]) as Code
	  FROM [dbo].[swiftfin_ChartOfAccounts] order by AccountType,AccountCode
END












GO
/****** Object:  StoredProcedure [dbo].[sp_ChartOfAccountsListingSortedSearch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

--[sp_ChartOfAccountsListingSortedSearch] 'ord'
CREATE PROCEDURE [dbo].[sp_ChartOfAccountsListingSortedSearch]
(@Search VarChar(100))
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	/****** Script for SelectTopNRows command from SSMS  ******/
	set @Search=upper(@Search)
SELECT 	id,	space(depth*4)+ ltrim(rtrim(AccountCode))+' '+ltrim([AccountName]) as Code
	  FROM swiftfin_ChartOfAccounts 
	  	  WHERE (upper(AccountName) like '%'+@Search+'%')
	  order by AccountType,AccountCode



END












GO
/****** Object:  StoredProcedure [dbo].[sp_CheckCustomerAccountLastWithdrawalDate]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 11.12.2014
-- Description:	CheckLastWithdrawalDate
-- =============================================
CREATE PROCEDURE [dbo].[sp_CheckCustomerAccountLastWithdrawalDate] 
	-- Add the parameters for the stored procedure here
	@CustomerAccountID uniqueidentifier 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT    top 1     dbo.swiftfin_Journals.CreatedDate
	FROM            dbo.swiftfin_Journals INNER JOIN
							 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId
	WHERE        dbo.swiftfin_Journals.TransactionCode =1
				 AND CustomerAccountId=@CustomerAccountID
	order by CreatedDate desc
END






GO
/****** Object:  StoredProcedure [dbo].[sp_CheckOffPerEmployer]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROC [dbo].[sp_CheckOffPerEmployer]
@Employer varchar(50),
@Month Int,
@BatchType varchar(10)
AS


SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Description, dbo.swiftfin_CreditBatchEntries.Principal, dbo.swiftfin_CreditBatchEntries.Interest, 
                         dbo.swiftfin_CreditBatchEntries.Beneficiary, dbo.swiftfin_CreditBatchEntries.Reference, dbo.swiftfin_CreditBatches.BatchNumber, dbo.swiftfin_CreditBatches.Month, dbo.swiftfin_CreditTypes.Description AS Expr1, 
                         dbo.vw_CustomerAccounts.Address_AddressLine2
FROM            dbo.swiftfin_CreditBatchEntries INNER JOIN
                         dbo.swiftfin_CreditBatches ON dbo.swiftfin_CreditBatchEntries.CreditBatchId = dbo.swiftfin_CreditBatches.Id INNER JOIN
                         dbo.swiftfin_CreditTypes ON dbo.swiftfin_CreditBatches.CreditTypeId = dbo.swiftfin_CreditTypes.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_CreditBatchEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
						 where dbo.vw_CustomerAccounts.EmployerID=@Employer and dbo.swiftfin_CreditBatches.Month=@Month and 
						 dbo.swiftfin_CreditBatches.Type=@BatchType


						

GO
/****** Object:  StoredProcedure [dbo].[sp_ChequeBooksByDate]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_ChequeBooksByDate] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
	--select * from swiftfin_PaymentVouchers
--select * from swiftfin_ChequeBooks
---select * from swiftfin_enumerations
--select * from swiftfin_CustomerAccounts where id in(select customeraccountid from swiftfin_ChequeBooks)

SELECT distinct case  swiftfin_ChequeBooks.IsActive   when 1 then 'In-Process' when 0 then 'Received' End as StatusType, swiftfin_ChequeBooks.NumberOfVouchers, swiftfin_ChequeBooks.InitialVoucherNumber, swiftfin_Customers.Individual_FirstName + '   '+swiftfin_Customers.Individual_LastName as FullName, swiftfin_Customers.Reference1
FROM            swiftfin_PaymentVouchers INNER JOIN
                         swiftfin_ChequeBooks ON swiftfin_PaymentVouchers.ChequeBookId = swiftfin_ChequeBooks.Id INNER JOIN
                         swiftfin_Customers  INNER JOIN
                         swiftfin_CustomerAccounts ON swiftfin_Customers.Id = swiftfin_CustomerAccounts.CustomerId ON swiftfin_ChequeBooks.CustomerAccountId = swiftfin_CustomerAccounts.Id

	where swiftfin_CustomerAccounts.id in(select customeraccountid from swiftfin_ChequeBooks) and swiftfin_ChequeBooks.CreatedDate   Between @StartDate and @EndDate

	--select * from swiftfin_paymentvouchers

END

GO
/****** Object:  StoredProcedure [dbo].[sp_ChequesReceived]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



---sp_ChequesReceived '01/20/2017'
CREATE procedure [dbo].[sp_ChequesReceived] 
(@StartDate DateTime,
@EndDate DateTime)
as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_ExternalCheques.Number, dbo.swiftfin_ExternalCheques.Amount, dbo.swiftfin_ExternalCheques.Drawer, dbo.swiftfin_ExternalCheques.DrawerBank, 
                         dbo.swiftfin_ExternalCheques.DrawerBankBranch, dbo.swiftfin_ExternalCheques.WriteDate, dbo.swiftfin_ChequeTypes.Description as ChequeType, 
                         dbo.swiftfin_ExternalCheques.MaturityDate, dbo.swiftfin_ExternalCheques.Remarks, dbo.swiftfin_ExternalCheques.IsCleared, dbo.swiftfin_ExternalCheques.ClearedBy, 
                         dbo.swiftfin_ExternalCheques.ClearedDate, dbo.swiftfin_ExternalCheques.IsBanked, dbo.swiftfin_ExternalCheques.BankedBy, dbo.swiftfin_ExternalCheques.BankedDate, 
                         dbo.swiftfin_ExternalCheques.IsTransferred, dbo.swiftfin_ExternalCheques.TransferredBy, dbo.swiftfin_ExternalCheques.TransferredDate, 
                         dbo.swiftfin_ExternalCheques.CreatedBy, dbo.swiftfin_ExternalCheques.CreatedDate, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.AccountName, 
                         dbo.vw_CustomerAccounts.Reference1, dbo.swiftfin_ExternalCheques.Id
FROM            dbo.swiftfin_ExternalCheques INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_ExternalCheques.CustomerAccountId = dbo.vw_CustomerAccounts.Id
						 INNER JOIN 
						dbo.swiftfin_ChequeTypes On dbo.swiftfin_ChequeTypes.id = dbo.swiftfin_ExternalCheques.ChequeTypeId
WHERE       dbo.swiftfin_ExternalCheques.CreatedDate BETWEEN @StartDate and @EndDate








GO
/****** Object:  StoredProcedure [dbo].[sp_CICLoansDisbursed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan>
-- Create date: <Create Date, 05/29/2015>
-- Description:	<Description, Loans Disburded Report Machakos>
-- =============================================
--exec sp_CICLoansDisbursed '04/28/2015','04/28/2015','Machakos'
create PROCEDURE [dbo].[sp_CICLoansDisbursed] 
	@StartDate datetime,
	@EndDate datetime,
	@BranchCode varchar(50)
	
AS
BEGIN
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        SUM(dbo.swiftfin_LoanCases.DisbursedAmount) AS DisbursedAmount, dbo.swiftfin_Customers.Individual_FirstName + '' + dbo.swiftfin_Customers.Individual_LastName As Name, dbo.swiftfin_Customers.Reference1, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers, dbo.swiftfin_LoanCases.CaseNumber, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate AS [Date Applied], 
                         dbo.swiftfin_LoanCases.DisbursedDate, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_Branches.Code, 
                         dbo.swiftfin_LoanProducts.Code AS [Loan Code]
	FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id
	WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount <> 0) and dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate and @BranchCode=dbo.swiftfin_Branches.Description 
	GROUP BY dbo.swiftfin_LoanProducts.Code, dbo.swiftfin_Branches.Code, dbo.swiftfin_Branches.Description, dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanProducts.Description, 
                         dbo.swiftfin_LoanCases.DisbursedDate, dbo.swiftfin_LoanCases.ReceivedDate, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.CaseNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers, 
                         dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Individual_FirstName
END






GO
/****** Object:  StoredProcedure [dbo].[sp_ClassificationByAge]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---sp_ClassificationByAge '12/31/2016'

create procedure [dbo].[sp_ClassificationByAge] (@EndDate DateTime)
as
with cte (Code,AgeBracket,NoofAccounts,[Share Capital],[Share Deposits],[Loans],[Savings],[Male],[Female])
as
(
/*Unclassified*/
select 1, 'Unclassifeld',
(select count(*) from swiftfin_Customers b where Individual_BirthDate is null) as NoofAccounts,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id  where swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=1  and Individual_BirthDate is null),0) as ShareCapital,

isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id   where swiftfin_InvestmentProducts.code=2 and swiftfin_JournalEntries.CreatedDate<=@EndDate and Individual_BirthDate is null),0) as ShareDeposits,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and Individual_BirthDate is null),0)*-1 as Loans,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and Individual_BirthDate is null),0) as Savings,

(select count(*) from swiftfin_Customers b where Individual_Gender=1 and Individual_BirthDate is null) as Male,
(select count(*) from swiftfin_Customers b where Individual_Gender=2 and Individual_BirthDate is null) as Female

/*between 0 and 17*/
union
select 2, '0 to 17',
(select count(*) from swiftfin_Customers b where datediff(yy,Individual_BirthDate,@EndDate) between 0 and 17) as NoofAccounts,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=1 and datediff(yy,Individual_BirthDate,@EndDate) between 0 and 17),0) as ShareCapital,

isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=2 and datediff(yy,Individual_BirthDate,@EndDate) between 0 and 17),0) as ShareDeposits,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between 0 and 17),0)*-1 as Loans,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and  datediff(yy,Individual_BirthDate,@EndDate) between 0 and 17 ),0) as Savings

,(select count(*) from swiftfin_Customers b where Individual_Gender=1 and datediff(yy,Individual_BirthDate,@EndDate) between 0 and 17) as Male,
(select count(*) from swiftfin_Customers b where Individual_Gender=2 and datediff(yy,Individual_BirthDate,@EndDate) between 0 and 17) as Female

union

/*between 18 and 35*/
select 3, '18 to 35',
(select count(*) from swiftfin_Customers b where datediff(yy,Individual_BirthDate,@EndDate) between 18 and 35) as NoofAccounts,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=1 and datediff(yy,Individual_BirthDate,@EndDate) between 18 and 35),0) as ShareCapital,

isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=2 and datediff(yy,Individual_BirthDate,@EndDate) between 18 and 35),0) as ShareDeposits,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between 18 and 35),0)*-1 as Loans,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between 18 and 35 ),0) as Savings
,(select count(*) from swiftfin_Customers b where Individual_Gender=1 and datediff(yy,Individual_BirthDate,@EndDate) between 18 and 35) as Male,
(select count(*) from swiftfin_Customers b where Individual_Gender=2 and datediff(yy,Individual_BirthDate,@EndDate) between 18 and 35) as Female

union 
/*between 36 and 45*/
select 4, '36 to 45',
(select count(*) from swiftfin_Customers b where datediff(yy,Individual_BirthDate,@EndDate) between 36 and 45) as NoofAccounts,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=1 and datediff(yy,Individual_BirthDate,@EndDate) between 36 and 45),0) as ShareCapital,

isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=2 and datediff(yy,Individual_BirthDate,@EndDate) between 36 and 45 ),0) as ShareDeposits,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between 36 and 45 ),0)*-1 as Loans,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between 36 and 45 ),0) as Savings
,(select count(*) from swiftfin_Customers b where Individual_Gender=1 and datediff(yy,Individual_BirthDate,@EndDate) between 36 and 45) as Male,
(select count(*) from swiftfin_Customers b where Individual_Gender=2 and datediff(yy,Individual_BirthDate,@EndDate) between 36 and 45) as Female


union 
/*between  46 and 555*/
select 5, '46 to 55',
(select count(*) from swiftfin_Customers b where datediff(yy,Individual_BirthDate,@EndDate) between  46 and 55) as NoofAccounts,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=1 and datediff(yy,Individual_BirthDate,@EndDate) between  46 and 55),0) as ShareCapital,

isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=2 and datediff(yy,Individual_BirthDate,@EndDate) between  46 and 55 ),0) as ShareDeposits,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between  46 and 55 ),0)*-1 as Loans,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between 46 and 55),0) as Savings
,(select count(*) from swiftfin_Customers b where Individual_Gender=1 and datediff(yy,Individual_BirthDate,@EndDate) between 46 and 55) as Male,
(select count(*) from swiftfin_Customers b where Individual_Gender=2 and datediff(yy,Individual_BirthDate,@EndDate) between 46 and 55) as Female


union 
/*between  46 and 555*/
select 6, '56 to 60',
(select count(*) from swiftfin_Customers b where datediff(yy,Individual_BirthDate,@EndDate) between  56 and 60) as NoofAccounts,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=1 and datediff(yy,Individual_BirthDate,@EndDate) between  56 and 60),0) as ShareCapital,

isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=2 and datediff(yy,Individual_BirthDate,@EndDate) between  56 and 60 ),0) as ShareDeposits,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between 56 and 60),0)*-1 as Loans,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) between 56 and 60),0) as Savings
,(select count(*) from swiftfin_Customers b where Individual_Gender=1 and datediff(yy,Individual_BirthDate,@EndDate) between 56 and 60) as Male,
(select count(*) from swiftfin_Customers b where Individual_Gender=2 and datediff(yy,Individual_BirthDate,@EndDate) between 56 and 60) as Female


union
/*between  46 and 555*/
select 7, 'Over 60',
(select count(*) from swiftfin_Customers b where datediff(yy,Individual_BirthDate,@EndDate)>60) as NoofAccounts,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where  swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=1 and datediff(yy,Individual_BirthDate,@EndDate) >60),0) as ShareCapital,

isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id    where swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_InvestmentProducts.code=2 and datediff(yy,Individual_BirthDate,@EndDate)>60 ),0) as ShareDeposits,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) > 60),0)*-1 as Loans,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id where  swiftfin_JournalEntries.CreatedDate<=@EndDate and datediff(yy,Individual_BirthDate,@EndDate) > 60),0) as Savings

,(select count(*) from swiftfin_Customers b where Individual_Gender=1 and datediff(yy,Individual_BirthDate,@EndDate) >60) as Male,
(select count(*) from swiftfin_Customers b where Individual_Gender=2 and datediff(yy,Individual_BirthDate,@EndDate) >60) as Female


)
select * from cte order by code


GO
/****** Object:  StoredProcedure [dbo].[sp_ClosedAccounts]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--sp_ClosedAccounts '1792','09/03/2015'
CREATE PROCEDURE [dbo].[sp_ClosedAccounts]
	@pCategory Int,
	@pSettledDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT         dbo.swiftfin_Customers.Individual_FirstName + '' +  dbo.swiftfin_Customers.Individual_LastName As FullName, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers, 
                   dbo.swiftfin_Customers.Reference1, dbo.swiftfin_MembershipWithdrawalNotifications.SettledDate, 
				   CASE dbo.swiftfin_MembershipWithdrawalNotifications.Category WHEN '1792' THEN 'DECEASED' WHEN '1793' Then 'OTHER' End As Category
	FROM           dbo.swiftfin_MembershipWithdrawalNotifications INNER JOIN
                   dbo.swiftfin_Customers ON dbo.swiftfin_MembershipWithdrawalNotifications.CustomerId = dbo.swiftfin_Customers.Id
				   Where dbo.swiftfin_MembershipWithdrawalNotifications.Category=@pCategory and dbo.swiftfin_MembershipWithdrawalNotifications.SettledDate <= @pSettledDate
END






GO
/****** Object:  StoredProcedure [dbo].[sp_ConsolidatedBalanceSheet]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 14.06.2014
-- Description:	ConsolidatedTrialBalance
-- =============================================
--- [sp_ConsolidatedBalanceSheet] '02/01/2015','2F015C30-7201-C686-7872-08D1AD41F57B'
---select * from swiftfin_postingperiod
--select sum(amount) from swiftfin_JournalEntries
---select * from swiftfin_PostingPeriods
CREATE PROCEDURE [dbo].[sp_ConsolidatedBalanceSheet] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

with BalanceSheet (AccountTypeCode,SortOrder,AccountCode,AccountName,Credit,Debit,AccountType,subdescription)
as(
SELECT        CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN 5000
                          THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000 THEN 'C' WHEN 2000 THEN 'D' WHEN 3000 THEN 'E' WHEN 4000 THEN 'A' WHEN 5000 THEN 'B' END AS SortOrder,
                          a.AccountCode, a.AccountName, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit, a.AccountType,
						 (select top 1 AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,4)=left(b.AccountCode,4) and costcenterid is not null) as subdescription
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts a ON dbo.swiftfin_JournalEntries.ChartOfAccountId = a.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
WHERE        (dbo.swiftfin_JournalEntries.ValueDate <= @EndDate) AND (a.AccountType IN (1000, 2000, 3000))
GROUP BY a.AccountCode, a.AccountName, a.AccountType
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
union
SELECT        'Liabilities' AS AccountTypeCode, 'E' AS SortOrder, '9999999' AS Expr1, 'Surplus/Loss' AS Expr2, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit, 2000 AS Expr3,'Surplus/Loss'
						 
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts a ON dbo.swiftfin_JournalEntries.ChartOfAccountId =a.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
WHERE        (dbo.swiftfin_Journals.valuedate <= @EndDate) AND (a.AccountType IN (4000, 5000))
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
)
select * from BalanceSheet order by [AccountType],SortOrder

END





GO
/****** Object:  StoredProcedure [dbo].[sp_ConsolidatedTrialBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 14.06.2014
-- Description:	ConsolidatedTrialBalance
-- =============================================

---[sp_ConsolidatedTrialBalance] '8/29/2016'
CREATE PROCEDURE [dbo].[sp_ConsolidatedTrialBalance] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    --Insert statements for procedure here
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT         
                          CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN
                          5000 THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000 THEN 'C' WHEN 2000 THEN 'D' WHEN 3000 THEN 'E' WHEN 4000 THEN 'A' WHEN 5000 THEN 'B' END AS SortOrder,
						 CASE left([AccountType],1) WHEN 1 THEN 1 WHEN 2 THEN 4 WHEN 3 THEN 5 WHEN 4 THEN 3 WHEN 5 THEN 2 END AS Type,
                         a.AccountCode, a.AccountName, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit, a.AccountType,
						 (select top 1 AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,5)=left(b.AccountCode,5) and costcenterid is not null) as subdescription
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts a ON dbo.swiftfin_JournalEntries.ChartOfAccountId = a.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
WHERE        (dbo.swiftfin_Journals.ValueDate <= @EndDate)
GROUP BY a.AccountCode, a.AccountName, a.AccountType
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
ORDER BY type,a.AccountCode
END




GO
/****** Object:  StoredProcedure [dbo].[sp_ConverteeReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---select * from swiftfin_InvestmentProducts
--sp_ConverteeReport '76ACE21D-C656-C0F1-67C6-08D1AD47AEEF','10/30/2014'
CREATE PROCEDURE [dbo].[sp_ConverteeReport] 
	-- Add the parameters for the stored procedure here
	@ProductID varchar(100), 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	Declare @StartDate DateTime
	set @StartDate=(SELECT DATEADD(month, DATEDIFF(month, 0, @EndDate), 0))
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With InvestmentProductBalances(id,Reference1,Reference2,Reference3,AccountName,Balance)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.id,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in (@ProductID) and dbo.swiftfin_JournalEntries.CreatedDate<=@StartDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.Id
	)
	SELECT id,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,
	isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=InvestmentProductBalances.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_InvestmentProducts where id=@ProductID) and CreatedDate between @StartDate and @EndDate),0) as Increament,
	SUM(Balance) +isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=InvestmentProductBalances.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_InvestmentProducts where id=@ProductID) and CreatedDate between @StartDate and @EndDate),0) as NewBalance
		
	FROM InvestmentProductBalances  where
	isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=InvestmentProductBalances.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_InvestmentProducts where id=@ProductID) and CreatedDate between @StartDate and @EndDate),0) <>0 
	Group By id,Reference1,Reference2,Reference3,AccountName having SUM(Balance) =0 
END







GO
/****** Object:  StoredProcedure [dbo].[sp_Correctstandingdorderstriggers]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[sp_Correctstandingdorderstriggers]

as
create table #std(account char(15),[Description] char(40),loancode char(1),ordertype char(1))
begin
with stdorders(Account,Decription,Loancode,Ordertype)
as(
SELECT        dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanProducts.[Description], dbo.swiftfin_LoanProducts.Code, dbo.swiftfin_StandingOrders.[Trigger]
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_StandingOrders ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId
						 where  dbo.swiftfin_LoanProducts.Code='4'
						 )

						  insert into #std (Account,[Description],Loancode,Ordertype)
						 select Account,Decription,Loancode,Ordertype
						 from stdorders
						 --delete from #std
						update  #std
						set ordertype='2'

						
						
						 				
											 
end
 
 

 select * from  #std
					





GO
/****** Object:  StoredProcedure [dbo].[sp_CreditBatch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

CREATE PROCEDURE [dbo].[sp_CreditBatch] 
	-- Add the parameters for the stored procedure here
	@BatchID uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, 
                         dbo.swiftfin_CreditBatchEntries.Principal, dbo.swiftfin_CreditBatchEntries.Interest, dbo.vw_CustomerAccounts.Reference1,
						dbo.vw_CustomerAccounts.Reference3,  vw_CustomerAccounts.AccountName
	FROM            dbo.vw_CustomerAccounts RIGHT OUTER JOIN
                         dbo.swiftfin_CreditBatchEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_CreditBatchEntries.CustomerAccountId  
	where CreditBatchId=@BatchID
END

--select * from dbo.vw_CustomerAccounts




GO
/****** Object:  StoredProcedure [dbo].[sp_CreditBatchDiscrepancies]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


---sp_CreditBatchDiscrepancies '0006520'

create Procedure [dbo].[sp_CreditBatchDiscrepancies]
@Batchno varchar(50)
as 

SELECT      dbo.swiftfin_CreditBatchDiscrepancies.Column1, dbo.swiftfin_CreditBatchDiscrepancies.Column2, 
                         dbo.swiftfin_CreditBatchDiscrepancies.Column3, dbo.swiftfin_CreditBatchDiscrepancies.Column4, dbo.swiftfin_CreditBatchDiscrepancies.Column5, dbo.swiftfin_CreditBatchDiscrepancies.Column6, 
                         dbo.swiftfin_CreditBatchDiscrepancies.Remarks, dbo.swiftfin_CreditBatchDiscrepancies.Status, dbo.swiftfin_CreditBatchDiscrepancies.CreatedDate
FROM            dbo.swiftfin_CreditBatchDiscrepancies INNER JOIN
                         dbo.swiftfin_CreditBatches ON dbo.swiftfin_CreditBatchDiscrepancies.CreditBatchId = dbo.swiftfin_CreditBatches.Id 
                         
                         where  dbo.swiftfin_CreditBatches.BatchNumber=@Batchno
                         --Where swiftfin_CreditBatchDiscrepancies.CreditBatchId='8E74B516-3B60-C92E-4F73-08D39B37FD10'




GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerAccountBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--sp_CustomerAccountBalance 'BA9CD9D3-711A-C425-5B85-08D37A1E72BB',3,0,'05/18/2016'

-- =============================================
-- Author:		Centrino
-- Create date: 01.06.2014
-- Description:	Customer AccountBalance Available
-- =============================================
CREATE PROCEDURE [dbo].[sp_CustomerAccountBalance] 
	-- Add the parameters for the stored procedure here
	@CustomerAccountID Varchar(100) = 0, 
	@Type int = 0,
	@considerMaturityPeriodForInvestmentAccounts bit =0,
	@CutoffDate DateTime,
	@CustomerAccountType_TargetProductId Uniqueidentifier=null,
	@CustomerAccountType_ProductCode Int=null
AS
	Declare @Balance numeric(18,2)
	Declare @MinBalance numeric(18,2), @CustomerAccountID_Sniff uniqueidentifier=@CustomerAccountID,@CutoffDate_Sniff DateTime=@CutoffDate

BEGIN

	IF left(CAST(@CutoffDate_Sniff AS TIME),5) = '00:00'
	BEGIN
		SET @CutoffDate_Sniff = (SELECT DATEADD(day, DATEDIFF(day, 0, @CutoffDate_Sniff), '23:59:59'));
	END
	
	SET NOCOUNT ON;
	
	Declare @ProductID uniqueidentifier=@CustomerAccountType_TargetProductId,
			@Days int,
			@EndDate Datetime,
			@unMaturedAmount Numeric(18,2),
			@UnclearedCheques Numeric(18,2),
			@UnclearedChequesChartOfAccountID uniqueidentifier,
			@InterestReceivableChartOfAccountID Uniqueidentifier,
			@ChartOfAccountID UniqueIdentifier
			if @type=2
				begin
					set @InterestReceivableChartOfAccountID=(SELECT InterestReceivableChartOfAccountId FROM swiftfin_LoanProducts WHERE ID =@ProductID)
				end
			if @type=3
				begin
					set @InterestReceivableChartOfAccountID=(SELECT ChartOfAccountId FROM swiftfin_SystemGeneralLedgerAccountMappings WHERE SystemGeneralLedgerAccountCode =48832)
				end
	set @ChartOfAccountID= (
		SELECT case 
		when @CustomerAccountType_ProductCode=1 then 
		(select       ChartOfAccountId FROM swiftfin_SavingsProducts  WHERE        (id =@ProductID))
		when @CustomerAccountType_ProductCode=2 then 
		(select       ChartOfAccountId FROM swiftfin_LoanProducts  WHERE        (id =@ProductID))
		when @CustomerAccountType_ProductCode=3 then 
		(select       ChartOfAccountId FROM swiftfin_InvestmentProducts  WHERE        (id =@ProductID))
		end)
	set @UnclearedChequesChartOfAccountID=
						(
							  SELECT[ChartOfAccountId]
							  FROM [dbo].[swiftfin_SystemGeneralLedgerAccountMappings] 
							  WHERE SystemGeneralLedgerAccountCode=48827
						)
	set @days=iif(@considerMaturityPeriodForInvestmentAccounts=1,(select MaturityPeriod from swiftfin_InvestmentProducts where id=@ProductID),0)
	set @unMaturedAmount=0
	set @Balance = 
		CASE 
			WHEN @Type=1 THEN ---Account Balance
				(
					SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
					FROM            dbo.swiftfin_JournalEntries  
					WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID_Sniff) 
					AND (dbo.swiftfin_JournalEntries.ChartOfAccountId in(@ChartOfAccountID,@UnclearedChequesChartOfAccountID))
					and CreatedDate<@CutoffDate_Sniff
				)
			when @type=2 then
			(		SELECT SUM(dbo.swiftfin_JournalEntries.Amount) 
						FROM   dbo.swiftfin_JournalEntries 
						WHERE CustomerAccountId =@CustomerAccountID_Sniff 
						 and ChartOfAccountId =@InterestReceivableChartOfAccountID
						 and CreatedDate<@CutoffDate_Sniff
				)
				when @Type=3 then
				(		SELECT SUM(dbo.swiftfin_JournalEntries.Amount) 
						FROM   dbo.swiftfin_JournalEntries 
						WHERE CustomerAccountId =@CustomerAccountID_Sniff 
						 and ChartOfAccountId =@InterestReceivableChartOfAccountID
						 and CreatedDate<@CutoffDate_Sniff
				)
			END 
		select @Balance= 
			CASE 
			  WHEN @considerMaturityPeriodForInvestmentAccounts=1 THEN  
					@Balance-@unMaturedAmount
			  ELSE
				    @Balance
			  END 
	SELECT ISNULL(@Balance,0) as Balance
END

GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerAccountBalance1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 01.06.2014
-- Description:	Customer AccountBalance Available
-- =============================================
---'2196-002-00560'
--
--select * from vw_customeraccounts where reference1='2196-002-00560'
---sp_CustomerAccountBalance '6B3E3546-3D21-C434-5B24-08D3FF6056D2',1,0,'11/14/2016','65E7D03C-C634-C192-ABAF-08D3E094814B',1
create PROCEDURE [dbo].[sp_CustomerAccountBalance1] 
	-- Add the parameters for the stored procedure here
	@CustomerAccountID uniqueidentifier, 
	@Type int = 0,
	@considerMaturityPeriodForInvestmentAccounts bit =0,
	@CutoffDate DateTime,
	@CustomerAccountType_TargetProductId Uniqueidentifier,
	@CustomerAccountType_ProductCode Int
AS
	Declare @Balance numeric(18,2)
	Declare @MinBalance numeric(18,2)

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
		set @CutoffDate=	(select DATEADD(day, DATEDIFF(day, 0, @CutoffDate), '23:59:59'));

	SET NOCOUNT ON;

	Declare @ProductID uniqueidentifier=@CustomerAccountType_TargetProductId,
			@Days int,
			@EndDate Datetime,
			@unMaturedAmount Numeric(18,2),
			@UnclearedCheques Numeric(18,2),
			@UnclearedChequesChartOfAccountID uniqueidentifier,
			@InterestReceivableChartOfAccountID Uniqueidentifier,
			@ChartOfAccountID UniqueIdentifier

	set @InterestReceivableChartOfAccountID=(SELECT InterestReceivableChartOfAccountId FROM swiftfin_LoanProducts WHERE ID =@ProductID)

	set @ChartOfAccountID= (
		SELECT case 
		when @CustomerAccountType_ProductCode=1 then 
		(select       ChartOfAccountId FROM swiftfin_SavingsProducts  WHERE        (id =@ProductID))
		when @CustomerAccountType_ProductCode=2 then 
		(select       ChartOfAccountId FROM swiftfin_LoanProducts  WHERE        (id =@ProductID))
		when @CustomerAccountType_ProductCode=3 then 
		(select       ChartOfAccountId FROM swiftfin_InvestmentProducts  WHERE        (id =@ProductID))
		end)
	set @UnclearedChequesChartOfAccountID=
							(
							  SELECT[ChartOfAccountId]
							  FROM [dbo].[swiftfin_SystemGeneralLedgerAccountMappings] 
							  WHERE SystemGeneralLedgerAccountCode=48827
						)
	set @days=iif(@considerMaturityPeriodForInvestmentAccounts=1,(select MaturityPeriod from swiftfin_InvestmentProducts where id=@ProductID),0)

	set @EndDate=Dateadd(d,@days*-1,@CutoffDate)
	set @unMaturedAmount=
	isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
			FROM         dbo.swiftfin_JournalEntries WITH (NOLOCK) INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID)  AND (dbo.swiftfin_InvestmentProducts.Id = @ProductID) AND 
                         (dbo.swiftfin_Journals.CreatedDate >= @EndDate)
						 AND  (dbo.swiftfin_Journals.ModuleNavigationItemCode <> ('64426'))),0)

	Select @UnclearedCheques= 
	isnull((
						(
					SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
					FROM            dbo.swiftfin_JournalEntries WITH (NOLOCK) INNER JOIN
											 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
					WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID) 
					and ChartOfAccountId  =@UnclearedChequesChartOfAccountID
				)

	),0)
	SELECT @Balance = 
		CASE 
			WHEN @Type=1 THEN ---Account Balance
				(
					SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
					FROM            dbo.swiftfin_JournalEntries WITH (NOLOCK) INNER JOIN
											 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
					WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID) 
					AND (dbo.swiftfin_JournalEntries.ChartOfAccountId =@ChartOfAccountID)
					and swiftfin_Journals.CreatedDate<=@CutoffDate
				)
			 ELSE  --- AccountInterest

				(		SELECT SUM(dbo.swiftfin_JournalEntries.Amount) 
						FROM   dbo.swiftfin_JournalEntries WITH (NOLOCK)
						WHERE CustomerAccountId =@CustomerAccountId 
						 and ChartOfAccountId =@InterestReceivableChartOfAccountID
						 and CreatedDate<=@CutoffDate
				)
			  END 
			  select @Balance= CASE 
			  WHEN @considerMaturityPeriodForInvestmentAccounts=1 THEN  @Balance-@unMaturedAmount
			  ELSE
				   @Balance+isnull(@UnclearedCheques,0)
			  END 
SELECT ISNULL(@Balance,0) as Balance
END







GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerAccountBalanceAvailable]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 01.06.2014
-- Description:	Customer AccountBalance Available
-- =============================================
---sp_CustomerAccountBalanceAvailable '3e9ae149-658f-caba-2682-08d1ad7d0c72','01/11/2013'

CREATE PROCEDURE [dbo].[sp_CustomerAccountBalanceAvailable] 
	-- Add the parameters for the stored procedure here
	@CustomerAccountID UniqueIdentifier,
	@CutoffDate Datetime ,
	@CustomerAccountType_TargetProductId Uniqueidentifier,
	@CustomerAccountType_ProductCode Int,
	@CustomerAccountBranchId Uniqueidentifier
AS
	Declare @Balance numeric(18,2)
	Declare @MinBalance numeric(18,2),
	@SavingsChartOfAccountID UniqueIdentifier,
	@ProducID UniqueIdentifier=@CustomerAccountType_TargetProductId,
	@BranchId UniqueIdentifier=@CustomerAccountBranchId

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SET @SavingsChartOfAccountID=(SELECT TOP 1 ChartOfAccountId FROM swiftfin_SavingsProducts where id=@ProducID)
	SET @CutoffDate=	(select DATEADD(day, DATEDIFF(day, 0, @CutoffDate), '23:59:59'));
	SELECT @Balance = 

				isnull((
						Select SUM(dbo.swiftfin_JournalEntries.Amount) ---Products_1.MinBalance
						FROM   dbo.swiftfin_JournalEntries WITH (NOLOCK) 
						WHERE CustomerAccountId =@CustomerAccountId and ChartOfAccountId =@SavingsChartOfAccountID
						 and CreatedDate<=@CutoffDate
						
				),0)

	IF EXISTS (select 1 from swiftfin_SavingsProductExemptions where SavingsProductId=@ProducID and BranchId=@BranchId) 
	BEGIN
		SET @MinBalance =  (SELECT TOP 1 MinimumBalance from swiftfin_SavingsProductExemptions where SavingsProductId=@ProducID and BranchId=@BranchId)
	END
	ELSE
	BEGIN
		SET @MinBalance = (select MinimumBalance from swiftfin_SavingsProducts where Id=@ProducID)
	END

	SET @MinBalance = ISNULL(@MinBalance,0)

	SET @Balance=@Balance-@MinBalance
	
	SELECT ISNULL(@Balance,0) as Balance
END









GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerAccountBalanceAvailablexxx]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_CustomerAccountBalanceAvailablexxx '11/10/2015'
CREATE PROCEDURE [dbo].[sp_CustomerAccountBalanceAvailablexxx] 
	
	@CutoffDate Datetime 
AS
	Declare @Balance numeric(18,2)
	Declare @MinBalance numeric(18,2),@SavingsChartOfAccountID UniqueIdentifier,@ProducID UniqueIdentifier

BEGIN
	
	SET NOCOUNT ON;
	set @ProducID=(select  CustomerAccountType_TargetProductId 
						from swiftfin_CustomerAccounts) --where id=@CustomerAccountID)

	set @SavingsChartOfAccountID=(SELECT  ChartOfAccountId FROM PRODUCTS(0) WHERE ID =@ProducID)
	set @CutoffDate=	(select DATEADD(day, DATEDIFF(day, 0, @CutoffDate), '23:59:59'));

	SELECT @Balance = 

				isnull((
						Select  dbo.swiftfin_JournalEntries.Amount
						FROM   dbo.swiftfin_JournalEntries WITH (NOLOCK) 
					
						where ChartOfAccountId =@SavingsChartOfAccountID
						 and CreatedDate<=@CutoffDate
						
				),0)

			  SET @MinBalance=
			  ISNULL((
						SELECT top(1) MinimumBalance
						FROM swiftfin_SavingsProducts WHERE ID =@ProducID
					),0)
			set @Balance=@Balance-@MinBalance
	
SELECT  ISNULL(@Balance,0) as Balance 

END











GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerAccountBalancex]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_CustomerAccounts
--sp_CustomerAccountBalance '0A873151-26C4-C2A5-2995-08D37A252320',1,0,'06/18/2016','AC57CA6A-3532-C9C9-292C-08D3397C3DE6',1
--select * from swiftfin_SavingsProducts
-- =============================================
-- Author:		Centrino
-- Create date: 01.06.2014
-- Description:	Customer AccountBalance Available
-- =============================================


create PROCEDURE [dbo].[sp_CustomerAccountBalancex] 
	-- Add the parameters for the stored procedure here
	@CustomerAccountID Varchar(100) = 0, 
	@Type int = 0,
	@considerMaturityPeriodForInvestmentAccounts bit =0,
	@CutoffDate DateTime,
	@CustomerAccountType_TargetProductId Uniqueidentifier=null,
	@CustomerAccountType_ProductCode Int=null
AS
	Declare @Balance numeric(18,2)
	Declare @MinBalance numeric(18,2)

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
		set @CutoffDate=	(select DATEADD(day, DATEDIFF(day, 0, @CutoffDate), '23:59:59'));

	SET NOCOUNT ON;

	Declare @ProductID uniqueidentifier=@CustomerAccountType_TargetProductId,
			@Days int,
			@EndDate Datetime,
			@unMaturedAmount Numeric(18,2),
			@UnclearedCheques Numeric(18,2),
			@UnclearedChequesChartOfAccountID uniqueidentifier,
			@InterestReceivableChartOfAccountID Uniqueidentifier,
			@ChartOfAccountID UniqueIdentifier

	set @InterestReceivableChartOfAccountID=(SELECT InterestReceivableChartOfAccountId FROM swiftfin_LoanProducts WHERE ID =@ProductID)

	set @ChartOfAccountID= (
		SELECT case 
		when @CustomerAccountType_ProductCode=1 then 
		(select       ChartOfAccountId FROM swiftfin_SavingsProducts  WHERE        (id =@ProductID))
		when @CustomerAccountType_ProductCode=2 then 
		(select       ChartOfAccountId FROM swiftfin_LoanProducts  WHERE        (id =@ProductID))
		when @CustomerAccountType_ProductCode=3 then 
		(select       ChartOfAccountId FROM swiftfin_InvestmentProducts  WHERE        (id =@ProductID))
		end)
	set @UnclearedChequesChartOfAccountID=
							(
							  SELECT[ChartOfAccountId]
							  FROM [dbo].[swiftfin_SystemGeneralLedgerAccountMappings] 
							  WHERE SystemGeneralLedgerAccountCode=48827
						)
	set @days=iif(@considerMaturityPeriodForInvestmentAccounts=1,(select MaturityPeriod from swiftfin_InvestmentProducts where id=@ProductID),0)

	set @EndDate=Dateadd(d,@days*-1,@CutoffDate)
	set @unMaturedAmount=
	case 
	when @considerMaturityPeriodForInvestmentAccounts=1 then
	isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
			FROM         dbo.swiftfin_JournalEntries WITH (NOLOCK) INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID)  AND (dbo.swiftfin_InvestmentProducts.Id = @ProductID) AND 
                         (dbo.swiftfin_Journals.CreatedDate >= @EndDate)
						 AND  (dbo.swiftfin_Journals.ModuleNavigationItemCode <> ('64426'))),0) 
	else 0
	end
	
	Select @UnclearedCheques=
	CASE WHEN @CustomerAccountType_ProductCode=1 then 
	isnull((
						(
					SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
					FROM            dbo.swiftfin_JournalEntries WITH (NOLOCK) INNER JOIN
											 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
					WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID) 
					and ChartOfAccountId  =@UnclearedChequesChartOfAccountID
				)
	),0)
	ELSE 0
	END

	SELECT @Balance = 
		CASE 
			WHEN @Type=1 THEN ---Account Balance
				(
					SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
					FROM            dbo.swiftfin_JournalEntries WITH (NOLOCK) INNER JOIN
											 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
					WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = @CustomerAccountID) 
					AND (dbo.swiftfin_JournalEntries.ChartOfAccountId =@ChartOfAccountID)
					and swiftfin_Journals.CreatedDate<=@CutoffDate
				)
			 ELSE  --- AccountInterest

				(		SELECT SUM(dbo.swiftfin_JournalEntries.Amount) 
						FROM   dbo.swiftfin_JournalEntries WITH (NOLOCK)
						WHERE CustomerAccountId =@CustomerAccountId 
						 and ChartOfAccountId =@InterestReceivableChartOfAccountID
						 and CreatedDate<=@CutoffDate
				)
			  END 
			  select @Balance= CASE 
			  WHEN @considerMaturityPeriodForInvestmentAccounts=1 THEN  @Balance-@unMaturedAmount
			  ELSE
				   @Balance+isnull(@UnclearedCheques,0)
			  END 
SELECT ISNULL(@Balance,0) as Balance
END






GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerAccountStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---sp_CustomerAccountStatement '01/01/2014','12/01/2014','reference1','0101-001-04583 '
CREATE PROCEDURE [dbo].[sp_CustomerAccountStatement]
	(
		@StartDate datetime,
		@EndDate Datetime,
		@SearchBy NVARCHAR(100),
		@SearchString NVARCHAR(100)
	)

AS
BEGIN

	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'))
	set @SearchString=ltrim(rtrim(@SearchString))
	Declare 
		@LocalStartDate datetime =@StartDate,
		@LocalEndDate Datetime=@EndDate,
		@LocalSearchBy NVARCHAR(100)=@SearchBy,
		@LocalSearchString NVARCHAR(100)=@SearchString


	SET NOCOUNT ON;

    -- Insert statements for procedure here
WITH Statement_cte (FullAccount,AccountName,Product,ID,TrxDate,PrimaryDescription,SecondaryDescription,reference,debit,credit,RunningTotal,InterestDR,InterestCR,IntBalance,Reference1,Reference2,Reference3)
AS
(
	SELECT      CustomerAccounts.FullAccount, Customers.Salutation+' '+Customers.Individual_FirstName+' '+Customers.Individual_LastName as AccountName , Products_1.Description,Products_1.id, JournalEntries.CreatedDate, Journals.PrimaryDescription, 
				Journals.SecondaryDescription,  Journals.Reference,ISNULL(CASE WHEN JournalEntries.amount < 0 THEN JournalEntries.amount * - 1 END, 0) AS Debit, ISNULL(CASE WHEN JournalEntries.amount > 0 THEN JournalEntries.amount END, 0) AS Credit, JournalEntries.Amount,0,0,0,CustomerAccounts.Reference1,CustomerAccounts.Reference2,CustomerAccounts.Reference3
	FROM        dbo.Products(1) AS Products_1 INNER JOIN
				dbo.swiftfin_JournalEntries AS JournalEntries ON Products_1.ChartOfAccountId = JournalEntries.ChartOfAccountId INNER JOIN
                dbo.vw_CustomerAccounts CustomerAccounts INNER JOIN
                dbo.vw_MemberRegister Customers  ON CustomerAccounts.CustomerId = Customers.Id INNER JOIN
                dbo.swiftfin_Branches ON CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id ON 
                JournalEntries.CustomerAccountId = CustomerAccounts.Id INNER JOIN
                dbo.swiftfin_Journals as Journals ON JournalEntries.JournalId = Journals.Id
	WHERE  
	CASE
		WHEN @LocalSearchBy ='IdentityCardNumber' THEN Customers.Individual_IdentityCardNumber
		WHEN @LocalSearchBy ='SerialNumber' THEN  Customers.SerialNumber
		WHEN @LocalSearchBy ='PersonalFileNumber' THEN  Customers.Individual_PayrollNumbers
		WHEN @LocalSearchBy ='Reference1' THEN  Customers.Reference1
		WHEN @LocalSearchBy ='Reference2' THEN  Customers.Reference2
	end =@LocalSearchString
),

Statement_Interest_cte (FullAccount,AccountName,Product,id,TrxDate,PrimaryDescription,SecondaryDescription,reference,InterestDR,InterestCR,IntBalance,Debit,Credit,RunningTotal,Reference1,Reference2,Reference3)
AS
(
	SELECT       CustomerAccounts.FullAccount, Customers.Salutation+' '+Customers.Individual_FirstName+' '+Customers.Individual_LastName as AccountName , Products_1.Description,Products_1.id, JournalEntries.CreatedDate, Journals.PrimaryDescription, 
				 Journals.SecondaryDescription,  Journals.Reference, ISNULL(CASE WHEN JournalEntries.amount < 0 THEN JournalEntries.amount * - 1 END, 0) AS Debit, ISNULL(CASE WHEN JournalEntries.amount > 0 THEN JournalEntries.amount END, 0) AS Credit,
				 JournalEntries.Amount,0,0,0,CustomerAccounts.Reference1,CustomerAccounts.Reference2,CustomerAccounts.Reference3
	FROM         dbo.Products(1) AS Products_1 INNER JOIN
                 dbo.swiftfin_JournalEntries AS JournalEntries ON Products_1.InterestReceivable = JournalEntries.ChartOfAccountId INNER JOIN
                 dbo.vw_CustomerAccounts CustomerAccounts INNER JOIN
                 dbo.vw_MemberRegister Customers  ON CustomerAccounts.CustomerId = Customers.Id INNER JOIN
                 dbo.swiftfin_Branches ON CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id ON 
                 JournalEntries.CustomerAccountId = CustomerAccounts.Id INNER JOIN
                 dbo.swiftfin_Journals as Journals ON JournalEntries.JournalId = Journals.Id
	WHERE  
	CASE
		WHEN @LocalSearchBy ='IdentityCardNumber' THEN Customers.Individual_IdentityCardNumber
		WHEN @LocalSearchBy ='SerialNumber' THEN  Customers.SerialNumber
		WHEN @LocalSearchBy ='PersonalFileNumber' THEN  Customers.Individual_PayrollNumbers
		WHEN @LocalSearchBy ='Reference1' THEN  Customers.Reference1
		WHEN @LocalSearchBy ='Reference2' THEN  Customers.Reference2
		WHEN @LocalSearchBy ='Reference3' THEN  Customers.Reference3
	end = (@LocalSearchString) or @LocalSearchString is null
),

Statement_Combined (FullAccount,AccountName,Product,id,TrxDate,PrimaryDescription,SecondaryDescription,reference,Credit,Debit,RunningTotal,InterestDR,InterestCR,IntBalance,Reference1,Reference2,Reference3)
AS
(
	SELECT FullAccount,AccountName,Product,id,TrxDate,PrimaryDescription,SecondaryDescription,reference,debit,credit,RunningTotal,
	InterestDR,InterestCR,IntBalance,Reference1,Reference2,Reference3
	FROM Statement_cte 
	union all
	SELECT FullAccount,AccountName,Product,id,TrxDate,PrimaryDescription,SecondaryDescription,reference,debit,credit,RunningTotal,
	InterestDR,InterestCR,IntBalance,Reference1,Reference2,Reference3
	FROM Statement_Interest_cte 
)

select FullAccount,AccountName,Product,id,TrxDate,ltrim(rtrim(PrimaryDescription))+' '+ltrim(rtrim(SecondaryDescription)) as PrimaryDescription ,reference,Debit,credit,SUM(isnull(RunningTotal,0)) OVER(PARTITION BY Product  ORDER BY TrxDate
	  		  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as RunningTotal,
InterestDR,InterestCR,SUM(isnull(IntBalance,0)) OVER(PARTITION BY Product  ORDER BY TrxDate
	  		  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)  as IntBalance,Reference1,Reference2,Reference3 into #temp from Statement_Combined order by product,TrxDate

select * from #temp WHERE TrxDate Between @LocalStartDate and @LocalEndDate

END







GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerByGender]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--Exec sp_CustomerByGender '0'
CREATE PROCEDURE [dbo].[sp_CustomerByGender]
	-- Add the parameters for the stored procedure here
	@pGender int,
	@EndDate DateTime
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	Set @EndDate=(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
	SELECT datediff (YY, Individual_BirthDate, getdate() ) as Age, Individual_FirstName + ' ' +  Individual_LastName As FullName, Reference1, Reference3,Individual_IdentityCardNumber,Address_MobileLine,
	CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' WHEN '0' THEN 'Unknown' END AS Gender,
	CASE Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END As Salutation

	FROM     swiftfin_Customers
	where Individual_Gender =@pGender and RegistrationDate<=@EndDate

END

--select * from swiftfin_Customers








GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerreferredBy]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan>
-- Create date: <Create Date, 17/11/2015>
-- Description:	<Description, List of Customers Recruited By an Employee >
-- =============================================
--sp_CustomersRecruitedBy '0004867'
create PROCEDURE [dbo].[sp_CustomerreferredBy] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime,
    @EndDate DateTime,
	@SerialNo int
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        COALESCE( ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))),'')+ COALESCE(  dbo.swiftfin_Customers.NonIndividual_Description,'') AS FullName, 
							 COALESCE( Individual_IdentityCardNumber,'')+COALESCE(NonIndividual_RegistrationNumber,'') as IdNo,Reference1 as AccountNo, Reference3 as PayrollNo,dbo.swiftfin_Stations.Description AS station,dbo.swiftfin_Referees.CustomerId
FROM            dbo.swiftfin_Customers inner  JOIN
                dbo.swiftfin_Referees on dbo.swiftfin_Customers.id=dbo.swiftfin_Referees.CustomerId inner join
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.stationId = dbo.swiftfin_Stations.Id
WHERE    RecruitedBy=@SerialNo and dbo.swiftfin_Customers.RegistrationDate BETWEEN @StartDate and @EndDate
END

---select * from swiftfin_customers






GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerSavingsStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---[sp_CustomerSavingsStatement] '01/01/2014','05/31/2014','reference1','0101-001-00671 '
CREATE PROCEDURE [dbo].[sp_CustomerSavingsStatement]
	(
		@StartDate datetime,
		@EndDate Datetime,
		@SearchBy NVARCHAR(MAX),
		@SearchString NVARCHAR(MAX)
	)

AS
BEGIN
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
WITH Statement_cte (FullAccount,AccountName,Product,Type,TrxDate,PrimaryDescription,SecondaryDescription,reference,debit,credit,BookBalance,AvailableBalance)
AS
(
SELECT        CustomerAccounts.FullAccount, Customers.Salutation+' '+Customers.Individual_FirstName+' '+Customers.Individual_LastName as AccountName , Products_1.Description,Products_1.Code, JournalEntries.CreatedDate, Journals.PrimaryDescription, 
			  Journals.SecondaryDescription,  Journals.Reference, ISNULL(CASE WHEN JournalEntries.amount < 0 THEN JournalEntries.amount * - 1 END, 0) AS Debit, ISNULL(CASE WHEN JournalEntries.amount > 0 THEN JournalEntries.amount END, 0) AS Credit,
			  
			  SUM(isnull(JournalEntries.Amount,0)) OVER(PARTITION BY Products_1.Description  ORDER BY JournalEntries.CreatedDate
	  		  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as BookBalance,

					  SUM
						(
						  CASE 
						  WHEN JournalEntries.ContraChartOfAccountId<>'F219BF2C-7956-C13E-C38E-08D133ECD9FB' THEN
							isnull(JournalEntries.Amount ,0) 
						  ELSE 
							0 
						  END
						) 
					  OVER
						(
						  PARTITION BY Products_1.Description  ORDER BY JournalEntries.CreatedDate
	  					  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
						) -Products_1.MinimumBalance
FROM          dbo.swiftfin_SavingsProducts AS Products_1 INNER JOIN
                         dbo.swiftfin_JournalEntries AS JournalEntries ON Products_1.ChartOfAccountId = JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.vw_CustomerAccounts CustomerAccounts INNER JOIN
                         dbo.vw_MemberRegister Customers  ON CustomerAccounts.CustomerId = Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id ON 
                         JournalEntries.CustomerAccountId = CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Journals as Journals ON JournalEntries.JournalId = Journals.Id
WHERE 
CASE
	WHEN @SearchBy ='IdentityCardNumber' THEN Customers.Individual_IdentityCardNumber
	WHEN @SearchBy ='SerialNumber' THEN  Customers.SerialNumber
	WHEN @SearchBy ='PersonalFileNumber' THEN  Customers.Individual_PayrollNumbers
	WHEN @SearchBy ='Reference1' THEN  Customers.Reference1
	WHEN @SearchBy ='Reference2' THEN  Customers.Reference2
	WHEN @SearchBy ='FullAccount' THEN CustomerAccounts.FullAccount
end = (@SearchString) 
)
SELECT FullAccount,AccountName,Product,type,TrxDate,PrimaryDescription,SecondaryDescription,reference,debit,credit,BookBalance,AvailableBalance
FROM Statement_cte 
WHERE TrxDate Between @StartDate and @EndDate
order by Product,Trxdate 
END










GO
/****** Object:  StoredProcedure [dbo].[sp_CustomersRecruitedBy]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan>
-- Create date: <Create Date, 17/11/2015>
-- Description:	<Description, List of Customers Recruited By an Employee >
-- =============================================
--sp_CustomersRecruitedBy '0004867'
CREATE PROCEDURE [dbo].[sp_CustomersRecruitedBy] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime,
    @EndDate DateTime,
	@SerialNo int
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        COALESCE( ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))),'')+ COALESCE(  dbo.swiftfin_Customers.NonIndividual_Description,'') AS FullName, 
							 COALESCE( Individual_IdentityCardNumber,'')+COALESCE(NonIndividual_RegistrationNumber,'') as IdNo,Reference1 as AccountNo, Reference3 as PayrollNo,dbo.swiftfin_Stations.Description AS Station,RecruitedBy
FROM            dbo.swiftfin_Customers LEFT OUTER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id
WHERE    RecruitedBy=@SerialNo and dbo.swiftfin_Customers.RegistrationDate BETWEEN @StartDate and @EndDate
END






GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---sp_CustomerStatement 20765,'04/01/2014','04/30/2014'
CREATE PROCEDURE [dbo].[sp_CustomerStatement] 
(
	@MemberShipNumber varchar(10),@StartDate datetime, @Enddate datetime
)
as
SELECT  
dbo.swiftfin_JournalEntries.Id,      
isnull(case
when amount<0 then amount*-1 
end ,0) as Debit,
isnull(case
when amount>0 then amount
end ,0) as Credit,amount ,dbo.swiftfin_JournalEntries.CreatedDate, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, 
                         dbo.swiftfin_Journals.Reference, Products_1.Description
 INTO #temp FROM            dbo.Products(1) AS Products_1 INNER JOIN
                         dbo.swiftfin_JournalEntries ON Products_1.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id ON 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_Customers.serialnumber = @MemberShipNumber) 

select *,
(SELECT SUM(b.Amount) 
                           FROM #temp b
                               WHERE b.CreatedDate <= a.CreatedDate
                               AND b.Description = a.Description)
AS RunningTotal into #temp2    from #temp a order by Description,CreatedDate

select * from #temp2 where Createddate between @StartDate and @Enddate
--SELECT * FROM swiftfin_JournalEntries WHERE ID='84D76F19-BE25-C14F-42AC-08D11C4BED7D'









GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerswithATMcards]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select Individual_FirstName+' '+Individual_LastName as FullName,reference1 as AcNo ,Reference3 as PayrollNo,Address_MobileLine as PhoneNo
-- from swiftfin_Customers innerjoin  where  Address_MobileLine = '' and reference3 is not null 

-- select * from swiftfin_AlternateChannels

create proc [dbo].[sp_CustomerswithATMcards]
as 
begin
SELECT        Individual_FirstName+' '+Individual_LastName as FullName, dbo.swiftfin_Customers.Reference1 as AccountNo, dbo.swiftfin_Customers.Individual_PayrollNumbers as PayrollNumber, dbo.swiftfin_AlternateChannels.CardNumber
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_AlternateChannels ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_AlternateChannels.CustomerAccountId
						 end
GO
/****** Object:  StoredProcedure [dbo].[sp_CustomersWithMissingDetails]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--sp_CustomersWithMissingDetails 'ID Numbers'
CREATE PROC [dbo].[sp_CustomersWithMissingDetails]
@Detail int
AS

SELECT        COALESCE( ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))),'')+ COALESCE(  dbo.swiftfin_Customers.NonIndividual_Description,'') AS FullName, 
							 COALESCE( Individual_IdentityCardNumber,'')+COALESCE(NonIndividual_RegistrationNumber,'') as IdNo,Reference1 as AccountNo,Reference2 as Mno,Reference3 as PayrollNo,Address_MobileLine as PhoneNumber
							 
							 FROM    dbo.swiftfin_Customers 
						where
						Case   when @Detail=1 then Reference1
						       when @Detail=2 then Individual_IdentityCardNumber 
				               when @Detail=3 then reference3 
							   when @Detail=4 then Reference2
							   when @Detail=5 then Address_MobileLine
							   end is null






GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerswithoutATMcards]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select Individual_FirstName+' '+Individual_LastName as FullName,reference1 as AcNo ,Reference3 as PayrollNo,Address_MobileLine as PhoneNo
-- from swiftfin_Customers innerjoin  where  Address_MobileLine = '' and reference3 is not null 

-- select * from swiftfin_AlternateChannels

CREATE proc [dbo].[sp_CustomerswithoutATMcards]

as 
begin
SELECT        Individual_FirstName+' '+Individual_LastName as FullName, dbo.swiftfin_Customers.Reference1 as AccountNo, dbo.swiftfin_Customers.Individual_PayrollNumbers as PayrollNumber,dbo.swiftfin_Customers.Address_MobileLine
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId 
						 where CustomerAccountType_TargetProductId='4623CC2E-E0BB-E811-A815-000C29142092' and 
						   dbo.swiftfin_CustomerAccounts.id not in(select CustomerAccountId from swiftfin_AlternateChannels where [type]=1)
					
						 
					end
GO
/****** Object:  StoredProcedure [dbo].[sp_CustomerTransactionAuthRequest]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

--sp_CustomerTransactionAuthRequestsAuthorizedByDate '01/01/2014' ,'04/30/2014'

--[sp_CustomerTransactionAuthRequest] 'Authorized Date','01/13/2014','04/30/2014'
CREATE PROCEDURE [dbo].[sp_CustomerTransactionAuthRequest]
@DisplayField varchar(50),
@FilterDate1 Datetime,
@FilterDate2 Datetime

AS

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
  SELECT        REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccount, 
                         CASE Individual_Salutation WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818' THEN 'Prof' WHEN '48819'
                          THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN 'Ms' ELSE 'UnKnown' END
                          + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         CASE dbo.swiftfin_CustomerTransactionAuthRequests.Type WHEN 1 THEN 'Withdrawal Within Limits' WHEN 2 THEN 'Withdrawal Above Maximum Allowed' WHEN 4 THEN 'Withdrawal Below Minimum Balance' ELSE
                          'UnKnown' END AS Type, 
                         CASE [Status] WHEN 1 THEN 'Pending' WHEN 2 THEN 'Authorized' WHEN 4 THEN 'Rejected' WHEN 8 THEN 'Paid' ELSE 'UnKnown' END AS Status, 
                         dbo.swiftfin_CustomerTransactionAuthRequests.Amount, dbo.swiftfin_CustomerTransactionAuthRequests.AuthorizedBy, 
                         dbo.swiftfin_CustomerTransactionAuthRequests.AuthorizationRemarks, dbo.swiftfin_CustomerTransactionAuthRequests.AuthorizedDate, 
                         dbo.swiftfin_CustomerTransactionAuthRequests.PaidBy, dbo.swiftfin_CustomerTransactionAuthRequests.PaidDate, dbo.swiftfin_CustomerTransactionAuthRequests.CreatedBy, 
                         dbo.swiftfin_CustomerTransactionAuthRequests.CreatedDate
FROM            dbo.swiftfin_CustomerTransactionAuthRequests INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_CustomerTransactionAuthRequests.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id

Where 
CASE 
	WHEN @DisplayField='AuthorizedDate' then dbo.swiftfin_CustomerTransactionAuthRequests.AuthorizedDate
	WHEN @DisplayField='PaidDate' then dbo.swiftfin_CustomerTransactionAuthRequests.PaidDate
	WHEN @DisplayField='CreatedDate' then dbo.swiftfin_CustomerTransactionAuthRequests.CreatedDate
end
between @FilterDate1 and @FilterDate2
END


---SELECT * FROM swiftfin_CustomerTransactionAuthRequests










GO
/****** Object:  StoredProcedure [dbo].[sp_DailyRoutine]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[sp_DailyRoutine] as
update swiftfin_Journals set CreatedDate=DATEADD(ms,1,CreatedDate) where CONVERT(varchar(10),CreatedDate,103)=CONVERT(varchar(10),getdate(),103)
update swiftfin_JournalEntries set CreatedDate=DATEADD(ms,1,CreatedDate) where CONVERT(varchar(10),CreatedDate,103)=CONVERT(varchar(10),getdate(),103)
update swiftfin_CreditBatchEntries set CreatedDate=DATEADD(ms,1,CreatedDate) where CONVERT(varchar(10),CreatedDate,103)=CONVERT(varchar(10),getdate(),103)






GO
/****** Object:  StoredProcedure [dbo].[SP_DASHBOARD]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_DASHBOARD]
AS

BEGIN

SET NOCOUNT ON;

CREATE TABLE #Dashboard
(
[Description] VARCHAR(50),
Value	VARCHAR(15)
)

/**SACCO Members*/
INSERT INTO #Dashboard
SELECT 'SACCO Members',COUNT(*) FROM dbo.swiftfin_Customers

/**Closed Accounts*/
INSERT INTO #Dashboard
SELECT 'Closed Accounts', '-' 

/**Active Male Members*/
INSERT INTO #Dashboard
SELECT 'Active Male Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE Individual_Gender = '57008'

/**Active Female Members*/
INSERT INTO #Dashboard
SELECT 'Active Female Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE Individual_Gender = '57009'

/**Unclassified Members*/
INSERT INTO #Dashboard
SELECT 'Unclassified Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE Individual_Gender NOT IN ('57009', '57008')

/**Active Members*/
INSERT INTO #Dashboard
SELECT 'Active Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE dbo.f_CustomerLastTransactionDate(id) >= DATEADD(MM,-3,GETDATE())

/**Dormant Members*/
INSERT INTO #Dashboard
SELECT 'Dormant Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE dbo.f_CustomerLastTransactionDate(id) < DATEADD(MM,-3,GETDATE())

/**Share Capital*/
INSERT INTO #Dashboard
SELECT dbo.swiftfin_ChartOfAccounts.AccountName, SUM(ISNULL(dbo.swiftfin_JournalEntries.Amount, 0)) AS Balance 
FROM dbo.swiftfin_JournalEntries INNER JOIN dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
WHERE dbo.swiftfin_JournalEntries.ChartOfAccountId = '7BD83577-DB07-CAAD-50B7-08D10FCB3DEC'                        
GROUP BY dbo.swiftfin_ChartOfAccounts.AccountName

SELECT * FROM #Dashboard

END






GO
/****** Object:  StoredProcedure [dbo].[sp_DebitCardsExpiredReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--sp_DebitCardsLinkingReport '01/01/2013','04/03/2014'
CREATE PROCEDURE [dbo].[sp_DebitCardsExpiredReport]
	-- Add the parameters for the stored procedure here
@StartDate Datetime,
@Enddate Datetime,
@type int
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT        RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_Branches.Code)) AS VARCHAR(5)), 5) + '-' + RIGHT('00000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber))
                          AS VARCHAR(6)), 6) + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode)) AS VARCHAR(5)), 5) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode)) AS VARCHAR(5)), 5) AS FullAccount, 
                         CASE [Individual_Salutation] WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818' THEN 'Prof' WHEN '48819'
                          THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN 'Ms' ELSE 'UnKnown' END
                          + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, dbo.swiftfin_DebitCards.Type, dbo.swiftfin_DebitCards.CardNumber, 
                         dbo.swiftfin_DebitCards.ValidFrom, dbo.swiftfin_DebitCards.Expires, dbo.swiftfin_DebitCards.DailyLimit, 
                         dbo.swiftfin_DebitCards.Remarks, dbo.swiftfin_DebitCards.IsLocked, dbo.swiftfin_DebitCards.CreatedBy, dbo.swiftfin_DebitCards.CreatedDate, 
                         dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers
FROM            dbo.swiftfin_DebitCards INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_DebitCards.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id
WHERE dbo.swiftfin_DebitCards.Expires>=@StartDate and dbo.swiftfin_DebitCards.Expires<=@Enddate and dbo.swiftfin_DebitCards.type=@type
END











GO
/****** Object:  StoredProcedure [dbo].[sp_DebitCardsLinkingReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--[sp_DebitCardsLinkingReport] '01/01/2013','06/01/2014',2
CREATE PROCEDURE [dbo].[sp_DebitCardsLinkingReport]
	-- Add the parameters for the stored procedure here
@StartDate Datetime,
@Enddate Datetime,
@type int
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT        RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_Branches.Code)) AS VARCHAR(5)), 5) + '-' + RIGHT('00000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber))
                          AS VARCHAR(6)), 6) + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode)) AS VARCHAR(5)), 5) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode)) AS VARCHAR(5)), 5) AS FullAccount, 
                         CASE Individual_Salutation WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818' THEN 'Prof' WHEN '48819'
                          THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN 'Ms' ELSE 'UnKnown' END
                          + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, dbo.swiftfin_DebitCards.Type,dbo.Character_Mask(CardNumber,5,'X') as CardNumber, 
                         dbo.swiftfin_DebitCards.ValidFrom, dbo.swiftfin_DebitCards.Expires, dbo.swiftfin_DebitCards.DailyLimit, 
                         dbo.swiftfin_DebitCards.Remarks, dbo.swiftfin_DebitCards.IsLocked, dbo.swiftfin_DebitCards.CreatedBy, dbo.swiftfin_DebitCards.CreatedDate, 
                         dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers
INTO #DebitCards
FROM            dbo.swiftfin_DebitCards INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_DebitCards.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id
WHERE dbo.swiftfin_DebitCards.CreatedDate>=@StartDate and dbo.swiftfin_DebitCards.CreatedDate<=@Enddate and dbo.swiftfin_DebitCards.Type=@type

select * from #DebitCards order by Branch,FullAccount
END











GO
/****** Object:  StoredProcedure [dbo].[sp_DebitCardsListingReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--[sp_DebitCardsListingReport] 1 '01/01/2013','04/03/2014'
CREATE PROCEDURE [dbo].[sp_DebitCardsListingReport]
	-- Add the parameters for the stored procedure here
@Type int 
AS

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT        RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_Branches.Code)) AS VARCHAR(6)), 6) + '-' + RIGHT('000000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber))
                          AS VARCHAR(6)), 6) + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode)) AS VARCHAR(5)), 5) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode)) AS VARCHAR(5)), 5) AS FullAccount, 
                         CASE [Individual_Salutation] WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818' THEN 'Prof' WHEN '48819'
                          THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN 'Ms' ELSE 'UnKnown' END
                          + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, dbo.swiftfin_DebitCards.Type,dbo.Character_Mask(CardNumber,5,'X') as CardNumber, 
                         dbo.swiftfin_DebitCards.ValidFrom, dbo.swiftfin_DebitCards.Expires, dbo.swiftfin_DebitCards.DailyLimit, 
                         dbo.swiftfin_DebitCards.Remarks, dbo.swiftfin_DebitCards.IsLocked, dbo.swiftfin_DebitCards.CreatedBy, dbo.swiftfin_DebitCards.CreatedDate, 
                         dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers
FROM            dbo.swiftfin_DebitCards INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_DebitCards.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id
WHERE dbo.swiftfin_DebitCards.Type=@Type
END











GO
/****** Object:  StoredProcedure [dbo].[sp_Defaulters]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--sp_Defaulters 0,'11/12/2018'
CREATE procedure [dbo].[sp_Defaulters]
(
	@GracePeriod int=0,
	@EndDate as Datetime
)

 as
SET NOCOUNT ON;

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


WITH Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select pf_no,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from BOSA.dbo.history  where pf_no= Loanhist.pf_no and ttype=loanhist.ttype) as balance,(select name from BOSA.dbo.lntypes where code=Loanhist.ttype) as description 
from BOSA.dbo.history as Loanhist where left(ttype,1)='L'   and docid not in('203','608')  group by pf_no,ttype 
)

select 
(select top 1 Name from BOSA.dbo.customer  where pf_no= Frequency_CTE.pf_no) as Name,(select top 1 empno from BOSA.dbo.customer  where pf_no= Frequency_CTE.pf_no) as PayrollNo,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference2=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select top 1 REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 ,Frequency_CTE.pf_no as Reference1 into #temp1 from Frequency_CTE where BAlance<>0 ;

 --select * from FOSA.dbo.Loanhist
WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select fosa_acno,ttype,max(trdate) as TrxDate, (select sum(debit-credit) from FOSA.dbo.Loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from FOSA.dbo.lntypes where code=Loanhist1.ttype) 
from FOSA.dbo.Loanhist as Loanhist1 where left(ttype,1)='L' and isnull(credit,0)+isnull(intcr,0)>0 group by fosa_acno,ttype  
)

select 
(select top 1 Name from FOSA.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select top 1 REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 ,Frequency_CTEFOSA.pf_no as Reference1 into #tempFosa from Frequency_CTEFOSA where BAlance<>0 


 SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and ValueDate<=@EndDate),0)*-1 as Balance ,
 isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.InterestReceivableChartOfAccountId and ValueDate<=@EndDate),0)*-1 as InterestAccrued,vw_CustomerAccounts.reference1,
vw_CustomerAccounts.reference2,vw_CustomerAccounts.Reference3, (SELECT MAX(dbo.swiftfin_JournalEntries.ValueDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.ValueDate <= @EndDate  and amount<>0 )) as LastActivity
, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id


select *,datediff(mm,#temp2_.LastActivity,@EndDate) as DefaultFrequency into #temp2 from #temp2_					



CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #Temp1 where balance<>0 and  FullAccount not in (select FullAccount from #temp2_)-----and FullAccount not in (select FullAccount from #temp2)

insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #tempFosa where balance<>0 and  FullAccount not in (select FullAccount from #temp2_) ----and FullAccount not in (select FullAccount from #temp2)



select (select top 1 FullName from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc) as FullName,(select top 1 balance from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc) as Balance ,Reference2,max(LastActivity) as LastActivity ,
datediff(mm,max(LastActivity),@EndDate) as  DefaultFrequency,FullAccount,LoanName,reference1 into #temp4 from #temp2 temp2 group by Reference2,LoanName,FullAccount,Reference1


select reference1,Fullaccount,fullname,balance,LoanName,max(lastactivity) as lastactivity into #temp3 from #temp4 group by Fullaccount,fullname,balance,LoanName,Reference1;

With CTEFinal(FullName,Balance,LastActivity,ClassOrder,Classification,DefaultFrequency,FullAccount,LoanName,ProductSection,provision_amount,reference1)
as
(
select 
FullName,Balance,LastActivity,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=3 THEN 0
WHEN DATEDIFF(MM,LastActivity,@EndDate)>3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=9 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>9 and DATEDIFF(MM,LastActivity,@EndDate)<=15 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>15 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=3 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=9 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>9 and DATEDIFF(MM,LastActivity,@EndDate)<=15 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>15 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,
(select top 1  LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=3 THEN 0
WHEN DATEDIFF(MM,LastActivity,@EndDate)>3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=9 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>9 and DATEDIFF(MM,LastActivity,@EndDate)<=15 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>15 THEN 100
end *Balance *0.01 as provision_amount,Reference1 
 from #temp3 where fullname is not null and balance<>0 and DATEDIFF(m,LastActivity,@EndDate)>=@GracePeriod 
)
select 

* from CTEFinal order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName



GO
/****** Object:  StoredProcedure [dbo].[sp_Defaulters_1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--sp_Defaulters '12/30/2018'
CREATE procedure [dbo].[sp_Defaulters_1]
(
	--@GracePeriod int=0,
	@EndDate as Datetime
)

 as
SET NOCOUNT ON;

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


WITH Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select pf_no,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from BOSA.dbo.history  where pf_no= Loanhist.pf_no and ttype=loanhist.ttype) as balance,(select name from BOSA.dbo.lntypes where code=Loanhist.ttype) as description 
from BOSA.dbo.history as Loanhist where left(ttype,1)='L'   and docid not in('203','608')  group by pf_no,ttype 
)

select 
(select top 1 Name from BOSA.dbo.customer  where pf_no= Frequency_CTE.pf_no) as Name,(select top 1 empno from BOSA.dbo.customer  where pf_no= Frequency_CTE.pf_no) as PayrollNo,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference2=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select top 1 REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 ,Frequency_CTE.pf_no as Reference1 into #temp1 from Frequency_CTE where BAlance<>0 ;

 --select * from FOSA.dbo.Loanhist
WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select fosa_acno,ttype,max(trdate) as TrxDate, (select sum(debit-credit) from FOSA.dbo.Loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from FOSA.dbo.lntypes where code=Loanhist1.ttype) 
from FOSA.dbo.Loanhist as Loanhist1 where left(ttype,1)='L' and isnull(credit,0)+isnull(intcr,0)>0 group by fosa_acno,ttype  
)

select 
(select top 1 Name from FOSA.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select top 1 REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 ,Frequency_CTEFOSA.pf_no as Reference1 into #tempFosa from Frequency_CTEFOSA where BAlance<>0 ;

 WITH CombinedCTE (FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
 as
 (
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #Temp1 where balance<>0 

UNION
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #tempFosa where balance<>0
)
Select * into #tempFinal from CombinedCTE 


 SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and ValueDate<=@EndDate),0)*-1 as Balance ,
isnull(iif( @EndDate< '11/03/2018',(select Balance from #tempFinal where FullAccount=dbo.vw_CustomerAccounts.FullAccount),(select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.InterestReceivableChartOfAccountId and ValueDate<=@EndDate)),0)*-1 as InterestAccrued,vw_CustomerAccounts.reference1,
vw_CustomerAccounts.reference2,vw_CustomerAccounts.Reference3, 
iif( @EndDate< '11/03/2018',(select LastActivity from #tempFinal where FullAccount=dbo.vw_CustomerAccounts.FullAccount),(SELECT MAX(dbo.swiftfin_JournalEntries.ValueDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.ValueDate <= @EndDate  and amount<>0 ))) as LastActivity
, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id


select *,datediff(mm,#temp2_.LastActivity,@EndDate) as DefaultFrequency into #temp2 from #temp2_					



--CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

--insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
--select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #Temp1 where balance<>0 and  FullAccount not in (select FullAccount from #temp2_)-----and FullAccount not in (select FullAccount from #temp2)

--insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
--select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #tempFosa where balance<>0 and  FullAccount not in (select FullAccount from #temp2_) ----and FullAccount not in (select FullAccount from #temp2)



select (select top 1 FullName from #temp2_ where FullAccount=temp2.FullAccount order by LastActivity desc) as FullName,(select top 1 balance from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc) as Balance ,Reference2,max(LastActivity) as LastActivity ,
datediff(mm,max(LastActivity),@EndDate) as  DefaultFrequency,FullAccount,LoanName,reference1 into #temp4 from #temp2 temp2 group by Reference2,LoanName,FullAccount,Reference1


select reference1,Fullaccount,fullname,balance,LoanName,max(lastactivity) as lastactivity into #temp3 from #temp4 group by Fullaccount,fullname,balance,LoanName,Reference1;

With CTEFinal(FullName,Balance,LastActivity,ClassOrder,Classification,DefaultFrequency,FullAccount,LoanName,ProductSection,provision_amount,reference1)
as
(
select 
FullName,Balance,LastActivity,
case 
WHEN DATEDIFF(DD,LastActivity,@EndDate)<=30 THEN 1
WHEN DATEDIFF(DD,LastActivity,@EndDate)>30 and DATEDIFF(DD,LastActivity,@EndDate)<=60 THEN 5
WHEN DATEDIFF(DD,LastActivity,@EndDate)>60 and DATEDIFF(DD,LastActivity,@EndDate)<=180 THEN 25
WHEN DATEDIFF(DD,LastActivity,@EndDate)>180 and DATEDIFF(DD,LastActivity,@EndDate)<=360 THEN 50
WHEN DATEDIFF(DD,LastActivity,@EndDate)>360 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(DD,LastActivity,@EndDate)<=30 THEN 'Performing'
WHEN DATEDIFF(DD,LastActivity,@EndDate)>30 and DATEDIFF(DD,LastActivity,@EndDate)<=60THEN 'Watch'
WHEN DATEDIFF(DD,LastActivity,@EndDate)>60 and DATEDIFF(DD,LastActivity,@EndDate)<=180 THEN 'Substandard'
WHEN DATEDIFF(DD,LastActivity,@EndDate)>180 and DATEDIFF(DD,LastActivity,@EndDate)<=360 THEN 'Doubtful'
WHEN DATEDIFF(DD,LastActivity,@EndDate)>360 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,
(select top 1  LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,
case 
WHEN DATEDIFF(DD,LastActivity,@EndDate)<=30 THEN 1
WHEN DATEDIFF(DD,LastActivity,@EndDate)>30 and DATEDIFF(DD,LastActivity,@EndDate)<=60 THEN 5
WHEN DATEDIFF(DD,LastActivity,@EndDate)>60 and DATEDIFF(DD,LastActivity,@EndDate)<=180 THEN 25
WHEN DATEDIFF(DD,LastActivity,@EndDate)>180 and DATEDIFF(DD,LastActivity,@EndDate)<=360 THEN 50
WHEN DATEDIFF(DD,LastActivity,@EndDate)>360 THEN 100 
end *Balance *0.01 as provision_amount,Reference1 
 from #temp3 where fullname is not null and balance<>0 --and DATEDIFF(m,LastActivity,@EndDate)>=@GracePeriod 
)
select 

* from CTEFinal order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName



GO
/****** Object:  StoredProcedure [dbo].[sp_Defaulters_Detailed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



--[sp_Defaulters] 0,'12/31/2015'
create procedure [dbo].[sp_Defaulters_Detailed]
(
	@GracePeriod int=0,
	@EndDate as Datetime
)
as
SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
 with LoanProductBalances (AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,Interest,LoanName)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,sum(Interest) as Interest,LoanName 
	into #temp3_ FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,LoanProductBalances.LoanName having SUM(Balance) <>0;



with  Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	--select fosa_acno,ttype,(select max(trdate)  from hq.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype and docid not in ('2603') and credit>0)  as TrxDate,(select sum(debit-credit) from hq.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from hq.dbo.lntypes where code=Loanhist1.ttype) from hq.dbo.Loanhist as Loanhist1 where left(ttype,1)='L'  group by fosa_acno,ttype 
select fosa_acno,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from hq.dbo.Loanhist  where fosa_acno= Loanhist.fosa_acno and ttype=loanhist.ttype) as balance,(select desc_ from hq.dbo.lntypes where code=Loanhist.ttype) as description from hq.dbo.loanhist as Loanhist where left(ttype,1)='L'   group by fosa_acno,ttype
)

select 
(select Name from hq.dbo.customer  where fosa_acno= Frequency_CTE.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 into #temp1 from Frequency_CTE where BAlance<>0 ;


WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	select fosa_acno,ttype,(select max(trdate)  from hq.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype and docid not in ('2603') )  as TrxDate,(select sum(isnull(debit,0)-isnull(credit,0)) from hq.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from hq.dbo.advtypes where code=Loanhist1.ttype) from hq.dbo.Loanhist as Loanhist1 where left(ttype,1)='A' group by fosa_acno,ttype 
----	select fosa_acno,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from hq.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from hq.dbo.advtypes where code=Loanhist1.ttype) from hq.dbo.Loanhist as Loanhist1 where left(ttype,1)='A'  group by fosa_acno,ttype 
)

select 
(select Name from hq.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 into #tempFosa from Frequency_CTEFOSA where BAlance>0 



 SELECT  vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and CreatedDate<=@EndDate),0)*-1 as Balance ,
vw_CustomerAccounts.Reference1, 
/*
(SELECT        MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate and amount>0)) as LastActivity
*/
isnull((SELECT     top 1    isnull(Duration_EndDate,'08/31/2015')
FROM            dbo.swiftfin_StandingOrders
WHERE        BeneficiaryCustomerAccountId = vw_CustomerAccounts.Id),'08/31/2015') as LastActivity

, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id


select *,datediff(mm,isnull(#temp2_.LastActivity,'08/31/2015'),@EndDate) as DefaultFrequency into #temp2 from #temp2_					



CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

---insert into #temp2(FullName,Balance,Reference1,LastActivity,DefaultFrequency,LoanName,FullAccount) 
---select Name,Balance,pf_no,isnull(LastTrxDate,'08/31/2015'),DefaultFrequency,LoanName,FullAccount from #Temp1 

---insert into #temp2(FullName,Balance,Reference1,LastActivity,DefaultFrequency,LoanName,FullAccount) 
---select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount from #tempFosa  



select *,AccountNo as FullAccount,AccountName as FullName,isnull((select max(lastactivity) from #temp2 where FullAccount=#temp3_.AccountNo and lastactivity<=@EndDate),@EndDate)  as lastactivity into #temp3 from  #temp3_ where balance>0




select distinct FullName,Balance,LastActivity,reference1,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,
(select LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,

case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end *Balance *0.01 as provision_amount
 from #temp3 where  DATEDIFF(m,LastActivity,@EndDate)>=@GracePeriod order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName








GO
/****** Object:  StoredProcedure [dbo].[sp_Defaulters_InsiderLending]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---[sp_Defaulters_InsiderLending] 0,'01/31/2018'
CREATE  procedure [dbo].[sp_Defaulters_InsiderLending]
(
	@GracePeriod int=0,
	@EndDate as Datetime

)
as

SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
 with cteInsider(CustomerID)
as
(
	select customerid from swiftfin_Employees
	union
	select CustomerId from swiftfin_Directors
) select CustomerID into #TempInsider from cteInsider;

 with LoanProductBalances (AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,Interest,LoanName,LoanID,Duration_EndDate)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName, 0 AS Expr1, 
								 SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 AS Amount, dbo.vw_CustomerAccounts.Description,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId, dbo.swiftfin_StandingOrders.Duration_EndDate
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
								 dbo.swiftfin_StandingOrders ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate) and vw_CustomerAccounts.CustomerId in  (select Customerid from #TempInsider)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Description,CustomerAccountType_TargetProductId,swiftfin_StandingOrders.Duration_EndDate
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName, 
								 SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 AS Amount, 0 AS Expr1, dbo.vw_CustomerAccounts.Description,dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId, dbo.swiftfin_StandingOrders.Duration_EndDate
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts AS swiftfin_LoanProducts_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = swiftfin_LoanProducts_1.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND swiftfin_LoanProducts_1.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
								 dbo.swiftfin_StandingOrders ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate) and vw_CustomerAccounts.CustomerId in  (select Customerid from #TempInsider)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Description,CustomerAccountType_TargetProductId,dbo.swiftfin_StandingOrders.Duration_EndDate
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,sum(Interest) as Interest,LoanName,LoanID,Duration_EndDate 
	into #temp3_ FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,Duration_EndDate,LoanProductBalances.LoanName,LoanID having SUM(Balance) +sum(Interest)<>0;

 SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and CreatedDate<=@EndDate),0)*-1 as Balance ,
vw_CustomerAccounts.reference2,  
isnull((SELECT        MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate and amount<>0)), 
 (SELECT        MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate and amount<>0 and swiftfin_Journals.transactioncode=21)))  as LastActivity
, dbo.swiftfin_LoanProducts.Description as LoanName, dbo.swiftfin_LoanProducts.id as LoanID,
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id


select *,datediff(mm,#temp2_.LastActivity,@EndDate) as DefaultFrequency into #temp2 from #temp2_					



select *,AccountNo as FullAccount,AccountName as FullName,iif(#temp3_.Duration_EndDate>getdate(), isnull((select max(lastactivity) from #temp2 where FullAccount=#temp3_.AccountNo and lastactivity<=@EndDate),@EndDate),#temp3_.Duration_EndDate) as lastactivity into #temp3 from  #temp3_


select distinct FullName,Balance ,LastActivity,reference1,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<1 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=1 and DATEDIFF(MM,LastActivity,@EndDate)<2 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=2 and DATEDIFF(MM,LastActivity,@EndDate)<7 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=7 and DATEDIFF(MM,LastActivity,@EndDate)<13 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>13 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<1 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=1 and DATEDIFF(MM,LastActivity,@EndDate)<2 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=2 and DATEDIFF(MM,LastActivity,@EndDate)<7 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=7 and DATEDIFF(MM,LastActivity,@EndDate)<13 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=13 THEN 'Loss'
end as Classification,

DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,LoanID,
(select LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,

case 

WHEN DATEDIFF(MM,LastActivity,@EndDate)<1 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=1 and DATEDIFF(MM,LastActivity,@EndDate)<2 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=2 and DATEDIFF(MM,LastActivity,@EndDate)<7 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=7 and DATEDIFF(MM,LastActivity,@EndDate)<13 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=13 THEN 100
end *Balance *0.01 as provision_amount
 from #temp3 where  DATEDIFF(m,LastActivity,@EndDate)>=@GracePeriod and balance>0  order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName 



GO
/****** Object:  StoredProcedure [dbo].[sp_Defaulters01]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_Defaulters '12/30/2018'
CREATE procedure [dbo].[sp_Defaulters01]
(
	--@GracePeriod int=0,
	@EndDate as Datetime
)

 as
SET NOCOUNT ON;

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


WITH Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select pf_no,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from BOSA.dbo.history  where pf_no= Loanhist.pf_no and ttype=loanhist.ttype) as balance,(select name from BOSA.dbo.lntypes where code=Loanhist.ttype) as description 
from BOSA.dbo.history as Loanhist where left(ttype,1)='L'   and docid not in('203','608')  group by pf_no,ttype 
)

select 
(select top 1 Name from BOSA.dbo.customer  where pf_no= Frequency_CTE.pf_no) as Name,(select top 1 empno from BOSA.dbo.customer  where pf_no= Frequency_CTE.pf_no) as PayrollNo,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference2=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select top 1 REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 ,Frequency_CTE.pf_no as Reference1 into #temp1 from Frequency_CTE where BAlance<>0 ;

 --select * from FOSA.dbo.Loanhist
WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select fosa_acno,ttype,max(trdate) as TrxDate, (select sum(debit-credit) from FOSA.dbo.Loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from FOSA.dbo.lntypes where code=Loanhist1.ttype) 
from FOSA.dbo.Loanhist as Loanhist1 where left(ttype,1)='L' and isnull(credit,0)+isnull(intcr,0)>0 group by fosa_acno,ttype  
)

select 
(select top 1 Name from FOSA.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select top 1 REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 ,Frequency_CTEFOSA.pf_no as Reference1 into #tempFosa from Frequency_CTEFOSA where BAlance<>0 ;

 WITH CombinedCTE (FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
 as
 (
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #Temp1 where balance<>0 

UNION
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #tempFosa where balance<>0
)
Select * into #tempFinal from CombinedCTE 


 SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and ValueDate<=@EndDate),0)*-1 as Balance ,
isnull(iif( @EndDate< '11/03/2018',(select Balance from #tempFinal where FullAccount=dbo.vw_CustomerAccounts.FullAccount),(select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.InterestReceivableChartOfAccountId and ValueDate<=@EndDate)),0)*-1 as InterestAccrued,vw_CustomerAccounts.reference1,
vw_CustomerAccounts.reference2,vw_CustomerAccounts.Reference3, 
iif( @EndDate< '11/03/2018',(select LastActivity from #tempFinal where FullAccount=dbo.vw_CustomerAccounts.FullAccount),(SELECT MAX(dbo.swiftfin_JournalEntries.ValueDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.ValueDate <= @EndDate  and amount<>0 ))) as LastActivity
, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id


select *,datediff(mm,#temp2_.LastActivity,@EndDate) as DefaultFrequency into #temp2 from #temp2_					



--CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

--insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
--select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #Temp1 where balance<>0 and  FullAccount not in (select FullAccount from #temp2_)-----and FullAccount not in (select FullAccount from #temp2)

--insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
--select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #tempFosa where balance<>0 and  FullAccount not in (select FullAccount from #temp2_) ----and FullAccount not in (select FullAccount from #temp2)



select (select top 1 FullName from #temp2_ where FullAccount=temp2.FullAccount order by LastActivity desc) as FullName,(select top 1 balance from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc) as Balance ,Reference2,max(LastActivity) as LastActivity ,
datediff(mm,max(LastActivity),@EndDate) as  DefaultFrequency,FullAccount,LoanName,reference1 into #temp4 from #temp2 temp2 group by Reference2,LoanName,FullAccount,Reference1


select reference1,Fullaccount,fullname,balance,LoanName,max(lastactivity) as lastactivity into #temp3 from #temp4 group by Fullaccount,fullname,balance,LoanName,Reference1;

With CTEFinal(FullName,Balance,LastActivity,ClassOrder,Classification,DefaultFrequency,FullAccount,LoanName,ProductSection,provision_amount,reference1)
as
(
select 
FullName,Balance,LastActivity,
case 
WHEN DATEDIFF(DD,LastActivity,@EndDate)<=30 THEN 1
WHEN DATEDIFF(DD,LastActivity,@EndDate)>30 and DATEDIFF(DD,LastActivity,@EndDate)<=60 THEN 5
WHEN DATEDIFF(DD,LastActivity,@EndDate)>60 and DATEDIFF(DD,LastActivity,@EndDate)<=180 THEN 25
WHEN DATEDIFF(DD,LastActivity,@EndDate)>180 and DATEDIFF(DD,LastActivity,@EndDate)<=360 THEN 50
WHEN DATEDIFF(DD,LastActivity,@EndDate)>360 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(DD,LastActivity,@EndDate)<=30 THEN 'Performing'
WHEN DATEDIFF(DD,LastActivity,@EndDate)>30 and DATEDIFF(DD,LastActivity,@EndDate)<=60THEN 'Watch'
WHEN DATEDIFF(DD,LastActivity,@EndDate)>60 and DATEDIFF(DD,LastActivity,@EndDate)<=180 THEN 'Substandard'
WHEN DATEDIFF(DD,LastActivity,@EndDate)>180 and DATEDIFF(DD,LastActivity,@EndDate)<=360 THEN 'Doubtful'
WHEN DATEDIFF(DD,LastActivity,@EndDate)>360 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,
(select top 1  LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,
case 
WHEN DATEDIFF(DD,LastActivity,@EndDate)<=30 THEN 1
WHEN DATEDIFF(DD,LastActivity,@EndDate)>30 and DATEDIFF(DD,LastActivity,@EndDate)<=60 THEN 5
WHEN DATEDIFF(DD,LastActivity,@EndDate)>60 and DATEDIFF(DD,LastActivity,@EndDate)<=180 THEN 25
WHEN DATEDIFF(DD,LastActivity,@EndDate)>180 and DATEDIFF(DD,LastActivity,@EndDate)<=360 THEN 50
WHEN DATEDIFF(DD,LastActivity,@EndDate)>360 THEN 100 
end *Balance *0.01 as provision_amount,Reference1 
 from #temp3 where fullname is not null and balance<>0 --and DATEDIFF(m,LastActivity,@EndDate)>=@GracePeriod 
)
select 

* from CTEFinal order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName


GO
/****** Object:  StoredProcedure [dbo].[sp_DefaultersCategorised]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---select * from swiftfin_branches
--select * from swiftfin_customers

--[sp_DefaultersCategorised] 0,'05/14/2018'
CREATE procedure [dbo].[sp_DefaultersCategorised]
(
	@GracePeriod int=0,
	@EndDate as Datetime

)
as
SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
 with LoanProductBalances (AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,Interest,LoanName,branch)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId),
		swiftfin_Branches.id
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								  dbo.swiftfin_branches on dbo.vw_CustomerAccounts.BranchId=dbo.swiftfin_branches.id inner join
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)  
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId,swiftfin_Branches.id
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId),
		swiftfin_Branches.id
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								  dbo.swiftfin_branches on dbo.vw_CustomerAccounts.BranchId=dbo.swiftfin_branches.id inner join
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId,swiftfin_Branches.id
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,
	sum(Interest) as Interest,LoanName,branch
	into #temp3_ FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,LoanProductBalances.LoanName,branch having SUM(Balance) <>0;



with  Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	select top 1 fosa_acno,ttype,(select max(trdate)  from FOSA.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype 
	and docid not in ('2603') and credit>0 )  as TrxDate,(select sum(debit-credit) from FOSA.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno 
	and ttype=Loanhist1.ttype) as balance,(select accountname from FOSA.dbo.lntypes1 where code=Loanhist1.ttype) from FOSA.dbo.Loanhist as Loanhist1 where left(ttype,1)='L'   group by fosa_acno,ttype 

)

select 
(select Name from FOSA.dbo.customer  where fosa_acno= Frequency_CTE.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 into #temp1 from Frequency_CTE where BAlance<>0 ;


WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	select top 1 fosa_acno,ttype,(select max(trdate)  from FOSA.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype and docid not in ('2603') ) 
	 as TrxDate,(select sum(isnull(debit,0)-isnull(credit,0)) from FOSA.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select top 1 accountname from 
	 FOSA.dbo.lntypes1 where code=Loanhist1.ttype) from FOSA.dbo.Loanhist as Loanhist1 where left(ttype,1)='A' group by fosa_acno,ttype 

)

select 
(select Name from FOSA.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 into #tempFosa from Frequency_CTEFOSA where BAlance>0 




SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and CreatedDate<=@EndDate),0)*-1 as Balance ,
vw_CustomerAccounts.reference1, (SELECT        MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate and amount>0)) as LastActivity
, dbo.swiftfin_LoanProducts.Description as LoanName,dbo.vw_CustomerAccounts.FullAccount,swiftfin_Branches.id as branch
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id inner join
						 swiftfin_branches on dbo.vw_CustomerAccounts.BranchId=swiftfin_branches.id



select *,datediff(mm,isnull(#temp2_.LastActivity,'05/11/2018'),@EndDate) as DefaultFrequency into #temp2 from #temp2_	


 

CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

insert into #temp2(FullName,Balance,Reference1,LastActivity,DefaultFrequency,LoanName,FullAccount,branch) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,(select top 1 id from swiftfin_Branches) from #Temp1  ---where FullAccount not in (select FullAccount from #temp2)

insert into #temp2(FullName,Balance,Reference1,LastActivity,DefaultFrequency,LoanName,FullAccount,branch) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,(select top 1 id from swiftfin_Branches) from #tempFosa ---- where FullAccount not in (select FullAccount from #temp2) 



select *,AccountNo as FullAccount,AccountName as FullName,isnull((select max(lastactivity) from #temp2 where FullAccount=#temp3_.AccountNo and 
lastactivity<=@EndDate),@EndDate)  as lastactivity into #temp3 from  #temp3_ where balance>0





select distinct FullName,Balance,LastActivity,reference1,branch,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=1 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>1 and DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=1 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>1 and DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,
(select top 1  LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=1 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>1 and DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end *Balance *0.01 as provision_amount
 from #temp3 where  DATEDIFF(m,LastActivity,@EndDate)>=@GracePeriod order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName






GO
/****** Object:  StoredProcedure [dbo].[Sp_DefaultersList]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--0101-001-01182
--select * from swiftfin_asmasloandata order by fosa_acno
--update swiftfin_asmasloandata set actualinterestpaid=0 where actualinterestpaid is null
--select * from swiftfin_standingorders
--select * from swiftfin_Customers where SerialNumber='15755'
--exec [Sp_DefaultersList] '6/30/2018' 



CREATE  Procedure [dbo].[Sp_DefaultersList](@EndDate DateTime) as
--drop table #tempx
--drop table #temp8
--select * from swiftfin_LoanProducts
SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

WITH CTEList (interestmode,PaymentFrequencyPerYear,DateOfBirth,Reference1,Reference2,Reference3,[Account Name],CustomerAccountID,LoanName,Principal,LoanAmount,PaymentPerPeriod,Balance,Interest,interestpaid1,LoanTerm,Term2,rate,category,StartDate,PeriodElapsed,EndDate,CustomerID,LoanProductID,interestchartofaccountid,Employer,Shares)
as
(
	SELECT       dbo.swiftfin_LoanProducts.LoanInterest_CalculationMode, 
	case dbo.swiftfin_LoanProducts.LoanRegistration_PaymentFrequencyPerYear 
when 1 then	'Annual'
when 2	then 'Semi-Annual' 
when 3 then	'Quarterly' 
when 4	then 'Tri-Annual' 
when 6	then 'Bi-Monthly'
when 12 then 'Monthly'
when 24	then 'Semi-Monthly' 
when 26	then 'Bi-Weekly' 
when 52	then 'Weekly'
when 365 then'Daily' end ,
	
	dbo.vw_CustomerAccounts.Individual_BirthDate,dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Individual_PayrollNumbers, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Id, dbo.swiftfin_LoanProducts.Description,
							 dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod, 
							 isnull(SUM(dbo.swiftfin_JournalEntries.Amount),0)*-1 AS Balance,
							 (select isnull(sum(Amount),0) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId =swiftfin_LoanProducts.InterestReceivableChartOfAccountId)*-1 as InterestBalance,
							 (select isnull(sum(Amount),0) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId =swiftfin_LoanProducts.InterestReceivableChartOfAccountId and isnull(amount,0)*-1<0 and 
							 swiftfin_JournalEntries.createddate>=swiftfin_StandingOrders.Duration_StartDate and swiftfin_JournalEntries.ValueDate<=@EndDate) as Interestpaid1

							 ,dbo.swiftfin_LoanProducts.LoanRegistration_TermInMonths,(LoanRegistration_TermInMonths+1) as Term2,dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductCategory,
							 Duration_StartDate as StartDate,
							 --iif(DATEDIFF(mm,duration_startdate,@EndDate)>LoanRegistration_TermInMonths,LoanRegistration_TermInMonths,dATEDIFF(mm,duration_startdate,@EndDate)) as MonthElapsed,
							 --iif(duration_startdate>@EndDate,0,DATEDIFF(mm,(dateadd(mm,0,duration_startdate)),@EndDate)) as MonthElapsed,eomonth(Duration_EndDate),
							 iif(duration_startdate>@EndDate,0,floor((DATEDIFF(dd,duration_startdate,@EndDate))/30)) as MonthElapsed,eomonth(Duration_EndDate),
							 dbo.vw_CustomerAccounts.CustomerId,CustomerAccountType_TargetProductId,swiftfin_LoanProducts.InterestReceivableChartOfAccountId,dbo.vw_CustomerAccounts.EmployerDescription,
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_InvestmentProducts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id AND dbo.swiftfin_InvestmentProducts.Id = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId
WHERE        (dbo.swiftfin_InvestmentProducts.Id = 'DCAD574A-B94B-4CC6-9E09-F936CCE0189D') and  dbo.swiftfin_CustomerAccounts.CustomerId=vw_CustomerAccounts.CustomerId),0) as Shares
						 --select * from swiftfin_InvestmentProducts
						
	FROM            dbo.vw_CustomerAccounts INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id inner JOIN
							 dbo.swiftfin_StandingOrders ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId INNER JOIN
							 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId and
							 isnull(dbo.swiftfin_StandingOrders.islocked,0)=0 and dbo.swiftfin_JournalEntries.ValueDate<=@EndDate


	GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.EmployerDescription, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Individual_PayrollNumbers, dbo.vw_CustomerAccounts.AccountName, dbo.vw_CustomerAccounts.Id, 
							 dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.LoanAmount, dbo.swiftfin_StandingOrders.PaymentPerPeriod,LoanRegistration_TermInMonths,
							 duration_startdate,FullName,Duration_EndDate,swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId,
							 dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductCategory, dbo.vw_CustomerAccounts.CustomerId,CustomerAccountType_TargetProductId,swiftfin_LoanProducts.InterestReceivableChartOfAccountId,
							 dbo.vw_CustomerAccounts.Individual_BirthDate,dbo.swiftfin_LoanProducts.LoanInterest_CalculationMode,dbo.swiftfin_LoanProducts.LoanRegistration_PaymentFrequencyPerYear 
)
select *,iif((isnull(PaymentPerPeriod,0)*PeriodElapsed)>balance,balance,isnull(PaymentPerPeriod,0)*PeriodElapsed) as BalanceExpected,
--select *,(isnull(PaymentPerPeriod,0)*PeriodElapsed) as BalanceExpected,

case
WHEN interestmode=512 then floor((nullif(LoanAmount,0)*rate/12*TERM2)/200) 
else
((PaymentPerPeriod*LoanTerm)-LoanAmount) end as  expectedInterest,
case
WHEN interestmode=512 then (floor((nullif(LoanAmount,0)*rate/12*TERM2)/200)+LoanAmount) 
else
(PaymentPerPeriod*LoanTerm) end as TotalLoanInterest,
case
WHEN category=0  THEN isnull(LoanAmount,0)-isnull(Balance,0)  else

isnull(LoanAmount,0)-isnull(Balance,0) end [Balance Paid],

--(floor((nullif(LoanAmount,0)*rate/12*TERM2)/200)+LoanAmount)-isnull(Balance,0) end [Balance Paid],

iif(isnull(startdate,'')<'05/12/2018',
		(select top 1 isnull(actualinterestpaid,0) from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID order by issue_date desc),0
		
	)[Interest Paid],

	
iif(startdate<'05/12/2018',
		(select top 1 isnull(Loan_officer,'Unknown') from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID order by issue_date desc ) ,
		(select top 1 Approvedby from swiftfin_LoanCases where LoanProductID=CTEList.LoanProductID and CustomerID=CTEList.CustomerID and ApprovedDate<=@EndDate  order by ApprovedDate desc )
	)[Loan Officer],
		
isnull(iif(startdate<'05/12/2018',
		(select top 1 loan_guarantors from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID order by issue_date desc) ,
		(select sum(Amountguaranteed) from swiftfin_LoanGuarantors where LoanProductID=CTEList.LoanProductID and CustomerID=CTEList.CustomerID)
	),0)[Amount Guaranteed],

	iif(startdate<'05/12/2018',
		(select top 1 LoanNo from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID order by issue_date desc) ,
		(select top 1 str(casenumber) from swiftfin_LoanCases where LoanProductID=CTEList.LoanProductID and CustomerID=CTEList.CustomerID and ApprovedDate<=@EndDate  order by ApprovedDate desc )
	)[Loan No],

	iif(startdate<'05/12/2018',
		(select top 1 amortization_type from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID order by issue_date desc) ,'Amortization'
		--(select top 1 str(casenumber) from swiftfin_LoanCases where LoanProductID=CTEList.LoanProductID and CustomerID=CTEList.CustomerID and ApprovedDate<=@EndDate  order by ApprovedDate desc )
	)[Amortization Type]

				--(select LoanNo from swiftfin_AsmasLoanData where customerid=CTEList.CustomerID and LoanProductID=CTEList.LoanProductID) [Loan No]

into #temp8 from CTEList

--select *,iif(round(BalanceExpected-([balance paid]+[Interest Paid]),0)<0,0,round(BalanceExpected-[balance paid],0)) as DefaultedAmount,iif(round((BalanceExpected-[balance paid])/nullif(principal,0),0)<0,0,round((BalanceExpected-[balance paid])/nullif(principal,0),0)) as DefaulFrequency
 select *,iif(round(BalanceExpected-[balance paid]-[Interest Paid]-interestpaid1,0)<0,0,round(BalanceExpected-[balance paid]-isnull([Interest Paid],0)-interestpaid1,0)) as DefaultedAmount,



 case when #temp8.balance<0 then 0

 when DATEDIFF(dd,#temp8.startdate,@EndDate)<30 then 0

 --when left(#temp8.LoanName,3)='A15' then 0
 
 when dateadd(mm,0,#temp8.EndDate)<@EndDate then 13 

 
 
 when #temp8.StartDate>@EndDate then 0

 --when left(#temp8.LoanName,3)='A19' then 0
 -- when #temp8.LoanName like '%E-Loan%' and #temp8.EndDate<=@EndDate and #temp8.Balance>0 then #temp8.PeriodElapsed
  else

 iif(round((BalanceExpected-[balance paid]-isnull([Interest Paid],0)-isnull(interestpaid1,0))/nullif(paymentperperiod,0),0)<0,0,round((BalanceExpected-[balance paid]-isnull([Interest Paid],0)-interestpaid1)/nullif(paymentperperiod,0),0)) end as DefaulFrequency
 



 into #tempx from #temp8 where Balance<>0 

 

select  *,  
----reference1,reference2,reference3,[Account Name],CustomerAccountID,LoanName,Principal,LoanAmount,PaymentPerPeriod,Balance,interest,
----LoanTerm,StartDate,EndDate,iif(BalanceExpected>balance,BalanceExpected,balance),[Balance Paid] ,iif(DefaultedAmount>balance,DefaultedAmount,balance),
----DefaulFrequency,
case 
WHEN DefaulFrequency< 1 THEN 1
WHEN DefaulFrequency=1  THEN 5
WHEN DefaulFrequency>1 and DefaulFrequency<=6 THEN 25
WHEN DefaulFrequency>6 and DefaulFrequency<=12 THEN 50
WHEN DefaulFrequency>12 THEN 100
end as ClassOrder

,case 
WHEN DefaulFrequency <1 THEN 'Performing'
WHEN DefaulFrequency=1  THEN 'Watch'
WHEN DefaulFrequency>1 and DefaulFrequency<=6 THEN 'Substandard'
WHEN DefaulFrequency>6 and DefaulFrequency<=12 THEN 'Doubtful'
WHEN DefaulFrequency>12 THEN 'Loss'
end as Classification,


case 

WHEN DefaulFrequency<1 THEN 1
WHEN DefaulFrequency=1 and DefaulFrequency<=4 THEN 5
WHEN DefaulFrequency>1 and DefaulFrequency<=6 THEN 25
WHEN DefaulFrequency>6 and DefaulFrequency<=12 THEN 50
WHEN DefaulFrequency>12 THEN 100
end *Balance *0.01 as provision_amount



from #tempx    where balance<>0 order by classorder,Reference1
--and reference1='001-015755-001-001' order by Reference1---ClassOrder--and reference1='001-014925-001-001'--
drop table #tempx 
drop table #temp8

---where reference1='0101-001-00650'--

--select * from #tempx where balance<0
--where left(LoanName,3) IN('ADV','BAN')
--where left(LoanName,3) IN('A19','A51')

--,ceiling(DefaultedAmount),ceiling(DefaulFrequency),ClassOrder,Classification,provision_amount from #temp1
--order by DefaulFrequency




GO
/****** Object:  StoredProcedure [dbo].[sp_Defaultersmine]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_Defaulters 0,'09/30/2015'
create procedure [dbo].[sp_Defaultersmine]
(
 @GracePeriod int=0,
 @EndDate as Datetime
)

 as
SET NOCOUNT ON;

set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


WITH Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select pf_no,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from bosa.dbo.history  where pf_no= Loanhist.pf_no and ttype=loanhist.ttype) as balance,(select top 1 name from bosa.dbo.lntypes where code=Loanhist.ttype) as description from Bosa.dbo.history as Loanhist where left(ttype,1)='L'   and docid not in('203','608')  group by pf_no,ttype 
)

select 
(select top 1 Name from bosa.dbo.customer  where pf_no= Frequency_CTE.pf_no) as Name,(select top 1  empno from bosa.dbo.customer  where pf_no= Frequency_CTE.pf_no) as PayrollNo,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference2=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 ,Frequency_CTE.pf_no as Reference1 into #temp1 from Frequency_CTE where BAlance<>0 ;


WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
 select fosa_acno,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from fosa.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select top 1 desc_ from fosa.dbo.lntypes where code=Loanhist1.ttype) from fosa.dbo.Loanhist as Loanhist1 where left(ttype,1)='L' and isnull(credit,0)>0 group by fosa_acno,ttype  
)

select 
(select top 1 Name from fosa.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 ,Frequency_CTEFOSA.pf_no as Reference1 into #tempFosa from Frequency_CTEFOSA where BAlance<>0 


 SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and CreatedDate<=@EndDate),0)*-1 as Balance ,
 isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.InterestReceivableChartOfAccountId and CreatedDate<=@EndDate),0)*-1 as InterestAccrued,vw_CustomerAccounts.reference1,
vw_CustomerAccounts.reference2,vw_CustomerAccounts.Reference3,
((SELECT      MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate  and amount>0 )  ))
						
        as LastActivity 
, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id


select *,datediff(mm,#temp2_.LastActivity,@EndDate) as DefaultFrequency into #temp2 from #temp2_ 

select *,datediff(mm,#temp2_.LastActivity,@EndDate) as DefaultFrequency into #temp2X from #temp2_    



CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount) 
select Name,0,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount from #Temp1 -- and  FullAccount not in (select FullAccount from #temp2_)-----and FullAccount not in (select FullAccount from #temp2)

insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount) 
select Name,0,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount from #tempFosa   --- and  FullAccount not in (select FullAccount from #temp2_) ----and FullAccount not in (select FullAccount from #temp2)


select  (select top 1 FullName from #temp2x where FullAccount=temp2.FullAccount order by LastActivity desc) as FullName,(select top 1 balance from #temp2X where FullAccount=temp2.FullAccount order by balance desc) as Balance ,Reference2,(select top 1 LastActivity from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc) as LastActivity ,datediff(mm,(select top 1 LastActivity from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc),@EndDate) as  DefaultFrequency,FullAccount,LoanName into #temp4 from #temp2X temp2 


select Fullaccount,fullname,balance,LoanName,max(lastactivity) as lastactivity into #temp3 from #temp4 group by Fullaccount,fullname,balance,LoanName;

With CTEFinal(FullName,Balance,LastActivity,ClassOrder,Classification,DefaultFrequency,FullAccount,LoanName,ProductSection,provision_amount)
as
(
select 
FullName,Balance,LastActivity,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,
(select LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end *Balance *0.01 as provision_amount 
 from #temp3 where fullname is not null and balance<>0 and DATEDIFF(m,LastActivity,@EndDate)>=@GracePeriod 
)
select 
--(select top 1 space(30) from vw_CustomerAccounts where FullAccount=CTEFinal.FullAccount) as EmployerName,
(select top 1 Reference1 from swiftfin_customers where SerialNumber=substring(CTEFinal.FullAccount,5,6)) as Reference1,
* from CTEFinal order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName






GO
/****** Object:  StoredProcedure [dbo].[sp_Defaultersstgingserver]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--[sp_Defaulters] 0,'12/31/2015'
create procedure [dbo].[sp_Defaultersstgingserver]
(
	@GracePeriod int=0,
	@EndDate as Datetime
)
as
SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
 with LoanProductBalances (AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,Interest,LoanName)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,sum(Interest) as Interest,LoanName 
	into #temp3_ FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,LoanProductBalances.LoanName having SUM(Balance) <>0;



with  Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	select fosa_acno,ttype,(select max(trdate)  from hq.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype and docid not in ('2603') and credit>0)  as TrxDate,(select sum(debit-credit) from hq.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from hq.dbo.lntypes where code=Loanhist1.ttype) from hq.dbo.Loanhist as Loanhist1 where left(ttype,1)='L'  group by fosa_acno,ttype 
---	select fosa_acno,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from hq.dbo.Loanhist  where fosa_acno= Loanhist.fosa_acno and ttype=loanhist.ttype) as balance,(select desc_ from hq.dbo.lntypes where code=Loanhist.ttype) as description from hq.dbo.loanhist as Loanhist where left(ttype,1)='L'   group by fosa_acno,ttype
)

select 
(select Name from hq.dbo.customer  where fosa_acno= Frequency_CTE.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 into #temp1 from Frequency_CTE where BAlance<>0 ;


WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	select fosa_acno,ttype,(select max(trdate)  from hq.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype and docid not in ('2603') )  as TrxDate,(select sum(isnull(debit,0)-isnull(credit,0)) from hq.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from hq.dbo.advtypes where code=Loanhist1.ttype) from hq.dbo.Loanhist as Loanhist1 where left(ttype,1)='A' group by fosa_acno,ttype 
----	select fosa_acno,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from hq.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from hq.dbo.advtypes where code=Loanhist1.ttype) from hq.dbo.Loanhist as Loanhist1 where left(ttype,1)='A'  group by fosa_acno,ttype 
)

select 
(select Name from hq.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 into #tempFosa from Frequency_CTEFOSA where BAlance>0 



 SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and CreatedDate<=@EndDate),0)*-1 as Balance ,
vw_CustomerAccounts.Reference1, 
/*
(SELECT        MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate and amount>0)) as LastActivity
*/
isnull((SELECT     top 1    isnull(Duration_EndDate,'08/31/2015')
FROM            dbo.swiftfin_StandingOrders
WHERE        BeneficiaryCustomerAccountId = vw_CustomerAccounts.Id),'08/31/2015') as LastActivity

, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id


select *,datediff(mm,isnull(#temp2_.LastActivity,'08/31/2015'),@EndDate) as DefaultFrequency into #temp2 from #temp2_					



CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

---insert into #temp2(FullName,Balance,Reference1,LastActivity,DefaultFrequency,LoanName,FullAccount) 
---select Name,Balance,pf_no,isnull(LastTrxDate,'08/31/2015'),DefaultFrequency,LoanName,FullAccount from #Temp1 

---insert into #temp2(FullName,Balance,Reference1,LastActivity,DefaultFrequency,LoanName,FullAccount) 
---select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount from #tempFosa  



select *,AccountNo as FullAccount,AccountName as FullName,isnull((select max(lastactivity) from #temp2 where FullAccount=#temp3_.AccountNo and lastactivity<=@EndDate),@EndDate)  as lastactivity into #temp3 from  #temp3_ where balance>0




select distinct FullName,Balance,LastActivity,reference1,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,
(select LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,

case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>=3 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end *Balance *0.01 as provision_amount
 from #temp3 where  DATEDIFF(m,LastActivity,@EndDate)>=@GracePeriod order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName








GO
/****** Object:  StoredProcedure [dbo].[sp_DefaultersSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_DefaultersSummary 0,'11/23/2015'
CREATE procedure [dbo].[sp_DefaultersSummary]
(
	@GracePeriod int=0,
	@EndDate as Datetime
)

 as
SET NOCOUNT ON;

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


WITH Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select pf_no,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from BOSA.dbo.history  where pf_no= Loanhist.pf_no and ttype=loanhist.ttype) as balance,(select name from BOSA.dbo.lntypes where code=Loanhist.ttype) as description 
from BOSA.dbo.history as Loanhist where left(ttype,1)='L'   and docid not in('203','608')  group by pf_no,ttype 
)

select 
(select top 1 Name from BOSA.dbo.customer  where pf_no= Frequency_CTE.pf_no) as Name,(select top 1 empno from BOSA.dbo.customer  where pf_no= Frequency_CTE.pf_no) as PayrollNo,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference2=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select top 1 REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 ,Frequency_CTE.pf_no as Reference1 into #temp1 from Frequency_CTE where BAlance<>0 ;

 --select * from FOSA.dbo.Loanhist
WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
select fosa_acno,ttype,max(trdate) as TrxDate, (select sum(debit-credit) from FOSA.dbo.Loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from FOSA.dbo.lntypes where code=Loanhist1.ttype) 
from FOSA.dbo.Loanhist as Loanhist1 where left(ttype,1)='L' and isnull(credit,0)+isnull(intcr,0)>0 group by fosa_acno,ttype  
)

select 
(select top 1 Name from FOSA.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select top 1 REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 ,Frequency_CTEFOSA.pf_no as Reference1 into #tempFosa from Frequency_CTEFOSA where BAlance<>0 


 SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and ValueDate<=@EndDate),0)*-1 as Balance ,
 isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.InterestReceivableChartOfAccountId and ValueDate<=@EndDate),0)*-1 as InterestAccrued,vw_CustomerAccounts.reference1,
vw_CustomerAccounts.reference2,vw_CustomerAccounts.Reference3, (SELECT MAX(dbo.swiftfin_JournalEntries.ValueDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.ValueDate <= @EndDate  and amount<>0 )) as LastActivity
, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id


select *,datediff(mm,#temp2_.LastActivity,@EndDate) as DefaultFrequency into #temp2 from #temp2_					



CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #Temp1 where balance<>0 and  FullAccount not in (select FullAccount from #temp2_)-----and FullAccount not in (select FullAccount from #temp2)

insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount,reference1) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount,reference1 from #tempFosa where balance<>0 and  FullAccount not in (select FullAccount from #temp2_) ----and FullAccount not in (select FullAccount from #temp2)


select  (select top 1 FullName from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc) as FullName,(select top 1 balance from #temp2 where FullAccount=temp2.FullAccount order by balance desc) as Balance ,Reference2,(select top 1 LastActivity from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc) as LastActivity ,datediff(mm,(select top 1 LastActivity from #temp2 where FullAccount=temp2.FullAccount order by LastActivity desc),@EndDate) as  DefaultFrequency,FullAccount,LoanName into #temp4 from #temp2 temp2 


select Fullaccount,fullname,balance,LoanName,max(lastactivity) as lastactivity into #temp3 from #temp4 group by Fullaccount,fullname,balance,LoanName;

select FullName,Balance,LastActivity,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=1 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>1 and DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end as ClassOrder
,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=1 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>1 and DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName into #temp5 from #temp3 where fullname is not null and balance<>0 and DATEDIFF(MM,LastActivity,@EndDate)>=@GracePeriod order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName

select Classification,count(fullaccount)as No_Of_Accounts,sum(Balance) as Balance,ClassOrder as [provision],sum(Balance)*ClassOrder*0.01 as provision_amount from #temp5
Group by Classification,ClassOrder order by ClassOrder



GO
/****** Object:  StoredProcedure [dbo].[sp_DefaultersSummary_Insider]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


---select * from swiftfin_Employees
--- sp_DefaultersSummary 0,'10/17/2017'
CREATE procedure [dbo].[sp_DefaultersSummary_Insider]
(
	@GracePeriod int=0,
	@EndDate as Datetime
)

 as
SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
with cteInsider(CustomerID)
as
(
	select customerid from swiftfin_Employees
	union
	select CustomerId from swiftfin_Directors
) select CustomerID into #TempInsider from cteInsider;

 with LoanProductBalances (AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,Interest,LoanName)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)  and vw_CustomerAccounts.CustomerId in (select Customerid from #TempInsider)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate) and vw_CustomerAccounts.CustomerId in (select Customerid from #TempInsider)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,sum(Interest) as Interest,LoanName 
	into #temp3_ FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,LoanProductBalances.LoanName having SUM(Balance) +sum(Interest)<>0;



with  Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	select fosa_acno,ttype,(select max(trdate)  from Testfosa.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype and docid not in ('2603') and credit+debit>0 )  as TrxDate,(select sum(debit-credit) from Testfosa.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from Testfosa.dbo.lntypes where code=Loanhist1.ttype) from Testfosa.dbo.Loanhist as Loanhist1 where left(ttype,1)='L'   group by fosa_acno,ttype 
---	select fosa_acno,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from Testfosa.dbo.Loanhist  where fosa_acno= Loanhist.fosa_acno and ttype=loanhist.ttype) as balance,(select desc_ from Testfosa.dbo.lntypes where code=Loanhist.ttype) as description from Testfosa.dbo.loanhist as Loanhist where left(ttype,1)='L'   group by fosa_acno,ttype
)

select 
(select Name from Testfosa.dbo.customer  where fosa_acno= Frequency_CTE.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 into #temp1 from Frequency_CTE where BAlance<>0 ;


WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	select fosa_acno,ttype,(select max(trdate)  from Testfosa.dbo.loanhist  where fosa_acno=loanhist1.fosa_acno and ttype=loanhist1.ttype and docid not in ('2603')and credit+debit>0 )  as TrxDate,(select sum(isnull(debit,0)-isnull(credit,0)) from Testfosa.dbo.loanhist  where fosa_acno= loanhist1.fosa_acno and ttype=loanhist1.ttype) as balance,(select desc_ from Testfosa.dbo.LNTYPES where code=Loanhist1.ttype) from Testfosa.dbo.Loanhist as Loanhist1 where left(ttype,1)='A' group by fosa_acno,ttype 
----	select fosa_acno,ttype,max(trdate) as TrxDate,(select sum(debit-credit) from Testfosa.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from Testfosa.dbo.advtypes where code=Loanhist1.ttype) from Testfosa.dbo.Loanhist as Loanhist1 where left(ttype,1)='A'  group by fosa_acno,ttype 
)

select 
(select Name from Testfosa.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
 ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
 into #tempFosa from Frequency_CTEFOSA ---where BAlance>0 

 

 SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and CreatedDate<=@EndDate),0)*-1 as Balance ,
vw_CustomerAccounts.reference2,  
isnull((SELECT        MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate and amount<>0)), 
 (SELECT        MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate and amount<>0 and swiftfin_Journals.transactioncode=21)))  as LastActivity
, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id



select *,datediff(mm,#temp2_.LastActivity,@EndDate) as DefaultFrequency into #temp2 from #temp2_					



CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount from #Temp1  ---where FullAccount not in (select FullAccount from #temp2)

insert into #temp2(FullName,Balance,Reference2,LastActivity,DefaultFrequency,LoanName,FullAccount) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount from #tempFosa ---- where FullAccount not in (select FullAccount from #temp2) 



select *,AccountNo as FullAccount,AccountName as FullName,isnull((select max(lastactivity) from #temp2 where FullAccount=#temp3_.AccountNo and lastactivity<=@EndDate),@EndDate)  as lastactivity into #temp3 from  #temp3_



select FullName,Balance,LastActivity,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=1 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>1 and DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=5 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>5 and DATEDIFF(MM,LastActivity,@EndDate)<=11 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>11 THEN 100
end as ClassOrder
,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=1 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>1 and DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=5 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>5 and DATEDIFF(MM,LastActivity,@EndDate)<=11 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>11 THEN 'Loss'
end as Classification,
DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName into #temp5 from #temp3 where fullname is not null  and DATEDIFF(MM,LastActivity,@EndDate)>=@GracePeriod order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName

select Classification,count(FullName)as No_Of_Accounts,sum(Balance) as Balance,ClassOrder as [provision],sum(Balance)*ClassOrder*0.01 as provision_amount from #temp5
whEre Balance>0
Group by Classification,ClassOrder order by ClassOrder

--select * from Testfosa.dbo.lntypes





GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteCreditBatchDiscrepancies]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	DeleteCreditBatchEntries
-- =============================================
create PROCEDURE [dbo].[sp_DeleteCreditBatchDiscrepancies] 
	-- Add the parameters for the stored procedure here
	@CreditBatchID uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DELETE 
	FROM swiftfin_CreditBatchDiscrepancies 
	WHERE CreditBatchId=@CreditBatchID
END







GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteCreditBatchEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	DeleteCreditBatchEntries
-- =============================================
CREATE PROCEDURE [dbo].[sp_DeleteCreditBatchEntries] 
	-- Add the parameters for the stored procedure here
	@CreditBatchID varchar(100)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DELETE 
	FROM swiftfin_CreditBatchEntries 
	WHERE CreditBatchId=@CreditBatchID
END







GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteDebitBatchEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	DeleteDebitBatchEntries
-- =============================================
CREATE PROCEDURE [dbo].[sp_DeleteDebitBatchEntries] 
	-- Add the parameters for the stored procedure here
	@DebitBatchID varchar(100)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DELETE 
	FROM swiftfin_DebitBatchEntries 
	WHERE DebitBatchId=@DebitBatchID
END







GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteJournalReversalBatchEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	DeleteCreditBatchEntries
-- =============================================
create PROCEDURE [dbo].[sp_DeleteJournalReversalBatchEntries] 
	-- Add the parameters for the stored procedure here
	@JournalReversalBatchId uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DELETE 
	FROM swiftfin_JournalReversalBatchEntries 
	WHERE JournalReversalBatchId=@JournalReversalBatchId
END







GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteLoanDisbursementBatchEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	DeleteLoanDisbursementBatchEntries
-- =============================================
CREATE PROCEDURE [dbo].[sp_DeleteLoanDisbursementBatchEntries] 
	-- Add the parameters for the stored procedure here
	@LoanDisbursementBatchID uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DELETE 
	FROM swiftfin_LoanDisbursementBatchEntries 
	WHERE LoanDisbursementBatchId=@LoanDisbursementBatchID
END








GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteOverDeductionBatchDiscrepancies]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	DeleteOverDeductionBatchDiscrepancies
-- =============================================
CREATE PROCEDURE [dbo].[sp_DeleteOverDeductionBatchDiscrepancies] 
	-- Add the parameters for the stored procedure here
	@OverDeductionBatchID uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DELETE 
	FROM swiftfin_OverDeductionBatchDiscrepancies 
	WHERE OverDeductionBatchId=@OverDeductionBatchID
END




GO
/****** Object:  StoredProcedure [dbo].[sp_DeleteOverDeductionBatchEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- ALTER date: 03.06.2014
-- Description:	DeleteOverDeductionBatchEntries
-- =============================================
CREATE PROCEDURE [dbo].[sp_DeleteOverDeductionBatchEntries] 
	-- Add the parameters for the stored procedure here
	@OverDeductionBatchId varchar(100)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	DELETE 
	FROM swiftfin_OverDeductionBatchEntries 
	WHERE OverDeductionBatchId=@OverDeductionBatchId
END




GO
/****** Object:  StoredProcedure [dbo].[sp_DelinkStation]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	sp_DelinkStation
-- =============================================
create PROCEDURE [dbo].[sp_DelinkStation] 
	-- Add the parameters for the stored procedure here
	@StationId uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	UPDATE [dbo].[swiftfin_Customers]
		SET [StationId] = NULL
	WHERE [StationId]=@StationId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_DepositsShareCapital]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- [sp_DepositsShareCapital] '2/4/2019'

CREATE  PROC [dbo].[sp_DepositsShareCapital]

@EndDate DateTime
AS
SET NOCOUNT ON;
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

--select * from swiftfin_customers where Address_MobileLine='+254722334466'
WITH InvestmentCTE(Fullname,ID,Mno,PFNo,Deposits,ShareCapital)
AS
( 
select (Individual_FirstName +' '+isnull(Individual_LastName,'')) as Fullname, Individual_IdentityCardNumber,
Reference2,individual_payrollnumbers, 
isnull((SELECT sum(amount) 
FROM dbo.swiftfin_InvestmentProducts INNER JOIN
dbo.swiftfin_JournalEntries ON dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
WHERE (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate) and dbo.swiftfin_JournalEntries.CustomerAccountId=dbo.swiftfin_CustomerAccounts.Id and dbo.swiftfin_InvestmentProducts.id=dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId and
dbo.swiftfin_InvestmentProducts.Code=1
),0) as Deposits,

isnull((SELECT sum(amount) 
FROM dbo.swiftfin_InvestmentProducts INNER JOIN
dbo.swiftfin_JournalEntries ON dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId 
WHERE (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate) and dbo.swiftfin_JournalEntries.CustomerAccountId=dbo.swiftfin_CustomerAccounts.Id and dbo.swiftfin_InvestmentProducts.id=dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId and
dbo.swiftfin_InvestmentProducts.Code=2
),0) as ShareCapital



FROM dbo.swiftfin_Customers INNER JOIN
dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId
where dbo.swiftfin_CustomerAccounts .CustomerAccountType_ProductCode=3 --and (dbo.swiftfin_JournalEntries.CreatedDate =@EndDate)
)
select Fullname,ID,Mno,PFNo,sum(ShareCapital) as ShareCapital ,
 sum(Deposits) as Deposits ,sum(ShareCapital)+ sum(Deposits) as Total,(sum(ShareCapital)+sum(Deposits))/100 as NoOfShares
from InvestmentCTE

group by Fullname,ID,Mno,PFNo


GO
/****** Object:  StoredProcedure [dbo].[sp_DividendFileGenerate]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 10.02.2015
-- Description:	Dividend Payslips
-- =============================================
--sp_DividendFileGenerate '12/31/2018',12,10,5
CREATE PROCEDURE [dbo].[sp_DividendFileGenerate] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime,
	@Rate1 Numeric(12,2),
	@Rate2 Numeric(12,2),
	@Wtax Numeric(12,2)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
DROP TABLE  swiftfin_Dividends_2018;
	SET NOCOUNT ON;
	--drop table swiftfin_Dividends_2018
	CREATE TABLE #List
	(
	    --FullAccountNo varchar(256),
		Fosa_Acno Varchar(256),
		PfNo Varchar(256),
		Name Varchar(256),
		BalanceBF Numeric(38,2),
		January Numeric(38,2),
		February Numeric(38,2),
		March Numeric(38,2),
		April Numeric(38,2),
		May Numeric(38,2),
		June Numeric(38,2),
		July Numeric(38,2),
		August Numeric(38,2),
		September Numeric(38,2),
		October Numeric(38,2),
		November Numeric(38,2),
		December Numeric(38,2),
		Qualified Numeric(38,2),
		tType Varchar(3)
	)

	-- finally, execute and insert into our table
	INSERT INTO #List
	(
	   --FullAccountNo,
		--FullAccountNo,
		 Fosa_Acno,
		 PfNo,
		Name,
		BalanceBF,
		January,
		February,
		March,
		April,
		May,
		June,
		July,
		August,
		September,
		October,
		November,
		December,
		Qualified,
		tType
	)
	exec [sp_Dividends_Prorata] @EndDate,'S01'
	INSERT INTO #List
	(
	   ----FullAccountNo,
		--FullAccountNo,
		 Fosa_Acno,
		  PfNo,
		Name,
		BalanceBF,
		January,
		February,
		March,
		April,
		May,
		June,
		July,
		August,
		September,
		October,
		November,
		December,
		Qualified,
		tType
	)
	exec [sp_Dividends_Prorata] @EndDate,'S02'


	
--delete from swiftfin_Dividends_2018
select Fosa_acno,PfNo,Name,
case when tType='S01' then isnull(sum(Qualified),0) end as [S01 Share Deposits],
case when tType='S02' then isnull(sum(Qualified),0) end as [S02 Share  Capital]



into #Listing from #List  group by fosa_acno ,PfNo,name,Qualified,tType order by Fosa_Acno;

--select * from swiftfin_Dividends_2018
--select * from swiftfin_InvestmentProducts

with  swiftfin_Dividends_2018_CTE (Fosaacno,PfNo,name,[S01 Share Deposits],[S02 Share  Capital])
as
(
select isnull(Fosa_acno,''),isnull(PfNo,''),isnull(name,''),isnull(sum([S01 Share Deposits]),0) as [S01 Share Deposits],isnull(sum([S02 Share  Capital]),0) as [S02 Share  Capital]
 from #Listing group by Fosa_Acno,Name,PfNO
)

select Fosaacno,PfNo,name,[S01 Share Deposits],[S01 Share Deposits]*@Rate1*0.01 as [S01 Share Deposits Interest],
[S02 Share  Capital],[S02 Share  Capital]*@Rate2*0.01 as [S02 Share  Capital Interest]

 into swiftfin_Dividends_2018 from swiftfin_Dividends_2018_CTE

select *,[S01 Share Deposits Interest]+[S02 Share  Capital Interest] as Total,
([S01 Share Deposits Interest]+[S02 Share  Capital Interest])*@Wtax*0.01 as Wtax,
([S01 Share Deposits Interest]+[S02 Share  Capital Interest])-
([S01 Share Deposits Interest]+[S02 Share  Capital Interest])*@Wtax*0.01 as Net

 from swiftfin_Dividends_2018
END
--select * from swiftfin_Dividends_2018







GO
/****** Object:  StoredProcedure [dbo].[sp_DividendPayslips]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[sp_DividendPayslips] 
	-- Add the parameters for the stored procedure here
	@Rate1 Numeric(12,2),
	@Rate2 Numeric(12,2),
	@Rate3 Numeric(12,2),
	@BuyingCenter varchar(15) 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @BuyingCenter=ltrim(rtrim(@BuyingCenter))	
	select fosaacno,name,[S01 Unwithdrawable Deposits],[S01 Unwithdrawable Deposits]*@Rate1*.01 as [S01 Unwithdrawable Deposits Interest],
	[S02 Housing Shares],[S02 Housing Shares]*@Rate2*.01 as [S02 Housing Shares Interest],[S03 Shares],[S03 Shares] *@Rate3*0.01 as [S03 Shares Interest],
	(select top 1 Individual_PayrollNumbers from swiftfin_Customers where Reference1=swiftfin_Dividends_2016.fosaacno COLLATE Latin1_General_CI_AS) as PayrollNumbers from swiftfin_Dividends_2016
	where fosaacno in (SELECT reference1 COLLATE Latin1_General_CI_AS
	FROM swiftfin_Customers WHERE Individual_PayrollNumbers like '%'+@BuyingCenter+'%')
	 order by fosaacno,name
END


GO
/****** Object:  StoredProcedure [dbo].[sp_DividendPayslipsListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_DividendPayslipsListing 14,12,12,12
CREATE PROCEDURE [dbo].[sp_DividendPayslipsListing] 
	-- Add the parameters for the stored procedure here
	@Rate1 Numeric(12,2),
	@Rate2 Numeric(12,2),
	@Rate3 Numeric(12,2),
	@Rate4 Numeric(12,2)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	select left(fosaacno,4)+substring(fosaacno,6,3)+substring(fosaacno,10,5) as fosaacno,name,[S01 Unwithdrawable Deposits],[S01 Unwithdrawable Deposits]*@Rate1*.01 as [S01 Unwithdrawable Deposits Interest],
	[S02 Housing Shares],[S02 Housing Shares]*@Rate2*.01 as [S02 Housing Shares Interest],[S03 Shares],[S03 Shares] *@Rate3*0.01 as [S03 Shares Interest],
	[S07 Building Shares Kericho],[S07 Building Shares Kericho] *@Rate4*0.01 as [S07 Building Shares Kericho Interest],
	(select top 1 Individual_PayrollNumbers from swiftfin_Customers where Reference1=swiftfin_Dividends_2016.fosaacno COLLATE Latin1_General_CI_AS) as PayrollNumbers from swiftfin_Dividends_2016 
	where fosaacno in (SELECT reference1 COLLATE Latin1_General_CI_AS
	FROM swiftfin_Customers)
	 order by fosaacno,name
END


--select * from swiftfin_InvestmentProducts
--select * from swiftfin_Dividends_2016


GO
/****** Object:  StoredProcedure [dbo].[SP_Dividends]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_customeraccounts
--SP_Dividends '12/31/2016'
--select * from swiftfin_savingsproducts 
--select * from dividends
CREATE procedure [dbo].[SP_Dividends] 
@EndDate DateTime
AS
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
SELECT 
left(Reference1,4)+SUBSTRING(Reference1,6,3)+SUBSTRING(Reference1,10,5) as reference1,
isnull(Individual_FirstName,'')+' ' +isnull(Individual_LastName,'') as Name,individual_payrollnumbers as payrollnumber,

isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=6 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) AS [SHARE CAPITAL],
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE  dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=6 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) * (select AnnualPercentageYield*.01 from swiftfin_InvestmentProducts where code=6) AS [Dividend SHARE CAPITAL],
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=3 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) AS [FOSA SHARES],
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE  dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=3 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) * (select AnnualPercentageYield*.01 from swiftfin_InvestmentProducts where code=3) AS [Interest Fosa Shares],
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE  dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=1 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) AS [NORMAL SHARES],
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                        dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE  dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=1 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) * (select AnnualPercentageYield*.01 from swiftfin_InvestmentProducts where code=1) AS [Interest Normal Shares],

						isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE  dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=8 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) AS [BUSINESS SHARES],
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                        dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE  dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=8 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) * (select AnnualPercentageYield*.01 from swiftfin_InvestmentProducts where code=8) AS [Interest Business Shares],

						isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE  dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=2 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) AS [HOUSING SHARES],
isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
                        dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId WHERE  dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.Id and swiftfin_InvestmentProducts.CODE=2 and swiftfin_JournalEntries.CreatedDate<@EndDate),0) * (select AnnualPercentageYield*.01 from swiftfin_InvestmentProducts where code=2) AS [Interest Housing Shares]

into #Dividends from swiftfin_Customers order by Reference1

select *,[Interest Normal Shares]+[Interest Fosa Shares]+[Dividend SHARE CAPITAL]+[Interest Business Shares]+[Interest Housing Shares] as [Total],([Interest Normal Shares]+[Interest Fosa Shares]+[Dividend SHARE CAPITAL]+[Interest Business Shares]+[Interest Housing Shares])*5*.01 as [WithHolding Tax],([Interest Normal Shares]+[Interest Fosa Shares]+[Dividend SHARE CAPITAL]+[Interest Business Shares]+[Interest Housing Shares] -([Interest Normal Shares]+[Interest Fosa Shares]+[Dividend SHARE CAPITAL]+[Interest Business Shares]+[Interest Housing Shares])*5*.01) as Net  from #Dividends where [NORMAL SHARES]+[FOSA SHARES]+[SHARE CAPITAL]+[BUSINESS SHARES]+[HOUSING SHARES]>0  order by reference1






GO
/****** Object:  StoredProcedure [dbo].[sp_Dividends_Prorata]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--[sp_Dividends_Prorata] '01/31/2018','S01'
---select * from swiftfin_investmentproducts
CREATE procedure [dbo].[sp_Dividends_Prorata] (@EndDate DateTime,@ttype char(3))
as
declare @code char(3)
set @Code= case when @ttype='S01' THEN 1 when @ttype='S02' then 2  end;

With CTEProrata (Fosa_acno,PfNo,Name,Balance,Month,Qualified)
as
(
select  Reference1  , Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) ,0 as Month,sum(credit-debit) as Qualified 
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where year(trdate)<='2017'  and right(ttype,1)=@code and left(ttype,1)='S' 
group by Reference1 ,Reference3,Individual_FirstName,Individual_LastName

union
select  Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,1 as Month,sum(credit-debit)*12/12 as Qualified 
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=1 and year(trdate)=year(@EndDate)  and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName


UNION
select  Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,2 as Month,sum(credit-debit)*11/12 as Qualified 
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=2and year(trdate)=year(@EndDate)  and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1 ,Reference3,Individual_FirstName,Individual_LastName

union
select  Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,3 as Month,sum(credit-debit)*10/12 as Qualified 
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=3 and year(trdate)=year(@EndDate) and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName

union
select Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,4 as Month,sum(credit-debit)*9/12 as Qualified
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=4  and year(trdate)=year(@EndDate) and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName


union
select Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,5 as Month,sum(credit-debit)*8/12 as Qualified
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=5  and year(trdate)=year(@EndDate) and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName

union
select Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,6 as Month,sum(credit-debit)*7/12 as Qualified
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=6  and year(trdate)=year(@EndDate) and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName

union
select Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,7 as Month,sum(credit-debit)*6/12 as Qualified
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=7  and year(trdate)=year(@EndDate) and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName

union
select Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,8 as Month,sum(credit-debit)*5/12 as Qualified
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=8  and year(trdate)=year(@EndDate) and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName

union
select Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,9 as Month,sum(credit-debit)*4/12 as Qualified
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=9  and year(trdate)=year(@EndDate) and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName

union
select Reference1  ,Reference3,Individual_FirstName+' '+Individual_LastName as Name,sum(credit-debit) as Balance,10 as Month,sum(credit-debit)*3/12 as Qualified
from BOSA.dbo.History inner join swiftfin_Customers on BOSA.dbo.History.pf_no=swiftfin_Customers.Reference2
where month(trdate)=10  and year(trdate)=year(@EndDate) and right(ttype,1)=@code and left(ttype,1)='S'
group by Reference1  ,Reference3,Individual_FirstName,Individual_LastName


union


SELECT       dbo.vw_CustomerAccounts.Reference1 as fosa_Acno,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName as Name,
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,11 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*2/12 AS qualified 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=11  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate)  AND
						 dbo.swiftfin_Journals.TransactionCode<>34 and dbo.swiftfin_investmentproducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName

union

SELECT       dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullName as Name,
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,12 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*1/12 AS qualified 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_investmentproducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_investmentproducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_investmentproducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=12  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_investmentproducts.CODE=@code 
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullName
), 
 CTEResults (Name,Fosa_acno,PfNo,BroughtFWD,January,February,March,April,May,June,July,August,September,October,November,December)
as
(
select Name,Fosa_acno,PfNo,
case when month=0 then sum(Qualified) else 0 end as BroughtFWD,
case when Month=1 then sum(Qualified) else 0  end as January,
case when Month=2 then sum(Qualified) else 0 end as February,
case when Month=3 then sum(Qualified) else 0 end as March,
case when Month=4 then sum(Qualified) else 0  end as April,
case when Month=5 then sum(Qualified) else 0 end as May,
case when Month=6 then sum(Qualified) else 0 end as June,
case when Month=7 then sum(Qualified) else 0 end as July,
case when Month=8 then sum(Qualified) else 0 end as August,
case when Month=9 then sum(Qualified) else 0 end as September,
case when Month=10 then sum(Qualified) else 0  end as October,
case when Month=11 then sum(Qualified) else 0 end as November,
case when Month=12 then sum(Qualified) else 0 end as December
 from CTEProrata group by  Name,fosa_acno,PfNo,month 
 )
select Fosa_acno, PfNo,Name,  
sum(BroughtFWD) as BalanceBF, 
sum(January) as January,
sum(February) as February, 
Sum(March) as March,
sum(April) as April, 
sum(May) as May, 
sum(June) as June, 
sum(July) as July, 
sum(August) as August, 
sum(September) as September,
sum(October) as October,
sum(November) as November,
sum(December) as December,
--sum(BroughtFWD+January+February+March+April+May+June+July+August+September+October+November+December) as Qualified,
--@ttype as type



  iif(sum(BroughtFWD+January+February+March+April+May+June+July+August+September+October+November+December)<0,0,

 sum(BroughtFWD+January+February+March+April+May+June+July+August+September+October+November+December) ) as Qualified,
@ttype as type

 from CTEResults 
 group by Name,Fosa_acno,PfNo  order by Fosa_acno


--select * from #temp
--[sp_Dividends_Prorata] '01/31/2018','S02'

--select * from swiftfin_Customers where Individual_LastName like '%busolo%'





GO
/****** Object:  StoredProcedure [dbo].[sp_Dividends_Prorata_previous]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec [sp_Dividends_Prorata_previous] '1/1/2015','s01'
CREATE Procedure [dbo].[sp_Dividends_Prorata_previous](@enddate as Datetime,@ttype char(3))
as
set nocount on
Declare @year as numeric (4),@FirstDayOfYear datetime,@mcode int

set @mcode= case when @ttype='S01' THEN 1 when @ttype='S03' then 3 when @ttype='S04' then 4 when @ttype ='S09' then 5
when @ttype ='S10' then 6 when @ttype ='S11' then 7
 end

set @year=year(@enddate)

set @FirstDayOfYear = DATEADD(YEAR, DATEDIFF(YEAR, 0, @enddate), 0)

select customer.fosa_Acno, customer.name, customer.EMPNO, customer.dept,
0 AS [month], 
0 AS monthly, 12 AS Expr1,
isnull((select top 1 coalesce(c.credit,0)-COALESCE(c.debit,0) from hq.dbo.sharehist c where c.fosa_Acno=customer.fosa_Acno  and c.ttype=@ttype order by trdate),0) as Opening,
 SUM(COALESCE(sharehist.credit,0)-COALESCE(sharehist.debit,0)) as balance,
 case 
 when @year =2012 then
	(isnull((select top 1 coalesce(c.credit,0)-COALESCE(c.debit,0) from hq.dbo.sharehist c where c.fosa_acno=customer.fosa_acno   and c.ttype=@ttype  order by trdate),0)+
	SUM(COALESCE(sharehist.credit,0)-COALESCE(sharehist.debit,0))) * 12/ 12 
 else
	 SUM(COALESCE(sharehist.credit,0)-COALESCE(sharehist.debit,0)) * 12/ 12  
 end
 AS qualified,sharehist.ttype
INTO #TEMPOpeningBalances
FROM         hq.dbo.sharehist sharehist INNER JOIN
                      hq.dbo.customer customer ON sharehist.fosa_acno = customer.fosa_Acno
     
WHERE      (YEAR(sharehist.TrDATE) < @year)  and sharehist.ttype=@ttype  --and sharehist.fosa_acno='0101-001-00064'
GROUP BY customer.fosa_acno,  customer.name, customer.empno, customer.dept,tea_no,sharehist.ttype
if @year<>2012
begin 
	update #TEMPOpeningBalances set opening=0 
end



select sharehist.fosa_acno,sharehist.trdate,sharehist.debit,sharehist.credit,docid,docno,TRDESCPT,ttype
Into #TempSharehist
from hq.dbo.sharehist WHERE (YEAR(sharehist.TRDATE) >=@year) and sharehist.ttype=@ttype -- and sharehist.fosa_acno='0101-001-00064'


insert into #TempSharehist (sharehist.fosa_acno,sharehist.trdate,sharehist.debit,sharehist.credit,docid,docno,TRDESCPT,ttype)
SELECT        ltrim(rtrim(dbo.vw_CustomerAccounts.Reference1)),dbo.swiftfin_JournalEntries.CreatedDate,0 as Debit, dbo.swiftfin_JournalEntries.Amount as Credit, '999' as Docid,'99999' as Docno,  
                         left(dbo.swiftfin_Journals.PrimaryDescription,30),dbo.swiftfin_InvestmentProducts.Code
FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_InvestmentProducts.Code = @mcode) AND (dbo.swiftfin_Journals.PrimaryDescription <> 'BALANCE C/F')




UPDATE #TempSharehist SET trdate ='1/31/2012' WHERE TRDESCPT ='Balance B/F' AND COALESCE(DOCID,'')='IMP'


UPDATE #TempSharehist SET trdate =@FirstDayOfYear
FROM #TempSharehist WHERE COALESCE(#TempSharehist.DOCID,'')='S/O' and year(trdate) < YEAR(@enddate)

delete #TempSharehist where YEAR(#TempSharehist.TRDATE) <>@year
 

select fosa_acno,max(trdate) as Trdate,ttype into #TempWithdrawals from hq.dbo.sharehist where docid IN('33E','334') and year(trdate)=@year
--and sharehist.fosa_acno='0101-001-00064'
group by fosa_Acno,ttype


SELECT    sharehist.fosa_acno, customer.name, customer.EMPNO, customer.dept,
 MONTH(sharehist.TRDATE) AS [month], 
 SUM(COALESCE(sharehist.credit,0)-COALESCE(sharehist.debit,0)) as balance,
SUM(COALESCE(sharehist.credit,0)) AS monthly,
isnull((select month(trdate) from #TempWithdrawals  where fosa_acno=sharehist.fosa_acno and ttype=@ttype),13) - (MONTH(sharehist.TRDATE) ) AS Expr1,
 SUM(COALESCE(sharehist.credit,0)-COALESCE(sharehist.debit,0)) *(  
 isnull((select month(trdate) from #TempWithdrawals  where fosa_acno=sharehist.fosa_acno and ttype=@ttype),13) 
 - (MONTH(sharehist.TRDATE))) / 12 AS qualified,sharehist.ttype
INTO #TEMPBalances
FROM         #TempSharehist sharehist INNER JOIN
                      hq.dbo.customer customer ON sharehist.fosa_Acno = customer.fosa_Acno
                      WHERE      (YEAR(sharehist.TRDATE) =@year)  and sharehist.ttype=@ttype 
GROUP BY sharehist.fosa_acno, sharehist.trdate, customer.name, customer.empno, customer.dept,sharehist.ttype
--ORDER BY sharehist.saccomno, MONTH(sharehist.date)

insert into #TEMPBalances(fosa_acno,name,empno,dept,month,Monthly,expr1,Qualified,balance,ttype )
select fosa_acno,name,empno,dept,month,Monthly,expr1,Qualified,coalesce(balance,0)+coalesce(opening,0),ttype from #TEMPOpeningBalances
/*
select fosa_acno,name,empno,dept as Activity,month,sum(monthly) as Monthly,expr1,
sum(qualified) as Qualified,sum(balance) as balance,@enddate as TRDATE
from #TEMPBalances --WHERE FOSA_aCNO='0101-001-00174 '
group by FOSA_ACNO,name,empno,DEPT,month,expr1
order by fosa_Acno,month
*/




select fosa_acno,name,
CASE 
WHEN MONTH=0 THEN sum(qualified)
END AS BalanceBF,
CASE 
WHEN MONTH=1 THEN sum(qualified)
END AS January,
CASE 
WHEN MONTH=2 THEN sum(qualified)
END AS February,
CASE 
WHEN MONTH=3 THEN sum(qualified)
END AS March,
CASE 
WHEN MONTH=4 THEN sum(qualified)
END AS April,
CASE 
WHEN MONTH=5 THEN sum(qualified)
END AS May,
CASE 
WHEN MONTH=6 THEN sum(qualified)
END AS June,
CASE 
WHEN MONTH=7 THEN sum(qualified)
END AS July,
CASE 
WHEN MONTH=8 THEN sum(qualified)
END AS August,
CASE 
WHEN MONTH=9 THEN sum(qualified)
END AS September,
CASE 
WHEN MONTH=10 THEN sum(qualified)
END AS October,
CASE 
WHEN MONTH=11 THEN sum(qualified)
END AS November,
CASE 
WHEN MONTH=12 THEN sum(qualified)
END AS December,
---sum(monthly) as Monthly,expr1,
sum(qualified) as Qualified,ttype into #TEMPBalances1
from #TEMPBalances --WHERE FOSA_aCNO='0101-001-00174 '
group by FOSA_ACNO,name,month,ttype
order by fosa_Acno


select Fosa_acno,ltrim(rtrim(name)) as name,sum(isnull(BalanceBF,0)) as BalanceBF ,sum(isnull(January,0)) as January,sum(isnull(February,0)) as February,sum(isnull(March,0)) as March
,sum(isnull(April,0)) as April,sum(isnull(May,0)) as May,sum(isnull(June,0)) as June,sum(isnull(July,0)) as July,sum(isnull(August,0)) as August,Sum(isnull(September,0)) as September,sum(isnull(october,0)) as October
,sum(isnull(November,0)) as November,sum(isnull(December,0)) as December ,sum(isnull(Qualified,0)) as Qualified,ttype from #TEMPBalances1 group  by Fosa_acno,name,ttype
order by fosa_acno

drop table #TEMPBalances
drop table #TEMPOpeningBalances















GO
/****** Object:  StoredProcedure [dbo].[Sp_EarningDeductionSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--exec Sp_EarningDeductionSummary
CREATE PROCEDURE [dbo].[Sp_EarningDeductionSummary]
	-- Add the parameters for the stored procedure here
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.

	SET NOCOUNT ON;
	
SELECT        dbo.swiftfin_Customers.Reference1, (dbo.swiftfin_Customers.Individual_FirstName+''+dbo.swiftfin_Customers.Individual_LastName)as name
				 ,isnull((select sum(dbo.swiftfin_PaySlipEntries.Principal+dbo.swiftfin_PaySlipEntries.Interest) 
FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_PaySlipEntries.CustomerAccountId
						 where dbo.swiftfin_Employees.CustomerId=dbo.swiftfin_Customers.Id),0) as [Amount]
			

 ,isnull((select sum(dbo.swiftfin_PaySlipEntries.Principal+dbo.swiftfin_PaySlipEntries.Interest) 
FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_PaySlipEntries.CustomerAccountId
			      		 where dbo.swiftfin_Employees.CustomerId=dbo.swiftfin_Customers.Id and swiftfin_PaySlipEntries.SalaryHeadCategory=1),0) as [Earnings]
						 

 ,isnull((select sum(dbo.swiftfin_PaySlipEntries.Principal+dbo.swiftfin_PaySlipEntries.Interest) 
FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_PaySlipEntries.CustomerAccountId
			      		 where dbo.swiftfin_Employees.CustomerId=dbo.swiftfin_Customers.Id and swiftfin_PaySlipEntries.Salaryheadcategory=2),0) as [Deductions]


          
FROM            dbo.swiftfin_PaySlipEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_PaySlipEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id

 order by Reference1
END






GO
/****** Object:  StoredProcedure [dbo].[sp_EducationToMembers]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[sp_EducationToMembers] (@CenterID uniqueidentifier=null)
as
SELECT        dbo.swiftfin_EducationAttendees.Remarks, dbo.swiftfin_EducationAttendees.CreatedBy, dbo.swiftfin_EducationAttendees.CreatedDate, dbo.vw_Customers.FullName, dbo.swiftfin_EducationAttendees.EducationRegisterId, 
                         dbo.vw_Customers.Reference1, dbo.vw_Customers.Reference2, dbo.vw_Customers.Reference3
FROM            dbo.swiftfin_EducationAttendees INNER JOIN
                         dbo.vw_Customers ON dbo.swiftfin_EducationAttendees.CustomerId = dbo.vw_Customers.Id
 where EducationRegisterId=@CenterID
GO
/****** Object:  StoredProcedure [dbo].[sp_electroniclistBOSAFOSAloans]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---sp_electroniclistBOSAFOSAloans '9/30/2018'
CREATE  Procedure [dbo].[sp_electroniclistBOSAFOSAloans]
@pEndDate DateTime
as
--select disbursedBy from swiftfin_loancases order by createddate desc
set @pEndDate=	(select DATEADD(day, DATEDIFF(day, 0, @pEndDate), '23:59:59'));

select  Reference1,Reference2,Reference3,FullName, serialnumber,
(select description from swiftfin_branches where code=1) as [Branch Name],

isnull((select top 1 disbursedBy from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),'') as [Loan Officer],
vw_CustomerAccounts.description,
vw_CustomerAccounts.EmployerDescription,

case when (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) ='512' then 'Reducing Balance'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '513' then 'Straight Line'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '514' then 'Amortization (Straight Line)'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '515' then 'Amortization (Diminishing Balance)'
	 END as [Loan Amortization Type],

isnull((select  top 1 Principal from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),0) as [Loan Instalments]
,(select LoanInterest_AnnualPercentageRate from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) as [Annual Loan Rate]
,(select LoanRegistration_TermInMonths from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) as [Period]
,CASE (select LoanRegistration_PaymentFrequencyPerYear from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
WHEN 1 THEN 'Annual'
WHEN 2 THEN 'Semi-Annual (every 6 months)'
WHEN 3 THEN 'Quarterly (every 3 months)'
WHEN 4 THEN 'Tri-Annual (every 4 months)'
WHEN 6 THEN 'Bi-Monthly (every 2 months)'
WHEN 12 THEN 'Monthly'
WHEN 24 THEN 'Semi-Monthly (twice a month)'
WHEN 26 THEN 'Bi-Weekly (every 2 weeks)'
WHEN 52 THEN 'Weekly'
WHEN 256 THEN 'Daily'
END as [Loan Frequency],
isnull((select top 1 CaseNumber from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),
(select ABS(CHECKSUM(NewId())) % 2000))
 as [Loan Number],


isnull((select  top 1 Duration_StartDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Date Loan Disbursed],

isnull((select top 1 LoanAmount from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),0) as   [Loan Amount]
,
0.00 as TopUpAmount
,
isnull((select  top 1 Duration_EndDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Loan Maturity],
isnull((select top 1 Schedule_ExpectedRunDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Schedule_ExpectedRunDate],

case when @pEndDate<'11/03/2018' then (select top 1 Balance from  swiftfin_AsmasData where Reference1=vw_CustomerAccounts.Reference1 and ProductID=vw_CustomerAccounts.CustomerAccountType_TargetProductId) else isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) and CreatedDate<=@pEndDate) ,0)*-1 end as [Loan Balance],
isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and ChartOfAccountId in (select interestReceivablechartofaccountid from swiftfin_LoanProducts) and CreatedDate<=@pEndDate) ,0)*-1 as [Loan Interest Due],

isnull(case
when (select top 1 CreatedDate from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and (ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts)  or  ChartOfAccountId in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts)) and CreatedDate<=@pEndDate and amount>0 order by CreatedDate desc) is not null
then
(select top 1 CreatedDate from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and (ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) or  ChartOfAccountId in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts))
 and CreatedDate<=@pEndDate and amount>0 order by CreatedDate desc)
else
(select top 1 LastTrxDate from  swiftfin_AsmasData where Reference1=vw_CustomerAccounts.Reference1 and ProductID=vw_CustomerAccounts.CustomerAccountType_TargetProductId)
end,'11/03/2018')
 as [Last Installment Date1],
 isnull((select  top 1 dateadd(mm,1,Duration_StartDate) from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as 
 [Loan_First_Pmt_Date],
	isnull((select top 1 amount from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) and CreatedDate<=@pEndDate and amount>0 order by CreatedDate desc),0) 
  as [Latest Amount Paid],
isnull((select top 1 (select sum(AmountGuaranteed) from dbo.swiftfin_LoanGuarantors where LoanCaseId=swiftfin_LoanCases.id ) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),0) as [Amount of Guarantee],
isnull((select top 1 (select count(AmountGuaranteed) from dbo.swiftfin_LoanGuarantors where LoanCaseId=swiftfin_LoanCases.id ) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),0) as [No of Loan Guarantors]

into #tempLoans  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id where CustomerAccountType_TargetProductId in (select id from swiftfin_LoanProducts) order by CustomerAccountType_TargetProductId

select *, [Last Installment Date1] as [Last Installment Date],
case when datediff(dd,[Last Installment Date1],@pEndDate)<30 then 0 else (datediff(dd,[Last Installment Date1],@pEndDate))-30 end  [DaysInArrears]
  into #tempLoans1
from #tempLoans 

select  *,case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100
end as ClassOrder,
case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 'Performing'
WHEN DATEDIFF(dd,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60THEN 'Watch'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 'Substandard'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 'Doubtful'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 'Loss'
end as Classification,
iif(DATEDIFF(MM,[Last Installment Date],@pEndDate)<0,0,DATEDIFF(MM,[Last Installment Date],@pEndDate)) as DefaultFrequency,
case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100 end as Provision
from #tempLoans1   where [Loan Balance]<>0  order by case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100 end
  --select * from vw_CustomerAccounts
GO
/****** Object:  StoredProcedure [dbo].[sp_electroniclistBOSAFOSAloansAsmas]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---sp_electroniclistBOSAFOSAloansAsmas '12/11/2018'
CREATE  Procedure [dbo].[sp_electroniclistBOSAFOSAloansAsmas]
@pEndDate DateTime
as
--select disbursedBy from swiftfin_loancases order by createddate desc
set @pEndDate=	(select DATEADD(day, DATEDIFF(day, 0, @pEndDate), '23:59:59'));

select  Reference1,Reference2,Reference3,FullName, serialnumber,
(select description from swiftfin_branches where code=1) as [Branch Name],

isnull((select top 1 disbursedBy from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),'') as [Loan Officer],
vw_CustomerAccounts.description,
vw_CustomerAccounts.EmployerDescription,

case when (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) ='512' then 'Reducing Balance'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '513' then 'Straight Line'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '514' then 'Amortization (Straight Line)'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '515' then 'Amortization (Diminishing Balance)'
	 END as [Loan Amortization Type],

isnull((select  top 1 Principal from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),0) as [Loan Instalments]
,(select LoanInterest_AnnualPercentageRate from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) as [Annual Loan Rate]
,(select LoanRegistration_TermInMonths from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) as [Period]
,CASE (select LoanRegistration_PaymentFrequencyPerYear from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
WHEN 1 THEN 'Annual'
WHEN 2 THEN 'Semi-Annual (every 6 months)'
WHEN 3 THEN 'Quarterly (every 3 months)'
WHEN 4 THEN 'Tri-Annual (every 4 months)'
WHEN 6 THEN 'Bi-Monthly (every 2 months)'
WHEN 12 THEN 'Monthly'
WHEN 24 THEN 'Semi-Monthly (twice a month)'
WHEN 26 THEN 'Bi-Weekly (every 2 weeks)'
WHEN 52 THEN 'Weekly'
WHEN 256 THEN 'Daily'
END as [Loan Frequency],
isnull((select top 1 CaseNumber from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),
(select ABS(CHECKSUM(NewId())) % 2000))
 as [Loan Number],


isnull((select  top 1 Duration_StartDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Date Loan Disbursed],

isnull((select top 1 LoanAmount from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),0) as   [Loan Amount]
,
0.00 as TopUpAmount
,
isnull((select  top 1 Duration_EndDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Loan Maturity],
isnull((select top 1 Schedule_ExpectedRunDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Schedule_ExpectedRunDate],
isnull((select Balance from  swiftfin_AsmasData2 where CustomerId=vw_CustomerAccounts.CustomerId and ProductID=vw_CustomerAccounts.CustomerAccountType_TargetProductId),0)  as [Loan Balance],
0 as [Loan Interest Due],
isnull((select top 1 LastTrxDate from  swiftfin_AsmasData where Reference1=vw_CustomerAccounts.Reference1 and ProductID=vw_CustomerAccounts.CustomerAccountType_TargetProductId)
,'11/03/2018')
 as [Last Installment Date1],
 isnull((select  top 1 dateadd(mm,1,Duration_StartDate) from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as 
 [Loan_First_Pmt_Date],
	isnull((select top 1 amount from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) and CreatedDate<=@pEndDate and amount>0 order by CreatedDate desc),0) 
  as [Latest Amount Paid],
isnull((select top 1 (select sum(AmountGuaranteed) from dbo.swiftfin_LoanGuarantors where LoanCaseId=swiftfin_LoanCases.id ) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),0) as [Amount of Guarantee],
isnull((select top 1 (select count(AmountGuaranteed) from dbo.swiftfin_LoanGuarantors where LoanCaseId=swiftfin_LoanCases.id ) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),0) as [No of Loan Guarantors]

into #tempLoans  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id where CustomerAccountType_TargetProductId in (select id from swiftfin_LoanProducts) order by CustomerAccountType_TargetProductId

select *, [Last Installment Date1] as [Last Installment Date],
case when datediff(dd,[Last Installment Date1],@pEndDate)<30 then 0 else (datediff(dd,[Last Installment Date1],@pEndDate))-30 end  [DaysInArrears]
  into #tempLoans1
from #tempLoans 

select  *,case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100
end as ClassOrder,
case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 'Performing'
WHEN DATEDIFF(dd,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60THEN 'Watch'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 'Substandard'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 'Doubtful'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 'Loss'
end as Classification,
DATEDIFF(MM,[Last Installment Date],@pEndDate) as DefaultFrequency,
case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100 end as Provision
from #tempLoans1   where [Loan Balance]<>0  order by case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100 end
  --select * from vw_CustomerAccounts
GO
/****** Object:  StoredProcedure [dbo].[sp_electroniclistBOSAFOSAloansSummarry]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---sp_electroniclistBOSAFOSAloansSummarry '10/11/2018'
CREATE  Procedure [dbo].[sp_electroniclistBOSAFOSAloansSummarry]
@pEndDate DateTime
as
--select disbursedBy from swiftfin_loancases order by createddate desc
set @pEndDate=	(select DATEADD(day, DATEDIFF(day, 0, @pEndDate), '23:59:59'));

select  Reference1,Reference2,Reference3,FullName, serialnumber,
(select description from swiftfin_branches where code=1) as [Branch Name],

isnull((select top 1 disbursedBy from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),'') as [Loan Officer],
vw_CustomerAccounts.description,
vw_CustomerAccounts.EmployerDescription,

case when (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) ='512' then 'Reducing Balance'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '513' then 'Straight Line'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '514' then 'Amortization (Straight Line)'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '515' then 'Amortization (Diminishing Balance)'
	 END as [Loan Amortization Type],

isnull((select  top 1 Principal from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),0) as [Loan Instalments]
,(select LoanInterest_AnnualPercentageRate from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) as [Annual Loan Rate]
,(select LoanRegistration_TermInMonths from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) as [Period]
,CASE (select LoanRegistration_PaymentFrequencyPerYear from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
WHEN 1 THEN 'Annual'
WHEN 2 THEN 'Semi-Annual (every 6 months)'
WHEN 3 THEN 'Quarterly (every 3 months)'
WHEN 4 THEN 'Tri-Annual (every 4 months)'
WHEN 6 THEN 'Bi-Monthly (every 2 months)'
WHEN 12 THEN 'Monthly'
WHEN 24 THEN 'Semi-Monthly (twice a month)'
WHEN 26 THEN 'Bi-Weekly (every 2 weeks)'
WHEN 52 THEN 'Weekly'
WHEN 256 THEN 'Daily'
END as [Loan Frequency],
isnull((select top 1 CaseNumber from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),
(select ABS(CHECKSUM(NewId())) % 2000))
 as [Loan Number],


isnull((select  top 1 Duration_StartDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Date Loan Disbursed],

isnull((select top 1 LoanAmount from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),0) as   [Loan Amount]
,
0.00 as TopUpAmount
,
isnull((select  top 1 Duration_EndDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Loan Maturity],
isnull((select top 1 Schedule_ExpectedRunDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Schedule_ExpectedRunDate],
case when @pEndDate<'11/03/2018' then (select top 1 Balance from  swiftfin_AsmasData where Reference1=vw_CustomerAccounts.Reference1 and ProductID=vw_CustomerAccounts.CustomerAccountType_TargetProductId) else isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) and CreatedDate<=@pEndDate) ,0)*-1 end as [Loan Balance],
isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and ChartOfAccountId in (select interestReceivablechartofaccountid from swiftfin_LoanProducts) and CreatedDate<=@pEndDate) ,0)*-1 as [Loan Interest Due],
isnull(case
when (select top 1 CreatedDate from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and (ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts)  or  ChartOfAccountId in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts)) and CreatedDate<=@pEndDate and amount>0 order by CreatedDate desc) is not null
then
(select top 1 CreatedDate from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and (ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) or  ChartOfAccountId in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts))
 and CreatedDate<=@pEndDate and amount>0 order by CreatedDate desc)
else
(select top 1 LastTrxDate from  swiftfin_AsmasData where Reference1=vw_CustomerAccounts.Reference1 and ProductID=vw_CustomerAccounts.CustomerAccountType_TargetProductId)
end,'11/03/2018')
 as [Last Installment Date1],
 isnull((select  top 1 dateadd(mm,1,Duration_StartDate) from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as 
 [Loan_First_Pmt_Date],
	isnull((select top 1 amount from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) and CreatedDate<=@pEndDate and amount>0 order by CreatedDate desc),0) 
  as [Latest Amount Paid],
isnull((select top 1 (select sum(AmountGuaranteed) from dbo.swiftfin_LoanGuarantors where LoanCaseId=swiftfin_LoanCases.id ) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),0) as [Amount of Guarantee],
isnull((select top 1 (select count(AmountGuaranteed) from dbo.swiftfin_LoanGuarantors where LoanCaseId=swiftfin_LoanCases.id ) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),0) as [No of Loan Guarantors]

into #tempLoans  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id where CustomerAccountType_TargetProductId in (select id from swiftfin_LoanProducts) order by CustomerAccountType_TargetProductId

select *, [Last Installment Date1] as [Last Installment Date],
case when datediff(dd,[Last Installment Date1],@pEndDate)<30 then 0 else (datediff(dd,[Last Installment Date1],@pEndDate))-30 end  [DaysInArrears]
  into #tempLoans1
from #tempLoans 

select  *,case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100
end as ClassOrder,
case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 'Performing'
WHEN DATEDIFF(dd,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60THEN 'Watch'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 'Substandard'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 'Doubtful'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 'Loss'
end as Classification,
DATEDIFF(MM,[Last Installment Date],@pEndDate) as DefaultFrequency,
case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100 end as Provision
into #tempFinal 
from #tempLoans1  where [Loan Balance]<>0  order by case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100 end
  select Classification,count(Reference1) as No_Of_Accounts,sum([Loan Balance]) as Balance,Provision,sum(Provision*[Loan Balance]*0.01) as Provision_Amount from #tempFinal 
  
  group by Classification,Provision
  order by provision


  ---sp_electroniclistBOSAFOSAloansSummarry '10/11/2018'
GO
/****** Object:  StoredProcedure [dbo].[sp_electroniclistBOSAFOSAloansSummarryAsmas]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---sp_electroniclistBOSAFOSAloansSummarryAsmas '12/14/2018'
CREATE  Procedure [dbo].[sp_electroniclistBOSAFOSAloansSummarryAsmas]
@pEndDate DateTime
as
--select disbursedBy from swiftfin_loancases order by createddate desc
set @pEndDate=	(select DATEADD(day, DATEDIFF(day, 0, @pEndDate), '23:59:59'));

select  Reference1,Reference2,Reference3,FullName, serialnumber,
(select description from swiftfin_branches where code=1) as [Branch Name],

isnull((select top 1 disbursedBy from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),'') as [Loan Officer],
vw_CustomerAccounts.description,
vw_CustomerAccounts.EmployerDescription,

case when (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) ='512' then 'Reducing Balance'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '513' then 'Straight Line'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '514' then 'Amortization (Straight Line)'
	 WHEN (select LoanInterest_CalculationMode from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) = '515' then 'Amortization (Diminishing Balance)'
	 END as [Loan Amortization Type],

isnull((select  top 1 Principal from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),0) as [Loan Instalments]
,(select LoanInterest_AnnualPercentageRate from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) as [Annual Loan Rate]
,(select LoanRegistration_TermInMonths from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId) as [Period]
,CASE (select LoanRegistration_PaymentFrequencyPerYear from swiftfin_LoanProducts where id =vw_CustomerAccounts.CustomerAccountType_TargetProductId)
WHEN 1 THEN 'Annual'
WHEN 2 THEN 'Semi-Annual (every 6 months)'
WHEN 3 THEN 'Quarterly (every 3 months)'
WHEN 4 THEN 'Tri-Annual (every 4 months)'
WHEN 6 THEN 'Bi-Monthly (every 2 months)'
WHEN 12 THEN 'Monthly'
WHEN 24 THEN 'Semi-Monthly (twice a month)'
WHEN 26 THEN 'Bi-Weekly (every 2 weeks)'
WHEN 52 THEN 'Weekly'
WHEN 256 THEN 'Daily'
END as [Loan Frequency],
isnull((select top 1 CaseNumber from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),
(select ABS(CHECKSUM(NewId())) % 2000))
 as [Loan Number],


isnull((select  top 1 Duration_StartDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Date Loan Disbursed],

isnull((select top 1 LoanAmount from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),0) as   [Loan Amount]
,
0.00 as TopUpAmount
,
isnull((select  top 1 Duration_EndDate from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as [Loan Maturity],
isnull((select Balance from  swiftfin_AsmasData2 where CustomerId=vw_CustomerAccounts.CustomerId and ProductID=vw_CustomerAccounts.CustomerAccountType_TargetProductId),0)  as [Loan Balance],
0 as [Loan Interest Due],
isnull((select top 1 LastTrxDate from  swiftfin_AsmasData where Reference1=vw_CustomerAccounts.Reference1 and ProductID=vw_CustomerAccounts.CustomerAccountType_TargetProductId)
,'11/03/2018')
 as [Last Installment Date1],
 isnull((select  top 1 dateadd(mm,1,Duration_StartDate) from swiftfin_StandingOrders where BeneficiaryCustomerAccountId=vw_CustomerAccounts.id ),'') as 
 [Loan_First_Pmt_Date],
	isnull((select top 1 amount from swiftfin_JournalEntries where CustomerAccountId =vw_CustomerAccounts.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) and CreatedDate<=@pEndDate and amount>0 order by CreatedDate desc),0) 
  as [Latest Amount Paid],
isnull((select top 1 (select sum(AmountGuaranteed) from dbo.swiftfin_LoanGuarantors where LoanCaseId=swiftfin_LoanCases.id ) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),0) as [Amount of Guarantee],
isnull((select top 1 (select count(AmountGuaranteed) from dbo.swiftfin_LoanGuarantors where LoanCaseId=swiftfin_LoanCases.id ) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate<=@pEndDate order by DisbursedDate desc),0) as [No of Loan Guarantors]

into #tempLoans  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id where CustomerAccountType_TargetProductId in (select id from swiftfin_LoanProducts) order by CustomerAccountType_TargetProductId

select *, [Last Installment Date1] as [Last Installment Date],
case when datediff(dd,[Last Installment Date1],@pEndDate)<30 then 0 else (datediff(dd,[Last Installment Date1],@pEndDate))-30 end  [DaysInArrears]
  into #tempLoans1
from #tempLoans 

select  *,case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100
end as ClassOrder,
case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 'Performing'
WHEN DATEDIFF(dd,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60THEN 'Watch'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 'Substandard'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 'Doubtful'
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 'Loss'
end as Classification,
DATEDIFF(MM,[Last Installment Date],@pEndDate) as DefaultFrequency,
case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100 end as Provision
into #tempFinal 
from #tempLoans1  where [Loan Balance]<>0  order by case 
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)<=30 THEN 1
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>30 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=60 THEN 5
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>60 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=180 THEN 25
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>180 and DATEDIFF(DD,[Last Installment Date],@pEndDate)<=360 THEN 50
WHEN DATEDIFF(DD,[Last Installment Date],@pEndDate)>360 THEN 100 end
  select Classification,count(Reference1) as No_Of_Accounts,sum([Loan Balance]) as Balance,Provision,sum(Provision*[Loan Balance]*0.01) as Provision_Amount from #tempFinal 
  
  group by Classification,Provision
  order by provision


  ---sp_electroniclistBOSAFOSAloansSummarry '10/11/2018'
GO
/****** Object:  StoredProcedure [dbo].[sp_EmployeeRegister]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
--select * from swiftfin_EmployeeTypes
--select * from swiftfin_Employees
-- =============================================
create procedure [dbo].[sp_EmployeeRegister] 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

 /****** Script for SelectTopNRows command from SSMS  ******/
SELECT  

	(SELECT
		SerialNumber
		FROM [dbo].[swiftfin_Customers] where Id=dbo.swiftfin_Employees.CustomerId) as PersonalFileNumber,
	(SELECT
		Individual_IdentityCardNumber
		FROM [dbo].[swiftfin_Customers] where Id=dbo.swiftfin_Employees.CustomerId) as IdentityCardNumber,
	(SELECT
		RIGHT('00000'+CAST(ltrim(rtrim(SerialNumber)) AS VARCHAR(6)),6) 
		FROM [dbo].[swiftfin_Customers] where Id=dbo.swiftfin_Employees.CustomerId) as MembershipNumber,
	(SELECT
		[Individual_FirstName]+' '+
		[Individual_LastName]
		FROM [dbo].[swiftfin_Customers] where Id=dbo.swiftfin_Employees.CustomerId) as EmployeeName,
	(SELECT [Description]
		FROM [dbo].[swiftfin_Branches] where id=dbo.swiftfin_Employees.BranchId) as BranchName,
	(SELECT 
		[Description]
		FROM [dbo].[swiftfin_Designations] where id=dbo.swiftfin_Employees.DesignationId) as Designation,  
	(SELECT
		[Description]
		FROM [dbo].[swiftfin_Departments] where id=dbo.swiftfin_Employees.DepartmentId) as Department,
(SELECT
		[Description]
		FROM [dbo].[swiftfin_EmployeeTypes] where id=dbo.swiftfin_Employees.EmployeeTypeId) As [Type],

	(SELECT
		[PersonalIdentificationNumber]
		FROM [dbo].[swiftfin_customers] where id=dbo.swiftfin_Employees.CustomerId) As [PersonalIdentificationNumber]
      ,[NationalSocialSecurityFundNumber]
      ,[NationalHospitalInsuranceFundNumber],
	   [BloodGroup] =
			CASE [BloodGroup]
				WHEN 0 THEN 'Unknown'
				WHEN 1 THEN 'A-'
				WHEN 2 THEN 'A+'
				WHEN 0 THEN 'B-'
				WHEN 1 THEN 'B+'
				WHEN 2 THEN 'AB-'
				WHEN 0 THEN 'AB+'
				WHEN 1 THEN 'O-'
				WHEN 2 THEN 'O+'
			END
      ,[Remarks]
      ,[IsLocked]
      ,[CreatedBy]
      ,[CreatedDate]
  FROM [dbo].[swiftfin_Employees]
END







GO
/****** Object:  StoredProcedure [dbo].[sp_EmployeeRegisterByGroups]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
create PROCEDURE [dbo].[sp_EmployeeRegisterByGroups]
	-- Ad
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here

	SELECT        dbo.swiftfin_SalaryGroups.Description AS SalaryGroup, dbo.swiftfin_SalaryCards.CardNumber, dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, 
                         dbo.vw_EmployeeRegister.IdentityCardNumber, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
                         dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.Designation, dbo.vw_EmployeeRegister.DateOfBirth,dbo.vw_EmployeeRegister.PersonalIdentificationNumber, 
                         dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber,
						 dbo.vw_EmployeeRegister.Individual_EmploymentDate
	FROM            dbo.swiftfin_SalaryCards INNER JOIN
                         dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.swiftfin_SalaryGroups ON dbo.swiftfin_SalaryCards.SalaryGroupId = dbo.swiftfin_SalaryGroups.Id
END




GO
/****** Object:  StoredProcedure [dbo].[sp_EmployerAttachmentReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 15.06.2014
-- Description:	sp_EmployerAttachmentReport
-- =============================================
--select * from swiftfin_PostingPeriods
---sp_EmployerAttachmentReport '0777363D-0845-C660-9E58-08D1336CB025',8
CREATE PROCEDURE [dbo].[sp_EmployerAttachmentReport] 
	-- Add the parameters for the stored procedure here
	@PostingPeriod Varchar(100), 
	@Month int = 1
AS
BEGIN

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SELECT ROW_NUMBER() OVER(ORDER BY dbo.vw_CustomerAccounts.Reference2) AS SNo,'14701' as VoteCode,dbo.vw_CustomerAccounts.Individual_PayrollNumbers as PNum,dbo.vw_CustomerAccounts.FullName as Name,'2641' as SaccoCode,CASE  upper(Products_1.type)
			WHEN 'INVESTMENTS' THEN 'S' WHEN 'LOANS' THEN 'L' END+REPLACE(STR(Products_1.Code, 2), SPACE(1), '0') +REPLACE(STR(dbo.vw_CustomerAccounts.serialnumber, 5), SPACE(1), '0')+REPLACE(STR(dbo.swiftfin_DataAttachmentEntries.SequenceNumber, 2), SPACE(1), '0') 
			AS AccountNo,'938' as EDCode,dbo.swiftfin_DataAttachmentEntries.NewAmount, dbo.swiftfin_DataAttachmentEntries.CurrentAmount,dbo.swiftfin_DataAttachmentEntries.NewBalance, dbo.swiftfin_DataAttachmentEntries.CurrentBalance,dbo.swiftfin_DataAttachmentEntries.TransactionType as TransType,
			case dbo.swiftfin_DataAttachmentEntries.TransactionType WHEN 1 THEN 'FreshLoan' WHEN 2 THEN 'Adjustment' END as TransName, 0 as Interest, case dbo.swiftfin_DataAttachmentEntries.TransactionType
			WHEN 1 THEN 2 WHEN 2 THEN 1 END as Action, dbo.swiftfin_DataAttachmentEntries.NewAbility as Ability, dbo.swiftfin_DataAttachmentEntries.CurrentAbility as Variated_ability,dbo.swiftfin_Employers.Description as Dept,dbo.swiftfin_Employers.Id,dbo.swiftfin_DataAttachmentEntries.Remarks,

replace(convert(NVARCHAR, DATEADD(month, ((year(dbo.swiftfin_PostingPeriods.Duration_StartDate)-1900) * 12) + dbo.swiftfin_DataAttachmentPeriods.Month, -1), 103), ' ', '/') as PayDate


FROM            dbo.swiftfin_Stations INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
                         dbo.swiftfin_DataAttachmentPeriods INNER JOIN
                         dbo.swiftfin_DataAttachmentEntries ON dbo.swiftfin_DataAttachmentPeriods.Id = dbo.swiftfin_DataAttachmentEntries.DataAttachmentPeriodId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_DataAttachmentEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_DataAttachmentPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id ON 
                         dbo.swiftfin_Stations.Id = dbo.vw_CustomerAccounts.StationId INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id


	WHERE dbo.swiftfin_DataAttachmentPeriods.PostingPeriodId= @PostingPeriod AND dbo.swiftfin_DataAttachmentPeriods.Month=@Month 
    -- Insert statements for procedure here
END






GO
/****** Object:  StoredProcedure [dbo].[sp_ExpectedVsActual]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from vw_CustomerAccounts where id='5CE23624-04B0-C79F-DE63-08D34A3ACE3F'
--select top 100 * from swiftfin_standingorderhistories
--select  * from swiftfin_CustomerAccountArrearages where CustomerAccountId='8834E9D7-9B8D-CB5C-7E2B-08D3030E1883' 
--select * from swiftfin_PostingPeriods
 ---sp_ExpectedVsActual '552DEB60-86EF-E711-948F-42F2E9267749','11/01/2018','11/21/2018'
 create Procedure [dbo].[sp_ExpectedVsActual] (@PostingPeriod uniqueidentifier,@StartDate datetime,  @EndDate datetime) as

set NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
with ActualvsExpectedCTE (ID,Reference1,Month,Reference2,FullName,ExpectedPrincipal,ExpectedInterest,ActualPrincipal,ActualInterest,PrincipalArrearsExpected,
InterestArrearsExpected,Description,DisbursedAmount,InterestArrearsRecovered,LoanArrearsRecovered)
as (
SELECT      distinct swiftfin_StandingOrderHistories.id, dbo.vw_CustomerAccounts.Reference1,  swiftfin_StandingOrderHistories.Month,
                         dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.FullName,
						 (dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal) as ExpectedPrincipal, 
						 (dbo.swiftfin_StandingOrderHistories.ExpectedInterest) as ExpectedInterest,
						  (dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as ActualPrincipal, 
						  (dbo.swiftfin_StandingOrderHistories.ActualInterest) as ActualInterest, 
                         --sum(dbo.swiftfin_StandingOrderHistories.PrincipalArrears) PrincipalArrearsExpected, sum(dbo.swiftfin_StandingOrderHistories.InterestArrears) InterestArrearsExpected,
						case when swiftfin_CustomerAccountArrearages.Category=0 then sum(isnull(swiftfin_CustomerAccountArrearages.amount,0)) end as PrincipalArrearsExpected,
						case when swiftfin_CustomerAccountArrearages.Category=1 then sum(isnull(swiftfin_CustomerAccountArrearages.amount,0)) end as InterestArrearsExpected,

						
						 vw_CustomerAccounts.Description
,isnull((select  sum(DisbursedAmount) from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=vw_CustomerAccounts.CustomerAccountType_TargetProductId and DisbursedDate between @StartDate and @EndDate),0) [Disbursed Amount],

isnull((SELECT        sum(amount) FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
where swiftfin_Journals.PrimaryDescription like '%arrears%' and swiftfin_JournalEntries.CreatedDate  between @StartDate and @EndDate
and swiftfin_journalentries.customeraccountid=vw_CustomerAccounts.id and ChartOfAccountId in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts)),0) InterestArrearsRecovered,
isnull((SELECT        sum(amount) FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
where swiftfin_Journals.PrimaryDescription like '%arrears%' and swiftfin_JournalEntries.CreatedDate  between @StartDate and @EndDate
and swiftfin_journalentries.customeraccountid=vw_CustomerAccounts.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts)),0) LoanArrearsRecovered

FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id inner join
swiftfin_CustomerAccountArrearages on dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId=swiftfin_CustomerAccountArrearages.CustomerAccountId
WHERE swiftfin_StandingOrderHistories.PostingPeriodId=@PostingPeriod and swiftfin_StandingOrderHistories.CreatedDate  between @StartDate and @EndDate

group by swiftfin_StandingOrderHistories.id, dbo.vw_CustomerAccounts.Reference1,  dbo.swiftfin_StandingOrderHistories.Month, vw_CustomerAccounts.Id,dbo.vw_CustomerAccounts.ChartOfAccountId,dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId,
                         dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.FullName,vw_CustomerAccounts.Description,vw_CustomerAccounts.CustomerId,vw_CustomerAccounts.CustomerAccountType_TargetProductId,
						 swiftfin_CustomerAccountArrearages.Amount,swiftfin_CustomerAccountArrearages.Category,
						 dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal,
						 dbo.swiftfin_StandingOrderHistories.ExpectedInterest, dbo.swiftfin_StandingOrderHistories.ActualPrincipal,
						 dbo.swiftfin_StandingOrderHistories.ActualInterest
)
select ID,Reference1,Month,Reference2,FullName,ExpectedPrincipal,ExpectedInterest,ActualInterest,ActualPrincipal,
sum(PrincipalArrearsExpected) as PrincipalArrearsExpected,sum(InterestArrearsExpected) as InterestArrearsExpected,Description,DisbursedAmount,InterestArrearsRecovered,LoanArrearsRecovered 
from ActualvsExpectedCTE 
group by ID, Reference1, Month, Reference2, FullName, ExpectedPrincipal, ExpectedInterest,ActualInterest,ActualPrincipal,
Description,DisbursedAmount,InterestArrearsRecovered,LoanArrearsRecovered
order by Reference1, Description

GO
/****** Object:  StoredProcedure [dbo].[sp_ExpensePayableEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[sp_ExpensePayableEntries] 
(
	@ExpensepayableId UniqueIdentifier
)
as
SELECT        dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_ChartOfAccounts.AccountName,dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ExpensePayableEntries.Value, dbo.swiftfin_ExpensePayableEntries.PrimaryDescription, 
                         dbo.swiftfin_ExpensePayableEntries.SecondaryDescription, dbo.swiftfin_ExpensePayableEntries.Reference,
                             (SELECT        Description
                               FROM            dbo.swiftfin_Enumerations
                               WHERE        ([Key] = 'ExpensePayableEntryStatus') AND (Value = dbo.swiftfin_ExpensePayableEntries.Status)) AS Status, dbo.swiftfin_ExpensePayableEntries.CreatedBy, 
                         dbo.swiftfin_ExpensePayableEntries.CreatedDate, case  when dbo.swiftfin_ExpensePayables.Type=1  then dbo.swiftfin_ExpensePayableEntries.Value else 0 end as Credit, case  when dbo.swiftfin_ExpensePayables.Type=2  then dbo.swiftfin_ExpensePayableEntries.Value else 0 end as Debit
FROM            dbo.swiftfin_ExpensePayableEntries INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_ExpensePayableEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_ExpensePayableEntries.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_ExpensePayables ON dbo.swiftfin_ExpensePayableEntries.ExpensePayableId = dbo.swiftfin_ExpensePayables.Id
						 where swiftfin_ExpensePayableEntries.expensepayableid=@ExpensepayableId

						



GO
/****** Object:  StoredProcedure [dbo].[SP_ExpensePayables]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE Procedure [dbo].[SP_ExpensePayables] (@VourcherNo Int) as

SELECT        dbo.swiftfin_ExpensePayables.ID,dbo.swiftfin_Branches.Description, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ExpensePayables.VoucherNumber, 
 (select Description from swiftfin_Enumerations where [key] ='ExpensePayableType' and value=swiftfin_ExpensePayables.Type) as Type,
                         dbo.swiftfin_ExpensePayables.ValueDate, dbo.swiftfin_ExpensePayables.Remarks, 
						 (select Description from swiftfin_Enumerations where [key] ='ExpensePayableStatus' and value=swiftfin_ExpensePayables.status) as Status,
						 dbo.swiftfin_ExpensePayables.TotalValue
						 , dbo.swiftfin_ExpensePayables.AuditedBy, dbo.swiftfin_ExpensePayables.AuditRemarks, 
                         dbo.swiftfin_ExpensePayables.AuditedDate, dbo.swiftfin_ExpensePayables.AuthorizedBy, dbo.swiftfin_ExpensePayables.AuthorizationRemarks, dbo.swiftfin_ExpensePayables.AuthorizedDate, 
                         dbo.swiftfin_ExpensePayables.CreatedBy, dbo.swiftfin_ExpensePayables.CreatedDate
FROM            dbo.swiftfin_ExpensePayables INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_ExpensePayables.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_ExpensePayables.BranchId = dbo.swiftfin_Branches.Id
						 Where swiftfin_ExpensePayables.VoucherNumber=@VourcherNo





GO
/****** Object:  StoredProcedure [dbo].[SP_ExpensePayables_1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE Procedure [dbo].[SP_ExpensePayables_1] 

(@StartDate datetime,
@EndDate datetime) as

SELECT        dbo.swiftfin_ExpensePayables.ID,dbo.swiftfin_Branches.Description, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ExpensePayables.VoucherNumber, 
 (select Description from swiftfin_Enumerations where [key] ='ExpensePayableType' and value=swiftfin_ExpensePayables.Type) as Type,
                         dbo.swiftfin_ExpensePayables.ValueDate, dbo.swiftfin_ExpensePayables.Remarks, 
						 (select Description from swiftfin_Enumerations where [key] ='ExpensePayableStatus' and value=swiftfin_ExpensePayables.status) as Status,
						 dbo.swiftfin_ExpensePayables.TotalValue
						 , dbo.swiftfin_ExpensePayables.AuditedBy, dbo.swiftfin_ExpensePayables.AuditRemarks, 
                         dbo.swiftfin_ExpensePayables.AuditedDate, dbo.swiftfin_ExpensePayables.AuthorizedBy, dbo.swiftfin_ExpensePayables.AuthorizationRemarks, dbo.swiftfin_ExpensePayables.AuthorizedDate, 
                         dbo.swiftfin_ExpensePayables.CreatedBy, dbo.swiftfin_ExpensePayables.CreatedDate
FROM            dbo.swiftfin_ExpensePayables INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_ExpensePayables.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_ExpensePayables.BranchId = dbo.swiftfin_Branches.Id
						 Where dbo.swiftfin_ExpensePayables.CreatedDate between @StartDate and @EndDate






GO
/****** Object:  StoredProcedure [dbo].[sp_ExternalCheckoff]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_chartofaccounts order by accountcode
--sp_ExternalCheckoff '09/01/2015','09/30/2015', '885DB963-361B-CC63-4151-08D1AC53DC06'

CREATE PROCEDURE [dbo].[sp_ExternalCheckoff] 
	@StartingDate DateTime,
	@EndingDate DateTime,
	@ChartOfAccountID UniqueIdentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	--set @Month=ltrim(rtrim(@Month))
    -- Insert statements for procedure here

SELECT        dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.PostingPeriodId, dbo.swiftfin_Journals.BranchId, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
              dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount as Principal,0 as Interest, LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_FirstName)) + ' ' + LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS FullName, 
              dbo.swiftfin_Customers.Individual_Salutation, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Employers.Description AS Employer, 
              dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection,swiftfin_ChartOfAccounts.CostCenterId,swiftfin_LoanProducts.Id,swiftfin_LoanProducts.Description as ProductName,
			  dbo.swiftfin_Branches.id, swiftfin_Enumerations.Value
									 
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
              dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
	          dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
              dbo.swiftfin_Enumerations ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_Enumerations.Value
WHERE         swiftfin_JournalEntries.ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) and 
              swiftfin_Journals.CreatedDate between @StartingDate and @EndingDate and (dbo.swiftfin_Journals.TransactionCode =32)  
			  --(dbo.swiftfin_JournalEntries.ChartOfAccountId = @ChartofAccountID) and 
UNION
SELECT        dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.PostingPeriodId, dbo.swiftfin_Journals.BranchId, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
              dbo.swiftfin_ChartOfAccounts.AccountName, 0 as Principal,Amount as Interest, ltrim(rtrim(dbo.swiftfin_Customers.Individual_FirstName))+' '+ ltrim(rtrim(dbo.swiftfin_Customers.Individual_LastName)) as FullName, dbo.swiftfin_Customers.Individual_Salutation, 
              dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3,  dbo.swiftfin_Employers.Description as Employer, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection, 
			  swiftfin_ChartOfAccounts.CostCenterId,swiftfin_LoanProducts.Id,swiftfin_LoanProducts.Description as ProductName, dbo.swiftfin_Branches.Id, swiftfin_Enumerations.Value
			
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId INNER JOIN
              dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
	          dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
              dbo.swiftfin_Enumerations ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_Enumerations.Value
WHERE         swiftfin_JournalEntries.ChartOfAccountId  in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts) and
			   swiftfin_Journals.CreatedDate between @StartingDate and @EndingDate and  (dbo.swiftfin_Journals.TransactionCode =32) 
--and (dbo.swiftfin_JournalEntries.ChartOfAccountId = @ChartofAccountID)

END        





GO
/****** Object:  StoredProcedure [dbo].[sp_ExternalChequesListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---sp_ExternalChequesBankedListing '01/01/2014','04/04/2014'
---[sp_ExternalChequesListing] '08/28/2017','08/30/2017','createdDate'
CREATE  PROCEDURE [dbo].[sp_ExternalChequesListing]
	@StartDate Datetime,
	@EndDate Datetime,
	@DisplayField varchar(50)
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

 SELECT        RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_Branches.Code)) AS VARCHAR(3)), 3) + '-' + RIGHT('000000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber)) AS VARCHAR(6)), 6) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode)) AS VARCHAR(5)), 5) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode)) AS VARCHAR(5)), 5) AS FullAccount, 
                         dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Tellers.Description AS ReceivedBy, 
                         dbo.swiftfin_ExternalCheques.Number, dbo.swiftfin_ExternalCheques.Amount, dbo.swiftfin_ExternalCheques.Drawer, dbo.swiftfin_ExternalCheques.DrawerBank, dbo.swiftfin_ExternalCheques.DrawerBankBranch, 
                         dbo.swiftfin_ExternalCheques.WriteDate, dbo.swiftfin_ChequeTypes.Description AS ChequeType, dbo.swiftfin_ExternalCheques.IsCleared, dbo.swiftfin_ExternalCheques.ClearedBy, dbo.swiftfin_ExternalCheques.MaturityDate, 
                         dbo.swiftfin_ExternalCheques.IsBanked, dbo.swiftfin_ExternalCheques.BankedBy, dbo.swiftfin_ExternalCheques.ClearedDate, dbo.swiftfin_ExternalCheques.IsTransferred, dbo.swiftfin_ExternalCheques.TransferredBy, 
                         dbo.swiftfin_ExternalCheques.TransferredDate, dbo.swiftfin_ExternalCheques.CreatedBy, dbo.swiftfin_ExternalCheques.CreatedDate, dbo.swiftfin_ExternalCheques.BankedDate, dbo.swiftfin_CustomerAccounts.BranchId
FROM            dbo.swiftfin_ChequeTypes INNER JOIN
                         dbo.swiftfin_Tellers INNER JOIN
                         dbo.swiftfin_ExternalCheques ON dbo.swiftfin_Tellers.Id = dbo.swiftfin_ExternalCheques.TellerId ON dbo.swiftfin_ChequeTypes.Id = dbo.swiftfin_ExternalCheques.ChequeTypeId LEFT OUTER JOIN
                         dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId ON dbo.swiftfin_Branches.Id = dbo.swiftfin_CustomerAccounts.BranchId ON 
                         dbo.swiftfin_ExternalCheques.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id

Where                     --dbo.swiftfin_ExternalCheques.CreatedBy='Emutethia' and convert(varchar(10),dbo.swiftfin_ExternalCheques.CreatedDate,103)='30/08/2017'
CASE 
	WHEN @DisplayField='BankedDate' then dbo.swiftfin_ExternalCheques.BankedDate
	WHEN @DisplayField='TransferredDate' then dbo.swiftfin_ExternalCheques.TransferredDate
	WHEN @DisplayField='CreatedDate' then dbo.swiftfin_ExternalCheques.CreatedDate
	WHEN @DisplayField='ClearedDate' then dbo.swiftfin_ExternalCheques.ClearedDate
	WHEN @DisplayField='MaturityDate' then dbo.swiftfin_ExternalCheques.MaturityDate

end
between @StartDate and @EndDate


END





GO
/****** Object:  StoredProcedure [dbo].[sp_ExternalChequesUnclearedORUnbanked]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_ExternalChequesUnclearedORUnbanked]
	@DisplayField varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

 SELECT        
						 RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_Branches.Code)) AS VARCHAR(3)), 3) + '-' + RIGHT('000000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber))
                          AS VARCHAR(6)), 6) + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode)) AS VARCHAR(5)), 5) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode)) AS VARCHAR(5)), 5) AS FullAccount, 
						 isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,'') + ltrim(rtrim(isnull(dbo.swiftfin_Customers.NonIndividual_Description,''))) AS FullName, dbo.swiftfin_Tellers.Description AS ReceivedBy, 
                         dbo.swiftfin_ExternalCheques.Number,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_ExternalCheques.Amount, dbo.swiftfin_ExternalCheques.Drawer, dbo.swiftfin_ExternalCheques.DrawerBank, 
                         dbo.swiftfin_ExternalCheques.DrawerBankBranch, dbo.swiftfin_ExternalCheques.WriteDate, dbo.swiftfin_ChequeTypes.Description as ChequeType, 
                         dbo.swiftfin_ExternalCheques.IsCleared, dbo.swiftfin_ExternalCheques.ClearedBy, dbo.swiftfin_ExternalCheques.MaturityDate, 
                         dbo.swiftfin_ExternalCheques.IsBanked, dbo.swiftfin_ExternalCheques.BankedBy, dbo.swiftfin_ExternalCheques.ClearedDate, dbo.swiftfin_ExternalCheques.IsTransferred, 
                         dbo.swiftfin_ExternalCheques.TransferredBy, dbo.swiftfin_ExternalCheques.TransferredDate , dbo.swiftfin_ExternalCheques.CreatedBy, 
                         dbo.swiftfin_ExternalCheques.CreatedDate ,dbo.swiftfin_ExternalCheques.BankedDate 

FROM            dbo.swiftfin_ExternalCheques INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_ExternalCheques.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_ExternalCheques.TellerId = dbo.swiftfin_Tellers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id INNER JOIN 
						 dbo.swiftfin_ChequeTypes On dbo.swiftfin_ChequeTypes.id = dbo.swiftfin_ExternalCheques.ChequeTypeId

Where 
CASE 
	WHEN @DisplayField='BankedDate' then dbo.swiftfin_ExternalCheques.BankedDate
	WHEN @DisplayField='ClearedDate' then dbo.swiftfin_ExternalCheques.ClearedDate
end
is null
order by RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_Branches.Code)) AS VARCHAR(3)), 3) + '-' + RIGHT('000000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber))
                          AS VARCHAR(6)), 6) + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode)) AS VARCHAR(5)), 5) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode)) AS VARCHAR(5)), 5) 
END










GO
/****** Object:  StoredProcedure [dbo].[sp_FailedStandingOrders]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---sp_FailedStandingOrders '05/01/2015','09/17/2015'
CREATE PROCEDURE [dbo].[sp_FailedStandingOrders]
	@StartDate DateTime,
	@EndDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	SELECT        dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal, dbo.swiftfin_StandingOrderHistories.ExpectedInterest, dbo.swiftfin_StandingOrderHistories.ActualPrincipal, dbo.swiftfin_StandingOrderHistories.ActualInterest, 
							 dbo.swiftfin_StandingOrderHistories.Charge_FixedAmount, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3, 
							 dbo.vw_CustomerAccounts.FullName, DATENAME(m, str(dbo.swiftfin_StandingOrderHistories.Month) + '/1/2011') as Month, Products_1.Description
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE         (dbo.swiftfin_StandingOrderHistories.ActualPrincipal = 0) and CreatedDate between @StartDate and @EndDate

END






GO
/****** Object:  StoredProcedure [dbo].[Sp_FailedTextAlerts]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Procedure [dbo].[Sp_FailedTextAlerts]

@StartDate DateTime,
@EndDate DateTime

as
SELECT        swiftfin_Customers.Reference1, (swiftfin_Customers.Individual_FirstName +''+ swiftfin_Customers.Individual_LastName) as Name, swiftfin_TextAlerts.TextMessage_Recipient, swiftfin_TextAlerts.CreatedDate
FROM            swiftfin_TextAlerts INNER JOIN
                         swiftfin_Customers ON swiftfin_TextAlerts.TextMessage_Recipient = swiftfin_Customers.Address_MobileLine

						 where swiftfin_TextAlerts.TextMessage_DLRStatus=2 and swiftfin_TextAlerts.CreatedDate between @StartDate and @EndDate




GO
/****** Object:  StoredProcedure [dbo].[sp_FileMovementRegisterByReceiveDate]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---sp_FileMovementRegisterByReceiveDate
CREATE PROCEDURE [dbo].[sp_FileMovementRegisterByReceiveDate]

	@StartDate as datetime,
	@EndDate as datetime
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
 
SELECT        CASE [Status] WHEN '51898' THEN 'Dispatched' WHEN '51899' THEN 'Received' ELSE 'UnKnown' END AS Status, 
                         RIGHT('00000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber)) AS VARCHAR(6)), 6) AS MembershipNumber, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers as PersonalFileNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5' THEN
                          'Prof' WHEN '5' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '10' THEN 'Sir' WHEN '11' THEN 'Ms'
                          ELSE 'UnKnown' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         dbo.swiftfin_Departments.Description AS SourceDepartment, swiftfin_Departments_1.Description AS DestinationDepartment, dbo.swiftfin_FileMovementHistories.Remarks, 
                         dbo.swiftfin_FileMovementHistories.Carrier, dbo.swiftfin_FileMovementHistories.Sender, dbo.swiftfin_FileMovementHistories.SendDate, 
                         dbo.swiftfin_FileMovementHistories.Recipient, convert(varchar(10),dbo.swiftfin_FileMovementHistories.ReceiveDate,103) as ReceiveDate, 
						 dbo.swiftfin_FileMovementHistories.ReceiveDate as ReceiveDateSorted,  dbo.swiftfin_FileMovementHistories.CreatedDate
FROM            dbo.swiftfin_FileRegisters INNER JOIN 
                         dbo.swiftfin_FileMovementHistories ON dbo.swiftfin_FileRegisters.Id = dbo.swiftfin_FileMovementHistories.FileRegisterId INNER JOIN
                         dbo.swiftfin_Departments ON dbo.swiftfin_FileMovementHistories.SourceDepartmentId = dbo.swiftfin_Departments.Id INNER JOIN
                         dbo.swiftfin_Departments AS swiftfin_Departments_1 ON dbo.swiftfin_FileMovementHistories.DestinationDepartmentId = swiftfin_Departments_1.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_FileRegisters.CustomerId = dbo.swiftfin_Customers.Id
Where			dbo.swiftfin_FileMovementHistories.ReceiveDate Between @StartDate AND @EndDate

END










GO
/****** Object:  StoredProcedure [dbo].[sp_FileMovementRegisterForSingleFile]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================


CREATE PROCEDURE [dbo].[sp_FileMovementRegisterForSingleFile]

	@MembershipNumber1 as varchar(10),
	@MembershipNumber2 as varchar(10),

	@StartDate as datetime,
	@EndDate as datetime
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '11:59:59'));
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	--select   REPLACE(STR(MembershipNumber, 5), SPACE(1), '0')  from swiftfin_Customers
	
	SET NOCOUNT ON;
 
SELECT        CASE [Status] WHEN '51898' THEN 'Dispatched' WHEN '51899' THEN 'Received' ELSE 'UnKnown' END AS Status, 
                         REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 5), SPACE(1), '0') AS MembershipNumber, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818' THEN
                          'Prof' WHEN '48819' THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN 'Ms'
                          ELSE 'UnKnown' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         dbo.swiftfin_Departments.Description AS SourceDepartment, swiftfin_Departments_1.Description AS DestinationDepartment, dbo.swiftfin_FileMovementHistories.Remarks, 
                         dbo.swiftfin_FileMovementHistories.Carrier, dbo.swiftfin_FileMovementHistories.Sender, dbo.swiftfin_FileMovementHistories.SendDate, 
                         dbo.swiftfin_FileMovementHistories.Recipient, dbo.swiftfin_FileMovementHistories.ReceiveDate, dbo.swiftfin_FileMovementHistories.CreatedDate
FROM            dbo.swiftfin_FileRegisters INNER JOIN
                         dbo.swiftfin_FileMovementHistories ON dbo.swiftfin_FileRegisters.Id = dbo.swiftfin_FileMovementHistories.FileRegisterId INNER JOIN
                         dbo.swiftfin_Departments ON dbo.swiftfin_FileMovementHistories.SourceDepartmentId = dbo.swiftfin_Departments.Id INNER JOIN
                         dbo.swiftfin_Departments AS swiftfin_Departments_1 ON dbo.swiftfin_FileMovementHistories.DestinationDepartmentId = swiftfin_Departments_1.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_FileRegisters.CustomerId = dbo.swiftfin_Customers.Id
Where			REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') between REPLACE(STR(@MembershipNumber1, 5), SPACE(1), '0') and REPLACE(STR(@MembershipNumber2, 5), SPACE(1), '0')  
				AND dbo.swiftfin_FileMovementHistories.CreatedDate BETWEEN @StartDate AND @EndDate
ORDER BY status,dbo.swiftfin_Customers.SerialNumber,CreatedDate
END










GO
/****** Object:  StoredProcedure [dbo].[sp_FinancialStatementBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

---[sp_FinancialStatementBranch] '12/31/2014','77898C54-67FE-C2DF-8E3C-08D0F8307E3A'
CREATE PROCEDURE [dbo].[sp_FinancialStatementBranch] 
	-- Add the parameters for the stored procedure here
	@Enddate datetime,@Branch varchar(Max)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	---select * from swiftfin_JournalEntries
 SELECT 	[AccountType],
			[AccountTypeCode] =
			CASE [AccountType]
				WHEN 100000 THEN 'Assets'
				WHEN 200000 THEN 'Liabilities'
				WHEN 300000 THEN 'Equity'
				WHEN 400000 THEN 'Income'
				WHEN 500000 THEN 'Expenses'
			END,
			left(AccountCode,3) as ShortCode,
			space(depth*4)+ ltrim(rtrim(AccountCode))+' '+ltrim([AccountName]) as Code
			,
			isnull((
				SELECT sum(isnull(amount,0)) 
				FROM [dbo].[swiftfin_JournalEntries] 
				where JournalId in 
				(
					select id from swiftfin_Journals where BranchId=@Branch and CreatedDate<=@Enddate --'77898C54-67FE-C2DF-8E3C-08D0F8307E3A'
				) and ChartOfAccountId=[dbo].[swiftfin_ChartOfAccounts].Id
				
 			),0) as Balance
	  FROM [dbo].[swiftfin_ChartOfAccounts] order by AccountType,AccountCode
	

END












GO
/****** Object:  StoredProcedure [dbo].[sp_FinancialSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



--select * from swiftfin_Enumerations where [key] = 'SystemGeneralLedgerAccountCode'
---select * from swiftfin_ChartOfAccounts order by AccountCode
---sp_FinancialSummary  '05/31/2017',3
CREATE procedure [dbo].[sp_FinancialSummary] (@EndDate DateTime ,@Type int)
as
/*1 = Trial Balance
  2 = Income and Expenditure
  3 = Balance Sheet
*/
declare @ProfitAndLossAccountID uniqueidentifier;
declare @ProfitAndLossAccountAmount money;

set @ProfitAndLossAccountID=(select ChartOfAccountId from swiftfin_SystemGeneralLedgerAccountMappings
 where SystemGeneralLedgerAccountCode='48831');
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
set @ProfitAndLossAccountAmount =isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) 
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id where swiftfin_ChartOfAccounts.AccountType in (4000,5000)),0);
WITH Hierarchy(ChildId, ChildName, Generation, ParentId,AccountCode,ParentName,ParentCode,CostCenterId,AccountType)
AS
(
    SELECT Id, AccountName, 0, ParentId,AccountCode,AccountName,AccountCode,CostCenterId,AccountType
        FROM swiftfin_ChartOfAccounts AS FirtGeneration
        WHERE ParentId IS NULL        
    UNION ALL
    SELECT NextGeneration.Id, NextGeneration.AccountName, Parent.Generation + 1, Parent.ChildId,NextGeneration.AccountCode,Parent.ChildName,Parent.AccountCode,NextGeneration.CostCenterId,NextGeneration.AccountType 
        FROM swiftfin_ChartOfAccounts AS NextGeneration
        INNER JOIN Hierarchy AS Parent ON NextGeneration.ParentId = Parent.ChildId    
)


SELECT *
   into #temp FROM Hierarchy 
    OPTION(MAXRECURSION 32767) ;

if @Type=1 /*Trial Balance*/
begin
	WITH CTE (AccountCode,ChildName,Generation,ParentCode,ParentName,Balance,CostCenterId)
	as
	(select AccountCode,ChildName,Generation,ParentCode,ParentName,
	isnull((select sum(amount) from swiftfin_JournalEntries where ChartOfAccountId=#temp.ChildId and CreatedDate<=@EndDate),0),CostCenterId from #temp
	) select AccountCode,ChildName AccountName,ParentCode,ParentName,
	case When BAlance<0 then Balance*-1 else 0 end as Debit,
	case When BAlance>0 then Balance else 0 end as Credit,
	isnull((select Description from swiftfin_CostCenters where id=cte.CostCenterId),'Back Office') CostCenter,
	left(rtrim(ltrim(str(AccountCode))),1) as Type,
	case 
	when left(rtrim(ltrim(str(AccountCode))),1)=1 then 'Assets' 
	when left(rtrim(ltrim(str(AccountCode))),1)=2 then 'Liabilities' 
	when left(rtrim(ltrim(str(AccountCode))),1)=3 then 'Equity' 
	when left(rtrim(ltrim(str(AccountCode))),1)=4 then 'Incomes' 
	when left(rtrim(ltrim(str(AccountCode))),1)=5 then 'Expenses' 
	end TypeName
	 from CTE  where BAlance<>0 order by AccountCode
end
else if @Type=2 /* Income and Expenditure */
begin
	WITH CTE (AccountCode,ChildName,Generation,ParentCode,ParentName,Balance,CostCenterId)
	as
	(select AccountCode,ChildName,Generation,ParentCode,ParentName,
	isnull((select sum(amount) from swiftfin_JournalEntries where ChartOfAccountId=#temp.ChildId and CreatedDate<=@EndDate),0),CostCenterId from #temp where AccountType in (4000,5000)
	union
	select 5999999,'Surplus/Loss Account',1,5990000,'Appropriation Account',
	isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) 
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id where swiftfin_ChartOfAccounts.AccountType in (4000,5000)),0) Balance,
	(select top 1 id from swiftfin_CostCenters where Description like '%Bosa%')

	) select AccountCode,ChildName AccountName,ParentCode,ParentName,
	case When BAlance<0 then Balance*-1 else 0 end as Debit,
	case When BAlance>0 then Balance else 0 end as Credit,
	isnull((select ltrim(rtrim(Description)) from swiftfin_CostCenters where id=cte.CostCenterId),'Back Office') CostCenter,
	left(rtrim(ltrim(str(AccountCode))),1) as Type,
	case 
	when left(rtrim(ltrim(str(AccountCode))),1)=1 then 'Assets' 
	when left(rtrim(ltrim(str(AccountCode))),1)=2 then 'Liabilities' 
	when left(rtrim(ltrim(str(AccountCode))),1)=3 then 'Equity' 
	when left(rtrim(ltrim(str(AccountCode))),1)=4 then 'Incomes' 
	when left(rtrim(ltrim(str(AccountCode))),1)=5 then 'Expenses' 
	end as TypeName
	 from CTE  where BAlance<>0 order by AccountCode
end
else if @Type=3 /*Balance Sheet*/
begin
	WITH CTE (AccountCode,ChildName,Generation,ParentCode,ParentName,Balance,CostCenterId)
	as
	(select AccountCode,ChildName,Generation,ParentCode,ParentName,
	isnull((select sum(amount) from swiftfin_JournalEntries where ChartOfAccountId=#temp.ChildId and CreatedDate<=@EndDate),0),CostCenterId from #temp where AccountType not in (4000,5000)
	union
	select 
	(select AccountCode from swiftfin_ChartOfAccounts where id=@ProfitAndLossAccountID),
	(select accountname from swiftfin_ChartOfAccounts where id=@ProfitAndLossAccountID),
	1,2990000,
	(select accountname from swiftfin_ChartOfAccounts where id=@ProfitAndLossAccountID),
	@ProfitAndLossAccountAmount,
	(select top 1 id from swiftfin_CostCenters where Description like '%Bosa%')
	) select AccountCode,ChildName AccountName,ParentCode,ParentName,
	case When BAlance<0 then Balance*-1 else 0 end as Debit,
	case When BAlance>0 then Balance else 0 end as Credit,
	isnull((select ltrim(rtrim(Description)) from swiftfin_CostCenters where id=cte.CostCenterId),'Back Office') CostCenter,
	left(rtrim(ltrim(str(AccountCode))),1) as Type,
	case 
	when left(rtrim(ltrim(str(AccountCode))),1)=1 then 'Assets' 
	when left(rtrim(ltrim(str(AccountCode))),1)=2 then 'Liabilities' 
	when left(rtrim(ltrim(str(AccountCode))),1)=3 then 'Equity' 
	when left(rtrim(ltrim(str(AccountCode))),1)=4 then 'Incomes' 
	when left(rtrim(ltrim(str(AccountCode))),1)=5 then 'Expenses' 
	end TypeName
 from CTE where BAlance<>0 order by AccountCode
end
else
begin
	WITH CTE (AccountCode,ChildName,Generation,ParentCode,ParentName,Balance,CostCenterId)
	as
	(select AccountCode,ChildName,Generation,ParentCode,ParentName,
	isnull((select sum(amount) from swiftfin_JournalEntries where ChartOfAccountId=#temp.ChildId and CreatedDate<=@EndDate),0),CostCenterId from #temp where AccountType not in (4000,5000)
	union
	select 
	(select AccountCode from swiftfin_ChartOfAccounts where id=@ProfitAndLossAccountID),
	(select accountname from swiftfin_ChartOfAccounts where id=@ProfitAndLossAccountID),
	1,4990000,
	(select accountname from swiftfin_ChartOfAccounts where id=@ProfitAndLossAccountID),
	@ProfitAndLossAccountAmount,
	(select top 1 id from swiftfin_CostCenters where Description like '%Bosa%')
	) select AccountCode,ChildName AccountName,ParentCode,ParentName,
	case When BAlance<0 then Balance*-1 else 0 end as Debit,
	case When BAlance>0 then Balance else 0 end as Credit,
	isnull((select ltrim(rtrim(Description)) from swiftfin_CostCenters where id=cte.CostCenterId),'Back Office') CostCenter,
	left(rtrim(ltrim(str(AccountCode))),1) as Type,
	case 
	when left(rtrim(ltrim(str(AccountCode))),1)=1 then 'Assets' 
	when left(rtrim(ltrim(str(AccountCode))),1)=2 then 'Liabilities' 
	when left(rtrim(ltrim(str(AccountCode))),1)=3 then 'Equity' 
	when left(rtrim(ltrim(str(AccountCode))),1)=4 then 'Incomes' 
	when left(rtrim(ltrim(str(AccountCode))),1)=5 then 'Expenses' 
	end TypeName
	 from CTE where BAlance<>0 order by AccountCode
	 
end


GO
/****** Object:  StoredProcedure [dbo].[sp_FindCustomerAccountById]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Name
-- Create date: 
-- Description:	
-- =============================================
CREATE PROCEDURE [dbo].[sp_FindCustomerAccountById] 
	-- Add the parameters for the stored procedure here
	@pCustomerAccountId varchar(100) = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT        dbo.swiftfin_CustomerAccounts.Id, dbo.swiftfin_CustomerAccounts.CustomerId, dbo.swiftfin_CustomerAccounts.BranchId, dbo.swiftfin_Branches.Code as BranchCode,
                         dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId, 
                         dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, dbo.swiftfin_CustomerAccounts.Remarks, dbo.swiftfin_CustomerAccounts.CreatedDate, 
                         dbo.swiftfin_CustomerAccounts.Status, dbo.swiftfin_CustomerAccounts.CreatedBy, Products_1.ChartOfAccountId, Products_1.InterestReceivable, 
                         CASE WHEN dbo.swiftfin_Employees.Id IS NOT NULL THEN 1 ELSE 0 END AS isEmployee, dbo.swiftfin_Customers.Individual_FirstName, 
                         dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers, 
                         dbo.swiftfin_Customers.Individual_Salutation, dbo.swiftfin_Customers.Individual_Gender, dbo.swiftfin_Customers.Individual_MaritalStatus, 
                         dbo.swiftfin_Customers.Individual_Nationality, dbo.swiftfin_Customers.Individual_BirthDate, dbo.swiftfin_Customers.Individual_EmploymentDesignation, 
                         dbo.swiftfin_Customers.Individual_EmploymentTermsOfService, dbo.swiftfin_Customers.Individual_EmploymentDate, dbo.swiftfin_Customers.NonIndividual_Description, 
                         dbo.swiftfin_Customers.NonIndividual_RegistrationNumber, dbo.swiftfin_Customers.PersonalIdentificationNumber, 
                         dbo.swiftfin_Customers.NonIndividual_DateEstablished, dbo.swiftfin_Customers.Address_AddressLine1, dbo.swiftfin_Customers.Address_AddressLine2, 
                         dbo.swiftfin_Customers.Address_Street, dbo.swiftfin_Customers.Address_PostalCode, dbo.swiftfin_Customers.Address_City, dbo.swiftfin_Customers.Address_Email, 
                         dbo.swiftfin_Customers.Address_LandLine, dbo.swiftfin_Customers.Address_MobileLine, dbo.swiftfin_Customers.StationId, dbo.swiftfin_Customers.Reference1, 
                         dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Customers.Remarks AS CustomerRemarks, 
                         dbo.swiftfin_Customers.IsLocked, dbo.swiftfin_Customers.RegistrationDate, dbo.swiftfin_Customers.CreatedBy AS CustomerCreatedBy, 
                         dbo.swiftfin_Customers.CreatedDate AS CustomerCreatedDate, dbo.swiftfin_Customers.PassportImageId, dbo.swiftfin_Customers.SignatureImageId, 
                         dbo.swiftfin_Customers.IdentityCardFrontSideImageId, dbo.swiftfin_Customers.IdentityCardBackSideImageId, dbo.swiftfin_Customers.SerialNumber, 
                         dbo.swiftfin_Customers.Type
FROM            dbo.swiftfin_CustomerAccounts 
						 INNER JOIN dbo.Products(0) AS Products_1 ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id 
						 INNER JOIN dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id 
						 INNER JOIN dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id 
						 LEFT OUTER JOIN dbo.swiftfin_Employees ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Employees.CustomerId
WHERE swiftfin_CustomerAccounts.[Id] = @pCustomerAccountId;
END







GO
/****** Object:  StoredProcedure [dbo].[sp_FindCustomerAccountByTargetProductId]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Name
-- Create date: 
-- Description:	
-- =============================================
CREATE PROCEDURE [dbo].[sp_FindCustomerAccountByTargetProductId] 
	-- Add the parameters for the stored procedure here
	@pCustomerAccountType_TargetProductId varchar(100) = 0 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT * FROM swiftfin_CustomerAccounts WHERE [CustomerAccountType_TargetProductId] =@pCustomerAccountType_TargetProductId;
END



GO
/****** Object:  StoredProcedure [dbo].[sp_FindCustomerAccountByTargetProductIdAndCustomerId]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Name
-- Create date: 
-- Description:	
-- =============================================
CREATE PROCEDURE [dbo].[sp_FindCustomerAccountByTargetProductIdAndCustomerId] 
	-- Add the parameters for the stored procedure here
	@pCustomerAccountType_TargetProductId varchar(100) = 0, 
	@pCustomerId varchar(100) = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT TOP 1 * FROM swiftfin_CustomerAccounts WHERE [CustomerId] = @pCustomerId AND [CustomerAccountType_TargetProductId] =@pCustomerAccountType_TargetProductId;
END







GO
/****** Object:  StoredProcedure [dbo].[sp_FindCustomerAccountByTargetProductIdAndPayrollNumber]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


create PROCEDURE [dbo].[sp_FindCustomerAccountByTargetProductIdAndPayrollNumber] 
	-- Add the parameters for the stored procedure here
	@pCustomerAccountType_TargetProductId varchar(100) = '', 
	@pIndividual_PayrollNumber varchar(100) = ''
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	Declare 	@pLocalCustomerAccountType_TargetProductId varchar(100) = @pCustomerAccountType_TargetProductId, 
				@pLocalIndividual_PayrollNumber varchar(100) = @pIndividual_PayrollNumber
	SELECT *
	FROM swiftfin_CustomerAccounts 
	WHERE  CustomerId IN (SELECT Id FROM swiftfin_Customers WHERE CONTAINS(Individual_PayrollNumbers,@pLocalIndividual_PayrollNumber))
	AND CustomerAccountType_TargetProductId =@pLocalCustomerAccountType_TargetProductId

	
END



GO
/****** Object:  StoredProcedure [dbo].[sp_FindCustomerAccountByTargetProductIdAndReference3]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[sp_FindCustomerAccountByTargetProductIdAndReference3] 
	-- Add the parameters for the stored procedure here
	@pCustomerAccountType_TargetProductId varchar(100) = '', 
	@pReference3 varchar(100) = ''
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	SELECT *
	FROM swiftfin_CustomerAccounts 
	WHERE  CustomerId IN (SELECT Id FROM swiftfin_Customers WHERE CONTAINS(Reference3, @pReference3))
	AND CustomerAccountType_TargetProductId =@pCustomerAccountType_TargetProductId

	
END


GO
/****** Object:  StoredProcedure [dbo].[sp_FindCustomerByPayrollNumber]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Centrino
-- Create date: 01.06.2014
-- Description:	FindCustomerAccount
-- =============================================
---sp_FindCustomerAccountByTargetProductIdAndPayrollNumber '68E8206F-3B52-CCBE-F04C-08D133526BAB','BPN/PC0233954_1'

create PROCEDURE [dbo].[sp_FindCustomerByPayrollNumber]
	-- Add the parameters for the stored procedure here
	@pIndividual_PayrollNumber varchar(100) = ''
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	SELECT *
	FROM swiftfin_Customers WHERE CONTAINS(Individual_PayrollNumbers,@pIndividual_PayrollNumber)


	
END






GO
/****** Object:  StoredProcedure [dbo].[sp_FindCustomerLoanAccountsGivenEmployerAndLoanProduct]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 20.06.2014
-- Description:	FindCustomerLoanAccountsGivenEmployerAndLoanProduct
-- =============================================
CREATE PROCEDURE [dbo].[sp_FindCustomerLoanAccountsGivenEmployerAndLoanProduct] 
	-- Add the parameters for the stored procedure here
	@EmployerID Varchar(100) , 
	@LoanProductID varchar(100) 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT        dbo.swiftfin_CustomerAccounts.*
	FROM            dbo.swiftfin_Zones INNER JOIN
							 dbo.swiftfin_Stations ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Stations.ZoneId INNER JOIN
							 dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
							 dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_Stations.Id = dbo.swiftfin_Customers.StationId INNER JOIN
							 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id
	WHERE dbo.swiftfin_Employers.Id=@EmployerID and dbo.swiftfin_LoanProducts.Id=@LoanProductID

END







GO
/****** Object:  StoredProcedure [dbo].[sp_FindEFTOrder]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Name
-- Create date: 
-- Description:	
-- =============================================
CREATE PROCEDURE [dbo].[sp_FindEFTOrder] 
	-- Add the parameters for the stored procedure here
	@pCustomerAccountId varchar(100) = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT TOP 1 * FROM swiftfin_EFTOrders WHERE [CustomerAccountId] =@pCustomerAccountId;
END







GO
/****** Object:  StoredProcedure [dbo].[sp_FindStandingOrder]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Name
-- Create date: 
-- Description:	
-- =============================================
CREATE PROCEDURE [dbo].[sp_FindStandingOrder] 
	-- Add the parameters for the stored procedure here
	@pBenefactorCustomerAccountId varchar(100) = 0, 
	@pBeneficiaryCustomerAccountId varchar(100) = 0,
	@pTrigger int = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT TOP 1 * FROM swiftfin_StandingOrders WHERE [BenefactorCustomerAccountId] =@pBenefactorCustomerAccountId AND [BeneficiaryCustomerAccountId] = @pBeneficiaryCustomerAccountId AND [Trigger] = @pTrigger;
END








GO
/****** Object:  StoredProcedure [dbo].[sp_Fiscal]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 15/10/2014
-- Description:	sp_Fiscal
-- =============================================
--select * from swiftfin_FiscalCounts
---select * from swiftfin_Branches where id='6A828776-11EE-C4A6-5B31-08D19D7D89D2'
---sp_Fiscal '10/04/2014','10/04/2014','8B8B1B74-141C-CF68-05C2-08D19D7D7330'
CREATE PROCEDURE [dbo].[sp_Fiscal] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime,
	@BranchID uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

WITH TreasuryAsAtCTE (PrimaryDescription, SecondaryDescription, Reference, Denomination_OneThousandValue, 
                      Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
                      Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue, CreatedBy, CreatedDate,Mode)
						as
						 (
							SELECT  PrimaryDescription, SecondaryDescription, Reference, Denomination_OneThousandValue, 
									Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
									Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue, CreatedBy, CreatedDate,
									case PrimaryDescription
									WHEN 'Bank to Treasury' THEN -1 
									WHEN 'Treasury to Bank' THEN 1 
									WHEN 'Treasury to Teller' THEN 1									
									WHEN 'Treasury to Treasury (Source)' THEN 1
									WHEN 'Treasury to Treasury (Destination)' THEN -1
									WHEN 'Teller Cash Transfer' THEN -1
									WHEN 'Teller To Treasury' THEN -1
									WHEN 'Teller End-Of-Day' THEN -1 
									WHEN 'Balance B/F' THEN -1
									End Mode
							FROM            swiftfin_FiscalCounts
							WHERE        (BranchId = @BranchID)  and CreatedDate <@StartDate 
						),
		TreasuryAddMode ( PrimaryDescription, SecondaryDescription, Reference,Denomination_OneThousandValue, 
                         Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
                         Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue,CreatedDate)
						as
						(

							select  PrimaryDescription, SecondaryDescription, Reference, Denomination_OneThousandValue*Mode , 
									Denomination_FiveHundredValue*Mode, Denomination_TwoHundredValue*Mode, Denomination_OneHundredValue*Mode, Denomination_FiftyValue*Mode, Denomination_FourtyValue*Mode, 
									Denomination_TwentyValue*Mode, Denomination_TenValue*Mode, Denomination_FiveValue*Mode, Denomination_OneValue*Mode, Denomination_FiftyCentValue*Mode,CreatedDate from TreasuryAsAtCTE
						),


/*Fetch Transactions Between StartDate and EndDate*/
 TreasuryTrxMode (PrimaryDescription, SecondaryDescription, Reference, Denomination_OneThousandValue, 
                      Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
                      Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue, CreatedBy, CreatedDate,Mode)
						as
						 (
							SELECT  PrimaryDescription, SecondaryDescription, Reference, Denomination_OneThousandValue, 
									Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
									Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue, CreatedBy, CreatedDate,
									case PrimaryDescription
									WHEN 'Bank to Treasury' THEN -1 
									WHEN 'Treasury to Bank' THEN 1 
									WHEN 'Treasury to Teller' THEN 1
									WHEN 'Treasury to Treasury (Source)' THEN 1
									WHEN 'Treasury to Treasury (Destination)' THEN -1
									WHEN 'Teller End-Of-Day' THEN -1
									WHEN 'Teller Cash Transfer' THEN -1
									WHEN 'Teller To Treasury' THEN -1
									WHEN 'Balance B/F' THEN -1
									END AS MODE
							FROM            swiftfin_FiscalCounts
							WHERE        (BranchId = @BranchID) and CreatedDate Between @StartDate and @EndDate
						),
						
	   TreasuryCTE2 (PrimaryDescription, SecondaryDescription, Reference,Denomination_OneThousandValue, 
                         Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
                         Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue,CreatedDate)
		as		
		(
			select  'Balance BF','<Treasury>','Balance BF',sum(isnull(Denomination_OneThousandValue,0)) , 
					sum(isnull(Denomination_FiveHundredValue,0)), 
					sum(isnull(Denomination_TwoHundredValue,0)), 
					sum(isnull(Denomination_OneHundredValue,0)), 
					sum(isnull(Denomination_FiftyValue,0)), 
					sum(isnull(Denomination_FourtyValue,0)), 
					sum(isnull(Denomination_TwentyValue,0)), 
					sum(isnull(Denomination_TenValue,0)), 
					sum(isnull(Denomination_FiveValue,0)), 
					sum(isnull(Denomination_OneValue,0)), 
					sum(isnull(Denomination_FiftyCentValue,0)),@StartDate from TreasuryAddMode
					union
			select  PrimaryDescription, SecondaryDescription, Reference, 
					Denomination_OneThousandValue*Mode , 
					Denomination_FiveHundredValue*Mode, 
					Denomination_TwoHundredValue*Mode, 
					Denomination_OneHundredValue*Mode, 
					Denomination_FiftyValue*Mode, 
					Denomination_FourtyValue*Mode, 
					Denomination_TwentyValue*Mode, 
					Denomination_TenValue*Mode, 
					Denomination_FiveValue*Mode, 
					Denomination_OneValue*Mode, 
					Denomination_FiftyCentValue*Mode,CreatedDate from TreasuryTrxMode

		),

		TransactionsList 
				(PrimaryDescription, SecondaryDescription, Reference,Denomination_OneThousandValue, 
                 Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
                 Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue,CreatedDate)
				 as
				 (

		select   PrimaryDescription, SecondaryDescription, Reference,Denomination_OneThousandValue, 
                 Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
                 Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue,CreatedDate from TreasuryCTE2
/*
				 union
			select  'Balance C/F','Balance C/F','Balance C/F',
					sum(Denomination_OneThousandValue) , 
					sum(Denomination_FiveHundredValue), 
					sum(Denomination_TwoHundredValue), 
					sum(Denomination_OneHundredValue), 
					sum(Denomination_FiftyValue), 
					sum(Denomination_FourtyValue), 
					sum(Denomination_TwentyValue), 
					sum(Denomination_TenValue), 
					sum(Denomination_FiveValue), 
					sum(Denomination_OneValue), 
					sum(Denomination_FiftyCentValue),@EndDate from TreasuryCTE2
					*/
				 )
		select   PrimaryDescription, SecondaryDescription, Reference,Denomination_OneThousandValue, 
                 Denomination_FiveHundredValue, Denomination_TwoHundredValue, Denomination_OneHundredValue, Denomination_FiftyValue, Denomination_FourtyValue, 
                 Denomination_TwentyValue, Denomination_TenValue, Denomination_FiveValue, Denomination_OneValue, Denomination_FiftyCentValue,
					Denomination_OneThousandValue + 
					Denomination_FiveHundredValue+ 
					Denomination_TwoHundredValue+
					Denomination_OneHundredValue+ 
					Denomination_FiftyValue+
					Denomination_FourtyValue+ 
					Denomination_TwentyValue+ 
					Denomination_TenValue+
					Denomination_FiveValue+ 
					Denomination_OneValue+
					Denomination_FiftyCentValue as TotalTrx,
					SUM(Denomination_OneThousandValue + 
					Denomination_FiveHundredValue+ 
					Denomination_TwoHundredValue+
					Denomination_OneHundredValue+ 
					Denomination_FiftyValue+
					Denomination_FourtyValue+ 
					Denomination_TwentyValue+ 
					Denomination_TenValue+
					Denomination_FiveValue+ 
					Denomination_OneValue+
					Denomination_FiftyCentValue) OVER(ORDER BY CreatedDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal,convert(varchar(10),CreatedDate,103) as GroupDate,
									case PrimaryDescription
									WHEN 'Bank to Treasury' THEN -1 
									WHEN 'Treasury to Bank' THEN 1 
									WHEN 'Treasury to Teller' THEN 1
									WHEN 'Treasury to Treasury (Source)' THEN 1
									WHEN 'Treasury to Treasury (Destination)' THEN -1
									WHEN 'Teller Cash Transfer' THEN -1
									WHEN 'Teller To Treasury' THEN -1
									WHEN 'Teller End-Of-Day' THEN -1 End Mode,
				 CreatedDate from TransactionsList where Denomination_OneValue is not null  order by CreatedDate

END






GO
/****** Object:  StoredProcedure [dbo].[sp_FiscalCountTallyByCount]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_FiscalCountTallyByCount]
@StartDate DateTime,
@EndDate Datetime

AS

 SET NOCOUNT ON;
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        swiftfin_ChartOfAccounts.AccountCode, swiftfin_ChartOfAccounts.AccountName, swiftfin_FiscalCounts.PrimaryDescription, swiftfin_FiscalCounts.SecondaryDescription, swiftfin_FiscalCounts.Denomination_OneThousandValue/1000 AS [1000], 
                         swiftfin_FiscalCounts.Denomination_FiveHundredValue / 500 AS [500], swiftfin_FiscalCounts.Denomination_TwoHundredValue / 200 AS [200], swiftfin_FiscalCounts.Denomination_OneHundredValue / 100 AS [100], 
                         swiftfin_FiscalCounts.Denomination_FiftyValue / 50 AS [50], swiftfin_FiscalCounts.Denomination_FourtyValue / 40 AS [40], swiftfin_FiscalCounts.Denomination_TwentyValue / 20 AS [20], 
                         swiftfin_FiscalCounts.Denomination_TenValue / 10 AS [10], swiftfin_FiscalCounts.Denomination_FiveValue / 5 AS [5], swiftfin_FiscalCounts.Denomination_OneValue as [1], swiftfin_FiscalCounts.Denomination_FiftyCentValue / 0.5 AS [0.5], 
                         swiftfin_FiscalCounts.CreatedBy, swiftfin_FiscalCounts.CreatedDate,swiftfin_FiscalCounts.BranchId,
						 swiftfin_FiscalCounts.Denomination_OneThousandValue+ swiftfin_FiscalCounts.Denomination_FiveHundredValue+swiftfin_FiscalCounts.Denomination_TwoHundredValue+ swiftfin_FiscalCounts.Denomination_OneHundredValue+
						 swiftfin_FiscalCounts.Denomination_FiftyValue+swiftfin_FiscalCounts.Denomination_FourtyValue+ swiftfin_FiscalCounts.Denomination_TwentyValue+swiftfin_FiscalCounts.Denomination_TenValue+
						 swiftfin_FiscalCounts.Denomination_FiveValue+swiftfin_FiscalCounts.Denomination_OneValue + swiftfin_FiscalCounts.Denomination_FiftyCentValue as Total
FROM            swiftfin_FiscalCounts INNER JOIN
                         swiftfin_ChartOfAccounts ON swiftfin_FiscalCounts.ChartOfAccountId = swiftfin_ChartOfAccounts.Id
						 where swiftfin_FiscalCounts.CreatedDate BETWEEN @StartDate and @EndDate

						-- select * from swiftfin_FiscalCounts
						
GO
/****** Object:  StoredProcedure [dbo].[sp_Fixeddepositasat]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


---sp_UnpaidFixedDeposits '11/15/2014'
create procedure [dbo].[sp_Fixeddepositasat]
(@EndDate DateTime)
as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_FixedDeposits.Value, dbo.swiftfin_FixedDeposits.Term, dbo.swiftfin_FixedDeposits.Rate, dbo.swiftfin_FixedDeposits.Remarks, dbo.swiftfin_FixedDeposits.Status, 
                         dbo.swiftfin_FixedDeposits.MaturityDate, dbo.swiftfin_FixedDeposits.ExpectedInterest, dbo.swiftfin_FixedDeposits.TotalExpected, dbo.swiftfin_FixedDeposits.PaidBy, 
                         dbo.swiftfin_FixedDeposits.PaidDate, dbo.swiftfin_FixedDeposits.CreatedBy, dbo.swiftfin_FixedDeposits.CreatedDate, 
                         dbo.swiftfin_FixedDeposits.Id, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName
 FROM            dbo.swiftfin_FixedDeposits INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_FixedDeposits.CustomerAccountId = dbo.vw_CustomerAccounts.Id
 wHERE         isnull(PaidDate,@EndDate)>=@EndDate and CreatedDate<@EndDate







GO
/****** Object:  StoredProcedure [dbo].[sp_FixedDepositCertificate]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:  <Name, Joan>
-- Create date: <Create Date, 05/06/2015 >
-- Description: <Description, FixedDepositCertificate Report>
-- =============================================
--exec sp_FixedDepositCertificate '0101-001-01436', '2015/05/18'
--exec sp_FixedDepositCertificate '62F8A02F-AB5E-C682-3B5E-08D403075570'
---select * from swiftfin_FixedDeposits
CREATE PROCEDURE [dbo].[sp_FixedDepositCertificate]
 -- Add the parameters for the stored procedure here
 --@AccountNumber varchar(100),
 @ID Varchar (50)
 
AS
BEGIN
 --set @createDate= (select DATEADD(day, DATEDIFF(day, 0, @createDate), '23:59:59'));
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 --select * from swiftfin_FixedDeposits
 SET NOCOUNT ON;

    -- Insert statements for procedure here
 SELECT        dbo.swiftfin_FixedDeposits.CreatedDate, dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName as Fullname, dbo.swiftfin_Customers.Individual_IdentityCardNumber, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers, dbo.swiftfin_Customers.Address_AddressLine1, dbo.swiftfin_Customers.Address_MobileLine, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_FixedDeposits.Value, 
                         dbo.swiftfin_FixedDeposits.Term, dbo.swiftfin_FixedDeposits.Rate, dbo.swiftfin_FixedDeposits.MaturityDate, dbo.swiftfin_FixedDeposits.ExpectedInterest, dbo.swiftfin_FixedDeposits.TotalExpected, 
						 dbo.swiftfin_FixedDeposits.ExpectedInterest*0.05 as WTax,dbo.swiftfin_FixedDeposits.TotalExpected - (dbo.swiftfin_FixedDeposits.ExpectedInterest*0.05) as NetPay,
                         dbo.swiftfin_FixedDeposits.CreatedBy, dbo.swiftfin_FixedDeposits.PaidBy, dbo.swiftfin_FixedDeposits.PaidDate, dbo.swiftfin_FixedDeposits.Remarks, dbo.swiftfin_FixedDeposits.Status, dbo.swiftfin_Customers.Address_LandLine,
       [dbo].[Currency_ToWords](dbo.swiftfin_FixedDeposits.Value) as AmountInWords
                       
 FROM            dbo.swiftfin_FixedDeposits INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_FixedDeposits.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id 
                         
 --where dbo.swiftfin_Customers.Reference1=@AccountNumber and  dbo.swiftfin_FixedDeposits.CreatedDate=@CreateDate
 --where dbo.swiftfin_Customers.Reference1=@AccountNumber and CONVERT(datetime(10), dbo.swiftfin_FixedDeposits.CreatedDate, 103) = @CreateDate
 --where dbo.swiftfin_Customers.Reference1=@AccountNumber and Convert(varchar, dbo.swiftfin_FixedDeposits.CreatedDate,111)= @CreateDate
 where  dbo.swiftfin_FixedDeposits.Id=@ID 
 END

GO
/****** Object:  StoredProcedure [dbo].[sp_FixedDeposits]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




---sp_UnpaidFixedDeposits '11/15/2014'
CREATE procedure [dbo].[sp_FixedDeposits] 
@StartDate Datetime,
@EndDate DateTime,
@status int,
@DisplayField varchar(50)
as
--set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_FixedDeposits.Value, dbo.swiftfin_FixedDeposits.Term, dbo.swiftfin_FixedDeposits.Rate, dbo.swiftfin_FixedDeposits.Remarks, dbo.swiftfin_FixedDeposits.Status, 
                         dbo.swiftfin_FixedDeposits.MaturityDate, dbo.swiftfin_FixedDeposits.ExpectedInterest, dbo.swiftfin_FixedDeposits.TotalExpected, dbo.swiftfin_FixedDeposits.PaidBy, 
                         dbo.swiftfin_FixedDeposits.PaidDate, dbo.swiftfin_FixedDeposits.CreatedBy, dbo.swiftfin_FixedDeposits.CreatedDate, 
                         dbo.swiftfin_FixedDeposits.Id, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName
 FROM            dbo.swiftfin_FixedDeposits INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_FixedDeposits.CustomerAccountId = dbo.vw_CustomerAccounts.Id
 wHERE  dbo.swiftfin_FixedDeposits.status=@status and

 CASE 
	WHEN @DisplayField='ReceivedDate' then dbo.swiftfin_FixedDeposits.CreatedDate
	WHEN @DisplayField='MaturityDate' then dbo.swiftfin_FixedDeposits.MaturityDate
	

end
between @StartDate and @EndDate









GO
/****** Object:  StoredProcedure [dbo].[sp_GetCustomerIds]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,paul,>
-- Create date: <Create,4/9/2014,>
-- Description:	<Description,get customer ids,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_GetCustomerIds]
	AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT [Id] FROM [dbo].[swiftfin_Customers] where IsLocked=0
END







GO
/****** Object:  StoredProcedure [dbo].[sp_GetDormantAccounts]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 22.01.2015
-- Description:	GetDormant
-- =============================================
-- sp_GetDormantAccounts 1, '09/02/2018'
CREATE PROCEDURE [dbo].[sp_GetDormantAccounts] 
	-- Add the parameters for the stored procedure here
	@Month int , 
	@Date Datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		set @Date=	(select DATEADD(day, DATEDIFF(day, 0, @Date), '23:59:59'));

		WITH DormantCTE (FosaAccount,FullName,LastTrxDATE,ProductID)
		AS
		(
		
		select fosa_acno,name,(SELECT MAX(trdate) from fosa.dbo.history where fosa_acno=customer.fosa_acno)as LastTrxDate,'4623CC2E-E0BB-E811-A815-000C29142092'
		from fosa.dbo.customer
		UNION 
		select REFERENCE1,FullName, (SELECT MAX(CREATEDDATE) FROM swiftfin_JournalEntries WHERE CustomerAccountId =vw_CustomerAccounts.ID) AS LastTrxDate,CustomerAccountType_TargetProductId 
			FROM vw_CustomerAccounts where CustomerAccountType_TargetProductId in (select id from swiftfin_SavingsProducts)
		)
		SELECT DATEDIFF(MM,LastTrxDATE,@Date) AS Month,* 
	
		FROM DormantCTE WHERE DATEDIFF(DD,LastTrxDATE,@Date)>=@Month*30

		

END






GO
/****** Object:  StoredProcedure [dbo].[sp_GetDormantAccountsWithBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:  Centrino
-- ALTER date: 15.09.2016
-- Description: Get Dormant Accounts & Their Balances
-- =============================================
-- sp_GetDormantAccountsWithBalances 1, '06/30/2018'
-- sp_GetDormantAccountsWithBalances
CREATE PROCEDURE [dbo].[sp_GetDormantAccountsWithBalances] 
 -- Add the parameters for the stored procedure here
 @Month int , 
 @Date Datetime
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

    -- Insert statements for procedure here
  set @Date= (select DATEADD(day, DATEDIFF(day, 0, @Date), '23:59:59'));

WITH DormantCTE (Reference1,FullName, Amount, LastTrxDATE,IdentityCardNumber,Address_MobileLine, Individual_PayrollNumbers, SerialNumber,ProductID) AS
(

SELECT        dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName, SUM(swiftfin_JournalEntries_1.Amount) - dbo.swiftfin_SavingsProducts.MinimumBalance AS AvailableBalance,
                             (SELECT        MAX(CREATEDDATE) AS Expr1
                               FROM            dbo.swiftfin_JournalEntries
                               WHERE        (CustomerAccountId = dbo.vw_CustomerAccounts.Id)) AS LastTrxDate, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Address_MobileLine, 
                         dbo.vw_CustomerAccounts.Individual_PayrollNumbers, dbo.vw_CustomerAccounts.SerialNumber,dbo.swiftfin_SavingsProducts.id
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_JournalEntries AS swiftfin_JournalEntries_1 ON dbo.swiftfin_ChartOfAccounts.Id = swiftfin_JournalEntries_1.ChartOfAccountId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_SavingsProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId AND 
                         swiftfin_JournalEntries_1.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
WHERE        (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId IN
                             (SELECT        Id
                               FROM            dbo.swiftfin_SavingsProducts AS swiftfin_SavingsProducts_1))
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Id, dbo.swiftfin_SavingsProducts.MinimumBalance, dbo.swiftfin_Customers.Individual_IdentityCardNumber, 
                         dbo.swiftfin_Customers.Address_MobileLine, dbo.vw_CustomerAccounts.Individual_PayrollNumbers, dbo.vw_CustomerAccounts.SerialNumber,dbo.swiftfin_SavingsProducts.id

)
SELECT DATEDIFF(MM,LastTrxDATE,@Date) AS Month,* 
  FROM DormantCTE WHERE DATEDIFF(DD,LastTrxDATE,@Date)>=@Month*30
  

END


GO
/****** Object:  StoredProcedure [dbo].[Sp_GetEmi]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--Sp_GetEmi 1000,10,4,'01/01/2016'
Create PROC [dbo].[Sp_GetEmi]   
@LoanAmount decimal(18,2),   
@InterestRate decimal(18,2),   
@LoanPeriod Int,   
@StartPaymentDate DATETIME  
AS  
BEGIN  
SET NOCOUNT ON  
  
DECLARE   
  
@Payment decimal(12,2),   
@Period FLOAT,   
@Payment2 decimal(12,2),  
@TotalPayment decimal(12,2),  
@FinanceCharges FLOAT,  
@CompoundingPeriod FLOAT,  
@CompoundingInterest FLOAT,  
@CurrentBalance decimal(12,2),  
@Principal FLOAT,  
@Interest FLOAT,  
@LoanPaymentEndDate DATETIME,  
@LoanPayDate DATETIME,  
@LoanDueDate DATETIME   
  
  
  
SET @InterestRate = @InterestRate/100   
  
SET @CompoundingPeriod = 12   
  
  
/*** END USER VARIABLES ***/   
  
SET @CompoundingInterest = @InterestRate/@CompoundingPeriod   
  
SET @Payment = ROUND((((@InterestRate/12) * @LoanAmount)/(1- ( POWER( (1 + (@InterestRate/12)),(-1 * @LoanPeriod) )))),2)   
  
SET @TotalPayment = @Payment * @LoanPeriod   
  
SET @FinanceCharges = @TotalPayment - @LoanAmount   
  
IF EXISTS(SELECT object_id FROM tempdb.sys.objects WHERE name LIKE '#EMI%')   
  
BEGIN   
  
DROP TABLE #EMI   
  
END   
  
/*** IT'S A TEMPORERY TABLE ***/   
  
CREATE TABLE #EMI(   
  
 PERIOD INT   
  
,PAYDATE SMALLDATETIME   
  
,PAYMENT decimal(12,2)   
  
,CURRENT_BALANCE decimal(12,2)   
  
,INTEREST decimal(12,2)   
  
,PRINCIPAL decimal(12,2)   
  
)   
  
SET @Period = 1   
  
SET @LoanPaymentEndDate = DATEADD(month,@LoanPeriod,@StartPaymentDate)   
  
SET @LoanPayDate = @StartPaymentDate  
  
BEGIN   
  
WHILE (@Period < = @LoanPeriod)   
  
BEGIN   
  
SET @CurrentBalance = ROUND (@LoanAmount * POWER( (1+ @CompoundingInterest) , @Period ) - ( (ROUND(@Payment,2)/@CompoundingInterest) * (POWER((1 + @CompoundingInterest),@Period ) - 1)),0)   
  
SET @Principal =   
CASE   
WHEN @Period = 1   
THEN   
ROUND((ROUND(@LoanAmount,0) - ROUND(@CurrentBalance,0)),0)   
ELSE   
ROUND ((SELECT ABS(ROUND(CURRENT_BALANCE,0) - ROUND(@CurrentBalance,0))   
FROM #EMI   
WHERE PERIOD = @Period -1),2)   
END   
  
SET @Interest = ROUND(ABS(ROUND(@Payment,2) - ROUND(@Principal,2)),2)   
  
SET @LoanDueDate = @LoanPayDate   
  
INSERT   
#EMI  
  
SELECT   
  
@Period,   
@LoanDueDate,   
@Payment,   
@CurrentBalance,   
@Interest,   
@Principal   
  
SET @Period = @Period + 1   
  
SET @LoanPayDate = DATEADD(MM,1,@LoanPayDate)   
  
END   
  
END   
  
SELECT * FROM #EMI  
END  





GO
/****** Object:  StoredProcedure [dbo].[sp_GetGlAccountBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 10.06.2014
-- Description:	GetGLAccountBalance
-- =============================================
--sp_GetGlAccountBalance '2783FA6C-CEAC-CEC5-8DE6-08D10CA97930','0777363D-0845-C660-9E58-08D1336CB025','06/10/2014'
CREATE PROCEDURE [dbo].[sp_GetGlAccountBalance] 
	-- Add the parameters for the stored procedure here
	@ChartOfAccountID uniqueidentifier, 
	@EndDate DateTime,
	@TransactionDateFilter int = 1
AS
BEGIN
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT        isnull(SUM(dbo.swiftfin_JournalEntries.Amount),0) AS Balance
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
	WHERE			(dbo.swiftfin_JournalEntries.ChartOfAccountId = @ChartOfAccountID) 				
					AND 
					Case
					WHEN @TransactionDateFilter =1 then dbo.swiftfin_Journals.ValueDate 
					WHEN @TransactionDateFilter =2 then dbo.swiftfin_Journals.CreatedDate 
					END <= @EndDate 
END






GO
/****** Object:  StoredProcedure [dbo].[sp_GetGlAccountBalanceByBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_GetGlAccountBalanceByBranch] 
	-- Add the parameters for the stored procedure here
	@BranchID varchar(100),
	@ChartOfAccountID varchar(100)  , 
	@EndDate DateTime,
	@TransactionDateFilter int = 1
AS
BEGIN
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT        isnull(SUM(dbo.swiftfin_JournalEntries.Amount),0) AS Balance
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
	WHERE			(dbo.swiftfin_JournalEntries.ChartOfAccountId = @ChartOfAccountID) 	and dbo.swiftfin_Journals.BranchId=@BranchID			
					AND 
					Case
					WHEN @TransactionDateFilter =1 then dbo.swiftfin_Journals.ValueDate 
					WHEN @TransactionDateFilter =2 then dbo.swiftfin_Journals.CreatedDate 
					END <= @EndDate 
END





GO
/****** Object:  StoredProcedure [dbo].[sp_GetGlTotalDebitsCredits]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 10.06.2014
-- Description:	GetGLAccountBalance
-- =============================================

create PROCEDURE [dbo].[sp_GetGlTotalDebitsCredits] 
	-- Add the parameters for the stored procedure here
	@ChartOfAccountID uniqueidentifier, 
	@StartDate DateTime,
	@EndDate DateTime,
	@TransactionDateFilter int = 1
AS
Declare	@Cmd nvarchar(max),@DateChar Varchar(30),@DateChar2 Varchar(30);
 set @DateChar=	 CONVERT(VARCHAR(24),@EndDate,101) +' '+ '23:59:59';
 set @DateChar2=	 CONVERT(VARCHAR(24),@StartDate,101) ;

	SET NOCOUNT ON;

	 set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	if @TransactionDateFilter=2
	begin
		set @Cmd='SELECT isnull(SUM(case when Amount>0 then amount else 0 end),0) Credit,isnull(SUM(case when Amount<0 then amount*-1 else 0 end),0) Debit,count(*) Count FROM  dbo.swiftfin_JournalEntries  
		WHERE dbo.swiftfin_JournalEntries.ChartOfAccountId =''' +cast(@ChartOfAccountID as Nvarchar(100))+''' and Createddate between '''
		+@DateChar2+''' and '''+@DateChar+''''
	end
	else
	begin
		set @Cmd='SELECT isnull(SUM(case when Amount>0 then amount else 0 end),0) Credit,isnull(SUM(case when Amount<0 then amount*-1 else 0 end),0) Debit,count(*) Count FROM  dbo.swiftfin_JournalEntries  
		WHERE dbo.swiftfin_JournalEntries.ChartOfAccountId =''' +cast(@ChartOfAccountID as Nvarchar(100))+''' and valuedate between '''
		+@DateChar2+''' and '''+@DateChar+''''
	end
exec (@cmd)

GO
/****** Object:  StoredProcedure [dbo].[sp_GetLastCreditBatchEntry]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 15.10.2014
-- Description:	Get last values for a credit batch
-- =============================================
CREATE PROCEDURE [dbo].[sp_GetLastCreditBatchEntry] 
	-- Add the parameters for the stored procedure here
	@CustomerAccountID varchar(50), 
	@Type int 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        TOP (1) dbo.swiftfin_CreditBatchEntries.Balance,dbo.swiftfin_CreditBatchEntries.Principal, dbo.swiftfin_CreditBatchEntries.Interest, dbo.swiftfin_CreditBatchEntries.CustomerAccountId, 
                         dbo.swiftfin_CreditBatches.Type
	FROM            dbo.swiftfin_CreditBatches INNER JOIN
                         dbo.swiftfin_CreditBatchEntries ON dbo.swiftfin_CreditBatches.Id = dbo.swiftfin_CreditBatchEntries.CreditBatchId
	WHERE dbo.swiftfin_CreditBatchEntries.CustomerAccountId=@CustomerAccountId and swiftfin_CreditBatches.Type=@Type and swiftfin_CreditBatches.Status=2
	ORDER BY dbo.swiftfin_CreditBatches.CreatedDate DESC
END






GO
/****** Object:  StoredProcedure [dbo].[sp_GetMonthlyAbility]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 15.10.2014
-- Description:	Get letest monthly ability from loancases given loanproduct
-- =============================================
CREATE PROCEDURE [dbo].[sp_GetMonthlyAbility] 
	-- Add the parameters for the stored procedure here
	@CustomerID varchar(50),
	@LoanProductID varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT      top 1  AppraisedAbility,MonthlyPaybackAmount
	FROM            dbo.swiftfin_LoanCases
	WHERE        (CustomerID=@CustomerID and LoanProductId = @LoanProductID and AuditedDate is not null) order by AuditedDate desc

END






GO
/****** Object:  StoredProcedure [dbo].[sp_GetStandingOrdersByCreditTypeProductTrigger]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_GetStandingOrdersByCreditTypeProductTrigger] 
	-- Add the parameters for the stored procedure here
	@CreditTypeID UniqueIdentifier , 
	@ProductID UniqueIdentifier , 
	@Trigger int = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT dbo.swiftfin_StandingOrders.*
FROM     dbo.swiftfin_CustomerCreditTypes INNER JOIN
                  dbo.swiftfin_Customers ON dbo.swiftfin_CustomerCreditTypes.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                  dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                  dbo.swiftfin_StandingOrders ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId
WHERE  (dbo.swiftfin_CustomerCreditTypes.CreditTypeId = @CreditTypeID) AND (dbo.swiftfin_StandingOrders.[Trigger] = @Trigger) AND 
                  (dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = @ProductID)

END
GO
/****** Object:  StoredProcedure [dbo].[sp_GetStandingOrdersByCustomerProductTrigger]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 04.07.2014
-- Description:	GetStandingOrdersByEmployerAndTrigger
-- =============================================
---select * from swiftfin_Employers
--sp_GetStandingOrdersByEmployerAndTrigger '87aa5e3a-98b9-44aa-a07a-cc6bc2b6fe18',0
CREATE PROCEDURE [dbo].[sp_GetStandingOrdersByCustomerProductTrigger] 
	-- Add the parameters for the stored procedure here
	@CustomerID UniqueIdentifier , 
	@ProductID UniqueIdentifier , 
	@Trigger int = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SELECT       dbo.swiftfin_StandingOrders.*
	FROM            dbo.swiftfin_StandingOrders INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id 
	WHERE  swiftfin_Customers.ID=@CustomerID and swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId=@ProductID and dbo.swiftfin_StandingOrders.[Trigger]=@Trigger

END







GO
/****** Object:  StoredProcedure [dbo].[sp_GetStandingOrdersByEmployerAndTrigger]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 04.07.2014
-- Description:	GetStandingOrdersByEmployerAndTrigger
-- =============================================
---select * from swiftfin_Employers
--sp_GetStandingOrdersByEmployerAndTrigger '87aa5e3a-98b9-44aa-a07a-cc6bc2b6fe18',0
CREATE PROCEDURE [dbo].[sp_GetStandingOrdersByEmployerAndTrigger] 
	-- Add the parameters for the stored procedure here
	@EmployerID varchar(100) , 
	@Trigger int = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SELECT       dbo.swiftfin_StandingOrders.*
	FROM            dbo.swiftfin_StandingOrders INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Employers INNER JOIN
                         dbo.swiftfin_Divisions INNER JOIN
                         dbo.swiftfin_Zones INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Stations.ZoneId ON dbo.swiftfin_Divisions.Id = dbo.swiftfin_Zones.DivisionId ON 
                         dbo.swiftfin_Employers.Id = dbo.swiftfin_Divisions.EmployerId ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id
	WHERE  dbo.swiftfin_Employers.Id=@EmployerID and dbo.swiftfin_StandingOrders.[Trigger]=@Trigger

END








GO
/****** Object:  StoredProcedure [dbo].[sp_GetStandingOrdersByEmployerProductTrigger]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 04.07.2014
-- Description:	GetStandingOrdersByEmployerAndTrigger
-- =============================================
---select * from swiftfin_Employers
--sp_GetStandingOrdersByEmployerAndTrigger '87aa5e3a-98b9-44aa-a07a-cc6bc2b6fe18',0
create procEDURE [dbo].[sp_GetStandingOrdersByEmployerProductTrigger] 
	-- Add the parameters for the stored procedure here
	@EmployerID UniqueIdentifier , 
	@ProductID UniqueIdentifier , 
	@Trigger int = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SELECT       dbo.swiftfin_StandingOrders.*
	FROM            dbo.swiftfin_StandingOrders INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Employers INNER JOIN
                         dbo.swiftfin_Divisions INNER JOIN
                         dbo.swiftfin_Zones INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Stations.ZoneId ON dbo.swiftfin_Divisions.Id = dbo.swiftfin_Zones.DivisionId ON 
                         dbo.swiftfin_Employers.Id = dbo.swiftfin_Divisions.EmployerId ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id
	WHERE  dbo.swiftfin_Employers.Id=@EmployerID and swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId=@ProductID and dbo.swiftfin_StandingOrders.[Trigger]=@Trigger

END







GO
/****** Object:  StoredProcedure [dbo].[sp_GLAccountDeterminationListings]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_GLAccountDeterminationListings] 
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

  SELECT        TOP (100) 
                         PERCENT CASE dbo.swiftfin_SystemGeneralLedgerAccountMappings.SystemGeneralLedgerAccountCode 
						 WHEN '48826' THEN 'COMMON CONTROL' 
						 WHEN '48827' THEN 'EXTERNAL CHEQUES CONTROL'
                          WHEN '48828' THEN 'PAYROLL CONTROL' 
						  WHEN '48829' THEN 'IN-HOUSE CHEQUES CONTROL' 
						  WHEN '48830' THEN 'ELECTRONIC FUNDS TRANSFER CONTROL' 
						  WHEN '48831' THEN 'PROFIT & LOSS APPROPRIATION' 
						  WHEN  '48832' THEN 'FIXED DEPOSIT' 
						  WHEN '48833' THEN 'FIXED DEPOSIT INTEREST' 
						  WHEN '48834' THEN 'COST CENTER INTER-SETTLEMENT'
						  WHEN '48835' THEN 'SACCO-LINK SETTLEMENT'
						  WHEN '48836' THEN 'DECEASED CONTROL'
						  WHEN '48837' THEN 'JOURNAL VOUCHER CONTROL' 
						  WHEN '48838' THEN 'MOBILE WALLET SETTLEMENT' 
						  ELSE 'UnKnown'
                          END AS SystemGeneralLedgerAccountCode, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         dbo.swiftfin_SystemGeneralLedgerAccountMappings.CreatedDate
FROM            dbo.swiftfin_SystemGeneralLedgerAccountMappings INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_SystemGeneralLedgerAccountMappings.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
ORDER BY SystemGeneralLedgerAccountCode
END










GO
/****** Object:  StoredProcedure [dbo].[sp_GlAccountStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_JournalEntries
---select * from swiftfin_PostingPeriods
--sp_GlAccountStatement 'F49C80A6-80DF-CC26-2974-08D3E2CCA71D','01/01/2017','01/01/2018','4CAF2D78-1DCE-CE0A-CC51-08D431798ECE'

---select * from swiftfin_ChartOfAccounts where AccountName like '%cheq%'

---select * from swiftfin_ChartOfAccounts where AccountName like '%cheq%'
CREATE PROCEDURE [dbo].[sp_GlAccountStatement] 
	-- Add the parameters for the stored procedure here
	@ChartOfAccountID Varchar(MAX),
	@StartDate Datetime,
	@EndDate Datetime,
	@PostingPeriod Varchar(MAX)
AS
DECLARE
	@OpeningBalance Numeric (18,2)
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here

WITH CTE AS
(
SELECT (select AccountCode from swiftfin_ChartOfAccounts where id=@ChartOfAccountID) as AccountCode,
(select AccountName from swiftfin_ChartOfAccounts where id=@ChartOfAccountID) as AccountName,'Balance B/F at ' +convert(varchar(10),@startdate,103) as PrimaryDescription,'<Opening Balance>' as SecondaryDescription,'<Opening Balance>' as Reference,
(select Balance from f_GLAccountBalance(@ChartOfAccountID,@StartDate)) as Amount,@StartDate as ValueDate,'' as FullAccountNumber,'' as FullName,'' as ContrAccountCode,'' as ContraAccountName
    UNION ALL
SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.swiftfin_JournalEntries.Amount, dbo.swiftfin_Journals.CreatedDate, 
                         REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccountNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         swiftfin_ChartOfAccounts_1.AccountCode AS ContraAccountCode, swiftfin_ChartOfAccounts_1.AccountName AS ContraAccountName
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId ON 
                         dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = swiftfin_ChartOfAccounts_1.Id LEFT OUTER JOIN
                         dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Branches.Id = dbo.swiftfin_CustomerAccounts.BranchId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id ON 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
WHERE         (dbo.swiftfin_Journals.PostingPeriodId = @PostingPeriod) AND 
                         (dbo.swiftfin_ChartOfAccounts.Id = @ChartOfAccountID)
						 ) 
						 SELECT AccountCode,AccountName,PrimaryDescription,SecondaryDescription,Reference,ValueDate,FullAccountNumber,FullName,ContrAccountCode,ContraAccountName,
ISNULL(CASE WHEN AMOUNT<0 THEN AMOUNT*-1 END,0) AS DEBIT,
ISNULL(CASE WHEN AMOUNT>0 THEN AMOUNT END,0) AS CREDIT into #temp1 FROM CTE ORDER BY valuedate

 select *,ValueDate as CreatedDate,SUM(credit-debit) OVER(ORDER BY ValueDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal
 from #temp1 where Valuedate BETWEEN @StartDate AND @EndDate
END











GO
/****** Object:  StoredProcedure [dbo].[sp_GlAccountStatementByAccountCode]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_ChartOfAccounts where accountname like '%ordinary%'
--sp_GlAccountStatementByAccountCode '2011101','08/20/2016'
CREATE PROCEDURE [dbo].[sp_GlAccountStatementByAccountCode] 
	-- Add the parameters for the stored procedure here
	@AccountID Varchar(20),
	@EndDate Datetime
AS
DECLARE
	@OpeningBalance Numeric (18,2),
	@ChartOfAccountID uniqueidentifier,
	@StartDate Datetime

	set @EndDate  =	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	set @ChartOfAccountID=(select top 1  id from swiftfin_ChartOfAccounts where AccountCode=@AccountID)

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.

	SET NOCOUNT ON;
    -- Insert statements for procedure here

WITH CTE AS
(
SELECT (select AccountCode from swiftfin_ChartOfAccounts where id=@ChartOfAccountID) as AccountCode,
(select AccountName from swiftfin_ChartOfAccounts where id=@ChartOfAccountID) as AccountName,'Balance B/F at ' +convert(varchar(10),@startdate,103) as PrimaryDescription,'<Opening Balance>' as SecondaryDescription,'<Opening Balance>' as Reference,
(select Balance from f_GLAccountBalance(@ChartOfAccountID,@StartDate)) as Amount,@StartDate as CreatedDate,'' as FullAccountNumber,'' as FullName,'' as ContrAccountCode,'' as ContraAccountName
    UNION ALL
SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.swiftfin_JournalEntries.Amount, dbo.swiftfin_Journals. valueDate as CreatedDate, 
                         REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccountNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         swiftfin_ChartOfAccounts_1.AccountCode AS ContraAccountCode, swiftfin_ChartOfAccounts_1.AccountName AS ContraAccountName
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId ON 
                         dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = swiftfin_ChartOfAccounts_1.Id LEFT OUTER JOIN
                         dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Branches.Id = dbo.swiftfin_CustomerAccounts.BranchId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id ON 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
WHERE        (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate)  AND 
                         (dbo.swiftfin_ChartOfAccounts.Id = @ChartOfAccountID)
						 ) SELECT AccountCode,AccountName,PrimaryDescription,SecondaryDescription,Reference,CreatedDate,FullAccountNumber,FullName,ContrAccountCode,ContraAccountName,
ISNULL(CASE WHEN AMOUNT<0 THEN AMOUNT*-1 END,0) AS DEBIT,
ISNULL(CASE WHEN AMOUNT>0 THEN AMOUNT END,0) AS CREDIT,
SUM(Amount) OVER(ORDER BY CreatedDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal
 FROM CTE ORDER BY CreatedDate


END











GO
/****** Object:  StoredProcedure [dbo].[sp_GlAccountStatementByBranchCostCenter]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_GlAccountStatementByBranchCostCenter] 
	-- Add the parameters for the stored procedure here
	@ChartOfAccountID Varchar(MAX),
	@StartDate Datetime,
	@EndDate Datetime,
	@PostingPeriod Varchar(MAX),
	@BranchID Varchar(50)
AS
DECLARE
	@OpeningBalance Numeric (18,2)
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here

WITH CTE AS
(
SELECT (select AccountCode from swiftfin_ChartOfAccounts where id=@ChartOfAccountID) as AccountCode,
(select AccountName from swiftfin_ChartOfAccounts where id=@ChartOfAccountID) as AccountName,'Balance B/F at ' +convert(varchar(10),@startdate,103) as PrimaryDescription,'<Opening Balance>' as SecondaryDescription,'<Opening Balance>' as Reference,
(select Balance from f_GLAccountBalance(@ChartOfAccountID,@StartDate)) as Amount,@StartDate as CreatedDate,'' as FullAccountNumber,'' as FullName,'' as ContrAccountCode,'' as ContraAccountName
    UNION ALL
SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, 
                         dbo.swiftfin_Journals.Reference, dbo.swiftfin_JournalEntries.Amount, dbo.swiftfin_Journals.ValueDate as CreatedDate, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), 
                         SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccountNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818'
                          THEN 'Prof' WHEN '48819' THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN
                          'Ms' ELSE 'UnKnown' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         swiftfin_ChartOfAccounts_1.AccountCode AS ContraAccountCode, swiftfin_ChartOfAccounts_1.AccountName AS ContraAccountName
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId RIGHT OUTER JOIN
                         dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId ON 
                         dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = swiftfin_ChartOfAccounts_1.Id ON 
                         dbo.swiftfin_Branches.Id = dbo.swiftfin_Journals.BranchId ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId
WHERE        (dbo.swiftfin_Journals.ValueDate BETWEEN @StartDate AND @EndDate) AND (dbo.swiftfin_Journals.PostingPeriodId = @PostingPeriod) AND 
                         (dbo.swiftfin_ChartOfAccounts.Id = @ChartOfAccountID ) and  dbo.swiftfin_Journals.BranchId=@BranchID
						 ) SELECT AccountCode,AccountName,PrimaryDescription,SecondaryDescription,Reference,CreatedDate,FullAccountNumber,FullName,ContrAccountCode,ContraAccountName,
ISNULL(CASE WHEN AMOUNT<0 THEN AMOUNT*-1 END,0) AS DEBIT,
ISNULL(CASE WHEN AMOUNT>0 THEN AMOUNT END,0) AS CREDIT,
SUM(Amount) OVER(ORDER BY CreatedDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal
 FROM CTE ORDER BY CreatedDate


END











GO
/****** Object:  StoredProcedure [dbo].[sp_GlAccountStatementByCostCenter]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_GlAccountStatementByCostCenter] as





GO
/****** Object:  StoredProcedure [dbo].[sp_GlSingleAccountTransactionsSummarized]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 14.06.2014
-- Description:	GLTransactionsSummarized
-- =============================================
--sp_GlSingleAccountTransactionsSummarized '347FCC34-7D65-C7EF-1788-08D10D7DA0F1','05/20/2014','05/31/2014'
CREATE PROCEDURE [dbo].[sp_GlSingleAccountTransactionsSummarized] 
	-- Add the parameters for the stored procedure here
	@ChartOfAccountID VarChar(100),
	@PostingPeriod VarChar(100),
	@StartDate DateTime , 
	@EndDate DateTime 
AS
	 Declare @OpenningBalance Numeric(18,2)

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	 set @OpenningBalance=isnull((select sum(amount) from swiftfin_JournalEntries 
					where ChartOfAccountId =@ChartOfAccountID 
					and CreatedDate<@StartDate),0);


	WITH GLTransactionSummaries_CTE (Serial,AccountCode, AccountName, Debit,Credit,Amount,CreatedDate,PrimaryDescription,SecondaryDescription,ContrAccountCode,ContraAccountName)
	AS
	-- Define the first CTE query.
	(

		SELECT  ROW_NUMBER() OVER(ORDER BY CONVERT(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate, 103)),dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
		CASE
		WHEN SUM(dbo.swiftfin_JournalEntries.Amount)<0 THEN SUM(dbo.swiftfin_JournalEntries.Amount)*-1
		ELSE 0 END AS DEBIT,
		CASE
		WHEN SUM(dbo.swiftfin_JournalEntries.Amount)>=0 THEN SUM(dbo.swiftfin_JournalEntries.Amount)
		ELSE 0 END AS CREDIT,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount, CONVERT(varchar(10), 
								 dbo.swiftfin_JournalEntries.CreatedDate, 103) AS CreatedDate, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.secondaryDescription, swiftfin_ChartOfAccounts_1.AccountCode AS ContrAccountCode, 
								 swiftfin_ChartOfAccounts_1.AccountName AS ContraAccountName
		FROM            dbo.swiftfin_JournalEntries INNER JOIN
								 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
								 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
								 dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = swiftfin_ChartOfAccounts_1.Id
		WHERE dbo.swiftfin_JournalEntries.ChartOfAccountId=@ChartOfAccountID and swiftfin_Journals.PostingPeriodId=@PostingPeriod
		AND swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate
		GROUP BY dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, CONVERT(varchar(10), dbo.swiftfin_JournalEntries.CreatedDate, 103), 
								 dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.SecondaryDescription, swiftfin_ChartOfAccounts_1.AccountCode, swiftfin_ChartOfAccounts_1.AccountName

	)

	SELECT Serial,AccountCode, AccountName, Debit,Credit,Amount,CreatedDate,PrimaryDescription,SecondaryDescription,ContrAccountCode,ContraAccountName INTO #TempGLTrans FROM GLTransactionSummaries_CTE
	insert into #TempGLTrans(Serial,AccountCode, AccountName, Debit,Credit,Amount,CreatedDate,PrimaryDescription,ContrAccountCode,ContraAccountName)
	select 0,AccountCode, AccountName, 0,0,@OpenningBalance,@StartDate,'Balance B/F',AccountCode,AccountName  from #TempGLTrans where Serial=1

	SELECT Serial,AccountCode, AccountName,ContrAccountCode,ContraAccountName,CreatedDate,PrimaryDescription,SecondaryDescription, Debit,Credit,SUM(Amount) OVER(ORDER BY Serial 
							ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal
	FROM #TempGLTrans 						 
	
END





GO
/****** Object:  StoredProcedure [dbo].[Sp_GoodsDispatchNoteItems]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Gilbert
-- Create date: 18/06/2018
-- Description:	InvoiceItems
-- =============================================
Create PROCEDURE [dbo].[Sp_GoodsDispatchNoteItems] 
	-- Add the parameters for the stored procedure here
@GoodsDispatchNoteId uniqueidentifier 
AS
BEGIN
--set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_GoodsDispatchNotes.ReferenceNumber, dbo.swiftfin_ItemRegister.Description AS ItemName, dbo.swiftfin_InventoryUnitsOfMeasure.Description AS UnitsOfMeasure, dbo.vw_EmployeeRegister.FullName, 
                         dbo.swiftfin_GoodsDispatchNotes.CreatedBy, dbo.swiftfin_GoodsDispatchNotes.CreatedDate,dbo.swiftfin_GoodsDispatchNoteItems.GoodsDispatchNoteId, 
						 Case dbo.swiftfin_ItemRegister.ItemType WHEN 1 THEN 'Asset' WHEN 2 THEN 'Inventory' ELSE '' END AS ItemType, dbo.swiftfin_GoodsDispatchNoteItems.Quantity, dbo.swiftfin_Requisitions.ReferenceNumber AS Requisition#
FROM            dbo.swiftfin_GoodsDispatchNotes INNER JOIN
                         dbo.swiftfin_GoodsDispatchNoteItems ON dbo.swiftfin_GoodsDispatchNotes.Id = dbo.swiftfin_GoodsDispatchNoteItems.GoodsDispatchNoteId INNER JOIN
                         dbo.swiftfin_ItemRegister ON dbo.swiftfin_GoodsDispatchNoteItems.ItemRegisterId = dbo.swiftfin_ItemRegister.Id INNER JOIN
                         dbo.swiftfin_InventoryUnitsOfMeasure ON dbo.swiftfin_ItemRegister.InventoryUnitOfMeasureId = dbo.swiftfin_InventoryUnitsOfMeasure.Id INNER JOIN
                         dbo.vw_EmployeeRegister ON dbo.swiftfin_GoodsDispatchNotes.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.swiftfin_RequisitionItems ON dbo.swiftfin_GoodsDispatchNoteItems.RequisitionItemId = dbo.swiftfin_RequisitionItems.Id INNER JOIN
                         dbo.swiftfin_Requisitions ON dbo.swiftfin_RequisitionItems.RequisitionId = dbo.swiftfin_Requisitions.Id
                        
	where  dbo.swiftfin_GoodsDispatchNoteItems.GoodsDispatchNoteId=@GoodsDispatchNoteId
END
GO
/****** Object:  StoredProcedure [dbo].[Sp_GoodsDispatchNotes]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

Create PROCEDURE [dbo].[Sp_GoodsDispatchNotes] 
	-- Add the parameters for the stored procedure here
@ReferenceNumber nvarchar(256)
AS
BEGIN

SELECT          dbo.swiftfin_GoodsDispatchNotes.Id, dbo.swiftfin_GoodsDispatchNotes.ReferenceNumber, dbo.swiftfin_Departments.Description As Department, dbo.swiftfin_Branches.Description AS Branch, dbo.vw_EmployeeRegister.FullName RecepientName, dbo.swiftfin_GoodsDispatchNotes.CreatedBy, 
                         dbo.swiftfin_GoodsDispatchNotes.CreatedDate, Case dbo.swiftfin_GoodsDispatchNotes.Status WHen 1 Then 'Dispatched' when 2 Then 'Cancelled' else '' End As Status
FROM            dbo.swiftfin_GoodsDispatchNotes INNER JOIN
                         dbo.swiftfin_Departments ON dbo.swiftfin_GoodsDispatchNotes.DepartmentId = dbo.swiftfin_Departments.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_GoodsDispatchNotes.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.vw_EmployeeRegister ON dbo.swiftfin_GoodsDispatchNotes.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID
						 where dbo.swiftfin_GoodsDispatchNotes.ReferenceNumber=@ReferenceNumber
						 order by dbo.swiftfin_GoodsDispatchNotes.ReferenceNumber
						 END
GO
/****** Object:  StoredProcedure [dbo].[Sp_GoodsReceivedNoteItems]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Gilbert
-- Create date: 18/06/2018
-- Description:	GoodsReceivedNoteItems
-- =============================================
Create PROCEDURE [dbo].[Sp_GoodsReceivedNoteItems] 
	-- Add the parameters for the stored procedure here
@GoodsReceivedNoteId uniqueidentifier 
AS
BEGIN
--set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_GoodsReceivedNotes.ReferenceNumber, dbo.swiftfin_Suppliers.Description As Supplier, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_Suppliers.Address_Email, dbo.swiftfin_Suppliers.Address_MobileLine, 
                         dbo.swiftfin_GoodsReceivedNoteItems.Quantity, dbo.swiftfin_GoodsReceivedNoteItems.UnitCost, dbo.swiftfin_GoodsReceivedNoteItems.TotalCost, dbo.swiftfin_GoodsReceivedNoteItems.Manufacturer, 
                         dbo.swiftfin_GoodsReceivedNoteItems.Model, dbo.swiftfin_GoodsReceivedNoteItems.SerialNumber, Case dbo.swiftfin_GoodsReceivedNoteItems.Status  when 0 Then 'Pending' when 1 Then 'Active' when 2 then 'Closed' else '' end As Status, dbo.swiftfin_ItemRegister.Code, dbo.swiftfin_ItemRegister.Description AS Name, 
                         Case dbo.swiftfin_ItemRegister.ItemType when 1 Then 'Asset' When 2 Then 'Inventory' else '' end AS ItemType,dbo.swiftfin_GoodsReceivedNoteItems.CreatedBy, dbo.swiftfin_GoodsReceivedNoteItems.CreatedDate, 
                         dbo.swiftfin_GoodsReceivedNoteItems.GoodsReceivedNoteId
FROM            dbo.swiftfin_GoodsReceivedNotes INNER JOIN
                         dbo.swiftfin_Suppliers ON dbo.swiftfin_GoodsReceivedNotes.SupplierId = dbo.swiftfin_Suppliers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_GoodsReceivedNotes.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_GoodsReceivedNoteItems ON dbo.swiftfin_GoodsReceivedNotes.Id = dbo.swiftfin_GoodsReceivedNoteItems.GoodsReceivedNoteId INNER JOIN
                         dbo.swiftfin_ItemRegister ON dbo.swiftfin_GoodsReceivedNoteItems.ItemRegisterId = dbo.swiftfin_ItemRegister.Id
                      
                        
	where  dbo.swiftfin_GoodsReceivedNoteItems.GoodsReceivedNoteId=@GoodsReceivedNoteId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_HighestProductBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_HighestProductBalance] 
	-- Add the parameters for the stored procedure here
	@Product uniqueidentifier , 
	@EndDate datetime ,
	@TopX int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	---select * from vw_CustomerAccounts
WITH TopXBalance (Account, Name,PayrollNo ,ProductName,Balance,Station,type)
AS
-- Define the CTE query.
(
    SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.reference3, Products_1.Description, 
                         SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,dbo.swiftfin_Stations.Description, Products_1.type
	FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.ChartOfAccountId LEFT OUTER JOIN
                         dbo.swiftfin_Stations ON dbo.vw_CustomerAccounts.StationId = dbo.swiftfin_Stations.Id
	where Products_1.id=@Product and dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
	GROUP BY dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, Products_1.Description, dbo.vw_CustomerAccounts.Reference3,dbo.swiftfin_Stations.Description,Products_1.type
)
select top (@TopX) Account,Name,PayrollNo,ProductName,Station,
case type
when 'Loans' then Balance*-1
else
Balance
end as Balance from  TopXBalance order by case type
when 'Loans' then Balance*-1
else
Balance
end  desc
END






GO
/****** Object:  StoredProcedure [dbo].[sp_HighestProductBalanceMonthly]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_HighestProductBalanceMonthly] 
	-- Add the parameters for the stored procedure here
	@Product uniqueidentifier , 
	@StartDate Datetime,
	@EndDate datetime ,
	@TopX int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	---select * from vw_CustomerAccounts
WITH TopXBalance (Account, Name,PayrollNo ,ProductName,Balance,Station,type,Employer)
AS
-- Define the CTE query.
(
    SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.reference3, Products_1.Description, 
                         SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,dbo.swiftfin_Stations.Description, Products_1.type,dbo.vw_CustomerAccounts.EmployerID
	FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.ChartOfAccountId LEFT OUTER JOIN
                         dbo.swiftfin_Stations ON dbo.vw_CustomerAccounts.StationId = dbo.swiftfin_Stations.Id
	where Products_1.id=@Product and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and  @EndDate
	GROUP BY dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, Products_1.Description,dbo.vw_CustomerAccounts.EmployerID, dbo.vw_CustomerAccounts.Reference3,dbo.swiftfin_Stations.Description,Products_1.type
)
select top (@TopX) Account,Name,PayrollNo,ProductName,Employer,
case type
when 'Loans' then Balance*-1
else
Balance
end as Balance from  TopXBalance order by case type
when 'Loans' then Balance*-1
else
Balance
end  desc
END








GO
/****** Object:  StoredProcedure [dbo].[sp_InactiveAccountsWithLoanBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[sp_InactiveAccountsWithLoanBalance]
AS

With LoanProductBalances(AccountNo,Reference1,Reference2,Reference3,AccountName,Product,Balance)
	AS
	(

SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Description, 
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
	where dbo.vw_CustomerAccounts.status=1
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Description,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount)
		select * from LoanProductBalances where balance<>0

		--select top 10 * from  vw_CustomerAccounts\


		--select * from swiftfin_Enumerations where [key] like '%account%'

GO
/****** Object:  StoredProcedure [dbo].[sp_IncomeExpenditureByBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 14.06.2014
-- Description:	ConsolidatedTrialBalance
-- =============================================
---SELECT * FROM swiftfin_PostingPeriods
---SELECT * FROM swiftfin_Branches
---select * from swiftfin_costcenters
---[sp_IncomeExpenditureByBranch] '08/29/2016','E9286081-6839-C17D-E5D8-08D3A5AADBF0','CFF292F7-BFC7-C83E-5574-08D3A5AC63F5'
CREATE PROCEDURE [dbo].[sp_IncomeExpenditureByBranch] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime,
	@StartDate Datetime
	--@BranchID varchar(100), 
	--@CostCenterId varchar(100)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	set @StartDate=	(select DATEADD(day, DATEDIFF(day, 0, @StartDate), '23:59:59'));
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	Declare 	@LocalEndDate DateTime=@EndDate,
				@LocalStartDate DateTime=@StartDate
				--@LocalBranchID varchar(100)=@BranchID, 
				--@LocalCostCenterId varchar(100)=@CostCenterId
				set @LocalStartDate='01/01/'+ltrim(rtrim(str(year(@LocalEndDate))));
with CTEIncomeExpenditure (AccountTypeCode,SortOrder,AccountCode,AccountName,Credit,Debit,AccountType,subdescription,branch,costcenter)
as
(
SELECT        CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN 5000
                          THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000 THEN 'C' WHEN 2000 THEN 'D' WHEN 3000 THEN 'E' WHEN 4000 THEN 'A' WHEN 5000 THEN 'B' END AS SortOrder,
                          a.AccountCode, a.AccountName, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount)
						 
                         < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit, a.AccountType,
						 (select top 1 AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,4)=left(b.AccountCode,4) and costcenterid is not null) as subdescription,
						 swiftfin_Journals.BranchId,a.CostCenterId
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts a ON dbo.swiftfin_JournalEntries.ChartOfAccountId = a.Id
WHERE  dbo.swiftfin_Journals.ValueDate between @LocalStartDate and @LocalEndDate
--AND swiftfin_Journals.BranchId=@LocalBranchID 
--AND CostCenterId=@LocalCostCenterId 
and  AccountType in (5000,4000) 

	
GROUP BY a.AccountCode, a.AccountName, a.AccountType,swiftfin_Journals.BranchId,a.CostCenterId
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0) 
),
cte (AccountTypeCode,SortOrder,AccountCode,AccountName,Credit,Debit,AccountType,subdescription,branch,costcenter)
as
(
select AccountTypeCode,SortOrder,AccountCode,AccountName,Credit,Debit,AccountType,subdescription,branch,costcenter from CTEIncomeExpenditure
UNION ALL
select TOP 1 'Surplus/Loss','B',(SELECT AccountCode FROM swiftfin_ChartOfAccounts WHERE ID IN (SELECT ChartOfAccountId FROM swiftfin_SystemGeneralLedgerAccountMappings WHERE SystemGeneralLedgerAccountCode='48831')),(SELECT AccountName FROM swiftfin_ChartOfAccounts a WHERE ID IN (SELECT ChartOfAccountId FROM swiftfin_SystemGeneralLedgerAccountMappings WHERE SystemGeneralLedgerAccountCode='48831')),

CASE 
WHEN (select SUM(DEBIT-CREDIT) from CTEIncomeExpenditure)>=0 THEN (select SUM(DEBIT-CREDIT) from CTEIncomeExpenditure)
ELSE 0 END,
CASE 
WHEN (select SUM(DEBIT-CREDIT) from CTEIncomeExpenditure)<0 THEN (select SUM(DEBIT-CREDIT) from CTEIncomeExpenditure)*-1
ELSE 0 END
,(SELECT AccountType FROM swiftfin_ChartOfAccounts WHERE ID IN (SELECT ChartOfAccountId FROM swiftfin_SystemGeneralLedgerAccountMappings WHERE SystemGeneralLedgerAccountCode='48831')), 
 'Surplus/Loss',branch,costcenter
from CTEIncomeExpenditure

)
select * FROM cte
order by AccountType ,AccountCode
END









GO
/****** Object:  StoredProcedure [dbo].[sp_IncomeStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---select DATEADD(yy,-1,getdate())
--SELECT * FROM swiftfin_PostingPeriods
----[sp_IncomeStatement] '6/30/2018','6D1AC584-032D-E811-80D1-F40343552CF8'
--select * from swiftfin_CostCenters
---select * from swiftfin_Branches
CREATE PROCEDURE [dbo].[sp_IncomeStatement] 
(
	@EndDate DateTime,
	@PostingPeriod varchar(100)
	--@Branch varchar(MAX),
	--@costcenter varchar(max)
	
)
AS
Declare 
	@StartDate as Datetime=DATEADD(yy, DATEDIFF(yy,0,@EndDate), 0)

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN 5000
                          THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000 THEN 'C' WHEN 2000 THEN 'D' WHEN 3000 THEN 'E' WHEN 4000 THEN 'A' WHEN 5000 THEN 'B' END AS SortOrder,
                          dbo.swiftfin_Branches.Code, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance, 
                        isnull((select sum(amount) from dbo.swiftfin_JournalEntries where CreatedDate BETWEEN DATEADD(yy,-1,@StartDate) AND DATEADD(yy,-1,@EndDate) and ChartOfAccountId=dbo.swiftfin_ChartOfAccounts.Id),0) as PreviousYearSamePeriod,
						 dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_Branches.id AS Branch, dbo.swiftfin_CostCenters.id AS CostCenter, 
                          dbo.swiftfin_PostingPeriods.Description AS PostingPeriod
INTO #temp
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id
WHERE dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate 
and dbo.swiftfin_PostingPeriods.Id=@PostingPeriod 
AND dbo.swiftfin_ChartOfAccounts.AccountType IN (4000,5000)
--AND dbo.swiftfin_Branches.id in (@Branch)
--AND dbo.swiftfin_CostCenters.Id in (@CostCenter)

GROUP BY dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_Branches.Description, 
                         dbo.swiftfin_Branches.Code, dbo.swiftfin_CostCenters.Description, dbo.swiftfin_PostingPeriods.Id, dbo.swiftfin_PostingPeriods.Description,dbo.swiftfin_ChartOfAccounts.Id
						 ,dbo.swiftfin_Branches.id,dbo.swiftfin_CostCenters.Id
---HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)

insert into #temp (AccountTypeCode,AccountType,SortOrder,AccountCode,AccountName,Balance,PreviousYearSamePeriod,code,Branch,CostCenter)
select 'NetIncome','6000','C','6000','Net Income',(select sum(balance) from #temp),isnull((select sum(PreviousYearSamePeriod) from #temp),0),99,
'BBD39924-4A2C-E811-80CF-F40343552CF8','573F8A3B-052C-E811-8320-507B9DA391CE'

select * from #temp where isnull(PreviousYearSamePeriod,0)+isnull(balance,0)<>0 order by AccountCode














GO
/****** Object:  StoredProcedure [dbo].[sp_IncomeStatementConsolidated]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---select DATEADD(yy,-1,getdate())

--select * from swiftfin_CostCenters
---select * from swiftfin_Branches
---select * from swiftfin_postingperiods

--exec  [sp_IncomeStatementConsolidated] '05/29/2018','6D1AC584-032D-E811-80D1-F40343552CF8'
CREATE  procedure [dbo].[sp_IncomeStatementConsolidated] 
(
	@EndDate DateTime,
	@PostingPeriod varchar(100)
	--@Branch varchar(MAX),
	--@CostCenter varchar(MAX)

)
AS
Declare 
	@StartDate as Datetime=DATEADD(yy, DATEDIFF(yy,0,@EndDate), 0)

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN 5000
                          THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000 THEN 'C' WHEN 2000 THEN 'D' WHEN 3000 THEN 'E' WHEN 4000 THEN 'A' WHEN 5000 THEN 'B' END AS SortOrder,

					 a.AccountCode, a.AccountName, 
                      ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, 
                         ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit, 
                        --isnull((select sum(amount) from dbo.swiftfin_JournalEntries where CreatedDate BETWEEN DATEADD(yy,-1,@StartDate) AND DATEADD(yy,-1,@EndDate) and ChartOfAccountId=a.Id),0) as PreviousYearSamePeriod,
						 a.AccountType,
                          dbo.swiftfin_PostingPeriods.Description AS PostingPeriod,
						  (select top 1 AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,4)=left(b.AccountCode,4) and costcenterid is not null) as subdescription
INTO #temp
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts a ON dbo.swiftfin_JournalEntries.ChartOfAccountId = a.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id
WHERE dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate 
and dbo.swiftfin_PostingPeriods.Id=@PostingPeriod 
AND a.AccountType IN (4000,5000)
--AND dbo.swiftfin_Branches.id in (@Branch)
--AND dbo.swiftfin_CostCenters.Id in (@CostCenter)

GROUP BY a.AccountCode, a.AccountName, a.AccountType, 
                         dbo.swiftfin_PostingPeriods.Id, dbo.swiftfin_PostingPeriods.Description,a.Id
---HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)

insert into #temp (AccountTypeCode,AccountType,SortOrder,AccountCode,AccountName,debit,credit,subdescription)
select 'SurplusLoss','6000','C','6000','SurplusLoss',
CASE 
WHEN (select SUM(DEBIT-CREDIT) from #temp)>=0 THEN (select SUM(DEBIT-CREDIT) from #temp)
ELSE 0 END,
CASE 
WHEN (select SUM(DEBIT-CREDIT) from #temp)<0 THEN (select SUM(DEBIT-CREDIT) from #temp)*-1
ELSE 0 END,


''


select * from #temp where isnull(debit,0)+isnull(credit,0)<>0 order by SortOrder









GO
/****** Object:  StoredProcedure [dbo].[sp_IncomeStatementwithBudget]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---select * from swiftfin_PostingPeriods
---sp_IncomeStatementwithBudget '04/30/2014','28C1F651-CFFE-C466-553E-08D0FC697DC8'
CREATE PROCEDURE [dbo].[sp_IncomeStatementwithBudget] 
(
	@EndDate DateTime,
	@PostingPeriod varchar(100)
)
as
Declare
	@StartDate as Datetime=DATEADD(yy, DATEDIFF(yy,0,@EndDate), 0)
SELECT        dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         dbo.swiftfin_BudgetEntries.Amount AS TotalBudget, dbo.swiftfin_PostingPeriods.Description AS PostingPeriod
FROM            dbo.swiftfin_ChartOfAccounts LEFT OUTER JOIN
                         dbo.swiftfin_Budgets INNER JOIN
                         dbo.swiftfin_BudgetEntries ON dbo.swiftfin_Budgets.Id = dbo.swiftfin_BudgetEntries.BudgetId INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Budgets.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id ON 
                         dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_BudgetEntries.ChartOfAccountId
WHERE  dbo.swiftfin_Budgets.PostingPeriodId in (@PostingPeriod)
AND dbo.swiftfin_ChartOfAccounts.AccountType IN (4000000,5000000)












GO
/****** Object:  StoredProcedure [dbo].[sp_IncomeStatementWithBudgetSummaries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

---select * from swiftfin_PostingPeriods

---sp_IncomeStatementWithBudgetSummaries '28C1F651-CFFE-C466-553E-08D0FC697DC8','04/30/2014'
CREATE PROCEDURE [dbo].[sp_IncomeStatementWithBudgetSummaries] 
	-- Add the parameters for the stored procedure here
	@PostingPeriod VARCHAR(MAX),
	@EndDate as Datetime
AS
DECLARE
	@StartDate as Datetime=DATEADD(yy, DATEDIFF(yy,0,@EndDate), 0)
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	

	SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ChartOfAccounts.AccountType, 
		isnull((
			SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) 
			FROM            dbo.swiftfin_Journals INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId
			where dbo.swiftfin_JournalEntries.ChartOfAccountId= dbo.swiftfin_ChartOfAccounts.ID 
			AND PostingPeriodId=@PostingPeriod						
			AND dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate
		),0) as ActualToDate,
		isnull(f_MonthlyBudget_1.TotalBudget,0) as TotalBudget, isnull(f_MonthlyBudget_1.MonthlyBudget,0) as MonthlyBudget, isnull(f_MonthlyBudget_1.MonthlyBudget,0)*month(@Enddate) as BudgetToDate
	INTO #TempTable
	FROM            dbo.swiftfin_ChartOfAccounts left JOIN
					dbo.f_MonthlyBudget(@EndDate,@PostingPeriod) AS f_MonthlyBudget_1 ON dbo.swiftfin_ChartOfAccounts.Id = f_MonthlyBudget_1.ID
	WHERE dbo.swiftfin_ChartOfAccounts.AccountType in (4000000,5000000)

	SELECT AccountCode,AccountName,AccountType,
	CASE  AccountType 
	WHEN 4000000 THEN ActualToDate
	WHEN 5000000 THEN ActualToDate *-1
	END as ActualToDate
	,TotalBudget,MonthlyBudget,BudgetToDate,
	BudgetToDate-(
	CASE  AccountType 
	WHEN 4000000 THEN ActualToDate
	WHEN 5000000 THEN ActualToDate *-1
	END) as BudgetBalance into #tempTable2 from #TempTable  
insert into #tempTable2 (AccountCode,AccountName,AccountType,ActualToDate,TotalBudget,MonthlyBudget,BudgetToDate,BudgetBalance)
select 6000000,'Net',6000000,
(select sum(ActualToDate) from #tempTable2 where AccountType='4000000')-(select sum(ActualToDate) from #tempTable2 where AccountType='5000000') ActualToDate,
(select sum(TotalBudget) from #tempTable2 where AccountType='4000000')-(select sum(TotalBudget) from #tempTable2 where AccountType='5000000') TotalBudget,
(select sum(MonthlyBudget) from #TempTable2 where AccountType='4000000')-(select sum(MonthlyBudget) from #tempTable2 where AccountType='5000000') MonthlyBudget,
(select sum(BudgetToDate) from #TempTable2 where AccountType='4000000')-(select sum(BudgetToDate) from #tempTable2 where AccountType='5000000') BudgetToDate,
(select sum(BudgetBalance) from #TempTable2 where AccountType='4000000')-(select sum(BudgetBalance) from #tempTable2 where AccountType='5000000') BudgetBalance
 select *,			CASE [AccountType]
				WHEN 6000000 THEN 'Net'
				WHEN 4000000 THEN 'Income'
				WHEN 5000000 THEN 'Expenses'
			END AccountTypeDesc
 from #tempTable2 where ActualToDate+TotalBudget+MonthlyBudget+BudgetToDate<>0

END










GO
/****** Object:  StoredProcedure [dbo].[sp_InhouseCheques]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 06/10/2014
-- Description:	sp_InhouseCheques
-- =============================================
CREATE PROCEDURE [dbo].[sp_InhouseCheques] 
	-- Add the parameters for the stored procedure here
	@StartDate datetime , 
	@EndDate datetime,
	@FilterField varchar(50) 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
			set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.FullAccount, 
                         dbo.swiftfin_InHouseCheques.Amount, dbo.swiftfin_InHouseCheques.Payee, dbo.swiftfin_InHouseCheques.Reference, dbo.swiftfin_InHouseCheques.IsPrinted, 
                         dbo.swiftfin_InHouseCheques.PrintedNumber, dbo.swiftfin_InHouseCheques.PrintedBy, dbo.swiftfin_InHouseCheques.PrintedDate, dbo.swiftfin_InHouseCheques.CreatedBy, 
                         dbo.swiftfin_InHouseCheques.CreatedDate, dbo.swiftfin_Branches.Description
	FROM            dbo.swiftfin_InHouseCheques INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_InHouseCheques.DebitCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_InHouseCheques.DebitChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_InHouseCheques.BranchId = dbo.swiftfin_Branches.Id
	WHERE 
	CASE 
		WHEN @FilterField='CreatedDate' then dbo.swiftfin_InHouseCheques.CreatedDate
		WHEN @FilterField='PrintedDate' then dbo.swiftfin_InHouseCheques.PrintedDate
	end
	between @StartDate and @EndDate


END






GO
/****** Object:  StoredProcedure [dbo].[sp_InsiderLending]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 16.07.2014
-- Description:	InsiderLending
-- =============================================
CREATE PROCEDURE [dbo].[sp_InsiderLending] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
				SELECT        dbo.vw_MemberRegister.Salutation +' '+ dbo.vw_MemberRegister.Individual_FirstName +' '+ dbo.vw_MemberRegister.Individual_LastName as FullName, 
									 dbo.vw_MemberRegister.Gender, dbo.vw_MemberRegister.Individual_IdentityCardNumber, dbo.vw_MemberRegister.MembershipNumber, 
									 dbo.vw_MemberRegister.Individual_PayrollNumbers,


			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND 
									 (dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection = 1) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as BosaLoans,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND 
									 (dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection = 0) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as FosaLoans,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as TotalLoans,

			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) and swiftfin_InvestmentProducts.Code=1 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as ShareCapital,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) and swiftfin_InvestmentProducts.Code=2 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as ShareDeposits,'Directors' as Description


			FROM            dbo.swiftfin_Directors INNER JOIN
									 dbo.vw_MemberRegister ON dbo.swiftfin_Directors.CustomerId = dbo.vw_MemberRegister.Id

			union
			SELECT        FullName, Gender, IdentityCardNumber, MembershipNumber, PersonalFileNumber,
			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND 
									 (dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection = 1) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as BosaLoans,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND 
									 (dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection = 0) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as FosaLoans,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId and swiftfin_JournalEntries.CreatedDate<=@EndDate) 
			),0)*-1 as TotalLoans,

			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) and swiftfin_InvestmentProducts.Code=1 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as ShareCapital,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) and swiftfin_InvestmentProducts.Code=2 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as ShareDeposits,'Staff' as Description


			FROM            dbo.vw_EmployeeRegister where MembershipNumber<>'07767'


END






GO
/****** Object:  StoredProcedure [dbo].[sp_InsiderLendingDetailed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--sp_InsiderLendingDetailed '12/01/2018'

CREATE PROCEDURE [dbo].[sp_InsiderLendingDetailed] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
				SELECT       dbo.vw_MemberRegister.Individual_FirstName +' '+ dbo.vw_MemberRegister.Individual_LastName as FullName, 
									 dbo.vw_MemberRegister.Individual_IdentityCardNumber, dbo.vw_MemberRegister.MembershipNumber, 
									 dbo.vw_MemberRegister.Individual_PayrollNumbers,
--select code,description, * from swiftfin_LoanProducts

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=1 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as SALARYADVANCE_PF ,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=2 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as FOSALOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=3 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as SalaryAdvanceCasual,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=4 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as FOSALOANPLUS,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=5 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as EMPLOYERSADVANCE,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=6 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as SALARYINADVAnCE,
				isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=7 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as INSTANTPLUSLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=8 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as INSTANTLOANFOSA,
				isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=9 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as NORMALLOAN,


			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=10 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as SCHOOLFEESLOAN,

						isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=11 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as EMERGENCYLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=12 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as INSTANTLOANBOSA,
			

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=13 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as PASSAGEBAGGAGELOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=14 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as COOPPERSONALLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=15 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as PIKIPIKILOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=16 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as INSTANTPLUS,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=17 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as DEVELOPMENTLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=18 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as COLLEGEFEESLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=19 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as MALIZAMRADI,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=20 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as NORMALLOANPLUS,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=21 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as GUARANTORSLIABILITY,
			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) AND dbo.swiftfin_LoanProducts.Code=23 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as DEPOSITBOOSTINGLOAN,


			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as TotalLoans,

			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) and swiftfin_InvestmentProducts.Code=2 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as ShareCapital,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = swiftfin_Directors.CustomerId) and swiftfin_InvestmentProducts.Code=1 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as ShareDeposits,'Directors' as Description 


			FROM            dbo.swiftfin_Directors INNER JOIN
									 dbo.vw_MemberRegister ON dbo.swiftfin_Directors.CustomerId = dbo.vw_MemberRegister.Id

			union
			SELECT        FullName, IdentityCardNumber, MembershipNumber, PersonalFileNumber,
						isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=1 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as SALARYADVANCE_PF ,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=2 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as FOSALOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=3 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as SalaryAdvanceCasual,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=4 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as FOSALOANPLUS,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=5 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as EMPLOYERSADVANCE,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=6 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as SALARYINADVAnCE,
				isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=7 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as INSTANTPLUSLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=8 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as INSTANTLOANFOSA,
				isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=9 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as NORMALLOAN,


			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=10 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as SCHOOLFEESLOAN,

						isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=11 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as EMERGENCYLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=12 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as INSTANTLOANBOSA,
			

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=13 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as PASSAGEBAGGAGELOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=14 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as COOPPERSONALLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=15 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as PIKIPIKILOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=16 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as INSTANTPLUS,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=17 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as DEVELOPMENTLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=18 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as COLLEGEFEESLOAN,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=19 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as MALIZAMRADI,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=20 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as NORMALLOANPLUS,

			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=21 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as GUARANTORSLIABILITY,
			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) AND dbo.swiftfin_LoanProducts.Code=23 and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as DEPOSITBOOSTINGLOAN,

			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId and swiftfin_JournalEntries.CreatedDate<=@EndDate) 
			),0)*-1 as TotalLoans,

			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) and swiftfin_InvestmentProducts.Code=2 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as ShareCapital,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_EmployeeRegister.CustomerId) and swiftfin_InvestmentProducts.Code=1 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as ShareDeposits,'Staff' as Description


			FROM            dbo.vw_EmployeeRegister

END


GO
/****** Object:  StoredProcedure [dbo].[sp_InterestPaid]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--sp_InterestPaid '07/01/2018','08/08/2018'

CREATE PROC [dbo].[sp_InterestPaid] 
@StartDate DateTime,
@EndDate DateTime

AS

SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Description, dbo.swiftfin_JournalEntries.Amount,
 dbo.swiftfin_JournalEntries.CreatedDate,  dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId AND 
						 dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id

where dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate and  dbo.swiftfin_JournalEntries.Amount>0 and
 dbo.swiftfin_Journals.PrimaryDescription not like '%Revers%'

--select * from swiftfin_Enumerations where [key] like '%transaction%'
GO
/****** Object:  StoredProcedure [dbo].[sp_InterestReceivablesSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---sp_InterestReceivablesSummary '08/26/2016'
---select * from products(0)
CREATE Procedure [dbo].[sp_InterestReceivablesSummary] (@EndDate DateTime)
as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, sum(dbo.swiftfin_JournalEntries.Amount) as Amount
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId AND 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
						 where dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate
						 group by dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName
						




GO
/****** Object:  StoredProcedure [dbo].[sp_InterestReversed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[sp_InterestReversed]
as
SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, 
                    (select description from swiftfin_chartofAccounts where id=dbo.swiftfin_JournalEntries.ContraChartOfAccountId) as Product, dbo.swiftfin_JournalEntries.Amount
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
						 where dbo.swiftfin_JournalEntries.ChartOfAccountId='59C54959-785A-E811-80D5-F40343552CF9' and 
						 PrimaryDescription='Interest Reversal Zerorise'
						 --group by dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.swiftfin_Journals.PrimaryDescription, 
       --                  dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference

						 --select sum(totalvalue) from swiftfin_journals where PrimaryDescription='Interest Reversal Zerorise'

						 --select * from swiftfin_ChartOfAccounts where AccountName like '%suspen%'
						 --select * from swiftfin_Journals where id in(
						 --select JournalId from swiftfin_JournalEntries where ChartOfAccountId='59C54959-785A-E811-80D5-F40343552CF9')
GO
/****** Object:  StoredProcedure [dbo].[sp_IntraAccountTransfer]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_IntraAccountTransfer '06/01/2018','07/01/2018'
CREATE PROC [dbo].[sp_IntraAccountTransfer]

@StartDate Datetime,
@EndDate Datetime

AS
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT      dbo.swiftfin_InvestmentProducts.id, dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_InvestmentProducts.Description,dbo.vw_CustomerAccounts.Reference1, 
dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, 
                         dbo.swiftfin_Journals.Reference, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_JournalEntries.Amount
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id ON 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId AND
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
						  where dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate and TransactionCode=45 and  dbo.swiftfin_JournalEntries.Amount<0
GO
/****** Object:  StoredProcedure [dbo].[sp_InventoryListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		CustomerCare Desk
-- Create date: 
-- Description:	
-- =============================================
Create PROCEDURE [dbo].[sp_InventoryListing] 
@EndDate datetime
AS
BEGIN
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	
SELECT        dbo.swiftfin_ItemRegister.Description AS Name, dbo.swiftfin_InventoryCategories.Description AS Category, dbo.swiftfin_InventoryPackageTypes.Description AS Package, dbo.swiftfin_Suppliers.Description AS Supplier, 
                         dbo.swiftfin_ItemRegister.EstimatedUnitCost, dbo.swiftfin_Inventories.Quantity, dbo.swiftfin_Departments.Description AS Department, dbo.swiftfin_Inventories.UnitPrice, dbo.swiftfin_ItemRegister.Remarks, dbo.swiftfin_ItemRegister.Pallet_TI, 
                         dbo.swiftfin_ItemRegister.Pallet_HI, dbo.swiftfin_ItemRegister.UnitNetWeight, dbo.swiftfin_ItemRegister.UnitGrossWeight, dbo.swiftfin_ItemRegister.LeadDays, dbo.swiftfin_ItemRegister.EconomicOrder, dbo.swiftfin_Inventories.CreatedDate, 
                         dbo.swiftfin_Inventories.CreatedBy
FROM            dbo.swiftfin_Inventories INNER JOIN
                         dbo.swiftfin_ItemRegister ON dbo.swiftfin_Inventories.ItemRegisterId = dbo.swiftfin_ItemRegister.Id INNER JOIN
                         dbo.swiftfin_InventoryCategories ON dbo.swiftfin_ItemRegister.InventoryCategoryId = dbo.swiftfin_InventoryCategories.Id INNER JOIN
                         dbo.swiftfin_InventoryPackageTypes ON dbo.swiftfin_ItemRegister.InventoryPackageTypeId = dbo.swiftfin_InventoryPackageTypes.Id INNER JOIN
                         dbo.swiftfin_Suppliers ON dbo.swiftfin_Inventories.SupplierId = dbo.swiftfin_Suppliers.Id INNER JOIN
                         dbo.swiftfin_Departments ON dbo.swiftfin_Inventories.DepartmentId = dbo.swiftfin_Departments.Id

						 where dbo.swiftfin_Inventories.CreatedDate<=@EndDate 
						 End 
GO
/****** Object:  StoredProcedure [dbo].[sp_InvestmentProductBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec [sp_InvestmentProductBalance] '789BA4B0-85B7-C439-A2C2-08D264EC6D36','93CE779D-9F0C-CA01-2251-08D261CC0815','12/31/2016'
CREATE PROCEDURE [dbo].[sp_InvestmentProductBalance] 
	-- Add the parameters for the stored procedure here
	--@ProductID varchar(100),
	@Branchid varchar(100), 
	--@StartDate DateTime ,
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With InvestmentProductBalances(AccountNo,Reference1,Reference2,Reference3,AccountName,Branch,Balance,Product,ProductName)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		 dbo.swiftfin_branches.Description,SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,dbo.swiftfin_InvestmentProducts.Id,dbo.swiftfin_InvestmentProducts.Description
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId inner join
								 dbo.swiftfin_journals on dbo.swiftfin_JournalEntries.JournalId=dbo.swiftfin_journals.id inner join
								 dbo.swiftfin_branches on dbo.swiftfin_journals.branchid=dbo.swiftfin_branches.id


		WHERE        (/*dbo.swiftfin_InvestmentProducts.id in (@ProductID) and */ dbo.swiftfin_branches.id=@Branchid and dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount, dbo.swiftfin_branches.Description,dbo.swiftfin_InvestmentProducts.Id,dbo.swiftfin_InvestmentProducts.Description
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,branch,SUM(Balance) AS Balance,Product,ProductName
	FROM InvestmentProductBalances
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,branch,Product,ProductName having SUM(Balance) <>0
END







GO
/****** Object:  StoredProcedure [dbo].[sp_InvestmentProductBalance1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_Branches
-- [sp_InvestmentProductBalance1] '143570C6-48BB-E811-A814-000C29142092','12/10/2018'
create PROCEDURE [dbo].[sp_InvestmentProductBalance1] 
	-- Add the parameters for the stored procedure here
	--@ProductID varchar(100),
	@Branchid varchar(100), 
	--@StartDate DateTime ,
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With InvestmentProductBalances(AccountNo,Reference1,Reference2,Reference3,AccountName,Branch,Balance,Product,ProductName,SerialNumber)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		 dbo.swiftfin_branches.Description,SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,dbo.swiftfin_InvestmentProducts.Id,dbo.swiftfin_InvestmentProducts.Description, vw_CustomerAccounts.SerialNumber

		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId inner join
								 dbo.swiftfin_journals on dbo.swiftfin_JournalEntries.JournalId=dbo.swiftfin_journals.id inner join
								 dbo.swiftfin_branches on dbo.swiftfin_journals.branchid=dbo.swiftfin_branches.id   


		WHERE        (/*dbo.swiftfin_InvestmentProducts.id in (@ProductID) and */ dbo.swiftfin_branches.id=@Branchid and dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount, dbo.swiftfin_branches.Description,dbo.swiftfin_InvestmentProducts.Id,dbo.swiftfin_InvestmentProducts.Description, vw_Customeraccounts.SerialNumber
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,branch,SUM(Balance) AS Balance,Product,ProductName, SerialNumber
	FROM InvestmentProductBalances
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,branch,Product,ProductName, SerialNumber having SUM(Balance) <>0
END
GO
/****** Object:  StoredProcedure [dbo].[sp_InvestmentProductBalanceSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_InvestmentProducts
--sp_InvestmentProductBalanceSummary '789BA4B0-85B7-C439-A2C2-08D264EC6D36','10/16/2015'
CREATE PROCEDURE [dbo].[sp_InvestmentProductBalanceSummary] 
	-- Add the parameters for the stored procedure here
	
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) as Amount,  dbo.swiftfin_InvestmentProducts.Description
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
where  dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
GROUP BY  dbo.swiftfin_InvestmentProducts.Description
END







GO
/****** Object:  StoredProcedure [dbo].[sp_InvestmentProductBalanceWithCollateral]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
--select * from swiftfin_LoanGuarantors
---select * from swiftfin_InvestmentProducts
----sp_InvestmentProductBalanceWithCollateral '8B392C2A-6FB8-CB05-A450-08D1AD47AEEE','07/31/2015'
CREATE PROCEDURE [dbo].[sp_InvestmentProductBalanceWithCollateral] 
	-- Add the parameters for the stored procedure here
	@ProductID varchar(100), 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With InvestmentProductBalances(CustomerID,AccountNo,Reference1,Reference2,Reference3,AccountName,Balance)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.CustomerId,dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in (@ProductID) and dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.CustomerId
	)
	SELECT CustomerID,
	isnull((SELECT top 1 CaseNumber FROM  dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id where swiftfin_loancases.CustomerId=InvestmentProductBalances.customerid and swiftfin_LoanProducts.LoanRegistration_LoanProductSection='47803' and DisbursedDate is not null order by DisbursedDate desc),0) as [Loan Number],
	isnull((select sum(CommittedShares) from swiftfin_LoanGuarantors where CustomerId=InvestmentProductBalances.customerid and Status=0),0) as [Guarantee Amount],
	AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance 
	into #temp1 FROM InvestmentProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,CustomerID having SUM(Balance) <>0
	
	select *,case when [Guarantee Amount]>Balance then balance else [Guarantee Amount] end as [Guarantee Amount1]  from #temp1 
END









GO
/****** Object:  StoredProcedure [dbo].[sp_InvestmentProductBalanceWithGrowerNumbers]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
CREATE PROCEDURE [dbo].[sp_InvestmentProductBalanceWithGrowerNumbers] 
	-- Add the parameters for the stored procedure here
	@ProductID varchar(100), 
	@EndDate DateTime ,
	@BuyingCenterCode varchar(5)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	declare 
	@LocalProductID varchar(100)=@ProductID, 
	@LocalEndDate DateTime =@EndDate,
	@LocalBuyingCenterCode varchar(5)=	@BuyingCenterCode ;
    -- Insert statements for procedure here
	With InvestmentProductBalances(AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,GrowerNo,PayrollNumbers)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,SUBSTRING(Individual_PayrollNumbers,PATINDEX('%'+@LocalBuyingCenterCode+'%',vw_CustomerAccounts.Individual_PayrollNumbers ),9),dbo.vw_CustomerAccounts.Individual_PayrollNumbers
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in (@LocalProductID) and dbo.swiftfin_JournalEntries.CreatedDate<=@LocalEndDate) and dbo.vw_CustomerAccounts.Individual_PayrollNumbers like '%'+@LocalBuyingCenterCode+'%'
		GROUP BY dbo.vw_CustomerAccounts.Reference1,Individual_PayrollNumbers,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,GrowerNo,PayrollNumbers 
	FROM InvestmentProductBalances where left(GrowerNo,5)=@BuyingCenterCode
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,GrowerNo,PayrollNumbers having SUM(Balance) <>0 order by GrowerNo
END







GO
/****** Object:  StoredProcedure [dbo].[sp_InvestmentProductBalanceWithIncreament]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---select * from swiftfin_InvestmentProducts
--sp_InvestmentProductBalanceWithIncreament '76ACE21D-C656-C0F1-67C6-08D1AD47AEEF','05/31/2015'
CREATE PROCEDURE [dbo].[sp_InvestmentProductBalanceWithIncreament] 
	-- Add the parameters for the stored procedure here
	@ProductID varchar(100), 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	Declare @StartDate DateTime
	set @StartDate=(SELECT DATEADD(month, DATEDIFF(month, 0, @EndDate), 0))
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With InvestmentProductBalances(id,Reference1,Reference2,Reference3,AccountName,Balance)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.id,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName,
		SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_InvestmentProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_InvestmentProducts.id in (@ProductID) and dbo.swiftfin_JournalEntries.CreatedDate<=@StartDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.Id
	)
	SELECT id,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,
	isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=InvestmentProductBalances.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_InvestmentProducts where id=@ProductID) and CreatedDate between @StartDate and @EndDate),0) as Increament,
SUM(Balance) +isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=InvestmentProductBalances.id and ChartOfAccountId in (select ChartOfAccountId from swiftfin_InvestmentProducts where id=@ProductID) and CreatedDate between @StartDate and @EndDate),0) as NewBalance
		
	FROM InvestmentProductBalances 
	Group By id,Reference1,Reference2,Reference3,AccountName having SUM(Balance) <>0
END

GO
/****** Object:  StoredProcedure [dbo].[sp_InvestmentProductsBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---sp_InvestmentProductsBalances '04/01/2014','>',1000000
CREATE PROCEDURE [dbo].[sp_InvestmentProductsBalances] 
	@Enddate Datetime,
	@Operator char(2),
	@OperatorValue float
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.AccountName, SUM(dbo.swiftfin_JournalEntries.Amount) 
							 AS Balance

	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
	where dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate    
	GROUP BY dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.AccountName
	HAVING
	 ((@Operator = '>' and SUM(dbo.swiftfin_JournalEntries.Amount)  > @OperatorValue)
		or (@Operator = '<' and SUM(dbo.swiftfin_JournalEntries.Amount) < @OperatorValue)
		or (@Operator = '<>' and SUM(dbo.swiftfin_JournalEntries.Amount) != @OperatorValue)
		or (@Operator = '>=' and SUM(dbo.swiftfin_JournalEntries.Amount) >= @OperatorValue)
		or (@Operator = '<=' and SUM(dbo.swiftfin_JournalEntries.Amount) <= @OperatorValue)
		or (@Operator = '=' and SUM(dbo.swiftfin_JournalEntries.Amount) = @OperatorValue)
		)

END










GO
/****** Object:  StoredProcedure [dbo].[sp_ItemRegister]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Gilbert
-- Create date: 
-- Description:	
-- =============================================
Create PROCEDURE [dbo].[sp_ItemRegister]
@StartDate datetime,  
@EndDate datetime
 as
 BEGIN
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	
SELECT        dbo.swiftfin_ItemRegister.Code,dbo.swiftfin_ItemRegister.Description, dbo.swiftfin_ItemRegister.EstimatedUnitCost, dbo.swiftfin_ItemRegister.ItemType, dbo.swiftfin_ItemRegister.Remarks, 
dbo.swiftfin_ItemRegister.ReorderPoint, dbo.swiftfin_ItemRegister.MaximumOrder, dbo.swiftfin_ItemRegister.UnitsPerPack, dbo.swiftfin_ItemRegister.MonthlyDemand, dbo.swiftfin_ItemRegister.CreatedBy, dbo.swiftfin_ItemRegister.CreatedDate
FROM            dbo.swiftfin_ItemRegister

where dbo.swiftfin_ItemRegister.CreatedDate between @StartDate and @EndDate
end 





GO
/****** Object:  StoredProcedure [dbo].[sp_JournalReversalBatch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_JournalReversalBatch]
@StartDate DateTime,
@EndDate DateTime,
@BatchID UniqueIdentifier

AS 
SELECT           dbo.swiftfin_JournalReversalBatches.Id, dbo.swiftfin_JournalReversalBatches.BranchId, dbo.swiftfin_JournalReversalBatches.BatchNumber,
                  CASE dbo.swiftfin_JournalReversalBatches.Status when 1 then 'pending' when 2 then 'Posted' when 4 then 'suspended' when 8 then 'Audited' end as BatchStatus, 
                         dbo.swiftfin_JournalReversalBatches.AuditedBy, dbo.swiftfin_JournalReversalBatches.AuditRemarks, dbo.swiftfin_JournalReversalBatches.AuditedDate, dbo.swiftfin_JournalReversalBatches.AuthorizedBy, 
                         dbo.swiftfin_JournalReversalBatches.AuthorizationRemarks, dbo.swiftfin_JournalReversalBatches.AuthorizedDate, dbo.swiftfin_JournalReversalBatches.CreatedBy, dbo.swiftfin_JournalReversalBatches.CreatedDate, 
                         dbo.swiftfin_JournalReversalBatches.Remarks, dbo.swiftfin_Branches.Description

FROM            dbo.swiftfin_JournalReversalBatches INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_JournalReversalBatches.BranchId = dbo.swiftfin_Branches.Id
WHERE @BatchID= dbo.swiftfin_JournalReversalBatches.Id and dbo.swiftfin_JournalReversalBatches.CreatedDate BETWEEN @StartDate AND @EndDate+1







GO
/****** Object:  StoredProcedure [dbo].[sp_JournalReversalBatchEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_JournalReversalBatchEntries]
@JournalBatchId uniqueidentifier
AS

SELECT        dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_JournalReversalBatchEntries.Remarks, dbo.swiftfin_Journals.TotalValue,
          CASE dbo.swiftfin_JournalReversalBatchEntries.Status  when 1 then 'pending' when 2 then 'Posted' when 4 then 'suspended'end as BatchEntryStatus,
                         dbo.swiftfin_JournalReversalBatchEntries.CreatedBy, dbo.swiftfin_JournalReversalBatchEntries.CreatedDate
FROM            dbo.swiftfin_JournalReversalBatches INNER JOIN
                         dbo.swiftfin_JournalReversalBatchEntries ON dbo.swiftfin_JournalReversalBatches.Id = dbo.swiftfin_JournalReversalBatchEntries.JournalReversalBatchId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalReversalBatchEntries.JournalId = dbo.swiftfin_Journals.Id
						 WHERE @JournalBatchId=dbo.swiftfin_JournalReversalBatchEntries.JournalReversalBatchId




GO
/****** Object:  StoredProcedure [dbo].[sp_JournalVoucherEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:  Centrino
-- Create date: 14.06.2014
-- Description: JournalVourcherEntries
-- =============================================
---sp_JournalVoucherEntries '08/01/2018','08/30/2018'

CREATE PROCEDURE [dbo].[sp_JournalVoucherEntries] 
 -- Add the parameters for the stored procedure here
 @StartDate DateTime  , 
 @EndDate DateTime 
AS
BEGIN
--select * from swiftfin_Enumerations where [key] like '%journal%'
--select * from swiftfin_Journalvouchers
--select * from dbo.swiftfin_JournalVoucherEntries
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

 SELECT dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_JournalVouchers.VoucherNumber, 
        CASE dbo.swiftfin_JournalVouchers.Status WHEN 1 THEN 'Pending' WHEN 2 THEN 'Posted' WHEN 4 THEN 'Rejected' END AS Status, 
        dbo.swiftfin_JournalVouchers.AuthorizedBy, dbo.swiftfin_JournalVouchers.AuthorizationRemarks, dbo.swiftfin_JournalVouchers.AuthorizedDate, 
        dbo.swiftfin_JournalVouchers.CreatedBy, dbo.swiftfin_JournalVouchers.CreatedDate, 
        CASE dbo.swiftfin_JournalVouchers.Type WHEN 0 THEN 'Debit G/L Account' WHEN 1 THEN 'Credit G/L Account' WHEN 2 THEN 'Debit Customer Account' WHEN
         3 THEN 'Credit Customer Account' END AS Type,dbo.swiftfin_JournalVouchers.TotalValue, 
        dbo.swiftfin_ChartOfAccounts.AccountCode, 
        dbo.swiftfin_ChartOfAccounts.AccountName, vw_CustomerAccounts_1.FullAccount, vw_CustomerAccounts_1.FullName AS FullAccountName, 
       dbo.swiftfin_JournalVoucherEntries.CreatedDate AS JournalVoucherEntriesCreatedDate, dbo.swiftfin_JournalVoucherEntries.Amount as JVAmount,
		  swiftfin_ChartOfAccounts_1.AccountCode AS JournalVoucherEntriesAccountCode, 
        swiftfin_ChartOfAccounts_1.AccountName AS JournalVoucherEntriesAccountName, dbo.vw_CustomerAccounts.FullAccount AS JournalVoucherEntriesFullAccount, 
        dbo.vw_CustomerAccounts.FullName AS JournalVoucherEntriesFullName,dbo.vw_CustomerAccounts.Reference3 as PersonalFileNo,dbo.swiftfin_JournalVouchers.Reference,
		iif(dbo.swiftfin_JournalVoucherEntries.CustomerAccountId is Null,CASE dbo.swiftfin_JournalVouchers.Type WHEN 1 THEN 'Debit G/L Account' WHEN 0 THEN 'Credit G/L Account' 
		WHEN  3 THEN 'Debit G/L Account' WHEN 2 THEN 'Credit G/L Account'END,
		CASE dbo.swiftfin_JournalVouchers.Type WHEN  3 THEN 'Debit Customer Account' WHEN
         2 THEN 'Credit Customer Account' WHEN 1 THEN 'Debit Customer Account' WHEN 0 THEN 'Credit Customer Account'END) as JournalEntriesType
 FROM            dbo.swiftfin_JournalVouchers INNER JOIN
        dbo.swiftfin_JournalVoucherEntries ON dbo.swiftfin_JournalVouchers.Id = dbo.swiftfin_JournalVoucherEntries.JournalVoucherId INNER JOIN
        dbo.swiftfin_Branches ON dbo.swiftfin_JournalVouchers.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
        dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalVouchers.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
        dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalVoucherEntries.ChartOfAccountId = swiftfin_ChartOfAccounts_1.Id LEFT OUTER JOIN
        dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalVoucherEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id LEFT OUTER JOIN
        dbo.vw_CustomerAccounts AS vw_CustomerAccounts_1 ON dbo.swiftfin_JournalVouchers.CustomerAccountId = vw_CustomerAccounts_1.Id
 WHERE dbo.swiftfin_JournalVouchers.CreatedDate BETWEEN @StartDate and @EndDate

END
--select * from vw_CustomerAccounts



GO
/****** Object:  StoredProcedure [dbo].[sp_JournalVoucherListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 14.06.2014
-- Description:	JournalVouchersListing
-- =============================================
CREATE PROCEDURE [dbo].[sp_JournalVoucherListing] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime  , 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	SET NOCOUNT ON;
	SELECT        VoucherNumber
	FROM            swiftfin_JournalVouchers
	WHERE        (CreatedDate BETWEEN @StartDate AND @EndDate)
    -- Insert statements for procedure here
END







GO
/****** Object:  StoredProcedure [dbo].[sp_LoanAnalysisDeferred]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



--[sp_LoanAnalysisDeferred] '12/07/2018','S07'
---select * from swiftfin_loanproducts
create procedure [dbo].[sp_LoanAnalysisDeferred] (@EndDate DateTime,@ttype char(3))
as
declare @code char(3)
set @Code= case when @ttype='S01' THEN 1 when @ttype='S02' then 2 when @ttype='S03' then 3 when @ttype='S04' then 4  when @ttype='S05' then 5 when @ttype='S06' then 6 
  when @ttype='S07' then 7 when @ttype='S08' then 8 when @ttype='S09' then 9 when @ttype='S010' then 10 when @ttype='S011' then 11 when @ttype='S012' then 12
   when @ttype='S013' then 13 when @ttype='S014' then 14 when @ttype='S015' then 15 when @ttype='S016' then 16 when @ttype='S017' then 17 when @ttype='S018' then 18
   when @ttype='S019' then 19 when @ttype='S020' then 20 when @ttype='S021' then 21 when @ttype='S022' then 22  when @ttype='S023' then 23 end;

With CTELoanAnalysisDeferred (FullAccountNo,Fosa_acno,Name,Empno,Balance,Month,Deferred)
as
(
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,0 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount) AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
						 dbo.swiftfin_journals on dbo.swiftfin_JournalEntries.JournalId=dbo.swiftfin_journals.id inner join
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_loanproducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId 
						 Where dbo.swiftfin_LoanProducts.CODE= @code 
						 and dbo.swiftfin_journals.TransactionCode=76 
 
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,1 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*12/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
						 dbo.swiftfin_journals on dbo.swiftfin_JournalEntries.JournalId=dbo.swiftfin_journals.id inner join
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=1 and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code
						 and dbo.swiftfin_journals.TransactionCode<>21 
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,2 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*11/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=2  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,3 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*10/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=3  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,4 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*09/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=4  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,5 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*8/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=5  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate)  AND dbo.swiftfin_LoanProducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,6 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*7/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=6  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,7 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*6/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=7  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code 
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,8 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*5/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=8  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,9 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*4/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=9  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code 
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,10 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*3/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=10  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,11 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*2/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=11  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
union
SELECT      dbo.vw_CustomerAccounts.FullAccount,  dbo.vw_CustomerAccounts.Reference1 as fosa_Acno, dbo.vw_CustomerAccounts.FullName as Name,dbo.vw_CustomerAccounts.Reference3 AS EMPNO, 
SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance,12 AS Month,SUM(dbo.swiftfin_JournalEntries.Amount)*1/12 AS Deferred 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 Where month(dbo.swiftfin_JournalEntries.CreatedDate)=12  and year(dbo.swiftfin_JournalEntries.CreatedDate)=Year(@EndDate) AND dbo.swiftfin_LoanProducts.CODE=@code 
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Reference3,dbo.vw_CustomerAccounts.FullAccount
), 
 CTEResults (FullAccountNo,Name,Empno,BroughtFWD,January,February,March,April,May,June,July,August,September,October,November,December)
as
(
select FullAccountNo,Name,Fosa_acno,
case when month=0 then sum(balance) else 0 end as BroughtFWD,
case when Month=1 then isnull(sum(Deferred),0) else 0  end as January,
case when Month=2 then sum(Deferred) else 0 end as February,
case when Month=3 then sum(Deferred) else 0 end as March,
case when Month=4 then sum(Deferred) else 0  end as April,
case when Month=5 then sum(Deferred) else 0 end as May,
case when Month=6 then sum(Deferred) else 0 end as June,
case when Month=7 then sum(Deferred) else 0 end as July,
case when Month=8 then sum(Deferred) else 0 end as August,
case when Month=9 then sum(Deferred) else 0 end as September,
case when Month=10 then sum(Deferred) else 0  end as October,
case when Month=11 then sum(Deferred) else 0 end as November,
case when Month=12 then sum(Deferred) else 0 end as December
 from CTELoanAnalysisDeferred group by  FullAccountNo,Name,fosa_acno,month 
 )
select FullAccountNo,Name,Empno as Fosa_acno, sum(BroughtFWD) as BalanceBF, 
sum(January) as January,
sum(February) as February, 
Sum(March) as March,
sum(April) as April, 
sum(May) as May, 
sum(June) as June, 
sum(July) as July, 
sum(August) as August, 
sum(September) as September,
sum(October) as October,
sum(November) as November,
sum(December) as December,
--sum(BroughtFWD+January+February+March+April+May+June+July+August+September+October+November+December) as Qualified,
--@ttype as type



  iif(sum(BroughtFWD+January+February+March+April+May+June+July+August+September+October+November+December)<0,0,

 sum(BroughtFWD+January+February+March+April+May+June+July+August+September+October+November+December) ) as AmountDeferred,
@ttype as type
 from CTEResults group by FullAccountNo,Name,Empno order by Empno





GO
/****** Object:  StoredProcedure [dbo].[Sp_LoanAnnex1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create Procedure [dbo].[Sp_LoanAnnex1] 
as
SELECT        (dbo.swiftfin_LoanCases.CaseNumber) as LoanNumber, 
(dbo.vw_customerAccountsEmployer.FullAccount) as MemberNumber , 
(dbo.vw_customerAccountsEmployer.FullName) as MemberName, 
dbo.vw_customerAccountsEmployer.EmployerName, 
(dbo.swiftfin_LoanProducts.Description) as LoanType, 
(dbo.swiftfin_LoanProducts.LoanInterest_CalculationMode) as LoanArmotizationType, 
(dbo.swiftfin_StandingOrders.Schedule_Frequency) as LoanInstalments , 
(dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate) as AnnualLoanRate, 
(dbo.swiftfin_LoanProducts.LoanRegistration_PaymentFrequencyPerYear) as LoanFrequency, 
(dbo.swiftfin_LoanCases.DisbursedDate) as DateLoanDisbursed, 
(dbo.swiftfin_LoanCases.DisbursedAmount) as LoanAmount,
(dbo.swiftfin_StandingOrders.Duration_EndDate) as LoanMaturity, 
(dbo.swiftfin_StandingOrders.Duration_StartDate) as Loan_First_Pmt_Date,
(dbo.swiftfin_StandingOrders.Principal) as Latest_Amount_Paid,(dbo.swiftfin_StandingOrders.Schedule_ActualRunDate) as Latest_Payment_Date,
0 as LoanBalance,0 as Days_In_Arrears,0 as Loan_Classification

FROM            dbo.swiftfin_StandingOrders INNER JOIN
                         dbo.vw_customerAccountsEmployer ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = dbo.vw_customerAccountsEmployer.Id INNER JOIN
                         dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id ON dbo.vw_customerAccountsEmployer.CustomerId = dbo.swiftfin_LoanCases.CustomerId




GO
/****** Object:  StoredProcedure [dbo].[sp_LoanBatches]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec sp_LoanBatches '04/16/2016','04/21/2016'

CREATE procedure [dbo].[sp_LoanBatches]
@Status int,
@startdate datetime,
@enddate datetime,
@Branch uniqueidentifier
--select * from dbo.swiftfin_enumerations where [key] like '%batchstatus%'
as
SELECT DISTINCT 
                        case  dbo.swiftfin_LoanDisbursementBatches.Status when 1 then 'pending' when 2 then 'Posted' when 4 then 'suspended' when 8 then 'Audited' end as Status, dbo.swiftfin_Branches.Description as Branch, dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_LoanProducts.Description AS LoanProduct,  dbo.swiftfin_LoanPurposes.Description AS LoanPurpose ,dbo.swiftfin_LoanCases.ApprovedAmount as ApprovedAmount,dbo.swiftfin_LoanCases.CaseNumber, 
                        dbo.swiftfin_LoanDisbursementBatches.BatchNumber,dbo.vw_CustomerAccounts.Reference3 as PersonalFileNumber,swiftfin_LoanDisbursementBatches.CreatedDate as createddate, dbo.swiftfin_LoanDisbursementBatches.CreatedBy As createdby
FROM            dbo.swiftfin_LoanDisbursementBatches INNER JOIN
                         dbo.swiftfin_LoanDisbursementBatchEntries ON dbo.swiftfin_LoanDisbursementBatches.Id = dbo.swiftfin_LoanDisbursementBatchEntries.LoanDisbursementBatchId INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanDisbursementBatches.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_LoanDisbursementBatchEntries.LoanCaseId = dbo.swiftfin_LoanCases.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_LoanCases.CustomerId = dbo.vw_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
 where   @Branch=dbo.swiftfin_LoanDisbursementBatches.BranchId and dbo.swiftfin_LoanDisbursementBatches.Status=@Status  and  swiftfin_LoanDisbursementBatches.CreatedDate between @startdate and @enddate 




GO
/****** Object:  StoredProcedure [dbo].[sp_LoanbyBatches]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec sp_LoanBatches '05/16/2016','04/21/2016'

CREATE procedure [dbo].[sp_LoanbyBatches]
@StartDate Datetime,
@EndDate DateTime,
@BatchNo uniqueidentifier

as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT DISTINCT 
                        case  dbo.swiftfin_LoanDisbursementBatches.Status when 1 then 'pending' when 2 then 'Posted' when 4 then 'suspended' when 8 then 'Audited' end as Status, dbo.swiftfin_Branches.Description as Branch, dbo.vw_CustomerAccounts.FullName, 
						dbo.swiftfin_LoanProducts.Description AS LoanProduct,  dbo.swiftfin_LoanPurposes.Description AS LoanPurpose ,dbo.swiftfin_LoanCases.ApprovedAmount as ApprovedAmount,dbo.swiftfin_LoanCases.DisbursedAmount AS AmountDisbursed, dbo.swiftfin_LoanCases.CaseNumber, 
                        dbo.swiftfin_LoanDisbursementBatches.BatchNumber,dbo.vw_CustomerAccounts.Reference3 as PersonalFileNumber,swiftfin_LoanDisbursementBatches.CreatedDate as createddate, dbo.swiftfin_LoanDisbursementBatches.CreatedBy As createdby
FROM            dbo.swiftfin_LoanDisbursementBatches INNER JOIN
                         dbo.swiftfin_LoanDisbursementBatchEntries ON dbo.swiftfin_LoanDisbursementBatches.Id = dbo.swiftfin_LoanDisbursementBatchEntries.LoanDisbursementBatchId INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanDisbursementBatches.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_LoanDisbursementBatchEntries.LoanCaseId = dbo.swiftfin_LoanCases.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_LoanCases.CustomerId = dbo.vw_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
 where @BatchNo=dbo.swiftfin_LoanDisbursementBatches.Id and swiftfin_LoanDisbursementBatches.CreatedDate  BETWEEN @StartDate AND @EndDate


  




GO
/****** Object:  StoredProcedure [dbo].[sp_Loandisbursed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_LoanDisbursed '06/01/2018','06/19/2018'
CREATE PROC [dbo].[sp_Loandisbursed]
@StartDate DateTime,@EndDate DateTime

as

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


WITH LoanCTE(Name,Age,Gender,YOB,AccountNo,LoanProduct,AmountApplied,AmountApproved,DisbursedAmount,PrincipleOffset,InterestOffset,CreatedDate,MonthlyPrinciple,MonthlyInterest,Employer,CostCenter,LoanType)
AS

(
SELECT  Distinct      dbo.vw_CustomerAccounts.FullName, DATEDIFF(YY,dbo.vw_CustomerAccounts.Individual_BirthDate,GETDATE()),
case dbo.vw_CustomerAccounts.Individual_Gender when 1 then 'Male' when 2 then 'Female' else 'Unknown' end, year(dbo.vw_CustomerAccounts.Individual_BirthDate),
 dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_LoanProducts.id, dbo.swiftfin_LoanCases.AmountApplied,
 dbo.swiftfin_LoanCases.ApprovedAmount,dbo.swiftfin_LoanCases.DisbursedAmount,
 isnull(sum(dbo.swiftfin_AttachedLoans.PrincipalBalance),0),isnull(sum(dbo.swiftfin_AttachedLoans.InterestBalance),0),
   dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.ApprovedPrincipalPayment, dbo.swiftfin_LoanCases.ApprovedInterestPayment,dbo.vw_CustomerAccounts.EmployerDescription,dbo.swiftfin_ChartOfAccounts.CostCenterId,dbo.swiftfin_LoanProducts.Description
 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                                                 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id LEFT OUTER JOIN
                         dbo.swiftfin_AttachedLoans ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_AttachedLoans.CustomerAccountId AND dbo.swiftfin_LoanCases.Id = dbo.swiftfin_AttachedLoans.LoanCaseId

						 where dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.Status='48829'

						 group by dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_ChartOfAccounts.CostCenterId,dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_LoanProducts.id, 
						 dbo.swiftfin_LoanCases.AmountApplied,
                      dbo.swiftfin_LoanCases.ApprovedAmount,dbo.swiftfin_LoanCases.DisbursedAmount,vw_CustomerAccounts.Individual_BirthDate,
   dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.ApprovedPrincipalPayment, dbo.swiftfin_LoanCases.ApprovedInterestPayment,dbo.vw_CustomerAccounts.Individual_Gender,
   dbo.vw_CustomerAccounts.EmployerDescription,dbo.swiftfin_LoanProducts.Description
						 )
						 Select Name,AccountNo,Age,YOB,Gender,LoanProduct,AmountApplied,AmountApproved,DisbursedAmount,
						PrincipleOffset,InterestOffset,CreatedDate,MonthlyPrinciple,MonthlyInterest,
						 AmountApproved-(PrincipleOffset+InterestOffset) as NetBal,Employer,CostCenter,LoanType
						 from LoanCTE 

						group by Name,Age,YOB,Gender,CostCenter,AccountNo,LoanProduct,AmountApplied,AmountApproved,DisbursedAmount,PrincipleOffset,InterestOffset ,
						CreatedDate,MonthlyPrinciple,MonthlyInterest,Employer,LoanType
						--select * from swiftfin_LoanCases where CustomerId='8F9C3FC2-3B55-E811-AF66-48BA4E3DB51F'
						--select left(description,3) from swiftfin_loanproducts
GO
/****** Object:  StoredProcedure [dbo].[sp_LoandisbursedOld]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Men & Women>
-- Create date: <28 Nov 2016,,>
-- Description:	<sp_Insider_Newloans,,>
-- =============================================
--exec sp_Loandisbursed '05/01/2016','06/30/2016'
create PROCEDURE [dbo].[sp_LoandisbursedOld] 
	-- Add the parameters for the stored procedure here
@StartDate DateTime,
@EndDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=1

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union 
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=2

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection

union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=3

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection

union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=4

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection

union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=5

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=6

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=7

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=8

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=9

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=10

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection

union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=11

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=12

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=13

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=14

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=15

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=16

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=17

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=18

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=19

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=20

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=21

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=22

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=23

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=24

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=25

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Sectionn
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=26

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=27

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=28

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=29

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=30

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=31

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=32

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=33

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=34

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection

union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=35

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=36

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection

union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=37

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection

union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=38

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection

union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=39

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=40

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=41

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=42

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=43

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=44

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=45

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=46

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=47

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=48

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=49

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
union
SELECT        sum( dbo.swiftfin_LoanCases.DisbursedAmount)as Amount, dbo.swiftfin_LoanProducts.Description,count(dbo.vw_CustomerAccounts.reference1) as Number,case when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0 then 'Fosa' when dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=1 then 'Bosa' end as Section
                        
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_Customers.Id = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.vw_CustomerAccounts.CustomerId
WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount > 0) AND (dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode = 1) AND (dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductCode = 1)
and  dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate+1	and  dbo.swiftfin_LoanProducts.Code=50

Group by   dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection
END




GO
/****** Object:  StoredProcedure [dbo].[sp_Loanee_guarantors]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_Customers where Reference1='0101-003-27286'
--select * from swiftfin_Customers where id='4C7531C7-0D2D-E811-83F4-18CF5E65399'

Create PROCEDURE [dbo].[sp_Loanee_guarantors]
@customerid varchar(50)
-- Exec sp_Loanee_guarantors 'D72864C7-0D2D-E811-83F4-18CF5E653998'
as
begin

SELECT        swiftfin_LoanGuarantors.TotalShares, swiftfin_LoanGuarantors.CommittedShares, swiftfin_LoanGuarantors.AmountGuaranteed, swiftfin_LoanGuarantors.AmountPledged, swiftfin_LoanGuarantors.AppraisalFactor, 
                         swiftfin_LoanProducts.Description,
						 (select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=swiftfin_CustomerAccounts.id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId)*-1 LoanBalance
						 ,(select top 1 AmountGuaranteed from swiftfin_LoanGuarantors where LoaneeCustomerId=@customerid and LoanProductId=swiftfin_LoanProducts.id) Single
						 ,(select sum(AmountGuaranteed) from swiftfin_LoanGuarantors where LoaneeCustomerId=@customerid and LoanProductId=swiftfin_LoanProducts.id and swiftfin_LoanGuarantors.Status=0) Total
						 ,round(((select top 1 AmountGuaranteed from swiftfin_LoanGuarantors where LoaneeCustomerId=@customerid and LoanProductId=swiftfin_LoanProducts.id) /
						 (select sum(AmountGuaranteed) from swiftfin_LoanGuarantors where LoaneeCustomerId=@customerid and LoanProductId=swiftfin_LoanProducts.id))*
						 (select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=swiftfin_CustomerAccounts.id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId)*-1,0) GuaranteedPercentage,
						  vw_Customers.FullName, vw_Customers.Reference1


FROM            swiftfin_LoanGuarantors INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanGuarantors.LoanProductId = swiftfin_LoanProducts.Id INNER JOIN
                         swiftfin_CustomerAccounts ON swiftfin_LoanGuarantors.LoaneeCustomerId = swiftfin_CustomerAccounts.CustomerId AND swiftfin_LoanGuarantors.LoanProductId = swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId INNER JOIN
                         vw_Customers ON swiftfin_LoanGuarantors.CustomerId = vw_Customers.Id
WHERE        (swiftfin_LoanGuarantors.LoaneeCustomerId = @customerid) and dbo.swiftfin_LoanGuarantors.status=0
order by swiftfin_LoanProducts.code

end
GO
/****** Object:  StoredProcedure [dbo].[sp_LoanForm]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:  Centrino
-- Create date: 13.06.2014
-- Description: LoanForm
-- =============================================
CREATE PROCEDURE [dbo].[sp_LoanForm] 
 -- Add the parameters for the stored procedure here
 @CaseNo int
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

    -- Insert statements for procedure here
 SELECT        dbo.swiftfin_LoanCases.id,dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
                         dbo.swiftfin_LoanCases.CaseNumber, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
                         CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
                          WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
                         CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
                          REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers AS PersonalFileNumber, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
                         dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
                         dbo.swiftfin_LoanCases.LoanInterest_AnnualPercentageRate/12*.01 as LoanInterest_AnnualPercentageRate,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths,dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
                         dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
                         dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
                         dbo.swiftfin_LoanCases.DisbursedAmount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, dbo.swiftfin_LoanCases.TotalPaybackAmount, 
                         dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, dbo.swiftfin_LoanCases.TotalLoansBalance, 
                         CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
                          'Unknown' END AS LoanInterest_CalculationMode, 
                         CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
                         dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, 
                         dbo.swiftfin_LoanCases.LoanProductId, 
                         CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection
 FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
 WHERE  swiftfin_LoanCases.CaseNumber=@CaseNo
END





GO
/****** Object:  StoredProcedure [dbo].[sp_LoaningMonthlySummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---select DisbursedDate,AppraisedAmount from swiftfin_LoanCases
--select * from swiftfin_postingperiods

--select AppraisedAmount,DisbursedDate from swiftfin_LoanCases
--select startdate from dbo.GetMonthList(getdate(),1) where monthnumber=4
---sp_LoanSummary '01/01/2014'
---select DisbursedDate,AppraisedAmount from swiftfin_LoanCases
---sp_LoaningMonthlySummary '6D1AC584-032D-E811-80D1-F40343552CF8','1','AppraisedAmount','DisbursedDate'
CREATE PROCEDURE [dbo].[sp_LoaningMonthlySummary] 
	-- Add the parameters for the stored procedure here
	(
	@PostingPeriod VARCHAR(50)='6D1AC584-032D-E811-80D1-F40343552CF8',
	@Section int='1',
	@AmountColumn as Varchar(50)='AppraisedAmount',
	@DateColumn as Varchar(50)='DisbursedDate'
	)
AS
	DECLARE

	@SQLtext1 NVARCHAR(3000),
	@SQLtext2 NVARCHAR(3000),

	@Desc1 varchar(10)='Backoffice',
	@Desc2 varchar(10)='FrontOffice'

BEGIN

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	set @SQLtext1='
DECLARE 
	@StartDate Datetime
	set @StartDate=(select top 1 Duration_StartDate from swiftfin_PostingPeriods where id='''+@PostingPeriod+''')

	select Description,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+' 
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=1) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=1)
	),0) as January,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=2) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=2)
	),0) as Febuary,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=3) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=3)
	),0) as March,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=4) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=4)
	),0) as April,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=5) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=5)
	),0) as May,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=6) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=6)
	),0) as June,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=7) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=7)
	),0) as July,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=8) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=8)
	),0) as August,'

	set @SQLtext2='
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=9) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=9)
	),0) as September,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=10) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=10)
	),0) as October,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=11) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=11)
	),0) as November,
	isnull((
		select sum('+@AmountColumn+') from swiftfin_LoanCases 
		where LoanProductId=dbo.swiftfin_LoanProducts.id AND '+@DateColumn+'  
		between (select StartDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=12) and (select EndDate from dbo.GetMonthList(@StartDate,1) where MonthNumber=12)
	),0) as December,
	LoanRegistration_LoanProductSection as Section
	 from swiftfin_LoanProducts 
	 WHERE LoanRegistration_LoanProductSection in ('+@Section+')'

declare @CarrierList table (Description varchar(50), January numeric(18,2), February numeric(18,2),March numeric(18,2),April numeric(18,2),May numeric(18,2),June numeric(18,2),
							July numeric(18,2),August numeric(18,2),September numeric(18,2),October numeric(18,2),November numeric(18,2),December numeric(18,2),Section int);
set @SQLtext1=ltrim(ltrim(@SQLtext1))
set @SQLtext2=ltrim(ltrim(@SQLtext2))

insert @CarrierList exec(@SQLtext1+@SQLtext2)
select Description,January,February,March,April,May,June,July,August,September,October,November,December,
CASE WHEN Section=1 THEN 'BackOffice' WHEN Section=0 THEN 'FrontOffice' END AS Section from @CarrierList

END











GO
/****** Object:  StoredProcedure [dbo].[sp_LoaningReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec [sp_LoaningReport] '1/1/2015','12/31/2016'
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	LoanDisbursement
-- =============================================
CREATE PROCEDURE [dbo].[sp_LoaningReport] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime 
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate,dbo.swiftfin_Customers.Reference1,
							 CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Individual_PayrollNumbers AS PersonalFileNumber, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanCases.ApprovedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.DisbursedDate is not null
END






GO
/****** Object:  StoredProcedure [dbo].[sp_LoaningReportDisbursed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	LoanDisbursement
-- =============================================
CREATE PROCEDURE [dbo].[sp_LoaningReportDisbursed] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime 
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '11'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference1 AS PersonalFileNumber, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, 
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate 
END







GO
/****** Object:  StoredProcedure [dbo].[sp_LoaningReportInsurance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	LoanDisbursement
-- =============================================
CREATE PROCEDURE [dbo].[sp_LoaningReportInsurance] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime 
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							  CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Individual_PayrollNumbers AS PersonalFileNumber, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, dbo.swiftfin_LoanCases.BatchNumber, 
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanCases.AuditedDate BETWEEN @StartDate and @EndDate
END




GO
/****** Object:  StoredProcedure [dbo].[Sp_LoanIssuedByRangeWithCurrentBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_loanproducts
---exec Sp_LoanIssuedByRangeWithCurrentBalances '982AFBA6-2EF8-C4DA-045C-08D264EECC4F','1/1/2015','12/31/2015'
CREATE procedure [dbo].[Sp_LoanIssuedByRangeWithCurrentBalances]

@Loantype uniqueidentifier,
@startdate datetime,
@enddate datetime
as
begin
with Loanissued (reference1,AccountName,Narration,issuedate,amount1,amount2)

as
(
SELECT        dbo.swiftfin_Customers.Reference1, (dbo.swiftfin_Customers.Individual_FirstName+''+ dbo.swiftfin_Customers.Individual_LastName)as Name, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanCases.DisbursedDate,
isnull((SELECT        SUM(dbo.swiftfin_LoanCases.DisbursedAmount) AS Expr1
FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id
						 where dbo.swiftfin_LoanProducts.id=@Loantype and dbo.swiftfin_LoanCases.DisbursedDate>=@startdate
						 and dbo.swiftfin_LoanCases.DisbursedDate<=@enddate),0) as [Loan issued],

						 isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
WHERE      dbo.vw_CustomerAccounts.CustomerId=  dbo.swiftfin_Customers.id and dbo.swiftfin_LoanProducts.id = @loantype   ),0)
as [balance] 
from   dbo.swiftfin_Customers inner join
dbo.swiftfin_LoanCases.CustomerId ON  dbo.swiftfin_Customers.Id= dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id inner join
						  dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id

 )

 select reference1,AccountName,Narration,issuedate,amount1,amount2

 from Loanissued 

						 end





GO
/****** Object:  StoredProcedure [dbo].[sp_LoanOffsets]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--sp_LoanOffsets '01/01/2019','01/11/2019',0
CREATE PROCEDURE [dbo].[sp_LoanOffsets]
	@StartDate DateTime,
	@Enddate DateTime,
	@ProductSection int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.Description, dbo.swiftfin_Journals.TotalValue AS principle,0 AS Interest, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Branches.Description AS Branch,dbo.swiftfin_JournalEntries.CreatedDate
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId AND dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.vw_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id
						 where swiftfin_Journals.TransactionCode=50  and swiftfin_JournalEntries.CreatedDate between @StartDate and @Enddate 
						
						 and LoanRegistration_LoanProductSection=@ProductSection
						 union
						 SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.Description,0 AS principle,dbo.swiftfin_Journals.TotalValue AS principle, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Branches.Description AS Branch,dbo.swiftfin_JournalEntries.CreatedDate
FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
                         dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.vw_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id
						 where swiftfin_Journals.TransactionCode=50   and swiftfin_JournalEntries.CreatedDate between @StartDate and @Enddate 
						
						 and LoanRegistration_LoanProductSection=@ProductSection


END




GO
/****** Object:  StoredProcedure [dbo].[sp_LoanOverdeductions]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:  Centrino
-- Create date: 25.10.2014
-- Description: Loan and Interest Balances
-- =============================================
--sp_LoanOverdeductions '06/14/2016'

CREATE PROCEDURE [dbo].[sp_LoanOverdeductions] 
 -- Add the parameters for the stored procedure here
 
 @EndDate DateTime 
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
 With LoanProductBalances(AccountNo,Reference1,Reference2,Reference3,AccountName,Description,Balance,Interest)
 AS
 (
  SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
  dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description, 0,
  SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount
  FROM            dbo.vw_CustomerAccounts INNER JOIN
         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
         dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
  WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
  GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
  dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Description
  UNION ALL
  SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
  dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description, 
  SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0
  FROM            dbo.vw_CustomerAccounts INNER JOIN
         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
         dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
  WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
  GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
  dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Description
 )
 SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,Description,SUM(Balance) AS Balance,sum(Interest) as Interest 
 FROM LoanProductBalances 
 Group By AccountNo,Reference1,Reference2,Reference3,AccountName,Description having SUM(Balance)<0 or sum(Interest)<0
END



GO
/****** Object:  StoredProcedure [dbo].[sp_LoanProductBalanceAndInterest]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
--[dbo].[sp_LoanProductBalanceAndInterest] '2/17/2017' order by reference1
--sp_LoanProductBalanceAndInterest
CREATE PROCEDURE [dbo].[sp_LoanProductBalanceAndInterest] 
	-- Add the parameters for the stored procedure here
	--@ProductID uniqueidentifier, 
	@EndDate DateTime 
AS
--BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With LoanProductBalances(AccountNo,Reference1,Reference2,Reference3,PayrollNumber,AccountName,LoanProduct,ProductID,CostCenterID,DateOfBirth,Branchid,Balance,Interest)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.Individual_PayrollNumbers,dbo.vw_CustomerAccounts.FullName,dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.Id,
		(select  costcenterid from swiftfin_ChartOfAccounts where id=dbo.swiftfin_JournalEntries.ChartOfAccountId),
		dbo.vw_CustomerAccounts.Individual_BirthDate,swiftfin_Branches.id,0,SUM(isnull(dbo.swiftfin_JournalEntries.Amount,0))*-1 AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.vw_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id
		WHERE        dbo.swiftfin_JournalEntries.ValueDate<= @EndDate 
		--and dbo.swiftfin_LoanProducts.id=@ProductID)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_LoanProducts.Description,dbo.vw_CustomerAccounts.Individual_PayrollNumbers,dbo.vw_CustomerAccounts.Individual_BirthDate,
		dbo.swiftfin_Branches.id,dbo.swiftfin_LoanProducts.Id,dbo.swiftfin_JournalEntries.ChartOfAccountId
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.Individual_PayrollNumbers,dbo.vw_CustomerAccounts.FullName,dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.Id,
		(select  costcenterid from swiftfin_ChartOfAccounts where id=dbo.swiftfin_JournalEntries.ChartOfAccountId),
		dbo.vw_CustomerAccounts.Individual_BirthDate,swiftfin_Branches.id,SUM(isnull(dbo.swiftfin_JournalEntries.Amount,0))*-1 AS Amount,0
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId inner join
								 dbo.swiftfin_journals on dbo.swiftfin_JournalEntries.JournalId=dbo.swiftfin_journals.id inner join
								  dbo.swiftfin_Branches ON dbo.vw_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id
		WHERE        dbo.swiftfin_JournalEntries.ValueDate<=@EndDate 
		--and dbo.swiftfin_LoanProducts.id=@ProductID)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_LoanProducts.Description,dbo.vw_CustomerAccounts.Individual_PayrollNumbers,dbo.vw_CustomerAccounts.Individual_BirthDate,
		dbo.swiftfin_Branches.id,dbo.swiftfin_LoanProducts.Id,dbo.swiftfin_JournalEntries.ChartOfAccountId
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,Payrollnumber,AccountName,LoanProduct,ProductID,CostCenterID,DateOfBirth,Branchid, SUM(Balance) AS Balance,sum(Interest) as Interest 
	FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,Payrollnumber,AccountName,LoanProduct,ProductID,CostCenterID,DateOfBirth,Branchid having SUM(Balance) +sum(Interest)<>0 order by Reference1
--END




GO
/****** Object:  StoredProcedure [dbo].[sp_LoanProductBalanceAndInterestNegativeLoans]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
CREATE PROCEDURE [dbo].[sp_LoanProductBalanceAndInterestNegativeLoans] 
	-- Add the parameters for the stored procedure here
	@ProductID uniqueidentifier, 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With LoanProductBalances(AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,Interest)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_LoanProducts.id = @ProductID and dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_LoanProducts.id = @ProductID and dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,sum(Interest) as Interest 
	FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName having SUM(Balance)<0 or  sum(Interest)<0
END






GO
/****** Object:  StoredProcedure [dbo].[sp_LoanProductBalanceAndInterestSingleMember]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
CREATE PROCEDURE [dbo].[sp_LoanProductBalanceAndInterestSingleMember] 
	-- Add the parameters for the stored procedure here
	@CustomerID varchar(100), 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With LoanProductBalances(Product,AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,Interest,LoanDate)
	AS
	(
		SELECT        dbo.swiftfin_LoanProducts.Description, dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,'' as LoanDate
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        dbo.vw_CustomerAccounts.CustomerId=@CustomerID and dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
		GROUP BY dbo.swiftfin_LoanProducts.Description,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount
		UNION ALL
		SELECT        dbo.swiftfin_LoanProducts.Description,dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0,
		isnull((select top 1 DisbursedDate from swiftfin_LoanCases where CustomerId=vw_CustomerAccounts.CustomerId and LoanProductId=dbo.swiftfin_LoanProducts.id and DisbursedDate is not null order by DisbursedDate desc),'') as DisbursedDate
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        ( dbo.vw_CustomerAccounts.CustomerId=@CustomerID and  dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.swiftfin_LoanProducts.Description,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,vw_CustomerAccounts.CustomerId,dbo.swiftfin_LoanProducts.id
	)
	SELECT Product, AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,sum(Interest) as Interest,LoanDate 
	FROM LoanProductBalances 
	Group By Product,AccountNo,Reference1,Reference2,Reference3,AccountName,LoanDate having SUM(Balance) +sum(Interest)<>0
END







GO
/****** Object:  StoredProcedure [dbo].[sp_LoanProductBalanceAndInterestWithoutStandingOrders]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
CREATE PROCEDURE [dbo].[sp_LoanProductBalanceAndInterestWithoutStandingOrders] 
	-- Add the parameters for the stored procedure here
	--@ProductID uniqueidentifier, 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With LoanProductBalances(ID,AccountNo,Reference1,Reference2,Reference3,AccountName,Branch,Description,Balance,Interest)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.id,dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.BranchId,dbo.swiftfin_LoanProducts.Description, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        ( dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.BranchId,
		dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.id,dbo.swiftfin_LoanProducts.Description
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.id, dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.BranchId, dbo.swiftfin_LoanProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        ( dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.id,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_LoanProducts.Description,dbo.vw_CustomerAccounts.BranchId
	)
	SELECT ID,AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,branch,Description,SUM(Balance) AS Balance,sum(Interest) as Interest 
	FROM LoanProductBalances  where id not in (select BeneficiaryCustomerAccountId from swiftfin_StandingOrders)
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,branch,description,id having SUM(Balance) +sum(Interest)<>0
END






GO
/****** Object:  StoredProcedure [dbo].[Sp_Loanproductbalncetotals]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--Sp_Loanproductbalncetotals '05/28/2018'

CREATE  procedure [dbo].[Sp_Loanproductbalncetotals] 
@EndDate DateTime
as

SELECT vw_CustomerAccounts.Reference1,vw_CustomerAccounts.FullAccount,vw_CustomerAccounts.Individual_IdentityCardNumber,vw_CustomerAccounts.Fullname,
sum(swiftfin_JournalEntries.Amount)*-1 as balance
FROM     swiftfin_LoanProducts INNER JOIN
                  vw_CustomerAccounts ON swiftfin_LoanProducts.Id = vw_CustomerAccounts.CustomerAccountType_TargetProductId INNER JOIN
                  swiftfin_JournalEntries ON vw_CustomerAccounts.Id = swiftfin_JournalEntries.CustomerAccountId AND swiftfin_LoanProducts.ChartOfAccountId = swiftfin_JournalEntries.ChartOfAccountId

      where swiftfin_JournalEntries.CreatedDate<=@EndDate group by vw_CustomerAccounts.Reference1,vw_CustomerAccounts.FullAccount,vw_CustomerAccounts.Individual_IdentityCardNumber,
	  vw_CustomerAccounts.Fullname
      having sum(swiftfin_JournalEntries.Amount)*-1<>0
      order by vw_CustomerAccounts.Reference1

	  --select * from vw_customeraccounts
GO
/****** Object:  StoredProcedure [dbo].[sp_LoanRecoverySummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---sp_LoanRecoverySummary '04/01/2015','09/01/2015'

CREATE PROCEDURE [dbo].[sp_LoanRecoverySummary]
	@StartDate datetime,
	@EndDate Datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT        TOP (100) PERCENT dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount, dbo.swiftfin_Journals.ModuleNavigationItemCode, 
                         dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.TransactionCode
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_LoanProducts.ChartOfAccountId
WHERE         dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.ModuleNavigationItemCode, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         dbo.swiftfin_Journals.TransactionCode
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) > 0)  order by  dbo.swiftfin_ChartOfAccounts.AccountCode

END







GO
/****** Object:  StoredProcedure [dbo].[Sp_LoanRepaymentSchedule]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--Sp_GetEmi 1000,10,4,'01/01/2016'
Create PROC [dbo].[Sp_LoanRepaymentSchedule]   
@LoanAmount decimal(18,2),   
@InterestRate decimal(18,2),   
@LoanPeriod Int,   
@StartPaymentDate DATETIME  
AS  
BEGIN  
SET NOCOUNT ON  
  
DECLARE   
  
@Payment decimal(12,2),   
@Period FLOAT,   
@Payment2 decimal(12,2),  
@TotalPayment decimal(12,2),  
@FinanceCharges FLOAT,  
@CompoundingPeriod FLOAT,  
@CompoundingInterest FLOAT,  
@CurrentBalance decimal(12,2),  
@Principal FLOAT,  
@Interest FLOAT,  
@LoanPaymentEndDate DATETIME,  
@LoanPayDate DATETIME,  
@LoanDueDate DATETIME   
  
  
  
SET @InterestRate = @InterestRate/100   
  
SET @CompoundingPeriod = 12   
  
  
/*** END USER VARIABLES ***/   
  
SET @CompoundingInterest = @InterestRate/@CompoundingPeriod   
  
SET @Payment = ROUND((((@InterestRate/12) * @LoanAmount)/(1- ( POWER( (1 + (@InterestRate/12)),(-1 * @LoanPeriod) )))),2)   
  
SET @TotalPayment = @Payment * @LoanPeriod   
  
SET @FinanceCharges = @TotalPayment - @LoanAmount   
  
IF EXISTS(SELECT object_id FROM tempdb.sys.objects WHERE name LIKE '#EMI%')   
  
BEGIN   
  
DROP TABLE #EMI   
  
END   
  
/*** IT'S A TEMPORERY TABLE ***/   
  
CREATE TABLE #EMI(   
  
 PERIOD INT   
  
,PAYDATE SMALLDATETIME   
  
,PAYMENT decimal(12,2)   
  
,CURRENT_BALANCE decimal(12,2)   
  
,INTEREST decimal(12,2)   
  
,PRINCIPAL decimal(12,2)   
  
)   
  
SET @Period = 1   
  
SET @LoanPaymentEndDate = DATEADD(month,@LoanPeriod,@StartPaymentDate)   
  
SET @LoanPayDate = @StartPaymentDate  
  
BEGIN   
  
WHILE (@Period < = @LoanPeriod)   
  
BEGIN   
  
SET @CurrentBalance = ROUND (@LoanAmount * POWER( (1+ @CompoundingInterest) , @Period ) - ( (ROUND(@Payment,2)/@CompoundingInterest) * (POWER((1 + @CompoundingInterest),@Period ) - 1)),0)   
  
SET @Principal =   
CASE   
WHEN @Period = 1   
THEN   
ROUND((ROUND(@LoanAmount,0) - ROUND(@CurrentBalance,0)),0)   
ELSE   
ROUND ((SELECT ABS(ROUND(CURRENT_BALANCE,0) - ROUND(@CurrentBalance,0))   
FROM #EMI   
WHERE PERIOD = @Period -1),2)   
END   
  
SET @Interest = ROUND(ABS(ROUND(@Payment,2) - ROUND(@Principal,2)),2)   
  
SET @LoanDueDate = @LoanPayDate   
  
INSERT   
#EMI  
  
SELECT   
  
@Period,   
@LoanDueDate,   
@Payment,   
@CurrentBalance,   
@Interest,   
@Principal   
  
SET @Period = @Period + 1   
  
SET @LoanPayDate = DATEADD(MM,1,@LoanPayDate)   
  
END   
  
END   
  
SELECT * FROM #EMI  
END  





GO
/****** Object:  StoredProcedure [dbo].[sp_LoansAppraisedButNotApproved]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansAppraisedButNotApproved '08/14/2018'
CREATE PROCEDURE [dbo].[sp_LoansAppraisedButNotApproved] 
	-- Add the parameters for the stored procedure here
	--@StartDate Datetime , 
	@EndDate Datetime
	--@BranchID uniqueidentifier
	
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							  CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							   REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection as ProductSection,dbo.swiftfin_LoanCases.BranchId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanCases.ApprovedDate IS NULL AND dbo.swiftfin_LoanCases.Status= 48827 AND  dbo.swiftfin_LoanCases.AppraisedDate<= @EndDate 
	--AND dbo.swiftfin_LoanCases.BranchId=@BranchID 
END








GO
/****** Object:  StoredProcedure [dbo].[sp_LoansAppraisedButNotApproved2]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_loancases
--select * from swiftfin_loanproducts
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_loanproducts
--exec sp_LoansAppraisedButNotApproved '3/2/2017' ,'60FAF0D5-6483-C943-140C-08D419C90018'
create PROCEDURE [dbo].[sp_LoansAppraisedButNotApproved2] 
 -- Add the parameters for the stored procedure here
 --@StartDate Datetime , 
 @EndDate Datetime,
 @ProductID uniqueidentifier
 
AS
BEGIN
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

    -- Insert statements for procedure here
  SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
        dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
        CASE dbo.swiftfin_Customers.Individual_Salutation WHEN 1 THEN 'Mr' WHEN 2 THEN 'Mrs' WHEN 3 THEN 'Miss' WHEN 4 THEN 'Dr' WHEN 5
         THEN 'Prof' WHEN 6 THEN 'Rev' WHEN 7 THEN 'Eng' WHEN 8 THEN 'Hon' WHEN 9 THEN 'Cllr' WHEN 10 THEN 'Sir' WHEN 11 THEN
         'Ms' ELSE 'UnKnown' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
        CASE Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'UnKnown' END AS Gender, 
        CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
         WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
        CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN 1 THEN 'BackOffice' WHEN 0 THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
         REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
        dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
        dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
        dbo.swiftfin_LoanCases.AppraisedAmount,dbo.swiftfin_LoanCases.AppraisedAmount,
dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
        dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
        dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
        dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
        dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
        dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
        CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
         'Unknown' END AS LoanInterest_CalculationMode, 
        CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
        dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
        dbo.swiftfin_LoanCases.LoanProductId, 
        CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN 0 THEN 'FrontOffice' WHEN 1 THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId,
        dbo.swiftfin_LoanCases.TakeHome_FixedAmount,
				(select isnull(sum(principalbalance+InterestBalance),0) from swiftfin_AttachedLoans where LoanCaseId=swiftfin_LoanCases.id)*-1 as AttachedLoanBalance
FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id                         
 WHERE dbo.swiftfin_LoanCases.ApprovedDate IS NULL AND dbo.swiftfin_LoanCases.Status= 48827 AND  dbo.swiftfin_LoanCases.AppraisedDate<= @EndDate and dbo.swiftfin_LoanCases.LoanProductId=@ProductID 

END



GO
/****** Object:  StoredProcedure [dbo].[sp_LoansAppraisedByBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansAppraisedByBranch '05/28/2016','05/31/2018','CD31AE61-4EB8-C509-BBF7-08D33947919E'
CREATE PROCEDURE [dbo].[sp_LoansAppraisedByBranch] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
	--@BranchID uniqueidentifier
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId,dbo.swiftfin_LoanCases.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
	WHERE dbo.swiftfin_LoanCases.AppraisedDate BETWEEN @StartDate and @EndDate  and dbo.swiftfin_LoanCases.status='48827'
	--AND dbo.swiftfin_LoanCases.BranchId=@BranchID 
END


--select status, * from swiftfin_loancases
--select * from swiftfin_enumerations where [key] like '%LoanCaseStatus%'







GO
/****** Object:  StoredProcedure [dbo].[sp_LoansAppraisedByBranchByProduct]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Various Men & Women
-- Create date: 6/18/2016 9:21:45 AM
-- Description:	Loans Appraised By Branch & Product
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansAppraisedByBranchByProduct '06/16/2017','06/18/2018','CD31AE61-4EB8-C509-BBF7-08D33947919E','8a948b74-6537-cf5d-6d94-08d33a1a0f44'
CREATE PROCEDURE [dbo].[sp_LoansAppraisedByBranchByProduct] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
	--@BranchId uniqueidentifier
	--@ProductID uniqueidentifier
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'UnKnown' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN 1 THEN 'BackOffice' WHEN 0 THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.ApprovalRemarks, 
							 dbo.swiftfin_LoanCases.ApprovedAmount, dbo.swiftfin_LoanCases.ApprovedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode,dbo.swiftfin_LoanProducts.LoanInterest_AnnualPercentageRate AS AnnualPercentageRate ,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId,dbo.swiftfin_Branches.Description AS BranchName,
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN 0 THEN 'FrontOffice' WHEN 1 THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanCases.ApprovedDate BETWEEN @StartDate and @EndDate 
	--AND dbo.swiftfin_LoanCases.BranchId=@BranchId 
END




GO
/****** Object:  StoredProcedure [dbo].[sp_LoansApprovedButNotDisbursed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansApprovedButNotDisbursed '06/14/2016'
CREATE PROCEDURE [dbo].[sp_LoansApprovedButNotDisbursed] 
	-- Add the parameters for the stored procedure here
	@EndDate Datetime
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							  CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '11'
							 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, swiftfin_loancases.ApprovedAmount,swiftfin_loancases.ApprovedBy,swiftfin_loancases.ApprovedDate,swiftfin_loancases.ApprovalRemarks,
							 dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE   dbo.swiftfin_LoanCases.ApprovedDate <= @EndDate AND dbo.swiftfin_LoanCases.status=48828 and dbo.swiftfin_LoanCases.AuditedDate IS NULL
	
END







GO
/****** Object:  StoredProcedure [dbo].[sp_LoansApprovedByBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansApprovedByBranch '05/01/2016','05/25/2016','03E97E5B-76C7-CFB1-3EF2-08D339480A2B',48826
CREATE PROCEDURE [dbo].[sp_LoansApprovedByBranch] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							  CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							   REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, swiftfin_loancases.ApprovedAmount,
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
	WHERE dbo.swiftfin_LoanCases.ApprovedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.status='48828'
	
END

--select status, * from swiftfin_loancases
--select * from swiftfin_enumerations where [key] like '%LoanCaseStatus%'






GO
/****** Object:  StoredProcedure [dbo].[sp_LoansApprovedByBranch2]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================

--select * from swiftfin_Branches
--sp_LoansApprovedByBranch '10/25/2014','10/25/2014','8B8B1B74-141C-CF68-05C2-08D19D7D7330'
CREATE PROCEDURE [dbo].[sp_LoansApprovedByBranch2] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							CASE dbo.swiftfin_Customers.Individual_Salutation WHEN 1 THEN 'Mr' WHEN 2 THEN 'Mrs' WHEN 3 THEN 'Miss' WHEN 4 THEN 'Dr' WHEN 5
							  THEN 'Prof' WHEN 6 THEN 'Rev' WHEN 7 THEN 'Eng' WHEN 8 THEN 'Hon' WHEN 9 THEN 'Cllr' WHEN 10 THEN 'Sir' WHEN 11 THEN
							  'Ms' ELSE 'UnKnown' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'UnKnown' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN 1 THEN 'BackOffice' WHEN 0 THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome,dbo.swiftfin_LoanCases.ApprovedAmount, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN 0 THEN 'FrontOffice' WHEN 1 THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanCases.ApprovedDate BETWEEN @StartDate and @EndDate 
	
END






GO
/****** Object:  StoredProcedure [dbo].[sp_LoansByStatus]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:  Centrino
-- Create date: 06.14.2016
-- Description: Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansAuditedButNotDisbursed '07/01/2016','07/14/2016'
CREATE PROCEDURE [dbo].[sp_LoansByStatus] 
 -- Add the parameters for the stored procedure here
 @StartDate Datetime , 
 @EndDate Datetime,
 @Status int
 --@BranchID uniqueidentifier
 
AS
BEGIN
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

    -- Insert statements for procedure here
  SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
        dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
        CASE dbo.swiftfin_Customers.Individual_Salutation  WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
        CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
        CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
        CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '2' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
         REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
        dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
        dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
        dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, swiftfin_LoanCases.ApprovedAmount,
        dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
        dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
        dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
        dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
        dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
        CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
         'Unknown' END AS LoanInterest_CalculationMode, 
        CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
        dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
        dbo.swiftfin_LoanCases.LoanProductId, 
        CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '2' THEN 'FrontOffice' ELSE 'UnKnown' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId
 FROM            dbo.swiftfin_LoanCases INNER JOIN
        dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
        dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
        dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
        dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
 WHERE   dbo.swiftfin_LoanCases.createdDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.Status=@Status --IS NULL  AND  dbo.swiftfin_LoanCases.AuditedDate IS NOT NULL AND 
 --AND dbo.swiftfin_LoanCases.BranchId=@BranchID 
END





GO
/****** Object:  StoredProcedure [dbo].[sp_LoansDibursedSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_LoansDibursedSummary '05/11/2018','05/25/2018'

CREATE PROC [dbo].[sp_LoansDibursedSummary]
@StartDate DateTime,
@EndDate DateTime
as

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

with LoanCasesCTE(Amount,Product,Male,Female,CostCenter)
as
(
select disbursedAmount as Amount,
(select Description from swiftfin_LoanProducts where id=swiftfin_LoanCases.LoanProductId) as Product,
(select count (id) from swiftfin_Customers where Individual_Gender=1 and  id=dbo.swiftfin_LoanCases.CustomerId) as Male,
(select count (id) from swiftfin_Customers where Individual_Gender=2 and  id=dbo.swiftfin_LoanCases.CustomerId) as Female,
(select Description from swiftfin_CostCenters where id= dbo.swiftfin_ChartOfAccounts.CostCenterId) as CostCenter


FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
						 where dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate and  Status=48829 
						 )
 select Product, sum(Amount) as Amount,sum(male) as Male,sum(Female) as Female,sum(male)+sum(Female) as TotalMembers,CostCenter
 
 from LoanCasesCTE 
 group by Product,CostCenter
 

 --select * from swiftfin_LoanCases
GO
/****** Object:  StoredProcedure [dbo].[sp_LoansDisbursedByBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================

--select * from swiftfin_Branches
--[sp_LoansDisbursedByBranch] '07/01/2016','07/25/2016'
CREATE PROCEDURE [dbo].[sp_LoansDisbursedByBranch] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	
    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))) AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, dbo.swiftfin_LoanCases.ApprovedAmount,
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, 
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
	WHERE dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.status='48829'
	
END

--select status, * from swiftfin_loancases
--select * from swiftfin_enumerations where [key] like '%LoanCaseStatus%'



GO
/****** Object:  StoredProcedure [dbo].[sp_LoansDisbursedByBranch1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================

--select * from swiftfin_Branches
--[sp_LoansDisbursedByBranch] '07/01/2016','07/25/2016'
create PROCEDURE [dbo].[sp_LoansDisbursedByBranch1] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime,
	@RegisteredBy varchar
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
  

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	
    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))) AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, dbo.swiftfin_LoanCases.ApprovedAmount,
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, 
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
	WHERE dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.status='48829' and dbo.swiftfin_LoanCases.CreatedBy=@RegisteredBy
	
END

--select status, * from swiftfin_loancases
--select * from swiftfin_enumerations where [key] like '%LoanCaseStatus%'



GO
/****** Object:  StoredProcedure [dbo].[sp_LoansDisbursedByDateRange]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Batch submitted through debugger: SQLQuery4.sql|9|0|C:\Users\ADMINI~1\AppData\Local\Temp\2\~vs8D19.sql

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================

--select * from swiftfin_Branches
--[sp_LoansDisbursedByBranch] '07/01/2016','08/25/2016'
CREATE PROCEDURE [dbo].[sp_LoansDisbursedByDateRange] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime,
	@ProductSection int
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	--select * from swiftfin_LoanCases
	
	
    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))) AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, dbo.swiftfin_LoanCases.ApprovedAmount,
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, 
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths,dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=@ProductSection and  dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate 
	
END






GO
/****** Object:  StoredProcedure [dbo].[sp_LoansDisbursedByEmployer]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[sp_LoansDisbursedByEmployer] 
-- select id, description from swiftfin_employers
--  select id, description from swiftfin_loanproducts
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime,
	@EmployerID uniqueidentifier,
	@LoanProductId uniqueidentifier

	-- [sp_LoansDisbursedByEmployer_1] '11/3/2018', '2/5/2019', '74BA72A9-41C6-E811-8357-08D40C76F50B', '41A31650-E9BB-E811-A815-000C29142092'
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT         ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.vw_Employers.EmployerID as EmployerID,dbo.vw_Employers.Employer as Employer, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))) AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,
							 dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, dbo.swiftfin_LoanCases.ApprovedAmount,
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, 
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId
FROM            swiftfin_LoanCases INNER JOIN
                         swiftfin_Branches ON swiftfin_LoanCases.BranchId = swiftfin_Branches.Id INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanCases.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanCases.LoanProductId = swiftfin_LoanProducts.Id INNER JOIN
                         swiftfin_LoanPurposes ON swiftfin_LoanCases.LoanPurposeId = swiftfin_LoanPurposes.Id INNER JOIN
                         swiftfin_ChartOfAccounts ON swiftfin_LoanProducts.ChartOfAccountId = swiftfin_ChartOfAccounts.Id INNER JOIN
                         vw_Employers ON swiftfin_Customers.StationId = vw_Employers.StationID
						 WHERE dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.status='48829'
						      and  dbo.vw_Employers.EmployerID = @EmployerID and  dbo.swiftfin_LoanCases.LoanProductId = @LoanProductId

						 end

						  --RIGHT OUTER JOIN dbo.swiftfin_CustomerAccounts 
						 --INNER JOIN
                       --  dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
GO
/****** Object:  StoredProcedure [dbo].[sp_LoansDisbursedByEmployer_1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create PROCEDURE [dbo].[sp_LoansDisbursedByEmployer_1] 
-- select id, description from swiftfin_employers
--  select id, description from swiftfin_loanproducts
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime,
	@EmployerID uniqueidentifier,
	@LoanProductId uniqueidentifier

	-- [sp_LoansDisbursedByEmployer_1] '11/3/2018', '2/5/2019', '74BA72A9-41C6-E811-8357-08D40C76F50B', '41A31650-E9BB-E811-A815-000C29142092'
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT         ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.vw_Employers.EmployerID as EmployerID,dbo.vw_Employers.Employer as Employer, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))) AS FullName, 
							 CASE Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN '1' THEN 'BackOffice' WHEN '0' THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,
							 dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, dbo.swiftfin_LoanCases.ApprovedAmount,
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount, 
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN '0' THEN 'FrontOffice' WHEN '1' THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId
FROM            swiftfin_LoanCases INNER JOIN
                         swiftfin_Branches ON swiftfin_LoanCases.BranchId = swiftfin_Branches.Id INNER JOIN
                         swiftfin_Customers ON swiftfin_LoanCases.CustomerId = swiftfin_Customers.Id INNER JOIN
                         swiftfin_LoanProducts ON swiftfin_LoanCases.LoanProductId = swiftfin_LoanProducts.Id INNER JOIN
                         swiftfin_LoanPurposes ON swiftfin_LoanCases.LoanPurposeId = swiftfin_LoanPurposes.Id INNER JOIN
                         swiftfin_ChartOfAccounts ON swiftfin_LoanProducts.ChartOfAccountId = swiftfin_ChartOfAccounts.Id INNER JOIN
                         vw_Employers ON swiftfin_Customers.StationId = vw_Employers.StationID
						 WHERE dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.status='48829'
						      and  dbo.vw_Employers.EmployerID = @EmployerID and  dbo.swiftfin_LoanCases.LoanProductId = @LoanProductId

						 end

						  --RIGHT OUTER JOIN dbo.swiftfin_CustomerAccounts 
						 --INNER JOIN
                       --  dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
GO
/****** Object:  StoredProcedure [dbo].[sp_LoansDisbursedInsurance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan Centrino>
-- Create date: <Create Date, 05/29/2015>
-- Description:	<Description, Loans Disburded Report Machakos>
-- =============================================
--exec sp_CICLoansDisbursed '04/28/2015','04/28/2015', '18'
--'Machakos',
CREATE PROCEDURE [dbo].[sp_LoansDisbursedInsurance] 
	@StartDate datetime,
	@EndDate datetime,
	--@BranchCode varchar(50)
	@code varchar (50)
	
AS
BEGIN
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        SUM(dbo.swiftfin_LoanCases.DisbursedAmount) AS DisbursedAmount, dbo.swiftfin_Customers.Individual_FirstName + '' + dbo.swiftfin_Customers.Individual_LastName As Name, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Individual_IdentityCardNumber,
                         dbo.swiftfin_Customers.Individual_PayrollNumbers, dbo.swiftfin_LoanCases.CaseNumber, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate AS [Date Applied], 
                         dbo.swiftfin_LoanCases.DisbursedDate, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_Branches.Code, 
                         dbo.swiftfin_LoanProducts.Code AS [Loan Code]
	FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id
	WHERE        (dbo.swiftfin_LoanCases.DisbursedAmount <> 0) and dbo.swiftfin_LoanCases.DisbursedDate between @StartDate and @EndDate and dbo.swiftfin_LoanProducts.Code =@code
	--and @BranchCode=dbo.swiftfin_Branches.Description 
	GROUP BY dbo.swiftfin_LoanProducts.Code, dbo.swiftfin_Branches.Code, dbo.swiftfin_Branches.Description, dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanProducts.Description, 
                         dbo.swiftfin_LoanCases.DisbursedDate, dbo.swiftfin_LoanCases.ReceivedDate, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.CaseNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers, 
                         dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_IdentityCardNumber
END






GO
/****** Object:  StoredProcedure [dbo].[sp_LoansDisbursedNet]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_loancases
--select * from swiftfin_loanproducts
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_loanproducts
-- sp_LoansDisbursedNet '01/01/2018' ,'D0A7FB03-B1EB-CB99-E958-08D3E0A0E8CF'
CREATE PROCEDURE [dbo].[sp_LoansDisbursedNet] 
 -- Add the parameters for the stored procedure here
 @StartDate Datetime , 
 @EndDate Datetime
-- @ProductID uniqueidentifier
 
AS
BEGIN
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

    -- Insert statements for procedure here
  SELECT      dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
        dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
        CASE dbo.swiftfin_Customers.Individual_Salutation WHEN 1 THEN 'Mr' WHEN 2 THEN 'Mrs' WHEN 3 THEN 'Miss' WHEN 4 THEN 'Dr' WHEN 5
         THEN 'Prof' WHEN 6 THEN 'Rev' WHEN 7 THEN 'Eng' WHEN 8 THEN 'Hon' WHEN 9 THEN 'Cllr' WHEN 10 THEN 'Sir' WHEN 11 THEN
         'Ms' ELSE 'UnKnown' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
        dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1,swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
        dbo.swiftfin_LoanCases.AppraisedAmount,dbo.swiftfin_LoanCases.ApprovedAmount,dbo.swiftfin_LoanCases.DisbursedDate, dbo.swiftfin_LoanCases.DisbursedAmount, 
      (select isnull(sum(principalbalance+InterestBalance),0) from swiftfin_AttachedLoans where LoanCaseId=swiftfin_LoanCases.id)*-1 as AttachedLoanBalance,swiftfin_LoanCases.LoanProductId,
	  dbo.swiftfin_Customers.StationId,
				dbo.swiftfin_LoanCases.disbursedamount-((select isnull(sum(principalbalance+InterestBalance),0) from swiftfin_AttachedLoans where LoanCaseId=swiftfin_LoanCases.id)*-1) as NetLoan
FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id                         
 WHERE  dbo.swiftfin_LoanCases.Status= 48829 AND  dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate --and dbo.swiftfin_LoanCases.LoanProductId=@ProductID 

END

--select * from swiftfin_loancases where [key] like '%status%'


GO
/****** Object:  StoredProcedure [dbo].[sp_LoansProductsBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---sp_InvestmentProductsBalances '10/16/2015','<',0
CREATE PROCEDURE [dbo].[sp_LoansProductsBalances] 
	@Enddate Datetime,
	@Operator char(2),
	@OperatorValue float
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.reference1,dbo.vw_CustomerAccounts.reference2, dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_LoanProducts.Description AS AccountName, dbo.vw_CustomerAccounts.Reference1, SUM(dbo.swiftfin_JournalEntries.Amount)*-1 
							 AS Balance

	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
	where dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate    
	GROUP BY dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_LoanProducts.Description,dbo.vw_CustomerAccounts.reference1,dbo.vw_CustomerAccounts.reference2, dbo.vw_CustomerAccounts.Reference1
	HAVING
	 ((@Operator = '>' and SUM(dbo.swiftfin_JournalEntries.Amount)*-1  > @OperatorValue)
		or (@Operator = '<' and SUM(dbo.swiftfin_JournalEntries.Amount)*-1 < @OperatorValue)
		or (@Operator = '<>' and SUM(dbo.swiftfin_JournalEntries.Amount)*-1 != @OperatorValue)
		or (@Operator = '>=' and SUM(dbo.swiftfin_JournalEntries.Amount)*-1 >= @OperatorValue)
		or (@Operator = '<=' and SUM(dbo.swiftfin_JournalEntries.Amount)*-1 <= @OperatorValue)
		or (@Operator = '=' and SUM(dbo.swiftfin_JournalEntries.Amount)*-1 = @OperatorValue)
		)

END











GO
/****** Object:  StoredProcedure [dbo].[sp_LoansProductsBalancesComparative]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---[sp_LoansProductsBalancesComparative] '04/01/2015'
CREATE PROCEDURE [dbo].[sp_LoansProductsBalancesComparative] 
	@Enddate Datetime
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	declare @StartDate Datetime=(select DATEADD ( month ,-1,@EndDate ))

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


SELECT     dbo.swiftfin_LoanProducts.Description AS AccountName,
	isnull((select sum(amount) from swiftfin_Journalentries where 
	 ContraChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and dbo.swiftfin_JournalEntries.CreatedDate<=@StartDate),0) as [Previous Month], 
	isnull((select sum(amount) from swiftfin_Journalentries where 
	 ContraChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and dbo.swiftfin_JournalEntries.CreatedDate<=@Enddate),0) [Current Month]    
FROM            dbo.swiftfin_LoanProducts order by Code
END










GO
/****** Object:  StoredProcedure [dbo].[sp_LoansRegisteredButNotAppraised]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansRegisteredButNotAppraised '08/01/2016','08/14/2016'
create PROCEDURE [dbo].[sp_LoansRegisteredButNotAppraised] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
	--@BranchID uniqueidentifier
	
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							  dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'UnKnown' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN 1 THEN 'BackOffice' WHEN 0 THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN 0 THEN 'FrontOffice' WHEN 1 THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanCases.AppraisedDate IS NULL  AND  dbo.swiftfin_LoanCases.createdDate BETWEEN @StartDate and @EndDate 
	--AND dbo.swiftfin_LoanCases.BranchId=@BranchID 
END






GO
/****** Object:  StoredProcedure [dbo].[sp_LoansRegisteredByBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansRegisteredByBranch '11/03/2018','12/03/2018'
CREATE PROCEDURE [dbo].[sp_LoansRegisteredByBranch] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
	--@BranchID uniqueidentifier
	
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
		 dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'UnKnown' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN 1 THEN 'BackOffice' WHEN 0 THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, dbo.swiftfin_loancases.casenumber,
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1,dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN 0 THEN 'FrontOffice' WHEN 1 THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE dbo.swiftfin_LoanCases.createdDate BETWEEN @StartDate and @EndDate 
	--AND dbo.swiftfin_LoanCases.BranchId=@BranchID 
END
--select * from swiftfin_loancases







GO
/****** Object:  StoredProcedure [dbo].[sp_LoansRejected]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 06.14.2016
-- Description:	Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansAuditedButNotDisbursed '07/01/2016','07/14/2016'
create  PROCEDURE [dbo].[sp_LoansRejected] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
	--@BranchID uniqueidentifier
	
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'UnKnown' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN 1 THEN 'BackOffice' WHEN 0 THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, 
							 dbo.swiftfin_LoanCases.ApprovedBy, dbo.swiftfin_LoanCases.ApprovedDate, dbo.swiftfin_LoanCases.ApprovalRemarks, dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN 0 THEN 'FrontOffice' WHEN 1 THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE   dbo.swiftfin_LoanCases.createdDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.Status='48830' --dbo.swiftfin_LoanCases.DisbursedDate IS NULL  AND  dbo.swiftfin_LoanCases.AuditedDate IS NOT NULL AND 
	--AND dbo.swiftfin_LoanCases.BranchId=@BranchID 
END



GO
/****** Object:  StoredProcedure [dbo].[sp_LoansReversed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create Proc [dbo].[sp_LoansReversed]
@StartDate DateTime,
@EndDate DateTime
AS
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Description, dbo.swiftfin_JournalEntries.Amount,
dbo.swiftfin_JournalEntries.CreatedDate, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Journals.SecondaryDescription
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
						 	where dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate and	ModuleNavigationItemCode=64460 and TransactionCode=21 and 
							dbo.vw_CustomerAccounts.CustomerAccountType_ProductCode=2
					order by Reference1
	--select * from swiftfin_Journals where PrimaryDescription like '%reversal%' 
	--and TransactionCode=21
GO
/****** Object:  StoredProcedure [dbo].[sp_LoansStatus]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	Loans Approved By Branch
-- =============================================
--select * from swiftfin_enumerations order by [key]
--select * from swiftfin_Branches
--sp_LoansStatus '08/01/2016','08/15/2016','1','48826'
CREATE PROCEDURE [dbo].[sp_LoansStatus] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime,
	@EndDate Datetime,
	@Section int,
	@Status Varchar(50)
AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
		SELECT       ROW_NUMBER() OVER(ORDER BY dbo.swiftfin_Branches.Description DESC) AS Row, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_LoanProducts.Description AS LoanProduct, dbo.swiftfin_LoanPurposes.Description AS LoanPurpose, 
							 dbo.swiftfin_LoanCases.CaseNumber,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths, dbo.swiftfin_LoanCases.AmountApplied, dbo.swiftfin_LoanCases.ReceivedDate, 
							 dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							 CASE Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'UnKnown' END AS Gender, 
							 CASE dbo.swiftfin_LoanCases.status WHEN '48826' THEN 'Registered' WHEN '48827' THEN 'Appraised' WHEN '48828' THEN 'Approved' WHEN '48829' THEN 'Disbursed'
							  WHEN '48830' THEN 'Rejected' WHEN '48831' THEN 'Differred' WHEN '48832' THEN 'Audited' ELSE 'UnKnown' END AS LoanStatus, 
							 CASE dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection WHEN 1 THEN 'BackOffice' WHEN 0 THEN 'FrontOffice' ELSE 'UnKnown' END AS LoanProductSection,
							  REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') AS MembershipNumber, 
							 dbo.swiftfin_Customers.Reference3 AS PersonalFileNumber,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_LoanCases.AppraisedBy, dbo.swiftfin_LoanCases.AppraisedDate, 
							 dbo.swiftfin_LoanCases.SystemAppraisalRemarks, dbo.swiftfin_LoanCases.SystemAppraisedAmount, dbo.swiftfin_LoanCases.AppraisalRemarks, 
							 dbo.swiftfin_LoanCases.AppraisedAmount, dbo.swiftfin_LoanCases.AppraisedAmountRemarks, dbo.swiftfin_LoanCases.AppraisedNetIncome, swiftfin_loancases.ApprovedAmount,swiftfin_loancases.ApprovedBy,swiftfin_loancases.ApprovedDate,swiftfin_loancases.ApprovalRemarks,
							 dbo.swiftfin_LoanCases.AuditedBy, 
							 dbo.swiftfin_LoanCases.AuditedDate, dbo.swiftfin_LoanCases.AuditRemarks, dbo.swiftfin_LoanCases.DisbursedBy, dbo.swiftfin_LoanCases.DisbursedDate, 
							 dbo.swiftfin_LoanCases.disbursedamount, dbo.swiftfin_LoanCases.MonthlyPaybackAmount, 
							 dbo.swiftfin_LoanCases.TotalPaybackAmount, dbo.swiftfin_LoanCases.LoanProductInvestmentsBalance, dbo.swiftfin_LoanCases.LoanProductLoanBalance, 
							 dbo.swiftfin_LoanCases.TotalLoansBalance, REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') +'-001-001' as FullAccount,
							 CASE dbo.swiftfin_LoanCases.LoanInterest_CalculationMode WHEN 512 THEN 'Reducing Balance' WHEN 513 THEN 'Straight Line' WHEN 514 THEN 'Amortization' ELSE
							  'Unknown' END AS LoanInterest_CalculationMode, 
							 CASE dbo.swiftfin_LoanCases.LoanInterest_ChargeMode WHEN 768 THEN 'UpFront' WHEN 769 THEN 'Periodic' ELSE 'Unknown' END AS LoanInterest_ChargeMode, 
							 dbo.swiftfin_LoanCases.CreatedBy, dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AuditTopUpAmount,  
							 dbo.swiftfin_LoanCases.LoanProductId, 
							 CASE dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection WHEN 0 THEN 'FrontOffice' WHEN 1 THEN 'BackOffice' END AS ProductSection,dbo.swiftfin_LoanCases.BranchId
	FROM            dbo.swiftfin_LoanCases INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_LoanCases.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_LoanCases.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
							 dbo.swiftfin_LoanPurposes ON dbo.swiftfin_LoanCases.LoanPurposeId = dbo.swiftfin_LoanPurposes.Id
	WHERE   dbo.swiftfin_LoanCases.ReceivedDate between @StartDate and @EndDate AND dbo.swiftfin_LoanCases.LoanRegistration_LoanProductSection=@Section and dbo.swiftfin_LoanCases.status=@Status--and dbo.swiftfin_LoanCases.AuditedDate IS NULL
	
END




GO
/****** Object:  StoredProcedure [dbo].[sp_MaturedButUnpaidFixedDeposits]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan >
-- Create date: <Create Date, 10/08/2015>
-- Description:	<Description, Matured Fixed Deposits That Are Not Yet Paid>
-- =============================================
 --sp_MaturedButUnpaidFixedDeposits '06/01/2015'
 create PROCEDURE [dbo].[sp_MaturedButUnpaidFixedDeposits]
	-- Add the parameters for the stored procedure here
	@MaturityDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        dbo.swiftfin_FixedDeposits.Value, dbo.swiftfin_FixedDeposits.Term, dbo.swiftfin_FixedDeposits.Rate, dbo.swiftfin_FixedDeposits.Status, dbo.swiftfin_FixedDeposits.MaturityDate, dbo.swiftfin_FixedDeposits.PaidDate, 
                         dbo.swiftfin_Customers.Individual_FirstName + '' + dbo.swiftfin_Customers.Individual_LastName as FullName, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference3, 
                         dbo.swiftfin_Customers.Reference2, dbo.swiftfin_FixedDeposits.CreatedDate, dbo.swiftfin_FixedDeposits.TotalExpected
	FROM            dbo.swiftfin_FixedDeposits INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_FixedDeposits.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
	Where MaturityDate <= @MaturityDate and  PaidDate is  null
						 
END






GO
/****** Object:  StoredProcedure [dbo].[sp_MemberGuarantorsWithAmountGuaranteed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc  [dbo].[sp_MemberGuarantorsWithAmountGuaranteed]

--@EndDate datetime
as
-- sp_MemberGuarantorsWithAmountGuaranteed '01/15/2018'
begin 
--set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
SELECT        dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Description, dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, 
                         dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_Customers.Individual_FirstName+' '+ dbo.swiftfin_Customers.Individual_LastName as LoaneeName,
						  dbo.swiftfin_Customers.Reference1 AS LoaneeAccountNo, dbo.swiftfin_loanguarantors.CreatedDate
FROM            dbo.swiftfin_LoanGuarantors INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_LoanGuarantors.CustomerId = dbo.vw_CustomerAccounts.CustomerId AND 
                         dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanGuarantors.LoaneeCustomerId = dbo.swiftfin_Customers.Id
						-- where dbo.swiftfin_loanguarantors.CreatedDate = @EndDate
						 end
GO
/****** Object:  StoredProcedure [dbo].[sp_MemberPerEmployer]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 15.10.2014
-- Description:	Members Per Station
-- =============================================
---select * from  swiftfin_Stations order by Description
---sp_MemberPerStation '7793DD6D-0143-E811-80D1-F40343552CF9'
CREATE PROCEDURE [dbo].[sp_MemberPerEmployer]
	-- Add the parameters for the stored procedure here
	@EmployerID uniqueidentifier
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        CASE swiftfin_Customers_2.Individual_Salutation  WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(swiftfin_Customers_2.Individual_FirstName,'') +' '+ isnull(swiftfin_Customers_2.Individual_LastName,'') + isnull(swiftfin_Customers_2.NonIndividual_Description,'')AS FullName, 
                         CASE swiftfin_Customers_2.Individual_Gender  WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
                         CASE swiftfin_Customers_2.Individual_MaritalStatus WHEN '1' THEN 'Married' WHEN '2' THEN 'Single' WHEN '3' THEN 'Divorced' WHEN '4' THEN 'Separated' ELSE '' END AS MaritalStatus, swiftfin_Customers_2.Individual_IdentityCardNumber, swiftfin_Customers_2.Individual_PayrollNumbers, 
                         swiftfin_Customers_2.Individual_BirthDate, swiftfin_Customers_2.Address_AddressLine1, swiftfin_Customers_2.Address_AddressLine2, swiftfin_Customers_2.Address_Street, 
                         swiftfin_Customers_2.Address_PostalCode, swiftfin_Customers_2.Address_City, swiftfin_Customers_2.Address_Email, swiftfin_Customers_2.Address_LandLine, 
                         swiftfin_Customers_2.Address_MobileLine, swiftfin_Customers_2.RegistrationDate, swiftfin_Customers_2.CreatedDate, dbo.swiftfin_Stations.Description AS Station, 
                         swiftfin_Customers_2.Individual_EmploymentDate, swiftfin_Customers_2.Individual_EmploymentDesignation, REPLACE(STR(swiftfin_Customers_2.SerialNumber, 5), 
                         SPACE(1), '0') AS DelegateMembershipNumber, LTRIM(RTRIM(swiftfin_Customers_2.Individual_FirstName)) 
                         + ' ' + LTRIM(RTRIM(swiftfin_Customers_2.Individual_LastName)) AS DelegateName, swiftfin_Customers_2.Id, REPLACE(STR(swiftfin_Customers_2.SerialNumber, 6), 
                         SPACE(1), '0') AS SerialNumber, swiftfin_Customers_2.Reference1, swiftfin_Customers_2.Reference2, swiftfin_Customers_2.Reference3,dbo.swiftfin_Zones.Description as Zone, 
                         dbo.swiftfin_Employers.Description AS Employer
	FROM            dbo.swiftfin_Customers AS swiftfin_Customers_2 INNER JOIN
                         dbo.swiftfin_Stations ON swiftfin_Customers_2.StationId = dbo.swiftfin_Stations.Id INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id  where dbo.swiftfin_Employers.Id=@EmployerID
END






GO
/****** Object:  StoredProcedure [dbo].[sp_MemberPerStation]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 15.10.2014
-- Description:	Members Per Station
-- =============================================
---select * from  swiftfin_Stations order by Description
---sp_MemberPerStation '5168F019-A5C7-E811-835A-08D40C76F50B'
CREATE PROCEDURE [dbo].[sp_MemberPerStation] 
	-- Add the parameters for the stored procedure here
	@StationID uniqueidentifier
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        COALESCE( ltrim(rtrim(CASE swiftfin_Customers_2.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(swiftfin_Customers_2.Individual_FirstName,'') + ' ' + isnull(swiftfin_Customers_2.Individual_LastName,''))),'')+ COALESCE(swiftfin_Customers_2.NonIndividual_Description,'') AS FullName, 
                         CASE swiftfin_Customers_2.Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender,  swiftfin_Customers_2.Individual_IdentityCardNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Nationality WHEN 1 THEN 'Kenya' WHEN 2 THEN 'Uganda' WHEN 3 THEN 'Tanzania' WHEN 4 THEN 'Rwanda' WHEN 4 THEN 'Burundi'
                          ELSE 'UnKnown' END AS Nationality, RIGHT('00000' + CAST(LTRIM(RTRIM(swiftfin_Customers_2.SerialNumber)) AS VARCHAR(5)), 5) AS MembershipNumber, 
                         swiftfin_Customers_2.Individual_PayrollNumbers, swiftfin_Customers_2.Individual_BirthDate, swiftfin_Customers_2.Address_AddressLine1, 
                         swiftfin_Customers_2.Address_AddressLine2, swiftfin_Customers_2.Address_Street, swiftfin_Customers_2.Address_PostalCode, swiftfin_Customers_2.Address_City, 
                         swiftfin_Customers_2.Address_Email, swiftfin_Customers_2.Address_LandLine, swiftfin_Customers_2.Address_MobileLine, swiftfin_Customers_2.RegistrationDate, 
                         swiftfin_Customers_2.CreatedDate, dbo.swiftfin_Stations.Description AS Station, dbo.swiftfin_Zones.Description AS Zone, dbo.swiftfin_Divisions.Description AS Division, 
                         dbo.swiftfin_Employers.Description AS Employer, swiftfin_Customers_2.Individual_EmploymentDate, swiftfin_Customers_2.Individual_EmploymentDesignation, 
                         REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 5), SPACE(1), '0') AS DelegateMembershipNumber, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers AS DelegatePersonalFileNumber, LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_FirstName)) 
                         + ' ' + LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS DelegateName, swiftfin_Customers_2.Id, REPLACE(STR(swiftfin_Customers_2.SerialNumber, 6), 
                         SPACE(1), '0') AS SerialNumber, swiftfin_Customers_2.Reference1, swiftfin_Customers_2.Reference2, swiftfin_Customers_2.Reference3
	FROM            dbo.swiftfin_Zones INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Stations.ZoneId INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
                         dbo.swiftfin_Delegates ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Delegates.ZoneId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Delegates.CustomerId = dbo.swiftfin_Customers.Id RIGHT OUTER JOIN
                         dbo.swiftfin_Customers AS swiftfin_Customers_2 ON dbo.swiftfin_Stations.Id = swiftfin_Customers_2.StationId where swiftfin_Customers_2.StationId=@StationID
END






GO
/****** Object:  StoredProcedure [dbo].[sp_MemberRegistrationByDate]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 22.10.2014
-- Description:	Member Registration By Date
-- =============================================
CREATE PROCEDURE [dbo].[sp_MemberRegistrationByDate] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime , 
	@EndDate Datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
	SELECT        CASE swiftfin_Customers_2.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END + ' '+ isnull(swiftfin_Customers_2.Individual_FirstName,'') +' '+ isnull(swiftfin_Customers_2.Individual_LastName,'') + isnull(swiftfin_Customers_2.NonIndividual_Description,'') as FullName, 
                         CASE swiftfin_Customers_2.Individual_Gender WHEN '1' THEN 'Male' WHEN '2' THEN 'Female' ELSE '' END AS Gender, 
                         CASE swiftfin_Customers_2.Individual_MaritalStatus WHEN '1' THEN 'Married' WHEN '2' THEN 'Single' WHEN '3' THEN 'Divorced' WHEN '4' THEN 'Separated' ELSE '' END AS MaritalStatus, swiftfin_Customers_2.Individual_IdentityCardNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Nationality WHEN 1 THEN 'Kenya' WHEN 2 THEN 'Uganda' WHEN 3 THEN 'Tanzania' WHEN 4 THEN 'Rwanda' WHEN 4 THEN 'Burundi'
                          ELSE '' END AS Nationality, RIGHT('00000' + CAST(LTRIM(RTRIM(swiftfin_Customers_2.SerialNumber)) AS VARCHAR(5)), 5) AS MembershipNumber, 
                         swiftfin_Customers_2.Individual_PayrollNumbers, swiftfin_Customers_2.Individual_BirthDate, swiftfin_Customers_2.Address_AddressLine1, 
                         swiftfin_Customers_2.Address_AddressLine2, swiftfin_Customers_2.Address_Street, swiftfin_Customers_2.Address_PostalCode, swiftfin_Customers_2.Address_City, 
                         swiftfin_Customers_2.Address_Email, swiftfin_Customers_2.Address_LandLine, swiftfin_Customers_2.Address_MobileLine, swiftfin_Customers_2.RegistrationDate, 
                         swiftfin_Customers_2.CreatedDate, 
                         --CASE swiftfin_Customers_1.Individual_Salutation WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818'
                         -- THEN 'Prof' WHEN '48819' THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN
                         -- 'Ms' ELSE 'UnKnown' END + ' ' + swiftfin_Customers_1.Individual_FirstName + ' ' + swiftfin_Customers_1.Individual_LastName AS 
                         '' as [Witness Person], 
                         dbo.swiftfin_Stations.Description AS Station, dbo.swiftfin_Zones.Description AS Zone, dbo.swiftfin_Divisions.Description AS Division, 
                         dbo.swiftfin_Employers.Description AS Employer, swiftfin_Customers_2.Individual_EmploymentDate, swiftfin_Customers_2.Individual_EmploymentDesignation, 
                         REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 5), SPACE(1), '0') AS DelegateMembershipNumber, 
                         dbo.swiftfin_Customers.Individual_PayrollNumbers AS DelegatePersonalFileNumber, LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_FirstName)) 
                         + ' ' + LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS DelegateName, swiftfin_Customers_2.Id, REPLACE(STR(swiftfin_Customers_2.SerialNumber, 6), 
                         SPACE(1), '0') AS SerialNumber, swiftfin_Customers_2.Reference1, swiftfin_Customers_2.Reference2, swiftfin_Customers_2.Reference3, swiftfin_Customers_2.CreatedBy
FROM            dbo.swiftfin_Zones INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Stations.ZoneId INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
                         dbo.swiftfin_Delegates ON dbo.swiftfin_Zones.Id = dbo.swiftfin_Delegates.ZoneId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Delegates.CustomerId = dbo.swiftfin_Customers.Id RIGHT OUTER JOIN
                         dbo.swiftfin_Customers AS swiftfin_Customers_2 ON dbo.swiftfin_Stations.Id = swiftfin_Customers_2.StationId 
WHERE swiftfin_Customers_2.CreatedDate Between @StartDate and @EndDate

END






GO
/****** Object:  StoredProcedure [dbo].[sp_Membersguarantors]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_Membersguarantors]
@customerid varchar(50),
@enddate1 datetime
as
--Select * from swiftfin_Customers where Reference1='0101-001-00009'
--exec sp_Membersguarantors 'EA6E31C7-0D2D-E811-83F4-18CF5E653998','05/02/2018'
begin
SELECT        dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.CreatedDate, 
                         dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_LoanGuarantors.CreatedBy, (dbo.swiftfin_Customers.Individual_FirstName+''+ dbo.swiftfin_Customers.Individual_LastName) as Name, dbo.swiftfin_LoanProducts.Description, 
                           dbo.swiftfin_Customers.reference1,dbo.swiftfin_LoanGuarantors.CustomerId ,sum(dbo.swiftfin_LoanCases.DisbursedAmount) AS LoanAmount,
						   abs(SUM(dbo.swiftfin_JournalEntries.Amount)) AS Balance 
FROM            dbo.swiftfin_LoanGuarantors INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_LoanGuarantors.LoaneeCustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_LoanGuarantors.LoaneeCustomerId = dbo.swiftfin_CustomerAccounts.CustomerId AND
                      dbo.swiftfin_LoanGuarantors.LoanProductId = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
                         dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId LEFT OUTER JOIN
                         dbo.swiftfin_LoanCases ON dbo.swiftfin_LoanGuarantors.LoanCaseId = dbo.swiftfin_LoanCases.Id AND dbo.swiftfin_LoanProducts.Id = dbo.swiftfin_LoanCases.LoanProductId
WHERE        (dbo.swiftfin_LoanGuarantors.CustomerId = @customerid) and dbo.swiftfin_LoanGuarantors.CreatedDate<=@enddate1 and dbo.swiftfin_LoanGuarantors.Status=0

GROUP BY dbo.swiftfin_LoanGuarantors.TotalShares, dbo.swiftfin_LoanGuarantors.CommittedShares, dbo.swiftfin_LoanGuarantors.AmountGuaranteed, dbo.swiftfin_LoanGuarantors.CreatedDate, 
                         dbo.swiftfin_LoanGuarantors.AmountPledged, dbo.swiftfin_LoanGuarantors.CreatedBy, dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_LoanProducts.Description, 
                         dbo.swiftfin_LoanGuarantors.CustomerId,dbo.swiftfin_Customers.reference1,dbo.swiftfin_LoanGuarantors.LoaneeCustomerId 
						 end


GO
/****** Object:  StoredProcedure [dbo].[sp_MembershipWithdrawal]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--sp_MembershipWithdrawal '09/01/2018','10/28/2018',1,1794

CREATE PROCEDURE [dbo].[sp_MembershipWithdrawal]
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate DateTime,
	@Status int,
	@Category int

AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT       COALESCE( ltrim(rtrim(dbo.vw_MemberRegister.Salutation)) +' ' +ltrim(rtrim(dbo.vw_MemberRegister.Individual_FirstName)),'') + ' '+ COALESCE(ltrim(rtrim(dbo.vw_MemberRegister.Individual_LastName)),'') as FullName, 
							 dbo.vw_MemberRegister.Gender, dbo.vw_MemberRegister.MembershipNumber, dbo.vw_MemberRegister.Individual_PayrollNumbers, 
							 case 
							 dbo.swiftfin_MembershipWithdrawalNotifications.Category
							 when 1792 THEN 'Deceased'
							 when 1793 THEN 'Voluntary'
							 when 1794 THEN 'Retiree'
							 End as Category
							 , 
							 CASE dbo.swiftfin_MembershipWithdrawalNotifications.Status
							 WHEN 1 THEN 'Registered'
							 WHEN 2 THEN 'Approved'
							 WHEN 4 THEN 'Verified'
							 WHEN 8 THEN 'Withdrawal Settled'
							 WHEN 16 THEN 'Deferred'
							 WHEN 32 THEN 'Death Claim Settled' END AS STATUS, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.Remarks, dbo.swiftfin_MembershipWithdrawalNotifications.CreatedBy, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.CreatedDate, dbo.swiftfin_MembershipWithdrawalNotifications.MaturityDate, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.ApprovedBy, dbo.swiftfin_MembershipWithdrawalNotifications.ApprovedDate, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.ApprovalRemarks, dbo.swiftfin_MembershipWithdrawalNotifications.AuditedBy, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.AuditedDate, dbo.swiftfin_MembershipWithdrawalNotifications.AuditRemarks, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.SettledBy, dbo.swiftfin_MembershipWithdrawalNotifications.SettledDate,swiftfin_MembershipWithdrawalSettlements.Principal,swiftfin_MembershipWithdrawalSettlements.Reference
	FROM            dbo.swiftfin_MembershipWithdrawalNotifications INNER JOIN
							 dbo.vw_MemberRegister ON dbo.swiftfin_MembershipWithdrawalNotifications.CustomerId = dbo.vw_MemberRegister.Id
						INNER JOIN
                         dbo.swiftfin_MembershipWithdrawalSettlements ON 
                         dbo.swiftfin_MembershipWithdrawalNotifications.Id = dbo.swiftfin_MembershipWithdrawalSettlements.WithdrawalNotificationId
						 INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_MembershipWithdrawalSettlements.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
	WHERE
	dbo.swiftfin_MembershipWithdrawalNotifications.Category=@Category AND
	CASE @Status
				WHEN 1 THEN dbo.swiftfin_MembershipWithdrawalNotifications.CreatedDate
				WHEN 2 THEN dbo.swiftfin_MembershipWithdrawalNotifications.ApprovedDate
				WHEN 4 THEN dbo.swiftfin_MembershipWithdrawalNotifications.AuditedDate
				WHEN 8 THEN dbo.swiftfin_MembershipWithdrawalNotifications.SettledDate
				WHEN 32 THEN dbo.swiftfin_MembershipWithdrawalNotifications.SettledDate				
	end Between @StartDate and @EndDate 
	 
END






GO
/****** Object:  StoredProcedure [dbo].[sp_MembershipWithdrawal2]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_Enumerations where [key] like '%Withdrawal%'
--select * from swiftfin_MembershipWithdrawalNotifications
--select * from swiftfin_MembershipWithdrawalSettlements where principal>0

--sp_MembershipWithdrawal2 '10/01/2018','10/28/2018',8,1794


CREATE procedure [dbo].[sp_MembershipWithdrawal2]
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate DateTime,
	@Status int,
	@Category int

AS
BEGIN
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT      COALESCE( ltrim(rtrim(dbo.vw_MemberRegister.Salutation)) +' ' +ltrim(rtrim(dbo.vw_MemberRegister.Individual_FirstName)),'') + ' '+ COALESCE(ltrim(rtrim(dbo.vw_MemberRegister.Individual_LastName)),'') as FullName,
							 dbo.vw_MemberRegister.MembershipNumber, dbo.vw_MemberRegister.Individual_PayrollNumbers, 
							 case 
							 dbo.swiftfin_MembershipWithdrawalNotifications.Category
							 when 1792 THEN 'Deceased'
							 when 1793 THEN 'Voluntary'
							 when 1794 THEN 'Retiree'
							 End as Category
							 , 
							 CASE dbo.swiftfin_MembershipWithdrawalNotifications.Status
							 WHEN 1 THEN 'Registered'
							 WHEN 2 THEN 'Approved'
							 WHEN 4 THEN 'Verified'
							 WHEN 8 THEN 'Withdrawal Settled'
							 WHEN 16 THEN 'Deferred'
							 WHEN 32 THEN 'Death Claim Settled' END AS STATUS, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.Remarks, dbo.swiftfin_MembershipWithdrawalNotifications.CreatedBy, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.CreatedDate, dbo.swiftfin_MembershipWithdrawalNotifications.MaturityDate, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.ApprovedBy, dbo.swiftfin_MembershipWithdrawalNotifications.ApprovedDate, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.ApprovalRemarks, dbo.swiftfin_MembershipWithdrawalNotifications.AuditedBy, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.AuditedDate, dbo.swiftfin_MembershipWithdrawalNotifications.AuditRemarks, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.SettledBy, dbo.swiftfin_MembershipWithdrawalNotifications.SettledDate,swiftfin_MembershipWithdrawalSettlements.Principal,swiftfin_MembershipWithdrawalSettlements.Reference,

							 isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON  dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE       (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MembershipWithdrawalNotifications.CustomerId) and swiftfin_InvestmentProducts.Code=2 and swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_JournalEntries.CreatedDate<dbo.swiftfin_MembershipWithdrawalNotifications.CreatedDate
			),0) as ShareCapital,
							 isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON  dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE       (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MembershipWithdrawalNotifications.CustomerId) and swiftfin_InvestmentProducts.Code=1 and swiftfin_JournalEntries.CreatedDate<=@EndDate and swiftfin_JournalEntries.CreatedDate<dbo.swiftfin_MembershipWithdrawalNotifications.CreatedDate
			),0) as ShareDeposit,
			isnull((

					SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE          (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MembershipWithdrawalNotifications.CustomerId) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			 and swiftfin_JournalEntries.CreatedDate<dbo.swiftfin_MembershipWithdrawalNotifications.CreatedDate
			),0)*-1 as TotalLoans,
							isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MembershipWithdrawalNotifications.CustomerId) and dbo.swiftfin_SavingsProducts.Code=1 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as OrdinarySavings


	into #temp FROM            dbo.swiftfin_MembershipWithdrawalNotifications INNER JOIN
							 dbo.vw_MemberRegister ON dbo.swiftfin_MembershipWithdrawalNotifications.CustomerId = dbo.vw_MemberRegister.Id
						INNER JOIN
                         dbo.swiftfin_MembershipWithdrawalSettlements ON 
                         dbo.swiftfin_MembershipWithdrawalNotifications.Id = dbo.swiftfin_MembershipWithdrawalSettlements.WithdrawalNotificationId
						 INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_MembershipWithdrawalSettlements.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
	WHERE
	dbo.swiftfin_MembershipWithdrawalNotifications.Category=@Category AND
	CASE @Status
				WHEN 1 THEN dbo.swiftfin_MembershipWithdrawalNotifications.CreatedDate
				WHEN 2 THEN dbo.swiftfin_MembershipWithdrawalNotifications.ApprovedDate
				WHEN 4 THEN dbo.swiftfin_MembershipWithdrawalNotifications.AuditedDate
				WHEN 8 THEN dbo.swiftfin_MembershipWithdrawalNotifications.SettledDate
				WHEN 32 THEN dbo.swiftfin_MembershipWithdrawalNotifications.SettledDate				
	end Between @StartDate and @EndDate and swiftfin_CustomerAccounts.CustomerAccountType_ProductCode=1 order by vw_MemberRegister.SerialNumber 
	 
END


select distinct * from  #temp





GO
/****** Object:  StoredProcedure [dbo].[Sp_MembersListingByAge]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[Sp_MembersListingByAge]
--exec Sp_MembersListingByAge -5000,0
@Age1  int,

@age2  int


as

begin
with Listing_cte(Name,Birthdate,AccountNumber,Age) 
as

(SELECT        (Individual_FirstName+''+Individual_LastName) as Name, Individual_BirthDate, Reference1,

isnull(datediff(yy,Individual_BirthDate,getdate()),0) as Age

FROM            dbo.swiftfin_Customers)

Select Name,Birthdate,AccountNumber,Age

from Listing_cte
where age>= @age1 and age<= @age2

order by age


end




GO
/****** Object:  StoredProcedure [dbo].[sp_MembersProductBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- sp_MembersProductBalances '04/30/2018'

CREATE Proc [dbo].[sp_MembersProductBalances]

@EndDate DateTime

AS

SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, Products_1.Description,Products_1.id,dbo.vw_CustomerAccounts.BranchId, isnull(sum(dbo.swiftfin_JournalEntries.Amount),0) as  Amount
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id AND dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.ChartOfAccountId

						 where dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
						 group by  dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, Products_1.Description,Products_1.id,dbo.vw_CustomerAccounts.BranchId
						 having sum(dbo.swiftfin_JournalEntries.Amount)<>0
						 --order by type desc

						-- select * from dbo.Products(0)
						--select * from vw_customeraccounts
GO
/****** Object:  StoredProcedure [dbo].[sp_MicroCreditColletionSheet]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.05.2018
-- Description:	MicroCreditColletionSheet
-- =============================================
--[sp_MicroCreditColletionSheet] '05/03/2018',''
Create  PROCEDURE [dbo].[sp_MicroCreditColletionSheet] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime,
	@GroupID varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
			SELECT        dbo.vw_Customers.FullName,dbo.vw_Customers.Reference1 as FullAccountNumber,
                           dbo.vw_Customers.Gender ,               		
			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MicroCreditGroupMembers.CustomerId ) AND 
									 (dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection = 1) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as BosaLoans,
			isnull((
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MicroCreditGroupMembers.CustomerId) AND 
									 (dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection = 0) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as FosaLoans,
		
						isnull((
			
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MicroCreditGroupMembers.CustomerId) and swiftfin_InvestmentProducts.Code=7 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as MicroPremiums,'Members' as Description


       	FROM            dbo.swiftfin_MicroCreditGroupMembers INNER JOIN
                         dbo.vw_Customers ON dbo.swiftfin_MicroCreditGroupMembers.CustomerId = dbo.vw_Customers.Id
	     WHERE MicroCreditGroupId=@GroupID


END


GO
/****** Object:  StoredProcedure [dbo].[sp_MicroCreditGroupMembers]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---sp_MicroCreditGroupMembers '420AA919-1E36-CEB1-7368-08D1A69A1873'
CREATE PROCEDURE [dbo].[sp_MicroCreditGroupMembers]
	@GroupID varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        dbo.vw_Customers.FullName,dbo.vw_Customers.Reference1 as FullAccountNumber,
                         CASE dbo.swiftfin_MicroCreditGroupMembers.Designation WHEN 1 THEN 'Chairperson' WHEN 2 THEN 'Deputy Chairperson' WHEN 4 THEN 'Secretary' WHEN 8 THEN 'Deputy Secretary'
                          WHEN 16 THEN 'Treasurer' WHEN 32 THEN 'Ordinary Member' END AS MicroCreditGroupMemberDesignation, dbo.vw_Customers.Gender, 
                         dbo.vw_Customers.Individual_IdentityCardNumber, dbo.vw_Customers.MembershipNumber, dbo.swiftfin_MicroCreditGroupMembers.LoanCycle, dbo.vw_Customers.Reference1,dbo.swiftfin_customers.NonIndividual_Description,dbo.swiftfin_customers.Reference1 as groupacno
						-- swiftfin_MicroCreditGroupMembers as GroupAcno

	FROM            swiftfin_MicroCreditGroupMembers INNER JOIN
                         vw_Customers ON swiftfin_MicroCreditGroupMembers.CustomerId = vw_Customers.Id INNER JOIN
                         swiftfin_MicroCreditGroups ON swiftfin_MicroCreditGroupMembers.MicroCreditGroupId = swiftfin_MicroCreditGroups.Id INNER JOIN
                         swiftfin_Customers ON swiftfin_MicroCreditGroups.CustomerId = swiftfin_Customers.Id
	WHERE MicroCreditGroupId=@GroupID
END

--select * from swiftfin_microcreditgroupmembers
---select * from swiftfin_microcreditgroups






GO
/****** Object:  StoredProcedure [dbo].[sp_MicroCreditGroupsListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Jeff>
-- Create date: <28/09/2014>
-- Description:	<Listing Micro-Credit Groups>
-- =============================================
---sp_MicroCreditGroupsListing '12/29/2015'
CREATE PROCEDURE [dbo].[sp_MicroCreditGroupsListing] (@CreatedDate as Datetime)
AS
BEGIN
	SET NOCOUNT ON;
	set @CreatedDate=	(select DATEADD(day, DATEDIFF(day, 0, @CreatedDate), '23:59:59'));
	SELECT       SerialNumber = REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0')  , dbo.swiftfin_Customers.NonIndividual_Description as GroupName, dbo.swiftfin_Customers.NonIndividual_RegistrationNumber as RegistrationNumber, 
							 dbo.swiftfin_Customers.NonIndividual_DateEstablished as DateEstablished,  
							 Case  dbo.swiftfin_MicroCreditGroups.Type
							 WHEN 1 THEN 'ROSCA'
							 WHEN 2 THEN 'ASCA'
							 WHEN 3 THEN 'Table Banking'
							 END AS MicroCreditGroupType ,dbo.swiftfin_Customers.Address_AddressLine1, 
							 dbo.swiftfin_Customers.Address_AddressLine2, dbo.swiftfin_Customers.Address_Street, dbo.swiftfin_Customers.Address_PostalCode, dbo.swiftfin_Customers.Address_City, 
							 dbo.swiftfin_Customers.Address_Email, dbo.swiftfin_Customers.Address_LandLine, dbo.swiftfin_Customers.Address_MobileLine, 
							 dbo.vw_EmployeeRegister.FullName AS MicroCreditOfficer, dbo.swiftfin_MicroCreditGroups.Id
	FROM            dbo.swiftfin_MicroCreditGroups INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_MicroCreditGroups.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_MicroCreditOfficers ON dbo.swiftfin_MicroCreditGroups.MicroCreditOfficerId = dbo.swiftfin_MicroCreditOfficers.Id INNER JOIN
							 dbo.vw_EmployeeRegister ON dbo.swiftfin_MicroCreditOfficers.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID
	WHERE swiftfin_MicroCreditGroups.CreatedDate<=@CreatedDate
END







GO
/****** Object:  StoredProcedure [dbo].[sp_MicroCreditSearchGroupsListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Jeff>
-- Create date: <28/09/2014>
-- Description:	<Listing Micro-Credit Groups>
-- =============================================
---sp_MicroCreditSearchGroupsListing 'Group'
CREATE PROCEDURE [dbo].[sp_MicroCreditSearchGroupsListing] (@SearchStrg varchar(50))
AS
BEGIN
	SET NOCOUNT ON;
		set @SearchStrg=upper(@SearchStrg)
	SELECT       SerialNumber = REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0')  , dbo.swiftfin_Customers.NonIndividual_Description as GroupName, 
	dbo.swiftfin_MicroCreditGroups.Id
	FROM            dbo.swiftfin_MicroCreditGroups INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_MicroCreditGroups.CustomerId = dbo.swiftfin_Customers.Id 							 
	 WHERE (upper(dbo.swiftfin_Customers.NonIndividual_Description) like '%'+@SearchStrg+'%')
	  order by REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0')
END







GO
/****** Object:  StoredProcedure [dbo].[sp_MicroCreditSingleGroupsListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Jeff>
-- Create date: <28/09/2014>
-- Description:	<Listing Micro-Credit Groups>
-- =============================================
---sp_MicroCreditSingleGroupsListing 'C59A7F72-F23E-E811-80D1-F40343552CF9'
CREATE  PROCEDURE [dbo].[sp_MicroCreditSingleGroupsListing] (@GroupID varchar(50))
AS
BEGIN
	SET NOCOUNT ON;
	SELECT       SerialNumber = REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0')  , dbo.swiftfin_Customers.NonIndividual_Description as GroupName, dbo.swiftfin_Customers.NonIndividual_RegistrationNumber as RegistrationNumber, 
							 dbo.swiftfin_Customers.NonIndividual_RegistrationNumber as PersonalIdentificationNumber, dbo.swiftfin_Customers.NonIndividual_DateEstablished as DateEstablished,  
							 Case  dbo.swiftfin_MicroCreditGroups.Type
							 WHEN 1 THEN 'ROSCA'
							 WHEN 2 THEN 'ASCA'
							 WHEN 3 THEN 'Table Banking'
							 END AS MicroCreditGroupType ,dbo.swiftfin_Customers.Address_AddressLine1, 
							 dbo.swiftfin_Customers.Address_AddressLine2, dbo.swiftfin_Customers.Address_Street, dbo.swiftfin_Customers.Address_PostalCode, dbo.swiftfin_Customers.Address_City, 
							 dbo.swiftfin_Customers.Address_Email, dbo.swiftfin_Customers.Address_LandLine, dbo.swiftfin_Customers.Address_MobileLine, 
							 dbo.vw_EmployeeRegister.FullName AS MicroCreditOfficer, dbo.swiftfin_MicroCreditGroups.Id
	FROM            dbo.swiftfin_MicroCreditGroups INNER JOIN
							 dbo.swiftfin_Customers ON dbo.swiftfin_MicroCreditGroups.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
							 dbo.swiftfin_MicroCreditOfficers ON dbo.swiftfin_MicroCreditGroups.MicroCreditOfficerId = dbo.swiftfin_MicroCreditOfficers.Id INNER JOIN
							 dbo.vw_EmployeeRegister ON dbo.swiftfin_MicroCreditOfficers.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID
	WHERE swiftfin_MicroCreditGroups.ID=@GroupID
END

GO
/****** Object:  StoredProcedure [dbo].[sp_MicroCreditStatistics]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.05.2018
-- Description:	MicroCreditStatistics
-- =============================================
--[sp_MicroCreditStatistics] '05/03/2018','6F676B52-193F-E811-80D1-F40343552CF9'
CREATE PROCEDURE [dbo].[sp_MicroCreditStatistics] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime,
	@GroupID varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
			SELECT        dbo.vw_Customers.FullName,dbo.vw_Customers.Reference1 as FullAccountNumber,
                           dbo.vw_Customers.Gender ,               		
			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MicroCreditGroupMembers.CustomerId ) AND 
									 dbo.swiftfin_LoanProducts.ChartOfAccountId in(select  id from swiftfin_ChartOfAccounts where CostCenterId ='8B5FDB43-052C-E811-8320-507B9DA391CE') and 
									 swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0)*-1 as Loans,
			--isnull((
			--SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			--FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
			--						 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
			--						 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
			--						 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			--WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MicroCreditGroupMembers.CustomerId) AND 
			--						 (dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection = 0) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			--),0)*-1 as FosaLoans,
		
						isnull((
			
			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_MicroCreditGroupMembers.CustomerId) and swiftfin_InvestmentProducts.Code=7 and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as MicroPremiums,'Members' as Description


       	FROM            dbo.swiftfin_MicroCreditGroupMembers INNER JOIN
                         dbo.vw_Customers ON dbo.swiftfin_MicroCreditGroupMembers.CustomerId = dbo.vw_Customers.Id
	     WHERE MicroCreditGroupId=@GroupID


END


GO
/****** Object:  StoredProcedure [dbo].[sp_ModifiedAccountsByDate]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_Customers where ModifiedDate != '2018-11-06 ' 

CREATE proc [dbo].[sp_ModifiedAccountsByDate]
--sp_ModifiedAccountsByDate '2018-11-06' ,'2018-11-06'
@StartDate Datetime,
    @EndDate DateTime

as
begin
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
SELECT        Individual_FirstName+' '+ Individual_LastName as FullName, Individual_PayrollNumbers as PayrollNo, Address_MobileLine as PhoneNo, Reference1 as AccountNo, ModifiedBy, ModifiedDate
FROM            dbo.swiftfin_Customers 
  where ModifiedDate is not null and ModifiedDate BETWEEN @StartDate and @EndDate 
end
GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyDefaulters]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---select * from swiftfin_branches
--select * from swiftfin_customers

--[sp_MonthlyDefaulters] 0,'05/31/2018'
CREATE procedure [dbo].[sp_MonthlyDefaulters]
(
	@GracePeriod int=0,
	@EndDate as Datetime

)
as
SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
 with LoanProductBalances (AccountNo,Reference1,Reference2,Reference3,AccountName,Balance,Interest,LoanName,branch,dept)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId),
		swiftfin_Branches.id,dbo.vw_CustomerAccounts.Address_AddressLine2
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								  dbo.swiftfin_branches on dbo.vw_CustomerAccounts.BranchId=dbo.swiftfin_branches.id inner join
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)  
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId,swiftfin_Branches.id,dbo.vw_CustomerAccounts.Address_AddressLine2
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0,(select Description from swiftfin_LoanProducts where ID =vw_CustomerAccounts.CustomerAccountType_TargetProductId),
		swiftfin_Branches.id,dbo.vw_CustomerAccounts.Address_AddressLine2
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								  dbo.swiftfin_branches on dbo.vw_CustomerAccounts.BranchId=dbo.swiftfin_branches.id inner join
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,CustomerAccountType_TargetProductId,swiftfin_Branches.id,dbo.vw_CustomerAccounts.Address_AddressLine2
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,SUM(Balance) AS Balance,
	sum(Interest) as Interest,LoanName,branch,dept
	into #temp3_ FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,AccountName,LoanProductBalances.LoanName,branch,dept having SUM(Balance) <>0;



with  Frequency_CTE (pf_no,Ttype,LastTrxDate,Balance,Description)
AS
(
	select isnull(fosa_acno,''),ttype,(select max(trdate)  from fosa.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype 
	and docid not in ('206') and credit>0 )  as TrxDate,(select sum(debit-credit) from fosa.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno 
	and ttype=Loanhist1.ttype) as balance,(select ltrim(accountname) from fosa.dbo.lntypes1 where code=Loanhist1.ttype) from fosa.dbo.Loanhist as Loanhist1    group by fosa_acno,ttype 

)

select 
(select top 1 Name from fosa.dbo.customer  where fosa_acno= Frequency_CTE.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
(select top 1 Description from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as LoanName,
 '001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTE.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
 (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTE.Description COLLATE Latin1_General_CI_AS) as FullAccount
 into #temp1 from Frequency_CTE where BAlance<>0 ;


--WITH Frequency_CTEFOSA (pf_no,Ttype,LastTrxDate,Balance,Description)
--AS
--(
--	select fosa_acno,ttype,(select max(trdate)  from fosa.dbo.loanhist  where fosa_acno=Loanhist1.fosa_acno and ttype=Loanhist1.ttype and docid not in ('2206') ) 
--	 as TrxDate,(select sum(isnull(debit,0)-isnull(credit,0)) from fosa.dbo.loanhist  where fosa_acno= Loanhist1.fosa_acno and ttype=Loanhist1.ttype) as balance,(select desc_ from 
--	 fosa.dbo.advtypes where code=Loanhist1.ttype) from fosa.dbo.Loanhist as Loanhist1 where left(ttype,1)='A' group by fosa_acno,ttype 

--)

--select 
--(select Name from fosa.dbo.customer  where fosa_acno= Frequency_CTEFOSA.pf_no) as Name,Balance,pf_no,LastTrxDate,datediff(mm,LastTrxDate,@EndDate) as DefaultFrequency,
--(select Description from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.Description COLLATE Latin1_General_CI_AS) as LoanName,
-- ltrim(rtrim('001-'+(select top 1  REPLACE(STR(SerialNumber, 6), SPACE(1), '0') from swiftfin_Customers where Reference1=Frequency_CTEFOSA.pf_no COLLATE Latin1_General_CI_AS)+'-002-'+
-- (select REPLACE(STR(Code, 3), SPACE(1), '0') from swiftfin_LoanProducts where Description=Frequency_CTEFOSA.description COLLATE Latin1_General_CI_AS))) as FullAccount
-- into #tempFosa from Frequency_CTEFOSA where BAlance>0 



-- SELECT  vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId 
-- and CreatedDate<=@EndDate),0)*-1 as Balance ,
--vw_CustomerAccounts.Reference1, 

--isnull((SELECT     top 1    isnull(Schedule_ActualRunDate,'08/01/2016')
--FROM            dbo.swiftfin_StandingOrders
--WHERE        BeneficiaryCustomerAccountId = vw_CustomerAccounts.Id),'08/01/2016') as LastActivity

--, dbo.swiftfin_LoanProducts.Description as LoanName, 
--                         dbo.vw_CustomerAccounts.FullAccount
--into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
--                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id

SELECT        vw_CustomerAccounts.FullName,isnull((select sum(amount) from swiftfin_JournalEntries where CustomerAccountId=vw_CustomerAccounts.Id and ChartOfAccountId=swiftfin_LoanProducts.ChartOfAccountId and CreatedDate<=@EndDate),0)*-1 as Balance ,
vw_CustomerAccounts.reference1, (SELECT        MAX(dbo.swiftfin_JournalEntries.CreatedDate) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = vw_CustomerAccounts.Id) AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_LoanProducts.ChartOfAccountId) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate and amount>0)) as LastActivity
, dbo.swiftfin_LoanProducts.Description as LoanName, 
                         dbo.vw_CustomerAccounts.FullAccount
into #temp2_ FROM             dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id



select *,datediff(mm,isnull(#temp2_.LastActivity,'05/11/2018'),@EndDate) as DefaultFrequency into #temp2 from #temp2_	where LastActivity IS NOT NULL AND BALANCE<>0	


 

CREATE  CLUSTERED INDEX IX_1 on #temp2 (fullAccount)

insert into #temp2(FullName,Balance,Reference1,LastActivity,DefaultFrequency,LoanName,FullAccount) 
select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount from #Temp1  ---where FullAccount not in (select FullAccount from #temp2)

--insert into #temp2(FullName,Balance,Reference1,LastActivity,DefaultFrequency,LoanName,FullAccount) 
--select Name,Balance,pf_no,LastTrxDate,DefaultFrequency,LoanName,FullAccount from #tempFosa ---- where FullAccount not in (select FullAccount from #temp2) 



select *,AccountNo as FullAccount,AccountName as FullName,isnull((select max(lastactivity) from #temp2 where FullAccount=#temp3_.AccountNo and 
lastactivity<=@EndDate),@EndDate)  as lastactivity into #temp3 from  #temp3_ where balance>0





select distinct FullName,Balance,LastActivity,reference1,dept,branch,
case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end as ClassOrder

,case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 'Performing'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 'Watch'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 'Substandard'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 'Doubtful'
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 'Loss'
end as Classification,

DATEDIFF(MM,LastActivity,@EndDate) as DefaultFrequency,FullAccount,LoanName,
(select LoanRegistration_LoanProductSection from swiftfin_LoanProducts where Description=#temp3.LoanName) as ProductSection,

case 
WHEN DATEDIFF(MM,LastActivity,@EndDate)<=2 THEN 1
WHEN DATEDIFF(MM,LastActivity,@EndDate)>2 and DATEDIFF(MM,LastActivity,@EndDate)<=4 THEN 5
WHEN DATEDIFF(MM,LastActivity,@EndDate)>4 and DATEDIFF(MM,LastActivity,@EndDate)<=6 THEN 25
WHEN DATEDIFF(MM,LastActivity,@EndDate)>6 and DATEDIFF(MM,LastActivity,@EndDate)<=12 THEN 50
WHEN DATEDIFF(MM,LastActivity,@EndDate)>12 THEN 100
end *Balance *0.01 as provision_amount
 from #temp3 where  DATEDIFF(mm,LastActivity,@EndDate)>@GracePeriod and balance>0   order by DATEDIFF(MM,LastActivity,@EndDate),FullAccount,LoanName 






GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyIncome]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--sp_MonthlyIncome '09/01/2017','09/30/2017'
create PROC [dbo].[sp_MonthlyIncome]
@StartDate DateTime,
@EndDate DateTime

AS

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, sum(dbo.swiftfin_JournalEntries.Amount) as Amount
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
						 where dbo.swiftfin_ChartOfAccounts.AccountType=4000 and dbo.swiftfin_JournalEntries.CreatedDate between @StartDate and @EndDate
						 group by dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName

GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyInterestDefaulted]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--select * from swiftfin_StandingOrderHistories
--[sp_MonthlyInterestDefaulted] '12/31/2018','9C18904A-EABB-E811-A815-000C29142092'
---select id, description from swiftfin_Loanproducts

create procedure [dbo].[sp_MonthlyInterestDefaulted] (@EndDate DateTime,@Loanproduct UniqueIdentifier)
as


With CTEMonthlyPrinciaplDefaulted (AccountNo,FullName,Amount,Month)
as
(
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=1  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=2  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=3  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=4  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=5  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=6  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=7  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=8  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=9  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=10  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union

SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=11  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  InterestArrears,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=12  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName  
), 
 CTEResults (AccountNo,Name,January,February,March,April,May,June,July,August,September,October,November,December)
as
(
select AccountNo,FullName,

case when Month=1 then round(isnull(sum(Amount),0),2) else 0  end as January,
case when Month=2 then round(sum(Amount),2) else 0 end as February,
case when Month=3 then round(sum(Amount),2) else 0 end as March,
case when Month=4 then round(sum(Amount),2) else 0  end as April,
case when Month=5 then round(sum(Amount),2) else 0 end as May,
case when Month=6 then round(sum(Amount),2) else 0 end as June,
case when Month=7 then round(sum(Amount),2) else 0 end as July,
case when Month=8 then round(sum(Amount),2) else 0 end as August,
case when Month=9 then round(sum(Amount),2) else 0 end as September,
case when Month=10 then round(sum(Amount),2) else 0  end as October,
case when Month=11 then round(sum(Amount),2) else 0 end as November,
case when Month=12 then round(sum(Amount),2) else 0 end as December
 from CTEMonthlyPrinciaplDefaulted where Amount>0 group by  AccountNo,FullName,Month
 )
select AccountNo,Name, 
sum(January) as January,
sum(February) as February, 
Sum(March) as March,
sum(April) as April, 
sum(May) as May, 
sum(June) as June, 
sum(July) as July, 
sum(August) as August, 
sum(September) as September,
sum(October) as October,
sum(November) as November,
sum(December) as December

 from CTEResults group by AccountNo,Name
 order by AccountNo






GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyInterestDefaultedTest]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



--select * from swiftfin_StandingOrderHistories
--[sp_MonthlyInterestDefaultedTest] '11/03/2017', '12/31/2018','9C18904A-EABB-E811-A815-000C29142092'
---select id, description from swiftfin_Loanproducts

create procedure [dbo].[sp_MonthlyInterestDefaultedTest] 
(@StartDate DateTime,
@EndDate datetime,
@Loanproduct UniqueIdentifier)
as


With CTEMonthlyPrinciaplDefaulted (AccountNo,FullName,Amount,Month)
as
(
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=1  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate  and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=2  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=3  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=4  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=5  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=6  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=7  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=8  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=9  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=10  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union

SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=11  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 sum(dbo.swiftfin_StandingOrderHistories.ExpectedInterest-dbo.swiftfin_StandingOrderHistories.ActualInterest) as  InterestArrears,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=12  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName  
), 
 CTEResults (AccountNo,Name,January,February,March,April,May,June,July,August,September,October,November,December)
as
(
select AccountNo,FullName,

case when Month=1 then round(isnull(sum(Amount),0),2) else 0  end as January,
case when Month=2 then round(sum(Amount),2) else 0 end as February,
case when Month=3 then round(sum(Amount),2) else 0 end as March,
case when Month=4 then round(sum(Amount),2) else 0  end as April,
case when Month=5 then round(sum(Amount),2) else 0 end as May,
case when Month=6 then round(sum(Amount),2) else 0 end as June,
case when Month=7 then round(sum(Amount),2) else 0 end as July,
case when Month=8 then round(sum(Amount),2) else 0 end as August,
case when Month=9 then round(sum(Amount),2) else 0 end as September,
case when Month=10 then round(sum(Amount),2) else 0  end as October,
case when Month=11 then round(sum(Amount),2) else 0 end as November,
case when Month=12 then round(sum(Amount),2) else 0 end as December
 from CTEMonthlyPrinciaplDefaulted where Amount>0 group by  AccountNo,FullName,Month
 )
select AccountNo,Name, 
sum(January) as January,
sum(February) as February, 
Sum(March) as March,
sum(April) as April, 
sum(May) as May, 
sum(June) as June, 
sum(July) as July, 
sum(August) as August, 
sum(September) as September,
sum(October) as October,
sum(November) as November,
sum(December) as December

 from CTEResults group by AccountNo,Name
 order by AccountNo






GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyInterestEarned]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[sp_MonthlyInterestEarned]

-- [sp_MonthlyInterestEarned] '41A31650-E9BB-E811-A815-000C29142092'
 -- select id, description from swiftfin_loanproducts
 -- Add the parameters for the stored procedure here
 @ProductID uniqueidentifier
AS

BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 

With LoanProductBalances(Reference1,Reference3,AccountName,Description,ProductID, PayrollNumber,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December)
 AS
 (
  
  SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference3, 
  dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.CustomerAccountType_TargetProductId,dbo.vw_customeraccounts.Individual_PayrollNumbers,
  isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=1 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as January,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=2 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as February,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=3 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as March,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=4 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as April,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=5 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as May,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=6 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as June,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=7 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as July,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=8 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as August,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=9 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as September,
						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=10 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as October,

						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=11 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as November,

						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=12 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as December





  FROM            dbo.vw_CustomerAccounts --where CustomerAccountType_TargetProductCode=2
  
  --GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
  --dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers
  )
 SELECT Reference1,Reference3 ,
 AccountName,Description,PayrollNumber,ProductID,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December
 FROM LoanProductBalances where Jan+Feb+March+Apr+May+June+July+Aug+Sept+Oct+Nov+December<>0 and ProductID = @ProductID 

 --Group By Reference1,Reference3,AccountName,Description,ProductID,PayrollNumber,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December --having SUM(Amount)<>0
 END

GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyInterestReceived]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[sp_MonthlyInterestReceived]

-- [sp_MonthlyInterestReceived] 'AACCD9E2-ECBB-E811-A815-000C29142092'
 -- select id, description from swiftfin_loanproducts
 -- Add the parameters for the stored procedure here
 @ProductID uniqueidentifier
AS

BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 

With LoanProductBalances(Reference1,Reference3,AccountName,Description,ProductID, PayrollNumber,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December)
 AS
 (
  
  SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference3, 
  dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.CustomerAccountType_TargetProductId,dbo.vw_customeraccounts.Individual_PayrollNumbers,
  isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=1 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as January,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=2 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as February,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=3 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as March,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=4 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as April,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=5 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as May,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=6 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as June,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=7 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as July,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=8 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as August,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=9 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as September,
						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=10 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as October,

						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=11 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as November,

						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivedChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=12 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as December





  FROM            dbo.vw_CustomerAccounts --where CustomerAccountType_TargetProductCode=2
  
  --GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
  --dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers
  )
 SELECT Reference1,Reference3 ,
 AccountName,Description,PayrollNumber,ProductID,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December
 FROM LoanProductBalances where Jan+Feb+March+Apr+May+June+July+Aug+Sept+Oct+Nov+December<>0 and ProductID = @ProductID 

 --Group By Reference1,Reference3,AccountName,Description,ProductID,PayrollNumber,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December --having SUM(Amount)<>0
 END

GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyLoanAdvances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_MonthlyLoanAdvances]

-- [sp_MonthlyLoanAdvances] '41A31650-E9BB-E811-A815-000C29142092'
 -- select id, description from swiftfin_loanproducts
 -- Add the parameters for the stored procedure here
 @ProductID uniqueidentifier
AS

BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 

With LoanProductBalances(Reference1,Reference3,AccountName,Description,ProductID, PayrollNumber,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December)
 AS
 (
  
  SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference3, 
  dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.CustomerAccountType_TargetProductId,dbo.vw_customeraccounts.Individual_PayrollNumbers,
  isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=1 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as January,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=2 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as February,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=3 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as March,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=4 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as April,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=5 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as May,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=6 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as June,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=7 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as July,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=8 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as August,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=9 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as September,
						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=10 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as October,

						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=11 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as November,

						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=12 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as December





  FROM            dbo.vw_CustomerAccounts --where CustomerAccountType_TargetProductCode=2
  
  --GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
  --dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers
  )
 SELECT Reference1,Reference3 ,
 AccountName,Description,PayrollNumber,ProductID,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December
 FROM LoanProductBalances where Jan+Feb+March+Apr+May+June+July+Aug+Sept+Oct+Nov+December<>0 and ProductID = @ProductID 

 --Group By Reference1,Reference3,AccountName,Description,ProductID,PayrollNumber,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December --having SUM(Amount)<>0
 END

GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyPrincipalDefaulted]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--[sp_MonthlyPrincipalDefaulted] '12/31/2018','9C18904A-EABB-E811-A815-000C29142092'
---select id, description from swiftfin_Loanproducts

CREATE procedure [dbo].[sp_MonthlyPrincipalDefaulted] (@EndDate DateTime,@Loanproduct UniqueIdentifier)
as


With CTEMonthlyPrinciaplDefaulted (AccountNo,FullName,Amount,Month)
as
(
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=1  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=2  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=3  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=4  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=5  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=6  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=7  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=8  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=9  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=10  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union

SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=11  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  PrincipalArrears,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=12  and year(swiftfin_StandingOrderHistories.CreatedDate)=Year(@EndDate) and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName  
), 
 CTEResults (AccountNo,Name,January,February,March,April,May,June,July,August,September,October,November,December)
as
(
select AccountNo,FullName,

case when Month=1 then round(isnull(sum(Amount),0),2) else 0  end as January,
case when Month=2 then round(sum(Amount),2) else 0 end as February,
case when Month=3 then round(sum(Amount),2) else 0 end as March,
case when Month=4 then round(sum(Amount),2) else 0  end as April,
case when Month=5 then round(sum(Amount),2) else 0 end as May,
case when Month=6 then round(sum(Amount),2) else 0 end as June,
case when Month=7 then round(sum(Amount),2) else 0 end as July,
case when Month=8 then round(sum(Amount),2) else 0 end as August,
case when Month=9 then round(sum(Amount),2) else 0 end as September,
case when Month=10 then round(sum(Amount),2) else 0  end as October,
case when Month=11 then round(sum(Amount),2) else 0 end as November,
case when Month=12 then round(sum(Amount),2) else 0 end as December
 from CTEMonthlyPrinciaplDefaulted where Amount>0 group by  AccountNo,FullName,Month
 )
select AccountNo,Name, 
sum(January) as January,
sum(February) as February, 
Sum(March) as March,
sum(April) as April, 
sum(May) as May, 
sum(June) as June, 
sum(July) as July, 
sum(August) as August, 
sum(September) as September,
sum(October) as October,
sum(November) as November,
sum(December) as December

 from CTEResults group by AccountNo,Name
 order by AccountNo






GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyPrincipalDefaultedTest]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




--select * from swiftfin_StandingOrderHistories
--[sp_MonthlyPrincipalDefaultedTest] '11/03/2017', '12/31/2018','9C18904A-EABB-E811-A815-000C29142092'
---select id, description from swiftfin_Loanproducts

create procedure [dbo].[sp_MonthlyPrincipalDefaultedTest] 
(@StartDate DateTime,
@EndDate datetime,
@Loanproduct UniqueIdentifier)
as


With CTEMonthlyPrinciaplDefaulted (AccountNo,FullName,Amount,Month)
as
(
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=1  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate  and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=2  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=3  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=4  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=5  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=6  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=7  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=8  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName 
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=9  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=10  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union

SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 Sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  Amount,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=11  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName
union
SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName as Name,
			 sum(dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal-dbo.swiftfin_StandingOrderHistories.ActualPrincipal) as  PrincipalArrears,12 AS Month
							 
				            
							
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   ( month(swiftfin_StandingOrderHistories.CreatedDate)=12  and swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
	        and Products_1.id=@Loanproduct
			GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName  
), 
 CTEResults (AccountNo,Name,January,February,March,April,May,June,July,August,September,October,November,December)
as
(
select AccountNo,FullName,

case when Month=1 then round(isnull(sum(Amount),0),2) else 0  end as January,
case when Month=2 then round(sum(Amount),2) else 0 end as February,
case when Month=3 then round(sum(Amount),2) else 0 end as March,
case when Month=4 then round(sum(Amount),2) else 0  end as April,
case when Month=5 then round(sum(Amount),2) else 0 end as May,
case when Month=6 then round(sum(Amount),2) else 0 end as June,
case when Month=7 then round(sum(Amount),2) else 0 end as July,
case when Month=8 then round(sum(Amount),2) else 0 end as August,
case when Month=9 then round(sum(Amount),2) else 0 end as September,
case when Month=10 then round(sum(Amount),2) else 0  end as October,
case when Month=11 then round(sum(Amount),2) else 0 end as November,
case when Month=12 then round(sum(Amount),2) else 0 end as December
 from CTEMonthlyPrinciaplDefaulted where Amount>0 group by  AccountNo,FullName,Month
 )
select AccountNo,Name, 
sum(January) as January,
sum(February) as February, 
Sum(March) as March,
sum(April) as April, 
sum(May) as May, 
sum(June) as June, 
sum(July) as July, 
sum(August) as August, 
sum(September) as September,
sum(October) as October,
sum(November) as November,
sum(December) as December

 from CTEResults group by AccountNo,Name
 order by AccountNo






GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyPrincipalRecovered]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




create PROCEDURE [dbo].[sp_MonthlyPrincipalRecovered]

-- [sp_MonthlyPrincipalRecovered] '41A31650-E9BB-E811-A815-000C29142092'
 -- select id, description from swiftfin_loanproducts
 -- Add the parameters for the stored procedure here
 @ProductID uniqueidentifier
AS

BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 

With LoanProductBalances(Reference1,Reference3,AccountName,Description,ProductID, PayrollNumber,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December)
 AS
 (
  
  SELECT      dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference3, 
  dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.CustomerAccountType_TargetProductId,dbo.vw_customeraccounts.Individual_PayrollNumbers,
  isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=1 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as January,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=2 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as February,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=3 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as March,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=4 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as April,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=5 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as May,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=6 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as June,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=7 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as July,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=8 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as August,

						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=9 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as September,
						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=10 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as October,

						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=11 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as November,

						  						    isnull((select sum(dbo.swiftfin_JournalEntries.Amount)
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
						 where dbo.swiftfin_JournalEntries.Amount>0 and 
						 month(dbo.swiftfin_JournalEntries.CreatedDate)=12 and  dbo.swiftfin_LoanProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId and 
						  dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id ),0) as December





  FROM            dbo.vw_CustomerAccounts --where CustomerAccountType_TargetProductCode=2
  
  --GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
  --dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers
  )
 SELECT Reference1,Reference3 ,
 AccountName,Description,PayrollNumber,ProductID,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December
 FROM LoanProductBalances where Jan+Feb+March+Apr+May+June+July+Aug+Sept+Oct+Nov+December<>0 and ProductID = @ProductID 

 --Group By Reference1,Reference3,AccountName,Description,ProductID,PayrollNumber,Jan,Feb,March,Apr,May,June,July,Aug,Sept,Oct,Nov,December --having SUM(Amount)<>0
 END

GO
/****** Object:  StoredProcedure [dbo].[sp_NegativeLoanProductBalanceAndInterest]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
--SELECT * FROM swiftfin_LoanProducts
--sp_NegativeLoanProductBalanceAndInterest '05/31/2018'
CREATE PROCEDURE [dbo].[sp_NegativeLoanProductBalanceAndInterest] 
	-- Add the parameters for the stored procedure here
	--@ProductID uniqueidentifier, 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With LoanProductBalances(AccountNo,Reference1,Reference2,Reference3,LoanDescription,LoanId,AccountName,Balance,Interest)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.Id,
		dbo.vw_CustomerAccounts.FullName, 0,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        --dbo.swiftfin_LoanProducts.id = @ProductID and 
		dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.swiftfin_LoanProducts.Description,
		dbo.swiftfin_LoanProducts.Id,dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.FullAccount
		UNION ALL
		SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.Id,
		dbo.vw_CustomerAccounts.FullName, 
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,0
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        --dbo.swiftfin_LoanProducts.id = @ProductID and 
		dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.Id,
		dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.FullAccount
	)
	SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 , LoanDescription, LoanId, AccountName,SUM(Balance) AS Balance,sum(Interest) as Interest 
	FROM LoanProductBalances 
	Group By AccountNo,Reference1,Reference2,Reference3,LoanDescription, LoanId, AccountName having   sum(Interest)<0 --and SUM(Balance) <0 
END

GO
/****** Object:  StoredProcedure [dbo].[sp_NegativeSavingsBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan>
-- Create date: <Create Date, 18/11/2015>
-- Description:	<Description, Negative Savings Balances>
-- =============================================
---- sp_NegativeSavingsBalance  '06/30/2018'
CREATE PROCEDURE [dbo].[sp_NegativeSavingsBalance]
	-- Add the parameters for the stored procedure here
	@EndDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	With NegativeBalanceCTE(Balance, FullName, AccountType, AccountNo,Address_MobileLine,LastTrxDATE)
As 
(
SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance, isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + isnull(dbo.swiftfin_Customers.Individual_LastName,'') as FullName, dbo.swiftfin_SavingsProducts.Description, 
                         dbo.swiftfin_Customers.Reference1,dbo.swiftfin_Customers.Address_MobileLine,
						 (SELECT        MAX(CREATEDDATE) AS Expr1
                               FROM            dbo.swiftfin_JournalEntries
                               WHERE        (CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id)) AS LastTrxDate
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId
WHERE  dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
GROUP BY dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_SavingsProducts.Description, dbo.swiftfin_Customers.Reference1,
dbo.swiftfin_Customers.Address_MobileLine,dbo.swiftfin_CustomerAccounts.Id
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) < 0)
)
Select * from NegativeBalanceCTE
END






GO
/****** Object:  StoredProcedure [dbo].[sp_NetLoanAppraised]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_NetLoanAppraised '04/01/2018','05/19/2018'
CREATE PROC [dbo].[sp_NetLoanAppraised]
@StartDate DateTime,@EndDate DateTime

as

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


WITH LoanCTE(Name,Age,Gender,YOB,AccountNo,LoanProduct,AmountApplied,AmountApproved,ProcFee,PrincipleOffset,InterestOffset,CreatedDate,MonthlyPrinciple,MonthlyInterest,Employer,CostCenter,LoanType,LoanTerm)
AS

(
SELECT        dbo.vw_CustomerAccounts.FullName, DATEDIFF(YY,dbo.vw_CustomerAccounts.Individual_BirthDate,GETDATE()),
case dbo.vw_CustomerAccounts.Individual_Gender when 1 then 'Male' when 2 then 'Female' else 'Unknown' end, year(dbo.vw_CustomerAccounts.Individual_BirthDate),
 dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_LoanProducts.id, dbo.swiftfin_LoanCases.AmountApplied,
 dbo.swiftfin_LoanCases.AppraisedAmount,(dbo.vw_LoanDynamicCharges.Charge_Percentage*dbo.swiftfin_LoanCases.AppraisedAmount/100)+dbo.vw_LoanDynamicCharges.Charge_FixedAmount ,
 isnull(sum(dbo.swiftfin_AttachedLoans.PrincipalBalance),0),isnull(sum(dbo.swiftfin_AttachedLoans.InterestBalance),0),
   dbo.swiftfin_LoanCases.CreatedDate,  dbo.swiftfin_LoanCases.AppraisedAmount/dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths,dbo.swiftfin_LoanCases.AppraisedAmount*dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths/12000,dbo.vw_CustomerAccounts.EmployerDescription,dbo.swiftfin_ChartOfAccounts.CostCenterId,dbo.swiftfin_LoanProducts.Description,
   dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths
 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_LoanDynamicCharges ON dbo.swiftfin_LoanProducts.Id = dbo.vw_LoanDynamicCharges.LoanProductId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id LEFT OUTER JOIN
                         dbo.swiftfin_AttachedLoans ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_AttachedLoans.CustomerAccountId AND dbo.swiftfin_LoanCases.Id = dbo.swiftfin_AttachedLoans.LoanCaseId

						 where dbo.swiftfin_LoanCases.CreatedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.Status='48827'

						 group by dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_ChartOfAccounts.CostCenterId,dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_LoanProducts.id, 
						 dbo.swiftfin_LoanCases.AmountApplied,dbo.vw_LoanDynamicCharges.Charge_FixedAmount,
                      dbo.swiftfin_LoanCases.AppraisedAmount,dbo.vw_LoanDynamicCharges.Charge_Percentage,vw_CustomerAccounts.Individual_BirthDate,
   dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.AppraisedAmount,dbo.vw_CustomerAccounts.Individual_Gender,
   dbo.vw_CustomerAccounts.EmployerDescription,dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanCases.LoanRegistration_TermInMonths
						 )
						 Select Name,AccountNo,Age,YOB,Gender,LoanProduct,AmountApplied,AmountApproved,ProcFee,
						PrincipleOffset,InterestOffset,CreatedDate,MonthlyPrinciple,MonthlyInterest,
						 AmountApproved-(PrincipleOffset+InterestOffset)*-1-ProcFee as NetBal,Employer,CostCenter,LoanType,LoanTerm
						 from LoanCTE 

						group by Name,Age,YOB,Gender,CostCenter,AccountNo,LoanProduct,AmountApplied,AmountApproved,ProcFee,PrincipleOffset,InterestOffset ,
						CreatedDate,MonthlyPrinciple,MonthlyInterest,Employer,LoanType,LoanTerm
						--select * from swiftfin_LoanCases where CustomerId='8F9C3FC2-3B55-E811-AF66-48BA4E3DB51F'
						--select left(description,3) from swiftfin_loanproducts

						--select * from swiftfin_Enumerations where [key] like '%LoanCaseStatus%'
GO
/****** Object:  StoredProcedure [dbo].[sp_NetLoanDisbursed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_NetLoanDisbursed '04/01/2018','05/19/2018'
CREATE PROC [dbo].[sp_NetLoanDisbursed]
@StartDate DateTime,@EndDate DateTime

as

set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


WITH LoanCTE(Name,Age,Gender,YOB,AccountNo,LoanProduct,AmountApplied,AmountApproved,ProcFee,PrincipleOffset,InterestOffset,CreatedDate,MonthlyPrinciple,MonthlyInterest,Employer,CostCenter,LoanType)
AS

(
SELECT        dbo.vw_CustomerAccounts.FullName, DATEDIFF(YY,dbo.vw_CustomerAccounts.Individual_BirthDate,GETDATE()),
case dbo.vw_CustomerAccounts.Individual_Gender when 1 then 'Male' when 2 then 'Female' else 'Unknown' end, year(dbo.vw_CustomerAccounts.Individual_BirthDate),
 dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_LoanProducts.id, dbo.swiftfin_LoanCases.AmountApplied,
 dbo.swiftfin_LoanCases.ApprovedAmount,(dbo.vw_LoanDynamicCharges.Charge_Percentage*dbo.swiftfin_LoanCases.ApprovedAmount/100)+dbo.vw_LoanDynamicCharges.Charge_FixedAmount ,
 isnull(sum(dbo.swiftfin_AttachedLoans.PrincipalBalance),0),isnull(sum(dbo.swiftfin_AttachedLoans.InterestBalance),0),
   dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.ApprovedPrincipalPayment, dbo.swiftfin_LoanCases.ApprovedInterestPayment,dbo.vw_CustomerAccounts.EmployerDescription,dbo.swiftfin_ChartOfAccounts.CostCenterId,left(dbo.swiftfin_LoanProducts.Description,3)
 

FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanCases ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_LoanCases.CustomerId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_LoanCases.LoanProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.vw_LoanDynamicCharges ON dbo.swiftfin_LoanProducts.Id = dbo.vw_LoanDynamicCharges.LoanProductId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id LEFT OUTER JOIN
                         dbo.swiftfin_AttachedLoans ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_AttachedLoans.CustomerAccountId AND dbo.swiftfin_LoanCases.Id = dbo.swiftfin_AttachedLoans.LoanCaseId

						 where dbo.swiftfin_LoanCases.DisbursedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_LoanCases.Status='48829'

						 group by dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_ChartOfAccounts.CostCenterId,dbo.vw_CustomerAccounts.Reference1,dbo.swiftfin_LoanProducts.id, 
						 dbo.swiftfin_LoanCases.AmountApplied,dbo.vw_LoanDynamicCharges.Charge_FixedAmount,
                      dbo.swiftfin_LoanCases.ApprovedAmount,dbo.vw_LoanDynamicCharges.Charge_Percentage,vw_CustomerAccounts.Individual_BirthDate,
   dbo.swiftfin_LoanCases.CreatedDate, dbo.swiftfin_LoanCases.ApprovedPrincipalPayment, dbo.swiftfin_LoanCases.ApprovedInterestPayment,dbo.vw_CustomerAccounts.Individual_Gender,
   dbo.vw_CustomerAccounts.EmployerDescription,dbo.swiftfin_LoanProducts.Description
						 )
						 Select Name,AccountNo,Age,YOB,Gender,LoanProduct,AmountApplied,AmountApproved,ProcFee,
						PrincipleOffset,InterestOffset,CreatedDate,MonthlyPrinciple,MonthlyInterest,
						 AmountApproved-(PrincipleOffset+InterestOffset)*-1-ProcFee as NetBal,Employer,CostCenter,LoanType
						 from LoanCTE 

						group by Name,Age,YOB,Gender,CostCenter,AccountNo,LoanProduct,AmountApplied,AmountApproved,ProcFee,PrincipleOffset,InterestOffset ,
						CreatedDate,MonthlyPrinciple,MonthlyInterest,Employer,LoanType
						--select * from swiftfin_LoanCases where CustomerId='8F9C3FC2-3B55-E811-AF66-48BA4E3DB51F'
						--select left(description,3) from swiftfin_loanproducts
GO
/****** Object:  StoredProcedure [dbo].[sp_NewMemberAccounts]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Tobbit
-- Create date: 7/6/2016
-- Description:	
-- =============================================
--SP_NewMemberAccounts '06/01/2016','08/08/2016'

CREATE PROCEDURE [dbo].[sp_NewMemberAccounts] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime = 0, 
	@EndDate Datetime = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	SELECT 
                        CASE swiftfin_Customers.Individual_Salutation WHEN 1 THEN 'Mr' WHEN 2 THEN 'Mrs' WHEN 3 THEN 'Miss' WHEN 4 THEN 'Dr' WHEN 5
                          THEN 'Prof' WHEN 6 THEN 'Rev' WHEN 7 THEN 'Eng' WHEN 8 THEN 'Hon' WHEN 9 THEN 'Cllr' WHEN 10 THEN 'Sir' WHEN 11 THEN
                          'Ms' ELSE 'Unknown' END + ' '+ isnull(swiftfin_Customers.Individual_FirstName,'') +' '+ isnull(swiftfin_Customers.Individual_LastName,'') + isnull(swiftfin_Customers.NonIndividual_Description,'') as FullName, 
						  isnull(dbo.swiftfin_Customers.Reference1,'') as Account, isnull(dbo.swiftfin_Customers.Reference3,'') AS PayrollNo,dbo.swiftfin_Customers.SerialNumber,dbo.swiftfin_Customers.CreatedBy,CASE swiftfin_Customers.Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'Unknown' END AS Gender, 
                         dbo.swiftfin_Stations.Description AS Station,dbo.swiftfin_Branches.Id,dbo.swiftfin_Customers.RegistrationDate,dbo.swiftfin_Customers.Individual_EmploymentDesignation,swiftfin_Customers.ModifiedBy
FROM            dbo.swiftfin_SavingsProducts INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_SavingsProducts.Code = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_CustomerAccounts.BranchId = dbo.swiftfin_Branches.Id
						 where dbo.swiftfin_Customers.CreatedDate BETWEEN @StartDate AND @EndDate and  dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode=1 and dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode=1
						-- group by   dbo.vw_Customers.FullName, dbo.vw_Customers.MembershipNumber, dbo.vw_Customers.Reference1, dbo.vw_Customers.Reference2, dbo.vw_Customers.Reference3, dbo.vw_Customers.RegistrationDate
END


--select * from swiftfin_CustomerAccounts




GO
/****** Object:  StoredProcedure [dbo].[sp_NewMembers]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Tobbit
-- Create date: 7/6/2016
-- Description:	
-- =============================================
--SP_NewMembers '10/01/2018','10/30/2018'

CREATE PROCEDURE [dbo].[sp_NewMembers] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime = 0, 
	@EndDate Datetime = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	SELECT        CASE swiftfin_Customers.Individual_Salutation WHEN 1 THEN 'Mr' WHEN 2 THEN 'Mrs' WHEN 3 THEN 'Miss' WHEN 4 THEN 'Dr' WHEN 5 THEN 'Prof' WHEN 6 THEN 'Rev' WHEN 7 THEN 'Eng' WHEN 8 THEN 'Hon' WHEN 9 THEN 'Cllr'
                          WHEN 10 THEN 'Sir' WHEN 11 THEN 'Ms' ELSE 'Unknown' END + ' ' + ISNULL(dbo.swiftfin_Customers.Individual_FirstName, '') + ' ' + ISNULL(dbo.swiftfin_Customers.Individual_LastName, '') 
                         + ISNULL(dbo.swiftfin_Customers.NonIndividual_Description, '') AS FullName, ISNULL(dbo.swiftfin_Customers.Reference1, '') AS Account, ISNULL(dbo.swiftfin_Customers.Reference3, '') AS PayrollNo, dbo.swiftfin_Customers.SerialNumber, 
                         dbo.swiftfin_Customers.CreatedBy, CASE swiftfin_Customers.Individual_Gender WHEN 1 THEN 'Male' WHEN 2 THEN 'Female' ELSE 'Unknown' END AS Gender, dbo.swiftfin_Stations.Description AS Station, 
                         dbo.swiftfin_Customers.RegistrationDate, dbo.swiftfin_Customers.Individual_EmploymentDesignation, dbo.swiftfin_Customers.ModifiedBy
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id
						 where dbo.swiftfin_Customers.CreatedDate BETWEEN @StartDate AND @EndDate --and  dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode=1 and dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode=1
						-- group by   dbo.vw_Customers.FullName, dbo.vw_Customers.MembershipNumber, dbo.vw_Customers.Reference1, dbo.vw_Customers.Reference2, dbo.vw_Customers.Reference3, dbo.vw_Customers.RegistrationDate
END


--select * from swiftfin_CustomerAccounts




GO
/****** Object:  StoredProcedure [dbo].[sp_NewMembersInvestmentBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE Procedure [dbo].[sp_NewMembersInvestmentBalances]

@StartDate DateTime,
@EndDate DateTime,
@ProductId UniqueIdentifier

as


SELECT        CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							dbo.swiftfin_Customers.Reference1, SUM(dbo.swiftfin_JournalEntries.Amount) AS Balance
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_InvestmentProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
						 where @ProductId=dbo.swiftfin_InvestmentProducts.Id and dbo.swiftfin_Customers.RegistrationDate BETWEEN @StartDate and @EndDate+1
GROUP BY dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_InvestmentProducts.MinimumBalance,dbo.swiftfin_Customers.Individual_Salutation


--select * from swiftfin_Customers


GO
/****** Object:  StoredProcedure [dbo].[sp_NewMembersSavingsBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE Procedure [dbo].[sp_NewMembersSavingsBalances]

@StartDate DateTime,
@EndDate DateTime,
@ProductId UniqueIdentifier

as


SELECT        CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
							dbo.swiftfin_Customers.Reference1, SUM(dbo.swiftfin_JournalEntries.Amount) AS BookBalance,SUM(dbo.swiftfin_JournalEntries.Amount)-dbo.swiftfin_SavingsProducts.MinimumBalance as AvailableBalance
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_SavingsProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
						 where @ProductId=dbo.swiftfin_SavingsProducts.Id and dbo.swiftfin_Customers.RegistrationDate BETWEEN @StartDate and @EndDate+1
GROUP BY dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_SavingsProducts.MinimumBalance,dbo.swiftfin_Customers.Individual_Salutation


--select * from swiftfin_Customers


GO
/****** Object:  StoredProcedure [dbo].[sp_NewMembersWithMinimumBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_NewMembersWithMinimumBalance '05/01/2018','05/30/2018','0019753','>',0

--select recruitedby,* from swiftfin_Customers where RecruitedBy is not null
--select * from swiftfin_Customers where serialnumber=0019753
CREATE Proc [dbo].[sp_NewMembersWithMinimumBalance]
@StartDate DateTime,
@EndDate DateTime,
@RecruitedBy nvarchar(50),
@Operator char(2),
@OperatorValue float

AS
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

with NewMembersWithMinimumBalanceCTE(Name,ID,Acno,Mno,Pfno,RecruitedBy,RecruitedDate,AccntType,AccountType,Amount,ShareCapital,ShareDeposits,MicroPremiums,QwetuSuper)
as
(
SELECT        COALESCE( ltrim(rtrim(CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
							  THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
							  'Ms' ELSE '' END + ' ' + isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,''))),'')+ COALESCE(  dbo.swiftfin_Customers.NonIndividual_Description,'') AS FullName, 
							 COALESCE( Individual_IdentityCardNumber,'')+COALESCE(NonIndividual_RegistrationNumber,'') as IdNo, dbo.swiftfin_Customers.Reference1, 
                         dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3,dbo.swiftfin_Customers.RecruitedBy,swiftfin_Customers.RegistrationDate, dbo.swiftfin_Customers.Type,
						 case dbo.swiftfin_Customers.Type when 0 then 'Individual' when 1 then 'Partnership' when 2 then 'Corporation' when 3 then 'Microcredit' end as AccountType,
						 sum(dbo.swiftfin_JournalEntries.Amount) as Amount,
--select * from swiftfin_investmentproducts
						 isnull((SELECT    sum(amount)    
FROM            dbo.swiftfin_InvestmentProducts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id AND 
						 dbo.swiftfin_InvestmentProducts.Id = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId
						 where dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.id and dbo.swiftfin_InvestmentProducts.Id='AD144688-0F75-4734-BAFF-0D0B0381846C'),0) as ShareCapital,
						 						isnull( (SELECT    sum(amount)    
FROM            dbo.swiftfin_InvestmentProducts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id AND 
						 dbo.swiftfin_InvestmentProducts.Id = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId
						 where dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.id  and dbo.swiftfin_InvestmentProducts.Id='DCAD574A-B94B-4CC6-9E09-F936CCE0189D'),0) as ShareDeposits,
						 						isnull( (SELECT    sum(amount)    
FROM            dbo.swiftfin_InvestmentProducts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id AND 
						 dbo.swiftfin_InvestmentProducts.Id = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId
						 where dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.id and dbo.swiftfin_InvestmentProducts.Id='A68549F5-FC7B-4CC6-B092-14C39D776AA9' ),0) as MicroPremiums,
						 						isnull( (SELECT    sum(amount)    
FROM            dbo.swiftfin_InvestmentProducts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_InvestmentProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id AND 
						 dbo.swiftfin_InvestmentProducts.Id = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId
						 where dbo.swiftfin_CustomerAccounts.CustomerId=swiftfin_Customers.id and dbo.swiftfin_InvestmentProducts.Id='AEFD28B2-907B-4CD5-BD80-AA713215C7DC'),0) as QwetuSuper

FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_SavingsProducts.ChartOfAccountId AND dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id

where  dbo.swiftfin_Customers.CreatedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_JournalEntries.Amount>0 and 
dbo.swiftfin_JournalEntries.JournalId not in(select id from swiftfin_Journals where TransactionCode=21)
 and dbo.swiftfin_Customers.RecruitedBy=@RecruitedBy
GROUP BY dbo.swiftfin_Customers.Individual_FirstName,dbo.swiftfin_Customers.Id, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, 
                         dbo.swiftfin_Customers.Reference3,dbo.swiftfin_Customers.RecruitedBy,dbo.swiftfin_Customers.Type,dbo.swiftfin_Customers.NonIndividual_Description,NonIndividual_RegistrationNumber,
						  dbo.swiftfin_Customers.Individual_Salutation,swiftfin_Customers.RegistrationDate
						 )
						 select * from NewMembersWithMinimumBalanceCTE where	(
			(@Operator = '>' and Amount  > @OperatorValue)
			or (@Operator = '<' and Amount < @OperatorValue)
			or (@Operator = '<>' and Amount!= @OperatorValue)
			or (@Operator = '>=' and Amount>= @OperatorValue)
			or (@Operator = '<=' and Amount<= @OperatorValue)
			or (@Operator = '=' and Amount = @OperatorValue)
		) 

						 --select * from swiftfin_Customers where id in (select customerid from swiftfin_employees)
						 --select * from swiftfin_Enumerations where [key] like '%CustomerType%'
						 --- Cast([RecruitedBy] as INT)

						-- select * from swiftfin_Journals where PrimaryDescription like '%disb%'
						 
						 
GO
/****** Object:  StoredProcedure [dbo].[sp_NextOfKinSchedule]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_NextOfKinSchedule]
	-- Add the parameters for the stored procedure here
	@CustomerID varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        ltrim(rtrim(dbo.swiftfin_Customers.Individual_FirstName))+' '+ LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS CustomerName, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Individual_PayrollNumbers, 
                         dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, LTRIM(rtrim(dbo.swiftfin_NextOfKin.FirstName))+' '+ ltrim(rtrim(dbo.swiftfin_NextOfKin.LastName)) as NextOfKinName, dbo.swiftfin_NextOfKin.IdentityCardNumber, 
                         
						 case dbo.swiftfin_NextOfKin.Relationship
						 When '1' then 'Father'
						 When '2' then 'Mother'
						 When '3' then 'Brother'
						 When '4' then 'Sister'
						 When '5' then 'Wife'
						 When '6' then 'Husband'
						 When '7' then 'Son'
						 When '8' then 'Daughter'
						 When '0' then 'Other'
						 end as Relationship
						 , dbo.swiftfin_NextOfKin.Address_AddressLine1, dbo.swiftfin_NextOfKin.Address_AddressLine2, dbo.swiftfin_NextOfKin.Address_Street, 
                         dbo.swiftfin_NextOfKin.Address_PostalCode, dbo.swiftfin_NextOfKin.Address_City, dbo.swiftfin_NextOfKin.Address_Email, dbo.swiftfin_NextOfKin.Address_LandLine, dbo.swiftfin_NextOfKin.Address_MobileLine, 
                         dbo.swiftfin_NextOfKin.NominatedPercentage,dbo.swiftfin_NextOfKin.IdentityCardNumber as NOKID
	FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_NextOfKin ON dbo.swiftfin_Customers.Id = dbo.swiftfin_NextOfKin.CustomerId 
						 where reference1=@CustomerID
END







GO
/****** Object:  StoredProcedure [dbo].[sp_NonCashJournal]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---sp_NONCashJournal '12/09/2014','12/09/2014'
--select count()
CREATE Procedure [dbo].[sp_NonCashJournal] (@StartDate DateTime, @EndDate DateTime)as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

With CashJournal(ItemDescription,AccountName,ItemCode,ParentItemCode,Debit,Credit)
as(
SELECT        TOP (100) PERCENT dbo.swiftfin_ModuleNavigationItems.ItemDescription, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ModuleNavigationItems.ItemCode, 
                         dbo.swiftfin_ModuleNavigationItems.ParentItemCode,
						 CASE  WHEN SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)  else 0 end as Debit,
						 CASE  WHEN SUM(dbo.swiftfin_JournalEntries.Amount)<0 then SUM(dbo.swiftfin_JournalEntries.Amount)*-1  else 0 end as Credit
                        
FROM            dbo.swiftfin_ModuleNavigationItems INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_ModuleNavigationItems.ItemCode = dbo.swiftfin_Journals.ModuleNavigationItemCode INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
WHERE        (dbo.swiftfin_ModuleNavigationItems.ItemCode NOT IN ('61657', '61754', '61757', '61758', '61759', '61760', '61755', '61756', '61655')) AND 
                         (dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate) 
GROUP BY dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ModuleNavigationItems.ItemCode, dbo.swiftfin_ModuleNavigationItems.ParentItemCode, 
                         dbo.swiftfin_ModuleNavigationItems.ItemDescription
)

select ROW_NUMBER() OVER(ORDER BY ItemCode) AS Row,* into #temp1 from  CashJournal where debit+credit>0 

select *,SUM(debit-credit) OVER(ORDER BY Row 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal from  #temp1  order by ItemCode





GO
/****** Object:  StoredProcedure [dbo].[sp_NonMembers]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--Exec sp_NonMembers '9AC3ECAA-B9D3-CF83-E5FD-08D20DABFB88'
--select * from swiftfin_InvestmentProducts
CREATE proc [dbo].[sp_NonMembers]
@InvestmentProductId UniqueIdentifier
as

SELECT        dbo.swiftfin_Customers.Individual_FirstName + ' ' +  dbo.swiftfin_Customers.Individual_LastName As AccountName, SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount, 
                         dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
where dbo.swiftfin_InvestmentProducts.Id=@InvestmentProductId and dbo.swiftfin_JournalEntries.Amount=0
GROUP BY dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3,
                         dbo.swiftfin_InvestmentProducts.Description





GO
/****** Object:  StoredProcedure [dbo].[sp_OldSystemBackofficeStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


---select * from bosa.dbo.customer
---select * from bosa.dbo.history
---[sp_OldSystemBackofficeStatement] '01325','01/01/2014','05/31/2018'
CREATE PROCEDURE [dbo].[sp_OldSystemBackofficeStatement] 
(
	@SaccoMno varchar(20),
	@StartDate datetime,
	@EndDate Datetime
)
as
set nocount on;
WITH Statement_cte (Name,pf_no,TranType,Product,TrxDate,Description,credit,debit,IntCr,IntDr)
AS
(
	SELECT        Customer.Name,Customer.pf_no,history.ttype,lntypes.[name], history.trdate, history.trdescpt, history.credit, history.debit, history.intcr, history.intdr
	FROM           bosa.dbo.history INNER JOIN
                   bosa.dbo.lntypes ON  bosa.dbo.history.ttype =  bosa.dbo.lntypes.code  
				  INNER JOIN 
				  bosa.dbo.CUSTOMER ON  bosa.dbo.history.pf_no =  bosa.dbo.CUSTOMER.pf_no  
				  
	where customer.pf_no=@SaccoMno

),

Summary_cte
(Name,pf_no,TranType,Product,TrxDate,Description,credit,debit,RunningTotal,InterestCr,InterestDr,InterestBalance)
as
(
select Name,pf_no,TranType,Product,TrxDate,Description,credit,debit,
case When left(TranType,1)='S' then SUM(isnull(debit,0)-isnull(credit,0)) OVER(PARTITION BY TranType  ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) *-1 else SUM(isnull(debit,0)-isnull(credit,0)) OVER(PARTITION BY TranType  ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) end AS RunningTotal,
IntCr,IntDr, 
case When left(TranType,1)='S' then SUM(isnull(Intdr,0)-isnull(Intcr,0)) OVER(PARTITION BY TranType ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) *-1 else SUM(isnull(IntDr,0)-isnull(IntCr,0)) OVER(PARTITION BY TranType ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) end AS InterestBalance
from Statement_cte 
)

select Name,pf_no,TranType,Product,TrxDate,Description,credit,debit,RunningTotal,InterestCr,InterestDr,InterestBalance 
from Summary_cte 
where TrxDate Between @StartDate and @EndDate
order by tranType ,Trxdate 





GO
/****** Object:  StoredProcedure [dbo].[sp_OldSystemBackofficeStatementTEST]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---select * from bosa.dbo.customer
---[sp_OldSystemBackofficeStatement] '2196-001-00001','01/01/2016','10/7/2016'
CREATE PROCEDURE [dbo].[sp_OldSystemBackofficeStatementTEST] 
(
	@SaccoMno varchar(20),
	@StartDate datetime,
	@EndDate Datetime
)
as
set nocount on;
WITH Statement_cte (Name,fosa_acno,TranType,Product,TrxDate,Description,credit,debit,IntCr,IntDr)
AS
(
	SELECT        Customer.Name,Customer.fosa_acno,loanhist.ttype,lntypes.desc_, loanhist.trdate, loanhist.trdescpt, loanhist.credit, loanhist.debit, loanhist.intcr, loanhist.intdr
	FROM           NDOSHA.dbo.loanhist INNER JOIN
                   NDOSHA.dbo.lntypes ON  NDOSHA.dbo.loanhist.ttype =  NDOSHA.dbo.lntypes.code  
				  INNER JOIN 
				  NDOSHA.dbo.CUSTOMER ON  NDOSHA.dbo.loanhist.fosa_acno =  NDOSHA.dbo.CUSTOMER.fosa_acno  
				  
	where customer.fosa_acno=@SaccoMno

),

Summary_cte
(Name,fosa_acno,TranType,Product,TrxDate,Description,credit,debit,RunningTotal,InterestCr,InterestDr,InterestBalance)
as
(
select Name,fosa_acno,TranType,Product,TrxDate,Description,credit,debit,
case When left(TranType,1)='S' then SUM(isnull(debit,0)-isnull(credit,0)) OVER(PARTITION BY TranType  ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) *-1 else SUM(isnull(debit,0)-isnull(credit,0)) OVER(PARTITION BY TranType  ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) end AS RunningTotal,
IntCr,IntDr, 
case When left(TranType,1)='S' then SUM(isnull(Intdr,0)-isnull(Intcr,0)) OVER(PARTITION BY TranType ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) *-1 else SUM(isnull(IntDr,0)-isnull(IntCr,0)) OVER(PARTITION BY TranType ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) end AS InterestBalance
from Statement_cte 
)

select Name,fosa_acno,TranType,Product,TrxDate,Description,credit,debit,RunningTotal,InterestCr,InterestDr,InterestBalance 
from Summary_cte 
where TrxDate Between @StartDate and @EndDate
order by tranType ,Trxdate 









GO
/****** Object:  StoredProcedure [dbo].[sp_OldSystemFrontofficeLoanStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---[sp_OldSystemFrontofficeLoanStatement] '0101-001-00009','01/01/2014','05/31/2018'
CREATE  PROCEDURE [dbo].[sp_OldSystemFrontofficeLoanStatement]
	(
	@SaccoMno varchar(20),
	@StartDate datetime,
	@EndDate Datetime
	)

as
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here

/****** Object:  StoredProcedure [dbo].[sp_OldSystemBackofficeStatement]    Script Date: 5/15/2014 6:26:57 PM ******/

WITH Statement_cte (Name,Fosa_acno,TranType,Product,TrxDate,Description,credit,debit,IntCr,IntDr)
AS
(
	SELECT        Customer.Name,Customer.Fosa_acno,loanhist.ttype,lntypes.desc_ as Name, loanhist.trdate, loanhist.trdescpt,loanhist.credit, loanhist.debit, loanhist.intcr, loanhist.intdr
	FROM          FOSA.dbo.loanhist INNER JOIN
                   FOSA.dbo.lntypes ON  FOSA.dbo.loanhist.ttype =  FOSA.dbo.lntypes.code  
				  INNER JOIN 
				   FOSA.dbo.CUSTOMER ON  FOSA.dbo.loanhist.fosa_Acno =  FOSA.dbo.CUSTOMER.fosa_acno  
				  
	where customer.Fosa_acno=@SaccoMno

),

Summary_cte
(Name,Fosa_acno,TranType,Product,TrxDate,Description,credit,debit,RunningTotal,InterestCr,InterestDr,InterestBalance)
as
(
select Name,Fosa_acno,TranType,Product,TrxDate,Description,credit,debit,
case When left(TranType,1)='S' then SUM(isnull(debit,0)-isnull(credit,0)) OVER(PARTITION BY TranType  ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) *-1 else SUM(isnull(debit,0)-isnull(credit,0)) OVER(PARTITION BY TranType  ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) end AS RunningTotal,
IntCr,IntDr, 
case When left(TranType,1)='S' then SUM(isnull(Intdr,0)-isnull(Intcr,0)) OVER(PARTITION BY TranType ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) *-1 else SUM(isnull(IntDr,0)-isnull(IntCr,0)) OVER(PARTITION BY TranType ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) end AS InterestBalance
from Statement_cte 
)

select Name,Fosa_acno,TranType,Product,TrxDate,Description,credit,debit,RunningTotal,InterestCr,InterestDr,InterestBalance 
from Summary_cte 
where TrxDate Between @StartDate and @EndDate
order by tranType ,Trxdate 

END




GO
/****** Object:  StoredProcedure [dbo].[sp_OldSystemFrontofficeSavingsStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
----sp_OldSystemFrontofficeSavingsStatement '0101-001-11495 ', '01/01/2016', '10/29/2016'
CREATE PROCEDURE [dbo].[sp_OldSystemFrontofficeSavingsStatement]
	(
		@SaccoMno varchar(20),
		@StartDate datetime,
		@EndDate Datetime
	)

as
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


WITH Statement_cte (Name,Fosa_acno,TrxDate,Description,credit,debit)
AS
(
	SELECT        Customer.Name,Customer.Fosa_acno, trdate, ltrim(rtrim(trdescpt)),credit, debit
	FROM          FOSA.dbo.history FOSA 
				  INNER JOIN 
				  FOSA.dbo.CUSTOMER ON FOSA.fosa_Acno = CUSTOMER.fosa_acno  				  
	where ltrim(customer.Fosa_acno)=@SaccoMno AND DOCID NOT IN ('206')

),

Summary_cte
(Name,Fosa_acno,TrxDate,Description,credit,debit,RunningTotal)
as
(
select Name,Fosa_acno,TrxDate,Description,credit,debit,
 SUM(isnull(debit,0)-isnull(credit,0)) OVER(ORDER BY TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)   AS RunningTotal
from Statement_cte 
)

select Name,Fosa_acno,TrxDate,Description,credit,debit,RunningTotal
from Summary_cte 
where TrxDate Between @StartDate and @EndDate
order by Trxdate 

END











GO
/****** Object:  StoredProcedure [dbo].[sp_OldSystemInvestmentStatement]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---select * from bosa.dbo.customer
---select * from bosa.dbo.history
---[sp_OldSystemInvestmentStatement] '01325','01/01/2014','05/31/2018'
CREATE PROCEDURE [dbo].[sp_OldSystemInvestmentStatement] 
(
	@SaccoMno varchar(20),
	@StartDate datetime,
	@EndDate Datetime
)
as
set nocount on;
WITH Statement_cte (Name,fosa_acno,TranType,Product,TrxDate,Description,credit,debit)
AS
(SELECT        Customer.Name,Customer.pf_no,history.ttype,lntypes.[name], history.trdate, history.trdescpt, history.credit, history.debit
	FROM           bosa.dbo.history INNER JOIN
                   bosa.dbo.lntypes ON  bosa.dbo.history.ttype =  bosa.dbo.lntypes.code  
				  INNER JOIN 
				  bosa.dbo.CUSTOMER ON  bosa.dbo.history.pf_no =  bosa.dbo.CUSTOMER.pf_no  
				  
	where customer.pf_no=@SaccoMno and bosa.dbo.history.ttype like '%s%'

),

Summary_cte
(Name,fosa_acno,TranType,Product,TrxDate,Description,credit,debit,RunningTotal)
as
(
select Name,fosa_acno,TranType,Product,TrxDate,Description,credit,debit,
case When left(TranType,1)='S' then SUM(isnull(debit,0)-isnull(credit,0)) OVER(PARTITION BY TranType  ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) *-1 else SUM(isnull(debit,0)-isnull(credit,0)) OVER(PARTITION BY TranType  ORDER BY TranType,TrxDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) end AS RunningTotal

from Statement_cte 
)

select Name,fosa_acno,TranType,Product,TrxDate,Description,credit,debit,RunningTotal
from Summary_cte 
where TrxDate Between @StartDate and @EndDate
order by tranType ,Trxdate 








GO
/****** Object:  StoredProcedure [dbo].[sp_OverdeductionListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--sp_OverdeductionListing '05/14/2018','05/15/2018'
CREATE PROCEDURE [dbo].[sp_OverdeductionListing]
@pStartDate DateTime,
@pEndDate DateTime
AS
BEGIN
set @pEndDate=	(select DATEADD(day, DATEDIFF(day, 0, @pEndDate), '23:59:59'))
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        FullAccountNumber, FullName, CredutAccountNumber, CreditName, DebitProductType, Principal, Interest, BatchNumber, Reference, TotalValue, Status, AuthorizedBy, AuthorizationRemarks, AuthorizedDate, CreatedBy, 
                         CreatedDate, CreditProduct
FROM            vw_Overdeductions
WHERE        (CreatedDate BETWEEN @pStartDate AND @pEndDate)
END
GO
/****** Object:  StoredProcedure [dbo].[sp_P10b]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create Procedure [dbo].[sp_P10b] (@PostingPeriodID varchar(50))
as
select distinct MembershipNumber,[PersonalIdentificationNumber], 
[FullName],
isnull((SELECT sum([Principal])
  FROM [vw_Payslips] b where PostingPeriodID=@PostingPeriodID ---'2F015C30-7201-C686-7872-08D1AD41F57B' 
  and  SalaryHeadType in (61680,61688) and [MembershipNumber]=a.MembershipNumber),0) AS [TOTAL EMOLUMENTS (KSH)]
,isnull((SELECT sum([Principal])
  FROM [vw_Payslips] b where PostingPeriodID=@PostingPeriodID 
  and  SalaryHeadType in (61683) and [MembershipNumber]=a.MembershipNumber),0) AS [TAX DEDUCTED (KSHS)]

from [dbo].[vw_Payslips] a where PostingPeriodID=@PostingPeriodID




GO
/****** Object:  StoredProcedure [dbo].[sp_P9B]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_postingperiods
--sp_P9B '1C63BEDC-5BDE-C393-60CB-08D3E2D33976' ,'2196-010-00003'

CREATE Procedure [dbo].[sp_P9B] 
(
@PostingPeriodID Varchar(50),
@MembershipNumber Varchar(16)
)as
Declare
@LocalPostingPeriodID Varchar(50)=@PostingPeriodID,
@LocalMembershipNumber Varchar(16)=@MembershipNumber

  select MonthName,
  isnull((SELECT [FullName]
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType='61680' and Month=MonthList.MonthNumber ),0) AS [FullName]
  ,isnull((SELECT [IdentityCardNumber]
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType='61680' and Month=MonthList.MonthNumber ),0) AS [IdentityCardNumber]
  ,isnull((SELECT [MembershipNumber]
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType='61680' and Month=MonthList.MonthNumber ),0) AS [MembershipNumber]
  ,isnull((SELECT [PersonalIdentificationNumber]
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType='61680' and Month=MonthList.MonthNumber ),0) AS [PersonalIdentificationNumber]

  ,isnull((SELECT [Principal]
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType='61680' and Month=MonthList.MonthNumber ),0) BasicPay
  ,0 as BenefitsNonCash
  ,0 as ValueOfQuarters
  ,isnull((SELECT sum([Principal])
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType in(61680,61688) and Month=MonthList.MonthNumber ),0) as TotalGrossPay
  ,isnull((SELECT sum([Principal])
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType in(61680,61688) and Month=MonthList.MonthNumber ),0)*30/100 as e1
  ,isnull((SELECT sum([Principal])
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType in(61681,61684) and Month=MonthList.MonthNumber ),0) as e2
  ,20000 as e3
,0 as Lessere1e2e3
,0 as D_F
,0 as AMinusF
,isnull((SELECT sum([Principal])
  FROM [vw_Payslips] where PostingPeriodID=@LocalPostingPeriodID 
  and Reference1=@LocalMembershipNumber and SalaryHeadType in(61683) and Month=MonthList.MonthNumber ),0) as PAYE
,1162 as Relief
  into #temp from dbo.GetMonthList('01/01/2014',0) MonthList

  select FullName,  [PersonalIdentificationNumber],
 MonthName,BasicPay,BenefitsNonCash,ValueOfQuarters,TotalGrossPay,e1,e2,e3,(SELECT MIN(mydate) 
        FROM (VALUES(e1),(e2),(e3)) mylist(mydate)
       ) AS [Lesser e1 e2 e3],TotalGrossPay-Lessere1e2e3 as [D-F],BasicPay-Lessere1e2e3 as [Taxable Income],PAYE+Relief as Tax_Charged,Relief,PAYE as PAYTAX into #temp1 from #temp where PAYE>0


select FullName,  [PersonalIdentificationNumber],
 MonthName,BasicPay,BenefitsNonCash,ValueOfQuarters,TotalGrossPay,e1,e2,e3, [Lesser e1 e2 e3],TotalGrossPay-[Lesser e1 e2 e3] as [D-F],TotalGrossPay-[Lesser e1 e2 e3] as [Taxable Income], Tax_Charged,Relief, PAYTAX from #temp1



GO
/****** Object:  StoredProcedure [dbo].[sp_PayoutsSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---exec sp_PayoutsSummary '08/31/2017'

CREATE PROCEDURE [dbo].[sp_PayoutsSummary] 
@EndDate datetime
 
 as
 with cte (Chartofaccountid,principal,interest,type,description,Savings)
 as (
SELECT        dbo.swiftfin_JournalEntries.ChartOfAccountId, SUM(dbo.swiftfin_JournalEntries.Amount) AS Principal,0, Products_1.type, Products_1.Description,0
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.Products(0) AS Products_1 ON dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.ChartOfAccountId
WHERE        (dbo.swiftfin_JournalEntries.JournalId IN
                             (SELECT        Id
                               FROM            dbo.swiftfin_Journals
                               WHERE         ValueDate=@EndDate and (TransactionCode = '28') )) AND (dbo.swiftfin_JournalEntries.Amount > 0)And Products_1.type not like '%Savings%'  
GROUP BY dbo.swiftfin_JournalEntries.ChartOfAccountId, Products_1.type, Products_1.Description
union
SELECT        dbo.swiftfin_JournalEntries.ChartOfAccountId, 0,SUM(dbo.swiftfin_JournalEntries.Amount) AS Principal, Products_1.type, Products_1.Description,0
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.Products(0) AS Products_1 ON dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.InterestReceivable
WHERE        (dbo.swiftfin_JournalEntries.JournalId IN
                             (SELECT        Id
                               FROM            dbo.swiftfin_Journals
                               WHERE         ValueDate=@EndDate and (TransactionCode = '28') )) AND (dbo.swiftfin_JournalEntries.Amount > 0)  
GROUP BY dbo.swiftfin_JournalEntries.ChartOfAccountId, Products_1.type, Products_1.Description
union
SELECT        dbo.swiftfin_JournalEntries.ChartOfAccountId, 0,0, Products_1.type, Products_1.Description ,SUM(dbo.swiftfin_JournalEntries.Amount) AS Savings
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.Products(0) AS Products_1 ON dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.ChartOfAccountId
WHERE        (dbo.swiftfin_JournalEntries.JournalId IN
                             (SELECT        Id
                               FROM            dbo.swiftfin_Journals
                               WHERE         ValueDate=@EndDate and (TransactionCode = '28') )) AND (dbo.swiftfin_JournalEntries.Amount > 0)And Products_1.type  like '%Savings%' 

GROUP BY dbo.swiftfin_JournalEntries.ChartOfAccountId, Products_1.type, Products_1.Description

)
select  sum(principal) Principal,sum(interest) Interests ,type,description,sum(Savings) Savings from cte group by type,description order by type

GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollAdvice]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---exec sp_PayrollAdvice '06/19/2018'

CREATE PROCEDURE [dbo].[sp_PayrollAdvice] 
@EndDate datetime
 as
 BEGIN
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	
With CTEPAYROLL (FullName,Reference1,Individual_PayrollNumbers,benefactorcustomeraccountid,Principal,Interest,Charge_FixedAmount,Description,TotalLoans,LoanAmount,Savings,LoanProduct) 
as
(
select distinct FullName,Reference1,Individual_PayrollNumbers,benefactorcustomeraccountid,

sum(Distinct Principal) ,Sum(Distinct Interest),sum(Distinct Charge_FixedAmount),dbo.swiftfin_StandingOrders.Remarks, 

 isnull((

					SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE          (dbo.swiftfin_JournalEntries.CustomerAccountId=dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			
			),0)*-1 as TotalLoans,
			 isnull((

					SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId 
			WHERE          dbo.swiftfin_CustomerAccounts.Id=dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId and swiftfin_JournalEntries.CreatedDate<=@EndDate
			
			),0) as LoanAmount,
			isnull((
			SELECT  sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_SavingsProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_SavingsProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_SavingsProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId) and swiftfin_JournalEntries.CreatedDate<=@EndDate
			),0) as Savings,
			(select CustomerAccountType_TargetProductId from swiftfin_CustomerAccounts where id =swiftfin_StandingOrders.BeneficiaryCustomerAccountId)
				

	
FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_StandingOrders ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId and dbo.swiftfin_StandingOrders.[Trigger]=0

group by benefactorcustomeraccountid, FullName,Reference1,Individual_PayrollNumbers,CustomerAccountType_ProductCode,BeneficiaryCustomerAccountId,dbo.swiftfin_StandingOrders.Remarks,CustomerAccountType_TargetProductId
) 


select FullName,Reference1,Individual_PayrollNumbers,benefactorcustomeraccountid, 
Principal, Interest,Charge_FixedAmount,Principal+Interest+Charge_FixedAmount AS Total,Description,LoanAmount,TotalLoans,Savings,LoanProduct
--into #temp
from CTEPAYROLL where Individual_PayrollNumbers is not null and Individual_PayrollNumbers<>''
-- and(Interest>0 and TotalLoans<>0)
and LoanAmount<>TotalLoans
group by benefactorcustomeraccountid, FullName,Reference1,Individual_PayrollNumbers,Principal,Interest,Charge_FixedAmount,Description,TotalLoans,Savings,LoanProduct,LoanAmount
 having sum(Principal+Interest+Charge_FixedAmount)>0   order by Individual_PayrollNumbers,Reference1

 end 

--delete from #temp where LoanProduct in (select id from swiftfin_LoanProducts) and TotalLoans=0

--select fullName,reference1,Individual_PayrollNumbers,sum(principal+interest+Charge_FixedAmount) Amount,Savings as Test,case when Savings<0 then (Savings*-1)+sum(principal+interest+Charge_FixedAmount) when Savings>=0 then sum(principal+interest+Charge_FixedAmount)   else 0 end as Savings from #temp  
--group by fullName,reference1,Individual_PayrollNumbers,Savings
--having sum(Principal+Interest+Charge_FixedAmount)<>80 order by Reference1

--select top 10 * from swiftfin_customeraccounts





GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollAnalysisDetailed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


---sp_PayrollAnalysisDetailed 'CB716133-38CB-CEA8-CF3F-08D1F352E534',1
--Select * from swiftfin_postingperiods
--[sp_PayrollAnalysisDetailed] '6D1AC584-032D-E811-80D1-F40343552CF8',5
CREATE PROCEDURE [dbo].[sp_PayrollAnalysisDetailed]
(
 @PostingPeriodID varchar(Max),
 @Month Int,
 @EmployeeType Int
)
 as
 create table #Payslips (EmployeeName Varchar(100),reference1 Varchar(15),PayslipDescription Varchar(50),Principal Numeric(18,2),Month int,PostingPeriodId UniqueIdentifier);

--- SET ANSI_WARNINGS OFF;
 With AnalysisCTE (EmployeeName,reference1,Mno,PayrollNo,TotalEarnings,TotalDeducts,TotalLoans)
 as
 (
   SELECT        dbo.swiftfin_Customers.Individual_FirstName+ dbo.swiftfin_Customers.Individual_LastName AS EmployeeName, dbo.swiftfin_Customers.reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.reference1,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 1)) AS TotalEarnings,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 2)) AS TotalDeductions,
			 (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadType='61686')) AS TotalLoans                        
   FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_EmployeeTypes ON dbo.swiftfin_Employees.EmployeeTypeId = dbo.swiftfin_EmployeeTypes.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id  where swiftfin_Employees.IsLocked=0 and swiftfin_EmployeeTypes.Category=@EmployeeType
 )
 ---SELECT * FROM swiftfin_EMPLOYEES WHERE TYPE<>4
-- select * from vw_payslips
 select EmployeeName,reference1,TotalEarnings,TotalDeducts,TotalLoans,TotalEarnings-TotalDeducts as NetPay,@Month as Month,@PostingPeriodID as PostingPeriodID  into #temp1 from AnalysisCTE

select CustomerName as EmployeeName ,reference1,PayslipDescription,Principal+Interest as Principal,Month,PostingPeriodID,SalaryHeadCategory,2 as SortOrder into #Payslips1
  from vw_Payslips where PostingPeriodID=@PostingPeriodID and Month=@Month and Category=@EmployeeType

insert into #Payslips(EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID)
select EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID from #Payslips1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Earnings',TotalEarnings,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Deductions',TotalDeducts,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Loans',TotalLoans,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Net Pay',NetPay,@Month,PostingPeriodID from #temp1


select Description,Category into #SalaryHeads from swiftfin_SalaryHeads

insert into #SalaryHeads (Description,Category)
select 'Total Earnings',1
union
select 'Total Deductions',3
union
select 'Total Loans',3
union
select 'Net Pay',4

DECLARE @PivotColumnHeaders VARCHAR(mAX),
@select_columns VARCHAR(MAX)
SELECT @PivotColumnHeaders = COALESCE( @PivotColumnHeaders + ',[' + Description+ ']',      '[' + Description+ ']' ),
    @select_columns = COALESCE( @select_columns +  ',ISNULL(['+ Description+ '], 0) AS [' + Description+ ']' ,'ISNULL(['+ Description+ '], 0) AS [' + Description+ ']')

FROM #SalaryHeads order by Category



DECLARE @PivotTableSQL NVARCHAR(MAX)
SET @PivotTableSQL = N'
  SELECT  EmployeeName,reference1,'+@select_columns+'
  FROM (
 select EmployeeName,reference1,PayslipDescription,Principal from #Payslips) AS PivotData
 PIVOT (
    SUM(Principal)
    FOR PayslipDescription IN (
      ' + @PivotColumnHeaders + '
    )
  ) AS PivotTable
'

--select @PivotTableSQL
EXECUTE(@PivotTableSQL)
GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollAnalysisDetailedDeductions]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


---sp_PayrollAnalysisDetailed 'CB716133-38CB-CEA8-CF3F-08D1F352E534',1
--Select * from swiftfin_postingperiods
--[sp_PayrollAnalysisDetailed] '6D1AC584-032D-E811-80D1-F40343552CF8',5,1
CREATE PROCEDURE [dbo].[sp_PayrollAnalysisDetailedDeductions]
(
 @PostingPeriodID varchar(Max),
 @Month Int,
 @EmployeeType Int
)
 as
 create table #Payslips (EmployeeName Varchar(100),reference1 Varchar(15),PayslipDescription Varchar(50),Principal Numeric(18,2),Month int,PostingPeriodId UniqueIdentifier);

--- SET ANSI_WARNINGS OFF;
 With AnalysisCTE (EmployeeName,reference1,Mno,PayrollNo,TotalEarnings,TotalDeducts,TotalLoans)
 as
 (
   SELECT        dbo.swiftfin_Customers.Individual_FirstName+ dbo.swiftfin_Customers.Individual_LastName AS EmployeeName, dbo.swiftfin_Customers.reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.reference1,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 1)) AS TotalEarnings,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 2)) AS TotalDeductions,
			 (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadType='61686')) AS TotalLoans                        
   FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_EmployeeTypes ON dbo.swiftfin_Employees.EmployeeTypeId = dbo.swiftfin_EmployeeTypes.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id  where swiftfin_Employees.IsLocked=0 and swiftfin_EmployeeTypes.Category=@EmployeeType
 )
 ---SELECT * FROM swiftfin_EMPLOYEES WHERE TYPE<>4
-- select * from vw_payslips
 select EmployeeName,reference1,TotalEarnings,TotalDeducts,TotalLoans,TotalEarnings-TotalDeducts as NetPay,@Month as Month,@PostingPeriodID as PostingPeriodID  into #temp1 from AnalysisCTE

select CustomerName as EmployeeName ,reference1,PayslipDescription,Principal+Interest as Principal,Month,PostingPeriodID,SalaryHeadCategory,2 as SortOrder into #Payslips1
  from vw_Payslips where PostingPeriodID=@PostingPeriodID and Month=@Month and Category=@EmployeeType

insert into #Payslips(EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID)
select EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID from #Payslips1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Earnings',TotalEarnings,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Deductions',TotalDeducts,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Loans',TotalLoans,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Net Pay',NetPay,@Month,PostingPeriodID from #temp1


select Description,Category into #SalaryHeads from swiftfin_SalaryHeads

insert into #SalaryHeads (Description,Category)
select 'Total Earnings',1
union
select 'Total Deductions',3
union
select 'Total Loans',3
union
select 'Net Pay',4

DECLARE @PivotColumnHeaders VARCHAR(mAX),
@select_columns VARCHAR(MAX)
SELECT @PivotColumnHeaders = COALESCE( @PivotColumnHeaders + ',[' + Description+ ']',      '[' + Description+ ']' ),
    @select_columns = COALESCE( @select_columns +  ',ISNULL(['+ Description+ '], 0) AS [' + Description+ ']' ,'ISNULL(['+ Description+ '], 0) AS [' + Description+ ']')

FROM #SalaryHeads order by Category



DECLARE @PivotTableSQL NVARCHAR(MAX)
SET @PivotTableSQL = N'
  SELECT  EmployeeName,reference1,'+@select_columns+'
  FROM (
 select EmployeeName,reference1,PayslipDescription,Principal from #Payslips) AS PivotData
 PIVOT (
    SUM(Principal)
    FOR PayslipDescription IN (
      ' + @PivotColumnHeaders + '
    )
  ) AS PivotTable
'

--select @PivotTableSQL
EXECUTE(@PivotTableSQL)
GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollAnalysisDetailedDeductions1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



---sp_PayrollAnalysisDetailed 'CB716133-38CB-CEA8-CF3F-08D1F352E534',1
--Select * from swiftfin_postingperiods
--[sp_PayrollAnalysisDetailed] '6D1AC584-032D-E811-80D1-F40343552CF8',5,1
create PROCEDURE [dbo].[sp_PayrollAnalysisDetailedDeductions1]
(
 @PostingPeriodID varchar(Max),
 @Month Int,
 @EmployeeType Int
)
 as
 create table #Payslips (EmployeeName Varchar(100),reference1 Varchar(15),PayslipDescription Varchar(50),Principal Numeric(18,2),Month int,PostingPeriodId UniqueIdentifier);

--- SET ANSI_WARNINGS OFF;
 With AnalysisCTE (EmployeeName,reference1,Mno,PayrollNo,TotalEarnings,TotalDeducts,TotalLoans)
 as
 (
   SELECT        dbo.swiftfin_Customers.Individual_FirstName+ dbo.swiftfin_Customers.Individual_LastName AS EmployeeName, dbo.swiftfin_Customers.reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.reference1,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 1)) AS TotalEarnings,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 2)) AS TotalDeductions,
			 (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadType='61686')) AS TotalLoans                        
   FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_EmployeeTypes ON dbo.swiftfin_Employees.EmployeeTypeId = dbo.swiftfin_EmployeeTypes.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id  where swiftfin_Employees.IsLocked=0 and swiftfin_EmployeeTypes.Category=@EmployeeType
 )
 ---SELECT * FROM swiftfin_EMPLOYEES WHERE TYPE<>4
-- select * from vw_payslips
 select EmployeeName,reference1,TotalEarnings,TotalDeducts,TotalLoans,TotalEarnings-TotalDeducts as NetPay,@Month as Month,@PostingPeriodID as PostingPeriodID  into #temp1 from AnalysisCTE

select CustomerName as EmployeeName ,reference1,PayslipDescription,Principal+Interest as Principal,Month,PostingPeriodID,SalaryHeadCategory,2 as SortOrder into #Payslips1
  from vw_Payslips where PostingPeriodID=@PostingPeriodID and Month=@Month and Category=@EmployeeType

insert into #Payslips(EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID)
select EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID from #Payslips1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Earnings',TotalEarnings,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Deductions',TotalDeducts,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Loans',TotalLoans,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Net Pay',NetPay,@Month,PostingPeriodID from #temp1


select Description,Category into #SalaryHeads from swiftfin_SalaryHeads

insert into #SalaryHeads (Description,Category)
select 'Total Earnings',1
union
select 'Total Deductions',3
union
select 'Total Loans',3
union
select 'Net Pay',4

DECLARE @PivotColumnHeaders VARCHAR(mAX),
@select_columns VARCHAR(MAX)
SELECT @PivotColumnHeaders = COALESCE( @PivotColumnHeaders + ',[' + Description+ ']',      '[' + Description+ ']' ),
    @select_columns = COALESCE( @select_columns +  ',ISNULL(['+ Description+ '], 0) AS [' + Description+ ']' ,'ISNULL(['+ Description+ '], 0) AS [' + Description+ ']')

FROM #SalaryHeads order by Category



DECLARE @PivotTableSQL NVARCHAR(MAX)
SET @PivotTableSQL = N'
  SELECT  EmployeeName,reference1,'+@select_columns+'
  FROM (
 select EmployeeName,reference1,PayslipDescription,Principal from #Payslips) AS PivotData
 PIVOT (
    SUM(Principal)
    FOR PayslipDescription IN (
      ' + @PivotColumnHeaders + '
    )
  ) AS PivotTable
'

--select @PivotTableSQL
EXECUTE(@PivotTableSQL)

GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollAnalysisDetailedDeductions2]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




---sp_PayrollAnalysisDetailed 'CB716133-38CB-CEA8-CF3F-08D1F352E534',1
--Select * from swiftfin_postingperiods
--[sp_PayrollAnalysisDetailed] '6D1AC584-032D-E811-80D1-F40343552CF8',5,1
CREATE PROCEDURE [dbo].[sp_PayrollAnalysisDetailedDeductions2]
(
 @PostingPeriodID varchar(Max),
 @Month Int
 --@EmployeeType Int
)
 as
 create table #Payslips (EmployeeName Varchar(100),reference1 Varchar(15),PayslipDescription Varchar(50),Principal Numeric(18,2),Month int,PostingPeriodId UniqueIdentifier);

--- SET ANSI_WARNINGS OFF;
 With AnalysisCTE (EmployeeName,reference1,Mno,PayrollNo,TotalEarnings,TotalDeducts,TotalLoans)
 as
 (
   SELECT        dbo.swiftfin_Customers.Individual_FirstName+ dbo.swiftfin_Customers.Individual_LastName AS EmployeeName, dbo.swiftfin_Customers.reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.reference1,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 1)) AS TotalEarnings,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 2)) AS TotalDeductions,
			 (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadType='61686')) AS TotalLoans                        
   FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_EmployeeTypes ON dbo.swiftfin_Employees.EmployeeTypeId = dbo.swiftfin_EmployeeTypes.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id  where swiftfin_Employees.IsLocked=0 --and swiftfin_EmployeeTypes.Category=@EmployeeType
 )
 ---SELECT * FROM swiftfin_EMPLOYEES WHERE TYPE<>4
-- select * from vw_payslips
 select EmployeeName,reference1,TotalEarnings,TotalDeducts,TotalLoans,TotalEarnings-TotalDeducts as NetPay,@Month as Month,@PostingPeriodID as PostingPeriodID  into #temp1 from AnalysisCTE

select CustomerName as EmployeeName ,reference1,PayslipDescription,Principal+Interest as Principal,Month,PostingPeriodID,SalaryHeadCategory,2 as SortOrder into #Payslips1
  from vw_Payslips where PostingPeriodID=@PostingPeriodID and Month=@Month --and Category=@EmployeeType

insert into #Payslips(EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID)
select EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID from #Payslips1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Earnings',TotalEarnings,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Deductions',TotalDeducts,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Loans',TotalLoans,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Net Pay',NetPay,@Month,PostingPeriodID from #temp1


select Description,Category into #SalaryHeads from swiftfin_SalaryHeads

insert into #SalaryHeads (Description,Category)
select 'Total Earnings',1
union
select 'Total Deductions',3
union
select 'Total Loans',3
union
select 'Net Pay',4

DECLARE @PivotColumnHeaders VARCHAR(mAX),
@select_columns VARCHAR(MAX)
SELECT @PivotColumnHeaders = COALESCE( @PivotColumnHeaders + ',[' + Description+ ']',      '[' + Description+ ']' ),
    @select_columns = COALESCE( @select_columns +  ',ISNULL(['+ Description+ '], 0) AS [' + Description+ ']' ,'ISNULL(['+ Description+ '], 0) AS [' + Description+ ']')

FROM #SalaryHeads order by Category



DECLARE @PivotTableSQL NVARCHAR(MAX)
SET @PivotTableSQL = N'
  SELECT  EmployeeName,reference1,'+@select_columns+'
  FROM (
 select EmployeeName,reference1,PayslipDescription,Principal from #Payslips) AS PivotData
 PIVOT (
    SUM(Principal)
    FOR PayslipDescription IN (
      ' + @PivotColumnHeaders + '
    )
  ) AS PivotTable
'

--select @PivotTableSQL
EXECUTE(@PivotTableSQL)


GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollAnalysisDetailedEarnings]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



---sp_PayrollAnalysisDetailed 'CB716133-38CB-CEA8-CF3F-08D1F352E534',1
--Select * from swiftfin_postingperiods
--[sp_PayrollAnalysisDetailed] '6D1AC584-032D-E811-80D1-F40343552CF8',5,4
CREATE PROCEDURE [dbo].[sp_PayrollAnalysisDetailedEarnings]
(
 @PostingPeriodID varchar(Max),
 @Month Int
 --@EmployeeType Int
)
 as
 create table #Payslips (EmployeeName Varchar(100),reference1 Varchar(15),PayslipDescription Varchar(50),Principal Numeric(18,2),Month int,PostingPeriodId UniqueIdentifier);

--- SET ANSI_WARNINGS OFF;
 With AnalysisCTE (EmployeeName,reference1,Mno,PayrollNo,TotalEarnings,TotalDeducts)
 as
 (
   SELECT        dbo.swiftfin_Customers.Individual_FirstName+ dbo.swiftfin_Customers.Individual_LastName AS EmployeeName, dbo.swiftfin_Customers.reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.reference1,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 1)) AS TotalEarnings,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 2)) AS TotalDeductions                          
   FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_EmployeeTypes ON dbo.swiftfin_Employees.EmployeeTypeId = dbo.swiftfin_EmployeeTypes.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id  where swiftfin_Employees.IsLocked=0 --and swiftfin_EmployeeTypes.Category=@EmployeeType
 )
 ---SELECT * FROM swiftfin_EMPLOYEES WHERE TYPE<>4
 select EmployeeName,reference1,TotalEarnings,TotalDeducts,TotalEarnings-TotalDeducts as NetPay,@Month as Month,@PostingPeriodID as PostingPeriodID  into #temp1 from AnalysisCTE

select CustomerName as EmployeeName ,reference1,PayslipDescription,Principal+Interest as Principal,Month,PostingPeriodID,SalaryHeadCategory,2 as SortOrder into #Payslips1
  from vw_Payslips where PostingPeriodID=@PostingPeriodID and Month=@Month --and Category=@EmployeeType

insert into #Payslips(EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID)
select EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID from #Payslips1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Earnings',TotalEarnings,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Deductions',TotalDeducts,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Net Pay',NetPay,@Month,PostingPeriodID from #temp1


select Description,Category into #SalaryHeads from swiftfin_SalaryHeads

insert into #SalaryHeads (Description,Category)
select 'Total Earnings',1
union
select 'Total Deductions',3
union
select 'Net Pay',4

DECLARE @PivotColumnHeaders VARCHAR(mAX),
@select_columns VARCHAR(MAX)
SELECT @PivotColumnHeaders = COALESCE( @PivotColumnHeaders + ',[' + Description+ ']',      '[' + Description+ ']' ),
    @select_columns = COALESCE( @select_columns +  ',ISNULL(['+ Description+ '], 0) AS [' + Description+ ']' ,'ISNULL(['+ Description+ '], 0) AS [' + Description+ ']')

FROM #SalaryHeads order by Category



DECLARE @PivotTableSQL NVARCHAR(MAX)
SET @PivotTableSQL = N'
  SELECT  EmployeeName,reference1,'+@select_columns+'
  FROM (
 select EmployeeName,reference1,PayslipDescription,Principal from #Payslips) AS PivotData
 PIVOT (
    SUM(Principal)
    FOR PayslipDescription IN (
      ' + @PivotColumnHeaders + '
    )
  ) AS PivotTable
'

--select @PivotTableSQL
EXECUTE(@PivotTableSQL)

GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollAnalysisDetailedEarnings2]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



---sp_PayrollAnalysisDetailed 'CB716133-38CB-CEA8-CF3F-08D1F352E534',1
--Select * from swiftfin_postingperiods
--[sp_PayrollAnalysisDetailed] '6D1AC584-032D-E811-80D1-F40343552CF8',5,4
CREATE PROCEDURE [dbo].[sp_PayrollAnalysisDetailedEarnings2]
(
 @PostingPeriodID varchar(Max),
 @Month Int
 --@EmployeeType Int
)
 as
 create table #Payslips (EmployeeName Varchar(100),reference1 Varchar(15),PayslipDescription Varchar(50),Principal Numeric(18,2),Month int,PostingPeriodId UniqueIdentifier);

--- SET ANSI_WARNINGS OFF;
 With AnalysisCTE (EmployeeName,reference1,Mno,PayrollNo,TotalEarnings,TotalDeducts)
 as
 (
   SELECT        dbo.swiftfin_Customers.Individual_FirstName+ dbo.swiftfin_Customers.Individual_LastName AS EmployeeName, dbo.swiftfin_Customers.reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.reference1,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 1)) AS TotalEarnings,
    (SELECT        SUM(Principal) + SUM(Interest) AS Expr1
            FROM            dbo.vw_Payslips AS vw_Payslips_1
            WHERE        (EmployeeId = dbo.swiftfin_Employees.Id) AND (PostingPeriodID = @PostingPeriodID) AND (Month = @Month) AND (SalaryHeadCategory = 2)) AS TotalDeductions                          
   FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_EmployeeTypes ON dbo.swiftfin_Employees.EmployeeTypeId = dbo.swiftfin_EmployeeTypes.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id  where swiftfin_Employees.IsLocked=0 --and swiftfin_EmployeeTypes.Category=@EmployeeType
 )
 ---SELECT * FROM swiftfin_EMPLOYEES WHERE TYPE<>4
 select EmployeeName,reference1,TotalEarnings,TotalDeducts,TotalEarnings-TotalDeducts as NetPay,@Month as Month,@PostingPeriodID as PostingPeriodID  into #temp1 from AnalysisCTE

select CustomerName as EmployeeName ,reference1,PayslipDescription,Principal+Interest as Principal,Month,PostingPeriodID,SalaryHeadCategory,2 as SortOrder into #Payslips1
  from vw_Payslips where PostingPeriodID=@PostingPeriodID and Month=@Month --and Category=@EmployeeType

insert into #Payslips(EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID)
select EmployeeName,reference1,PayslipDescription,Principal,Month,PostingPeriodID from #Payslips1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Earnings',TotalEarnings,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Total Deductions',TotalDeducts,@Month,PostingPeriodID from #temp1
union
select left(EmployeeName,30),ltrim(rtrim(reference1)),'Net Pay',NetPay,@Month,PostingPeriodID from #temp1


select Description,Category into #SalaryHeads from swiftfin_SalaryHeads

insert into #SalaryHeads (Description,Category)
select 'Total Earnings',1
union
select 'Total Deductions',3
union
select 'Net Pay',4

DECLARE @PivotColumnHeaders VARCHAR(mAX),
@select_columns VARCHAR(MAX)
SELECT @PivotColumnHeaders = COALESCE( @PivotColumnHeaders + ',[' + Description+ ']',      '[' + Description+ ']' ),
    @select_columns = COALESCE( @select_columns +  ',ISNULL(['+ Description+ '], 0) AS [' + Description+ ']' ,'ISNULL(['+ Description+ '], 0) AS [' + Description+ ']')

FROM #SalaryHeads order by Category



DECLARE @PivotTableSQL NVARCHAR(MAX)
SET @PivotTableSQL = N'
  SELECT  EmployeeName,reference1,'+@select_columns+'
  FROM (
 select EmployeeName,reference1,PayslipDescription,Principal from #Payslips) AS PivotData
 PIVOT (
    SUM(Principal)
    FOR PayslipDescription IN (
      ' + @PivotColumnHeaders + '
    )
  ) AS PivotTable
'

--select @PivotTableSQL
EXECUTE(@PivotTableSQL)

GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollBankPayList]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

--select * from swiftfin_PostingPeriods
---sp_PayrollBankPayList '7B1A9AA2-8FBF-C7FA-112D-08D48C6BD7F5',5
CREATE PROCEDURE [dbo].[sp_PayrollBankPayList]
	-- Add the parameters for the stored procedure here
	(
		@PostingPeriod varchar(100),
		@SalaryMonth int,
		@EmployeeTypeId VarChar(100)
	)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

		SELECT        REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), SPACE(1), '0') AS CardNumber, dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, 
								 dbo.vw_EmployeeRegister.IdentityCardNumber, dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, 
								 dbo.vw_EmployeeRegister.EmploymentType,dbo.vw_EmployeeRegister.reference1, dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth,
								  SUM(CASE WHEN dbo.swiftfin_PaySlipEntries.SalaryHeadCategory = 1 THEN dbo.swiftfin_PaySlipEntries.Principal ELSE (dbo.swiftfin_PaySlipEntries.Principal + dbo.swiftfin_PaySlipEntries.Interest)
								  * - 1 END) AS NetPay,dbo.vw_EmployeeRegister.EmployeeTypeId
		FROM            dbo.swiftfin_PaySlips INNER JOIN
								 dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_PaySlips.Id = dbo.swiftfin_PaySlipEntries.PaySlipId INNER JOIN
								 dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
								 dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
								 dbo.swiftfin_SalaryGroups ON dbo.swiftfin_SalaryCards.SalaryGroupId = dbo.swiftfin_SalaryGroups.Id INNER JOIN
								 dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
								 dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID
		WHERE			dbo.swiftfin_PostingPeriods.id=@PostingPeriod and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.vw_EmployeeRegister.EmployeeTypeId=@EmployeeTypeId

		GROUP BY dbo.swiftfin_SalaryPeriods.Month, dbo.swiftfin_SalaryCards.CardNumber, dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, 
								 dbo.vw_EmployeeRegister.IdentityCardNumber, dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, 
								 dbo.vw_EmployeeRegister.EmploymentType, dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth,dbo.vw_EmployeeRegister.reference1,dbo.vw_EmployeeRegister.EmployeeTypeId
								 order by dbo.vw_EmployeeRegister.PersonalFileNumber

END






GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--sp_PayrollReport '2062BF6C-1B00-CE16-CC6F-08D261CBF0C2', 11, 'Basic Pay'
create PROCEDURE [dbo].[sp_PayrollReport] 
	-- Add the parameters for the stored procedure here
	(
		@PostingPeriodID VARCHAR (100),
		@SalaryMonth int,
		@SalaryHeadID VARCHAR (100)
	)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SELECT        dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.MaritalStatus, dbo.vw_EmployeeRegister.IdentityCardNumber, 
							 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
							 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, 
							 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
							 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber,dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, dbo.swiftfin_PaySlipEntries.Description, 
							 dbo.swiftfin_PaySlipEntries.Principal, dbo.swiftfin_PaySlipEntries.Interest,dbo.swiftfin_PaySlipEntries.SalaryHeadCategory
	FROM            dbo.swiftfin_PaySlipEntries INNER JOIN
							 dbo.swiftfin_PaySlips ON dbo.swiftfin_PaySlipEntries.PaySlipId = dbo.swiftfin_PaySlips.Id INNER JOIN
							 dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
							 dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
							 dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
							 dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID 
	WHERE dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.swiftfin_PaySlipEntries.Description=@SalaryHeadID
	ORDER BY dbo.vw_EmployeeRegister.PersonalFileNumber
END








GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollReportNssf]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--sp_PayrollReportNssf '6D1AC584-032D-E811-80D1-F40343552CF8', 5 
--select * from swiftfin_PostingPeriods
CREATE PROCEDURE [dbo].[sp_PayrollReportNssf] 
	-- Add the parameters for the stored procedure here
	(
		@PostingPeriodID VARCHAR (100),
		@SalaryMonth int,
		@EmployeeType UniqueIdentifier
		--@SalaryHeadID VARCHAR (100)
	)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SELECT        dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.MaritalStatus, dbo.vw_EmployeeRegister.IdentityCardNumber, 
							 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
							 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, 
							 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
							 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber,dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, dbo.swiftfin_PaySlipEntries.Description, 
							 dbo.swiftfin_PaySlipEntries.Principal,0 as Voluntary, dbo.swiftfin_PaySlipEntries.Interest,dbo.swiftfin_PaySlipEntries.SalaryHeadCategory
	FROM            dbo.swiftfin_PaySlipEntries INNER JOIN
							 dbo.swiftfin_PaySlips ON dbo.swiftfin_PaySlipEntries.PaySlipId = dbo.swiftfin_PaySlips.Id INNER JOIN
							 dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
							 dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
							 dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
							 dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID 
	WHERE dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.vw_EmployeeRegister.EmployeeTypeID=@EmployeeType and 
	 (dbo.swiftfin_PaySlipEntries.Description like '%N.S.S.F%') --and dbo.swiftfin_PaySlipEntries.Principal>0


	UNION 

	SELECT        dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.MaritalStatus, dbo.vw_EmployeeRegister.IdentityCardNumber, 
							 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
							 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, 
							 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
							 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber,dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, dbo.swiftfin_PaySlipEntries.Description, 
							0 as Principal, dbo.swiftfin_PaySlipEntries.Principal as Voluntary, dbo.swiftfin_PaySlipEntries.Interest,dbo.swiftfin_PaySlipEntries.SalaryHeadCategory
	FROM            dbo.swiftfin_PaySlipEntries INNER JOIN
							 dbo.swiftfin_PaySlips ON dbo.swiftfin_PaySlipEntries.PaySlipId = dbo.swiftfin_PaySlips.Id INNER JOIN
							 dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
							 dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
							 dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
							 dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID 
	WHERE dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.vw_EmployeeRegister.EmployeeTypeID=@EmployeeType and 
	 ( dbo.swiftfin_PaySlipEntries.Description like '%NSSF%' and dbo.swiftfin_PaySlipEntries.Principal>0)
	ORDER BY dbo.vw_EmployeeRegister.PersonalFileNumber

	--select * from swiftfin_PaySlipEntries
END



--select * from vw_EmployeeRegister




GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollReportProvidend]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--sp_PayrollReportProvidend '6D1AC584-032D-E811-80D1-F40343552CF8', 5 ,'54FE6A7C-AC2D-E811-80D1-F40343552CF8'
--select * from swiftfin_employeetypes
--select * from swiftfin_Salaryheads
CREATE PROCEDURE [dbo].[sp_PayrollReportProvidend] 
	-- Add the parameters for the stored procedure here
	(
		@PostingPeriodID VARCHAR (100),
		@SalaryMonth int,
		@EmployeeType UniqueIdentifier
		--@SalaryHeadID VARCHAR (100)
	)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SELECT        dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.MaritalStatus, dbo.vw_EmployeeRegister.IdentityCardNumber, 
							 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
							 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, 
							 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
							 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber,dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, dbo.swiftfin_PaySlipEntries.Description, 
							 dbo.swiftfin_PaySlipEntries.Principal,0 as Voluntary,dbo.swiftfin_PaySlipEntries.Principal*1.5 as EmployerContrib, dbo.swiftfin_PaySlipEntries.Interest,dbo.swiftfin_PaySlipEntries.SalaryHeadCategory
	FROM            dbo.swiftfin_PaySlipEntries INNER JOIN
                         dbo.swiftfin_PaySlips ON dbo.swiftfin_PaySlipEntries.PaySlipId = dbo.swiftfin_PaySlips.Id INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
                         dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_PaySlipEntries.SalaryHeadType = dbo.swiftfin_SalaryHeads.Type
	WHERE dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.vw_EmployeeRegister.EmployeeTypeID=@EmployeeType and 
	 (dbo.swiftfin_SalaryHeads.Type='61684') --and dbo.swiftfin_PaySlipEntries.Principal>0


	UNION 

	SELECT        dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.MaritalStatus, dbo.vw_EmployeeRegister.IdentityCardNumber, 
							 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
							 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, 
							 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
							 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber,dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, dbo.swiftfin_PaySlipEntries.Description, 
							0 as Principal, dbo.swiftfin_PaySlipEntries.Principal as Voluntary,0 as EmployerContrib, dbo.swiftfin_PaySlipEntries.Interest,dbo.swiftfin_PaySlipEntries.SalaryHeadCategory
	FROM            dbo.swiftfin_PaySlipEntries INNER JOIN
                         dbo.swiftfin_PaySlips ON dbo.swiftfin_PaySlipEntries.PaySlipId = dbo.swiftfin_PaySlips.Id INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
                         dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_PaySlipEntries.SalaryHeadType = dbo.swiftfin_SalaryHeads.Type 
	WHERE dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.vw_EmployeeRegister.EmployeeTypeID=@EmployeeType and 
	 (dbo.swiftfin_PaySlipEntries.Description='VOLUNTARY PROVIDENT CONTRIBUTION PAYABLE' and dbo.swiftfin_PaySlipEntries.Principal>0)
	ORDER BY dbo.vw_EmployeeRegister.PersonalFileNumber

	--select * from swiftfin_salaryheads
END



--select * from vw_EmployeeRegister




GO
/****** Object:  StoredProcedure [dbo].[sp_PayrollSchedule]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan>
-- Create date: <Create Date, 20/11/2015 >
-- Description:	<Description,>
-- =============================================
--select * from swiftfin_postingPeriods
--sp_PayrollSummarized '9', '2062BF6C-1B00-CE16-CC6F-08D261CBF0C2'
create PROCEDURE [dbo].[sp_PayrollSchedule]
	-- Add the parameters for the stored procedure here
	@SalaryMonth int, 
	@PostingPeriodID UniqueIdentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
SELECT dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.MaritalStatus, dbo.vw_EmployeeRegister.IdentityCardNumber, 
	   dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
	   dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, 
	   dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
	   dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
	   SPACE(1), '0') AS CardNumber,dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, dbo.swiftfin_PaySlipEntries.Description, 
	   dbo.swiftfin_PaySlipEntries.Principal, dbo.swiftfin_PaySlipEntries.Interest, CASE dbo.swiftfin_PaySlipEntries.SalaryHeadCategory WHEN 1 THEN 'EARNINGS' WHEN 2 THEN 'DEDUCTIONS' END AS SalaryHeadCategory
FROM   dbo.swiftfin_PaySlipEntries INNER JOIN
	   dbo.swiftfin_PaySlips ON dbo.swiftfin_PaySlipEntries.PaySlipId = dbo.swiftfin_PaySlips.Id INNER JOIN
	   dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
	   dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
	   dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
	   dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
       dbo.swiftfin_PostingPeriods AS swiftfin_PostingPeriods_1 ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = swiftfin_PostingPeriods_1.Id
WHERE  dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and swiftfin_PostingPeriods_1.Id=@PostingPeriodID and Principal + Interest <> 0
order by dbo.swiftfin_PaySlipEntries.SalaryHeadCategory Asc

END





GO
/****** Object:  StoredProcedure [dbo].[sp_payrollsummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

--select * from swiftfin_PostingPeriods
---sp_payrollsummary '0777363D-0845-C660-9E58-08D1336CB025',5
create PROCEDURE [dbo].[sp_payrollsummary]
	-- Add the parameters for the stored procedure here
	(
		@PostingPeriod varchar(100),
		@SalaryMonth int
	)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here

WITH DirectReports
(PostingPeriod, SalaryMonth, CardNumber, FullName, Gender,Branch, IdentityCardNumber, Nationality,MembershipNumber, EmploymentType, 
PersonalFileNumber, DateOfBirth, Designation,PersonalIdentificationNumber,NationalSocialSecurityFundNumber, 
NationalHospitalInsuranceFundNumber,BloodGroup, SalaryGroup, SalaryPeriodStatus,Description, HeadCategoryDescription, SalaryMonthName, 
SalaryHeadCategory,Amount, CreatedDate,SalaryHeadType, Balance
)
AS 
(
		SELECT        dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber, dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.Branch, dbo.vw_EmployeeRegister.IdentityCardNumber, 
								 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
								 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, 
								 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
								 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, dbo.swiftfin_SalaryGroups.Description AS SalaryGroup, 
								 CASE dbo.swiftfin_SalaryPeriods.Status WHEN 1 THEN 'Open' WHEN 2 THEN 'Closed' WHEN 3 THEN 'Suspended' END AS SalaryPeriodStatus, 
								 dbo.swiftfin_PaySlipEntries.Description, 
								 CASE dbo.swiftfin_PaySlipEntries.SalaryHeadCategory WHEN 1 THEN 'EARNINGS' WHEN 2 THEN 'DEDUCTIONS' END AS HeadCategoryDescription,(select DATENAME(MONTH, '2012-' + CAST(number as varchar(2)) + '-1') 
								FROM master..spt_values
								WHERE Type = 'P' and number between 1 and 12
								and number=dbo.swiftfin_SalaryPeriods.Month) as SalaryMonthName, 
								 dbo.swiftfin_PaySlipEntries.SalaryHeadCategory, dbo.swiftfin_PaySlipEntries.Principal, dbo.swiftfin_SalaryPeriods.CreatedDate,dbo.swiftfin_PaySlipEntries.SalaryHeadType,
									(
										select sum(amount) from swiftfin_JournalEntries where CustomerAccountId= swiftfin_PaySlipEntries.CustomerAccountId and swiftfin_JournalEntries.ChartOfAccountId=swiftfin_PaySlipEntries.ChartOfAccountId
									) as Balance
		FROM            dbo.swiftfin_PaySlips INNER JOIN
								 dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_PaySlips.Id = dbo.swiftfin_PaySlipEntries.PaySlipId INNER JOIN
								 dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
								 dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
								 dbo.swiftfin_SalaryGroups ON dbo.swiftfin_SalaryCards.SalaryGroupId = dbo.swiftfin_SalaryGroups.Id INNER JOIN
								 dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
								 dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_PaySlipEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
		WHERE			dbo.swiftfin_PostingPeriods.id=@PostingPeriod and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth



		union all
		SELECT        dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber, dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender,dbo.vw_EmployeeRegister.Branch, dbo.vw_EmployeeRegister.IdentityCardNumber, 
								 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
								 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth, dbo.vw_EmployeeRegister.Designation, 
								 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
								 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, dbo.swiftfin_SalaryGroups.Description AS SalaryGroup, 
								 CASE dbo.swiftfin_SalaryPeriods.Status WHEN 1 THEN 'Open' WHEN 2 THEN 'Closed' WHEN 3 THEN 'Suspended' END AS SalaryPeriodStatus, 
								 ltrim(rtrim(dbo.swiftfin_PaySlipEntries.Description)) +' Interest', 
								 CASE dbo.swiftfin_PaySlipEntries.SalaryHeadCategory WHEN 1 THEN 'EARNINGS' WHEN 2 THEN 'DEDUCTIONS' END AS HeadCategoryDescription,(select DATENAME(MONTH, '2012-' + CAST(number as varchar(2)) + '-1') 
								FROM master..spt_values
								WHERE Type = 'P' and number between 1 and 12
								and number=dbo.swiftfin_SalaryPeriods.Month) as SalaryMonthName, 
								 dbo.swiftfin_PaySlipEntries.SalaryHeadCategory, dbo.swiftfin_PaySlipEntries.Interest, dbo.swiftfin_SalaryPeriods.CreatedDate,dbo.swiftfin_PaySlipEntries.SalaryHeadType,
									0 as Balance
		FROM            dbo.swiftfin_PaySlips INNER JOIN
								 dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_PaySlips.Id = dbo.swiftfin_PaySlipEntries.PaySlipId INNER JOIN
								 dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
								 dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
								 dbo.swiftfin_SalaryGroups ON dbo.swiftfin_SalaryCards.SalaryGroupId = dbo.swiftfin_SalaryGroups.Id INNER JOIN
								 dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
								 dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_PaySlipEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
		WHERE			dbo.swiftfin_PostingPeriods.id=@PostingPeriod and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and  dbo.swiftfin_PaySlipEntries.Interest>0

)
select PostingPeriod, SalaryMonth, Description, HeadCategoryDescription, SalaryMonthName, branch,
SalaryHeadCategory,iif(SalaryHeadCategory=1,sum(Amount),0) as Debit,iif(SalaryHeadCategory=2,sum(Amount),0) as Credit
from DirectReports group BY PostingPeriod, SalaryMonth, Description, HeadCategoryDescription, SalaryMonthName, branch,
SalaryHeadCategory order by SalaryHeadCategory,Description


END








GO
/****** Object:  StoredProcedure [dbo].[sp_payslips]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

--select * from swiftfin_PostingPeriods
---sp_payslips 'CB716133-38CB-CEA8-CF3F-08D1F352E534',1
create PROCEDURE [dbo].[sp_payslips]
	-- Add the parameters for the stored procedure here
	(
		@PostingPeriod varchar(100),
		@SalaryMonth int
	)
AS
BEGIN
	Declare @EndDate Datetime
	
	---set @EndDate=(select EndDate from 
	---GetMonthList((select Duration_StartDate from swiftfin_PostingPeriods where id=@PostingPeriod),1) where MonthNumber=@SalaryMonth)
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here

WITH DirectReports
(PostingPeriod, SalaryMonth, CardNumber, FullName, Gender, IdentityCardNumber, Nationality,MembershipNumber, EmploymentType, 
PersonalFileNumber, DateOfBirth,RetirementAge, Designation,PersonalIdentificationNumber,NationalSocialSecurityFundNumber, 
NationalHospitalInsuranceFundNumber,BloodGroup, SalaryGroup, SalaryPeriodStatus,Description, HeadCategoryDescription, SalaryMonthName, 
SalaryHeadCategory,Amount, CreatedDate,SalaryHeadType, Balance
)
AS 
(
		SELECT        dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber, dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.IdentityCardNumber, 
								 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
								 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth,DATEADD(yy,60,dbo.vw_EmployeeRegister.DateOfBirth), dbo.vw_EmployeeRegister.Designation, 
								 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
								 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, dbo.swiftfin_SalaryGroups.Description AS SalaryGroup, 
								 CASE dbo.swiftfin_SalaryPeriods.Status WHEN 1 THEN 'Open' WHEN 2 THEN 'Closed' WHEN 3 THEN 'Suspended' END AS SalaryPeriodStatus, 
								 dbo.swiftfin_PaySlipEntries.Description, 
								 CASE dbo.swiftfin_PaySlipEntries.SalaryHeadCategory WHEN 1 THEN 'EARNINGS' WHEN 2 THEN 'DEDUCTIONS' END AS HeadCategoryDescription,(select DATENAME(MONTH, '2012-' + CAST(number as varchar(2)) + '-1') 
								FROM master..spt_values
								WHERE Type = 'P' and number between 1 and 12
								and number=dbo.swiftfin_SalaryPeriods.Month) as SalaryMonthName, 
								 dbo.swiftfin_PaySlipEntries.SalaryHeadCategory, dbo.swiftfin_PaySlipEntries.Principal, dbo.swiftfin_SalaryPeriods.CreatedDate,dbo.swiftfin_PaySlipEntries.SalaryHeadType,
								case dbo.swiftfin_PaySlipEntries.SalaryHeadCategory
								WHEN 1 THEN 0
								else
									isnull((
									SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
									FROM            dbo.swiftfin_JournalEntries INNER JOIN
															 dbo.Products(0) AS Products_1 ON dbo.swiftfin_JournalEntries.ChartOfAccountId = Products_1.ChartOfAccountId INNER JOIN
															 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id AND 
															 Products_1.id = dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId
						 															 WHERE        (dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_PaySlipEntries.CustomerAccountId) AND 
															 (dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_PaySlipEntries.ChartOfAccountId) AND 
															 (dbo.swiftfin_JournalEntries.CreatedDate <= dbo.swiftfin_PaySlipEntries.CreatedDate) 
																		),0)
								end as Balance
		FROM            dbo.swiftfin_PaySlips INNER JOIN
								 dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_PaySlips.Id = dbo.swiftfin_PaySlipEntries.PaySlipId INNER JOIN
								 dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
								 dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
								 dbo.swiftfin_SalaryGroups ON dbo.swiftfin_SalaryCards.SalaryGroupId = dbo.swiftfin_SalaryGroups.Id INNER JOIN
								 dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
								 dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_PaySlipEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
		WHERE			dbo.swiftfin_PostingPeriods.id=@PostingPeriod and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth



		union all
		SELECT        dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, dbo.swiftfin_SalaryPeriods.Month AS SalaryMonth, REPLACE(STR(dbo.swiftfin_SalaryCards.CardNumber, 4), 
								 SPACE(1), '0') AS CardNumber, dbo.vw_EmployeeRegister.FullName, dbo.vw_EmployeeRegister.Gender, dbo.vw_EmployeeRegister.IdentityCardNumber, 
								 dbo.vw_EmployeeRegister.Nationality, dbo.vw_EmployeeRegister.MembershipNumber, dbo.vw_EmployeeRegister.EmploymentType, 
								 dbo.vw_EmployeeRegister.PersonalFileNumber, dbo.vw_EmployeeRegister.DateOfBirth,DATEADD(yy,60,dbo.vw_EmployeeRegister.DateOfBirth), dbo.vw_EmployeeRegister.Designation, 
								 dbo.vw_EmployeeRegister.PersonalIdentificationNumber, dbo.vw_EmployeeRegister.NationalSocialSecurityFundNumber, 
								 dbo.vw_EmployeeRegister.NationalHospitalInsuranceFundNumber, dbo.vw_EmployeeRegister.BloodGroup, dbo.swiftfin_SalaryGroups.Description AS SalaryGroup, 
								 CASE dbo.swiftfin_SalaryPeriods.Status WHEN 1 THEN 'Open' WHEN 2 THEN 'Closed' WHEN 3 THEN 'Suspended' END AS SalaryPeriodStatus, 
								 ltrim(rtrim(dbo.swiftfin_PaySlipEntries.Description)) +' Interest', 
								 CASE dbo.swiftfin_PaySlipEntries.SalaryHeadCategory WHEN 1 THEN 'EARNINGS' WHEN 2 THEN 'DEDUCTIONS' END AS HeadCategoryDescription,(select DATENAME(MONTH, '2012-' + CAST(number as varchar(2)) + '-1') 
								FROM master..spt_values
								WHERE Type = 'P' and number between 1 and 12
								and number=dbo.swiftfin_SalaryPeriods.Month) as SalaryMonthName, 
								 dbo.swiftfin_PaySlipEntries.SalaryHeadCategory, dbo.swiftfin_PaySlipEntries.Interest, dbo.swiftfin_SalaryPeriods.CreatedDate,dbo.swiftfin_PaySlipEntries.SalaryHeadType,
									0 as Balance
		FROM            dbo.swiftfin_PaySlips INNER JOIN
								 dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_PaySlips.Id = dbo.swiftfin_PaySlipEntries.PaySlipId INNER JOIN
								 dbo.swiftfin_SalaryCards ON dbo.swiftfin_PaySlips.SalaryCardId = dbo.swiftfin_SalaryCards.Id INNER JOIN
								 dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
								 dbo.swiftfin_SalaryGroups ON dbo.swiftfin_SalaryCards.SalaryGroupId = dbo.swiftfin_SalaryGroups.Id INNER JOIN
								 dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
								 dbo.vw_EmployeeRegister ON dbo.swiftfin_SalaryCards.EmployeeId = dbo.vw_EmployeeRegister.EmployeeID INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_PaySlipEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
		WHERE			dbo.swiftfin_PostingPeriods.id=@PostingPeriod and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and  dbo.swiftfin_PaySlipEntries.Interest>0

)
select PostingPeriod, SalaryMonth, CardNumber, FullName, Gender, IdentityCardNumber, Nationality,MembershipNumber, EmploymentType, 
PersonalFileNumber, DateOfBirth,RetirementAge, Designation,PersonalIdentificationNumber,NationalSocialSecurityFundNumber, 
NationalHospitalInsuranceFundNumber,BloodGroup, SalaryGroup, SalaryPeriodStatus,Description, HeadCategoryDescription, SalaryMonthName, 
SalaryHeadCategory,Amount, CreatedDate,SalaryHeadType, Balance
from DirectReports ORDER BY PersonalFileNumber,SalaryHeadCategory,SalaryHeadType,CreatedDate,Description


END








GO
/****** Object:  StoredProcedure [dbo].[sp_Procedure]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from temploanposting
CREATE procedure [dbo].[sp_Procedure] 

as
begin
	declare @JournalID uniqueidentifier =newid()

	insert into swiftfin_Journals (Id, PostingPeriodId, BranchId, JournalVoucherId, FiscalCountId, DebitCardLogId, TotalValue, PrimaryDescription, SecondaryDescription, Reference, 
                         ApplicationUserName, EnvironmentUserName, EnvironmentMachineName, EnvironmentDomainName, EnvironmentOSVersion, EnvironmentMACAddress, 
                         EnvironmentMotherboardSerialNumber, EnvironmentProcessorId, ModuleNavigationItemCode, IsLocked, CreatedDate)
	
	SELECT        JournalID, PostingPeriodId, BranchId, JournalVoucherId, FiscalCountId, DebitCardLogId, TotalValue, primaryDescription, SecondaryDescription, Reference, 
							 ApplicationUserName, EnvironmentUserName, EnvironmentMachineName, EnvironmentDomainName, EnvironmentOSVersion, EnvironmentMACAddress, 
							 EnvironmentMotherboardSerialNumber, EnvironmentProcessorId, ModuleNavigationItemCode, IsLocked, CreatedDate 
	 FROM            tempLoanPosting

	insert into   swiftfin_JournalEntries(Id, JournalId, ChartOfAccountId, ContraChartOfAccountId, CustomerAccountId, Amount, CreatedDate)
	SELECT        newid(), JournalID, ChartOfAccountId, '3F0E3661-52EA-C90C-A2AE-08D10CB839E9', CustomerAccountId, TotalValue*-1, CreatedDate
	FROM           tempLoanPosting

	insert into   swiftfin_JournalEntries(Id, JournalId, ChartOfAccountId, ContraChartOfAccountId, CustomerAccountId, Amount, CreatedDate)
	SELECT        newid(), JournalID,  '3F0E3661-52EA-C90C-A2AE-08D10CB839E9', ChartOfAccountId, CustomerAccountId, TotalValue, CreatedDate
	FROM            tempLoanPosting



end


---delete from swiftfin_journals where id in (select id from tempLoanPosting)
---delete from swiftfin_journalentries where journalid in (select id from tempLoanPosting)
---select * from swiftfin_JournalEntries
---update tempLoanPosting set journalid=newid()
---delete from swiftfin_Journalentries where JournalId in (select JournalId from tempLoanPosting)
---delete from swiftfin_Journals where id in (select JournalId from tempLoanPosting)






GO
/****** Object:  StoredProcedure [dbo].[sp_ProductAccountBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_ProductAccountBalances] 
	-- Add the parameters for the stored procedure here
	@enddate datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

 /****** Script for SelectTopNRows command from SSMS  ******/
SELECT 
	(SELECT 
	    RIGHT('00000'+CAST(ltrim(rtrim(SerialNumber)) AS VARCHAR(6)),6) 
		FROM [dbo].[swiftfin_Customers] 
		where id= [dbo].[swiftfin_CustomerAccounts].CustomerId) as MembershipNumber,
	(SELECT 
	   Individual_PayrollNumbers AS PersonalFileNumber
		FROM [dbo].[swiftfin_Customers] 
		where id= [dbo].[swiftfin_CustomerAccounts].CustomerId) as PersonalFileNumber,
	(SELECT 
		[Salutation] =
		CASE [Individual_Salutation]
			WHEN '48814' THEN 'Mr'
			WHEN '48815' THEN 'Mrs'
			WHEN '48816' THEN 'Miss'
			WHEN '48817' THEN 'Dr'
			WHEN '48818' THEN 'Prof'
			WHEN '48819' THEN 'Rev'
			WHEN '48820' THEN 'Eng'
			WHEN '48821' THEN 'Hon'
			WHEN '48822' THEN 'Cllr'
			WHEN '48823' THEN 'Sir'
			WHEN '48824' THEN 'Ms'
			ELSE 'UnKnown'
		END +' '+
		[Individual_FirstName]+' '+
		[Individual_LastName]
		FROM [dbo].[swiftfin_Customers] 
		WHERE id= [dbo].[swiftfin_CustomerAccounts].CustomerId) as FullName
      ,
	  (SELECT [Description]
        FROM [dbo].[swiftfin_Branches] 
		WHERE ID=[dbo].[swiftfin_CustomerAccounts].[BranchId]) AS BranchName,
 		[Product Type] =
		CASE [CustomerAccountType_ProductCode]
			WHEN 1 THEN 'Savings'
			WHEN 2 THEN 'Loans'
			WHEN 3 THEN 'Investments'
			ELSE 'UnKnown'
		END 
		,
		[Product] =
		CASE [CustomerAccountType_ProductCode]
			WHEN 1 THEN 
				(SELECT 
				 [Description]
				FROM [dbo].[swiftfin_SavingsProducts] 
				WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
			WHEN 2 THEN 
				(SELECT 
				 [Description]
				FROM [dbo].[swiftfin_LoanProducts] 
				WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
			WHEN 3 THEN 
				(SELECT 
				 [Description]
				FROM [dbo].[swiftfin_InvestmentProducts] 
				WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
			ELSE 'UnKnown'
		END,
		[Product Balance] =
		ISNULL(
				CASE [CustomerAccountType_ProductCode]
					WHEN 1 THEN 
					(SELECT 
						 (
							SELECT SUM(AMOUNT)
							FROM [dbo].[swiftfin_JournalEntries] 
							WHERE CustomerAccountId=[dbo].[swiftfin_CustomerAccounts].ID AND ChartOfAccountId=[dbo].[swiftfin_SavingsProducts].[ChartOfAccountId] AND CreatedDate<=@enddate
						 )
					FROM [dbo].[swiftfin_SavingsProducts] 
					WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
					WHEN 2 THEN 
					(SELECT 
						 (
							SELECT SUM(AMOUNT)
							FROM [dbo].[swiftfin_JournalEntries] 
							WHERE CustomerAccountId=[dbo].[swiftfin_CustomerAccounts].ID AND ChartOfAccountId=[dbo].[swiftfin_LoanProducts].[ChartOfAccountId] AND CreatedDate<=@enddate
						 )
					FROM [dbo].[swiftfin_LoanProducts] 
					WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
					WHEN 3 THEN 
					(SELECT 
						 (
							SELECT SUM(AMOUNT)
							FROM [dbo].[swiftfin_JournalEntries] 
							WHERE CustomerAccountId=[dbo].[swiftfin_CustomerAccounts].ID AND ChartOfAccountId=[dbo].[swiftfin_InvestmentProducts].[ChartOfAccountId] AND CreatedDate<=@enddate
						 )
					FROM [dbo].[swiftfin_InvestmentProducts] 
					WHERE ID=[dbo].[swiftfin_CustomerAccounts].[CustomerAccountType_TargetProductId])
				ELSE 0
				END 
				,0)
      ,[Remarks]
      ,[CreatedDate]
  FROM [dbo].[swiftfin_CustomerAccounts]
END











GO
/****** Object:  StoredProcedure [dbo].[sp_ProductBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--[sp_ProductBalances] '01/23/2018'
create PROCEDURE [dbo].[sp_ProductBalances] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
AS

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
		set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	with LoanProductCTE (FullName, IdNo,PayrollNo,AccNo,Amount) as 
			
(
			SELECT        Individual_FirstName+' '+Individual_LastName, Individual_IdentityCardNumber,  Individual_PayrollNumbers,Reference1,
			isnull((

			SELECT        sum(dbo.swiftfin_JournalEntries.Amount)
			FROM            dbo.swiftfin_CustomerAccounts INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
									 dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
									 dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
			WHERE        (dbo.swiftfin_CustomerAccounts.CustomerId = vw_MemberRegister.Id and swiftfin_JournalEntries.CreatedDate<=@EndDate) 
			),0)*-1 
					
		
			FROM            dbo.vw_MemberRegister
			)
		


Select * from LoanProductCTE where amount<>0



GO
/****** Object:  StoredProcedure [dbo].[sp_ProductBalancesInOutFlows]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_InvestmentProductsInflows '5/1/2016','8/25/2016','043ED62E-3628-C988-8056-08D2B77ECFF2'
---select * from swiftfin_branches

--select * from products(0)
create procedure [dbo].[sp_ProductBalancesInOutFlows]

@StartDate Datetime,
@EndDate Datetime
---@Branch uniqueidentifier

as

SELECT         PRODUCTS.Description As ProductType,swiftfin_Branches.id as branchid,swiftfin_Branches.Description as branch,PRODUCTS.type,
ISNULL(CASE WHEN sum(swiftfin_JournalEntries.Amount) < 0 THEN sum(swiftfin_JournalEntries.Amount) * - 1 END, 0) AS Debit,
ISNULL(CASE WHEN sum(swiftfin_JournalEntries.Amount) > 0 THEN sum(swiftfin_JournalEntries.Amount) END, 0) AS credit

FROM            swiftfin_Branches INNER JOIN
                         swiftfin_Journals ON swiftfin_Branches.Id = swiftfin_Journals.BranchId INNER JOIN
                         swiftfin_JournalEntries INNER JOIN
                          dbo.Products(0) ON swiftfin_JournalEntries.ChartOfAccountId =  Products.ChartOfAccountId ON swiftfin_Journals.Id = swiftfin_JournalEntries.JournalId
where swiftfin_JournalEntries.CreatedDate between @StartDate and @EndDate --- and swiftfin_Journals.BranchId in (@Branch)
						 group by  Products.Description,swiftfin_Branches.id,PRODUCTS.type,swiftfin_Branches.Description
						 order by PRODUCTS.type,swiftfin_Branches.Description



GO
/****** Object:  StoredProcedure [dbo].[sp_ProductsBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from products(0)
---sp_ProductsBalances '06/30/2015','<>',0,'5F692D2F-E739-C3FD-33E2-08D20DA8F789'
CREATE procedure [dbo].[sp_ProductsBalances]
	--@ID UniqueIdentifier, 
	@Enddate Datetime,
	@Operator char(2),
	@OperatorValue float,
	@ProductID UniqueIdentifier
AS
	declare @ID UniqueIdentifier
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'))
	set @ID = (Select top 1 ChartOfAccountid from Products(0) where id=@ProductID)

	;

BEGIN
	SET NOCOUNT ON;

;WITH JournalEntries (CustomerAccountID, Amount,ChartOfAccountId) AS
(
	SELECT CustomerAccountID, Amount,ChartOfAccountId
    FROM swiftfin_JournalEntries  where ChartOfAccountId IN (@ID) and CreatedDate<=@Enddate
),


CustomerAccounts (ID,FullAccount,FullName,Description,Reference1,Reference3, CustomerAccountType_TargetProductId) AS
(
	SELECT ID,FullAccount,FullName,Description,Reference1,Reference3, CustomerAccountType_TargetProductId
    FROM vw_CustomerAccounts h
),

Listing (FullName,FullAccount,Description,Balance,ChartOfAccountId,Reference1,Reference3) as
(
	SELECT   o.FullName,o.FullAccount,o.Description,sum(od.Amount) AS Balance,od.ChartOfAccountId,Reference1,Reference3
	FROM CustomerAccounts o
    INNER JOIN JournalEntries od ON o.id = od.CustomerAccountID
	where o.CustomerAccountType_TargetProductId =@ProductID
	GROUP BY o.FullAccount,o.FullName ,o.Description,od.ChartOfAccountId,reference1,Reference3
),
	
Summary (FullAccount,FullName,Description, Balance,type,Reference1,Reference3) as
(
	select a.FullAccount,a.FullName,a.Description, 
	case 
	When _products.type ='Loans' 
	Then a.Balance*-1
	else a.Balance end as Balance  ,_products.type,Reference1,Reference3
	From Listing a
	left JOIN dbo.products(0) _products on a.ChartOfAccountId=_products.ChartOfAccountId
	
)

select distinct FullAccount,FullName,Description, Balance ,type,Reference1,Reference3
From Summary 
where	(
			(@Operator = '>' and Balance  > @OperatorValue)
			or (@Operator = '<' and Balance < @OperatorValue)
			or (@Operator = '<>' and Balance != @OperatorValue)
			or (@Operator = '>=' and Balance >= @OperatorValue)
			or (@Operator = '<=' and Balance <= @OperatorValue)
			or (@Operator = '=' and Balance = @OperatorValue)
		)

end






GO
/****** Object:  StoredProcedure [dbo].[sp_ProductsListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================

CREATE PROCEDURE [dbo].[sp_ProductsListing]
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

select id,'Savings     ' as type,Description,ChartOfAccountId into #temp from swiftfin_SavingsProducts

insert into #temp(id,type,Description,ChartOfAccountId)
select id,'Loans',Description,ChartOfAccountId from swiftfin_LoanProducts

insert into #temp(id,type,Description,ChartOfAccountId)
select id,'Investments',Description,ChartOfAccountId from swiftfin_InvestmentProducts

select id,type, description,ChartOfAccountId from #temp
END











GO
/****** Object:  StoredProcedure [dbo].[sp_ProductSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
---sp_ProductSummary '01/18/2017'
---select * from products(0)
CREATE Procedure [dbo].[sp_ProductSummary] (@EndDate DateTime)
as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
with productSummaryCTE(Code,Type,Description,Balance)
as
(
select Code,Type,Description,
isnull((select sum(amount)  from dbo.swiftfin_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId 
						 and swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId=Products.id  
						  where ChartOfAccountId=Products.ChartOfAccountId and swiftfin_JournalEntries.CreatedDate<=@EndDate),0) Balance
 from products(0)  )
 select * from productSummaryCTE where isnull(Balance,0)<>0 order by type,code
GO
/****** Object:  StoredProcedure [dbo].[Sp_PurchaseOrdersItems]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Gilbert
-- Create date: 18/06/2018
-- Description:	PurchaseOrderItems
-- =============================================
Create PROCEDURE [dbo].[Sp_PurchaseOrdersItems] 
	-- Add the parameters for the stored procedure here
@PurchaseOrderId uniqueidentifier 
AS
BEGIN
--set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_PurchaseOrders.ReferenceNumber, dbo.swiftfin_Suppliers.Description AS Supplier, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_ItemRegister.Description AS Name, dbo.swiftfin_ItemRegister.Code, 
                         dbo.swiftfin_PurchaseOrderItems.Quantity, dbo.swiftfin_PurchaseOrderItems.QuantitySupplied, dbo.swiftfin_PurchaseOrderItems.UnitCost, dbo.swiftfin_PurchaseOrderItems.TotalCost, Case dbo.swiftfin_PurchaseOrderItems.Status when 0 Then 'Pending' when 1 Then 'Active' when 2 then 'Closed' else '' end As Status, 
                         dbo.swiftfin_PurchaseOrderItems.CreatedBy, dbo.swiftfin_PurchaseOrderItems.CreatedDate, Case dbo.swiftfin_ItemRegister.ItemType when 1 Then 'Asset' When 2 Then 'Inventory' else '' end AS ItemType, dbo.swiftfin_InventoryUnitsOfMeasure.Description AS UnitsOfMeasure, 
                         dbo.swiftfin_PurchaseOrderItems.PurchaseOrderId
FROM            dbo.swiftfin_PurchaseOrders INNER JOIN
                         dbo.swiftfin_Suppliers ON dbo.swiftfin_PurchaseOrders.SupplierId = dbo.swiftfin_Suppliers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_PurchaseOrders.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_PurchaseOrderItems ON dbo.swiftfin_PurchaseOrders.Id = dbo.swiftfin_PurchaseOrderItems.PurchaseOrderId INNER JOIN
                         dbo.swiftfin_ItemRegister ON dbo.swiftfin_PurchaseOrderItems.ItemRegisterId = dbo.swiftfin_ItemRegister.Id INNER JOIN
                         dbo.swiftfin_InventoryUnitsOfMeasure ON dbo.swiftfin_ItemRegister.InventoryUnitOfMeasureId = dbo.swiftfin_InventoryUnitsOfMeasure.Id
                      
                        
	where  dbo.swiftfin_PurchaseOrderItems.PurchaseOrderId=@PurchaseOrderId
END
GO
/****** Object:  StoredProcedure [dbo].[Sp_Quotations]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Gilbert
-- Create date: 18/06/2018
-- Description:	Quotation
-- =============================================
CREATE PROCEDURE [dbo].[Sp_Quotations] 
	-- Add the parameters for the stored procedure here
@QuotationId uniqueidentifier 
AS
BEGIN
--set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    SELECT      Distinct  dbo.swiftfin_Quotations.ReferenceNumber, dbo.swiftfin_Quotations.DocumentNumber, dbo.swiftfin_Quotations.FileName, dbo.swiftfin_Quotations.FileTitle, dbo.swiftfin_Quotations.FileDescription, dbo.swiftfin_Quotations.QuotationDate, 
                         dbo.swiftfin_Quotations.CreatedBy, dbo.swiftfin_Quotations.CreatedDate, dbo.swiftfin_Quotations.ExpiryDate, dbo.swiftfin_Quotations.Period, dbo.swiftfin_QuotationItems.TotalCost, dbo.swiftfin_QuotationItems.Quantity, 
                         dbo.swiftfin_QuotationItems.UnitCost, dbo.swiftfin_Suppliers.Description AS SupplierName, dbo.swiftfin_Branches.Description AS Branch,dbo.swiftfin_QuotationItems.QuotationId
FROM            dbo.swiftfin_Quotations INNER JOIN
                         dbo.swiftfin_QuotationItems ON dbo.swiftfin_Quotations.Id = dbo.swiftfin_QuotationItems.QuotationId INNER JOIN
                         dbo.swiftfin_Suppliers ON dbo.swiftfin_Quotations.SupplierId = dbo.swiftfin_Suppliers.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Quotations.BranchId = dbo.swiftfin_Branches.Id
	where  dbo.swiftfin_QuotationItems.QuotationId=@QuotationId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_RapaymentSchedule]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:  <Author,,Name>
-- Create date: <Create Date,,>
-- Description: <Description,,>
-- =============================================

---sp_RapaymentSchedule 35000,10,10,.2,'02/09/2015',1
CREATE PROCEDURE [dbo].[sp_RapaymentSchedule] 
 -- Add the parameters for the stored procedure here
 
 @LoanAmount float, ----The term of the loan in years
 @payment_frequency as float, ---The number of payments in a year
 @Term as float,  ----The number of payments in a year
 @annual_rate as float, --.07 --The annual rate of interest
 @startdate datetime,
 @Pay_type as bit---- = 0 --Identifies the payment as due at the end (0) or the beginning (1) of the period 
 as
 set @LoanAmount=@LoanAmount*-1
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

    -- Insert statements for procedure here
 
/**Loan Repayment Schedule**/
DECLARE 
 @PV as Float = @LoanAmount
,@FV as float = 0 --Value of the loan at termination

,@rate as float
,@nper as float
 
Set @rate = @annual_rate/@payment_frequency
Set @nper = @Term * @payment_frequency
 
;WITH
Nbrs_3( n ) AS ( SELECT 1 UNION SELECT 0 ),
Nbrs_2( n ) AS ( SELECT 1 FROM Nbrs_3 n1 CROSS JOIN Nbrs_3 n2 ),
Nbrs_1( n ) AS ( SELECT 1 FROM Nbrs_2 n1 CROSS JOIN Nbrs_2 n2 ),
Nbrs_0( n ) AS ( SELECT 1 FROM Nbrs_1 n1 CROSS JOIN Nbrs_1 n2 ),
Nbrs ( n ) AS ( SELECT 1 FROM Nbrs_0 n1 CROSS JOIN Nbrs_0 n2 )
SELECT n as [Period],
/*CASE @payment_frequency
WHEN 13 THEN convert(varchar, DATEADD(week,4*n,@startdate),106)
WHEN 26 THEN convert(varchar, DATEADD(week,2*n,@startdate),106)
WHEN 52 THEN convert(varchar, DATEADD(week,n,@startdate),106)
ELSE convert(varchar, DATEADD(m,12*n/@payment_frequency,@startdate),106)  
 END as [Due Date]*/

 convert(varchar, DATEADD(mm,n,@startdate),106) as Due_Date

 
,-dbo.PV(@rate,@nper-(n-1),dbo.PMT(@rate,@nper,@PV,@FV,@pay_type),@FV,@pay_type) as [Starting Balance]
,dbo.PMT(@rate,@nper,@PV,@FV,@pay_type) as [Payment]
,dbo.IPMT(@rate,n,@nper,@PV,@FV,@pay_type) as [Interest Payment]
,dbo.PPMT(@rate,n,@nper,@PV,@FV,@pay_type) as [Principal Payment]
,-dbo.PV(@rate,@nper-n,dbo.PMT(@rate,@nper,@PV,@FV,@pay_type),@FV,@pay_type) as [Ending Balance]
 FROM ( SELECT ROW_NUMBER() OVER (ORDER BY n)
           FROM Nbrs ) D( n )
 WHERE n <= @nper
END





GO
/****** Object:  StoredProcedure [dbo].[sp_Recoveries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_enumerations
--select * from swiftfin_loanproducts
--sp_Recoveries '08/01/2016','08/30/2016'

CREATE PROCEDURE [dbo].[sp_Recoveries] 
 @StartingDate DateTime,
 @EndingDate DateTime
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 --set @Month=ltrim(rtrim(@Month))
    -- Insert statements for procedure here

SELECT        dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.PostingPeriodId, dbo.swiftfin_Journals.BranchId, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
              dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount as Principal,0 as Interest, LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_FirstName)) + ' ' + LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS FullName, 
              dbo.swiftfin_Customers.Individual_Salutation, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Employers.Description AS Employer, 
              dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection,swiftfin_ChartOfAccounts.CostCenterId,swiftfin_LoanProducts.Id,swiftfin_LoanProducts.Description as ProductName,
     dbo.swiftfin_Branches.id, swiftfin_Enumerations.Value,
    Case dbo.swiftfin_Journals.TransactionCode
     WHEN 32 THEN 'Payout'
     WHEN 28 THEN 'Check-Off'
     WHEN 18 THEN 'Back Office Cash Receipt'
     WHEN 27 THEN 'Payroll Recoveries'
     WHEN 14 THEN 'Inter-Acccount Funds Transfer'
     WHEN 30 THEN 'Scheduled Standing Order'
     WHEN 30 THEN 'Manual Standing Order'
     END As Transactioncode
       
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
              dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
           dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
              dbo.swiftfin_Enumerations ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_Enumerations.Value
WHERE         swiftfin_JournalEntries.ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) 
              and swiftfin_Journals.CreatedDate between @StartingDate and @EndingDate and (dbo.swiftfin_Journals.TransactionCode IN (32, 268435456, 131072, 8192, 134217728, 32768,536870913))  
UNION
SELECT        dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.PostingPeriodId, dbo.swiftfin_Journals.BranchId, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
              dbo.swiftfin_ChartOfAccounts.AccountName, 0 as Principal,Amount as Interest, ltrim(rtrim(dbo.swiftfin_Customers.Individual_FirstName))+' '+ ltrim(rtrim(dbo.swiftfin_Customers.Individual_LastName)) as FullName, dbo.swiftfin_Customers.Individual_Salutation, 
              dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3,  dbo.swiftfin_Employers.Description as Employer, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection, 
     swiftfin_ChartOfAccounts.CostCenterId,swiftfin_LoanProducts.Id,swiftfin_LoanProducts.Description as ProductName, dbo.swiftfin_Branches.Id, swiftfin_Enumerations.Value,
     Case dbo.swiftfin_Journals.TransactionCode
     WHEN 32 THEN 'Payout'
     WHEN 28 THEN 'Check-Off'
     WHEN 18 THEN 'Back Office Cash Receipt'
     WHEN 27 THEN 'Payroll Recoveries'
     WHEN 14 THEN 'Inter-Acccount Funds Transfer'
     WHEN 30 THEN 'Scheduled Standing Order'
     WHEN 30 THEN 'Manual Standing Order'
     END As Transactioncode
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId INNER JOIN
              dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
           dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
              dbo.swiftfin_Enumerations ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_Enumerations.Value
WHERE         swiftfin_JournalEntries.ChartOfAccountId  in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts) 
     and swiftfin_Journals.CreatedDate between @StartingDate and @EndingDate and  (dbo.swiftfin_Journals.TransactionCode IN (32, 28, 18, 27, 14, 30,30)) 


END





GO
/****** Object:  StoredProcedure [dbo].[sp_RecoveriesByBatch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_RecoveriesByBatch '08/31/2018','08/31/2018',854
--select * from swiftfin_CreditBatches
CREATE PROCEDURE [dbo].[sp_RecoveriesByBatch]
 -- Add the parameters for the stored procedure here
--@TransactionCode Int,
@StartDate DateTime, 
@EndDate DateTime,
@BatchNo varchar
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
 With LoanProductBalances(AccountNo,Reference1,Reference2,Reference3,AccountName,Description, PayrollNumber, Code,Balance,Interest,Tranxcode,Branch,costcenter,BatchNo)
 AS
 (
  SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
   dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description, dbo.vw_customeraccounts.Individual_PayrollNumbers,  dbo.swiftfin_Journals.TransactionCode, 0,
  SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_Journals.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId,dbo.swiftfin_Journals.Reference
  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
                         dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id inner join
						 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
  WHERE       dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate and  left(dbo.swiftfin_Journals.Reference,7) like '%@BatchNo%'
  GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
  dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_Journals.TransactionCode,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers,dbo.swiftfin_Journals.Reference,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_Journals.BranchId,
  dbo.swiftfin_ChartOfAccounts.CostCenterId
  UNION ALL
  SELECT        dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
  dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers,dbo.swiftfin_Journals.TransactionCode, 
  SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,0,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_Journals.BranchId,dbo.swiftfin_ChartOfAccounts.CostCenterId,dbo.swiftfin_Journals.Reference
  FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id inner join
						 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_LoanProducts.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
  WHERE       dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate and  left(dbo.swiftfin_Journals.Reference,7) like '%@BatchNo%'
  GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3,  dbo.vw_CustomerAccounts.FullName,
  dbo.vw_CustomerAccounts.FullAccount,dbo.swiftfin_Journals.TransactionCode,dbo.vw_CustomerAccounts.Description,dbo.vw_customeraccounts.Individual_PayrollNumbers,dbo.swiftfin_Journals.Reference,dbo.swiftfin_Journals.TransactionCode,dbo.swiftfin_Journals.BranchId
  ,dbo.swiftfin_ChartOfAccounts.CostCenterId
 )
 SELECT AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,
 AccountName,Description,PayrollNumber, Code,SUM(Balance) AS Balance,sum(Interest) as Interest ,Tranxcode,Branch,costcenter,BatchNo
 FROM LoanProductBalances 
 Group By AccountNo,Reference1,Reference2,Reference3,AccountName,Code,Tranxcode,Branch,costcenter,Description,PayrollNumber,BatchNo having SUM(Balance) +sum(Interest)<>0
END
GO
/****** Object:  StoredProcedure [dbo].[sp_RecoveriesByRecoveryMode]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_loanproducts
--sp_RecoveriesByRecoveryMode '2062BF6C-1B00-CE16-CC6F-08D261CBF0C2','09/01/2015','09/30/2015','32'
CREATE PROCEDURE [dbo].[sp_RecoveriesByRecoveryMode] 
	@BranchID UniqueIdentifier,
	@StartingDate DateTime,
	@EndingDate DateTime,
	@TransactionCode Integer
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	--set @Month=ltrim(rtrim(@Month))
    -- Insert statements for procedure here

SELECT        dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.PostingPeriodId, dbo.swiftfin_Journals.BranchId, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
                         dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount, LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_FirstName)) + ' ' + LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS FullName, 
                         dbo.swiftfin_Customers.Individual_Salutation, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Employers.Description AS Employer, 
                         dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection,swiftfin_ChartOfAccounts.CostCenterId,swiftfin_LoanProducts.Id,swiftfin_LoanProducts.Description as ProductName,
						 Case dbo.swiftfin_Journals.TransactionCode
						 WHEN 32 THEN 'Payout'
						 WHEN 268435456 THEN 'Check-Off'
						 WHEN 131072 THEN 'Back Office Cash Receipt'
						 WHEN 134217728 THEN 'Payroll Recoveries'
						 WHEN 8192 THEN 'Inter-Acccount Funds Transfer'
						 END As Transactioncode
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
                         dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
                         dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
                         dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
WHERE  swiftfin_JournalEntries.ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) and
swiftfin_Journals.CreatedDate between @StartingDate and @EndingDate and (dbo.swiftfin_Journals.TransactionCode IN (32, 268435456, 131072, 8192, 134217728))  and 
dbo.swiftfin_Journals.TransactionCode =@TransactionCode

UNION
SELECT        dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.PostingPeriodId, dbo.swiftfin_Journals.BranchId, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
              dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount, ltrim(rtrim(dbo.swiftfin_Customers.Individual_FirstName))+' '+ ltrim(rtrim(dbo.swiftfin_Customers.Individual_LastName)) as FullName, dbo.swiftfin_Customers.Individual_Salutation, 
              dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3,  dbo.swiftfin_Employers.Description as Employer, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection, 
			  swiftfin_ChartOfAccounts.CostCenterId,swiftfin_LoanProducts.Id,swiftfin_LoanProducts.Description as ProductName,
			  Case dbo.swiftfin_Journals.TransactionCode
						 WHEN 32 THEN 'Payout'
						 WHEN 268435456 THEN 'Check-Off'
						 WHEN 131072 THEN 'Back Office Cash Receipt'
						 WHEN 134217728 THEN 'Payroll Recoveries'
						 WHEN 8192 THEN 'Inter-Acccount Funds Transfer'
						 END As Transactioncode
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
WHERE        swiftfin_JournalEntries.ChartOfAccountId  in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts)  and  (dbo.swiftfin_Journals.TransactionCode IN (32, 268435456, 131072, 8192, 134217728)) 
and swiftfin_Journals.CreatedDate between @StartingDate and @EndingDate and dbo.swiftfin_Journals.TransactionCode =@TransactionCode

END    





GO
/****** Object:  StoredProcedure [dbo].[sp_RecoveriesSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_Branches
-- =============================================
-- Author:		<Author, Centrino>
-- Create date: <Create Date, 02/10/2015>
-- Description:	<Description,>
-- =============================================
--sp_RecoveriesSummary '2F015C30-7201-C686-7872-08D1AD41F57B','80899738-73B9-C628-8A3A-08D1CE089CFC','April'
CREATE PROCEDURE [dbo].[sp_RecoveriesSummary] 
	@PostingPeriod UniqueIdentifier,
	@BranchID UniqueIdentifier,
	@Month Varchar(20)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @Month=ltrim(rtrim(@Month));
    -- Insert statements for procedure here
	with SummaryCTE(AccountName,Amount)
	as
	(
   SELECT        
                         dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
	WHERE   swiftfin_JournalEntries.ChartOfAccountId  in (select ChartOfAccountId from swiftfin_LoanProducts) and     ( (dbo.swiftfin_Journals.TransactionCode in (32, 268435456, 131072, 8192, 134217728)) and PostingPeriodId=@PostingPeriod) 
	 and SecondaryDescription like '%'+@Month+'%'
union
   SELECT        
                         dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
	WHERE       swiftfin_JournalEntries.ChartOfAccountId  in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts) and   (dbo.swiftfin_Journals.TransactionCode in (32, 268435456, 131072, 8192, 134217728)) and PostingPeriodId=@PostingPeriod
	 and SecondaryDescription like '%'+@Month+'%'
	)
	select AccountName,sum(Amount) as Amount from SummaryCTE group by AccountName
END






GO
/****** Object:  StoredProcedure [dbo].[sp_RecoveriesSummaryxxx]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_Branches
-- =============================================
-- Author:		<Author, Centrino>
-- Create date: <Create Date, 02/10/2015>
-- Description:	<Description,>
-- =============================================
--select * from swiftfin_branches
--sp_RecoveriesSummaryxxx '09/01/2015','09/30/2015'
CREATE PROCEDURE [dbo].[sp_RecoveriesSummaryxxx] 
	@StartingDate DateTime,
	@EndingDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
    -- Insert statements for procedure here
	with SummaryCTE(PrimaryDescription,AccountName,ProductName,Amount)
	as
	(

	SELECT    dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_ChartOfAccounts.AccountName,  swiftfin_LoanProducts.Description as ProductName,dbo.swiftfin_JournalEntries.Amount   	  						 
    FROM      dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
              dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
	          dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
              dbo.swiftfin_Enumerations ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_Enumerations.Value
WHERE         swiftfin_JournalEntries.ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) 
             
UNION
SELECT        dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_ChartOfAccounts.AccountName,  swiftfin_LoanProducts.Description as ProductName,dbo.swiftfin_JournalEntries.Amount 
			 
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId INNER JOIN
              dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
	          dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
              dbo.swiftfin_Enumerations ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_Enumerations.Value
WHERE         swiftfin_JournalEntries.ChartOfAccountId  in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts) )
SELECT     AccountName, sum(Amount *-1) from SummaryCTE group by  AccountName
order by AccountName
 


END






GO
/****** Object:  StoredProcedure [dbo].[sp_Recoveriesxxx]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select * from swiftfin_loanproducts
--sp_Recoveriesxxx '09/01/2015','09/30/2015'

CREATE PROCEDURE [dbo].[sp_Recoveriesxxx] 
	@StartingDate DateTime,
	@EndingDate DateTime

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	--set @Month=ltrim(rtrim(@Month))
    -- Insert statements for procedure here

SELECT        dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.PostingPeriodId, dbo.swiftfin_Journals.BranchId, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
              dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount, LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_FirstName)) + ' ' + LTRIM(RTRIM(dbo.swiftfin_Customers.Individual_LastName)) AS FullName, 
              dbo.swiftfin_Customers.Individual_Salutation, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_Employers.Description AS Employer, 
              dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection,swiftfin_ChartOfAccounts.CostCenterId,swiftfin_LoanProducts.Id,swiftfin_LoanProducts.Description as ProductName,
			  dbo.swiftfin_Branches.id, swiftfin_Enumerations.Value,
			  Case dbo.swiftfin_Journals.TransactionCode
			  WHEN 32 THEN 'Payout'
			  WHEN 268435456 THEN 'Check-Off'
			  WHEN 131072 THEN 'Back Office Cash Receipt'
			  WHEN 134217728 THEN 'Payroll Recoveries'
			  WHEN 8192 THEN 'Inter-Acccount Funds Transfer'
			  WHEN 32768 THEN 'Scheduled Standing Order'
			  END As Transactioncode
						 
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId INNER JOIN
              dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
	          dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
              dbo.swiftfin_Enumerations ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_Enumerations.Value
WHERE         swiftfin_JournalEntries.ChartOfAccountId in (select ChartOfAccountId from swiftfin_LoanProducts) 
              and swiftfin_Journals.CreatedDate between @StartingDate and @EndingDate and (dbo.swiftfin_Journals.TransactionCode IN (32, 268435456, 131072, 8192, 134217728, 32768))  
UNION
SELECT        dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.PostingPeriodId, dbo.swiftfin_Journals.BranchId, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
              dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount, ltrim(rtrim(dbo.swiftfin_Customers.Individual_FirstName))+' '+ ltrim(rtrim(dbo.swiftfin_Customers.Individual_LastName)) as FullName, dbo.swiftfin_Customers.Individual_Salutation, 
              dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3,  dbo.swiftfin_Employers.Description as Employer, dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection, 
			  swiftfin_ChartOfAccounts.CostCenterId,swiftfin_LoanProducts.Id,swiftfin_LoanProducts.Description as ProductName, dbo.swiftfin_Branches.Id, swiftfin_Enumerations.Value,
			  Case dbo.swiftfin_Journals.TransactionCode
			  WHEN 32 THEN 'Payout'
			  WHEN 268435456 THEN 'Check-Off'
			  WHEN 131072 THEN 'Back Office Cash Receipt'
			  WHEN 134217728 THEN 'Payroll Recoveries'
			  WHEN 8192 THEN 'Inter-Acccount Funds Transfer'
			  WHEN 32768 THEN 'Scheduled Standing Order'
			  END As Transactioncode
FROM          dbo.swiftfin_Journals INNER JOIN
              dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
              dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
              dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
              dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
              dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
              dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
              dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
              dbo.swiftfin_LoanProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId INNER JOIN
              dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
	          dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
              dbo.swiftfin_Enumerations ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_Enumerations.Value
WHERE         swiftfin_JournalEntries.ChartOfAccountId  in (select InterestReceivableChartOfAccountId from swiftfin_LoanProducts) 
			  and swiftfin_Journals.CreatedDate between @StartingDate and @EndingDate and  (dbo.swiftfin_Journals.TransactionCode IN (32, 268435456, 131072, 8192, 134217728, 32768)) 


END    





GO
/****** Object:  StoredProcedure [dbo].[sp_RecoveryReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_RecoveryReport] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate DateTime

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	
	SELECT        dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName, 
	CASE 
	when dbo.swiftfin_StandingOrderHistories.[Trigger]=0 then 'Payout'
	when dbo.swiftfin_StandingOrderHistories.[Trigger]=1 then 'Checkoff'
	when dbo.swiftfin_StandingOrderHistories.[Trigger]=2 then 'Scheduled'
	end as [Trigger], 
							 dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal, dbo.swiftfin_StandingOrderHistories.ExpectedInterest, dbo.swiftfin_StandingOrderHistories.ActualPrincipal, dbo.swiftfin_StandingOrderHistories.ActualInterest, 
							 (dbo.swiftfin_StandingOrderHistories.ExpectedPrincipal+dbo.swiftfin_StandingOrderHistories.ExpectedInterest)-(dbo.swiftfin_StandingOrderHistories.ActualPrincipal+ dbo.swiftfin_StandingOrderHistories.ActualInterest) as Arrears,
							 Products_1.Description,dbo.swiftfin_StandingOrderHistories.CreatedDate
	FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id
	WHERE   (dbo.swiftfin_StandingOrderHistories.CreatedDate Between @StartDate and @EndDate and  dbo.swiftfin_StandingOrderHistories.Duration_EndDate>dbo.swiftfin_StandingOrderHistories.CreatedDate)
END






GO
/****** Object:  StoredProcedure [dbo].[sp_Refunds]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_Refunds '10/01/2018','10/30/2018'
CREATE PROC [dbo].[sp_Refunds]
@StartDate DateTime,
@EndDate DateTime

AS
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.AccountName, dbo.swiftfin_OverDeductionBatches.BatchNumber, 
                         dbo.swiftfin_OverDeductionBatches.CreatedBy, dbo.swiftfin_OverDeductionBatches.AuthorizedBy, dbo.swiftfin_OverDeductionBatchEntries.Principal, dbo.swiftfin_OverDeductionBatchEntries.Interest, 
                         case dbo.swiftfin_OverDeductionBatchEntries.Status when 1 then 'Pending' when 2 then 'Posted' when 8 then 'Verified' when 4 then 'Rejected' end as Status, dbo.swiftfin_OverDeductionBatches.CreatedDate
FROM            dbo.swiftfin_OverDeductionBatches INNER JOIN
                         dbo.swiftfin_OverDeductionBatchEntries ON dbo.swiftfin_OverDeductionBatches.Id = dbo.swiftfin_OverDeductionBatchEntries.OverDeductionBatchId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_OverDeductionBatchEntries.DebitCustomerAccountId = dbo.vw_CustomerAccounts.Id

						 where dbo.swiftfin_OverDeductionBatchEntries.CreatedDate BETWEEN @StartDate and @EndDate and dbo.swiftfin_OverDeductionBatches.AuthorizedDate is not null


						



GO
/****** Object:  StoredProcedure [dbo].[sp_Reindex]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create procedure [dbo].[sp_Reindex]
as
DECLARE @TableName varchar(255) 

DECLARE TableCursor CURSOR FOR 
SELECT table_name FROM information_schema.tables 
WHERE table_type = 'base table' 

OPEN TableCursor 

FETCH NEXT FROM TableCursor INTO @TableName 
WHILE @@FETCH_STATUS = 0 
BEGIN 
DBCC DBREINDEX(@TableName,' ',90) 
FETCH NEXT FROM TableCursor INTO @TableName 
END 

CLOSE TableCursor 

DEALLOCATE TableCursor





GO
/****** Object:  StoredProcedure [dbo].[Sp_Requisitions]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Gilbert
-- Create date: 18/06/2018
-- Description:	Requisition
-- =============================================
Create PROCEDURE [dbo].[Sp_Requisitions] 
	-- Add the parameters for the stored procedure here
@RequisitionId uniqueidentifier 
AS
BEGIN
--set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    SELECT        dbo.swiftfin_Requisitions.ReferenceNumber, dbo.swiftfin_Requisitions.ExpectedDate, dbo.swiftfin_RequisitionItems.Quantity,Case dbo.swiftfin_RequisitionItems.Status when 0 Then 'Pending' when 1 Then 'Active' when 2 then 'Closed' else '' end As Status, dbo.swiftfin_RequisitionItems.CreatedBy, 
                         dbo.swiftfin_RequisitionItems.CreatedDate, dbo.swiftfin_RequisitionItems.QuantityReceived, dbo.swiftfin_ItemRegister.Description as ItemName, dbo.swiftfin_Branches.Description AS Branch, dbo.swiftfin_Departments.Description AS Department, 
                         Case dbo.swiftfin_Requisitions.RecordStatus when 0 Then 'Pending' when 1 then 'Verified' when 2 then 'Posted' when 3 Then 'Rejected' Else '' end AS RecordStatus,dbo.swiftfin_Requisitions.Reason, dbo.swiftfin_ItemRegister.Code,
						 Case dbo.swiftfin_ItemRegister.ItemType when 1 Then 'Asset'when 2 Then 'Inventory' else '' end AS ItemType,dbo.swiftfin_ItemRegister.EstimatedUnitCost,dbo.swiftfin_RequisitionItems.RequisitionId
FROM            dbo.swiftfin_Requisitions INNER JOIN
                         dbo.swiftfin_RequisitionItems ON dbo.swiftfin_Requisitions.Id = dbo.swiftfin_RequisitionItems.RequisitionId INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Requisitions.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_Departments ON dbo.swiftfin_Requisitions.DepartmentId = dbo.swiftfin_Departments.Id INNER JOIN
                         dbo.swiftfin_ItemRegister ON dbo.swiftfin_RequisitionItems.ItemRegisterId = dbo.swiftfin_ItemRegister.Id
                      
                        
	where  swiftfin_RequisitionItems.RequisitionId=@RequisitionId
END
GO
/****** Object:  StoredProcedure [dbo].[sp_ReversedTransactionsByDate]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---sp_ReversedTransactionsByDate '01/01/2013','04/03/2014'
CREATE PROCEDURE [dbo].[sp_ReversedTransactionsByDate] 
	@StartDate as Datetime,
	@EndDate as Datetime

AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT        dbo.swiftfin_Branches.Description AS Branch, convert(Varchar(10),dbo.swiftfin_Journals.CreatedDate,103) as Date,dbo.swiftfin_PostingPeriods.Description AS PostingPeriod, swiftfin_ChartOfAccounts_1.AccountCode, 
                         swiftfin_ChartOfAccounts_1.AccountName, RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_Branches.Code)) AS VARCHAR(5)), 5) 
                         + '-' + RIGHT('00000' + CAST(LTRIM(RTRIM(dbo.swiftfin_Customers.SerialNumber)) AS VARCHAR(6)), 6) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode)) AS VARCHAR(5)), 5) 
                         + '-' + RIGHT('00' + CAST(LTRIM(RTRIM(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode)) AS VARCHAR(5)), 5) AS FullAccount, 
                         CASE Individual_Salutation WHEN '48814' THEN 'Mr' WHEN '48815' THEN 'Mrs' WHEN '48816' THEN 'Miss' WHEN '48817' THEN 'Dr' WHEN '48818' THEN 'Prof' WHEN '48819'
                          THEN 'Rev' WHEN '48820' THEN 'Eng' WHEN '48821' THEN 'Hon' WHEN '48822' THEN 'Cllr' WHEN '48823' THEN 'Sir' WHEN '48824' THEN 'Ms' ELSE 'UnKnown' END
                          + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, dbo.swiftfin_JournalEntries.CreatedDate, dbo.swiftfin_JournalEntries.Amount, 
                         dbo.swiftfin_ChartOfAccounts.AccountCode AS ContraAccountCode, dbo.swiftfin_ChartOfAccounts.AccountName AS ContraAccountName, 
                         dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ChartOfAccountId = swiftfin_ChartOfAccounts_1.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id ON 
                         dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ContraChartOfAccountId LEFT OUTER JOIN
                         dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId ON 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
WHERE        (dbo.swiftfin_Journals.ModuleNavigationItemCode = 64429) 
			AND (dbo.swiftfin_JournalEntries.Amount > 0) 
			AND dbo.swiftfin_JournalEntries.CreatedDate>=@StartDate 
			AND dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate
order by Branch,CreatedDate
END











GO
/****** Object:  StoredProcedure [dbo].[sp_RoleApplication]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 13.06.2014
-- Description:	RoleApplication
-- =============================================
CREATE PROCEDURE [dbo].[sp_RoleApplication] 
AS
BEGIN
	SET NOCOUNT ON;
	SELECT        dbo.aspnet_Roles.RoleName, dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, 
							 dbo.swiftfin_ModuleNavigationItems.ItemDescription
	FROM            dbo.aspnet_Roles INNER JOIN
							 dbo.swiftfin_ModuleNavigationItemsInRoles INNER JOIN
							 dbo.swiftfin_ModuleNavigationItems ON dbo.swiftfin_ModuleNavigationItemsInRoles.ModuleNavigationItemId = dbo.swiftfin_ModuleNavigationItems.Id ON 
							 dbo.aspnet_Roles.RoleName = dbo.swiftfin_ModuleNavigationItemsInRoles.RoleName
	ORDER BY dbo.aspnet_Roles.RoleName,dbo.swiftfin_ModuleNavigationItems.ModuleDescription,dbo.swiftfin_ModuleNavigationItems.ParentItemDescription,dbo.swiftfin_ModuleNavigationItems.ItemDescription
END







GO
/****** Object:  StoredProcedure [dbo].[sp_RuningFixedDeposits]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan>
-- Create date: <Create Date, 10/08/2015>
-- Description:	<Description, Unpaid fixed deposit test>
-- =============================================
--sp_RuningFixedDeposits '01/01/2015'
create PROCEDURE [dbo].[sp_RuningFixedDeposits]
	-- Add the parameters for the stored procedure here
	@MaturityDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        dbo.swiftfin_FixedDeposits.Value, dbo.swiftfin_FixedDeposits.Term, dbo.swiftfin_FixedDeposits.Rate, dbo.swiftfin_FixedDeposits.Status, dbo.swiftfin_FixedDeposits.MaturityDate, dbo.swiftfin_FixedDeposits.PaidDate, 
                         dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName as FullName, dbo.swiftfin_Customers.Individual_IdentityCardNumber, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference3, 
                         dbo.swiftfin_Customers.Reference2, dbo.swiftfin_FixedDeposits.CreatedDate, dbo.swiftfin_FixedDeposits.TotalExpected
	FROM            dbo.swiftfin_FixedDeposits INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_FixedDeposits.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id
	where MaturityDate >= @MaturityDate
	order by MaturityDate
END






GO
/****** Object:  StoredProcedure [dbo].[sp_SaccoLinkReports]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--sp_SaccoLinkReports '06/01/2014','06/30/2014'
CREATE PROCEDURE [dbo].[sp_SaccoLinkReports]
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate Datetime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
SELECT        dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_JournalEntries.Amount, convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,101) as TrxDate, 
                         dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.Character_Mask(dbo.swiftfin_AlternateChannels.CardNumber,6,'X') as CardNumber
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_AlternateChannels ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_AlternateChannels.CustomerAccountId
WHERE        (dbo.swiftfin_JournalEntries.ChartOfAccountId = '7F2F04D2-BDFC-C8BA-2130-08D10CAE7E33') and swiftfin_AlternateChannels.Type=1 and PrimaryDescription +SecondaryDescription not like '%Sacco link%' and  PrimaryDescription +SecondaryDescription not like '%charge%'
and  PrimaryDescription +SecondaryDescription not like '%Withdraw From Agent%' and swiftfin_JournalEntries.CreatedDate>=@StartDate and swiftfin_JournalEntries.CreatedDate<=@EndDate order by swiftfin_AlternateChannels.CardNumber 
END







GO
/****** Object:  StoredProcedure [dbo].[sp_SaccoStatisticalReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SaccoStatisticalReport]
	(
		@StartDate Datetime,
		@EndDate Datetime
	)
AS
BEGIN

SET NOCOUNT ON;

CREATE TABLE #Dashboard
(
[Description] VARCHAR(50),
Value	decimal(18,2)
)

/**SACCO Members*/
INSERT INTO #Dashboard
SELECT 'SACCO Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE CAST(CreatedDate as DATE) BETWEEN @StartDate and @EndDate

/**Closed Accounts*/
INSERT INTO #Dashboard
SELECT 'Closed Accounts', count(*) from swiftfin_CustomerAccountS where Status = 3 and CAST(CreatedDate as DATE) BETWEEN @StartDate and @EndDate

/**Active Male Members*/
INSERT INTO #Dashboard
SELECT 'Active Male Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE Individual_Gender = '57008' AND CAST(CreatedDate as DATE) BETWEEN @StartDate and @EndDate

/**Active Female Members*/
INSERT INTO #Dashboard
SELECT 'Active Female Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE Individual_Gender = '57009' And CAST(CreatedDate as DATE) BETWEEN @StartDate and @EndDate

/**Unclassified Members*/
INSERT INTO #Dashboard
SELECT 'Unclassified Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE Individual_Gender NOT IN ('57009', '57008') And CAST(CreatedDate as DATE) BETWEEN @StartDate and @EndDate

/**Active Members*/
INSERT INTO #Dashboard
SELECT 'Active Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE dbo.f_CustomerLastTransactionDate(id) >= DATEADD(MM,-3,GETDATE()) And CAST(CreatedDate as DATE) BETWEEN @StartDate and @EndDate

/**Dormant Members*/
INSERT INTO #Dashboard
SELECT 'Dormant Members',COUNT(*) FROM dbo.swiftfin_Customers WHERE dbo.f_CustomerLastTransactionDate(id) < DATEADD(MM,-3,GETDATE()) AND CAST(CreatedDate as DATE) BETWEEN @StartDate and @EndDate


/**Total Loan Balances*/
INSERT INTO #Dashboard
SELECT 'Total Loan Balances', SUM(ISNULL(dbo.swiftfin_JournalEntries.Amount, 0)) AS Balance 
FROM dbo.swiftfin_JournalEntries INNER JOIN
dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
inner join swiftfin_LoanProducts on swiftfin_LoanProducts.ChartOfAccountId = swiftfin_ChartOfAccounts.Id
WHERE CAST(dbo.swiftfin_JournalEntries.CreatedDate as DATE) BETWEEN @StartDate and @EndDate
--WHERE dbo.swiftfin_ChartOfAccounts.AccountCode like '10500%'


-- Blank line
--INSERT INTO #Dashboard
--Select '',''

/**All Investments*/
INSERT INTO #Dashboard
SELECT dbo.swiftfin_ChartOfAccounts.AccountName, SUM(ISNULL(dbo.swiftfin_JournalEntries.Amount, 0)) AS Balance 
FROM dbo.swiftfin_JournalEntries INNER JOIN
dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
inner join swiftfin_InvestmentProducts on swiftfin_InvestmentProducts.ChartOfAccountId = swiftfin_ChartOfAccounts.Id
--WHERE dbo.swiftfin_JournalEntries.ChartOfAccountId = '7BD83577-DB07-CAAD-50B7-08D10FCB3DEC' 
WHERE CAST(dbo.swiftfin_JournalEntries.CreatedDate as DATE) BETWEEN @StartDate and @EndDate                       
GROUP BY dbo.swiftfin_ChartOfAccounts.AccountName

-- Blank line
--INSERT INTO #Dashboard
--Select '',''

-- All Loan Products
INSERT INTO #Dashboard
SELECT dbo.swiftfin_ChartOfAccounts.AccountName, SUM(ISNULL(dbo.swiftfin_JournalEntries.Amount, 0)) AS Balance 
FROM dbo.swiftfin_JournalEntries INNER JOIN
dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
inner join swiftfin_LoanProducts on swiftfin_LoanProducts.ChartOfAccountId = swiftfin_ChartOfAccounts.Id
--WHERE dbo.swiftfin_JournalEntries.ChartOfAccountId = '7BD83577-DB07-CAAD-50B7-08D10FCB3DEC'   
WHERE CAST(dbo.swiftfin_JournalEntries.CreatedDate as DATE) BETWEEN @StartDate and @EndDate                     
GROUP BY dbo.swiftfin_ChartOfAccounts.AccountName

SELECT [Description], CASE WHEN [Value] < 0 THEN abs(Value)
ELSE VALUE END AS VALUE FROM #Dashboard

END








GO
/****** Object:  StoredProcedure [dbo].[sp_SalaryGroups]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_SalaryGroups] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT      dbo.swiftfin_SalaryGroups.Description, dbo.swiftfin_SalaryHeads.Description AS SalaryHead, 
				CASE 
				WHEN dbo.swiftfin_SalaryGroupEntries.Charge_FixedAmount>0 THEN 'Charge_FixedAmount'
				ELSE 'Charge_Percentage' END as Type,
				CASE 
				WHEN dbo.swiftfin_SalaryHeads.Category=1 THEN 'Earning'
				WHEN dbo.swiftfin_SalaryHeads.Category=2 THEN 'Deduction'
				END as CategoryDescription,dbo.swiftfin_SalaryHeads.Category
	FROM            dbo.swiftfin_SalaryGroupEntries INNER JOIN
							 dbo.swiftfin_SalaryGroups ON dbo.swiftfin_SalaryGroupEntries.SalaryGroupId = dbo.swiftfin_SalaryGroups.Id INNER JOIN
							 dbo.swiftfin_SalaryHeads ON dbo.swiftfin_SalaryGroupEntries.SalaryHeadId = dbo.swiftfin_SalaryHeads.Id 
	ORDER BY dbo.swiftfin_SalaryGroups.Description,dbo.swiftfin_SalaryHeads.Category
END







GO
/****** Object:  StoredProcedure [dbo].[sp_SalaryHeadsListing]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_SalaryHeadsListing] 

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT        dbo.swiftfin_SalaryHeads.Description, 
                         CASE type WHEN '61680' THEN 'Basic Pay Earning' WHEN '61681' THEN 'N.S.S.F Deduction' WHEN '61682' THEN 'N.H.I.F Deduction' WHEN '61683' THEN 'P.A.Y.E Deduction'
                          WHEN '61684' THEN 'Provident Fund Deduction' WHEN '61686' THEN 'Loan Deduction' WHEN '61687' THEN 'Investment Deduction' WHEN '61688' THEN 'Other Earning'
                          WHEN '61689' THEN 'Other Deduction' ELSE 'UnKnown' END AS SalaryHeadType, 
                         CASE [Category] WHEN 1 THEN 'Earning' WHEN 2 THEN 'Deduction' ELSE 'UnKnown' END AS Category, dbo.swiftfin_SalaryHeads.CreatedDate, 
                         dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName
FROM            dbo.swiftfin_SalaryHeads INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_SalaryHeads.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
order by type
	END











GO
/****** Object:  StoredProcedure [dbo].[sp_SavingsProductsBalances]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_SavingsProductsBalances]
	@ID varchar(MAX), 
	@Enddate Datetime,
	@Operator char(2),
	@OperatorValue float
AS
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	SET NOCOUNT ON;

;WITH JournalEntries (CustomerAccountID, Amount) AS
(
	SELECT CustomerAccountID, Amount
    FROM swiftfin_JournalEntries  where ChartOfAccountId IN (@ID) and CreatedDate<=@Enddate
),


CustomerAccounts (ID,FullAccount,FullName,Description) AS
(
	SELECT ID,FullAccount,FullName,Description
    FROM vw_CustomerAccounts h
),

Summary (FullName,FullAccount,Description,Balance) as
(
	SELECT  o.FullName,o.FullAccount,o.Description,sum(od.Amount) AS Balance
	FROM CustomerAccounts o
    INNER JOIN JournalEntries od ON o.id = od.CustomerAccountID
	GROUP BY o.FullAccount,o.FullName ,o.Description
)	

select FullAccount,FullName,Description, Balance From Summary

where	(
			(@Operator = '>' and Balance  > @OperatorValue)
			or (@Operator = '<' and Balance < @OperatorValue)
			or (@Operator = '<>' and Balance != @OperatorValue)
			or (@Operator = '>=' and Balance >= @OperatorValue)
			or (@Operator = '<=' and Balance <= @OperatorValue)
			or (@Operator = '=' and Balance = @OperatorValue)
		)

end










GO
/****** Object:  StoredProcedure [dbo].[sp_SharesBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan Centrino>
-- Create date: <Create Date, '15/06/2014>
-- Description:	<Description, Shares Balances As At: >
-- =============================================
--sp_SharesBalance 'a382db4c-b6cb-c765-70cc-08d20dabfb88', '05/30/2015'
CREATE PROCEDURE [dbo].[sp_SharesBalance]
	-- Add the parameters for the stored procedure here
	@Id varchar (50),
	@EndDate Date
	AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        SUM(dbo.swiftfin_Journals.TotalValue) AS Amount, dbo.swiftfin_Customers.Individual_FirstName + '' + dbo.swiftfin_Customers.Individual_LastName AS FullName, dbo.swiftfin_Customers.Individual_PayrollNumbers, 
                         dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_InvestmentProducts.Id
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
	WHERE  (dbo.swiftfin_InvestmentProducts.Id = @Id) and dbo.swiftfin_JournalEntries.CreatedDate<= @EndDate 
	GROUP BY dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Individual_PayrollNumbers, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, 
                         dbo.swiftfin_Customers.Reference3, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_InvestmentProducts.Id
	order by  dbo.swiftfin_Customers.Reference2 
END






GO
/****** Object:  StoredProcedure [dbo].[sp_SharesWithdrawalReport]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author, Joan >
-- Create date: <Create Date, 16/09/2015>
-- Description:	<Description, Shares Withdrawal>
-- =============================================
CREATE PROCEDURE [dbo].[sp_SharesWithdrawalReport]
	-- Add the parameters for the stored procedure here
	@pStartDate DateTime,
	@pEndDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @pEndDate=	(select DATEADD(day, DATEDIFF(day, 0, @pEndDate), '23:59:59'));
    -- Insert statements for procedure here
	SELECT    dbo.swiftfin_JournalEntries.CreatedDate, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, 
              dbo.swiftfin_InvestmentProducts.Description, dbo.swiftfin_InvestmentProducts.Id,
			  ISNULL(CASE WHEN dbo.swiftfin_JournalEntries.amount < 0 THEN dbo.swiftfin_JournalEntries.amount * - 1 END, 0) AS Debit, 
			  ISNULL(CASE WHEN dbo.swiftfin_JournalEntries.amount > 0 THEN dbo.swiftfin_JournalEntries.amount END, 0) AS Credit
	FROM      dbo.swiftfin_JournalEntries INNER JOIN
              dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
              dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
	WHERE   ISNULL(CASE WHEN dbo.swiftfin_JournalEntries.amount < 0 THEN dbo.swiftfin_JournalEntries.amount * - 1 END, 0) <>0 and dbo.swiftfin_JournalEntries.CreatedDate between @pStartDate and @pEndDate
	GROUP BY dbo.swiftfin_InvestmentProducts.Id, dbo.swiftfin_JournalEntries.CreatedDate, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, 
             dbo.swiftfin_InvestmentProducts.Description, dbo.swiftfin_JournalEntries.amount

END






GO
/****** Object:  StoredProcedure [dbo].[sp_SingleGlTransactions_DateRange]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE  PROCEDURE [dbo].[sp_SingleGlTransactions_DateRange]
	-- Add the parameters for the stored procedure here
	@ChartOfAccountID as Varchar(100),
	@StartDate as Datetime,
	@EndDate as Datetime

AS
	Declare 
	@OpeningBalance Numeric (18,2)
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

SELECT  (
		SELECT
			(
			SELECT 
			  [Description]
			FROM [dbo].[swiftfin_Branches] 
			WHERE Id=[dbo].[swiftfin_Journals].BranchId
			)
		FROM [dbo].[swiftfin_Journals] 
		WHERE Id =  [dbo].[swiftfin_JournalEntries].JournalId
		) AS Branch
		,
		(
			SELECT 
			  [AccountCode]
			FROM [dbo].[swiftfin_ChartOfAccounts] 
			WHERE Id = [dbo].[swiftfin_JournalEntries].ChartOfAccountId
		) AS ChartOfAccount
		,
		(
			SELECT 
			  [AccountName]
			FROM [dbo].[swiftfin_ChartOfAccounts] 
			WHERE Id = [dbo].[swiftfin_JournalEntries].ChartOfAccountId
		) AS [AccountName]

		,
		(
			SELECT 
			  [AccountCode]
			FROM [dbo].[swiftfin_ChartOfAccounts] 
			WHERE Id = [dbo].[swiftfin_JournalEntries].[ContraChartOfAccountId]
		) AS ContraChartOfAccountCode
		,
		(
			SELECT 
			  [AccountName]
			FROM [dbo].[swiftfin_ChartOfAccounts] 
			WHERE Id = [dbo].[swiftfin_JournalEntries].[ContraChartOfAccountId]
		) AS [ContraAccountName]

      ,
	  (
		SELECT (
					SELECT
						[Individual_FirstName]+' '+
						[Individual_LastName]
					FROM [dbo].[swiftfin_Customers] 
					where Id=[dbo].[swiftfin_CustomerAccounts].CustomerId
				) 
		FROM [dbo].[swiftfin_CustomerAccounts] 
		WHERE Id=[dbo].[swiftfin_JournalEntries].CustomerAccountId
	  ) as CustomerAccountName
	  ,
		(
		  SELECT [PrimaryDescription]
		  FROM [dbo].[swiftfin_Journals]
		  WHERE Id=[dbo].[swiftfin_JournalEntries].JournalId
		) AS [PrimaryDescription]
	  ,
		(
		  SELECT [SecondaryDescription]
		  FROM [dbo].[swiftfin_Journals]
		  WHERE Id=[dbo].[swiftfin_JournalEntries].JournalId
		) AS [SecondaryDescription]
	  ,
		(
		  SELECT [Reference]
		  FROM [dbo].[swiftfin_Journals]
		  WHERE Id=[dbo].[swiftfin_JournalEntries].JournalId
		) AS [Reference]

	  ,[Amount]
	  ,[CreatedDate]
	  INTO #Temp 
	  FROM [dbo].[swiftfin_JournalEntries] 
	  where ChartOfAccountId=@ChartOfAccountId and CreatedDate>=@StartDate and CreatedDate<=@Enddate

	  set @OpeningBalance=
	  (
		SELECT sum(amount) 
		FROM [dbo].[swiftfin_JournalEntries] 
		WHERE ChartOfAccountId=@ChartOfAccountId and CreatedDate<@StartDate
	  )
	  set @OpeningBalance=isnull(@OpeningBalance,0)
	  insert into #temp (CreatedDate,SecondaryDescription,Reference,Amount) 
	  values(@StartDate,'Balance B/F', 'B/B', @OpeningBalance)
	  select *,case when [Amount]>0 then Amount else 0 end as Credit,case when [Amount]<0 then Amount*-1 else 0 end as Debit, 
	SUM(amount) OVER(ORDER BY CreatedDate 
     ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) 
          AS RunningTotal
		  ,convert(varchar(10),CreatedDate,103) as date	  
	  from #Temp order by CreatedDate

	  

END








GO
/****** Object:  StoredProcedure [dbo].[sp_SpotCashAirtimeCommissions]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_JournalEntries
---select * from swiftfin_PostingPeriods
--sp_GlAccountStatement 'FE1B832E-3BFB-C150-B32D-08D1AD4E836D','12/01/2014','12/28/2014','2F015C30-7201-C686-7872-08D1AD41F57B'

---select * from swiftfin_ChartOfAccounts where AccountName like '%cheq%'

-- sp_SpotCashAirtimeCommissions'01/1/2017','01/18/2017'
CREATE PROCEDURE [dbo].[sp_SpotCashAirtimeCommissions] 
 -- Add the parameters for the stored procedure here
 
 @StartDate Datetime,
 @EndDate Datetime
AS
DECLARE
 @OpeningBalance Numeric (18,2)
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

    -- Insert statements for procedure here

WITH CTE AS
(
SELECT (select AccountCode from swiftfin_ChartOfAccounts where id='217DD325-F915-CA40-2202-08D41DBAE1B6') as AccountCode,
(select AccountName from swiftfin_ChartOfAccounts where id='217DD325-F915-CA40-2202-08D41DBAE1B6') as AccountName,'Balance B/F at ' +convert(varchar(10),@startdate,103) as PrimaryDescription,'<Opening Balance>' as SecondaryDescription,'<Opening Balance>' as Reference,
(select Balance from f_GLAccountBalance('217DD325-F915-CA40-2202-08D41DBAE1B6',@StartDate)) as Amount,@StartDate as ValueDate,'' as FullAccountNumber,'' as Reference1,'' as Reference3,'' as FullName,'' as ContrAccountCode,'' as ContraAccountName,'' as PhoneNo
    UNION ALL
SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.swiftfin_JournalEntries.Amount, dbo.swiftfin_Journals.CreatedDate, 
                         REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccountNumber,
        dbo.swiftfin_Customers.Reference1,dbo.swiftfin_Customers.Reference3,
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         swiftfin_ChartOfAccounts_1.AccountCode AS ContraAccountCode, swiftfin_ChartOfAccounts_1.AccountName AS ContraAccountName,dbo.swiftfin_Customers.Address_MobileLine
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId ON 
                         dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = swiftfin_ChartOfAccounts_1.Id LEFT OUTER JOIN
                         dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Branches.Id = dbo.swiftfin_CustomerAccounts.BranchId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id ON 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
WHERE                (dbo.swiftfin_JournalEntries.ContraChartOfAccountId ='217DD325-F915-CA40-2202-08D41DBAE1B6'
                             ))
       SELECT AccountCode,AccountName,PrimaryDescription,SecondaryDescription,Reference,ValueDate,FullAccountNumber,FullName,reference1,Reference3,ContrAccountCode,ContraAccountName,PhoneNo,
ISNULL(CASE WHEN AMOUNT<0 THEN AMOUNT*-1 END,0) AS DEBIT,
ISNULL(CASE WHEN AMOUNT>0 THEN AMOUNT END,0) AS CREDIT into #temp1 FROM CTE ORDER BY valuedate

 select *,ValueDate as CreatedDate,SUM(credit-debit) OVER(ORDER BY ValueDate 
      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal
 from #temp1 where Valuedate BETWEEN @StartDate AND @EndDate
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SpotCashDeposits]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- sp_SpotCashDeposits'01/1/2018','05/24/2018'
CREATE PROCEDURE [dbo].[sp_SpotCashDeposits] 
 -- Add the parameters for the stored procedure here
 @StartDate datetime , 
 @EndDate datetime
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
 SELECT        dbo.swiftfin_Journals.CreatedDate,dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
                         dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference3, dbo.swiftfin_Branches.Description AS Branch, 
                         dbo.swiftfin_Journals.TotalValue,CASE WHEN dbo.swiftfin_JournalEntries.Amount<0 THEN dbo.swiftfin_JournalEntries.Amount *-1 ELSE 0 END AS DEBIT,
       CASE WHEN dbo.swiftfin_JournalEntries.Amount>0 THEN dbo.swiftfin_JournalEntries.Amount  ELSE 0 END AS CREDIT
 FROM            dbo.swiftfin_JournalEntries INNER JOIN
        dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
        dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
        dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
 WHERE   dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate AND dbo.swiftfin_JournalEntries.ChartOfAccountId ='48ECF699-EE4D-E811-80D1-F40343552CF9' 
AND PrimaryDescription LIKE '%Deposit%' -- OR PrimaryDescription='Spot Cash Withdrawal Charge~Withdrawal Fee'  OR SecondaryDescription='Cash Withdrawal Spotcash')
                             
 
 
          
END


--select * from swiftfin_ChartOfAccounts where AccountName like '%spot%'
GO
/****** Object:  StoredProcedure [dbo].[sp_SpotcashRegisteredMembers]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select address_mobileline from swiftfin_Customers
--select * from swiftfin_AlternateChannels where type=8
--exec sp_SpotcashRegisteredMembers '06/01/2018', '08/03/2018'

CREATE PROC [dbo].[sp_SpotcashRegisteredMembers]
@StartDate Datetime,
@EndDate Datetime

AS
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

 SELECT        dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullNames,  dbo.swiftfin_AlternateChannels.CardNumber,dbo.swiftfin_AlternateChannels.CardNumber as Address_MobileLine, dbo.swiftfin_Customers.Individual_IdentityCardNumber,dbo.swiftfin_Customers.Reference1 AS AccountNumber,
                         dbo.swiftfin_AlternateChannels.CreatedDate
FROM            dbo.swiftfin_AlternateChannels INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_AlternateChannels.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id

						where dbo.swiftfin_AlternateChannels.Type=8 and dbo.swiftfin_AlternateChannels.CreatedDate Between @StartDate and @EndDate

						order by  dbo.swiftfin_AlternateChannels.CreatedDate
						--select * from swiftfin_AlternateChannels where [Type]=8
						--select * from swiftfin_Enumerations where [key] like '%alternate%'
GO
/****** Object:  StoredProcedure [dbo].[sp_spotcashsummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


---sp_spotcashsummary '02/23/2017','02/24/2017'
create PROCEDURE [dbo].[sp_spotcashsummary]
 -- Add the parameters for the stored procedure here
 ( --@TellerCode varchar(50),
      @StartDate datetime,
  @EndDate Datetime
 )
AS
 --Declare @Date Varchar(10)
 --Set @Date=convert(varchar(10),@TrxDate,103)
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
 
    -- Insert statements for procedure here

SELECT       dbo.swiftfin_Journals.PrimaryDescription, 
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,dbo.swiftfin_ChartOfAccounts.AccountName,
       case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,50 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=25 and dbo.swiftfin_JournalEntries.CreatedDate between @StartDate and @EndDate and swiftfin_ChartOfAccounts.AccountCode=1021019
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_ChartOfAccounts.AccountName

end
GO
/****** Object:  StoredProcedure [dbo].[sp_SpotCashTransactions]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_JournalEntries
---select * from swiftfin_PostingPeriods
--sp_GlAccountStatement 'FE1B832E-3BFB-C150-B32D-08D1AD4E836D','12/01/2014','12/28/2014','2F015C30-7201-C686-7872-08D1AD41F57B'

---select * from swiftfin_ChartOfAccounts where AccountName like '%cheq%'

-- sp_SpotCashTransactions 'E41F121D-7E20-C4DB-97EA-08D41DBABD06','01/27/2017','01/30/2017'
CREATE PROCEDURE [dbo].[sp_SpotCashTransactions] 
 -- Add the parameters for the stored procedure here
 
 @StartDate Datetime,
 @EndDate Datetime
AS
DECLARE
 @OpeningBalance Numeric (18,2)
set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;

    -- Insert statements for procedure here

WITH CTE AS
(
SELECT (select AccountCode from swiftfin_ChartOfAccounts where id='48ECF699-EE4D-E811-80D1-F40343552CF9') as AccountCode,
(select AccountName from swiftfin_ChartOfAccounts where id='48ECF699-EE4D-E811-80D1-F40343552CF9') as AccountName,'Balance B/F at ' +convert(varchar(10),@startdate,103) as PrimaryDescription,'<Opening Balance>' as SecondaryDescription,'<Opening Balance>' as Reference,
(select Balance from f_GLAccountBalance('48ECF699-EE4D-E811-80D1-F40343552CF9',@StartDate)) as Amount,@StartDate as ValueDate,'' as FullAccountNumber,'' as Reference1,'' as Reference3,'' as FullName,'' as ContrAccountCode,'' as ContraAccountName,'' as PhoneNo
    UNION ALL
SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.swiftfin_JournalEntries.Amount, dbo.swiftfin_Journals.CreatedDate, 
                         REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccountNumber,
        dbo.swiftfin_Customers.Reference1,dbo.swiftfin_Customers.Reference3,
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         swiftfin_ChartOfAccounts_1.AccountCode AS ContraAccountCode, swiftfin_ChartOfAccounts_1.AccountName AS ContraAccountName,dbo.swiftfin_Customers.Address_MobileLine
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId ON 
                         dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = swiftfin_ChartOfAccounts_1.Id LEFT OUTER JOIN
                         dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Branches.Id = dbo.swiftfin_CustomerAccounts.BranchId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id ON 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
WHERE         (dbo.swiftfin_ChartOfAccounts.Id = '48ECF699-EE4D-E811-80D1-F40343552CF9') 
       ) 
       SELECT AccountCode,AccountName,PrimaryDescription,SecondaryDescription,Reference,ValueDate,FullAccountNumber,FullName,reference1,Reference3,ContrAccountCode,ContraAccountName,PhoneNo,
ISNULL(CASE WHEN AMOUNT<0 THEN AMOUNT*-1 END,0) AS DEBIT,
ISNULL(CASE WHEN AMOUNT>0 THEN AMOUNT END,0) AS CREDIT into #temp1 FROM CTE ORDER BY valuedate

 select *,ValueDate as CreatedDate,SUM(credit-debit) OVER(ORDER BY ValueDate 
      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal
 from #temp1 where Valuedate BETWEEN @StartDate AND @EndDate
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SpotCashWithdrawal]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- sp_SpotCashWithdrawal'01/1/2018','05/24/2018'
CREATE PROCEDURE [dbo].[sp_SpotCashWithdrawal] 
 -- Add the parameters for the stored procedure here
 @StartDate datetime , 
 @EndDate datetime
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
 SELECT        dbo.swiftfin_Journals.CreatedDate,dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, 
                         dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference3, dbo.swiftfin_Branches.Description AS Branch, 
                         dbo.swiftfin_Journals.TotalValue,CASE WHEN dbo.swiftfin_JournalEntries.Amount<0 THEN dbo.swiftfin_JournalEntries.Amount *-1 ELSE 0 END AS DEBIT,
       CASE WHEN dbo.swiftfin_JournalEntries.Amount>0 THEN dbo.swiftfin_JournalEntries.Amount  ELSE 0 END AS CREDIT
 FROM            dbo.swiftfin_JournalEntries INNER JOIN
        dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
        dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
        dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
 WHERE   dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate AND dbo.swiftfin_JournalEntries.ChartOfAccountId ='48ECF699-EE4D-E811-80D1-F40343552CF9' 
AND PrimaryDescription LIKE '%Withdrawal%' -- OR PrimaryDescription='Spot Cash Withdrawal Charge~Withdrawal Fee'  OR SecondaryDescription='Cash Withdrawal Spotcash')
                             
 
 
          
END


--select * from swiftfin_ChartOfAccounts where AccountName like '%spot%'
GO
/****** Object:  StoredProcedure [dbo].[sp_StandingOrders]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 01.06.2014
-- Description:	Standing Orders Listing
-- =============================================
-- sp_StandingOrders 0,0
CREATE PROCEDURE [dbo].[sp_StandingOrders] 
	-- Add the parameters for the stored procedure here
	@pStaus int = 0, 
	@pType int = 0
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	SELECT					CASE dbo.swiftfin_StandingOrders.[Trigger]
							 WHEN 0 THEN 'Payout'
							 WHEN 1 THEN 'Check-Off'
							 WHEN 2 THEN 'Other'
							 END AS StandingOrderTrigger,dbo.swiftfin_StandingOrders.[Trigger],
							 dbo.vw_CustomerAccounts.FullAccount, ltrim(rtrim(dbo.vw_CustomerAccounts.FullName)) as FullName, ltrim(rtrim(Products_1.Description)) AS SourceProduct, 
							  dbo.swiftfin_StandingOrders.Principal, dbo.swiftfin_StandingOrders.Interest, 
							 CASE dbo.swiftfin_StandingOrders.IsLocked
							 WHEN 0 THEN 'Running'
							 WHEN 1 THEN 'Stopped'
							 END Status, dbo.swiftfin_StandingOrders.IsLocked,
							 dbo.swiftfin_StandingOrders.CreatedDate, dbo.swiftfin_StandingOrders.CreatedBy, 
							  ltrim(rtrim(Products_2.Description)) AS BeneficiaryProduct, 
							 vw_CustomerAccounts_1.FullAccount AS BeneficiaryAccountNumber, ltrim(rtrim(vw_CustomerAccounts_1.FullName)) AS BeneficiaryFullName
	FROM            dbo.swiftfin_StandingOrders INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.Products(0) AS Products_1 ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = Products_1.id INNER JOIN
							 dbo.vw_CustomerAccounts AS vw_CustomerAccounts_1 ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = vw_CustomerAccounts_1.Id INNER JOIN
							 dbo.Products(0) AS Products_2 ON vw_CustomerAccounts_1.CustomerAccountType_TargetProductId = Products_2.id
	WHERE			dbo.swiftfin_StandingOrders.IsLocked=@pStaus 
					AND dbo.swiftfin_StandingOrders.[Trigger]=@pType
	ORDER BY		dbo.vw_CustomerAccounts.FullAccount, vw_CustomerAccounts_1.FullAccount
	
END







GO
/****** Object:  StoredProcedure [dbo].[sp_StandingOrdersByEmployer]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 23.10.2014
-- Description:	Standing Orders Listing By Employer
-- =============================================
---sp_StandingOrdersByEmployer 'D6E0B99B-690C-C23D-51BA-08D1BC0ACBF6'
Create PROCEDURE [dbo].[sp_StandingOrdersByEmployer] 
	-- Add the parameters for the stored procedure here
	@EmployerID varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        dbo.vw_CustomerAccounts.Reference1 AS BenefactorAccount, dbo.vw_CustomerAccounts.FullName AS BenefactorName, 
                         vw_CustomerAccounts_1.Reference1 AS BeneficiaryAccount, vw_CustomerAccounts_1.FullAccount AS BeneficiaryName, 
                         dbo.swiftfin_StandingOrders.Duration_StartDate, dbo.swiftfin_StandingOrders.Duration_EndDate, dbo.swiftfin_StandingOrders.Schedule_Frequency, 
                         dbo.swiftfin_StandingOrders.Schedule_ExpectedRunDate, dbo.swiftfin_StandingOrders.Schedule_ActualRunDate, dbo.swiftfin_StandingOrders.Schedule_ExecuteAttemptCount, 
          
						 CASE dbo.swiftfin_StandingOrders.[Trigger]
						 WHEN 0 THEN 'Payout'
						 WHEN 1 THEN 'Check-Off'
						 WHEN 2 THEN 'Other'
						 END AS [Trigger] , ISNULL(dbo.swiftfin_StandingOrders.Principal,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_FixedAmount,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_Percentage,0) AS Principal , dbo.swiftfin_StandingOrders.Interest, 
                         dbo.swiftfin_StandingOrders.Remarks, dbo.swiftfin_StandingOrders.IsLocked, dbo.swiftfin_StandingOrders.CreatedBy, dbo.swiftfin_StandingOrders.CreatedDate, 
                         CASE dbo.swiftfin_StandingOrders.Charge_Type WHEN 1 THEN 'Percentage' WHEN 2 THEN 'Fixed Amount' END AS ChargeType
                         
	FROM            dbo.swiftfin_Customers INNER JOIN
							 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
							 dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
							 dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
							 dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
							 dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
							 dbo.swiftfin_StandingOrders ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.vw_CustomerAccounts AS vw_CustomerAccounts_1 ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = vw_CustomerAccounts_1.Id
	WHERE   ISNULL(dbo.swiftfin_StandingOrders.Principal,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_FixedAmount,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_Percentage,0)>0 AND     (dbo.swiftfin_Divisions.EmployerId =@EmployerID)
END






GO
/****** Object:  StoredProcedure [dbo].[sp_StandingOrdersByEmployerandProduct]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		Centrino
-- Create date: 23.10.2014
-- Description:	Standing Orders Listing By Employer
-- =============================================

--sp_StandingOrdersByEmployerandProduct '74BA72A9-41C6-E811-8357-08D40C76F50B',17
--select id, description from swiftfin_employers
CREATE PROCEDURE [dbo].[sp_StandingOrdersByEmployerandProduct] 
	-- Add the parameters for the stored procedure here
	@EmployerID uniqueidentifier,
	@TargetProductId int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        dbo.vw_CustomerAccounts.Reference1 AS BenefactorAccount, dbo.vw_CustomerAccounts.FullName AS BenefactorName, 
                         vw_CustomerAccounts_1.Reference1 AS BeneficiaryAccount, vw_CustomerAccounts_1.FullAccount AS BeneficiaryName, 
                         dbo.swiftfin_StandingOrders.Duration_StartDate, dbo.swiftfin_StandingOrders.Duration_EndDate, dbo.swiftfin_StandingOrders.Schedule_Frequency, 
                         dbo.swiftfin_StandingOrders.Schedule_ExpectedRunDate, dbo.swiftfin_StandingOrders.Schedule_ActualRunDate, dbo.swiftfin_StandingOrders.Schedule_ExecuteAttemptCount, 
          
						 CASE dbo.swiftfin_StandingOrders.[Trigger]
						 WHEN 0 THEN 'Payout'
						 WHEN 1 THEN 'Check-Off'
						 WHEN 2 THEN 'Other'
						 END AS [Trigger] , ISNULL(dbo.swiftfin_StandingOrders.Principal,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_FixedAmount,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_Percentage,0) AS Principal , dbo.swiftfin_StandingOrders.Interest, 
                         dbo.swiftfin_StandingOrders.Remarks, dbo.swiftfin_StandingOrders.IsLocked, dbo.swiftfin_StandingOrders.CreatedBy, dbo.swiftfin_StandingOrders.CreatedDate, 
                         CASE dbo.swiftfin_StandingOrders.Charge_Type WHEN 1 THEN 'Percentage' WHEN 2 THEN 'Fixed Amount' END AS ChargeType,  dbo.swiftfin_Employers.Id as EmployerId,
						  dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId
                         
	FROM            dbo.swiftfin_Customers INNER JOIN
							 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
							 dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
							 dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
							 dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
							 dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
							 dbo.swiftfin_StandingOrders ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.vw_CustomerAccounts AS vw_CustomerAccounts_1 ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = vw_CustomerAccounts_1.Id
	WHERE   ISNULL(dbo.swiftfin_StandingOrders.Principal,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_FixedAmount,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_Percentage,0)>0 AND (dbo.swiftfin_Divisions.EmployerId =@EmployerID) and 
	(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode = @TargetProductId)
END

--select id, description from swiftfin_employers
-- select * from swiftfin_loanproducts where id = '4623CC2E-E0BB-E811-A815-000C29142092'

--select id,code, description from swiftfin_LoanProducts



GO
/****** Object:  StoredProcedure [dbo].[sp_StandingOrdersByEmployerProduct]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 23.10.2014
-- Description:	Standing Orders Listing By Employer
-- =============================================
---sp_StandingOrdersByEmployerProduct '74BA72A9-41C6-E811-8357-08D40C76F50B', '41A31650-E9BB-E811-A815-000C29142092'
--select * from swiftfin_employers
CREATE PROCEDURE [dbo].[sp_StandingOrdersByEmployerProduct] 
	-- Add the parameters for the stored procedure here
	@EmployerID varchar(50),
	@ProductID uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	SELECT        dbo.vw_CustomerAccounts.Reference1 AS BenefactorAccount, dbo.vw_CustomerAccounts.FullName AS BenefactorName, 
                         vw_CustomerAccounts_1.Reference1 AS BeneficiaryAccount, vw_CustomerAccounts_1.FullAccount AS BeneficiaryName, 
                         dbo.swiftfin_StandingOrders.Duration_StartDate, dbo.swiftfin_StandingOrders.Duration_EndDate, dbo.swiftfin_StandingOrders.Schedule_Frequency, 
                         dbo.swiftfin_StandingOrders.Schedule_ExpectedRunDate, dbo.swiftfin_StandingOrders.Schedule_ActualRunDate, dbo.swiftfin_StandingOrders.Schedule_ExecuteAttemptCount, 
          
						 CASE dbo.swiftfin_StandingOrders.[Trigger]
						 WHEN 0 THEN 'Payout'
						 WHEN 1 THEN 'Check-Off'
						 WHEN 2 THEN 'Other'
						 END AS [Trigger] , ISNULL(dbo.swiftfin_StandingOrders.Principal,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_FixedAmount,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_Percentage,0) AS Principal , dbo.swiftfin_StandingOrders.Interest, 
                         dbo.swiftfin_StandingOrders.Remarks, dbo.swiftfin_StandingOrders.IsLocked, dbo.swiftfin_StandingOrders.CreatedBy, dbo.swiftfin_StandingOrders.CreatedDate, 
                         CASE dbo.swiftfin_StandingOrders.Charge_Type WHEN 1 THEN 'Percentage' WHEN 2 THEN 'Fixed Amount' END AS ChargeType, swiftfin_LoanProducts.Id as LoanProductID
                         
	FROM            dbo.swiftfin_Customers INNER JOIN
							 dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
							 dbo.swiftfin_Stations ON dbo.swiftfin_Customers.StationId = dbo.swiftfin_Stations.Id INNER JOIN
							 dbo.swiftfin_Zones ON dbo.swiftfin_Stations.ZoneId = dbo.swiftfin_Zones.Id INNER JOIN
							 dbo.swiftfin_Divisions ON dbo.swiftfin_Zones.DivisionId = dbo.swiftfin_Divisions.Id INNER JOIN
							 dbo.swiftfin_Employers ON dbo.swiftfin_Divisions.EmployerId = dbo.swiftfin_Employers.Id INNER JOIN
							 dbo.swiftfin_StandingOrders ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId INNER JOIN
							 dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrders.BenefactorCustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
							 dbo.vw_CustomerAccounts AS vw_CustomerAccounts_1 ON dbo.swiftfin_StandingOrders.BeneficiaryCustomerAccountId = vw_CustomerAccounts_1.Id
							  INNER JOIN swiftfin_LoanProducts ON swiftfin_StandingOrders.Remarks = swiftfin_LoanProducts.Description
	WHERE   ISNULL(dbo.swiftfin_StandingOrders.Principal,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_FixedAmount,0)+ISNULL(dbo.swiftfin_StandingOrders.Charge_Percentage,0)>0 AND (dbo.swiftfin_Divisions.EmployerId =@EmployerID)
	and  (dbo.swiftfin_LoanProducts.Id = @ProductID)

END







GO
/****** Object:  StoredProcedure [dbo].[sp_StatementOfDepositReturn]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---[sp_StatementOfDepositReturn]'11/14/2018'

CREATE  Procedure [dbo].[sp_StatementOfDepositReturn]
(
@enddate as Datetime
)
as
 set nocount on
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));


Create Table #response(Code char(3),Description varchar(50),Range1 numeric(14,2),Range2 numeric(14,2),
Balance numeric(14,2),countx numeric(14),OrderCode char(2),OrderName Char(50))




select Id as CustomerAccountId,FullAccount,10000000000.00-10000000000.00 as Balance,
(select ChartOfAccountId from swiftfin_InvestmentProducts where id= vw_CustomerAccounts.CustomerAccountType_TargetProductId) as ChartOfAccountId
into #Sacco_DepositsAccounts
 from vw_CustomerAccounts where CustomerAccountType_ProductCode  = 3 -- Investments
and CustomerAccountType_TargetProductId in(SELECT id FROM swiftfin_InvestmentProducts WHERE Code=1 -- Deposits
)
--select * from swiftfin_InvestmentProducts
select Id as CustomerAccountId,FullAccount,10000000000.00-10000000000.00 as Balance,
(select ChartOfAccountId from swiftfin_SavingsProducts where id= vw_CustomerAccounts.CustomerAccountType_TargetProductId) as ChartOfAccountId
into #Sacco_SavingsAccounts
 from vw_CustomerAccounts where CustomerAccountType_ProductCode = 1 -- Savings
and CustomerAccountType_TargetProductId in(SELECT id FROM swiftfin_SavingsProducts --WHERE Code not in(8) --  Fixed Deposits
)

select Id as CustomerAccountId,FullAccount,10000000000.00-10000000000.00 as Balance,
(select ChartOfAccountId from swiftfin_InvestmentProducts where id= vw_CustomerAccounts.CustomerAccountType_TargetProductId) as ChartOfAccountId
into #Sacco_TermDeposits
 from vw_CustomerAccounts where CustomerAccountType_ProductCode  = 3 -- Investments
and CustomerAccountType_TargetProductId in(SELECT id FROM swiftfin_InvestmentProducts WHERE Code in(3,5)) -- TermDeposits

--select  CustomerAccountId,id,(select FullAccount from vw_CustomerAccounts where id=#temp1.CustomerAccountId) as FullAccount,10000000000.00-10000000000.00 as Balance,
--(SELECT 
--      [ChartOfAccountId]
--  FROM [dbo].[swiftfin_SystemGeneralLedgerAccountMappings] where  SystemGeneralLedgerAccountCode='48832'
--) as ChartOfAccountId
--into #Sacco_TermDeposits2
-- from #temp1 ---where PaidDate is null
 --select * from   drop table #Sacco_TermDeposits
 --select * from swiftfin_Enumerations where [key] like '%SystemGeneralLedgerAccountCode%'

create table #temp(ChartOfAccountID UniqueIdentifier)

insert into #temp(ChartOfAccountID)
select ChartOfAccountId from #Sacco_TermDeposits group by ChartOfAccountId

insert into #temp(ChartOfAccountID)
select ChartOfAccountId from #Sacco_SavingsAccounts group by ChartOfAccountId

insert into #temp(ChartOfAccountID)
select ChartOfAccountId from #Sacco_DepositsAccounts group by ChartOfAccountId

SELECT swiftfin_JournalEntries.CustomerAccountId,SUM(coalesce(swiftfin_JournalEntries.amount,0)) as Balance
into #tempBalances
FROM swiftfin_JournalEntries inner join
swiftfin_journals on swiftfin_JournalEntries.JournalId=swiftfin_journals.id
where ChartOfAccountId in(select ChartOfAccountId from #temp)
and  swiftfin_journals.ValueDate <=@enddate
group by swiftfin_JournalEntries.CustomerAccountId

update #Sacco_TermDeposits set Balance =isnull((select Balance from #tempBalances where CustomerAccountId=
#Sacco_TermDeposits.CustomerAccountId),0)

update #Sacco_SavingsAccounts set Balance =isnull((select Balance from #tempBalances where CustomerAccountId=
#Sacco_SavingsAccounts.CustomerAccountId),0)

update #Sacco_DepositsAccounts set Balance =isnull((select Balance from #tempBalances where CustomerAccountId=
#Sacco_DepositsAccounts.CustomerAccountId),0)

insert into #response(Code ,Description ,Range1,Range2,Balance,Countx,OrderCode,OrderName)
select '02','Savings',Ranges.range1,Ranges.Range2,sum(coalesce(#Sacco_SavingsAccounts.balance,0)) as Balance,
count(#Sacco_SavingsAccounts.FullAccount) as Countx,Ranges.Code ,Ranges.OrderName
from swiftfin_Depositsranges Ranges
left outer join #Sacco_SavingsAccounts on #Sacco_SavingsAccounts.balance >=Ranges.Range1 and  #Sacco_SavingsAccounts.balance <=Ranges.Range2
group by  Ranges.range1,Ranges.Range2,Ranges.Code,Ranges.OrderName


insert into #response(Code ,Description ,Range1,Range2,Balance,Countx,OrderCode,OrderName)
select '03','Term Deposits',Ranges.range1,Ranges.Range2,sum(coalesce(#Sacco_TermDeposits.balance,0)) as Balance,
count(#Sacco_TermDeposits.FullAccount) as Countx,Ranges.Code ,Ranges.OrderName
from swiftfin_Depositsranges Ranges
left outer join #Sacco_TermDeposits on #Sacco_TermDeposits.balance >=Ranges.Range1 and  #Sacco_TermDeposits.balance <=Ranges.Range2
group by  Ranges.range1,Ranges.Range2,Ranges.Code,Ranges.OrderName

insert into #response(Code ,Description ,Range1,Range2,Balance,Countx,OrderCode,OrderName)
select '01','Non Withdraw-able',Ranges.range1,Ranges.Range2,sum(coalesce(#Sacco_DepositsAccounts.balance,0)) as Balance,
count(#Sacco_DepositsAccounts.FullAccount) as Countx,Ranges.Code,Ranges.OrderName 
from swiftfin_Depositsranges Ranges
left outer  join #Sacco_DepositsAccounts on #Sacco_DepositsAccounts.balance >=Ranges.Range1 and  #Sacco_DepositsAccounts.balance <=Ranges.Range2
group by  Ranges.range1,Ranges.Range2,Ranges.Code,Ranges.OrderName

--select * from #Sacco_TermDeposits
select * from #response order by OrderCode,code


--select * from #temp1







GO
/****** Object:  StoredProcedure [dbo].[sp_StatutoryDeductions]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Tobbit
-- Create date: 12/10/2015
-- Description:	Statutory Deductions
-- =============================================

--sp_StatutoryDeductions '1C63BEDC-5BDE-C393-60CB-08D3E2D33976',10
--select * from swiftfin_PostingPeriods
CREATE PROCEDURE [dbo].[sp_StatutoryDeductions] 
	-- Add the parameters for the stored procedure here
	@PostingPeriodId uniqueidentifier, 
	@SalaryMonth int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here
	

SELECT        dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_Employees.NationalSocialSecurityFundNumber,dbo.swiftfin_JournalEntries.Amount AS EmployeeContribution,dbo.swiftfin_JournalEntries.Amount AS EmployerContribution,dbo.swiftfin_JournalEntries.Amount*2 AS TotalContribution
FROM                dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Employees ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_Employees.CustomerId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_SalaryHeads.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PostingPeriods.Id = dbo.swiftfin_SalaryPeriods.PostingPeriodId
						 where dbo.swiftfin_SalaryHeads.Type='61681' and dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth
						
						group by dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_Employees.NationalSocialSecurityFundNumber,dbo.swiftfin_ChartOfAccounts.Id,dbo.swiftfin_JournalEntries.Amount
END
--select * from swiftfin_SalaryHeads


GO
/****** Object:  StoredProcedure [dbo].[sp_StatutoryDeductionsNHIF]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Tobbit
-- Create date: 12/10/2015
-- Description:	Statutory Deductions
-- =============================================

--sp_StatutoryDeductionsNHIF '4CAF2D78-1DCE-CE0A-CC51-08D431798ECE',2
--select * from swiftfin_PostingPeriods
CREATE PROCEDURE [dbo].[sp_StatutoryDeductionsNHIF] 
	-- Add the parameters for the stored procedure here
	@PostingPeriodId uniqueidentifier, 
	@SalaryMonth int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here
	

SELECT        dbo.swiftfin_Customers.Individual_FirstName +' '+ swiftfin_Customers.Individual_LastName as FullName, dbo.swiftfin_Employees.NationalHospitalInsuranceFundNumber,dbo.swiftfin_PaySlipEntries.Principal AS Contribution
FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_SalaryCards ON dbo.swiftfin_Employees.Id = dbo.swiftfin_SalaryCards.EmployeeId INNER JOIN
                         dbo.swiftfin_PaySlips ON dbo.swiftfin_SalaryCards.Id = dbo.swiftfin_PaySlips.SalaryCardId INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
                         dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_PaySlips.Id = dbo.swiftfin_PaySlipEntries.PaySlipId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_PaySlipEntries.SalaryHeadType = dbo.swiftfin_SalaryHeads.Type INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id
						 where dbo.swiftfin_SalaryHeads.Type='61682' and dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth 
						
						--group by dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_Employees.NationalHospitalInsuranceFundNumber,dbo.swiftfin_ChartOfAccounts.Id,dbo.swiftfin_JournalEntries.Amount
END
--select * from swiftfin_SalaryHeads
--SELECT *from swiftfin_employees


GO
/****** Object:  StoredProcedure [dbo].[sp_StatutoryDeductionsNSSF]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Tobbit
-- Create date: 12/10/2015
-- Description:	Statutory Deductions
-- =============================================

--sp_StatutoryDeductionsNSSF '4CAF2D78-1DCE-CE0A-CC51-08D431798ECE',1
--select * from swiftfin_PostingPeriods
CREATE PROCEDURE [dbo].[sp_StatutoryDeductionsNSSF] 
	-- Add the parameters for the stored procedure here
	@PostingPeriodId uniqueidentifier, 
	@SalaryMonth int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here
	

SELECT        dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_Employees.NationalSocialSecurityFundNumber,dbo.swiftfin_JournalEntries.Amount AS EmployeeContribution,dbo.swiftfin_JournalEntries.Amount AS EmployerContribution,dbo.swiftfin_JournalEntries.Amount*2 AS TotalContribution
FROM                dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Employees ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_Employees.CustomerId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_SalaryHeads.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PostingPeriods.Id = dbo.swiftfin_SalaryPeriods.PostingPeriodId
						 where dbo.swiftfin_SalaryHeads.Type='61681' and dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.swiftfin_JournalEntries.Amount>0
						
						group by dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_Employees.NationalSocialSecurityFundNumber,dbo.swiftfin_ChartOfAccounts.Id,dbo.swiftfin_JournalEntries.Amount
END
--select * from swiftfin_SalaryHeads


GO
/****** Object:  StoredProcedure [dbo].[sp_StatutoryDeductionsPAYE]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Tobbit
-- Create date: 12/10/2015
-- Description:	Statutory Deductions
-- =============================================

--sp_StatutoryDeductionsPAYE '4CAF2D78-1DCE-CE0A-CC51-08D431798ECE',2
--select * from swiftfin_PostingPeriods
CREATE PROCEDURE [dbo].[sp_StatutoryDeductionsPAYE] 
	-- Add the parameters for the stored procedure here
	@PostingPeriodId uniqueidentifier, 
	@SalaryMonth int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here
	

SELECT       dbo.swiftfin_Customers.Individual_FirstName + ' '+ dbo.swiftfin_Customers.Individual_LastName AS FullName, dbo.swiftfin_Customers.PersonalIdentificationNumber  , dbo.swiftfin_PaySlipEntries.Principal AS Contribution
FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_SalaryCards ON dbo.swiftfin_Employees.Id = dbo.swiftfin_SalaryCards.EmployeeId INNER JOIN
                         dbo.swiftfin_PaySlips ON dbo.swiftfin_SalaryCards.Id = dbo.swiftfin_PaySlips.SalaryCardId INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
                         dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_PaySlips.Id = dbo.swiftfin_PaySlipEntries.PaySlipId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_PaySlipEntries.SalaryHeadType = dbo.swiftfin_SalaryHeads.Type INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id
						 where dbo.swiftfin_SalaryHeads.Type='61683' and dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth 
						 
					
						--group by dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.PersonalIdentificationNumber,dbo.swiftfin_ChartOfAccounts.Id,dbo.swiftfin_JournalEntries.Amount
END
--select * from swiftfin_SalaryHeads
--SELECT *from swiftfin_employees
--select * from vw_CustomerAccounts


GO
/****** Object:  StoredProcedure [dbo].[sp_StatutoryDeductionsProvident]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Tobbit
-- Create date: 12/10/2015
-- Description:	Statutory Deductions
-- =============================================

--sp_StatutoryDeductionsProvident '943CA8F5-48BB-E811-A814-000C29142092',12
--select id,description from swiftfin_PostingPeriods
CREATE PROCEDURE [dbo].[sp_StatutoryDeductionsProvident] 
	-- Add the parameters for the stored procedure here
	@PostingPeriodId uniqueidentifier, 
	@SalaryMonth int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here
	

SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Individual_IdentityCardNumber,dbo.swiftfin_JournalEntries.Amount AS EmployeeContribution,dbo.swiftfin_JournalEntries.Amount*2 AS EmployerContribution,dbo.swiftfin_JournalEntries.Amount*2 + dbo.swiftfin_JournalEntries.Amount AS TotalContribution
FROM                dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Employees ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_Employees.CustomerId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_SalaryHeads.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PostingPeriods.Id = dbo.swiftfin_SalaryPeriods.PostingPeriodId
						 where dbo.swiftfin_SalaryHeads.Type='61684' and dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.swiftfin_JournalEntries.Amount>0
						
						group by dbo.vw_CustomerAccounts.FullName,dbo.vw_CustomerAccounts.Individual_IdentityCardNumber,dbo.swiftfin_ChartOfAccounts.Id,dbo.swiftfin_JournalEntries.Amount
END
--select * from swiftfin_SalaryHeads
--select * from vw_CustomerAccounts



GO
/****** Object:  StoredProcedure [dbo].[sp_StatutoryDeductionsProvidentFund]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Tobbit
-- Create date: 12/10/2015
-- Description:	Statutory Deductions
-- =============================================

-- [sp_StatutoryDeductionsProvidentFund] '52BB648B-900D-E911-A880-000C2914209C', 1
--select * from swiftfin_PostingPeriods
create PROCEDURE [dbo].[sp_StatutoryDeductionsProvidentFund] 
	-- Add the parameters for the stored procedure here
	@PostingPeriodId uniqueidentifier, 
	@SalaryMonth int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here
	

SELECT        dbo.swiftfin_Customers.Individual_FirstName +' '+ swiftfin_Customers.Individual_LastName as FullName,dbo.swiftfin_Customers.Individual_IdentityCardNumber,
              dbo.swiftfin_PaySlipEntries.Principal AS EmployeeContribution,dbo.swiftfin_PaySlipEntries.Principal*2 as EmployerContribution,
			  dbo.swiftfin_PaySlipEntries.Principal*2 + dbo.swiftfin_PaySlipEntries.Principal  AS TotalContribution 
FROM            dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_SalaryCards ON dbo.swiftfin_Employees.Id = dbo.swiftfin_SalaryCards.EmployeeId INNER JOIN
                         dbo.swiftfin_PaySlips ON dbo.swiftfin_SalaryCards.Id = dbo.swiftfin_PaySlips.SalaryCardId INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PaySlips.SalaryPeriodId = dbo.swiftfin_SalaryPeriods.Id INNER JOIN
                         dbo.swiftfin_PaySlipEntries ON dbo.swiftfin_PaySlips.Id = dbo.swiftfin_PaySlipEntries.PaySlipId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_PaySlipEntries.SalaryHeadType = dbo.swiftfin_SalaryHeads.Type INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_Employees.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_SalaryPeriods.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id
						 where dbo.swiftfin_SalaryHeads.Type='61684' and dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth 
						
						--group by dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_Employees.NationalHospitalInsuranceFundNumber,dbo.swiftfin_ChartOfAccounts.Id,dbo.swiftfin_JournalEntries.Amount
END
--select * from swiftfin_SalaryHeads
--SELECT *from swiftfin_employees



GO
/****** Object:  StoredProcedure [dbo].[sp_StatutoryDeductionsSTAFFPREMIUMS]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Tobbit
-- Create date: 12/10/2015
-- Description:	Statutory Deductions
-- =============================================

--sp_StatutoryDeductionsSTAFFPREMIUMS '1C63BEDC-5BDE-C393-60CB-08D3E2D33976',10
--select * from swiftfin_PostingPeriods
CREATE PROCEDURE [dbo].[sp_StatutoryDeductionsSTAFFPREMIUMS] 
	-- Add the parameters for the stored procedure here
	@PostingPeriodId uniqueidentifier, 
	@SalaryMonth int
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here
	

SELECT        dbo.vw_CustomerAccounts.FullName,dbo.swiftfin_JournalEntries.Amount AS EmployeeContribution
FROM                dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Employees ON dbo.vw_CustomerAccounts.CustomerId = dbo.swiftfin_Employees.CustomerId INNER JOIN
                         dbo.swiftfin_SalaryHeads ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_SalaryHeads.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id INNER JOIN
                         dbo.swiftfin_SalaryPeriods ON dbo.swiftfin_PostingPeriods.Id = dbo.swiftfin_SalaryPeriods.PostingPeriodId
						 where dbo.swiftfin_SalaryHeads.Id='029F9AE4-ABE8-C290-4410-08D40178AB32' and dbo.swiftfin_PostingPeriods.Id=@PostingPeriodID and dbo.swiftfin_SalaryPeriods.Month=@SalaryMonth and dbo.swiftfin_JournalEntries.Amount<>2500 and dbo.swiftfin_JournalEntries.Amount>0
						
						group by dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_Employees.NationalSocialSecurityFundNumber,dbo.swiftfin_ChartOfAccounts.Id,dbo.swiftfin_JournalEntries.Amount
END
--select * from swiftfin_SalaryHeads
--SELECT * from swiftfin_Enumerations where [key] like '%salary%'


GO
/****** Object:  StoredProcedure [dbo].[sp_SumCreditBatchEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 03.06.2014
-- Description:	SumCreditBatchEntries
-- =============================================
--select top 1 * from swiftfin_Customers
---[sp_SumCreditBatchEntries] 'D9907B05-7C5B-C5BA-EE8D-08D13F32F7F4'
CREATE PROCEDURE [dbo].[sp_SumCreditBatchEntries] 
	-- Add the parameters for the stored procedure here
	@Creditbatchid varchar(100) 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	select isnull(sum(isnull(Interest,0)+isnull(principal,0)),0) as Amount 
	from swiftfin_CreditBatchEntries  
	where creditbatchid=@Creditbatchid
END







GO
/****** Object:  StoredProcedure [dbo].[sp_SumWireTransferBatchEntries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:  Centrino
-- Create date: 03.06.2014
-- Description: SumWireTransferBatchEntries
-- =============================================
--select top 1 * from swiftfin_Customers
---[sp_SumWireTransferBatchEntries] 'D9907B05-7C5B-C5BA-EE8D-08D13F32F7F4'
create PROCEDURE [dbo].[sp_SumWireTransferBatchEntries] 
 -- Add the parameters for the stored procedure here
 @WireTransferBatchid uniqueidentifier 
AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 select isnull(sum(isnull(Amount,0)),0) as Amount 
 from swiftfin_WireTransferBatchEntries  
 where WireTransferBatchid=@WireTransferBatchid
END
GO
/****** Object:  StoredProcedure [dbo].[sp_SuspenceAccountSummaries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---[sp_SuspenceAccountSummaries] '08/16/2016','08/17/2016','2292972A-8E1C-C44C-4E8A-08D339648AD2'
CREATE PROCEDURE [dbo].[sp_SuspenceAccountSummaries] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate DateTime,
	@ChartofAccountID uniqueidentifier
AS
BEGIN
	SET NOCOUNT ON;
	Declare @OpeningBalance Numeric(18,2)

	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	set @OpeningBalance =(select sum(dbo.swiftfin_JournalEntries.amount) from dbo.swiftfin_Journals INNER JOIN
							 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId where ChartOfAccountId=@ChartofAccountID and dbo.swiftfin_Journals.ValueDate< @StartDate);
	With CTESuspense (Row,PrimaryDescription,SecondaryDescription,ContraAccountName,ValueDate,Debit,Credit,CreateDate)
	as
	(
		Select 2,'Balance B/F','Previous Balance','ContraAccountName',@StartDate as ValueDate,Case When @OpeningBalance<0 then @OpeningBalance *-1 else 0 end as debit,Case When @OpeningBalance>=0 then @OpeningBalance  else 0 end as Credit,@EndDate As CreatedDate
		union
		SELECT     1,   dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, swiftfin_ChartOfAccounts_1.AccountName AS ContraAccountName,dbo.swiftfin_Journals.ValueDate, case when SUM(dbo.swiftfin_JournalEntries.Amount) <0 then SUM(dbo.swiftfin_JournalEntries.Amount)*-1 else 0 end as Debit,
		case when SUM(dbo.swiftfin_JournalEntries.Amount) >0 then SUM(dbo.swiftfin_JournalEntries.Amount) else 0 end as Credit,dbo.swiftfin_JournalEntries.CreatedDate
		FROM            dbo.swiftfin_Journals INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
								  dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
								 dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = swiftfin_ChartOfAccounts_1.Id
		WHERE        dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate AND (dbo.swiftfin_JournalEntries.ChartOfAccountId = @ChartofAccountID)
		GROUP BY dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription,swiftfin_ChartOfAccounts_1.AccountName,dbo.swiftfin_Journals.ValueDate,dbo.swiftfin_JournalEntries.CreatedDate
	)
	Select ROW_NUMBER() OVER(ORDER BY row DESC) AS Row1, * into #tempCTSuspense from CTESuspense

	select *,SUM(credit-Debit) OVER(ORDER BY Row1
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal from #tempCTSuspense
END
---select * from swiftfin_CreditTypes


GO
/****** Object:  StoredProcedure [dbo].[sp_SystemTransactionByType]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 11-23-2016
-- Description:	Systemtransactions By Type
-- =============================================
--sp_SystemTransactionByType '01/01/2017','01/31/2017',1
CREATE PROCEDURE [dbo].[sp_SystemTransactionByType] 
 -- Add the parameters for the stored procedure here
 @StartDate DateTime=0 , 
 @EndDate DateTime=0 ,
 @TransactionCode int = 0
 

AS
BEGIN
 -- SET NOCOUNT ON added to prevent extra result sets from
 -- interfering with SELECT statements.
 SET NOCOUNT ON;
 set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
  SELECT        dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Description, 
     CASE WHEN dbo.swiftfin_JournalEntries.Amount<0 THEN dbo.swiftfin_JournalEntries.Amount * -1 ELSE 0 END AS Debit,
     CASE WHEN dbo.swiftfin_JournalEntries.Amount>0 THEN dbo.swiftfin_JournalEntries.Amount ELSE 0 END AS Credit, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.CreatedDate,dbo.swiftfin_Journals.BranchId
         FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_SavingsProducts ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_SavingsProducts.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_SavingsProducts.Id = dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId AND dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id

       where dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate  and dbo.swiftfin_Journals.TransactionCode=@TransactionCode and dbo.swiftfin_Journals.TransactionCode in(1,2,3,17,18,19,20)
	    and dbo.swiftfin_Journals.ParentId is null

END

--select  * from swiftfin_journals where TransactionCode=2
--select * from swiftfin_Enumerations where [key] like '%SystemTransactionCode%' order by value


GO
/****** Object:  StoredProcedure [dbo].[sp_SystemTransactionSummaryByBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 21.10.2014
-- Description:	System Transaction Summary by Module
-- =============================================
--- sp_SystemTransactionSummary '10/21/2014','10/21/2014'
CREATE PROCEDURE [dbo].[sp_SystemTransactionSummaryByBranch] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime  , 
	@EndDate Datetime ,
	@BranchID uniqueidentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	SELECT        dbo.swiftfin_ModuleNavigationItems.ItemDescription,dbo.swiftfin_ModuleNavigationItems.id as ModuleNavigationItemID ,dbo.swiftfin_ModuleNavigationItems.ItemCode,dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, 
							CASE 
							WHEN SUM(dbo.swiftfin_JournalEntries.Amount)<0 THEN  SUM(dbo.swiftfin_JournalEntries.Amount)*-1 
							ELSE 0 END AS DEBIT,CASE 
							WHEN SUM(dbo.swiftfin_JournalEntries.Amount)>0 THEN  SUM(dbo.swiftfin_JournalEntries.Amount) 
							ELSE 0 END AS CREDIT, dbo.swiftfin_ChartOfAccounts.Id as ChartOfAccountID,dbo.swiftfin_ChartOfAccounts.AccountName,dbo.swiftfin_ChartOfAccounts.AccountCode
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
							 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
							 dbo.swiftfin_ModuleNavigationItems ON dbo.swiftfin_Journals.ModuleNavigationItemCode = dbo.swiftfin_ModuleNavigationItems.ItemCode
	WHERE  dbo.swiftfin_Journals.BranchId=@BranchID and swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate
/*
	AND swiftfin_JournalEntries.ChartOfAccountId not in
	(SELECT        ChartOfAccountId
	FROM            dbo.swiftfin_SystemGeneralLedgerAccountMappings INNER JOIN
							 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_SystemGeneralLedgerAccountMappings.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
	WHERE        (dbo.swiftfin_SystemGeneralLedgerAccountMappings.SystemGeneralLedgerAccountCode  IN ('48826')))
	*/
	GROUP BY dbo.swiftfin_ModuleNavigationItems.ItemDescription, dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, 
							 dbo.swiftfin_ChartOfAccounts.AccountName,dbo.swiftfin_ChartOfAccounts.Id,dbo.swiftfin_ModuleNavigationItems.id,dbo.swiftfin_ModuleNavigationItems.ItemCode,dbo.swiftfin_ChartOfAccounts.AccountCode having SUM(dbo.swiftfin_JournalEntries.Amount)!=0
	ORDER BY ParentItemDescription,ModuleDescription,ItemDescription

END






GO
/****** Object:  StoredProcedure [dbo].[sp_SystemTransactionSummaryByBranchDetailed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

---sp_SystemTransactionSummaryByBranchDetailed '01/31/2015','01/31/2015','8B8B1B74-141C-CF68-05C2-08D19D7D7330'
CREATE PROCEDURE [dbo].[sp_SystemTransactionSummaryByBranchDetailed] 
	-- Add the parameters for the stored procedure here
	@StartDate Datetime  , 
	@EndDate Datetime ,
	@BranchID uniqueidentifier,
	@ChartOfAccountID varchar(50),
	@ModuleNavigationItemsID Varchar(50)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	SELECT        TOP (100) PERCENT dbo.swiftfin_ModuleNavigationItems.ItemDescription, dbo.swiftfin_ModuleNavigationItems.ItemCode, 
                         dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END AS DEBIT, CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END AS CREDIT, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ChartOfAccounts.AccountCode, 
                         dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.vw_CustomerAccounts.FullName, 
                         dbo.vw_CustomerAccounts.Reference1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_ModuleNavigationItems ON dbo.swiftfin_Journals.ModuleNavigationItemCode = dbo.swiftfin_ModuleNavigationItems.ItemCode LEFT OUTER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id
WHERE        (dbo.swiftfin_Journals.BranchId = @BranchID and dbo.swiftfin_ModuleNavigationItems.id=@ModuleNavigationItemsID and dbo.swiftfin_ChartOfAccounts.ID=@ChartOfAccountID ) AND (dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate)
GROUP BY dbo.swiftfin_ModuleNavigationItems.ItemDescription, dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, 
                         dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ModuleNavigationItems.ItemCode, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Reference1
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
ORDER BY dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ItemDescription
END






GO
/****** Object:  StoredProcedure [dbo].[sp_SystemTransactionSummaryByGledger]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		Centrino
-- Create date: 21.10.2014
-- Description:	System Transaction Summary by Module
-- =============================================


--- sp_SystemTransactionSummaryByGledger 'B8BAD591-07B8-C04C-C925-08D1AC51F90D','10/21/2014','10/21/2014'
CREATE PROCEDURE [dbo].[sp_SystemTransactionSummaryByGledger] 
	-- Add the parameters for the stored procedure here
	@ChartOfAccountID varchar(50),
	@StartDate Datetime , 
	@EndDate Datetime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
		 Declare @OpenningBalance Numeric(18,2)

    -- Insert statements for procedure here
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
	 set @OpenningBalance=isnull((select sum(amount) from swiftfin_JournalEntries 
					where ChartOfAccountId =@ChartOfAccountID 
					and CreatedDate<@StartDate),0);
	With GLTransactionSummaries_CTE (Serial,ItemDescription,ItemCode,ModuleDescription,ParentItemDescription,Debit,Credit,Amount,AccountName,AccountCode)
	as
	(
	SELECT      ROW_NUMBER() OVER(ORDER BY ItemDescription),  dbo.swiftfin_ModuleNavigationItems.ItemDescription,dbo.swiftfin_ModuleNavigationItems.ItemCode, dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, 
							CASE 
							WHEN SUM(dbo.swiftfin_JournalEntries.Amount)<0 THEN  SUM(dbo.swiftfin_JournalEntries.Amount)*-1 
							ELSE 0 END AS DEBIT,CASE 
							WHEN SUM(dbo.swiftfin_JournalEntries.Amount)>0 THEN  SUM(dbo.swiftfin_JournalEntries.Amount) 
							ELSE 0 END AS CREDIT,SUM(dbo.swiftfin_JournalEntries.Amount), dbo.swiftfin_ChartOfAccounts.AccountName,dbo.swiftfin_ChartOfAccounts.AccountCode
	FROM            dbo.swiftfin_JournalEntries INNER JOIN
							 dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
							 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
							 dbo.swiftfin_ModuleNavigationItems ON dbo.swiftfin_Journals.ModuleNavigationItemCode = dbo.swiftfin_ModuleNavigationItems.ItemCode
	WHERE dbo.swiftfin_JournalEntries.ChartOfAccountId=@ChartOfAccountID and swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate AND @EndDate 
/*
	AND swiftfin_JournalEntries.ChartOfAccountId not in
	(SELECT        ChartOfAccountId
	FROM            dbo.swiftfin_SystemGeneralLedgerAccountMappings INNER JOIN
							 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_SystemGeneralLedgerAccountMappings.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
	WHERE        (dbo.swiftfin_SystemGeneralLedgerAccountMappings.SystemGeneralLedgerAccountCode  IN ('48826')))
	*/
	GROUP BY dbo.swiftfin_ModuleNavigationItems.ItemDescription, dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, 
							 dbo.swiftfin_ChartOfAccounts.AccountName,dbo.swiftfin_ModuleNavigationItems.ItemCode,dbo.swiftfin_ChartOfAccounts.AccountCode having SUM(dbo.swiftfin_JournalEntries.Amount)!=0

	)
		---SELECT Serial,AccountCode, AccountName, Debit,Credit,Amount,CreatedDate,PrimaryDescription,ContrAccountCode,ContraAccountName INTO #TempGLTrans FROM GLTransactionSummaries_CTE

	select * into #TempGLTrans from GLTransactionSummaries_CTE 	ORDER BY ParentItemDescription,ModuleDescription,ItemDescription
	insert into #TempGLTrans(Serial,ItemDescription,ItemCode,ModuleDescription,ParentItemDescription,Debit,Credit,Amount,AccountName,AccountCode)
	select 0,'', 0, '','',0,0,@OpenningBalance,'Balance B/F',0  from #TempGLTrans where Serial=1

	select Serial,ItemDescription,ItemCode,ModuleDescription,ParentItemDescription,Debit,Credit,SUM(Amount) OVER(ORDER BY Serial 
							ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal,AccountName,AccountCode from #TempGLTrans

END







GO
/****** Object:  StoredProcedure [dbo].[sp_TellerAverageCollection]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_Tellers
---sp_TellerAverageCollection 'F4789D98-143E-C6B5-1D36-08D3FF6BAACC','02/01/2017','02/28/2017'
CREATE PROCEDURE [dbo].[sp_TellerAverageCollection] 
	-- Add the parameters for the stored procedure here
	(
		@TellerCode varchar(50),
		@StartDate Datetime,
		@EndDate DateTime
	)
AS
 
 set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
  
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here

WITH TellerAverageCollectionCTE(PrimaryDescription,Credit,Debit,Code)

AS
(
SELECT         dbo.swiftfin_Journals.PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end ,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end ,2 
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=2 and swiftfin_Tellers.id=@TellerCode and  dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription


UNION 

SELECT         'Cash Receipt(Sundry)' , 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end ,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end ,5 
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id

Where dbo.swiftfin_Journals.TransactionCode=18 and swiftfin_Tellers.id=@TellerCode and  dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate


UNION 

SELECT         'Cheque Receipt(Sundry)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end ,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,7 
FROM           dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=19 and swiftfin_Tellers.id=@TellerCode and  dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT        'Cash Receipt(Customer)', 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end , 8 
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=17 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

)

select *,sum(Debit) as TotalCollection,sum(debit)/DATEDIFF(DAY, @StartDate, @EndDate+1) as AverageCollection
 from TellerAverageCollectionCTE  WHERE Debit>0
 group by PrimaryDescription,Credit,Debit,Code

order by code




END











GO
/****** Object:  StoredProcedure [dbo].[sp_TellerDailyTransactions]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---select * from swiftfin_JournalEntries where ChartOfAccountId='F538AB2E-99EE-CF93-1E7A-08D10CAD12D7'
--select top 1000 * from swiftfin_JournalEntries where JournalId='743622FB-B23C-C87C-3FFD-08D13FC11C40' order by CreatedDate desc
--select * from swiftfin_Tellers
---sp_TellerDailyTransactions '05/20/2014', '313E32FF-19F0-C20F-215B-08D14000BA48'
CREATE PROCEDURE [dbo].[sp_TellerDailyTransactions] 
	-- Add the parameters for the stored procedure here
	@TrxDate DateTime,
	@TellerCode varchar(100)

AS
Declare 
@OpenningBalance Numeric(18,2)

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
  set @OpenningBalance=isnull((select sum(amount) from swiftfin_JournalEntries 
					where ChartOfAccountId in
					(select ChartOfAccountId from swiftfin_Tellers where ID= @TellerCode) 
					and CreatedDate<@TrxDate),0)
					
    -- Insert statements for procedure here

SELECT        REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccountNumber, 
                         ltrim(rtrim( isnull(dbo.swiftfin_Customers.Individual_FirstName,'') + ' ' + isnull(dbo.swiftfin_Customers.Individual_LastName,'')))+''+
						  isnull(dbo.swiftfin_Customers.NonIndividual_Description,'') AS FullName, 
                         dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.swiftfin_JournalEntries.Amount, 
                        swiftfin_Customers_1.Individual_FirstName + ' ' + swiftfin_Customers_1.Individual_LastName AS TellerFullName, 
                         dbo.swiftfin_Tellers.Description AS TellerCode,(select AccountName from swiftfin_ChartOfAccounts where id = dbo.swiftfin_JournalEntries.ContraChartOfAccountId) as ContraName, 
						 (select AccountCode from swiftfin_ChartOfAccounts where id = dbo.swiftfin_JournalEntries.ContraChartOfAccountId) as ContraGL,dbo.swiftfin_JournalEntries.CreatedDate,dbo.swiftfin_Customers.Individual_IdentityCardNumber
into #temp  FROM            dbo.swiftfin_Customers RIGHT OUTER JOIN
                         dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId LEFT OUTER JOIN
                         dbo.swiftfin_Employees INNER JOIN
                         dbo.swiftfin_Customers AS swiftfin_Customers_1 ON dbo.swiftfin_Employees.CustomerId = swiftfin_Customers_1.Id ON 
                         dbo.swiftfin_Tellers.EmployeeId = dbo.swiftfin_Employees.Id LEFT OUTER JOIN
                         dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Branches.Id = dbo.swiftfin_CustomerAccounts.BranchId ON 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId
						 
WHERE   dbo.swiftfin_Tellers.Id=@TellerCode and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103) =convert(varchar(10),@TrxDate,103)
insert into #temp(PrimaryDescription,SecondaryDescription,Reference,Amount,CreatedDate) 
select 'Balance B/F','','B-B/F',@OpenningBalance,DATEADD(d,-1,@TrxDate)


SELECT CASE 
WHEN isnull(FullAccountNumber,'')='' THEN LTRIM(RTRIM(STR(ContraGL)))
ELSE FullAccountNumber
END AS FullAccountNumber,
CASE 
WHEN isnull(FullName,'')='' THEN LTRIM(RTRIM(ContraName))
ELSE FullName
END AS FullName
,PrimaryDescription,SecondaryDescription,reference,Reference1,convert(varchar(10),CreatedDate,103) as TrxDate,
CreatedDate as CreatedDateSorted , Individual_IdentityCardNumber,
						 isnull(case when Amount<=0 then Amount*-1 else 0 end,0) as Debit,
						 isnull(case when Amount>0 then Amount else 0 end,0) as Credit,
						 SUM(Amount) OVER(ORDER BY CreatedDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal from #temp
Order by CreatedDateSorted
END










GO
/****** Object:  StoredProcedure [dbo].[sp_TellersRegister]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_TellersRegister] 
	-- Add the parameters for the stored procedure here
	--<@Param1, sysname, @p1> <Datatype_For_Param1, , int> = <Default_Value_For_Param1, , 0>, 
	---<@Param2, sysname, @p2> <Datatype_For_Param2, , int> = <Default_Value_For_Param2, , 0>
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	
/****** Script for SelectTopNRows command from SSMS  ******/
SELECT 	id,
	(select 
			(SELECT
			Individual_FirstName+' '+
			Individual_LastName
			FROM [dbo].[swiftfin_Customers] 
			where Id=dbo.swiftfin_Employees.CustomerId)
		from [dbo].[swiftfin_Employees] 
		WHERE Id=swiftfin_Tellers.EmployeeId
	  ) as EmployeeName
      ,[Code]
      ,'Teller Code: '+[Description] +' Teller Name '+
	  (select 
			(SELECT
			Individual_FirstName+' '+
			Individual_LastName
			FROM [dbo].[swiftfin_Customers] 
			where Id=dbo.swiftfin_Employees.CustomerId)
		from [dbo].[swiftfin_Employees] 
		WHERE Id=swiftfin_Tellers.EmployeeId
	  ) as DisplayName

  FROM [dbo].[swiftfin_Tellers]
 
END












GO
/****** Object:  StoredProcedure [dbo].[sp_TellerSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_Tellers
---sp_TellerSummary '8D709FB9-3D6A-C8A5-5E82-08D13FC96221','05/17/2014'
CREATE PROCEDURE [dbo].[sp_TellerSummary] 
	-- Add the parameters for the stored procedure here
	(
		@TellerCode varchar(50),
		@TrxDate Datetime
	)
AS
	Declare @Date Varchar(10)
	Set @Date=convert(varchar(10),@TrxDate,103)
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here

SELECT        dbo.swiftfin_Tellers.Description, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.PrimaryDescription, 
                         case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,
							 count(dbo.swiftfin_ChartOfAccounts.AccountCode) as Count
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Tellers.id=@TellerCode and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY dbo.swiftfin_Tellers.Description, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName,dbo.swiftfin_JournalEntries.CreatedDate
order by dbo.swiftfin_JournalEntries.CreatedDate asc
END










GO
/****** Object:  StoredProcedure [dbo].[sp_TellerSummary2]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_Tellers
---sp_TellerSummary2 'F4789D98-143E-C6B5-1D36-08D3FF6BAACC','02/27/2017'
CREATE PROCEDURE [dbo].[sp_TellerSummary2] 
	-- Add the parameters for the stored procedure here
	(
		@TellerCode varchar(50),
	
		@StartDate Datetime,@EndDate Datetime
	)
AS
	set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here

SELECT       dbo.swiftfin_Journals.PrimaryDescription, 
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,3 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.CustomerId) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=1 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,2 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=2 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription, 
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,1 as code,0 as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
Where dbo.swiftfin_Journals.TransactionCode=9 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT        'Cheque Deposit' as PrimaryDescription,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,4 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=3 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         'Cash Receipt(Sundry)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,5 as code,count(dbo.swiftfin_Journals.Id) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id

Where dbo.swiftfin_Journals.TransactionCode=18 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         'Cash Payment (Sundry)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,6 as code,count(dbo.swiftfin_Journals.Id) as CustomerServed
FROM           dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=20 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         'Cheque Receipt(Sundry)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,7 as code,count(dbo.swiftfin_Journals.Id) as CustomerServed
FROM           dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=19 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT        'Cash Receipt(Customer)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit, 8 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=17 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT        'Cash Pickup' as PrimaryDescription,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,4 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=29 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate


UNION 


SELECT        'Sundry Payment Batch ' as PrimaryDescription,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,4 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=43 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate

UNION

SELECT        'Cheque Transfer' as PrimaryDecription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,9 as code,0 as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
Where dbo.swiftfin_Journals.TransactionCode=22 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,10 as code,0 as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
Where dbo.swiftfin_Journals.TransactionCode=41 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription
order by code




END









GO
/****** Object:  StoredProcedure [dbo].[sp_TellerSummaryAll]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_Tellers

--select * from swiftfin_branches
---sp_TellerSummaryAll '07/07/2015','8B8B1B74-141C-CF68-05C2-08D19D7D7330'
create PROCEDURE [dbo].[sp_TellerSummaryAll] 
	-- Add the parameters for the stored procedure here
	(
		@TrxDate Datetime,
		@BranchID uniqueidentifier
	)
AS
	Declare @Date Varchar(10)
	Set @Date=convert(varchar(10),@TrxDate,103)
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here

SELECT         dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.PrimaryDescription, 
                         case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,
							 count(dbo.swiftfin_ChartOfAccounts.AccountCode) as Count
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where  convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date and dbo.swiftfin_Journals.branchid=@BranchID
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName
END










GO
/****** Object:  StoredProcedure [dbo].[sp_TellerSummaryCombined]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_Tellers
---sp_TellerSummaryCombined '02/27/2017'
CREATE PROCEDURE [dbo].[sp_TellerSummaryCombined] 
	-- Add the parameters for the stored procedure here
	(
		--@TellerCode varchar(50),
		@TrxDate Datetime
	)
AS
	Declare @Date Varchar(10)
	Set @Date=convert(varchar(10),@TrxDate,103)
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here

SELECT       dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.BranchId,
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,3 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=1  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.BranchId

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,2 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=2  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.BranchId

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,1 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
Where dbo.swiftfin_Journals.TransactionCode=9 and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.BranchId

UNION 

SELECT        'Cheque Deposit' as PrimaryDescription, dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,4 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=3  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT         'Cash Receipt(Sundry)' as PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,5 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id 
Where dbo.swiftfin_Journals.TransactionCode=18  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT         'Cash Payment (Sundry)' as PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,6 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
Where dbo.swiftfin_Journals.TransactionCode=20  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT         'Cheque Receipt(Sundry)' as PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,7 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id 
Where dbo.swiftfin_Journals.TransactionCode=19   and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT        'Cash Receipt(Customer)' as PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit, 8 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=17 and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT        'Cheque Transfer' as PrimaryDecription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,9 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id 
Where dbo.swiftfin_Journals.TransactionCode=22 and  convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,10 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id 
Where dbo.swiftfin_Journals.TransactionCode=41 and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,  dbo.swiftfin_Journals.BranchId
order by code




END











GO
/****** Object:  StoredProcedure [dbo].[sp_TellerSummaryCombinedPerBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_Tellers
---sp_TellerSummaryCombined '02/27/2017'
CREATE PROCEDURE [dbo].[sp_TellerSummaryCombinedPerBranch] 
	-- Add the parameters for the stored procedure here
	(
		--@TellerCode varchar(50),
		@TrxDate Datetime
	)
AS
	Declare @Date Varchar(10)
	Set @Date=convert(varchar(10),@TrxDate,103)
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here

SELECT       dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.BranchId,
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,3 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=1  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.BranchId

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,2 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=2  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.BranchId

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,1 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
Where dbo.swiftfin_Journals.TransactionCode=9 and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,dbo.swiftfin_Journals.BranchId

UNION 

SELECT        'Cheque Deposit' as PrimaryDescription, dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,4 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=3  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT         'Cash Receipt(Sundry)' as PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,5 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id 
Where dbo.swiftfin_Journals.TransactionCode=18  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT         'Cash Payment (Sundry)' as PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,6 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id
Where dbo.swiftfin_Journals.TransactionCode=20  and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT         'Cheque Receipt(Sundry)' as PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,7 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id 
Where dbo.swiftfin_Journals.TransactionCode=19   and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT        'Cash Receipt(Customer)' as PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit, 8 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=17 and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT        'Cheque Transfer' as PrimaryDecription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,9 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id 
Where dbo.swiftfin_Journals.TransactionCode=22 and  convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.BranchId

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription,  dbo.swiftfin_Journals.BranchId,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,10 as code
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id 
Where dbo.swiftfin_Journals.TransactionCode=41 and convert(varchar(10),dbo.swiftfin_JournalEntries.CreatedDate,103)=@Date
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription,  dbo.swiftfin_Journals.BranchId
order by code




END











GO
/****** Object:  StoredProcedure [dbo].[sp_TellerSummaryDetailed]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_Tellers
--select * from swiftfin_Enumerations where [key] like '%SystemTransactionCode%'
---sp_TellerSummary2 'F4789D98-143E-C6B5-1D36-08D3FF6BAACC','02/27/2017'
CREATE PROCEDURE [dbo].[sp_TellerSummaryDetailed] 
	-- Add the parameters for the stored procedure here
	(
		@TellerCode varchar(50),
	
		@StartDate Datetime,@EndDate Datetime
	)
AS
	set @EndDate= (select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
    -- Insert statements for procedure here

SELECT       dbo.swiftfin_Journals.PrimaryDescription, 
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,3 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.CustomerId) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=1 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,2 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=2 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription, 
                 case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,1 as code,0 as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
Where dbo.swiftfin_Journals.TransactionCode=9 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT        'Cheque Deposit' as PrimaryDescription,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,4 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=3 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         'Cash Receipt(Sundry)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,5 as code,count(dbo.swiftfin_Journals.Id) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id

Where dbo.swiftfin_Journals.TransactionCode=18 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         'Cash Payment (Sundry)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,6 as code,count(dbo.swiftfin_Journals.Id) as CustomerServed
FROM           dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=20 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         'Cheque Receipt(Sundry)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,7 as code,count(dbo.swiftfin_Journals.Id) as CustomerServed
FROM           dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=19 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT        'Cash Receipt(Customer)' as PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit, 8 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=17 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 


SELECT        'Cash Pickup' as PrimaryDescription,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,4 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=29 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate


UNION 


SELECT        'Sundry Payment Batch ' as PrimaryDescription,
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,4 as code,count(DISTINCT dbo.swiftfin_CustomerAccountS.Customerid) as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
Where dbo.swiftfin_Journals.TransactionCode=43 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate

UNION

SELECT        'Cheque Transfer' as PrimaryDecription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,9 as code,0 as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
Where dbo.swiftfin_Journals.TransactionCode=22 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
--GROUP BY  dbo.swiftfin_Journals.PrimaryDescription

UNION 

SELECT         dbo.swiftfin_Journals.PrimaryDescription, 
                  case when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)else 0 end AS Credit,
							case when SUM(dbo.swiftfin_JournalEntries.Amount)<=0 then SUM(dbo.swiftfin_JournalEntries.Amount) * -1 else 0 end AS Debit,10 as code,0 as CustomerServed
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id 
Where dbo.swiftfin_Journals.TransactionCode=41 and swiftfin_Tellers.id=@TellerCode and dbo.swiftfin_JournalEntries.CreatedDate BETWEEN @StartDate and @EndDate
GROUP BY  dbo.swiftfin_Journals.PrimaryDescription
order by code




END









GO
/****** Object:  StoredProcedure [dbo].[sp_TellerTransactionsByType]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from  swiftfin_Branches
--sp_TellerTransactionsByType '05/13/2015','05/13/2015','80899738-73B9-C628-8A3A-08D1CE089CFC',1
CREATE PROCEDURE [dbo].[sp_TellerTransactionsByType]
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate DateTime,
	@BranchID varchar (50),
	@TransactionCode Int 

AS
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'))
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	

    -- Insert statements for procedure here
	SELECT        dbo.swiftfin_Customers.Individual_FirstName + '' + dbo.swiftfin_Customers.Individual_LastName as FullName, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Journals.PrimaryDescription, dbo.swiftfin_Journals.SecondaryDescription, 
                         dbo.swiftfin_Journals.TransactionCode, dbo.swiftfin_Journals.TotalValue, dbo.swiftfin_ChartOfAccounts.AccountType, dbo.swiftfin_ChartOfAccounts.AccountCategory, dbo.swiftfin_ChartOfAccounts.AccountCode, 
                         dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_JournalEntries.Amount, dbo.swiftfin_Journals.CreatedDate, dbo.swiftfin_Branches.Code, dbo.swiftfin_Branches.Description
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
WHERE        (dbo.swiftfin_Journals.TransactionCode =@TransactionCode)  and swiftfin_JournalEntries.ContraChartOfAccountId in (select ChartOfAccountId from swiftfin_Tellers) 
			 and dbo.swiftfin_JournalEntries.CreatedDate 
			 between @StartDate and @EndDate and dbo.swiftfin_Branches.id=@BranchID  


END






GO
/****** Object:  StoredProcedure [dbo].[sp_TellerTransactionSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
---select * from swiftfin_branches
---sp_TellerTransactionSummary '07/09/2015','07/09/2015','8B8B1B74-141C-CF68-05C2-08D19D7D7330'
create PROCEDURE [dbo].[sp_TellerTransactionSummary] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate Datetime,
	@BranchID uniqueIdentifier
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	Declare @OpeningBalance Numeric(18,2)
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    set @OpeningBalance=isnull((select sum(amount) from swiftfin_JournalEntries where ChartOfAccountId in
	(select ChartOfAccountId from  swiftfin_Treasuries where BranchId=@BranchID) and CreatedDate<@StartDate),0);
	-- Insert statements for procedure here
	WITH CTECashJournal(Recno,Description,AccountName,Credit,Debit)
	as
	(
			select 0,'Balance B/F','Cash in Hand',case 
			when @OpeningBalance>0 then @OpeningBalance
			else 0
			end Credit,case 
			when @OpeningBalance<0 then @OpeningBalance*-1
			else 0
			end Debit
			union 
			SELECT 2,       dbo.swiftfin_TransactionCodes.Description, dbo.swiftfin_ChartOfAccounts.AccountName, case 
			when SUM(dbo.swiftfin_JournalEntries.Amount)>0 then SUM(dbo.swiftfin_JournalEntries.Amount)
			else 0
			end Credit,case 
			when SUM(dbo.swiftfin_JournalEntries.Amount)<0 then SUM(dbo.swiftfin_JournalEntries.Amount)*-1
			else 0
			end Debit
			FROM            dbo.swiftfin_Journals INNER JOIN
									 dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
									 dbo.swiftfin_TransactionCodes ON dbo.swiftfin_Journals.TransactionCode = dbo.swiftfin_TransactionCodes.TransactionCode INNER JOIN
									 dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
									 dbo.swiftfin_Tellers ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_Tellers.ChartOfAccountId
									 where dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate and dbo.swiftfin_Journals.BranchId=@BranchID and
									  dbo.swiftfin_JournalEntries.ContraChartOfAccountId not in (select ChartOfAccountId from swiftfin_SystemGeneralLedgerAccountMappings where SystemGeneralLedgerAccountCode='48834')
									  AND   dbo.swiftfin_Journals.ModuleNavigationItemCode not in (61655,61759)

			GROUP BY dbo.swiftfin_TransactionCodes.Description, dbo.swiftfin_ChartOfAccounts.AccountName
		union
		select 3,'Salary Cheques',PrimaryDescription,0,TotalValue from swiftfin_Journals where id in (
		select JournalId from swiftfin_JournalEntries where ChartOfAccountId in (select ChartOfAccountId from swiftfin_Tellers)
		 and dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate) and PrimaryDescription like '%cheque%'  and dbo.swiftfin_Journals.BranchId=@BranchID
		  and ModuleNavigationItemCode=61757
			union
		select 1,'Cash To Tellers',PrimaryDescription,sum(TotalValue),0 from swiftfin_Journals where id in (
		select JournalId from swiftfin_JournalEntries where ChartOfAccountId in (select ChartOfAccountId from swiftfin_Tellers)
		 and dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate)   and dbo.swiftfin_Journals.BranchId=@BranchID
		  	  AND   dbo.swiftfin_Journals.ModuleNavigationItemCode in (61655) group by PrimaryDescription
			union
		select 5,'Cash From Tellers',PrimaryDescription,0,sum(TotalValue) from swiftfin_Journals where id in (
		select JournalId from swiftfin_JournalEntries where ChartOfAccountId in (select ChartOfAccountId from swiftfin_Tellers)
		 and dbo.swiftfin_Journals.CreatedDate between @StartDate and @EndDate)   and dbo.swiftfin_Journals.BranchId=@BranchID
		  	  AND   dbo.swiftfin_Journals.ModuleNavigationItemCode in (61759) group by PrimaryDescription
  )
  select  ROW_NUMBER() OVER (ORDER BY RECNO) AS [serial number] , * into #tempJournal from  CTECashJournal  order by Recno
   select *,(SELECT SUM(b.Debit-b.Credit)
                       FROM #tempJournal b
                       WHERE b.[serial number] <= a.[serial number]) as RunningBalance from #tempJournal a
END






GO
/****** Object:  StoredProcedure [dbo].[sp_TEST1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,Joan>
-- Create date: <Create Date, 12/11/2015>
-- Description:	<Description, Accounts Not Credited with salary>
-- =============================================
--select * from swiftfin_loanproducts
--sp_TEST1 'FD9E3CCF-F1F7-CD59-045C-08D264EECC4F', '11/30/2015'
CREATE PROCEDURE [dbo].[sp_TEST1]
	-- Add the parameters for the stored procedure here
	--@ProductID varchar(100), 
	--@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	--set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
    -- Insert statements for procedure here
SELECT   dbo.vw_CustomerAccounts.Id, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName, 
          SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount,dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_JournalEntries.CreatedDate
FROM     dbo.vw_CustomerAccounts INNER JOIN
         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id
--WHERE dbo.swiftfin_LoanProducts.id=@ProductID and dbo.swiftfin_JournalEntries.CreatedDate=@EndDate 
GROUP BY dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Id, 
         dbo.swiftfin_LoanProducts.Description, dbo.swiftfin_JournalEntries.CreatedDate
ORDER BY dbo.swiftfin_JournalEntries.CreatedDate DESC
END






GO
/****** Object:  StoredProcedure [dbo].[sp_TextAlertSummaries]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_TextAlertSummaries] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime,
	@EndDate DateTime
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

with CTEMessages (TextMessage_Recipient,TextMessage_DLRStatus)
as
(
SELECT [TextMessage_Recipient],
	  Case [TextMessage_DLRStatus]
	  When 1 then 'UnKnown' 
	  When 2 then 'Failed'
	  When 4 then 'Pending'
	  When 8 then 'Delivered'
	  When 16 then 'Not Applicable'
	  end as [TextMessage_DLRStatus]
  FROM [VanguardFinancialsDB].[dbo].[swiftfin_TextAlerts] where CreatedDate between @StartDate and @EndDate )

  select count(*) as Count,TextMessage_DLRStatus from CTEMessages group by TextMessage_DLRStatus
 END






GO
/****** Object:  StoredProcedure [dbo].[sp_TotalLoanProductBalanceAndInterest]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
---[sp_TotalLoanProductBalanceAndInterest] '07/01/2016'
CREATE PROCEDURE [dbo].[sp_TotalLoanProductBalanceAndInterest] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With LoanProductBalances(ID,AccountNo,Reference1,Reference2,Reference3,AccountName,product,Interest,InterestRecvableAc)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.ID,dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName, dbo.swiftfin_LoanProducts.Description,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate)
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Id,dbo.swiftfin_LoanProducts.Description,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
	)
	SELECT id,AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,ltrim(rtrim(product))as product,sum(Interest) as Interest,InterestRecvableAc 
	FROM LoanProductBalances 
	Group By id,AccountNo,Reference1,Reference2,Reference3,AccountName,product,InterestRecvableAc  having sum(Interest)<>0
END






GO
/****** Object:  StoredProcedure [dbo].[sp_TotalLoanProductBalanceAndInterest1]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
---[sp_TotalLoanProductBalanceAndInterest1] '12/31/2015'
create PROCEDURE [dbo].[sp_TotalLoanProductBalanceAndInterest1] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With LoanProductBalances(ID,AccountNo,Reference1,Reference2,Reference3,AccountName,Interest,InterestRecvableAc)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.ID,dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate) and dbo.swiftfin_loanproducts.LoanRegistration_LoanProductSection='47802' and
  dbo.swiftfin_loanproducts.code<>'5' 
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Id,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
	)
	SELECT newid()as ID, id as CustomerAccountID,AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,sum(Interest) as Interest,InterestRecvableAc 
	into #temp FROM LoanProductBalances 
	Group By id,AccountNo,Reference1,Reference2,Reference3,AccountName,InterestRecvableAc  having sum(Interest)<>0
	end





GO
/****** Object:  StoredProcedure [dbo].[sp_TotalLoanProductBalanceAndInterest2]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 25.10.2014
-- Description:	Loan and Interest Balances
-- =============================================
---[sp_TotalLoanProductBalanceAndInterest6] '12/31/2015'
create PROCEDURE [dbo].[sp_TotalLoanProductBalanceAndInterest2] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

    -- Insert statements for procedure here
	With LoanProductBalances(ID,AccountNo,Reference1,Reference2,Reference3,AccountName,Interest,InterestRecvableAc)
	AS
	(
		SELECT        dbo.vw_CustomerAccounts.ID,dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, 
		dbo.vw_CustomerAccounts.FullName,
		SUM(dbo.swiftfin_JournalEntries.Amount)*-1 AS Amount,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
		FROM            dbo.vw_CustomerAccounts INNER JOIN
								 dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id INNER JOIN
								 dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND 
								 dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId
		WHERE        (dbo.swiftfin_JournalEntries.CreatedDate<=@EndDate) and dbo.swiftfin_loanproducts.LoanRegistration_LoanProductSection='47802' and
  dbo.swiftfin_loanproducts.code<>'5' 
		GROUP BY dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2,dbo.vw_CustomerAccounts.Reference3, dbo.vw_CustomerAccounts.FullName,
		dbo.vw_CustomerAccounts.FullAccount,dbo.vw_CustomerAccounts.Id,dbo.swiftfin_LoanProducts.InterestReceivableChartOfAccountId
	)
	SELECT newid()as ID, id as CustomerAccountID,AccountNo,rtrim(rtrim(Reference1)) as Reference1,ltrim(rtrim(Reference2)) as Reference2,ltrim(rtrim(Reference3)) as Reference3 ,AccountName,sum(Interest) as Interest,InterestRecvableAc 
	into #temp FROM LoanProductBalances 
	Group By id,AccountNo,Reference1,Reference2,Reference3,AccountName,InterestRecvableAc  having sum(Interest)<>0
	end





GO
/****** Object:  StoredProcedure [dbo].[sp_TransactionLog]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_TransactionLog '01/01/2017','12/31/2018'
CREATE PROC [dbo].[sp_TransactionLog]
@StartDate DateTime,
@EndDate DateTime
as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT         dbo.swiftfin_Journals.ApplicationUserName as UserID, dbo.vw_CustomerAccounts.Description as ProductID, dbo.swiftfin_Branches.Description AS BranchID,
dbo.vw_CustomerAccounts.FullAccount as AccountID,dbo.vw_CustomerAccounts.Reference1 as MemberID,dbo.swiftfin_Journals.TransactionCode as TransactionID,
dbo.swiftfin_Journals.PrimaryDescription as TransactionDescription,dbo.swiftfin_Journals.CreatedDate as TransactionDate,dbo.swiftfin_Journals.SecondaryDescription as TraansactionType,
dbo.swiftfin_Journals.TotalValue as TransactionAmount, dbo.swiftfin_Journals.CreatedBy as AuthorizedBy
                       
FROM            dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id
						 where dbo.swiftfin_Journals.CreatedDate BETWEEN @StartDate and @EndDate and swiftfin_JournalEntries.Amount>0 and
						  dbo.swiftfin_Journals.ApplicationUserName is not null
						 
GO
/****** Object:  StoredProcedure [dbo].[sp_TreasuryTranx]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--select * from swiftfin_JournalEntries
---select * from swiftfin_PostingPeriods
--sp_GlAccountStatement 'FE1B832E-3BFB-C150-B32D-08D1AD4E836D','12/01/2014','12/28/2014','2F015C30-7201-C686-7872-08D1AD41F57B'

---select * from swiftfin_ChartOfAccounts where AccountName like '%cheq%'

---select * from swiftfin_ChartOfAccounts where AccountName like '%cheq%'

 --sp_TreasuryTranx 'C4887D0D-78BD-E811-8355-08D40C76F50B', '11/1/2018','11/19/2018', '943CA8F5-48BB-E811-A814-000C29142092'

create PROCEDURE [dbo].[sp_TreasuryTranx] 
	-- Add the parameters for the stored procedure here
	@ChartOfAccountID Varchar(MAX),
	@StartDate Datetime,
	@EndDate Datetime,
	@PostingPeriod Varchar(MAX)
AS
DECLARE
	@OpeningBalance Numeric (18,2)
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here

WITH CTE AS
(
SELECT (select AccountCode from swiftfin_ChartOfAccounts where id=@ChartOfAccountID) as AccountCode,
(select AccountName from swiftfin_ChartOfAccounts where id=@ChartOfAccountID) as AccountName,'Balance B/F at ' +convert(varchar(10),@startdate,103) as PrimaryDescription,'<Opening Balance>' as SecondaryDescription,'<Opening Balance>' as Reference,
(select Balance from f_GLAccountBalance(@ChartOfAccountID,@StartDate)) as Amount,@StartDate as ValueDate,'' as FullAccountNumber,'' as FullName,'' as ContrAccountCode,'' as ContraAccountName
    UNION ALL
SELECT        dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_Journals.PrimaryDescription, 
                         dbo.swiftfin_Journals.SecondaryDescription, dbo.swiftfin_Journals.Reference, dbo.swiftfin_JournalEntries.Amount, dbo.swiftfin_Journals.CreatedDate, 
                         REPLACE(STR(dbo.swiftfin_Branches.Code, 3), SPACE(1), '0') + '-' + REPLACE(STR(dbo.swiftfin_Customers.SerialNumber, 6), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_ProductCode, 3), SPACE(1), '0') 
                         + '-' + REPLACE(STR(dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductCode, 3), SPACE(1), '0') AS FullAccountNumber, 
                         CASE dbo.swiftfin_Customers.Individual_Salutation WHEN '1' THEN 'Mr' WHEN '2' THEN 'Mrs' WHEN '3' THEN 'Miss' WHEN '4' THEN 'Dr' WHEN '5'
 THEN 'Prof' WHEN '6' THEN 'Rev' WHEN '7' THEN 'Eng' WHEN '8' THEN 'Hon' WHEN '9' THEN 'Cllr' WHEN '13' THEN 'Sir' WHEN '11' THEN
'Ms' ELSE '' END + ' ' + dbo.swiftfin_Customers.Individual_FirstName + ' ' + dbo.swiftfin_Customers.Individual_LastName AS FullName, 
                         swiftfin_ChartOfAccounts_1.AccountCode AS ContraAccountCode, swiftfin_ChartOfAccounts_1.AccountName AS ContraAccountName
FROM            dbo.swiftfin_ChartOfAccounts INNER JOIN
                         dbo.swiftfin_Journals INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId ON 
                         dbo.swiftfin_ChartOfAccounts.Id = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_ChartOfAccounts AS swiftfin_ChartOfAccounts_1 ON dbo.swiftfin_JournalEntries.ContraChartOfAccountId = swiftfin_ChartOfAccounts_1.Id LEFT OUTER JOIN
                         dbo.swiftfin_Branches INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Branches.Id = dbo.swiftfin_CustomerAccounts.BranchId INNER JOIN
                         dbo.swiftfin_Customers ON dbo.swiftfin_CustomerAccounts.CustomerId = dbo.swiftfin_Customers.Id ON 
                         dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.swiftfin_CustomerAccounts.Id
WHERE         (dbo.swiftfin_Journals.PostingPeriodId = @PostingPeriod) AND 
                         (dbo.swiftfin_ChartOfAccounts.Id = @ChartOfAccountID) AND dbo.swiftfin_ChartOfAccounts.Id in(
'C4887D0D-78BD-E811-8355-08D40C76F50B')
						 ) 
						 SELECT AccountCode,AccountName,PrimaryDescription,SecondaryDescription,Reference,ValueDate,FullAccountNumber,FullName,ContrAccountCode,ContraAccountName,
ISNULL(CASE WHEN AMOUNT<0 THEN AMOUNT*-1 END,0) AS DEBIT,
ISNULL(CASE WHEN AMOUNT>0 THEN AMOUNT END,0) AS CREDIT into #temp1 FROM CTE ORDER BY valuedate

 select *,ValueDate as CreatedDate,SUM(credit-debit) OVER(ORDER BY ValueDate 
						ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal
 from #temp1 where Valuedate BETWEEN @StartDate AND @EndDate
END


--select * from swiftfin_ChartOfAccounts where AccountName like '%treasury%'
 --select * from swiftfin_postingperiods










GO
/****** Object:  StoredProcedure [dbo].[sp_TrialBalance]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_TrialBalance] 
(
	@StartDate DateTime,
	@EndDate DateTime,
	@PostingPeriod varchar(100),
	@pBranch varchar(MAX)
)
AS

	SELECT        CASE [AccountType] WHEN 1000000 THEN 'Assets' WHEN 2000000 THEN 'Liabilities' WHEN 3000000 THEN 'Equity' WHEN 4000000 THEN 'Income' WHEN 5000000
                          THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000000 THEN 'C' WHEN 2000000 THEN 'D' WHEN 3000000 THEN 'E' WHEN 4000000 THEN 'A' WHEN 5000000 THEN 'B' END AS SortOrder,
                         dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, 
                         ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, 
                         ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit, 
                         dbo.swiftfin_ChartOfAccounts.AccountType, 
                          dbo.swiftfin_PostingPeriods.Description AS PostingPeriod
     FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_ChartOfAccounts.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id INNER JOIN
                         dbo.swiftfin_CostCenters ON dbo.swiftfin_ChartOfAccounts.CostCenterId = dbo.swiftfin_CostCenters.Id INNER JOIN
                         dbo.swiftfin_PostingPeriods ON dbo.swiftfin_Journals.PostingPeriodId = dbo.swiftfin_PostingPeriods.Id
 WHERE dbo.swiftfin_PostingPeriods.Id=@PostingPeriod AND dbo.swiftfin_JournalEntries.CreatedDate 
						BETWEEN @StartDate AND @EndDate
						AND swiftfin_Branches.Description IN (@pBranch)
GROUP BY dbo.swiftfin_ChartOfAccounts.AccountCode, dbo.swiftfin_ChartOfAccounts.AccountName, dbo.swiftfin_ChartOfAccounts.AccountType,
                        dbo.swiftfin_PostingPeriods.Id, dbo.swiftfin_PostingPeriods.Description
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)







GO
/****** Object:  StoredProcedure [dbo].[Sp_TrialBalanceByBranch]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 14.06.2014
-- Description:	ConsolidatedTrialBalance
-- =============================================

---[Sp_TrialBalanceByBranch] '7/31/2017'
CREATE PROCEDURE [dbo].[Sp_TrialBalanceByBranch] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
	--@StartDate DateTime,
	--@Branch uniqueidentifier,
	--@PostingPeriod varchar(100)

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	--select * from swiftfin_costcenters
    --Insert statements for procedure here
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT         
                          CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN
                          5000 THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000 THEN 'C' WHEN 2000 THEN 'D' WHEN 3000 THEN 'E' WHEN 4000 THEN 'A' WHEN 5000 THEN 'B' END AS SortOrder,
						 CASE left([AccountType],1) WHEN 1 THEN 1 WHEN 2 THEN 4 WHEN 3 THEN 5 WHEN 4 THEN 3 WHEN 5 THEN 2 END AS Type,
						 CASE left([Accountcode],3) WHEN 102 THEN 1 WHEN 101 THEN 2 WHEN 103 THEN 3 WHEN 104 THEN 4 WHEN 105 THEN 5 WHEN 106 THEN 6  END AS CodeType,
                         a.AccountCode, a.AccountName, 
						 ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit,a.AccountType,dbo.swiftfin_Branches.id as branchid,
						 dbo.swiftfin_Branches.Description AS Branch,dbo.swiftfin_Branches.id As Branchid,swiftfin_costcenters.id as costcenterid,swiftfin_costcenters.Description as costcenter,--dbo.swiftfin_PostingPeriods.Description AS PostingPeriod,
						 (select top 1 AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,4)=left(b.AccountCode,4) and costcenterid is not null) as subdescription
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts a ON dbo.swiftfin_JournalEntries.ChartOfAccountId = a.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id inner join
						  swiftfin_costcenters on a.CostCenterId= swiftfin_costcenters.id
WHERE        (dbo.swiftfin_Journals.ValueDate <= @EndDate)
GROUP BY a.AccountCode, a.AccountName, a.AccountType,dbo.swiftfin_Branches.Description,dbo.swiftfin_Branches.id,swiftfin_costcenters.id,swiftfin_costcenters.Description
                     
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
--ORDER BY type,codetype,a.AccountCode
END




GO
/****** Object:  StoredProcedure [dbo].[Sp_TrialBalanceByCostCenter]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 14.06.2014
-- Description:	ConsolidatedTrialBalance
-- =============================================

---[Sp_TrialBalanceByBranch] '7/31/2017'
CREATE PROCEDURE [dbo].[Sp_TrialBalanceByCostCenter] 
	-- Add the parameters for the stored procedure here
	@EndDate DateTime 
	--@StartDate DateTime,
	--@Branch uniqueidentifier,
	--@PostingPeriod varchar(100)

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	--select * from swiftfin_costcenters
    --Insert statements for procedure here
	set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT         
                          CASE [AccountType] WHEN 1000 THEN 'Assets' WHEN 2000 THEN 'Liabilities' WHEN 3000 THEN 'Equity' WHEN 4000 THEN 'Income' WHEN
                          5000 THEN 'Expenses' END AS AccountTypeCode, 
                         CASE [AccountType] WHEN 1000 THEN 'C' WHEN 2000 THEN 'D' WHEN 3000 THEN 'E' WHEN 4000 THEN 'A' WHEN 5000 THEN 'B' END AS SortOrder,
						 CASE left([AccountType],1) WHEN 1 THEN 1 WHEN 2 THEN 4 WHEN 3 THEN 5 WHEN 4 THEN 3 WHEN 5 THEN 2 END AS Type,
						 CASE left([Accountcode],3) WHEN 102 THEN 1 WHEN 101 THEN 2 WHEN 103 THEN 3 WHEN 104 THEN 4 WHEN 105 THEN 5 WHEN 106 THEN 6  END AS CodeType,
                         a.AccountCode, a.AccountName, 
						 ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         > 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) ELSE 0 END, 0) AS Credit, ISNULL(CASE WHEN SUM(dbo.swiftfin_JournalEntries.Amount) 
                         < 0 THEN SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 ELSE 0 END, 0) AS Debit,a.AccountType,dbo.swiftfin_Branches.id as branchid,
						 dbo.swiftfin_Branches.Description AS Branch,dbo.swiftfin_Branches.id As Branchid,swiftfin_costcenters.id as costcenterid,swiftfin_costcenters.Description as costcenter,--dbo.swiftfin_PostingPeriods.Description AS PostingPeriod,
						 (select top 1 AccountName from swiftfin_chartofaccounts b  where accountcategory=4096 and left(a.AccountCode,4)=left(b.AccountCode,4) and costcenterid is not null) as subdescription
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id INNER JOIN
                         dbo.swiftfin_ChartOfAccounts a ON dbo.swiftfin_JournalEntries.ChartOfAccountId = a.Id INNER JOIN
                         dbo.swiftfin_Branches ON dbo.swiftfin_Journals.BranchId = dbo.swiftfin_Branches.Id inner join
						  swiftfin_costcenters on a.CostCenterId= swiftfin_costcenters.id
WHERE        (dbo.swiftfin_Journals.ValueDate <= @EndDate)
GROUP BY a.AccountCode, a.AccountName, a.AccountType,dbo.swiftfin_Branches.Description,dbo.swiftfin_Branches.id,swiftfin_costcenters.id,swiftfin_costcenters.Description
                     
HAVING        (SUM(dbo.swiftfin_JournalEntries.Amount) <> 0)
--ORDER BY type,codetype,a.AccountCode
END




GO
/****** Object:  StoredProcedure [dbo].[sp_UnBankedCheques]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





---sp_UnBankedCheques '01/30/2015'
CREATE procedure [dbo].[sp_UnBankedCheques] 
(@EndDate DateTime)
as
---set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_ExternalCheques.Number, dbo.swiftfin_ExternalCheques.Amount, dbo.swiftfin_ExternalCheques.Drawer, dbo.swiftfin_ExternalCheques.DrawerBank, 
                         dbo.swiftfin_ExternalCheques.DrawerBankBranch, dbo.swiftfin_ExternalCheques.WriteDate, dbo.swiftfin_ChequeTypes.Description as ChequeType, 
                         dbo.swiftfin_ExternalCheques.MaturityDate, dbo.swiftfin_ExternalCheques.Remarks, dbo.swiftfin_ExternalCheques.IsCleared, dbo.swiftfin_ExternalCheques.ClearedBy, 
                         dbo.swiftfin_ExternalCheques.ClearedDate, dbo.swiftfin_ExternalCheques.IsBanked, dbo.swiftfin_ExternalCheques.BankedBy, dbo.swiftfin_ExternalCheques.BankedDate, 
                         dbo.swiftfin_ExternalCheques.IsTransferred, dbo.swiftfin_ExternalCheques.TransferredBy, dbo.swiftfin_ExternalCheques.TransferredDate, 
                         dbo.swiftfin_ExternalCheques.CreatedBy, dbo.swiftfin_ExternalCheques.CreatedDate, 
                         dbo.swiftfin_ExternalCheques.Id
FROM            dbo.swiftfin_ExternalCheques INNER JOIN 
				dbo.swiftfin_ChequeTypes On dbo.swiftfin_ChequeTypes.id = dbo.swiftfin_ExternalCheques.ChequeTypeId
WHERE       isnull(dbo.swiftfin_ExternalCheques.BankedDate,@EndDate)>=@EndDate







GO
/****** Object:  StoredProcedure [dbo].[sp_UnclearedCheques]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



---sp_UnclearedCheques '01/31/2015'
CREATE procedure [dbo].[sp_UnclearedCheques] 
(@EndDate DateTime)
as
---set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_ExternalCheques.Number, dbo.swiftfin_ExternalCheques.Amount, dbo.swiftfin_ExternalCheques.Drawer, dbo.swiftfin_ExternalCheques.DrawerBank, 
                         dbo.swiftfin_ExternalCheques.DrawerBankBranch, dbo.swiftfin_ExternalCheques.WriteDate, dbo.swiftfin_ChequeTypes.Description as ChequeType, 
                         dbo.swiftfin_ExternalCheques.MaturityDate, dbo.swiftfin_ExternalCheques.Remarks, dbo.swiftfin_ExternalCheques.IsCleared, dbo.swiftfin_ExternalCheques.ClearedBy, 
                         dbo.swiftfin_ExternalCheques.ClearedDate, dbo.swiftfin_ExternalCheques.IsBanked, dbo.swiftfin_ExternalCheques.BankedBy, dbo.swiftfin_ExternalCheques.BankedDate, 
                         dbo.swiftfin_ExternalCheques.IsTransferred, dbo.swiftfin_ExternalCheques.TransferredBy, dbo.swiftfin_ExternalCheques.TransferredDate, 
                         dbo.swiftfin_ExternalCheques.CreatedBy, dbo.swiftfin_ExternalCheques.CreatedDate, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.AccountName, 
                         dbo.vw_CustomerAccounts.Reference1, dbo.swiftfin_ExternalCheques.Id
FROM            dbo.swiftfin_ExternalCheques INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_ExternalCheques.CustomerAccountId = dbo.vw_CustomerAccounts.Id
						 INNER JOIN 
						dbo.swiftfin_ChequeTypes On dbo.swiftfin_ChequeTypes.id = dbo.swiftfin_ExternalCheques.ChequeTypeId
WHERE        (dbo.swiftfin_ExternalCheques.CustomerAccountId IS NOT NULL) and isnull(dbo.swiftfin_ExternalCheques.ClearedDate,@EndDate)>=@EndDate







GO
/****** Object:  StoredProcedure [dbo].[sp_UnpaidFixedDeposits]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




---sp_UnpaidFixedDeposits '11/15/2014'
CREATE procedure [dbo].[sp_UnpaidFixedDeposits] 
(@EndDate DateTime)
as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));

SELECT        dbo.swiftfin_FixedDeposits.Value, dbo.swiftfin_FixedDeposits.Term, dbo.swiftfin_FixedDeposits.Rate, dbo.swiftfin_FixedDeposits.Remarks, dbo.swiftfin_FixedDeposits.Status, 
                         dbo.swiftfin_FixedDeposits.MaturityDate, dbo.swiftfin_FixedDeposits.ExpectedInterest, dbo.swiftfin_FixedDeposits.TotalExpected, dbo.swiftfin_FixedDeposits.PaidBy, 
                         dbo.swiftfin_FixedDeposits.PaidDate, dbo.swiftfin_FixedDeposits.CreatedBy, dbo.swiftfin_FixedDeposits.CreatedDate, 
                         dbo.swiftfin_FixedDeposits.Id, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.FullAccount, dbo.vw_CustomerAccounts.FullName
 FROM            dbo.swiftfin_FixedDeposits INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_FixedDeposits.CustomerAccountId = dbo.vw_CustomerAccounts.Id
 wHERE         isnull(PaidDate,@EndDate)>=@EndDate and CreatedDate<@EndDate







GO
/****** Object:  StoredProcedure [dbo].[sp_UnRecoveredStandingOrders]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--sp_UnRecoveredStandingOrders '08/31/2016'
CREATE PROCEDURE [dbo].[sp_UnRecoveredStandingOrders] (@StartDate DateTime, @EndDate DateTime) as
set @EndDate=	(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
with CTEBalance (ID,Reference1,Reference3,Name,Balance,Description,LoanProductId, DisbursementDate)
as
(
SELECT        dbo.vw_CustomerAccounts.Id, dbo.vw_CustomerAccounts.Reference1, dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.FullName, SUM(dbo.swiftfin_JournalEntries.Amount) * - 1 AS Balance, 
                         dbo.vw_CustomerAccounts.Description, dbo.swiftfin_LoanProducts.Id AS LoanProductId,
	(SELECT top 1   swiftfin_JournalEntries.CreatedDate    
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.swiftfin_Journals ON dbo.swiftfin_JournalEntries.JournalId = dbo.swiftfin_Journals.Id where swiftfin_JournalEntries.CustomerAccountId=vw_CustomerAccounts.id and swiftfin_Journals.TransactionCode=21 order by CreatedDate desc) DisbursementDate				 
FROM            dbo.vw_CustomerAccounts INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.vw_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId AND dbo.vw_CustomerAccounts.ChartOfAccountId = dbo.swiftfin_JournalEntries.ChartOfAccountId INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id 
						
WHERE        (dbo.swiftfin_JournalEntries.CreatedDate <= @EndDate) and dbo.swiftfin_LoanProducts.LoanRegistration_LoanProductSection=0
GROUP BY dbo.vw_CustomerAccounts.ID,dbo.vw_CustomerAccounts.Reference1,dbo.vw_CustomerAccounts.Reference2, dbo.vw_CustomerAccounts.FullName, dbo.vw_CustomerAccounts.Description,dbo.swiftfin_LoanProducts.Id

)
select * from CTEBalance where Balance>0 and id not in (

SELECT        dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId
FROM            dbo.swiftfin_StandingOrderHistories INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_StandingOrderHistories.BeneficiaryCustomerAccountId = dbo.vw_CustomerAccounts.Id
WHERE    dbo.swiftfin_StandingOrderHistories.CreatedDate between @StartDate and @EndDate and   (dbo.swiftfin_StandingOrderHistories.ActualInterest + dbo.swiftfin_StandingOrderHistories.ActualPrincipal >0) and [trigger]=0)



GO
/****** Object:  StoredProcedure [dbo].[sp_UpdateStandingOrderCapitalizedInterest]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [dbo].[sp_UpdateStandingOrderCapitalizedInterest]
@BeneficiaryAccount uniqueidentifier,
@InterestAMount decimal(18,2)

As
--select * from 
SET NOCOUNT ON;

BEGIN
  Declare @InterestCalcMode int

  set @InterestCalcMode=(
        SELECT  top 1    dbo.swiftfin_LoanProducts.LoanInterest_CalculationMode
        FROM        dbo.swiftfin_CustomerAccounts INNER JOIN
           dbo.swiftfin_LoanProducts ON dbo.swiftfin_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id
           Where swiftfin_CustomerAccounts.id=@BeneficiaryAccount)


  UPDATE swiftfin_StandingOrders SET
   Interest =
   (CASE 
   WHEN @InterestCalcMode=512 THEN @InterestAMount  ---Reducing Balance
   --WHEN @InterestCalcMode=513 THEN interest ----Straight Line
   --WHEN @InterestCalcMode=514 THEN Principal ---Amortization (Straight Line)
   WHEN @InterestCalcMode=515 THEN iif(PaymentPerPeriod< @InterestAMount,PaymentPerperiod,@InterestAMount) ---Amortization (Diminishing Balance)
   ELSE Interest END),
   Principal=
   (CASE 
   WHEN @InterestCalcMode=512 THEN Principal  ---Reducing Balance
   WHEN @InterestCalcMode=513 THEN Principal ----Straight Line
   WHEN @InterestCalcMode=514 THEN Principal ---Amortization (Straight Line)
   WHEN @InterestCalcMode=515 THEN iif(PaymentPerPeriod-@InterestAMount<0,0,PaymentPerPeriod-@InterestAMount) ---Amortization (Diminishing Balance)
   ELSE Principal END)
    from swiftfin_StandingOrders inner join swiftfin_CustomerAccounts C
  On C.Id = swiftfin_StandingOrders.BeneficiaryCustomerAccountId inner join swiftfin_CustomerAccounts C2 
  On C2.Id = swiftfin_StandingOrders.BenefactorCustomerAccountId 
  where BeneficiaryCustomerAccountId = @BeneficiaryAccount and C.CustomerId = C2.CustomerId
  END
GO
/****** Object:  StoredProcedure [dbo].[sp_UserActivityProfile]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 01/10/2014
-- Description:	User Activity
-- =============================================
-- sp_UserActivityProfile
CREATE PROCEDURE [dbo].[sp_UserActivityProfile] 
	-- Add the parameters for the stored procedure here
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	SET NOCOUNT ON;

	SELECT        dbo.vw_EmployeeRegisterwithUserID.FullName, dbo.vw_aspnet_MembershipUsers.LoweredEmail, dbo.vw_aspnet_MembershipUsers.IsApproved, 
                         dbo.vw_aspnet_MembershipUsers.IsLockedOut, dbo.vw_aspnet_MembershipUsers.CreateDate, dbo.vw_aspnet_MembershipUsers.LastLoginDate, 
                         dbo.vw_aspnet_MembershipUsers.LastPasswordChangedDate, CASE dbo.vw_aspnet_MembershipUsers.LastLockoutDate WHEN '1754-01-01 00:00:00.000' THEN '' END
						 as  LastLockoutDate,
                         dbo.vw_aspnet_MembershipUsers.FailedPasswordAttemptCount, 
                         dbo.vw_aspnet_MembershipUsers.UserName, dbo.vw_aspnet_MembershipUsers.LastActivityDate
	FROM            dbo.vw_aspnet_MembershipUsers INNER JOIN
                         dbo.vw_EmployeeRegisterwithUserID ON dbo.vw_aspnet_MembershipUsers.UserId = dbo.vw_EmployeeRegisterwithUserID.UserId

END






GO
/****** Object:  StoredProcedure [dbo].[sp_UserProfile]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 13.06.2014
-- Description:	UserProfiles
-- =============================================
---sp_UserProfile 'bkimanga'
CREATE PROCEDURE [dbo].[sp_UserProfile] 
	-- Add the parameters for the stored procedure here
	@UserName varchar(20)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	
	SELECT        dbo.vw_EmployeeRegisterwithUserID.FullName, dbo.vw_EmployeeRegisterwithUserID.IdentityCardNumber, 
							 dbo.vw_EmployeeRegisterwithUserID.MembershipNumber, '' as EmploymentType, 
							 dbo.vw_EmployeeRegisterwithUserID.PersonalFileNumber, dbo.vw_EmployeeRegisterwithUserID.Designation, dbo.vw_EmployeeRegisterwithUserID.Reference1, 
							VanguardFinancialsDB_AuthStore.dbo.aspnet_Roles.RoleName, VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership.IsApproved, VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership.IsLockedOut, VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership.CreateDate, 
							 VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership.LastLoginDate, VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership.LastPasswordChangedDate, VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership.LastLockoutDate, 
							VanguardFinancialsDB_AuthStore. dbo.aspnet_Membership.FailedPasswordAttemptCount, VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership.Comment, VanguardFinancialsDB_AuthStore.dbo.aspnet_Users.UserName, 
							 dbo.swiftfin_ModuleNavigationItems.ModuleDescription, dbo.swiftfin_ModuleNavigationItems.ParentItemDescription, 
							 dbo.swiftfin_ModuleNavigationItems.ItemDescription
	FROM            dbo.swiftfin_ModuleNavigationItemsInRoles INNER JOIN
							 dbo.swiftfin_ModuleNavigationItems ON dbo.swiftfin_ModuleNavigationItemsInRoles.ModuleNavigationItemId = dbo.swiftfin_ModuleNavigationItems.Id INNER JOIN
							 dbo.vw_EmployeeRegisterwithUserID INNER JOIN
							 VanguardFinancialsDB_AuthStore.dbo.aspnet_UsersInRoles ON dbo.vw_EmployeeRegisterwithUserID.UserId = VanguardFinancialsDB_AuthStore.dbo.aspnet_UsersInRoles.UserId INNER JOIN
							 VanguardFinancialsDB_AuthStore.dbo.aspnet_Roles ON VanguardFinancialsDB_AuthStore.dbo.aspnet_UsersInRoles.RoleId = VanguardFinancialsDB_AuthStore.dbo.aspnet_Roles.RoleId INNER JOIN
							 VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership ON dbo.vw_EmployeeRegisterwithUserID.UserId = VanguardFinancialsDB_AuthStore.dbo.aspnet_Membership.UserId INNER JOIN
							VanguardFinancialsDB_AuthStore. dbo.aspnet_Users ON VanguardFinancialsDB_AuthStore.dbo.aspnet_UsersInRoles.UserId = VanguardFinancialsDB_AuthStore.dbo.aspnet_Users.UserId ON 
							 dbo.swiftfin_ModuleNavigationItemsInRoles.RoleName = VanguardFinancialsDB_AuthStore.dbo.aspnet_Roles.RoleName
	WHERE VanguardFinancialsDB_AuthStore.dbo.aspnet_Users.UserName=@UserName
	END







GO
/****** Object:  StoredProcedure [dbo].[sp_UsersTransactionsSummary]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--select PrimaryDescription,SecondaryDescription,Reference,TotalValue,ApplicationUserName from swiftfin_Journals where ApplicationUserName is not null and ParentId is null


-- sp_UsersTransactionsSummary '05/07/2018','05/07/2018'
CREATE proc [dbo].[sp_UsersTransactionsSummary]
@StartDate DateTime,
@EndDate DateTime
as
set @EndDate=(select DATEADD(day, DATEDIFF(day, 0, @EndDate), '23:59:59'));
select applicationUsername,count(applicationusername) as NumberofTransactions from swiftfin_AuditLogs
where CreatedDate Between @StartDate and @EndDate and ApplicationUserName is not null 
group by applicationUsername


--select top 1000 * from swiftfin_AuditLogs
GO
/****** Object:  StoredProcedure [dbo].[sp_ValidateGracePeriodComputation]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 23.07.2014
-- Description:	ValidateGracePeriodComputation
-- =============================================
---sp_ValidateGracePeriodComputation 'C0038028-75C8-C527-AB15-08D1D39B7B25',5
CREATE PROCEDURE [dbo].[sp_ValidateGracePeriodComputation] 
	-- Add the parameters for the stored procedure here
	@CustomerAccountID varchar(100) , 
	@Month int 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	Declare @CustomerID varchar(100),
			@LoanProductID	varchar(100),	
			@GracePeriod int, @LoanDays int,
			@MonthName varchar(20),
			@Value int=0,
			@Compute int=0
			select @CustomerID =(select top 1 CustomerId from swiftfin_CustomerAccounts where CustomerId=@CustomerAccountID)
			select @LoanProductID =(select top 1 CustomerAccountType_TargetProductId from swiftfin_CustomerAccounts where CustomerId=@CustomerAccountID)
			select @GracePeriod=(select LoanRegistration_GracePeriod from swiftfin_LoanProducts where id=@LoanProductID)
			select @LoanDays=(select top 1 DATEDIFF(d,AuditedDate,getdate()) from swiftfin_LoanCases where CustomerId=@LoanProductID and LoanProductId=@LoanProductID order by AuditedDate desc)
			select @MonthName=(select MonthName from dbo.GetMonthList('01/01/2014',0) where MonthNumber=@Month)
		

		   SET  @Value= 
		   (  SELECT top 1 1
				FROM            dbo.swiftfin_Journals INNER JOIN
				dbo.swiftfin_JournalEntries ON dbo.swiftfin_Journals.Id = dbo.swiftfin_JournalEntries.JournalId where swiftfin_JournalEntries.CustomerAccountId=@CustomerAccountID and swiftfin_Journals.SecondaryDescription like '%~' + @MonthName
				 and swiftfin_Journals.TransactionCode =24 	
				and swiftfin_Journals.PostingPeriodId in (select top 1 id from swiftfin_PostingPeriods where IsActive=1) 		   
		   )
		   SET @Value=isnull(@Value,0)

	if @value=0
		begin
			select @value= iif(@LoanDays<@GracePeriod,1,0)
		end
	select @value
END






GO
/****** Object:  StoredProcedure [dbo].[sp_WithdrawalNotifications]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Centrino
-- Create date: 05.06.2014
-- Description:	WithdrawalNotifications
-- =============================================

---[sp_WithdrawalNotifications] '01/01/2014','06/30/2014'
CREATE PROCEDURE [dbo].[sp_WithdrawalNotifications] 
	-- Add the parameters for the stored procedure here
	@StartDate DateTime  , 
	@EndDate DateTime 
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	
	SELECT        dbo.swiftfin_Branches.Description AS ReceivingBranch, ltrim(rtrim(dbo.vw_MemberRegister.Individual_FirstName))+' '+ltrim(rtrim(dbo.vw_MemberRegister.Individual_LastName)) as Name, dbo.vw_MemberRegister.Gender, dbo.vw_MemberRegister.Individual_IdentityCardNumber, 
							 dbo.vw_MemberRegister.MembershipNumber, dbo.vw_MemberRegister.Individual_PayrollNumbers, dbo.swiftfin_MembershipWithdrawalNotifications.CreatedBy, 
							 dbo.swiftfin_MembershipWithdrawalNotifications.CreatedDate, dbo.vw_MemberRegister.Zone,
							 CASE dbo.swiftfin_MembershipWithdrawalNotifications.Status
							 WHEN 1 THEN 'Open'
							 WHEN 2 THEN 'Closed'
							 WHEN 4 THEN 'Suspended'
							 END AS Status,
							 CASE dbo.swiftfin_MembershipWithdrawalNotifications.Category
							 WHEN 1792 THEN 'Deceased'
							 WHEN 1793 THEN 'Back Office'
							 WHEN 1994 THEN 'Front Office'
							 END AS Category
	FROM            dbo.swiftfin_MembershipWithdrawalNotifications INNER JOIN
							 dbo.vw_MemberRegister ON dbo.swiftfin_MembershipWithdrawalNotifications.CustomerId = dbo.vw_MemberRegister.Id INNER JOIN
							 dbo.swiftfin_Branches ON dbo.swiftfin_MembershipWithdrawalNotifications.BranchId = dbo.swiftfin_Branches.Id

	WHERE swiftfin_MembershipWithdrawalNotifications.CreatedDate BETWEEN  @StartDate AND @EndDate
END







GO
/****** Object:  StoredProcedure [dbo].[spMembersAndNonMembers]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--Exec spMembersAndNonMembers '9AC3ECAA-B9D3-CF83-E5FD-08D20DABFB88'
--select * from swiftfin_InvestmentProducts
CREATE proc [dbo].[spMembersAndNonMembers]
@InvestmentProductId UniqueIdentifier
as

SELECT        dbo.swiftfin_Customers.Individual_FirstName + ' ' +  dbo.swiftfin_Customers.Individual_LastName As AccountName, SUM(dbo.swiftfin_JournalEntries.Amount) AS Amount, 
                         dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3
FROM            dbo.swiftfin_Customers INNER JOIN
                         dbo.swiftfin_CustomerAccounts ON dbo.swiftfin_Customers.Id = dbo.swiftfin_CustomerAccounts.CustomerId INNER JOIN
                         dbo.swiftfin_JournalEntries ON dbo.swiftfin_CustomerAccounts.Id = dbo.swiftfin_JournalEntries.CustomerAccountId INNER JOIN
                         dbo.swiftfin_InvestmentProducts ON dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_InvestmentProducts.ChartOfAccountId
where dbo.swiftfin_InvestmentProducts.Id=@InvestmentProductId and dbo.swiftfin_JournalEntries.Amount >0
GROUP BY dbo.swiftfin_Customers.Individual_FirstName, dbo.swiftfin_Customers.Individual_LastName, dbo.swiftfin_Customers.Reference1, dbo.swiftfin_Customers.Reference2, dbo.swiftfin_Customers.Reference3,
                         dbo.swiftfin_InvestmentProducts.Description





GO
/****** Object:  StoredProcedure [dbo].[testcrb]    Script Date: 23/05/2023 11:07:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from swiftfin_MicroCreditGroupMembers
--testcrb '92B37A75-5CD8-C9C4-045C-08D264EECC4F', '03/03/2013'
CREATE Procedure [dbo].[testcrb]  
(
@loanid uniqueidentifier,
@EndDate DateTime
)
as
SELECT        dbo.swiftfin_Customers.Individual_FirstName+' '+ dbo.swiftfin_Customers.Individual_LastName as Fullname, dbo.swiftfin_Customers.Reference1
,isnull((SELECT        SUM(dbo.swiftfin_JournalEntries.Amount) AS Expr1
FROM            dbo.swiftfin_JournalEntries INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_JournalEntries.CustomerAccountId = dbo.vw_CustomerAccounts.Id INNER JOIN
                         dbo.swiftfin_LoanProducts ON dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId = dbo.swiftfin_LoanProducts.Id AND 
                         dbo.swiftfin_JournalEntries.ChartOfAccountId = dbo.swiftfin_LoanProducts.ChartOfAccountId
WHERE     dbo.vw_CustomerAccounts.CustomerId=  dbo.swiftfin_Customers.id and dbo.swiftfin_LoanProducts.LoanRegistration_Microcredit = 1 and swiftfin_JournalEntries.CreatedDate<=@EndDate ),0)*
-1 as [Loan Balance],

isnull((SELECT   top (1)     dbo.swiftfin_LoanCases.DisbursedAmount
FROM            dbo.swiftfin_LoanCases INNER JOIN
                         dbo.vw_CustomerAccounts ON dbo.swiftfin_LoanCases.CustomerId = dbo.vw_CustomerAccounts.CustomerId inner join

                         dbo.swiftfin_LoanProducts on dbo.vw_CustomerAccounts.CustomerAccountType_TargetProductId=dbo.swiftfin_LoanProducts.Id and
						  dbo.swiftfin_LoanCases.LoanProductId=dbo.swiftfin_LoanProducts.Id 
                          WHERE     dbo.vw_CustomerAccounts.CustomerId=  dbo.swiftfin_Customers.id and dbo.swiftfin_LoanProducts.id =@loanid  

ORDER BY dbo.swiftfin_LoanCases.DisbursedDate DESC
),0) as DisbursedAmount






FROM            dbo.swiftfin_Customers
                      





GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[20] 2[10] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = -96
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 15
               Left = 452
               Bottom = 219
               Right = 749
            End
            DisplayFlags = 280
            TopColumn = 43
         End
         Begin Table = "swiftfin_CustomerAccounts"
            Begin Extent = 
               Top = 39
               Left = 32
               Bottom = 169
               Right = 353
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "customer (FOSA.dbo)"
            Begin Extent = 
               Top = 170
               Left = 68
               Bottom = 300
               Right = 264
            End
            DisplayFlags = 280
            TopColumn = 55
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 10
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'View_signatories'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'View_signatories'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_StandingOrders"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 225
               Right = 304
            End
            DisplayFlags = 280
            TopColumn = 11
         End
         Begin Table = "vw_CustomerAccounts"
            Begin Extent = 
               Top = 0
               Left = 636
               Bottom = 225
               Right = 949
            End
            DisplayFlags = 280
            TopColumn = 3
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 10
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_AdavanceSO'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_AdavanceSO'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[5] 2[22] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "lntypes (FOSA.dbo)"
            Begin Extent = 
               Top = 2
               Left = 84
               Bottom = 204
               Right = 346
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 45
         Width = 284
         Width = 1500
         Width = 3165
         Width = 1500
         Width = 1830
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Advtypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Advtypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Advtypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[62] 4[4] 2[14] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 343
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 8
         End
         Begin Table = "swiftfin_AlternateChannels"
            Begin Extent = 
               Top = 0
               Left = 825
               Bottom = 338
               Right = 1021
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CustomerAccounts"
            Begin Extent = 
               Top = 2
               Left = 408
               Bottom = 305
               Right = 729
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_ATMcards'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_ATMcards'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[45] 4[8] 2[16] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 0
               Left = 24
               Bottom = 219
               Right = 322
            End
            DisplayFlags = 280
            TopColumn = 44
         End
         Begin Table = "customer (BOSA.dbo)"
            Begin Extent = 
               Top = 6
               Left = 373
               Bottom = 237
               Right = 567
            End
            DisplayFlags = 280
            TopColumn = 4
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_ClosedAccounts'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_ClosedAccounts'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_CreditBatchEntries"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 234
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CustomerAccounts"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 359
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Branches"
            Begin Extent = 
               Top = 270
               Left = 38
               Bottom = 400
               Right = 244
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 402
               Left = 38
               Bottom = 532
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CreditBatches"
            Begin Extent = 
               Top = 534
               Left = 38
               Bottom = 664
               Right = 264
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CreditTypes"
            Begin Extent = 
               Top = 6
               Left = 272
               Bottom = 136
               Right = 458
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_ChartOfAccounts"
            Begin Extent = 
               Top = 666
               Left = 38
               Bottom = 796
   ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CreditBatchEntries'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'            Right = 255
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CreditTypeCommissions"
            Begin Extent = 
               Top = 270
               Left = 282
               Bottom = 400
               Right = 452
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Commissions"
            Begin Extent = 
               Top = 666
               Left = 293
               Bottom = 796
               Right = 474
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CreditBatchEntries'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CreditBatchEntries'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_CreditBatches"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 265
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CreditBatchEntries"
            Begin Extent = 
               Top = 6
               Left = 303
               Bottom = 136
               Right = 499
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CreditTypes"
            Begin Extent = 
               Top = 6
               Left = 537
               Bottom = 136
               Right = 745
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "vw_CustomerAccounts"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 359
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_credittypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_credittypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[62] 4[5] 2[15] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Divisions"
            Begin Extent = 
               Top = 6
               Left = 609
               Bottom = 136
               Right = 779
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Zones"
            Begin Extent = 
               Top = 190
               Left = 807
               Bottom = 320
               Right = 977
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Employers"
            Begin Extent = 
               Top = 6
               Left = 817
               Bottom = 175
               Right = 1023
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Stations"
            Begin Extent = 
               Top = 127
               Left = 397
               Bottom = 257
               Right = 603
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CustomerAccounts"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 359
            End
            DisplayFlags = 280
            TopColumn = 15
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 337
               Right = 333
            End
            DisplayFlags = 280
            TopColumn = 21
         End
         Begin Table = "swiftfin_Branches"
            Begin Extent = 
               Top = 270
               Left = 38
               Bottom = 400
               Right = 244' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CustomerAccounts'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Products_1"
            Begin Extent = 
               Top = 404
               Left = 506
               Bottom = 534
               Right = 725
            End
            DisplayFlags = 280
            TopColumn = 4
         End
         Begin Table = "swiftfin_ChartOfAccounts"
            Begin Extent = 
               Top = 413
               Left = 105
               Bottom = 543
               Right = 322
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CustomerAccounts'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CustomerAccounts'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_CustomerAccounts"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 359
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Branches"
            Begin Extent = 
               Top = 270
               Left = 38
               Bottom = 400
               Right = 244
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CustomerAccountsWithoutProductDescription'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_CustomerAccountsWithoutProductDescription'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Customers'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Customers'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "vw_CustomerAccounts"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 225
               Right = 377
            End
            DisplayFlags = 280
            TopColumn = 2
         End
         Begin Table = "swiftfin_StandingOrders"
            Begin Extent = 
               Top = 13
               Left = 660
               Bottom = 225
               Right = 957
            End
            DisplayFlags = 280
            TopColumn = 1
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_DuplicateStdOrders'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_DuplicateStdOrders'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[67] 4[4] 2[14] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Employees"
            Begin Extent = 
               Top = 20
               Left = 442
               Bottom = 292
               Right = 746
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 23
               Left = 0
               Bottom = 153
               Right = 297
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Branches"
            Begin Extent = 
               Top = 177
               Left = 37
               Bottom = 307
               Right = 243
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Designations"
            Begin Extent = 
               Top = 38
               Left = 1096
               Bottom = 168
               Right = 1274
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_EmployeeTypes"
            Begin Extent = 
               Top = 217
               Left = 1096
               Bottom = 347
               Right = 1376
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Departments"
            Begin Extent = 
               Top = 6
               Left = 784
               Bottom = 136
               Right = 954
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 28
         Width = 284
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EmployeeRegister'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EmployeeRegister'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EmployeeRegister'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[57] 4[5] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "aspnet_Profile (VanguardFinancialsDB_AuthStore.dbo)"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 239
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "vw_EmployeeRegister"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 296
               Right = 354
            End
            DisplayFlags = 280
            TopColumn = 23
         End
         Begin Table = "aspnet_Users (VanguardFinancialsDB_AuthStore.dbo)"
            Begin Extent = 
               Top = 6
               Left = 277
               Bottom = 136
               Right = 466
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EmployeeRegisterwithUserID'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EmployeeRegisterwithUserID'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Employers"
            Begin Extent = 
               Top = 0
               Left = 29
               Bottom = 220
               Right = 250
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Divisions"
            Begin Extent = 
               Top = 5
               Left = 400
               Bottom = 135
               Right = 570
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Zones"
            Begin Extent = 
               Top = 1
               Left = 642
               Bottom = 131
               Right = 812
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Stations"
            Begin Extent = 
               Top = 6
               Left = 850
               Bottom = 136
               Right = 1056
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Employers'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Employers'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[45] 4[16] 2[7] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 231
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "EmployersMapping"
            Begin Extent = 
               Top = 6
               Left = 373
               Bottom = 189
               Right = 548
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 2715
         Width = 2640
         Width = 2880
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EmployerStationMapping'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_EmployerStationMapping'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[15] 2[15] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_StandingOrders"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 210
               Right = 364
            End
            DisplayFlags = 280
            TopColumn = 12
         End
         Begin Table = "swiftfin_StandingOrders_Copy"
            Begin Extent = 
               Top = 14
               Left = 577
               Bottom = 208
               Right = 836
            End
            DisplayFlags = 280
            TopColumn = 15
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 51
         Width = 284
         Width = 2205
         Width = 1500
         Width = 1500
         Width = 1935
         Width = 1905
         Width = 1650
         Width = 1500
         Width = 1950
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1860
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1980
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Wi' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_FosaLoanInterest'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'dth = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_FosaLoanInterest'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_FosaLoanInterest'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[20] 2[10] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "gledger (FOSA.dbo)"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 219
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_GlName'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_GlName'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[20] 2[11] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "lntypes (BOSA.dbo)"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 272
            End
            DisplayFlags = 280
            TopColumn = 4
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 75
         Width = 284
         Width = 1500
         Width = 2115
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 3735
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_lntypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_lntypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_lntypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[55] 4[6] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_LoanProductDynamicCharges"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 187
               Right = 259
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_DynamicCharges"
            Begin Extent = 
               Top = 6
               Left = 260
               Bottom = 136
               Right = 489
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_DynamicChargeCommissions"
            Begin Extent = 
               Top = 6
               Left = 527
               Bottom = 136
               Right = 711
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Commissions"
            Begin Extent = 
               Top = 80
               Left = 775
               Bottom = 210
               Right = 956
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_GraduatedScales"
            Begin Extent = 
               Top = 21
               Left = 1015
               Bottom = 203
               Right = 1218
            End
            DisplayFlags = 280
            TopColumn = 1
         End
         Begin Table = "swiftfin_LoanProducts"
            Begin Extent = 
               Top = 63
               Left = 24
               Bottom = 224
               Right = 522
            End
            DisplayFlags = 280
            TopColumn = 2
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin C' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_LoanDynamicCharges'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'riteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_LoanDynamicCharges'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_LoanDynamicCharges'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[61] 4[1] 2[21] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_LoanCases"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 445
            End
            DisplayFlags = 280
            TopColumn = 33
         End
         Begin Table = "swiftfin_Branches"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 244
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 270
               Left = 38
               Bottom = 400
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_LoanProducts"
            Begin Extent = 
               Top = 402
               Left = 38
               Bottom = 532
               Right = 445
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_LoanPurposes"
            Begin Extent = 
               Top = 138
               Left = 282
               Bottom = 268
               Right = 452
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 135' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_LoaningList'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'0
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_LoaningList'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_LoaningList'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[63] 4[5] 2[14] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = -384
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Zones"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 208
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Stations"
            Begin Extent = 
               Top = 21
               Left = 658
               Bottom = 151
               Right = 864
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Divisions"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 208
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Employers"
            Begin Extent = 
               Top = 177
               Left = 296
               Bottom = 307
               Right = 502
            End
            DisplayFlags = 280
            TopColumn = 1
         End
         Begin Table = "swiftfin_Delegates"
            Begin Extent = 
               Top = 270
               Left = 38
               Bottom = 400
               Right = 208
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 374
               Left = 318
               Bottom = 525
               Right = 610
            End
            DisplayFlags = 280
            TopColumn = 1
         End
         Begin Table = "swiftfin_Customers_2"
            Begin Extent = 
               Top = 545
               Left = 816
               Bottom = 717
               Right = 1113' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_MemberRegister'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'
            End
            DisplayFlags = 280
            TopColumn = 14
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_MemberRegister'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_MemberRegister'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[20] 2[5] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "GroupMember (FOSA.dbo)"
            Begin Extent = 
               Top = 50
               Left = 599
               Bottom = 225
               Right = 769
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Group_Designation (FOSA.dbo)"
            Begin Extent = 
               Top = 4
               Left = 348
               Bottom = 134
               Right = 518
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers_1"
            Begin Extent = 
               Top = 0
               Left = 25
               Bottom = 205
               Right = 268
            End
            DisplayFlags = 280
            TopColumn = 19
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 6
               Left = 825
               Bottom = 211
               Right = 1086
            End
            DisplayFlags = 280
            TopColumn = 3
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1230
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 2055
         Width = 2040
         Width = 2355
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
  ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_MicroGroupMembers'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'       Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_MicroGroupMembers'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_MicroGroupMembers'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[20] 2[12] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_NextOfKin"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 189
               Right = 319
            End
            DisplayFlags = 280
            TopColumn = 12
         End
         Begin Table = "NextofKin"
            Begin Extent = 
               Top = 2
               Left = 480
               Bottom = 182
               Right = 717
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 26
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_NextofKin'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_NextofKin'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[21] 2[9] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = -384
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_OverDeductionBatchEntries"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 266
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_OverDeductionBatches"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 244
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CustomerAccounts"
            Begin Extent = 
               Top = 270
               Left = 38
               Bottom = 400
               Right = 359
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 402
               Left = 38
               Bottom = 599
               Right = 340
            End
            DisplayFlags = 280
            TopColumn = 33
         End
         Begin Table = "swiftfin_Branches"
            Begin Extent = 
               Top = 534
               Left = 38
               Bottom = 664
               Right = 244
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Products_1"
            Begin Extent = 
               Top = 666
               Left = 38
               Bottom = 796
               Right = 257
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_CustomerAccounts_1"
            Begin Extent = 
               Top = 798
               Left = 38
               Bo' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Overdeductions'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'ttom = 928
               Right = 359
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers_1"
            Begin Extent = 
               Top = 930
               Left = 38
               Bottom = 1060
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Branches_1"
            Begin Extent = 
               Top = 1062
               Left = 38
               Bottom = 1192
               Right = 244
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "Products_2"
            Begin Extent = 
               Top = 1194
               Left = 38
               Bottom = 1324
               Right = 257
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Overdeductions'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Overdeductions'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = -576
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_PaySlipEntries"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 234
            End
            DisplayFlags = 280
            TopColumn = 7
         End
         Begin Table = "swiftfin_PaySlips"
            Begin Extent = 
               Top = 11
               Left = 681
               Bottom = 141
               Right = 851
            End
            DisplayFlags = 280
            TopColumn = 2
         End
         Begin Table = "swiftfin_SalaryPeriods"
            Begin Extent = 
               Top = 4
               Left = 279
               Bottom = 134
               Right = 573
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_SalaryCards"
            Begin Extent = 
               Top = 270
               Left = 38
               Bottom = 400
               Right = 208
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_SalaryGroups"
            Begin Extent = 
               Top = 270
               Left = 246
               Bottom = 383
               Right = 416
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_SalaryGroupEntries"
            Begin Extent = 
               Top = 384
               Left = 246
               Bottom = 514
               Right = 449
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_SalaryHeads"
            Begin Extent = 
               Top = 516
               Left = 38
               Bottom = 646
 ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_payslips'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N'              Right = 359
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "vw_EmployeeRegister"
            Begin Extent = 
               Top = 625
               Left = 542
               Bottom = 755
               Right = 842
            End
            DisplayFlags = 280
            TopColumn = 18
         End
         Begin Table = "vw_CustomerAccounts"
            Begin Extent = 
               Top = 780
               Left = 38
               Bottom = 910
               Right = 359
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_PostingPeriods"
            Begin Extent = 
               Top = 912
               Left = 38
               Bottom = 1042
               Right = 265
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_payslips'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_payslips'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[53] 4[8] 2[14] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 231
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 4
         End
         Begin Table = "customer (FOSA.dbo)"
            Begin Extent = 
               Top = 10
               Left = 448
               Bottom = 238
               Right = 679
            End
            DisplayFlags = 280
            TopColumn = 40
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Phone'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Phone'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[74] 4[4] 2[4] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 378
               Right = 335
            End
            DisplayFlags = 280
            TopColumn = 14
         End
         Begin Table = "MasterFile_Import (FOSA.dbo)"
            Begin Extent = 
               Top = 6
               Left = 383
               Bottom = 287
               Right = 632
            End
            DisplayFlags = 280
            TopColumn = 7
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 65
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width =' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_PhoneNoId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N' 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_PhoneNoId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_PhoneNoId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[20] 2[10] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "gltrans (FOSA.dbo)"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 193
               Right = 393
            End
            DisplayFlags = 280
            TopColumn = 28
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 71
         Width = 284
         Width = 1500
         Width = 1500
         Width = 3780
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 2295
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 2790
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width =' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_PreviousGLStatement'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N' 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_PreviousGLStatement'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_PreviousGLStatement'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[20] 2[11] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "lntypes (BOSA.dbo)"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 272
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Shtypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Shtypes'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "customer (FOSA.dbo)"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 234
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_SavingsProducts"
            Begin Extent = 
               Top = 6
               Left = 631
               Bottom = 136
               Right = 877
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "vw_CustomerAccounts"
            Begin Extent = 
               Top = 6
               Left = 272
               Bottom = 136
               Right = 593
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_SigningInstructions'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_SigningInstructions'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "vw_CustomerAccounts"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 375
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_LoanProducts"
            Begin Extent = 
               Top = 6
               Left = 413
               Bottom = 136
               Right = 927
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_JournalEntries"
            Begin Extent = 
               Top = 6
               Left = 965
               Bottom = 136
               Right = 1203
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_StandingOrders"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 313
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
        ' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StaffStandingOrders'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane2', @value=N' Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StaffStandingOrders'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=2 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StaffStandingOrders'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[20] 2[10] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "Standing"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 158
               Right = 222
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_StandingOrders"
            Begin Extent = 
               Top = 0
               Left = 451
               Bottom = 192
               Right = 710
            End
            DisplayFlags = 280
            TopColumn = 13
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 15
         Width = 284
         Width = 1905
         Width = 1500
         Width = 1845
         Width = 1785
         Width = 1800
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 2430
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Standing'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_Standing'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[41] 4[12] 2[23] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_StandingOrders"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 168
               Right = 300
            End
            DisplayFlags = 280
            TopColumn = 16
         End
         Begin Table = "swiftfin_CustomerAccounts"
            Begin Extent = 
               Top = 4
               Left = 370
               Bottom = 168
               Right = 676
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_Customers"
            Begin Extent = 
               Top = 0
               Left = 801
               Bottom = 195
               Right = 1098
            End
            DisplayFlags = 280
            TopColumn = 5
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 11
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StandingOrder2'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StandingOrder2'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[56] 4[7] 2[15] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "swiftfin_StandingOrders"
            Begin Extent = 
               Top = 1
               Left = 14
               Bottom = 281
               Right = 319
            End
            DisplayFlags = 280
            TopColumn = 1
         End
         Begin Table = "vw_CustomerAccounts"
            Begin Extent = 
               Top = 6
               Left = 398
               Bottom = 267
               Right = 727
            End
            DisplayFlags = 280
            TopColumn = 6
         End
         Begin Table = "swiftfin_LoanProducts"
            Begin Extent = 
               Top = 13
               Left = 834
               Bottom = 230
               Right = 1211
            End
            DisplayFlags = 280
            TopColumn = 10
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 11
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StandingOrders'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StandingOrders'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPane1', @value=N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[31] 4[5] 2[35] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "vw_CustomerAccounts"
            Begin Extent = 
               Top = 0
               Left = 38
               Bottom = 310
               Right = 358
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "swiftfin_StandingOrders"
            Begin Extent = 
               Top = 0
               Left = 668
               Bottom = 322
               Right = 983
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 2535
         Width = 2250
         Width = 2880
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StandingOrderTrigger'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_DiagramPaneCount', @value=1 , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'VIEW',@level1name=N'vw_StandingOrderTrigger'
GO
