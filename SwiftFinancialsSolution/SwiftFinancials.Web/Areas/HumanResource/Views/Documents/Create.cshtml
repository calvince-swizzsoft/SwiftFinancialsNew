@model Application.MainBoundedContext.DTO.HumanResourcesModule.EmployeeDocumentDTO

@{ ViewBag.Title = "Create Employee Documents"; }
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Create Employee Documents</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                @Html.ActionLink("Dashboard", "Index", "Home", new { Area = "" }, null)
            </li>
            <li class="breadcrumb-item">
                @Html.ActionLink("Home", "Index", "EmployeeDocuments", new { Area = "HumanResource" }, null)
            </li>
            <li class="breadcrumb-item active">
                <strong>Create</strong>
            </li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content white-bg">
    <div class="row">
        <div class="col-md-12">
            <div class="ibox">
                <div class="ibox-title">
                    <p>The documents that can be uploaded here include employees C.V, Contract letter, Warning letters among others.</p>
                </div>
                <div class="ibox-content bg-white text-info">
                    @using (Html.BeginForm("Create", "EmployeeDocuments", new { Area = "HumanResource" }, FormMethod.Post, new { enctype = "multipart/form-data" }))
                    {
        @Html.AntiForgeryToken()

                        <fieldset>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="form-group form-group-lg">
                                        @Html.LabelFor(model => model.FileName, new { @class = "control-label" })
                                        @Html.HiddenFor(model => model.FileName)
                                        <div class="input-group" data-autoclose="true">
                                            <input type="file" id="documentUpload" class="form-control input-md" required />
                                            <span class="input-group-addon">
                                                <a data-toggle="modal" data-target="#documentLookupModal"><span class="fa fa-search"></span></a>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group form-group-lg">
                                        @Html.LabelFor(model => model.EmployeeCustomerFullName, new { @class = "control-label" })
                                        @Html.HiddenFor(model => model.EmployeeCustomerId)
                                        <div class="input-group" data-autoclose="true">
                                            @Html.TextBoxFor(model => model.EmployeeCustomerFullName, new { @class = "form-control input-md alpha alphaspace required", @readonly = "readonly" })
                                            <span class="input-group-addon">
                                                <a data-toggle="modal" data-target="#customerLookupModal"><span class="fa fa-search"></span></a>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group form-group-lg">
                                        @Html.LabelFor(model => model.FileTitle, htmlAttributes: new { @class = "" })
                                        @Html.EditorFor(model => model.FileTitle, new { htmlAttributes = new { @class = "form-control", @placeholder = "Title", @required = "" } })
                                        @Html.ValidationMessageFor(model => model.FileTitle, "", new { @class = "text-danger" })
                                    </div>

                                    <div class="form-group form-group-lg">
                                        @Html.LabelFor(model => model.FileDescription, htmlAttributes: new { @class = "" })
                                        @Html.TextAreaFor(model => model.FileDescription, new { htmlAttributes = new { @class = "form-control", @placeholder = "Description", @required = "" } })
                                        @Html.ValidationMessageFor(model => model.FileDescription, "", new { @class = "text-danger" })
                                    </div>

                                    <div class="form-group form-group-sm">
                                        <div class="col-md-offset-2">
                                            <input type="submit" value="Create" class="btn btn-primary" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customerLookupModal" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h3 class="font-bold">Customers Lookup<button type="button" class="close" data-dismiss="modal"><span class="sr-only">Close</span></button></h3>
            </div>
            <table id="customersGrid" class="table table-striped table-bordered table-hover" style="width:100%;">
                <tbody>
                    <tr>
                        <td class="dataTables_empty">
                            Loading data from server
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    @Styles.Render("~/Content/plugins/iCheck/iCheckStyles")
    @Styles.Render("~/Content/plugins/dataTables/dataTablesStyles")
    @Styles.Render("~/plugins/awesomeCheckboxStyles")
    @Styles.Render("~/plugins/clockpickerStyles")
    @Styles.Render("~/plugins/dateRangeStyles")
    @Styles.Render("~/Content/plugins/chosen/chosenStyles")
    @Styles.Render("~/plugins/switcheryStyles")
    @Styles.Render("~/plugins/jasnyBootstrapStyles")
    @Styles.Render("~/plugins/nouiSliderStyles")
    @Styles.Render("~/plugins/dataPickerStyles")
    @Styles.Render("~/Content/plugins/ionRangeSlider/ionRangeStyles")
    @Styles.Render("~/plugins/imagecropperStyles")
    @Styles.Render("~/Content/plugins/colorpicker/colorpickerStyles")
    @Styles.Render("~/plugins/select2Styles")
    @Styles.Render("~/plugins/touchSpinStyles")
    @Styles.Render("~/plugins/tagInputsStyles")
    @Styles.Render("~/plugins/duallistStyles")
}

@section Scripts {
    @Scripts.Render("~/plugins/validate")
    @Scripts.Render("~/plugins/typehead")
    @Scripts.Render("~/plugins/dataTables")
    @Scripts.Render("~/plugins/iCheck")
    @Scripts.Render("~/plugins/dataPicker")
    @Scripts.Render("~/plugins/ionRange")
    @Scripts.Render("~/plugins/nouiSlider")
    @Scripts.Render("~/plugins/jasnyBootstrap")
    @Scripts.Render("~/plugins/switchery")
    @Scripts.Render("~/plugins/chosen")
    @Scripts.Render("~/plugins/knob")
    @Scripts.Render("~/plugins/imagecropper")
    @Scripts.Render("~/plugins/colorpicker")
    @Scripts.Render("~/plugins/clockpicker")
    @Scripts.Render("~/plugins/dateRange")
    @Scripts.Render("~/plugins/select2")
    @Scripts.Render("~/plugins/touchSpin")
    @Scripts.Render("~/plugins/tagInputs")
    @Scripts.Render("~/plugins/duallist")

<script>
    $(document).ready(function () {
        // Branch typeahead starts here
        $('.BranchesLookup').typeahead({
            source: function (query, process) {
                return $.getJSON(
                    '@Url.Action("GetBranchesAsync", "Branch", new { Area = "Admin" })',
                    { query: query },
                    function (Branches) {
                        var newBranchesData = [];
                        BranchesMap = {};
                        $.each(Branches, function (i, Branch) {
                            newBranchesData.push(Branch.Description);
                            BranchesMap[Branch.Description] = Branch;
                        });
                        process(newBranchesData);
                    }
                );
            },
            matcher: function (item) {
                return item.toLowerCase().indexOf(this.query.trim().toLowerCase()) != -1;
            },
            sorter: function (items) {
                return items.sort();
            },
            highlighter: function (item) {
                var regex = new RegExp('(' + this.query + ')', 'gi');
                return item.replace(regex, "<strong>$1</strong>");
            },
            updater: function (item) {
                var branchId = BranchesMap[item].Id;
                $('#BranchId').val(branchId);
                return item;
            }
        });

        // Initialize DataTable for Customers Grid
        $('#customersGrid').DataTable({
            "sPaginationType": "full_numbers",
            "bProcessing": true,
            "bServerSide": true,
            "sAjaxSource": "@(Url.Action("Index", "Customer", new { Area = "Registry" }))",
            "sServerMethod": "POST",
            "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                var createdDate = new Date(parseInt(aData.CreatedDate.replace("/Date(", "").replace(")/", ""), 10));
                var h = ("0" + createdDate.getHours()).slice(-2);
                var m = ("0" + createdDate.getMinutes()).slice(-2);
                var s = ("0" + createdDate.getSeconds()).slice(-2);
                var dt_Created = $.datepicker.formatDate('dd/mm/yy', createdDate) + " " + h + ":" + m + ":" + s;
                aData.CreatedDate = dt_Created;
                var selectUrl = '<a href="/humanResource/employee/create/' + aData.Id + '" class="btn btn-outline-info">Select</a>';
                $('td:eq(4)', nRow).html(dt_Created);
                $('td:eq(5)', nRow).html(selectUrl);
                return nRow;
            },
            "aoColumns": [
                { "mDataProp": "FullName", "sTitle": "Name", "sWidth": "6%" },
                { "mDataProp": "TypeDescription", "sTitle": "Type", "sWidth": "6%" },
                { "mDataProp": "Reference2", "sTitle": "Membership Number", "sWidth": "6%" },
                { "mDataProp": "IndividualTypeDescription", "sTitle": "Individual Type", "sWidth": "6%" },
                { "mDataProp": "CreatedDate", "sTitle": "Created Date", "sWidth": "6%" },
                { "mDataProp": "CreatedDate", "sTitle": "", "sWidth": "6%", "bSortable": false }
            ],
            "aaSorting": [[0, "desc"]]
        });

        $("#s tbody").on("click", "tr", function () {
            var data = $('#customersGrid').DataTable().row(this).data();
            $('#CustomerId').val(data.Id);
            $('input[name=CustomerId]').val(data.Id);
            $('input[name=CustomerFullName]').val(data.FullName);
            $('#customerLookupModal').modal('hide');
        });

        // Initialize DataTable for Employee Lookup
        $('#employeeLookupGrid').DataTable({
            "sPaginationType": "full_numbers",
            "bProcessing": true,
            "bServerSide": true,
            "sAjaxSource": "@(Url.Action("GetEmployees", "Documents", new { Area = "HumanResource" }))",
            "sServerMethod": "POST",
            "aoColumns": [
                { "mDataProp": "EmployeeName", "sTitle": "Employee Name" },
                { "mDataProp": "EmployeeID", "sTitle": "Employee ID" },
                {
                    "mDataProp": null,
                    "sTitle": "Select",
                    "bSortable": false,
                    "mRender": function (data, type, row) {
                        return '<a href="#" class="btn btn-outline-info select-employee" data-id="' + row.EmployeeID + '" data-name="' + row.EmployeeName + '">Select</a>';
                    }
                }
            ],
            "aaSorting": [[0, "desc"]]
        });

        // Handle Employee Selection
        $('#employeeLookupGrid').on('click', '.select-employee', function () {
            var employeeId = $(this).data('id');
            var employeeName = $(this).data('name');
            $('#EmployeeCustomerId').val(employeeId);
            $('#EmployeeCustomerFullName').val(employeeName);
            $('#employeeLookupModal').modal('hide');
        });

        // EmployeeType typeahead starts here
        $('.EmployeeTypesLookup').typeahead({
            source: function (query, process) {
                return $.getJSON(
                    '@Url.Action("GetEmployeeTypesAsync", "EmployeeType", new { Area = "HumanResource" })',
                    { query: query },
                    function (EmployeeTypes) {
                        var newEmployeeTypesData = [];
                        EmployeeTypesMap = {};
                        $.each(EmployeeTypes, function (i, EmployeeType) {
                            newEmployeeTypesData.push(EmployeeType.CategoryDescription);
                            EmployeeTypesMap[EmployeeType.CategoryDescription] = EmployeeType;
                        });
                        process(newEmployeeTypesData);
                    }
                );
            },
            matcher: function (item) {
                return item.toLowerCase().indexOf(this.query.trim().toLowerCase()) != -1;
            },
            sorter: function (items) {
                return items.sort();
            },
            highlighter: function (item) {
                var regex = new RegExp('(' + this.query + ')', 'gi');
                return item.replace(regex, "<strong>$1</strong>");
            },
            updater: function (item) {
                var employeeTypeId = EmployeeTypesMap[item].Id;
                $('#EmployeeTypeId').val(employeeTypeId);
                return item;
            }
        });

        // Designation typeahead starts here
        $('.DesignationsLookup').typeahead({
            source: function (query, process) {
                return $.getJSON(
                    '@Url.Action("GetDesignationsAsync", "Designation", new { Area = "HumanResource" })',
                    { query: query },
                    function (Designations) {
                        var newDesignationsData = [];
                        DesignationsMap = {};
                        $.each(Designations, function (i, Designation) {
                            newDesignationsData.push(Designation.Description);
                            DesignationsMap[Designation.Description] = Designation;
                        });
                        process(newDesignationsData);
                    }
                );
            },
            matcher: function (item) {
                return item.toLowerCase().indexOf(this.query.trim().toLowerCase()) != -1;
            },
            sorter: function (items) {
                return items.sort();
            },
            highlighter: function (item) {
                var regex = new RegExp('(' + this.query + ')', 'gi');
                return item.replace(regex, "<strong>$1</strong>");
            },
            updater: function (item) {
                var designationId = DesignationsMap[item].Id;
                $('#DesignationId').val(designationId);
                return item;
            }
        });

        // Department typeahead starts here
        $('.DepartmentsLookup').typeahead({
            source: function (query, process) {
                return $.getJSON(
                    '@Url.Action("GetDepartmentsAsync", "Department", new { Area = "HumanResource" })',
                    { query: query },
                    function (Departments) {
                        var newDepartmentsData = [];
                        DepartmentsMap = {};
                        $.each(Departments, function (i, Department) {
                            newDepartmentsData.push(Department.Description);
                            DepartmentsMap[Department.Description] = Department;
                        });
                        process(newDepartmentsData);
                    }
                );
            },
            matcher: function (item) {
                return item.toLowerCase().indexOf(this.query.trim().toLowerCase()) != -1;
            },
            sorter: function (items) {
                return items.sort();
            },
            highlighter: function (item) {
                var regex = new RegExp('(' + this.query + ')', 'gi');
                return item.replace(regex, "<strong>$1</strong>");
            },
            updater: function (item) {
                var departmentId = DepartmentsMap[item].Id;
                $('#DepartmentId').val(departmentId);
                return item;
            }
        });

        // Add placeholders to input fields
        $('.BranchesLookup').attr('placeholder', 'Search for a branch...');
        $('.EmployeesLookup').attr('placeholder', 'Search for an employee...');
        $('.EmployeeTypesLookup').attr('placeholder', 'Search for an employee type...');
        $('.DesignationsLookup').attr('placeholder', 'Search for a designation...');
        $('.DepartmentsLookup').attr('placeholder', 'Search for a department...');
    });
</script>
}

