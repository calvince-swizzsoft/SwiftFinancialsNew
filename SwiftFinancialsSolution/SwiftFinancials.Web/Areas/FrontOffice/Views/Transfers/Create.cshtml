@model Application.MainBoundedContext.DTO.FrontOfficeModule.CashTransferRequestDTO

@{
    ViewBag.Title = "Create Transfers";

    var cashTransferTransactionTypes = ViewBag.CashTransferTransactionTypeSelectList as List<SelectListItem>;
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-12">
        <h2>Cash Transactions</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                @Html.ActionLink("Dashboard", "Index", "Home", new { Area = "" }, null)
            </li>
            <li class="breadcrumb-item">
                @Html.ActionLink("Home", "Index", "Transfers", new { Area = "FrontOffice" }, null)
            </li>
            <li class="breadcrumb-item active">
                <strong>Create</strong>
            </li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-content bg-white text-info" style="border: 1px solid #ddd; border-radius: 4px; padding: 20px; margin-bottom: 20px;">
                    <form>
                        <!-- Tabs -->
                        <ul class="nav nav-tabs mb-4">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#cashTransfer">Cash Transfer</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#chequesTransfer">Check Transfer</a>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <!-- Cash Transfer Tab -->

                            @*@using (Html.BeginForm("Create", "Transfers", new { Area = "FrontOffice" }, FormMethod.Post, new { @id = "cashReceiptsForm" }))
                            {
                                @Html.AntiForgeryToken()*@


                                <div id="cashTransfer" class="form-horizontal tab-pane active">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <!-- Left Panel -->
                                            <div class="card h-100">
                                                <div class="card-body d-flex flex-column">
                                                    <!-- Amount Field -->
                                                    @Html.HiddenFor(model => model.EmployeeId, new { htmlAttributes = new { @id = "transfersEmployeeId" } })
                                                    <div class="form-group mb-4">
                                                        @Html.LabelFor(model => model.Amount, "Amount", new { @class = "font-bold" })
                                                        @Html.EditorFor(model => model.Amount, new { htmlAttributes = new { @class = "form-control form-control-lg", @id = "transfersAmount" } })
                                                        @Html.ValidationMessageFor(model => model.Amount, "", new { @class = "text-danger" })
                                                    </div>

                                                    <div class="form-group mb-4">
                                                        <label>Treasury</label>
                                                        <input type="text" class="form-control" readonly value="HeadOffice">
                                                    </div>

                                                    <!-- Reference Field -->
                                                    <div class="form-group mt-auto">
                                                        @Html.LabelFor(model => model.Reference, "Reference", new { @class = "font-bold" })
                                                        @Html.EditorFor(model => model.Reference, new { htmlAttributes = new { @id = "transfersReference", @class = "form-control", @placeholder = "Enter reference" } })
                                                        @Html.ValidationMessageFor(model => model.Reference, "", new { @class = "text-danger" })
                                                    </div>
                                                </div>

                                        </div>
                                            </div>

                                        <div class="col-md-8">
                                            <!-- Right Panel -->
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="form-group mb-3">
                                                        @Html.LabelFor(model => model.OpeningBalance, new { @class = "font-bold" })
                                                        @Html.TextBoxFor(model => model.OpeningBalance, new { @class = "form-control", @id = "transfersOpeningBalance", @readonly = "readonly" })
                                                        @Html.ValidationMessageFor(model => model.OpeningBalance, "", new { @class = "text-danger" })
                                                    </div>


                                                    <div class="form-group mb-3">
                                                        @Html.LabelFor(model => model.TotalCredits, new { @class = "font-bold" })
                                                        @Html.TextBoxFor(model => model.TotalCredits, new { @class = "form-control", @id = "transfersTotalCredits", @readonly = "readonly" })
                                                        @Html.ValidationMessageFor(model => model.TotalCredits, "", new { @class = "text-danger" })
                                                    </div>

                                                    <div class="form-group mb-3">
                                                        @Html.LabelFor(model => model.TotalDebits, new { @class = "font-bold" })
                                                        @Html.TextBoxFor(model => model.TotalDebits, new { @class = "form-control", @id = "transfersTotalDebits", @readonly = "readonly" })
                                                        @Html.ValidationMessageFor(model => model.TotalDebits, "", new { @class = "text-danger" })
                                                    </div>


                                                    <div class="form-group mb-3">
                                                        @Html.LabelFor(model => model.BookBalance, new { @class = "font-bold" })
                                                        @Html.TextBoxFor(model => model.BookBalance, new { @class = "form-control", @id = "transfersBookBalance", @readonly = "readonly" })
                                                        @Html.ValidationMessageFor(model => model.BookBalance, "", new { @class = "text-danger" })
                                                    </div>


                                                    <div class="form-group mb-3">
                                                        @Html.LabelFor(model => model.UntransferredChequesValue, new { @class = "font-bold" })
                                                        @Html.TextBoxFor(model => model.UntransferredChequesValue, new { @class = "form-control", @id = "transfersUntransferredChequesValue", @readonly = "readonly" })
                                                        @Html.ValidationMessageFor(model => model.UntransferredChequesValue, "", new { @class = "text-danger" })
                                                    </div>

                                                    <div class="form-group mb-3">
                                                        @Html.LabelFor(model => model.ClosingBalance, new { @class = "font-bold" })
                                                        @Html.TextBoxFor(model => model.ClosingBalance, new { @class = "form-control", @id = "transfersClosingBalance", @readonly = "readonly" })
                                                        @Html.ValidationMessageFor(model => model.ClosingBalance, "", new { @class = "text-danger" })
                                                    </div>

                                                    <div class="form-group mb-3">
                                                        @Html.LabelFor(model => model.ClosingBalanceStatus, new { @class = "font-bold" })
                                                        @Html.TextBoxFor(model => model.ClosingBalanceStatus, new { @class = "form-control", @id = "transfersClosingBalanceStatus", @readonly = "readonly" })
                                                        @Html.ValidationMessageFor(model => model.ClosingBalanceStatus, "", new { @class = "text-danger" })
                                                    </div>


                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12 text-right">
                                            <button type="submit" id="cashTransferButton" class="btn btn-primary">Update</button>
                                        </div>
                                    </div>
                                </div>

                                   


                                <!-- Cheques Transfer Tab -->
                                <div id="chequesTransfer" class="tab-pane">
                                    <div id="selectAllContainer" class="mb-3">
                                        <label class="d-flex align-items-center">
                                            <input type="checkbox" id="selectAllCheckbox" class="mr-2">
                                            <span>Select All Cheques</span>
                                        </label>
                                    </div>

                                    <div class="table-responsive">
                                        <table id="ChequesGrid" class="table table-striped table-bordered table-hover">
                                            <tbody>
                                                <tr>
                                                    <td class="dataTables_empty">Loading data from server</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-12 text-right">
                                        <button type="submit" id="chequesTransferButton" class="btn btn-primary mt-3 mb-3">Update</button>
                                    </div>

                                </div>
                            </div>
                    </form>
                            @*}*@
                </div>
            </div>
        </div>
    </div>
</div>
    

<style>
    .card {
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .card-body {
        padding: 20px;
    }

    .form-control {
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }

    .form-control-lg {
        height: calc(1.5em + 1rem + 2px);
        padding: 0.5rem 1rem;
        font-size: 1.25rem;
    }

    .btn-primary {
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
        padding: 0.375rem 0.75rem;
    }

    .h-100 {
        height: 100%;
    }

    .d-flex {
        display: flex;
    }

    .flex-column {
        flex-direction: column;
    }

    .nav-tabs {
        border-bottom: 1px solid #dee2e6;
    }

        .nav-tabs .nav-link {
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }

            .nav-tabs .nav-link.active {
                color: #495057;
                background-color: #fff;
                border-color: #dee2e6 #dee2e6 #fff;
            }

    .tab-content {
        padding-top: 20px;
    }

    .table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .table-bordered {
        border: 1px solid #dee2e6;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }
</style>

@section Styles{
    @Styles.Render("~/Content/plugins/iCheck/iCheckStyles")
    @Styles.Render("~/plugins/wizardStepsStyles")
    @Styles.Render("~/Content/plugins/dataTables/dataTablesStyles")
    @Styles.Render("~/plugins/awesomeCheckboxStyles")
    @Styles.Render("~/plugins/clockpickerStyles")
    @Styles.Render("~/plugins/dateRangeStyles")
    @Styles.Render("~/Content/plugins/chosen/chosenStyles")
    @Styles.Render("~/plugins/switcheryStyles")
    @Styles.Render("~/plugins/jasnyBootstrapStyles")
    @Styles.Render("~/plugins/nouiSliderStyles")
    @Styles.Render("~/plugins/dataPickerStyles")
    @Styles.Render("~/Content/plugins/ionRangeSlider/ionRangeStyles")
    @Styles.Render("~/plugins/imagecropperStyles")
    @Styles.Render("~/Content/plugins/colorpicker/colorpickerStyles")
    @Styles.Render("~/plugins/select2Styles")
    @Styles.Render("~/plugins/touchSpinStyles")
    @Styles.Render("~/plugins/tagInputsStyles")
    @Styles.Render("~/plugins/duallistStyles")
}

@section Scripts {
    @Scripts.Render("~/plugins/wizardSteps")
    @Scripts.Render("~/plugins/validate")
    @Scripts.Render("~/plugins/typehead")
    @Scripts.Render("~/plugins/dataTables")
    @Scripts.Render("~/plugins/iCheck")
    @Scripts.Render("~/plugins/dataPicker")
    @Scripts.Render("~/plugins/ionRange")
    @Scripts.Render("~/plugins/nouiSlider")
    @Scripts.Render("~/plugins/jasnyBootstrap")
    @Scripts.Render("~/plugins/switchery")
    @Scripts.Render("~/plugins/chosen")
    @Scripts.Render("~/plugins/knob")
    @Scripts.Render("~/plugins/imagecropper")
    @Scripts.Render("~/plugins/colorpicker")
    @Scripts.Render("~/plugins/clockpicker")
    @Scripts.Render("~/plugins/dateRange")
    @Scripts.Render("~/plugins/select2")
    @Scripts.Render("~/plugins/touchSpin")
    @Scripts.Render("~/plugins/tagInputs")
    @Scripts.Render("~/plugins/duallist")


    <script>


        function updateSelectAllCheckbox() {
    var allChecked = $('.cheque-checkbox:checked').length === $('.cheque-checkbox').length;
    $('#selectAllCheckbox').prop('checked', allChecked);
}
    // Initialize the DataTable and store the reference in a variable
    var chequeTable = $('#ChequesGrid').DataTable({
        "sPaginationType": "full_numbers",
        "bProcessing": true,
        "bServerSide": true,
        "sAjaxSource": "@(Url.Action("FetchUnTransferredChequesTable", "Transfers", new { Area = "FrontOffice"}))",
        "sServerMethod": "POST",
        "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {

            // Create the checkbox for each row
            var checkboxHtml = '<div style="text-align: center;"><input type="checkbox" class="form-check-input cheque-checkbox" value="' + String(aData.Id) + '"></div>';
            $('td:eq(0)', nRow).html(checkboxHtml);

            // Handle CreatedDate formatting
            var createdDate = new Date(parseInt(aData.CreatedDate.replace("/Date(", "").replace(")/", ""), 10));
            var h = ("0" + createdDate.getHours()).slice(-2);
            var m = ("0" + createdDate.getMinutes()).slice(-2);
            var s = ("0" + createdDate.getSeconds()).slice(-2);
            var dt_Created = $.datepicker.formatDate('dd/mm/yy', createdDate) + " " + h + ":" + m + ":" + s;
            aData.CreatedDate = dt_Created;

            // Handle MaturityDate formatting
            if (aData.MaturityDate) {
                var maturityDate = new Date(parseInt(aData.MaturityDate.replace("/Date(", "").replace(")/", ""), 10));
                var dt_Maturity = $.datepicker.formatDate('dd/mm/yy', maturityDate);
                $('td:eq(8)', nRow).html(dt_Maturity);
            }

            // Handle WriteDate formatting (corrected from MaturityDate)
            if (aData.WriteDate) {
                var writeDate = new Date(parseInt(aData.WriteDate.replace("/Date(", "").replace(")/", ""), 10));
                var dt_Write = $.datepicker.formatDate('dd/mm/yy', writeDate);
                $('td:eq(6)', nRow).html(dt_Write);
            }

            // Update CreatedDate column
            $('td:eq(12)', nRow).html(dt_Created);
            return nRow;
        },

        "aoColumns": [
            { "mDataProp": null, "sTitle": "Select?", "sWidth": "3%", "bSortable": false, "sClass": "dt-body-center"},
            { "mDataProp": "PaddedNumber", "sTitle": "Cheque Number", "sWidth": "15%" },
            { "mDataProp": "Amount", "sTitle": "Amount", "sWidth": "15%" },
            { "mDataProp": "Drawer", "sTitle": "Drawer", "sWidth": "25%" },
            { "mDataProp": "DrawerBank", "sTitle": "Drawer Bank", "sWidth": "10%" },
            { "mDataProp": "DrawerBankBranch", "sTitle": "Drawer Bank Branch", "sWidth": "10%" },
            { "mDataProp": "WriteDate", "sTitle": "Write Date", "sWidth": "10%" },
            { "mDataProp": "ChequeTypeDescription", "sTitle": "Cheque Type", "sWidth": "15%" },
            { "mDataProp": "MaturityDate", "sTitle": "Maturity Date", "sWidth": "15%" },
            { "mDataProp": "CustomerAccountCustomerFullName", "sTitle": "Customer Name", "sWidth": "15%" },
            { "mDataProp": "CustomerAccountFullAccountNumber", "sTitle": "Account Number", "sWidth": "15%" },
            { "mDataProp": "CustomerAccountCustomerReference2", "sTitle": "Membership", "sWidth": "15%" },
            { "mDataProp": "CreatedDate", "sTitle": "Created Date", "sWidth": "5%" },
        ],

        "oClasses": {
            "sStripeOdd": "odd",
            "sStripeEven": "even",
            "sRow": "aligned-row"
        },

        "aaSorting": [[1, "desc"]], // Default sorting on Cheque Number

        "drawCallback": function (settings) {
            updateSelectAllCheckbox();
        }
    });

        // Event listener for the "Select All" checkbox
        $('#selectAllCheckbox').on('change', function () {
            var isChecked = $(this).prop('checked');
            $('.cheque-checkbox').prop('checked', isChecked);
        });

    // Event listener for the "Transfer Cheques" button
    $('#chequesTransferButton').on('click', function () {
        var selectedCheques = [];

        // Gather selected cheques data
        $('.cheque-checkbox:checked').each(function () {
            var row = $(this).closest('tr'); // Get the parent row of the checkbox
            var chequeData = chequeTable.row(row).data(); // Get the data for the selected row
            selectedCheques.push(chequeData);
        });

        // Check if any cheques are selected
        if (selectedCheques.length === 0) {
            alert("Please select at least one cheque to transfer.");
            return;
        }

        // AJAX request to send selected cheques data to the controller
        $.ajax({
            url: '@Url.Action("TransferSelectedChequesAsync", "Transfers")', // Ensure this is in a Razor view or use a hardcoded URL
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ cheques: selectedCheques }), // Send the selected cheque data
            success: function (response) {
                if (response && response.success) {
                    console.log(response.data);
                    console.log(JSON.stringify(response.data));

                    $('#transfersClosingBalance').val(response.data.ClosingBalance);
                    $('#transfersOpeningBalance').val(response.data.OpeningBalance);
                    $('#transfersTotalCredits').val(response.data.TotalCredits);
                    $('#transfersTotalDebits').val(response.data.TotalDebits);
                    $('#transfersUntransferredChequesValue').val(response.data.UntransferredChequesValue);
                    $('#transfersBookingBalance').val(response.data.BookingBalance);

                    chequeTable.ajax.reload(); // Refresh the table after the transfer
                } else {
                    alert("Error: " + (response.message || "An unexpected error occurred."));
                }
            },
            error: function () {
                alert("An unexpected error occurred.");
            }
        });
    });
    </script>

    <script>

        function resetAllFields() {
            /*            $('#CustomerAccountNewAvailableBalance').val('');*/
            $('#transfersAmount').val('');
            $('#transfersBookBalance').val('');
            $('#transfersClosingBalance').val('');
            $('#transfersClosingBalanceStatus').val('');
            $('#employeeId').val('');
            $('#transfersUntransferredChequesValue').val('');
            $('#transfersTotalCredits').val('');
            $('#transfersTotalDebits').val('');
            $('#transfersOpeningBalance').val('');



            // Disable submit button
            $('#submitButton').prop('disabled', true);
        }

    // Event listener for the "Transfer Cheques" button
$('#cashTransferButton').on('click', function (e) {

    e.preventDefault();

    console.log("cashTransfer btn clicked");
    var cashTransferRequestDTO = {
        amount: $('#transfersAmount').val(),
        reference: $('#transfersReference').val(),
        employeeId: $('#transfersEmployeeId').val()
    };

    // AJAX request to send selected cheques data to the controller
    $.ajax({
        url: '@Url.Action("Create", "Transfers")',  // Your controller/action URL
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(cashTransferRequestDTO), // Convert DTO object to JSON string
        success: function (response) {
            if (response.redirect) {
                resetAllFields();
            } else if (response.success) {
                console.log("transfer request success");
                //alert('Customer Receipts: Operation Success');
                resetAllFields();
            } else {
                //alert('Customer Receipts: Operation Failed\n\n' + (response.errorMessages ? response.errorMessages.join('\n') : 'Unknown error'));
                //resetAllFields();
            }
        },
        error: function (xhr, status, error) {
            //alert("An unexpected error occurred.");
            console.error(error);
        }
    });
});


    </script>

    <script>
        $(document).ready(function () {
            // Function to update the balance status based on the amount and closing balance
            function updateBalanceStatus() {
                // Get the current values for amount and closing balance
                var amount = parseFloat($('#transfersAmount').val()) || 0;  // Default to 0 if no value is entered
                var closingBalance = parseFloat($('#transfersClosingBalance').val()) || 0;

                // Determine the status based on the comparison
                var status;
                if (amount < closingBalance) {
                    status = 'Shortage';
                } else if (amount > closingBalance) {
                    status = 'Excess';
                } else {
                    status = 'Balanced';
                }

                // Update the status field
                $('#transfersClosingBalanceStatus').val(status);
            }

            // Attach the update function to the amount field's input event
            $('#transfersAmount').on('input', function () {
                updateBalanceStatus();
            });

            // Initialize the status when the page loads
            updateBalanceStatus();
        });
    </script>
}