@model dynamic
@{
    ViewBag.Title = "File Catalogue";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">File Catalogue</h3>
            </div>
            <div class="panel-body">
                <div class="row filter-section">
                    <div class="col-md-12">
                        <div class="form-inline">
                            @*<div class="form-group">
                                <label for="fileStatus">File Status</label>
                                @Html.DropDownList("RecordStatus", ViewBag.recordStatus as SelectList, new { @class = "form-control input-sm" })
                            </div>
                            <div class="form-group">
                                <label for="customerType">Customer Type</label>
                                @Html.DropDownList("customerType", ViewBag.CustomerTypeSelectList as SelectList, new { @class = "form-control input-sm" })
                            </div>
                            <div class="form-group">
                                <label for="movementStatus">Movement Status</label>
                                @Html.DropDownList("movementStatus", ViewBag.movementStatus as SelectList, new { @class = "form-control input-sm" })
                            </div>*@
                            <div class="form-group">
                                <label for="customerFilter">Customer Filter</label>
                                @Html.DropDownList("customerFilter", ViewBag.customerFilter as SelectList, new { @class = "form-control input-sm" })
                            </div>
                            <button id="btnSearch" class="btn btn-primary btn-sm">Search</button>
                        </div>
                    </div>
                </div>
                <div class="row search-section">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="searchText">Account Number</label>
                            <div class="input-group">
                                <input type="text" id="searchText" class="form-control input-sm" placeholder="Enter Text..." />
                                <span class="input-group-btn">
                                    <button id="btnClear" class="btn btn-default btn-sm" type="button">Clear</button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Data Table -->
                <div class="row">
                    <div class="col-md-12">
                        <table id="catalogueTable" class="table table-striped table-bordered table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Serial Number</th>
                                    <th>Full Account Number</th>
                                    <th>Membership Number</th>
                                    <th>Personal File Number</th>
                                    <th>Customer Name</th>
                                    <th>Gender</th>
                                    <th>Marital Status</th>
                                    <th>Identity Card</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="modal fade" id="movementHistoryModal" tabindex="-1" role="dialog" aria-labelledby="movementHistoryModalLabel">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <h4 class="modal-title" id="movementHistoryModalLabel">File Movement History</h4>
                            </div>
                            <div class="modal-body">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Source</th>
                                            <th>Destination</th>
                                            <th>Remarks</th>
                                            <th>Carrier</th>
                                            <th>Sender</th>
                                            <th>Dispatch Date</th>
                                            <th>Recipient</th>
                                            <th>Receive Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="movementHistoryBody"></tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            var table = $('#catalogueTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "@Url.Action("Index", "Catalogue")",
                    "type": "POST",
                    "data": function (d) {
                        d.recordStatus = $('#fileStatus').val();
                        d.customerFilter = $('#customerFilter').val();
                        d.customerType = $('#customerType').val();
                        d.movementStatus = $('#movementStatus').val();
                        d.filterValue = $('#searchText').val();
                    }
                },
                "columns": [
                    { "data": "SerialNumber", "name": "SerialNumber" },
                    { "data": "FullAccountNumber", "name": "FullAccountNumber" },
                    { "data": "MembershipNumber", "name": "MembershipNumber" },
                    { "data": "PersonalFileNumber", "name": "PersonalFileNumber" },
                    {
                        "data": "CustomerName",
                        "name": "CustomerName",
                        "render": function (data, type, row) {
                            return row.FileRegisterCustomerIndividualFirstName + ' ' + row.FileRegisterCustomerIndividualLastName;
                        }
                    },
                    { "data": "Gender", "name": "Gender" },
                    { "data": "MaritalStatus", "name": "MaritalStatus" },
                    { "data": "IdentityCardNumber", "name": "IdentityCardNumber" },
                    {
                        "data": "Status",
                        "name": "Status",
                        "render": function (data, type, row) {
                            return row.IsReceived ? 'Received' : 'Dispatched';
                        }
                    },
                    {
                        "data": "Id",
                        "render": function (data, type, row) {
                            return '<button class="btn btn-xs btn-info view-history" data-id="' + row.FileRegisterId + '">View History</button>';
                        },
                        "orderable": false
                    }
                ],
                "pageLength": 15,
                "lengthMenu": [15, 25, 50, 100]
            });

            $('#btnSearch').click(function () {
                table.ajax.reload();
            });

            $('#btnClear').click(function () {
                $('#searchText').val('');
                table.ajax.reload();
            });

            $('#catalogueTable').on('click', '.view-history', function () {
                var fileRegisterId = $(this).data('id');

                $.ajax({
                    url: '@Url.Action("GetMovementHistory", "Catalogue")',
                    type: 'POST',
                    data: { fileRegisterId: fileRegisterId },
                    success: function (response) {
                        if (response.success) {
                            var html = '';
                            $.each(response.data, function (index, item) {
                                html += '<tr>' +
                                    '<td>' + (item.SourceDepartmentDescription || '') + '</td>' +
                                    '<td>' + (item.DestinationDepartmentDescription || '') + '</td>' +
                                    '<td>' + (item.Remarks || '') + '</td>' +
                                    '<td>' + (item.CarrierName || '') + '</td>' +
                                    '<td>' + (item.SenderName || '') + '</td>' +
                                    '<td>' + (item.DispatchDate ? new Date(parseInt(item.DispatchDate.substr(6)) : '') + '</td>' +
                                    '<td>' + (item.RecipientName || '') + '</td>' +
                                    '<td>' + (item.ReceiveDate ? new Date(parseInt(item.ReceiveDate.substr(6))) : '') + '</td>' +
                                    '</tr>';
                            });
                            $('#movementHistoryBody').html(html);
                            $('#movementHistoryModal').modal('show');
                        }
                    }
                });
            });
        });
    </script>
}