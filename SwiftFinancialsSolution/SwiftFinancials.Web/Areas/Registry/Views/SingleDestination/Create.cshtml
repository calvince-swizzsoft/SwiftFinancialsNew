@model Application.MainBoundedContext.DTO.RegistryModule.FileMovementHistoryDTO

@{
    ViewBag.Title = "Create SingleDestination File";
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-12">
        <h2>File Dispatch</h2>
    </div>
</div>

<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Dispatch Details</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        <a class="close-link"><i class="fa fa-times"></i></a>
                    </div>
                </div>

                <div class="ibox-content bg-white">
                    @using (Html.BeginForm("Create", "Singledestination", new { Area = "Registry" }, FormMethod.Post, new { @class = "wizard-big", @id = "form" }))
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Remarks:</label>
                                    @Html.TextAreaFor(m => m.Remarks, new { @class = "form-control", placeholder = "Enter Text...", rows = 3, id = "remarks" })
                                </div>

                                <div class="form-group">
                                    <label>Carrier:</label>
                                    @Html.TextBoxFor(m => m.Carrier, new { @class = "form-control", placeholder = "Enter Carrier Name...", id = "carrier" })
                                </div>
                            </div>

                            <div class="col-md-6 form-group">
                                <div class="form-group form-group-lg">
                                    @Html.LabelFor(model => model.DestinationDepartmentDescription, new { @class = "control-label" })
                                    <div class="input-group" data-autoclose="true">
                                        @Html.HiddenFor(model => model.DestinationDepartmentId, new { @id = "ChartOfAccountId" })
                                        @Html.TextBoxFor(model => model.DestinationDepartmentDescription, new { @Id = "ChartOfAccountAccountName", @class = "form-control input-md alpha alphaspace required", @readonly = "readonly", @required = "required", @placeholder = "Search Department..." })
                                        <span class="input-group-addon">
                                            <a data-toggle="modal" data-target="#chartofAccountLookupModal"><span class="fa fa-search"></span></a>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 form-group">
                                <div class="form-group form-group-lg">
                                    @Html.LabelFor(model => model.SourceDepartmentDescription, new { @class = "control-label" })
                                    <div class="input-group" data-autoclose="true">
                                        @Html.HiddenFor(model => model.SourceDepartmentId, new { @id = "ChartOfAccountId" })
                                        @Html.TextBoxFor(model => model.SourceDepartmentDescription, new { @Id = "ChartOfAccountAccountName", @class = "form-control input-md alpha alphaspace required", @readonly = "readonly", @required = "required", @placeholder = "Search Department..." })
                                        <span class="input-group-addon">
                                            <a data-toggle="modal" data-target="#chartofAccountLookupModal"><span class="fa fa-search"></span></a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="ibox-content">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label>Search:</label>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Enter Text..." />
                                </div>
                                <div class="col-md-6">
                                    <label>Show entries:</label>
                                    <select class="form-control d-inline w-auto" id="entriesSelect">
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                            </div>

                            <table id="customerTable" class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th width="50px">Select</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Member No/th>
                                        <th>Id number</th>
                                        <th>Payroll number</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (ViewBag.customers != null)
                                    {
                                        foreach (var customer in ViewBag.customers)
                                        {
                                            <tr>
                                                <td><input type="checkbox" name="customerIds" value="@customer.Id" class="customer-checkbox" /></td>
                                                <td>@customer.IndividualFirstName</td>
                                                <td>@customer.IndividualLastName</td>
                                                <td>@customer.Reference2</td>
                                                <td>@customer.IndividualIdentityCardNumber</td>
                                                <td>@customer.IndividualPayrollNumbers</td>

                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="3" class="text-center">No customers available</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>

                            <div class="text-center mt-3">
                                <nav>
                                    <ul id="paginationControls" class="pagination justify-content-center"></ul>
                                </nav>
                            </div>

                            <div class="text-right">
                                <button class="btn btn-primary" id="dispatchBtn">Dispatch</button>
                            </div>

                            <div class="mt-4">
                                <h4>File Movement History</h4>
                                <table class="table table-bordered" id="movementHistoryTable">
                                    <thead>
                                        <tr>
                                            <th>Source</th>
                                            <th>Destination</th>
                                            <th>Remarks</th>
                                            <th>Carrier</th>
                                            <th>Dispatch Date</th>
                                            <th>Recipient</th>
                                            <th>Receive Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="7" class="text-center">No history available</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal  fade" id="chartofAccountLookupModal" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h3 class="font-bold">Department Lookup<button type="button" class="close" data-dismiss="modal"><span class="sr-only">Close</span></button></h3>
            </div>

            <br />
            <style>
                #chartsofAccountGrid thead {
                    background-color: #007bff;
                    color: white;
                }
            </style>
            <table id="chartsofAccountGrid" class="table table-hover" style="width:100%">
                <tbody>
                    <tr>
                        <td class="dataTables_empty">
                            Loading data from server
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles{
    @Styles.Render("~/Content/plugins/iCheck/iCheckStyles")
    @Styles.Render("~/plugins/wizardStepsStyles")
    @Styles.Render("~/Content/plugins/dataTables/dataTablesStyles")
    @Styles.Render("~/plugins/awesomeCheckboxStyles")
    @Styles.Render("~/plugins/clockpickerStyles")
    @Styles.Render("~/plugins/dateRangeStyles")
    @Styles.Render("~/Content/plugins/chosen/chosenStyles")
    @Styles.Render("~/plugins/switcheryStyles")
    @Styles.Render("~/plugins/jasnyBootstrapStyles")
    @Styles.Render("~/plugins/nouiSliderStyles")
    @Styles.Render("~/plugins/dataPickerStyles")
    @Styles.Render("~/Content/plugins/ionRangeSlider/ionRangeStyles")
    @Styles.Render("~/plugins/imagecropperStyles")
    @Styles.Render("~/Content/plugins/colorpicker/colorpickerStyles")
    @Styles.Render("~/plugins/select2Styles")
    @Styles.Render("~/plugins/touchSpinStyles")
    @Styles.Render("~/plugins/tagInputsStyles")
    @Styles.Render("~/plugins/duallistStyles")
}

@section Scripts{
    @Scripts.Render("~/plugins/wizardSteps")
    @Scripts.Render("~/plugins/validate")
    @Scripts.Render("~/plugins/typehead")
    @Scripts.Render("~/plugins/dataTables")
    @Scripts.Render("~/plugins/iCheck")
    @Scripts.Render("~/plugins/dataPicker")
    @Scripts.Render("~/plugins/ionRange")
    @Scripts.Render("~/plugins/nouiSlider")
    @Scripts.Render("~/plugins/jasnyBootstrap")
    @Scripts.Render("~/plugins/switchery")
    @Scripts.Render("~/plugins/chosen")
    @Scripts.Render("~/plugins/knob")
    @Scripts.Render("~/plugins/imagecropper")
    @Scripts.Render("~/plugins/colorpicker")
    @Scripts.Render("~/plugins/clockpicker")
    @Scripts.Render("~/plugins/dateRange")
    @Scripts.Render("~/plugins/select2")
    @Scripts.Render("~/plugins/touchSpin")
    @Scripts.Render("~/plugins/tagInputs")
    @Scripts.Render("~/plugins/duallist")

    <script>
    $(document).ready(function() {
        // Initialize pagination for customer table
        initCustomerTablePagination();

        // Your existing DataTable initialization
        $('#chartsofAccountGrid').DataTable({
            "sPaginationType": "full_numbers",
            "bProcessing": true,
            "bServerSide": true,
            "sAjaxSource": "@(Url.Action("Index", "Department", new { Area = "HumanResource"}))",
            "sServerMethod": "POST",
            "fnRowCallback": function (nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                var createdDate = new Date(parseInt(aData.CreatedDate.replace("/Date(", "").replace(")/", ""), 10));
                var h = ("0" + createdDate.getHours()).slice(-2);
                var m = ("0" + createdDate.getMinutes()).slice(-2);
                var s = ("0" + createdDate.getSeconds()).slice(-2);

                var dt_Created = $.datepicker.formatDate('dd/mm/yy', createdDate) + " " + h + ":" + m + ":" + s;
                aData.CreatedDate = dt_Created;

                var selectUrl = '<button class="btn btn-outline-info" onclick="selectCoA(\'' + aData.Id + '\')">Select</button>';

                $('td:eq(3)', nRow).html(dt_Created);
                $('td:eq(4)', nRow).html(selectUrl);

                return nRow;
            },
            "aoColumns": [
                { "mDataProp": "Description", "sTitle": "Name", "sWidth": "15%" },
                { "mDataProp": "IsLocked", "sTitle": "IsLocked", "sWidth": "10%" },
                { "mDataProp": "IsRegistry", "sTitle": "IsRegistry", "sWidth": "10%" },
                { "mDataProp": "CreatedDate", "sTitle": "Created Date", "sWidth": "10%" },
                { "mDataProp": "CreatedDate", "sTitle": "", "sWidth": "10%", "bSortable": false }],
            "aaSorting": [[0, "desc"]]
        });

        // Your existing selectCoA function
        function selectCoA(id) {
            console.log("Selected ID:", id);
            $.ajax({
                url: '/Registry/SingleDestination/ChartOfAccountLookUp',
                type: 'POST',
                data: { Id: id },
                success: function (response) {
                    if (response.success) {
                        console.log(response);
                        $('#ChartOfAccountId').val(response.data.ChartOfAccountId);
                        $('#ChartOfAccountAccountName').val(response.data.ChartOfAccountAccountName);

                        $('#chartofAccountLookupModal').modal('hide');
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('An error occurred while processing your request.');
                }
            });
        }
    });

    // Customer table pagination functions
    function initCustomerTablePagination() {
        var table = $('#customerTable');
        var rows = table.find('tbody tr');
        var totalRows = rows.length;
        var entriesPerPage = parseInt($('#entriesSelect').val());
        var totalPages = Math.ceil(totalRows / entriesPerPage);
        var currentPage = 1;

        // Initialize pagination
        function initPagination() {
            updatePaginationControls();
            showPage(1);
        }

        // Show specific page
        function showPage(page) {
            currentPage = page;
            var startIndex = (page - 1) * entriesPerPage;
            var endIndex = Math.min(startIndex + entriesPerPage, totalRows);

            rows.hide();
            rows.slice(startIndex, endIndex).show();

            updatePaginationControls();
        }

        // Update pagination controls
        function updatePaginationControls() {
            var pagination = $('#paginationControls');
            pagination.empty();

            // Previous button
            var prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(
                `<li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" aria-label="Previous" data-page="${currentPage - 1}">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>`
            );

            // Page numbers
            var maxVisiblePages = 5;
            var startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            var endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                pagination.append('<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>');
                if (startPage > 2) {
                    pagination.append('<li class="page-item disabled"><a class="page-link" href="#">...</a></li>');
                }
            }

            for (var i = startPage; i <= endPage; i++) {
                var active = i === currentPage ? 'active' : '';
                pagination.append(
                    `<li class="page-item ${active}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>`
                );
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagination.append('<li class="page-item disabled"><a class="page-link" href="#">...</a></li>');
                }
                pagination.append(`<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`);
            }

            // Next button
            var nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(
                `<li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" aria-label="Next" data-page="${currentPage + 1}">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>`
            );
        }

        // Handle page click
        $(document).on('click', '.page-link', function(e) {
            e.preventDefault();
            var page = $(this).data('page');
            if (page) {
                showPage(page);
            }
        });

        // Handle entries per page change
        $('#entriesSelect').change(function() {
            entriesPerPage = parseInt($(this).val());
            totalPages = Math.ceil(totalRows / entriesPerPage);
            currentPage = 1;
            showPage(currentPage);
        });

        // Handle search functionality
        $('#searchInput').keyup(function() {
            var searchText = $(this).val().toLowerCase();

            rows.each(function() {
                var rowText = $(this).text().toLowerCase();
                $(this).toggle(rowText.indexOf(searchText) > -1);
            });

            // Update pagination after search
            rows = table.find('tbody tr:visible');
            totalRows = rows.length;
            totalPages = Math.ceil(totalRows / entriesPerPage);
            currentPage = 1;
            showPage(currentPage);
        });

        // Initialize
        initPagination();
    }
    </script>

}