@{
    ViewBag.Title = "Chat with OpenAI";
    var username = ViewBag.UserName ?? "You";
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

<style>
    .chat-container {
        height: 500px;
        overflow-y: auto;
        background-color: #f4f6f8;
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        scrollbar-width: thin;
    }

    .chat-message {
        display: flex;
        align-items: flex-end;
        margin-bottom: 1rem;
        gap: 0.5rem;
    }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-message.ai {
            flex-direction: row;
        }

    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: 0 0 0 2px white;
    }

    .chat-bubble {
        padding: 0.75rem 1rem;
        border-radius: 20px;
        max-width: 75%;
        position: relative;
        font-size: 1rem;
        word-wrap: break-word;
        white-space: normal;
        display: inline-block;
        line-height: 1.5;
    }

        .chat-bubble.user {
            background: linear-gradient(135deg, #0d6efd, #1e90ff);
            color: white;
            border-bottom-right-radius: 4px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .chat-bubble.ai {
            background-color: #e9ecef;
            color: #212529;
            border-bottom-left-radius: 4px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

            .chat-bubble.ai.error {
                background-color: #f8d7da;
                color: #842029;
                border-left: 5px solid #dc3545;
            }

    .chat-timestamp {
        display: block;
        text-align: right;
        font-size: 0.7rem;
        color: #adb5bd;
        margin-top: 4px;
    }

    pre {
        background-color: #f0f0f0;
        padding: 0.75rem;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 0.9rem;
    }

    code {
        font-family: 'Courier New', Courier, monospace;
    }
</style>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow rounded-4 border-0">
                <div class="card-header bg-primary text-white rounded-top-4">
                    <h4 class="mb-0"><i class="bi bi-chat-dots-fill me-2"></i>Chat with OpenAI</h4>
                </div>
                <div class="card-body d-flex flex-column" style="height: 500px;">
                    <div id="chatBox" class="chat-container mb-3 flex-grow-1"></div>

                    <div class="input-group">
                        <input type="text" id="prompt" class="form-control form-control-lg" placeholder="Type your message..." autocomplete="off" />
                        <button id="sendBtn" class="btn btn-lg btn-primary">
                            <span id="sendText">Send</span>
                            <span id="loading" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
    const sendBtn = document.getElementById("sendBtn");
    const sendText = document.getElementById("sendText");
    const loading = document.getElementById("loading");
    const promptInput = document.getElementById("prompt");
    const chatBox = document.getElementById("chatBox");

    const currentUser = "@username";

    function appendMessage(content, sender, isError = false) {
        const msgWrapper = document.createElement("div");
        msgWrapper.classList.add("chat-message", sender);

        const avatar = document.createElement("img");
        avatar.classList.add("chat-avatar", sender === "user" ? "right" : "left");
        avatar.src = sender === "user"
            ? `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser)}&background=0d6efd&color=fff`
            : "https://ui-avatars.com/api/?name=AI&background=e9ecef&color=212529";
        avatar.alt = sender === "user" ? currentUser : "AI";

        const bubble = document.createElement("div");
        bubble.classList.add("chat-bubble", sender);
        if (sender === "ai" && isError) {
            bubble.classList.add("error");
        }

        if (sender === "ai" && !isError) {
            bubble.innerHTML = marked.parse(content);
            bubble.innerHTML += `<div class="chat-timestamp">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
            hljs.highlightAll();
        } else {
            bubble.textContent = content;
            bubble.innerHTML += `<div class="chat-timestamp">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
        }

        if (sender === "user") {
            msgWrapper.appendChild(bubble);
            msgWrapper.appendChild(avatar);
        } else {
            msgWrapper.appendChild(avatar);
            msgWrapper.appendChild(bubble);
        }

        chatBox.appendChild(msgWrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.addEventListener("click", async function () {
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        appendMessage(prompt, "user");
        promptInput.value = "";
        promptInput.focus();

        sendBtn.disabled = true;
        sendText.classList.add("d-none");
        loading.classList.remove("d-none");

        try {
            const res = await fetch('@Url.Action("Ask", "Chat")', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt })
            });

            const data = await res.json();
            appendMessage(data.reply || "No response from the server.", "ai", data.isError);
        } catch (err) {
            appendMessage("🚫 Error: " + err.message, "ai", true);
        } finally {
            sendBtn.disabled = false;
            sendText.classList.remove("d-none");
            loading.classList.add("d-none");
        }
    });

    promptInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendBtn.click();
        }
    });
    </script>
}
